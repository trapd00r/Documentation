From zsh-workers-return-19619-mason-zsh=primenet.com.au@sunsite.dk Sat Mar 13 22:41:24 2004
Return-Path: <zsh-workers-return-19619-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 9207 invoked from network); 13 Mar 2004 22:41:23 -0000
Received: from sunsite.dk (130.225.247.90)
  by ns1.primenet.com.au with SMTP; 13 Mar 2004 22:41:23 -0000
Received: (qmail 23542 invoked by alias); 13 Mar 2004 22:41:16 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 19619
Received: (qmail 23468 invoked from network); 13 Mar 2004 22:41:16 -0000
Received: from localhost (HELO sunsite.dk) (127.0.0.1)
  by localhost with SMTP; 13 Mar 2004 22:41:16 -0000
X-MessageWall-Score: 0 (sunsite.dk)
Received: from [193.109.254.211] by sunsite.dk (MessageWall 1.0.8) with SMTP; 13 Mar 2004 22:41:15 -0000
X-VirusChecked: Checked
X-Env-Sender: okiddle@yahoo.co.uk
X-Msg-Ref: server-19.tower-36.messagelabs.com!1079217674!4623217
X-StarScan-Version: 5.2.5; banners=-,-,-
X-Originating-IP: [158.234.9.163]
Received: (qmail 14989 invoked from network); 13 Mar 2004 22:41:14 -0000
Received: from iris.logica.co.uk (158.234.9.163)
  by server-19.tower-36.messagelabs.com with SMTP; 13 Mar 2004 22:41:14 -0000
Received: from trentino.logica.co.uk ([158.234.142.61])
	by iris.logica.co.uk (8.12.3/8.12.3/Debian -4) with ESMTP id i2DMfECk021196
	for <zsh-workers@sunsite.dk>; Sat, 13 Mar 2004 22:41:14 GMT
Received: from trentino.logica.co.uk (localhost [127.0.0.1])
	by trentino.logica.co.uk (Postfix) with ESMTP id 8290579721C1
	for <zsh-workers@sunsite.dk>; Sat, 13 Mar 2004 23:40:29 +0100 (CET)
X-VirusChecked: Checked
X-StarScan-Version: 5.1.13; banners=.,-,-
From: Oliver Kiddle <okiddle@yahoo.co.uk>
To: Zsh workers <zsh-workers@sunsite.dk>
Subject: PATCH: compiling on MacOS X 10.1
Date: Sat, 13 Mar 2004 23:40:29 +0100
Message-ID: <14248.1079217629@trentino.logica.co.uk>

Sourceforge actually has both a MacOS X 10.1 and 10.2 system. Before I
had tried the 10.2 system but I just tried 10.1 and it had a problem.

Where configure used the preprocessor to get a list of signals, it gets
lines of this form:
#1 "/usr/include/sys/signal.h" 1

We expect a space or tab after the `#' in the sed expression. This
patch allows a number. I've checked the output on a few other systems
and the only other lines beginning with `#' I ever saw are `#pragma' so
this should be safe.

The patch also includes a section to avoid a large number of ugly
warnings on MacOS like the following:

  errtmp.c:3: undefined type, found `XXNAMES'
  errtmp.c:3: illegal external declaration, missing `;' after `XXEPERM'

They don't matter because at the end it does this:

  cpp-precomp: warning: errors during smart preprocessing, retrying in basic mode

But they are easily avoided by using -traditional-cpp.

zpty doesn't entirely work on Mac OS X: test Y03 hangs. Theres also a
test failure in C02 that I haven't yet understood.

Oliver

Index: configure.ac
===================================================================
RCS file: /cvsroot/zsh/zsh/configure.ac,v
retrieving revision 1.14
diff -u -r1.14 configure.ac
--- configure.ac	12 Mar 2004 16:29:30 -0000	1.14
+++ configure.ac	13 Mar 2004 21:48:27 -0000
@@ -412,6 +412,11 @@
 AC_PROG_GCC_TRADITIONAL     dnl Do we need -traditional flag for gcc.
 AC_C_CONST                  dnl Does compiler support `const'.
 
+dnl Default preprocessing on Mac OS X produces warnings
+case "$host_os" in
+  darwin*) CPP="$CPP -traditional-cpp" ;;
+esac
+
 fp_PROG_CC_STDC
 AC_MSG_CHECKING([whether to use prototypes])
 if test ."$ansi2knr" = .yes || test ."$ansi2knr" = .no; then
@@ -1232,7 +1237,7 @@
 echo "#include <errno.h>" > nametmp.c
 errfile_list="`$CPP nametmp.c |
 sed -n -e 's/^#line[ 	].*\"\(.*\)\"/\1/p' \
-       -e 's/^#[ 	].*\"\(.*\)\"/\1/p' |
+       -e 's/^#[ 	0-9].*\"\(.*\)\"/\1/p' |
 sed 's/\\\\\\\\/\//g' |
 $AWK '{ if (\$1 ~ \"err\") files[[\$1]] = \$1 }
   END { for (var in files) print var }'`"

