From zsh-workers-return-26945-mason-zsh=primenet.com.au@sunsite.dk Thu May 07 16:02:40 2009
Return-Path: <zsh-workers-return-26945-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 23059 invoked from network); 7 May 2009 16:02:37 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-1.8 required=5.0 tests=AWL,BAYES_00,MISSING_HEADERS
	autolearn=no version=3.2.5
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 7 May 2009 16:02:37 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 25880 invoked from network); 7 May 2009 16:02:33 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 7 May 2009 16:02:33 -0000
Received: (qmail 8712 invoked by alias); 7 May 2009 16:02:27 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 26945
Received: (qmail 8701 invoked from network); 7 May 2009 16:02:27 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 7 May 2009 16:02:27 -0000
Received: from cluster-d.mailcontrol.com (cluster-d.mailcontrol.com [85.115.60.190])
	by bifrost.dotsrc.org (Postfix) with ESMTPS id 6268B80590A3
	for <zsh-workers@sunsite.dk>; Thu,  7 May 2009 18:02:23 +0200 (CEST)
Received: from cameurexb01.EUROPE.ROOT.PRI ([193.128.72.68])
	by rly47d.srv.mailcontrol.com (MailControl) with ESMTP id n47G2KBr005397
	for <zsh-workers@sunsite.dk>; Thu, 7 May 2009 17:02:20 +0100
Received: from news01 ([10.99.50.25]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.3959);
	 Thu, 7 May 2009 17:02:19 +0100
Date: Thu, 7 May 2009 17:02:19 +0100
From: Peter Stephenson <pws@csr.com>
Cc: zsh-workers@sunsite.dk
Subject: Re: D07multibyte.ztst failure on HP-UX 11.11
Message-ID: <20090507170219.46d636e0@news01>
In-Reply-To: <20090507163819.1932f06e@news01>
References: <20090501145253.GA5070@svalbard>
	<200905011518.n41FIlHi005089@news01.csr.com>
	<20090505193931.GA2944@svalbard>
	<20090506202206.63bc26b0@pws-pc>
	<20090506215026.GA5565@otaku>
	<20090507163819.1932f06e@news01>
Organization: CSR
X-Mailer: Claws Mail 3.5.0 (GTK+ 2.12.8; i386-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: quoted-printable
X-OriginalArrivalTime: 07 May 2009 16:02:19.0966 (UTC) FILETIME=[33675DE0:01C9CF2D]
X-Scanned-By: MailControl A-06-00-00 (www.mailcontrol.com) on 10.68.0.157
X-Virus-Scanned: ClamAV 0.92.1/9340/Thu May  7 16:10:34 2009 on bifrost
X-Virus-Status: Clean

On Thu, 7 May 2009 16:38:19 +0100
Peter Stephenson <pws@csr.com> wrote:
>   (unsetopt multibyte; print $'\xc5') | read
>=20
> returns status 1 with no output.
>=20
> I'm fairly happy this isn't a shell bug...

Having said that, actually there's no good reason why "read" shouldn't just
accept any old junk and let whoever is looking at the variable handle it.
This fixes that, and adds a test for it.

This means your test still fails, however.  I'm not sure what to do about
this since clearly the test *does* fail; you don't get a valid character or
an error.  Since character set conversion isn't working on your system (as
evinced by the result of not setting the C locale), I suppose we could test
that and if so skip the test?

Index: Src/builtin.c
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D
RCS file: /cvsroot/zsh/zsh/Src/builtin.c,v
retrieving revision 1.224
diff -u -r1.224 builtin.c
--- Src/builtin.c	25 Mar 2009 09:52:41 -0000	1.224
+++ Src/builtin.c	7 May 2009 15:55:58 -0000
@@ -5546,8 +5546,12 @@
 		wc =3D (wchar_t)c;
 	    }
 	    if (ret !=3D MB_INCOMPLETE) {
-		if (ret =3D=3D MB_INVALID)
+		if (ret =3D=3D MB_INVALID) {
 		    memset(&mbs, 0, sizeof(mbs));
+		    /* Treat this as a single character */
+		    wc =3D (wchar_t)c;
+		    laststart =3D bptr;
+		}
 		/*
 		 * \ at the end of a line introduces a continuation line,
 		 * except in raw mode (-r option)
Index: Test/D07multibyte.ztst
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D
RCS file: /cvsroot/zsh/zsh/Test/D07multibyte.ztst,v
retrieving revision 1.31
diff -u -r1.31 D07multibyte.ztst
--- Test/D07multibyte.ztst	30 Apr 2009 08:37:13 -0000	1.31
+++ Test/D07multibyte.ztst	7 May 2009 15:55:58 -0000
@@ -427,3 +427,9 @@
 >=C4=84 =D0=9F=D1=91=D1=82=D1=80 =D0=98=D0=BB=D1=8C=D0=B8=D1=87 =D0=A7=D0=
=B0=D0=B9=D0=BA=D0=BE=D0=B2=D1=81=D0=BA=D0=B8=D0=B9 =E6=A2=B6=E6=B5=A6=E7=
=94=B1=E8=A8=98
 >=C4=84 =D0=9F=D1=91=D1=82=D1=80 =D0=98=D0=BB=D1=8C=D0=B8=D1=87 =D0=A7=D0=
=B0=D0=B9=D0=BA=D0=BE=D0=B2=D1=81=D0=BA=D0=B8=D0=B9 =E6=A2=B6=E6=B5=A6=E7=
=94=B1=E8=A8=98
 >=C4=84 =D0=9F=D1=91=D1=82=D1=80 =D0=98=D0=BB=D1=8C=D0=B8=D1=87 =D0=A7=D0=
=B0=D0=B9=D0=BA=D0=BE=D0=B2=D1=81=D0=BA=D0=B8=D0=B9 =E6=A2=B6=E6=B5=A6=E7=
=94=B1=E8=A8=98
+
+  setopt cbases
+  print $'\xc5' | read
+  print $(( [#16] #REPLY ))
+0:read passes through invalid multibyte characters
+>0xC5


--=20
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070

