From zsh-workers-return-17266-mason-zsh=primenet.com.au@sunsite.dk Fri May 31 04:59:52 2002
Return-Path: <zsh-workers-return-17266-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 4009 invoked from network); 31 May 2002 04:59:51 -0000
Received: from sunsite.dk (130.225.247.90)
  by ns1.primenet.com.au with SMTP; 31 May 2002 04:59:51 -0000
Received: (qmail 5087 invoked by alias); 31 May 2002 04:59:42 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 17266
Received: (qmail 5074 invoked from network); 31 May 2002 04:59:41 -0000
Date: Fri, 31 May 2002 00:59:37 -0400
From: Clint Adams <clint@zsh.org>
To: zsh-workers@sunsite.dk
Subject: PATCH: _man and manpath
Message-ID: <20020531045937.GA9093@dman.com>
Mime-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
User-Agent: Mutt/1.3.28i
X-Virus-Scanned: by amavisd-milter (http://amavis.org/)

If $MANPATH is set and different from $(manpath), _man will never get
the output of of manpath since $manpath is tied to $MANPATH.

With this patch, it will.

Index: Completion/Unix/Command/_man
===================================================================
RCS file: /cvsroot/zsh/zsh/Completion/Unix/Command/_man,v
retrieving revision 1.5
diff -u -r1.5 _man
--- Completion/Unix/Command/_man	10 Jan 2002 11:00:05 -0000	1.5
+++ Completion/Unix/Command/_man	31 May 2002 04:55:32 -0000
@@ -7,20 +7,24 @@
     _files || return 0
   fi
 
-  if (( ! $#manpath )); then
+  if (( ! $#_manpath )); then
     local mp
-    mp=($(manpath 2>/dev/null))
+    mp=( ${(s.:.)$(manpath 2>/dev/null)} )
     [[ "$mp" == *:* ]] && mp=( ${(s.:.)mp} )
-    manpath=( $mp )
+    if (( $#mp )); then
+      _manpath=( $mp )
+    elif (( $#manpath )); then
+      _manpath=( $manpath )
+    fi
   fi
 
-  (( $#manpath )) || manpath=( ${(s.:.)$(manpath 2>/dev/null)} ) ||
-      manpath=( /usr/man(-/) /(opt|usr)/(dt|share|X11R6|local)/(cat|)man(-/) )
+  (( $#_manpath )) ||
+      _manpath=( /usr/man(-/) /(opt|usr)/(dt|share|X11R6|local)/(cat|)man(-/) )
 
   # `sman' is the SGML manual directory for Solaris 7.
   # 1M is system administrator commands on SVR4
 
-  mrd=(${^manpath/\%L/${LANG:-En_US.ASCII}}/mandb(N))
+  mrd=(${^_manpath/\%L/${LANG:-En_US.ASCII}}/mandb(N))
 
   local sect
   if [[ $OSTYPE = solaris* ]]; then
@@ -34,10 +38,10 @@
   fi
 
   if [[ $sect = (<->*|1M|l|n) || $sect = \(*\|*\) ]]; then
-    dirs=( $^manpath/(sman|man|cat)${~sect}/ )
+    dirs=( $^_manpath/(sman|man|cat)${~sect}/ )
     awk="\$2 == \"$sect\" {print \$1}"
   else
-    dirs=( $^manpath/(sman|man|cat)*/ )
+    dirs=( $^_manpath/(sman|man|cat)*/ )
     awk='{print $1}'
   fi
   if zstyle -t ":completion:${curcontext}:manuals" separate-sections; then

