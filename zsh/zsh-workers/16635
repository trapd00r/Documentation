From zsh-workers-return-16635-mason-zsh=primenet.com.au@sunsite.dk Thu Feb 14 05:32:06 2002
Return-Path: <zsh-workers-return-16635-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 24678 invoked from network); 14 Feb 2002 05:32:06 -0000
Received: from sunsite.dk (130.225.247.90)
  by ns1.primenet.com.au with SMTP; 14 Feb 2002 05:32:06 -0000
Received: (qmail 26553 invoked by alias); 14 Feb 2002 05:31:59 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 16635
Received: (qmail 26542 invoked from network); 14 Feb 2002 05:31:57 -0000
To: zsh-workers@sunsite.dk
Path: not-for-mail
From: Geoff Wing <mason@primenet.com.au>
X-Newsgroups: lists.zsh.workers
Subject: PATCH: completion listing and singlelinezle
Date: Thu, 14 Feb 2002 05:31:52 +0000 (UTC)
Organization: PrimeNet Computer Consultants
Lines: 58
Message-ID: <a4fi48$o2t$1@coral.primenet.com.au>
References: <12996.1012931557@csr.com> <15458.16000.496414.167960@wischnow.berkom.de>
Reply-To: mason@primenet.com.au
NNTP-Posting-Host: localhost.primenet.com.au
X-Trace: coral.primenet.com.au 1013664712 24669 127.0.0.1 (14 Feb 2002 05:31:52 GMT)
X-Complaints-To: usenet@coral.primenet.com.au
NNTP-Posting-Date: Thu, 14 Feb 2002 05:31:52 +0000 (UTC)
User-Agent: slrn/0.9.7.3 (NetBSD)

Sven Wischnowsky <wischnow@berkom.de> typed:
: Peter Stephenson wrote:
:> A colleague pointed out to me that somebody on comp.unix.shell found out
:> that singlelinezle completely screws up completion listings.  They were

:> I tried back in 3.0.6 (pre-installed on this Solaris 5.8 system) and it
:> sort-of worked, without alwayslastprompt behaviour, but there is an odd bug
:> that the display doesn't get refreshed properly until you type another
:> character.  I hope that's an old bug we don't need to worry about any
:> more.

Seems to be gone.  Could repro in 3.0.8 but not in 4.*
 
: As far as I can see in zrefresh(), with singlelinezle it gives up
: (zle_refresh.c:394ff) before coming to the code that decides whether
: the list has to be displayed (line 650).

Found out that zle_refresh.c didn't have any goto statements in it yet
so I thought I better do one :-)

Index: Src/Zle/zle_refresh.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/zle_refresh.c,v
retrieving revision 1.4
diff -u -r1.4 zle_refresh.c
--- Src/Zle/zle_refresh.c	24 Oct 2001 07:00:49 -0000	1.4
+++ Src/Zle/zle_refresh.c	14 Feb 2002 05:20:41 -0000
@@ -393,7 +393,7 @@
 
     if (termflags & TERM_SHORT) {
 	singlerefresh();
-	return;
+	goto singlelineout;
     }
 
     if (cs < 0) {
@@ -643,6 +643,7 @@
     onumscrolls = numscrolls;
     if (nlnct > vmaxln)
 	vmaxln = nlnct;
+singlelineout:
     fflush(shout);		/* make sure everything is written out */
 
     /* if we have a new list showing, note it; if part of the list has been
@@ -1183,7 +1184,6 @@
     qbuf = nbuf;
     nbuf = obuf;
     obuf = qbuf;
-    fflush(shout);		/* make sure everything is written out */
 }
 
 /**/

Regards,
-- 
Geoff Wing : <gcw@pobox.com>
Rxvt Stuff : <gcw@rxvt.org>
Zsh Stuff  : <gcw@zsh.org>

