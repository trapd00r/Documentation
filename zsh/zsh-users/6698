From zsh-users-return-6698-mason-zsh=primenet.com.au@sunsite.dk Tue Oct 14 06:29:54 2003
Return-Path: <zsh-users-return-6698-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 859 invoked from network); 14 Oct 2003 06:29:53 -0000
Received: from sunsite.dk (130.225.247.90)
  by ns1.primenet.com.au with SMTP; 14 Oct 2003 06:29:53 -0000
Received: (qmail 22430 invoked by alias); 14 Oct 2003 06:29:36 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 6698
Received: (qmail 22410 invoked from network); 14 Oct 2003 06:29:35 -0000
Received: from localhost (HELO sunsite.dk) (127.0.0.1)
  by localhost with SMTP; 14 Oct 2003 06:29:35 -0000
X-MessageWall-Score: 0 (sunsite.dk)
Received: from [66.93.131.57] by sunsite.dk (MessageWall 1.0.8) with SMTP; 14 Oct 2003 6:29:35 -0000
Received: from lorien.emufarm.org (localhost [127.0.0.1])
	by lorien.emufarm.org (8.12.7/8.12.7) with ESMTP id h9E6TXfS014799
	for <zsh-users@sunsite.dk>; Mon, 13 Oct 2003 23:29:34 -0700
Received: (from duvall@localhost)
	by lorien.emufarm.org (8.12.7/8.12.7/Submit) id h9E6TXKM014798
	for zsh-users@sunsite.dk; Mon, 13 Oct 2003 23:29:33 -0700
Date: Mon, 13 Oct 2003 23:29:33 -0700
From: Danek Duvall <duvall@emufarm.org>
To: zsh-users@sunsite.dk
Subject: need for a fancier _pick_variant?
Message-ID: <20031014062933.GC13457@lorien.emufarm.org>
Mail-Followup-To: Danek Duvall <duvall@emufarm.org>, zsh-users@sunsite.dk
Mime-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
User-Agent: Mutt/1.5.4i

I was debugging why

    % diff -u foo ba<TAB>

failed to complete "bar" on Solaris.  The reason, of course is that
_diff_options calls

    _pick_variant -c diff 'gnu=GNU' unix -v

which doesn't match anything for Solaris diff, so the generic unix diff
options are chosen, and the result is thrown by the -u.

Unfortunately, I don't know of any way of distinguishing Solaris diff by
its output, short of a brittle check of its usage statement.  I can,
however, reliably check what options are available for it by running
"what /usr/bin/diff", noting SunOS, and the OS version.

I tried a very naive

   _pick_variant -c what -r diff solaris=SunOS unix '$(whence diff)'

as the test for an elif clause in _diff_options, but it didn't work.  On
re-reading the man page, I misunderstood what -r did, but that's only
the tip of the iceberg here.

I next tried

  elif [[ $(what $(whence $cmd)) == *SunOS\ 5.<9->* ]]; then

which seems to work pretty nicely.  Would you suggest that as a
solution, or to try to beef up _pick_variant to support running
auxiliary programs as tests?

Hm.  In investigating all this, I noticed that all the completion
directories end up duplicated in $fpath, which seems to be done in
compaudit.  This seems to happen on 4.0.5 on Solaris, 4.1.1 on Solaris,
and 4.1.1 on Linux, FWIW.

Thanks,
Danek

