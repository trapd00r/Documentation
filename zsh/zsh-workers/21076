From zsh-workers-return-21076-mason-zsh=primenet.com.au@sunsite.dk Thu Mar 31 14:17:55 2005
Return-Path: <zsh-workers-return-21076-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 24118 invoked from network); 31 Mar 2005 14:17:54 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 31 Mar 2005 14:17:54 -0000
Received: (qmail 24424 invoked from network); 31 Mar 2005 14:17:47 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 31 Mar 2005 14:17:47 -0000
Received: (qmail 14564 invoked by alias); 31 Mar 2005 14:17:44 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 21076
Received: (qmail 14549 invoked from network); 31 Mar 2005 14:17:44 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 31 Mar 2005 14:17:44 -0000
Received: (qmail 24171 invoked from network); 31 Mar 2005 14:17:44 -0000
Received: from mail36.messagelabs.com (193.109.254.211)
  by a.mx.sunsite.dk with SMTP; 31 Mar 2005 14:17:36 -0000
X-VirusChecked: Checked
X-Env-Sender: okiddle@yahoo.co.uk
X-Msg-Ref: server-11.tower-36.messagelabs.com!1112278655!15717886!1
X-StarScan-Version: 5.4.11; banners=-,-,-
X-Originating-IP: [158.234.9.163]
Received: (qmail 23997 invoked from network); 31 Mar 2005 14:17:35 -0000
Received: from iris.logica.co.uk (158.234.9.163)
  by server-11.tower-36.messagelabs.com with SMTP; 31 Mar 2005 14:17:35 -0000
Received: from trentino.logica.co.uk ([158.234.142.59])
	by iris.logica.co.uk (8.12.3/8.12.3/Debian -4) with ESMTP id j2VEHY4U028766;
	Thu, 31 Mar 2005 15:17:34 +0100
Received: from trentino.groupinfra.com (localhost [127.0.0.1])
	by trentino.logica.co.uk (Postfix) with ESMTP id D46793BFE5;
	Thu, 31 Mar 2005 16:17:13 +0200 (CEST)
X-VirusChecked: Checked
X-StarScan-Version: 5.0.7; banners=.,-,-
In-reply-to: <20050327003652.GA20238@scowler.net> 
From: Oliver Kiddle <okiddle@yahoo.co.uk>
References: <20050317142638.GA23797@dixsept.loria.fr> <20050325142839.GA32333@scowler.net> <20050325161734.GT19392@ay.vinc17.org> <20050327003652.GA20238@scowler.net>
To: zsh-workers@sunsite.dk, Vincent Lefevre <vincent@vinc17.org>,
   299950-forwarded@bugs.debian.org
Subject: Re: Bug#299950: zsh: Better completion for "svn revert" 
Date: Thu, 31 Mar 2005 16:17:13 +0200
Message-ID: <5059.1112278633@trentino.groupinfra.com>
X-Spam-Checker-Version: SpamAssassin 3.0.2 on a.mx.sunsite.dk
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=6.0 tests=AWL,BAYES_00 autolearn=ham 
	version=3.0.2
X-Spam-Hits: -2.6

On 26 Mar, Clint wrote:
> > This wouldn't be sufficient. In the first column, this would be at
> > least 'A', 'D' (note that the file no longer exists, but completion
> > should be able to give the deleted file) and 'M'. In the second
> > column, this would be 'M'.
> 
> I'm not sure I understand.  Does this patch make it do the right thing?

In addition to the points made by Vincent, it is also better to use
_files instead of rewriting filename completion. If you need complicated
rules to decide which files to include then use a function with the e
glob qualifier. This is what _svn_controlled does to pick up files under
configuration control. The result is that the file-patterns style and
many other nice features of _files/_path_files will work.

The following patch adds two new functions: _svn_deletedfiles and
_svn_status for use with the e qualifier.

_svn_status checks files against the output of svn status. By default it
picks up modified and added files.

Of course _files doesn't complete files which don't already exist.
_svn_deletedfiles uses a trick I've never tried before with _files: it
fills up the reply array. Usage is along the lines of:
  _files -g '.svn(/e:_svn_deletedfiles:)'
This seems to work quite nicely but I won't be suprised if some problems
arrise. It'll be interesting to see. Only thing I've seen is that they
don't get a space suffix.

Oliver

Index: Completion/Unix/Command/_subversion
===================================================================
RCS file: /cvsroot/zsh/zsh/Completion/Unix/Command/_subversion,v
retrieving revision 1.9
diff -u -r1.9 _subversion
--- Completion/Unix/Command/_subversion	27 Mar 2005 00:41:00 -0000	1.9
+++ Completion/Unix/Command/_subversion	31 Mar 2005 14:13:34 -0000
@@ -21,9 +21,28 @@
   [[ -f ${(M)REPLY##*/}.svn/text-base/${REPLY##*/}.svn-base ]]
 }
 
-(( $+functions[_svn_adm_files] )) ||
-_svn_adm_files() {
-  compadd ${${(M)${(f)"$(svn status)"}:#(#s)[ADM]*}##[ADM] ##}
+(( $+functions[_svn_deletedfiles] )) ||
+_svn_deletedfiles() {
+  # Typical usage would be _files -g '.svn(/e:_svn_deletedfiles:)' 
+  local cont controlled
+  reply=( )
+  [[ $REPLY = (*/|).svn ]] || return
+  controlled=( $REPLY/text-base/*.svn-base(N:r:t) )
+  for cont in ${controlled}; do
+    [[ -e $REPLY:h/$cont ]] || reply+=( ${REPLY%.svn}$cont )
+  done
+}
+
+(( $+functions[_svn_status] )) ||
+_svn_status() {
+  local dir=$REPLY:h
+  local pat="${1:-([ADMR]|?M)}"
+
+  if (( ! $+_cache_svn_status[$dir] )); then
+    _cache_svn_status[$dir]="$(_call_program files svn status -N $dir)"
+  fi
+
+  (( ${(M)#${(f)_cache_svn_status[$dir]}:#(#s)${~pat}*$REPLY} ))
 }
 
 (( $+functions[_svn_urls] )) ||
@@ -68,6 +87,7 @@
 (( $+functions[_svn_subcommand] )) ||
 _svn_subcommand () {
   local subcmd _svn_subcmds _svn_subcmd_usage
+  typeset -A _cache_svn_status
 
   _svn_subcmd_usage=${${(M)${(f)"$(LC_MESSAGES=C _call_program options svn help $1)"}:#usage:*}#usage: $1 }
 
@@ -87,9 +107,14 @@
 	'*:file:_files -g "*(e:_svn_controlled:)"'
       )
     ;;
-    (revert)
+    delete)
+      _svn_subcmds+=(
+        '*:file:_files -g ".svn(/e:_svn_deletedfiles:)"'
+      )
+    ;;
+    revert|commit)
       _svn_subcmds+=(
-	'*:file:_svn_adm_files'
+        '*:file:_files -g "(.svn|*)(/e:_svn_deletedfiles:,e:_svn_status:)"'
       )
     ;;
     *)

