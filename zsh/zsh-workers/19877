From zsh-workers-return-19877-mason-zsh=primenet.com.au@sunsite.dk Tue May 04 15:31:52 2004
Return-Path: <zsh-workers-return-19877-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 14009 invoked from network); 4 May 2004 15:31:51 -0000
Received: from thor.dotsrc.org (HELO a.mx.sunsite.dk) (qmailr@130.225.247.86)
  by ns1.primenet.com.au with SMTP; 4 May 2004 15:31:51 -0000
Received: (qmail 9296 invoked from network); 4 May 2004 15:31:34 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 4 May 2004 15:31:34 -0000
Received: (qmail 24395 invoked by alias); 4 May 2004 15:31:28 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 19877
Received: (qmail 24384 invoked from network); 4 May 2004 15:31:28 -0000
Received: from thor.dotsrc.org (HELO a.mx.sunsite.dk) (qmailr@130.225.247.86)
  by sunsite.dk with SMTP; 4 May 2004 15:31:25 -0000
Received: (qmail 8957 invoked from network); 4 May 2004 15:31:24 -0000
Received: from lhuumrelay3.lnd.ops.eu.uu.net (62.189.58.19)
  by a.mx.sunsite.dk with SMTP; 4 May 2004 15:31:23 -0000
Received: from MAILSWEEPER01.csr.com (mailhost1.csr.com [62.189.183.235])
	by lhuumrelay3.lnd.ops.eu.uu.net (8.11.0/8.11.0) with ESMTP id i44FUuv11125
	for <zsh-workers@sunsite.dk>; Tue, 4 May 2004 15:30:56 GMT
Received: from EXCHANGE02.csr.com (unverified [192.168.137.45]) by MAILSWEEPER01.csr.com
 (Content Technologies SMTPRS 4.3.12) with ESMTP id <T695d42d525c0a88d01420@MAILSWEEPER01.csr.com> for <zsh-workers@sunsite.dk>;
 Tue, 4 May 2004 16:30:27 +0100
Received: from csr.com ([192.168.144.127]) by EXCHANGE02.csr.com with Microsoft SMTPSVC(5.0.2195.6713);
	 Tue, 4 May 2004 16:32:13 +0100
To: zsh-workers@sunsite.dk
Subject: Re: Bug#245974: zsh: export LC_ALL=da_DK causes segfault 
In-reply-to: "Clint Adams"'s message of "Tue, 04 May 2004 11:06:19 EDT."
             <20040504150619.GA28923@scowler.net> 
Date: Tue, 04 May 2004 16:30:55 +0100
Message-ID: <7357.1083684655@csr.com>
From: Peter Stephenson <pws@csr.com>
X-OriginalArrivalTime: 04 May 2004 15:32:13.0338 (UTC) FILETIME=[F9090FA0:01C431EC]
X-Spam-Checker-Version: SpamAssassin 2.63 on a.mx.sunsite.dk
X-Spam-Level: 
X-Spam-Status: No, hits=0.0 required=6.0 tests=BAYES_50 autolearn=no 
	version=2.63
X-Spam-Hits: 0.0

Clint Adams wrote:
> > This is a better patch, although it's not ideal, owing to the interface
> > of strftime which doesn't signal success or failure properly.
> 
> glibc suggests this method
> 
>           buf[0] = '\1';
>           len = strftime (buf, bufsize, format, tp);
>           if (len == 0 && buf[0] != '\0')
>             {
>               /* Something went wrong in the strftime call.  */
>               ...
>             }
> 
> If it's portable, it would seem a better hack.

I agree, although I don't know if it's portable... the following allows
ztrftime to return -1 for an error.  If the fix isn't portable, it means
we won't handle long strings properly.  I've still limited the size of
the loop in the prompt, since I'm paranoid.  I think making the size
of the buffer depend on the length of the format should also improve
matters there.

Index: Src/prompt.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/prompt.c,v
retrieving revision 1.16
diff -u -r1.16 prompt.c
--- Src/prompt.c	4 May 2004 04:17:29 -0000	1.16
+++ Src/prompt.c	4 May 2004 15:25:22 -0000
@@ -526,11 +526,16 @@
 		    }
 		    timet = time(NULL);
 		    tm = localtime(&timet);
-		    for(t0=80; ; t0*=2) {
+		    /*
+		     * Hack because strftime won't say how
+		     * much space it actually needs.  Try to add it
+		     * a few times until it works.  Some formats don't
+		     * actually have a length, so we could go on for
+		     * ever.
+		     */
+		    for(j = 0, t0 = strlen(tmfmt)*8; j < 3; j++, t0*=2) {
 			addbufspc(t0);
-			if (ztrftime(bp, t0, tmfmt, tm) ||
-			    !strcmp("%P", tmfmt) ||
-			    !strcmp("%p", tmfmt))
+			if (ztrftime(bp, t0, tmfmt, tm) >= 0)
 			    break;
 		    }
 		    bp += strlen(bp);
Index: Src/utils.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/utils.c,v
retrieving revision 1.59
diff -u -r1.59 utils.c
--- Src/utils.c	4 May 2004 04:17:29 -0000	1.59
+++ Src/utils.c	4 May 2004 15:25:31 -0000
@@ -1719,6 +1719,11 @@
  * Like the system function, this returns the number of characters
  * copied, not including the terminating NUL.  This may be zero
  * if the string didn't fit.
+ *
+ * As an extension, try to detect an error in strftime --- typically
+ * not enough memory --- and return -1.  Not guaranteed to be portable,
+ * since the strftime() interface doesn't make any guarantees about
+ * the state of the buffer if it returns zero.
  */
 
 /**/
@@ -1831,9 +1836,14 @@
 		 */
 		*buf = '\0';
 		tmp[1] = fmt[-1];
-		if (!strftime(buf, bufsize + 2, tmp, tm) &&
-		    tmp[1]!='p' && tmp[1]!='P')
+		if (!strftime(buf, bufsize + 2, tmp, tm))
+		{
+		    if (*buf) {
+			buf[0] = '\0';
+			return -1;
+		    }
 		    return 0;
+		}
 		decr = strlen(buf);
 		buf += decr;
 		bufsize -= decr - 2;
Index: Src/Modules/datetime.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Modules/datetime.c,v
retrieving revision 1.7
diff -u -r1.7 datetime.c
--- Src/Modules/datetime.c	22 Jan 2004 17:51:06 -0000	1.7
+++ Src/Modules/datetime.c	4 May 2004 15:25:31 -0000
@@ -61,7 +61,7 @@
     buffer = zalloc(bufsize);
 
     for (x=0; x < 4; x++) {
-        if (ztrftime(buffer, bufsize, argv[0], t))
+        if (ztrftime(buffer, bufsize, argv[0], t) >= 0)
 	    break;
 	buffer = zrealloc(buffer, bufsize *= 2);
     }

-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR Ltd., Science Park, Milton Road,
Cambridge, CB4 0WH, UK                          Tel: +44 (0)1223 692070


**********************************************************************
This email and any files transmitted with it are confidential and
intended solely for the use of the individual or entity to whom they
are addressed. If you have received this email in error please notify
the system manager.

This footnote also confirms that this email message has been swept by
MIMEsweeper for the presence of computer viruses.

www.mimesweeper.com
**********************************************************************

