From zsh-workers-return-9424-mason-zsh=primenet.com.au@sunsite.auc.dk Tue Jan 25 09:29:58 2000
Return-Path: <zsh-workers-return-9424-mason-zsh=primenet.com.au@sunsite.auc.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 10596 invoked from network); 25 Jan 2000 09:29:57 -0000
Received: from sunsite.auc.dk (130.225.51.30)
  by ns1.primenet.com.au with SMTP; 25 Jan 2000 09:29:57 -0000
Received: (qmail 406 invoked by alias); 25 Jan 2000 09:29:51 -0000
Mailing-List: contact zsh-workers-help@sunsite.auc.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.auc.dk
X-Seq: 9424
Received: (qmail 397 invoked from network); 25 Jan 2000 09:29:50 -0000
Date: Tue, 25 Jan 2000 10:29:49 +0100 (MET)
Message-Id: <200001250929.KAA14128@beta.informatik.hu-berlin.de>
From: Sven Wischnowsky <wischnow@informatik.hu-berlin.de>
To: zsh-workers@sunsite.auc.dk
In-reply-to: Peter Stephenson's message of Mon, 24 Jan 2000 20:01:02 +0000
Subject: Re: parameter structs still alive


Peter Stephenson wrote:

> ...
>
> However, looking at it again, such parameters are all (as far as I can see)
> created by createparam(), and so can be freed, therefore I should have made
> unsetparam_pm() free the struct when the flag was present --- i.e. just
> change the test and comment right at the end of the function.  This seems
> to be working so far, but maybe you should cast an eye over the effect in
> various modules, too.  (We don't need to test for non-removable specials
> since they were handled a couple of paragraphs back.)

Seems to work fine except for two function in the parameter module
which made named dirs and aliases be removed if one dared to unload
that module.

> Does anybody know what the second argument to the unsetfn() family is for?

It's set if the unset function was invoked by the user calling `unset' 
instead of an endparamscope() (I think the `exp' is for `explicit').

This is useful, for example, the completion code uses it to set its
special parameters to the empty string/array only if the user unset
them explicitly. If called from endparamscope(), the values are not
changed so that the completion code can still use them after the
widget has finished.

Bye
 Sven

diff -ru ../z.old/Src/Modules/parameter.c Src/Modules/parameter.c
--- ../z.old/Src/Modules/parameter.c	Tue Jan 25 09:15:13 2000
+++ Src/Modules/parameter.c	Tue Jan 25 10:23:40 2000
@@ -1418,6 +1418,9 @@
     int i;
     HashNode hn, next, hd;
 
+    if (!ht)
+	return;
+
     for (i = 0; i < nameddirtab->hsize; i++)
 	for (hn = nameddirtab->nodes[i]; hn; hn = next) {
 	    next = hn->next;
@@ -1426,9 +1429,6 @@
 		nameddirtab->freenode(hd);
 	}
 
-    if (!ht)
-	return;
-
     for (i = 0; i < ht->hsize; i++)
 	for (hn = ht->nodes[i]; hn; hn = hn->next) {
 	    struct value v;
@@ -1649,6 +1649,9 @@
     int i;
     HashNode hn, next, hd;
 
+    if (!ht)
+	return;
+
     for (i = 0; i < aliastab->hsize; i++)
 	for (hn = aliastab->nodes[i]; hn; hn = next) {
 	    next = hn->next;
@@ -1657,9 +1660,6 @@
 		(hd = aliastab->removenode(aliastab, hn->nam)))
 		aliastab->freenode(hd);
 	}
-
-    if (!ht)
-	return;
 
     for (i = 0; i < ht->hsize; i++)
 	for (hn = ht->nodes[i]; hn; hn = hn->next) {

--
Sven Wischnowsky                         wischnow@informatik.hu-berlin.de

