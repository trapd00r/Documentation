From zsh-workers-return-24109-mason-zsh=primenet.com.au@sunsite.dk Wed Nov 21 09:41:05 2007
Return-Path: <zsh-workers-return-24109-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 12563 invoked from network); 21 Nov 2007 09:40:55 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.3 (2007-08-08) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.3
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 21 Nov 2007 09:40:55 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 92959 invoked from network); 21 Nov 2007 09:40:49 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 21 Nov 2007 09:40:49 -0000
Received: (qmail 21764 invoked by alias); 21 Nov 2007 09:40:43 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 24109
Received: (qmail 21749 invoked from network); 21 Nov 2007 09:40:43 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 21 Nov 2007 09:40:43 -0000
Received: (qmail 92505 invoked from network); 21 Nov 2007 09:40:43 -0000
Received: from vinc17.pck.nerim.net (HELO prunille.vinc17.org) (213.41.242.187)
  by a.mx.sunsite.dk with SMTP; 21 Nov 2007 09:40:38 -0000
Received: by prunille.vinc17.org (Postfix, from userid 501)
	id 49C0C1BCD8BD; Wed, 21 Nov 2007 10:40:37 +0100 (CET)
Date: Wed, 21 Nov 2007 10:40:37 +0100
From: Vincent Lefevre <vincent@vinc17.org>
To: "Zsh Hackers' List" <zsh-workers@sunsite.dk>
Subject: Re: zsh-4.3.4-dev-2.tar.gz
Message-ID: <20071121094036.GH1499@prunille.vinc17.org>
Mail-Followup-To: "Zsh Hackers' List" <zsh-workers@sunsite.dk>
References: <11649.1195558694@csr.com> <4742DC87.5030901@math.technion.ac.il> <20071120141442.55f7ac28@news01> <4742F733.4030908@math.technion.ac.il> <20071120154246.30388170@news01>
MIME-Version: 1.0
Content-Type: text/plain; charset=iso-8859-1
Content-Disposition: inline
Content-Transfer-Encoding: 8bit
In-Reply-To: <20071120154246.30388170@news01>
X-Mailer-Info: http://www.vinc17.org/mutt/
User-Agent: Mutt/1.5.17-vl-r19795 (2007-11-20)

On 2007-11-20 15:42:46 +0000, Peter Stephenson wrote:
> +#ifdef ZSH_IGNORE_NCURSES
> +# ifdef HAVE_CURSES_H
> +#  include <curses.h>
> +# endif
> +#else
> +# ifdef HAVE_NCURSESW_NCURSES_H
> +#  include <ncursesw/ncurses.h>
> +# else
> +#  ifdef HAVE_NCURSES_H
> +#   include <ncurses.h>
> +#  else
> +#   ifdef HAVE_NCURSES_NCURSES_H
> +#    include <ncurses/ncurses.h>
> +#   else
> +#    ifdef HAVE_CURSES_H
> +#     include <curses.h>
> +#    endif
> +#   endif
> +#  endif
> +# endif
>  #endif

Shouldn't HAVE_NCURSES_NCURSES_H and HAVE_NCURSES_H be reversed,
in case both are defined? Indeed I assume that <ncurses/ncurses.h>
should have the precedence over <ncurses.h> since the former is
the canonical place, isn't it?

FYI, on my Mac OS X machine:

prunille:~> locate ncurses.h
/Developer/SDKs/MacOSX10.3.9.sdk/usr/include/ncurses.h
/Developer/SDKs/MacOSX10.4u.sdk/usr/include/ncurses.h
/opt/local/include/ncurses/ncurses.h
/opt/local/include/ncursesw/ncurses.h
/opt/local/var/macports/software/ncurses/5.6_0+darwin_8/opt/local/include/ncurses/ncurses.h
/opt/local/var/macports/software/ncursesw/5.6_0+darwin_8/opt/local/include/ncursesw/ncurses.h
/usr/include/ncurses.h

prunille:~> locate libncurses.dylib
/Applications/Gimp.app/Contents/Resources/lib/libncurses.dylib
/Developer/SDKs/MacOSX10.3.9.sdk/usr/lib/libncurses.dylib
/Developer/SDKs/MacOSX10.4u.sdk/usr/lib/libncurses.dylib
/opt/local/lib/libncurses.dylib
/opt/local/var/macports/software/ncurses/5.6_0+darwin_8/opt/local/lib/libncurses.dylib
/usr/lib/libncurses.dylib

So, if libncursesw isn't installed, zsh will currently be built
using /usr/include/ncurses.h (the old Mac OS X header file) and
/opt/local/lib/libncurses.dylib (the new ncurses library installed
via MacPorts). If the ncurses ABI has changed, this can lead to
a broken zsh binary.

BTW, since

  gr -r 'include.*curses' .

on zsh 4.3.4 only gives #include <curses.h> lines, I suppose that my
current zsh 4.3.4 version has been built using /usr/include/curses.h,
but it is linked with /opt/local/lib/libncurses.5.dylib:

prunille:~> otool -L =zsh
/opt/local/bin/zsh:
        /opt/local/lib/libiconv.2.dylib (compatibility version 7.0.0, current version 7.0.0)
        /usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 88.1.10)
        /opt/local/lib/libncurses.5.dylib (compatibility version 5.0.0, current version 5.0.0)

I wonder if this can explain the crashes I get.

-- 
Vincent Lefèvre <vincent@vinc17.org> - Web: <http://www.vinc17.org/>
100% accessible validated (X)HTML - Blog: <http://www.vinc17.org/blog/>
Work: CR INRIA - computer arithmetic / Arenaire project (LIP, ENS-Lyon)

