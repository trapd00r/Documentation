From zsh-workers-return-22820-mason-zsh=primenet.com.au@sunsite.dk Fri Oct 06 16:46:53 2006
Return-Path: <zsh-workers-return-22820-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 29300 invoked from network); 6 Oct 2006 16:46:48 -0000
X-Spam-Checker-Version: SpamAssassin 3.1.6 (2006-10-03) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.4 required=5.0 tests=AWL,BAYES_00,
	FORGED_RCVD_HELO autolearn=ham version=3.1.6
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 6 Oct 2006 16:46:48 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 23802 invoked from network); 6 Oct 2006 16:46:42 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 6 Oct 2006 16:46:42 -0000
Received: (qmail 18236 invoked by alias); 6 Oct 2006 16:46:39 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 22820
Received: (qmail 18227 invoked from network); 6 Oct 2006 16:46:39 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 6 Oct 2006 16:46:39 -0000
Received: (qmail 23471 invoked from network); 6 Oct 2006 16:46:38 -0000
Received: from cluster-c.mailcontrol.com (168.143.177.190)
  by a.mx.sunsite.dk with SMTP; 6 Oct 2006 16:46:33 -0000
Received: from cameurexb01.EUROPE.ROOT.PRI ([62.189.241.200])
	by rly20c.srv.mailcontrol.com (MailControl) with ESMTP id k96GkTB9001963
	for <zsh-workers@sunsite.dk>; Fri, 6 Oct 2006 17:46:30 +0100
Received: from news01.csr.com ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.1830);
	 Fri, 6 Oct 2006 17:46:29 +0100
Received: from news01.csr.com (localhost.localdomain [127.0.0.1])
	by news01.csr.com (8.13.7/8.13.4) with ESMTP id k96GkTiE003629
	for <zsh-workers@sunsite.dk>; Fri, 6 Oct 2006 17:46:29 +0100
Received: from csr.com (pws@localhost)
	by news01.csr.com (8.13.7/8.13.7/Submit) with ESMTP id k96GkSW8003626
	for <zsh-workers@sunsite.dk>; Fri, 6 Oct 2006 17:46:29 +0100
Message-Id: <200610061646.k96GkSW8003626@news01.csr.com>
X-Authentication-Warning: news01.csr.com: pws owned process doing -bs
To: zsh-workers@sunsite.dk (Zsh hackers list)
Subject: Re: _all_matches moves cursor 
In-reply-to: <200610061003.k96A3RQh019503@news01.csr.com> 
References: <20061006051215.GA12364@mollari.zhar.net> <200610060941.k969fbIw017806@news01.csr.com> <200610061003.k96A3RQh019503@news01.csr.com>
Comments: In-reply-to Peter Stephenson <pws@csr.com>
   message dated "Fri, 06 Oct 2006 11:03:27 +0100."
Date: Fri, 06 Oct 2006 17:46:28 +0100
From: Peter Stephenson <pws@csr.com>
X-OriginalArrivalTime: 06 Oct 2006 16:46:29.0425 (UTC) FILETIME=[F8A6BA10:01C6E966]
Content-Type: text/plain
MIME-Version: 1.0
X-Scanned-By: MailControl A-07-04-02 (www.mailcontrol.com) on 10.67.0.130

(Moved to zsh-workers.)

Peter Stephenson wrote:
> I've read it more carefully and I think there's simply a bug in the
> calculation at this point.

Aaarggh! No there isn't, add is already in t.  The patch simply moved
the end of output too far to the left, avoiding the problem.

I'm fed up with this, but given the propensity to abbreviate in the
middle of the line, I think simply omitting the initial space would do.
Nothing else works for reasons I can't fathom.

Index: Src/Zle/compresult.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/compresult.c,v
retrieving revision 1.66
diff -u -r1.66 compresult.c
--- Src/Zle/compresult.c	6 Oct 2006 10:07:38 -0000	1.66
+++ Src/Zle/compresult.c	6 Oct 2006 16:43:18 -0000
@@ -2126,7 +2126,7 @@
 		if (add)
 		    strcat(buf, " ");
 		strcat(buf, m->str);
-		len -= t + add;
+		len -= t;
 		add = 1;
 	    } else {
 		if (len > add + 2) {
@@ -2134,7 +2134,7 @@
 			strcat(buf, " ");
 		    strncat(buf, m->str, len);
 		}
-		strcat(buf, " ...");
+		strcat(buf, "...");
 		break;
 	    }
 	}

-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070


To access the latest news from CSR copy this link into a web browser:  http://www.csr.com/email_sig.php

