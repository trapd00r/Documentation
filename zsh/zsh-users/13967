From zsh-users-return-13967-mason-zsh=primenet.com.au@sunsite.dk Wed Mar 25 12:23:48 2009
Return-Path: <zsh-users-return-13967-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 21641 invoked from network); 25 Mar 2009 12:23:45 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 25 Mar 2009 12:23:45 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 9648 invoked from network); 25 Mar 2009 12:23:29 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 25 Mar 2009 12:23:29 -0000
Received: (qmail 14942 invoked by alias); 25 Mar 2009 12:23:08 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 13967
Received: (qmail 14927 invoked from network); 25 Mar 2009 12:23:07 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 25 Mar 2009 12:23:07 -0000
Received: from n23.bullet.mail.ukl.yahoo.com (n23.bullet.mail.ukl.yahoo.com [87.248.110.140])
	by bifrost.dotsrc.org (Postfix) with SMTP id 6F28480590EB
	for <zsh-users@sunsite.dk>; Wed, 25 Mar 2009 13:23:04 +0100 (CET)
Received: from [217.12.4.215] by n23.bullet.mail.ukl.yahoo.com with NNFMP; 25 Mar 2009 12:23:04 -0000
Received: from [87.248.110.107] by t2.bullet.ukl.yahoo.com with NNFMP; 25 Mar 2009 12:23:04 -0000
Received: from [127.0.0.1] by omp212.mail.ukl.yahoo.com with NNFMP; 25 Mar 2009 12:23:04 -0000
X-Yahoo-Newman-Id: 396742.35308.bm@omp212.mail.ukl.yahoo.com
Received: (qmail 71209 invoked from network); 25 Mar 2009 12:23:04 -0000
DomainKey-Signature: a=rsa-sha1; q=dns; c=nofws;
  s=s1024; d=yahoo.fr;
  h=Received:X-YMail-OSG:X-Yahoo-Newman-Property:Date:From:To:Cc:Subject:Message-ID:Mail-Followup-To:References:MIME-Version:Content-Type:Content-Disposition:In-Reply-To:User-Agent;
  b=6Mr46mpMozBaXbdzeqcllLxQEmGZAMTFcbkKjvWxmP+dgN4NRlEuTdno+2uY/UGKod2azd9HYMdOLW7O7JO9/FNkmNVgNbgw/AGkNCGdm9ZX94JqUyvrlJSR/byajDJKaBAcqLbhHcsmt/L5Qt86cOsKjp77BHV/K0bLAeRzIC8=  ;
Received: from unknown (HELO seebyte.com) (stephane_chazelas@78.105.235.196 with login)
  by smtp103.mail.ukl.yahoo.com with SMTP; 25 Mar 2009 12:23:04 -0000
X-YMail-OSG: TeDiiysVM1koPNiHprmwdvSY6bP00v77GtadP5ACkF1hgV0dlZR8XIEM55MK9jCFX26BAZ1VZhS7Ytx4tw2PP6LLwIcXUGEfQKT1w9SQa1kAKas1JA4VZZSOfv3OucArGLh3lv4TsuM2nWSYHmNhP_jG9pmeR1tZ96RG5Ns.zNXdbK_xd0UDhai0u0kUsvQzg2uuES8A25ZgicZFHaTAi8GffBH88vwN
X-Yahoo-Newman-Property: ymail-3
Date: Wed, 25 Mar 2009 12:23:02 +0000
From: Stephane Chazelas <stephane_chazelas@yahoo.fr>
To: "Benjamin R. Haskell" <zsh@benizi.com>
Cc: Zsh Users <zsh-users@sunsite.dk>
Subject: Re: freebsd problems with carriage return
Message-ID: <chaz20090325122302.GB5054@seebyte.com>
Mail-Followup-To: "Benjamin R. Haskell" <zsh@benizi.com>,
	Zsh Users <zsh-users@sunsite.dk>
References: <20090324101411.66890.qmail@smasher.org> <chaz20090324114727.GA5144@seebyte.com> <20090324213624.93603.qmail@smasher.org> <alpine.LNX.2.00.0903250227080.3609@averatec>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <alpine.LNX.2.00.0903250227080.3609@averatec>
User-Agent: Mutt/1.5.16 (2007-09-19)
X-Virus-Scanned: ClamAV 0.92.1/9164/Wed Mar 25 05:02:31 2009 on bifrost
X-Virus-Status: Clean

2009-03-25 04:18:51 -0400, Benjamin R. Haskell:
[...]
> I think it's a difference in how FreeBSD and Linux handle some 
> tty/job-control settings.  (Though it's not terribly surprising to me... 
> one of those "I'm going to behave differently when you pipe me" things.)  

Except that as far as I can see from the source code, it does an
explicit fflush() after each progress line, so it shouldn't be a
stdio buffering issue. Unless the OP's using an old version of
rsync on FreeBSD?

[...]
> On FreeBSD for me, the status updates are visible when not piped (either 
> displayed to terminal, or redirected to a file).  But, rsync --progress 
> from to | cat -v only shows the final status.
> 
> I noticed in the rsync code (progress.c) that it declines to print the 
> partial status lines (the ones that end with '\r' so that they can be 
> overwritten) depending on the outcome of:
> 
>  210         tc_pgrp = tcgetpgrp(STDOUT_FILENO);
>  211         if (tc_pgrp != pgrp && tc_pgrp != -1)
>  212                 return;

The above is meant not to print the progress if the output is to
a terminal and rsync is not in the foreground process group of
the terminal.

For a pipe, tcgetpgrp should return -1 so that test should fail
(unless there's a bug in FreeBSD? ktrace would probably tell
us).

[...]
> Maybe something in 'stty' will affect the outcome of the above call (but 
> you'd have to ask someone who knows way more about it than I do).  There 
> are at least a handful of differences in the various settings between 
> FreeBSD and Linux for the systems I'm using right now.
[...]

It shouldn't have anything to do with stty as we're not
accessing the terminal here. And stty doesn't affect the
foreground process group of the terminal, it's the shell's job
control that does.

The fact that you don't get the output when stdout is a pipe is
probably the place to look at. But I don't know why rsync would
decide not to output the progress when stdout is pipe as opposed
to when it's a regular file.

Now, looking at:
http://www.freebsd.org/cgi/cvsweb.cgi/src/sys/kern/sys_pipe.c?rev=1.201

pipe_ioctl(...
[...]
         /* This is deprecated, FIOGETOWN should be used instead. */
         case TIOCGPGRP:
                 *(int *)data = -fgetown(&mpipe->pipe_sigio);
                 break;

So tcgetpgrp() is valid on a pipe on FreeBSD, so it contradicts
its man page.

That would be the reason. To fix that, you'd have to patch rsync
to add a isatty() check, or better, remove that check
altogether, as if the user reguested progress with --progress, I
don't agree that rsync should disable it in any circumstance.

-- 
Stephane

