From zsh-workers-return-5436-mason-zsh=primenet.com.au@sunsite.auc.dk Sat Feb 20 13:19:30 1999
Return-Path: <zsh-workers-return-5436-mason-zsh=primenet.com.au@sunsite.auc.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 14807 invoked from network); 20 Feb 1999 13:19:28 -0000
Received: from sunsite.auc.dk (130.225.51.30)
  by ns1.primenet.com.au with SMTP; 20 Feb 1999 13:19:28 -0000
Received: (qmail 98 invoked by alias); 20 Feb 1999 13:18:02 -0000
Mailing-List: contact zsh-workers-help@sunsite.auc.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.auc.dk
X-Seq: 5436
Received: (qmail 10727 invoked from network); 20 Feb 1999 11:13:38 -0000
Message-Id: <9902191720.AA13416@ibmth.df.unipi.it>
To: zsh-workers@sunsite.auc.dk (Zsh hackers list)
Subject: PATCH: 3.1.5-pws-8++: set -x for ((...)), functions
Date: Fri, 19 Feb 1999 18:20:04 +0100
From: Peter Stephenson <pws@ibmth.df.unipi.it>

Here is more set -x stuff for two more common cases, namely function calls
and ((...)) evaluations.  Also, I was reminded about prompt4 since the last
patch.

--- Src/exec.c.xtr2	Tue Feb 16 18:15:15 1999
+++ Src/exec.c	Fri Feb 19 18:12:36 1999
@@ -2529,7 +2529,7 @@
 {
     int stat;
     if (isset(XTRACE)) {
-	fprintf(stderr, "+ [[");
+	fprintf(stderr, "%s[[", prompt4 ? prompt4 : "");
 	tracingcond++;
     }
     stat = !evalcond(cmd->u.cond);
@@ -2550,8 +2550,17 @@
     char *e;
     long val = 0;
 
-    while ((e = (char *) ugetnode(cmd->args)))
+    if (isset(XTRACE))
+	fprintf(stderr, "%s((", prompt4 ? prompt4 : "");
+    while ((e = (char *) ugetnode(cmd->args))) {
+	if (isset(XTRACE))
+	    fprintf(stderr, " %s", e);
 	val = matheval(e);
+    }
+    if (isset(XTRACE)) {
+	fprintf(stderr, " ))\n", stderr);
+	fflush(stderr);
+    }
     errflag = 0;
     return !val;
 }
@@ -2624,6 +2633,18 @@
 	last_file_list = jobtab[thisjob].filelist;
 	jobtab[thisjob].filelist = NULL;
 	deletejob(jobtab + thisjob);
+    }
+
+    if (isset(XTRACE)) {
+	LinkNode lptr;
+	fprintf(stderr, "%s", prompt4 ? prompt4 : prompt4);
+	for (lptr = firstnode(cmd->args); lptr; incnode(lptr)) {
+	    if (lptr != firstnode(cmd->args))
+		fputc(' ', stderr);
+	    fprintf(stderr, "%s", (char *)getdata(lptr));
+	}
+	fputc('\n', stderr);
+	fflush(stderr);
     }
 
     doshfunc(shf->nam, shf->funcdef, cmd->args, shf->flags, 0);

-- 
Peter Stephenson <pws@ibmth.df.unipi.it>       Tel: +39 050 844536
WWW:  http://www.ifh.de/~pws/
Dipartimento di Fisica, Via Buonarroti 2, 56127 Pisa, Italy

