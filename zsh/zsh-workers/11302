From zsh-workers-return-11302-mason-zsh=primenet.com.au@sunsite.auc.dk Wed May 10 15:14:12 2000
Return-Path: <zsh-workers-return-11302-mason-zsh=primenet.com.au@sunsite.auc.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 8480 invoked from network); 10 May 2000 15:14:07 -0000
Received: from sunsite.auc.dk (130.225.51.30)
  by ns1.primenet.com.au with SMTP; 10 May 2000 15:14:07 -0000
Received: (qmail 11710 invoked by alias); 10 May 2000 15:14:00 -0000
Mailing-List: contact zsh-workers-help@sunsite.auc.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.auc.dk
X-Seq: 11302
Received: (qmail 11669 invoked from network); 10 May 2000 15:13:57 -0000
From: "Bart Schaefer" <schaefer@candle.brasslantern.com>
Message-Id: <1000510151331.ZM9852@candle.brasslantern.com>
Date: Wed, 10 May 2000 15:13:31 +0000
In-Reply-To: <0FUC00L2BHP1Y5@la-la.cambridgesiliconradio.com>
Comments: In reply to Peter Stephenson <pws@cambridgesiliconradio.com>
        "PATCH: edit-command-line" (May 10,  2:05pm)
References: <0FUC00L2BHP1Y5@la-la.cambridgesiliconradio.com>
X-Mailer: Z-Mail (5.0.0 30July97)
To: zsh-workers@sunsite.auc.dk (Zsh hackers list)
Subject: Re: PATCH: edit-command-line
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii

On May 10,  2:05pm, Peter Stephenson wrote:
} Subject: PATCH: edit-command-line
}
} I think the LBUFFER= and RBUFFER= are redundant, I put them there while I
} was wondering why the display didn't appear properly after the function,

It looks like zrefresh() only reprints the line up to the previous cursor
position if it hasn't changed beyond that.  The whole line gets redisplayed
correctly only if the cursor was at the start or end of the line when the
function began.  So the call to redisplay is the right thing.

Fiddling with LBUFFER and RBUFFER causes CURSOR to change, though, so I
think we should take those out and explicitly set CURSOR instead.

And being me, I rewrote other stuff as well:  Quote against shwordsplit,
use `print -R -' in case of backslashes or leading dashes in $BUFFER, and
don't let the user's alias for `rm' creep in.

Index: Functions/Zle/edit-command-line
===================================================================
@@ -7,12 +7,11 @@
 
 local tmpfile=${TMPPREFIX:-/tmp/zsh}ecl$$
 
-print $BUFFER >$tmpfile
+print -R - "$BUFFER" >$tmpfile
 exec </dev/tty
 ${VISUAL:-${EDITOR:-vi}} $tmpfile
-LBUFFER=
-RBUFFER=
-BUFFER=$(<$tmpfile)
+BUFFER="$(<$tmpfile)"
+CURSOR=$#BUFFER
 
-rm -f $tmpfile
+command rm -f $tmpfile
 zle redisplay

-- 
Bart Schaefer                                 Brass Lantern Enterprises
http://www.well.com/user/barts              http://www.brasslantern.com

