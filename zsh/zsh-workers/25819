From zsh-workers-return-25819-mason-zsh=primenet.com.au@sunsite.dk Mon Oct 06 23:43:10 2008
Return-Path: <zsh-workers-return-25819-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 841 invoked from network); 6 Oct 2008 23:43:07 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.9 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 6 Oct 2008 23:43:07 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 23540 invoked from network); 6 Oct 2008 23:42:41 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 6 Oct 2008 23:42:41 -0000
Received: (qmail 11034 invoked by alias); 6 Oct 2008 23:42:25 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 25819
Received: (qmail 11011 invoked from network); 6 Oct 2008 23:42:21 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 6 Oct 2008 23:42:21 -0000
Received: from uucp.gnuu.de (unknown [83.246.114.63])
	by bifrost.dotsrc.org (Postfix) with ESMTP id 9F60080308BE
	for <zsh-workers@sunsite.dk>; Tue,  7 Oct 2008 01:42:17 +0200 (CEST)
Received: by uucp.gnuu.de (Postfix, from userid 10)
	id 6987D488024; Tue,  7 Oct 2008 01:42:05 +0200 (CEST)
X-DKIM: Sendmail DKIM Filter v2.5.2 uucp.gnuu.de 6987D488024
DKIM-Signature: v=1; a=rsa-sha256; c=simple/simple; d=gnuu.de; s=banki;
	t=1223336526; i=@alea.gnuu.de; bh=tGESiatd5SClo6RaloWuOltV23PR32P5G
	W81r11UUjM=; h=From:To:Cc:Subject:Date:Message-Id:In-Reply-To:
	 References:MIME-Version:Content-Type:Content-Transfer-Encoding;
	b=r9VuoLuSF0mhUC3a6otYu0TUkkUwJxyy5LPBw9PuhCX+uQRAZF7g+j45iok+odVWG
	jkGnzOmjQ3sInlQT90NiMAkbQVGloceKw4eXnG+K3S6jDelC1uXCaNuBo3Qt4vU5EH9
	2BfEBwaC15QLLIGquxp0DSnYV6O3L0qgXtnUYIA=
Received: from ibook.localnet ([192.168.0.5] helo=alea.gnuu.de)
	by alea.gnuu.de with esmtp (Exim 4.63)
	(envelope-from <joerg@alea.gnuu.de>)
	id 1Kmz27-0000a5-GR
	for zsh-workers@sunsite.dk; Tue, 07 Oct 2008 00:58:32 +0200
Received: from joerg by alea.gnuu.de with local (Exim 4.69)
	(envelope-from <joerg@alea.gnuu.de>)
	id 1Kmz27-0000hM-0j; Tue, 07 Oct 2008 00:58:31 +0200
From: =?utf-8?q?J=C3=B6rg=20Sommer?= <joerg@alea.gnuu.de>
To: zsh-workers@sunsite.dk
Cc: =?utf-8?q?J=C3=B6rg=20Sommer?= <joerg@alea.gnuu.de>
Subject: [PATCH 4/4] Improve module parameter completion
Date: Tue,  7 Oct 2008 00:58:30 +0200
Message-Id: <1223333910-2641-4-git-send-email-joerg@alea.gnuu.de>
X-Mailer: git-send-email 1.6.0.1
In-Reply-To: <1223333910-2641-3-git-send-email-joerg@alea.gnuu.de>
References: <1223333910-2641-1-git-send-email-joerg@alea.gnuu.de>
 <1223333910-2641-2-git-send-email-joerg@alea.gnuu.de>
 <1223333910-2641-3-git-send-email-joerg@alea.gnuu.de>
MIME-Version: 1.0
Content-Type: text/plain; charset=utf-8
Content-Transfer-Encoding: 8bit
X-Virus-Scanned: ClamAV 0.92.1/8379/Mon Oct  6 21:56:44 2008 on bifrost
X-Virus-Status: Clean

First, do not embedd the = in the parameter by define it a
parameter‐value separator; -S =.

Second, look for already given parameters in all words; -w.

Third, use the curcontext variable; -C.

Forth, distinct between boolean and non‐boolean parameters, i.e. do not
append a = to the end. And include the type of the parameter in the help
message. This information is only given in the full output of modinfo,
not in the narrowed output with --field.
---
 Completion/Linux/Command/_modutils |   13 ++++++++++---
 1 files changed, 10 insertions(+), 3 deletions(-)

diff --git a/Completion/Linux/Command/_modutils b/Completion/Linux/Command/_modutils
index faab852..eefb11f 100644
--- a/Completion/Linux/Command/_modutils
+++ b/Completion/Linux/Command/_modutils
@@ -95,10 +95,17 @@ case "$state" in
     if compset -P '*='; then
       _message -e value 'parameter value'
     else
-      typeset -A val_args
+      local params
+      params=( ${${(M)${(f)"$(_call_program module_parameter modinfo "$words[2]" 2>/dev/null)"}:#parm:*}##parm:[[:space:]]##} )
+      if [[ $#params -eq 0 ]]; then
+        _message -e parameter "This modules doesn't have parameters"
+      else
+        typeset -A val_args
 
-      _values 'module parameter' \
-        ${(f)^"$(_call_program module_parameter modinfo -F parm "$words[2]" 2>/dev/null)"//:/\=[}\] && ret=0
+        _values -S = -C -w 'module parameter' \
+          ${${${(M)params:#*(:bool|\(bool\))}/:/[}/(bool| \(bool\))/]} \
+          ${^${params:#*(:bool|\(bool\))}/:/[}"]:auto added argument: " && ret=0
+      fi
     fi
   ;;
 esac
-- 
1.6.0.1

