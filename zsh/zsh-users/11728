From zsh-users-return-11728-mason-zsh=primenet.com.au@sunsite.dk Sun Aug 05 19:40:17 2007
Return-Path: <zsh-users-return-11728-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 28758 invoked from network); 5 Aug 2007 19:40:15 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.1 (2007-05-02) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=BAYES_00 autolearn=ham
	version=3.2.1
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 5 Aug 2007 19:40:15 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 13092 invoked from network); 5 Aug 2007 19:40:09 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 5 Aug 2007 19:40:09 -0000
Received: (qmail 3477 invoked by alias); 5 Aug 2007 19:40:00 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 11728
Received: (qmail 2943 invoked from network); 5 Aug 2007 19:33:19 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 5 Aug 2007 19:33:19 -0000
Received: (qmail 7414 invoked from network); 5 Aug 2007 19:33:19 -0000
Received: from py-out-1112.google.com (64.233.166.177)
  by a.mx.sunsite.dk with SMTP; 5 Aug 2007 19:33:15 -0000
Received: by py-out-1112.google.com with SMTP id f47so2123985pye
        for <zsh-users@sunsite.dk>; Sun, 05 Aug 2007 12:33:13 -0700 (PDT)
Received: by 10.35.85.1 with SMTP id n1mr8596573pyl.1186342393064;
        Sun, 05 Aug 2007 12:33:13 -0700 (PDT)
Received: by 10.35.97.8 with HTTP; Sun, 5 Aug 2007 12:33:13 -0700 (PDT)
Message-ID: <b3502dfb0708051233s6d5bc0a9kb625f3055331c765@mail.gmail.com>
Date: Sun, 5 Aug 2007 15:33:13 -0400
From: "Dana Jansens" <danakj@orodu.net>
To: zsh-users@sunsite.dk
Subject: showing the current job in the window title
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 7bit
Content-Disposition: inline

Hi,

I recently decided I wanted to show the current job I am using in my
xterm window titles.  I found, with some help, an example on this
mailing list but it was incomplete and not functional.  So I thought I
would share my success with you all, in case other people would be
interested to do the same in the future.

One interesting thing about it is that "builtin jobs %+" (or %1, %2,
etc) does not seem to work at all in preexec().  It would give off
strange errors instead such as "no such job: 1".  However using grep I
was able to attain the same result.

preexec () {
 local -a cmd
 local -a job

 if [ $#1 -gt 512 ];then 1=${1[1,512]}; fi
 cmd=(${(z)1})
 case $cmd[1] in
   (fg)
     if (( $#cmd == 1 )); then
       builtin jobs | grep "^\[[0-9]\+\]\W\++" | read job
       job=$job[19,-1]
     else
       builtin jobs | grep "^\[${(Q)cmd[2][2,-1]}\]" | read job
       job=$job[19,-1]
     fi ;;
   (r)
     builtin history -n -1 | read job ;;
   (%*)
     builtin jobs | grep "^\[${(Q)cmd[1][2,-1]}\]" | read job
     job=$job[19,-1] ;;
   (exec)
     job=($cmd)
     shift job ;;
   (*)
     job=$cmd ;;
 esac

 ct -e "`print -P "%n@%m"` {$job} [`print -P "%100<...<%~%<<"`]"
}

ct () {
	local MATCH
	if [[ "$1" = "-e" ]]
	then
		print -n "\033]0;${(q)${2//
/\\n}//(#m)[-]/$MATCH}\007"
	elif [[ "$1" = "-t" ]]
	then
		pts="$2"
		ct -e "$3" > /dev/pts/$pts
	else
		ct -e "$*"
	fi
}

Yay for zsh!

