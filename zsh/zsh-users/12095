From zsh-users-return-12095-mason-zsh=primenet.com.au@sunsite.dk Wed Oct 24 12:47:36 2007
Return-Path: <zsh-users-return-12095-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 17114 invoked from network); 24 Oct 2007 12:47:28 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.3 (2007-08-08) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.3
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 24 Oct 2007 12:47:28 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 96858 invoked from network); 24 Oct 2007 12:47:21 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 24 Oct 2007 12:47:21 -0000
Received: (qmail 28810 invoked by alias); 24 Oct 2007 12:47:13 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 12095
Received: (qmail 28792 invoked from network); 24 Oct 2007 12:47:12 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 24 Oct 2007 12:47:12 -0000
Received: (qmail 95650 invoked from network); 24 Oct 2007 12:47:12 -0000
Received: from smtp.eu.citrix.com (62.200.22.115)
  by a.mx.sunsite.dk with SMTP; 24 Oct 2007 12:47:07 -0000
X-IronPort-AV: E=Sophos;i="4.21,324,1188792000"; 
   d="scan'208";a="11503866"
Received: from lonpexchmx01.citrite.net ([10.30.224.191])
  by LONPIPO01.EU.CITRIX.COM with ESMTP; 24 Oct 2007 08:47:04 -0400
Received: from lonpexch01.citrite.net ([10.30.224.136]) by lonpexchmx01.citrite.net with Microsoft SMTPSVC(6.0.3790.1830);
	 Wed, 24 Oct 2007 13:46:05 +0100
X-MimeOLE: Produced By Microsoft Exchange V6.5
Content-class: urn:content-classes:message
MIME-Version: 1.0
Content-Type: text/plain;
	charset="us-ascii"
Content-Transfer-Encoding: quoted-printable
Subject: RE: Completion problems on cygwin when nocaseglob is set
Date: Wed, 24 Oct 2007 13:45:57 +0100
Message-ID: <DD74FBB8EE28D441903D56487861CD9D22719439@lonpexch01.citrite.net>
In-Reply-To: <20071023165708.41f29476@news01>
X-MS-Has-Attach: 
X-MS-TNEF-Correlator: 
Thread-Topic: Completion problems on cygwin when nocaseglob is set
thread-index: AcgVjXt/hudu9cBmSiOpbBTWlkfETQArPQtg
References: <DD74FBB8EE28D441903D56487861CD9D223A0DF0@lonpexch01.citrite.net><20a807210710200509t43730713oa909fce4e0a57940@mail.gmail.com><DD74FBB8EE28D441903D56487861CD9D223A0DF8@lonpexch01.citrite.net><20071022103452.6c0580c6@news01><DD74FBB8EE28D441903D56487861CD9D224E86E7@lonpexch01.citrite.net><20071022123128.2db6000c@news01><DD74FBB8EE28D441903D56487861CD9D224E8A05@lonpexch01.citrite.net><20071023101151.3757a369@news01><DD74FBB8EE28D441903D56487861CD9D225F6432@lonpexch01.citrite.net><200710231156.l9NBuQwA019246@news01.csr.com><DD74FBB8EE28D441903D56487861CD9D225F6859@lonpexch01.citrite.net> <20071023165708.41f29476@news01>
From: "John Cooper" <John.Cooper@citrix.com>
To: "Peter Stephenson" <pws@csr.com>,
	"Zsh Users" <zsh-users@sunsite.dk>
X-OriginalArrivalTime: 24 Oct 2007 12:46:05.0756 (UTC) FILETIME=[D7AFBFC0:01C8163B]

I've finally built zsh 4.3.4 from the cygwin source package, and can
confirm the patch fixes the problem and I can now complete using
c:/<TAB>.

As an interesting note, I've also found that the slightly earlier zsh
4.3.2 (installed from cygwin's setup.exe) does not have the problem.
Completion works in this version (with setopt nocaseglob) through both
/c/ and c:/ . It even works after I delete my /c mount point directory
(c:\cygwin\c) even though "print /*" still does not include "/c".

    --- John.


-----Original Message-----
From: Peter Stephenson [mailto:pws@csr.com]=20
Sent: 23 October 2007 16:57
To: Zsh Users
Subject: Re: Completion problems on cygwin when nocaseglob is set

OK, I've found the underlying problem.  The cause is as discussed---"c"
doesn't appear in the directory listing for "/", which still strikes me
as
a bug.

I next noticed that "print /c/*" doesn't work.  The reason is that
globbing
couldn't find /c.  That #ifdef I pointed out before in pattern.c is
supposed to ensure that we don't do globbing on a directory just because
nocaseglob is in effect on Cygwin, since we'll find files with any case
without having to search.  However, it turns out there's another piece
of
code that's turning off the flag that says we've got a straight string
that
doesn't need globbing.  Using the same trick here allows us to pick up
/c
without globbing to find it again.  c:/* now works again, too.

This means that /c*/* still doesn't find any files under /c, but this
time
I think it's a natural and unavoidable consequence of the fact that c
doesn't appear in the directory listing for /.

I haven't looked at fake-files.

Index: Src/pattern.c
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D
RCS file: /cvsroot/zsh/zsh/Src/pattern.c,v
retrieving revision 1.40
diff -u -r1.40 pattern.c
--- Src/pattern.c	27 Jul 2007 21:51:33 -0000	1.40
+++ Src/pattern.c	23 Oct 2007 15:47:38 -0000
@@ -1167,7 +1167,26 @@
 	 * ..(#a1).. (i.e. the (#a1) has no effect), but if you're
 	 * going to write funny patterns, you get no sympathy from me.
 	 */
-	if (patglobflags & (0xFF|GF_LCMATCHUC|GF_IGNCASE)) {
+	if (patglobflags &
+#ifdef __CYGWIN__
+	    /*
+	     * As above: don't use pattern matching for files
+	     * just because of case insensitivity if file system
+	     * is known to be case insensitive.
+	     *
+	     * This is known to be necessary in at least one case:
+	     * if "mount -c /" is in effect, so that drives appear
+	     * directly under / instead of the usual /cygdrive, they
+	     * aren't shown by readdir().  So it's vital we don't use
+	     * globbing to find "/c", since that'll fail.
+	     */
+	    ((patflags & PAT_FILE) ?
+	    (0xFF|GF_LCMATCHUC) :
+	    (0xFF|GF_LCMATCHUC|GF_IGNCASE))
+#else
+	    (0xFF|GF_LCMATCHUC|GF_IGNCASE)
+#endif
+	    ) {
 	    if (!(patflags & PAT_FILE))
 		flags &=3D ~P_PURESTR;
 	    else if (!(nptr[0] =3D=3D '.' &&


--=20
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070

