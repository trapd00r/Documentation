From zsh-users-return-10242-mason-zsh=primenet.com.au@sunsite.dk Wed May 10 21:58:22 2006
Return-Path: <zsh-users-return-10242-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 23448 invoked from network); 10 May 2006 21:58:21 -0000
X-Spam-Checker-Version: SpamAssassin 3.1.1 (2006-03-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=BAYES_00,FORGED_RCVD_HELO 
	autolearn=ham version=3.1.1
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 10 May 2006 21:58:21 -0000
Received: (qmail 76063 invoked from network); 10 May 2006 21:58:14 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 10 May 2006 21:58:14 -0000
Received: (qmail 4894 invoked by alias); 10 May 2006 21:58:06 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 10242
Received: (qmail 4885 invoked from network); 10 May 2006 21:58:06 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 10 May 2006 21:58:06 -0000
Received: (qmail 74834 invoked from network); 10 May 2006 21:58:06 -0000
Received: from mail.starnix.com (24.215.7.100)
  by a.mx.sunsite.dk with SMTP; 10 May 2006 21:58:05 -0000
Received: from localhost (localhost.localdomain [127.0.0.1])
	by mail.starnix.com (Postfix) with ESMTP id 8821B4C2CE;
	Wed, 10 May 2006 17:58:03 -0400 (EDT)
Received: from newsol.starnix.com (unknown [209.250.156.214])
	by mail.starnix.com (Postfix) with ESMTP id 50F7A4C2CC;
	Wed, 10 May 2006 17:57:56 -0400 (EDT)
Received: by newsol.starnix.com (Postfix, from userid 510)
	id CB24D48DF4; Wed, 10 May 2006 18:04:18 -0400 (EDT)
Sender: tim@starnix.com
From: Tim Writer <tim@starnix.com>
To: Lloyd Zusman <ljz@asfast.com>
Cc: zsh-users@sunsite.dk
Subject: Re: File locking within zsh?
References: <87r7324zyh.fsf@asfast.com> <ltd5emv9lh.fsf@newsol.starnix.com>
	<009101c673f7$06b3f090$6500000a@venti> <877j4ujizh.fsf@asfast.com>
Date: 10 May 2006 18:04:18 -0400
In-Reply-To: <877j4ujizh.fsf@asfast.com>
Message-ID: <ltejz1sfj1.fsf@newsol.starnix.com>
Lines: 50
User-Agent: Gnus/5.0808 (Gnus v5.8.8) XEmacs/21.4 (Common Lisp)
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
X-Virus-Scanned: by starnix.com

Lloyd Zusman <ljz@asfast.com> writes:

> "Brian K. White" <brian@aljex.com> writes:
> 
> > From: "Tim Writer" <tim@starnix.com>
> >
> >> [ ... ]
> >>
> >>    while ! ln file file.lock 2>/dev/null
> >>    do
> >>        sleep 1
> >>    done
> >>    # Lock obtained
> >>
> >>    print foo bar baz >>file
> >>    # do a whole lot of other stuff to "file"
> >>
> >>    rm -f file.lock
> >>    # Lock released
> >>
> >> Wrapping this idiom into lock/unlock functions is left as an exercise
> >> for the
> >> reader. :-)
> >
> >
> > Is that better or worse, and why, than  umask 222 ; >file ?
> >
> > http://www.unix.org.ua/orelly/unix/upt/ch45_36.htm
> 
> Thanks to both of you (Brian K. White and Tim Writer).  I personally
> like the umask version better, because I think I can implement a
> variation of it without spawning any extra processes (my goal), given
> that umask is an internal zsh command.

Keep in mind that you have to put umask in a subshell, like this:

    ( umask 222; >file )

in order to preserve it. IIRC, zsh avoids forking in subshells but don't most
shells implement subshells with fork()?

Keep in mind that ln is a tiny wrapper around the link(2) system call and so
there's only a very small amount of overhead in running it. With zsh, you
can have your cake and eat it too using the zsh/files which makes ln a
builtin (among other things).

-- 
tim writer <tim@starnix.com>                                  starnix inc.
647.722.5301                                      toronto, ontario, canada
http://www.starnix.com              professional linux services & products

