From zsh-workers-return-22124-mason-zsh=primenet.com.au@sunsite.dk Fri Jan 06 14:06:36 2006
Return-Path: <zsh-workers-return-22124-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 8121 invoked from network); 6 Jan 2006 14:06:33 -0000
X-Spam-Checker-Version: SpamAssassin 3.1.0 (2005-09-13) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=AWL,BAYES_00,
	FORGED_RCVD_HELO autolearn=ham version=3.1.0
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 6 Jan 2006 14:06:33 -0000
Received: (qmail 73584 invoked from network); 6 Jan 2006 14:06:27 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 6 Jan 2006 14:06:27 -0000
Received: (qmail 18748 invoked by alias); 6 Jan 2006 14:06:24 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 22124
Received: (qmail 18739 invoked from network); 6 Jan 2006 14:06:23 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 6 Jan 2006 14:06:23 -0000
Received: (qmail 73265 invoked from network); 6 Jan 2006 14:06:23 -0000
Received: from cluster-d.mailcontrol.com (HELO rly16d.srv.mailcontrol.com) (217.69.20.190)
  by a.mx.sunsite.dk with SMTP; 6 Jan 2006 14:06:20 -0000
Received: from exchange03.csr.com (uuk202166.uk.customer.alter.net [62.189.241.194] (may be forged))
	by rly16d.srv.mailcontrol.com (MailControl) with ESMTP id k06E6G0w004402
	for <zsh-workers@sunsite.dk>; Fri, 6 Jan 2006 14:06:16 GMT
Received: from news01.csr.com ([10.103.143.38]) by exchange03.csr.com with Microsoft SMTPSVC(5.0.2195.6713);
	 Fri, 6 Jan 2006 14:06:15 +0000
Received: from news01.csr.com (localhost.localdomain [127.0.0.1])
	by news01.csr.com (8.13.1/8.12.11) with ESMTP id k06E6FU5006934
	for <zsh-workers@sunsite.dk>; Fri, 6 Jan 2006 14:06:15 GMT
Received: from csr.com (pws@localhost)
	by news01.csr.com (8.13.1/8.13.1/Submit) with ESMTP id k06E6D3x006928
	for <zsh-workers@sunsite.dk>; Fri, 6 Jan 2006 14:06:13 GMT
Message-Id: <200601061406.k06E6D3x006928@news01.csr.com>
To: zsh-workers@sunsite.dk (Zsh hackers list)
Subject: PATCH: self-insert with bad multibyte input
Date: Fri, 06 Jan 2006 14:06:12 +0000
From: Peter Stephenson <pws@csr.com>
X-OriginalArrivalTime: 06 Jan 2006 14:06:15.0912 (UTC) FILETIME=[5BC74E80:01C612CA]
Content-Type: text/plain
MIME-Version: 1.0
X-Scanned-By: MailControl A-05-40-01 (www.mailcontrol.com) on 10.68.0.126

Playing around with the Solaris problems, I noticed that handling
of bad character input is poor.  selfinsert() tries to grab the rest of
a wide character.  It assumes, quite reasonably, that we already have
something to insert because it only gets called with real input,
although that may be an incomplete character.  However, we currently set
the wide character to WEOF in this case, which self-insert inserts; this
isn't a very good solution.  This patch checks for the return value when
reading the key and beeps when necessary.  It doesn't fix the problems
inputting multibyte characters, but it prevents any consequent problems.

Multibyte editing appears to be OK on the Solaris 8 systems here as long
as the characters don't come from the keyboard: this is basically
consistent with the problem I was seeing before.

Index: Src/Zle/zle_hist.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/zle_hist.c,v
retrieving revision 1.33
diff -u -r1.33 zle_hist.c
--- Src/Zle/zle_hist.c	12 Dec 2005 18:35:47 -0000	1.33
+++ Src/Zle/zle_hist.c	6 Jan 2006 14:01:33 -0000
@@ -1107,7 +1107,10 @@
 	    } else if (cmd == Th(z_selfinsert)) {
 #ifdef MULTIBYTE_SUPPORT
 		if (!lastchar_wide_valid)
-		    getrestchar(lastchar);
+		    if (getrestchar(lastchar) == WEOF) {
+			handlefeep(zlenoargs);
+			continue;
+		    }
 #else
 		;
 #endif
@@ -1303,7 +1306,10 @@
 	    } else {
 #ifdef MULTIBYTE_SUPPORT
 		if (!lastchar_wide_valid)
-		    getrestchar(lastchar);
+		    if (getrestchar(lastchar) == WEOF) {
+			handlefeep(zlenoargs);
+			continue;
+		    }
 #else
 		;
 #endif
Index: Src/Zle/zle_misc.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/zle_misc.c,v
retrieving revision 1.38
diff -u -r1.38 zle_misc.c
--- Src/Zle/zle_misc.c	30 Nov 2005 16:49:44 -0000	1.38
+++ Src/Zle/zle_misc.c	6 Jan 2006 14:01:36 -0000
@@ -64,7 +64,8 @@
 
 #ifdef MULTIBYTE_SUPPORT
     if (!lastchar_wide_valid)
-	getrestchar(lastchar);
+	if (getrestchar(lastchar) == WEOF)
+	    return 1;
 #endif
     tmp = LASTFULLCHAR;
     doinsert(&tmp, 1);
@@ -1018,6 +1019,9 @@
 #ifdef MULTIBYTE_SUPPORT
 		    if (!lastchar_wide_valid)
 			getrestchar(lastchar);
+		    if (lastchar_wide == WEOF)
+			feep = 1;
+		    else
 #endif
 		    if (ZC_icntrl(LASTFULLCHAR))
 			feep = 1;

-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070


Your mail client is unable to display the latest news from CSR. To access our news copy this link into a web browser:  http://www.csr.com/email_sig.html

