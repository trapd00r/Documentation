From zsh-users-return-9688-mason-zsh=primenet.com.au@sunsite.dk Fri Nov 18 11:47:37 2005
Return-Path: <zsh-users-return-9688-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 4546 invoked from network); 18 Nov 2005 11:47:35 -0000
X-Spam-Checker-Version: SpamAssassin 3.1.0 (2005-09-13) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=AWL,BAYES_00,
	FORGED_RCVD_HELO autolearn=ham version=3.1.0
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 18 Nov 2005 11:47:35 -0000
Received: (qmail 28814 invoked from network); 18 Nov 2005 11:47:29 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 18 Nov 2005 11:47:29 -0000
Received: (qmail 5146 invoked by alias); 18 Nov 2005 11:47:17 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 9688
Received: (qmail 5135 invoked from network); 18 Nov 2005 11:47:17 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 18 Nov 2005 11:47:17 -0000
Received: (qmail 27364 invoked from network); 18 Nov 2005 11:47:17 -0000
Received: from cluster-c.mailcontrol.com (HELO rly16c.srv.mailcontrol.com) (168.143.177.190)
  by a.mx.sunsite.dk with SMTP; 18 Nov 2005 11:47:14 -0000
Received: from exchange03.csr.com ([62.189.241.194])
	by rly16c.srv.mailcontrol.com (MailControl) with ESMTP id jAIBkjSe003369
	for <zsh-users@sunsite.dk>; Fri, 18 Nov 2005 11:47:12 GMT
Received: from news01 ([10.103.143.38]) by exchange03.csr.com with Microsoft SMTPSVC(5.0.2195.6713);
	 Fri, 18 Nov 2005 11:49:46 +0000
Date: Fri, 18 Nov 2005 11:47:05 +0000
From: Peter Stephenson <pws@csr.com>
To: zsh-users@sunsite.dk
Subject: Re: Mysterious completion of variables
Message-Id: <20051118114705.0bd95c76.pws@csr.com>
In-Reply-To: <87psoynqcv.fsf@trews52.bothi.fi>
References: <b6c719b90511171236j5988236elda6ac5a4e9d37dc@mail.gmail.com>
	<87psoynqcv.fsf@trews52.bothi.fi>
Organization: Cambridge Silicon Radio
X-Mailer: Sylpheed version 0.9.12 (GTK+ 1.2.10; i386-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
X-OriginalArrivalTime: 18 Nov 2005 11:49:46.0531 (UTC) FILETIME=[2C492F30:01C5EC36]
X-Scanned-By: MailControl A-05-40-01 (www.mailcontrol.com) on 10.67.0.126

Hannu Koivisto <azure@iki.fi> wrote:
> I modified ssh completion to dig host aliases from the
> configuration file.

I'll commit it in the following form.

The only point of changing "host" to "remote host name" everywhere is that
otherwise the hosts appear under two separate names (if you have the
descriptions turned on).  I'm not attached to the latter rather than the
form, it just has to be consistent throughout.

I'm not sure whether the extra _wanted in _ssh_hosts is needed, given how
_ssh_hosts is called, but I think it's at least harmless.

Index: Completion/Unix/Command/_ssh
===================================================================
RCS file: /cvsroot/zsh/zsh/Completion/Unix/Command/_ssh,v
retrieving revision 1.24
diff -u -r1.24 _ssh
--- Completion/Unix/Command/_ssh	9 May 2005 02:38:35 -0000	1.24
+++ Completion/Unix/Command/_ssh	18 Nov 2005 11:44:47 -0000
@@ -283,11 +283,11 @@
       elif compset -P '*@'; then
         suf=( -S '' )
         compset -S ':*' || suf=( -S : )
-        _wanted hosts expl host _ssh_hosts $suf && ret=0
+        _wanted hosts expl 'remote host name' _ssh_hosts $suf && ret=0
       else
         _alternative \
 	    'files:: _files' \
-	    'hosts:host:_ssh_hosts -S:' \
+	    'hosts:remote host name:_ssh_hosts -S:' \
 	    'users:user:_ssh_users -qS@' && ret=0
       fi
       ;;
@@ -298,7 +298,7 @@
         _wanted hosts expl host _ssh_hosts -S: && ret=0
       else
         _alternative \
-	    'hosts:host:_ssh_hosts -S:' \
+	    'hosts:remote host name:_ssh_hosts -S:' \
 	    'users:user:_ssh_users -qS@' && ret=0
       fi
       ;;
@@ -311,12 +311,26 @@
 }
 
 _ssh_hosts () {
+  local -a config_hosts
+
   if [[ "$IPREFIX" == *@ ]]; then
     _combination -s '[:@]' my-accounts users-hosts "users=${IPREFIX/@}" hosts "$@"
   else
     _combination -s '[:@]' my-accounts users-hosts \
       ${opt_args[-l]:+"users=${opt_args[-l]:q}"} hosts "$@"
   fi
+  if [[ -r "$HOME/.ssh/config" ]]; then
+    local IFS=$'\t ' key host
+    while read key host; do
+      if [[ "$key" == (#i)host ]]; then
+	 config_hosts+=("$host")
+      fi
+    done < "$HOME/.ssh/config"
+    if (( ${#config_hosts} )); then
+      _wanted hosts expl 'remote host name' \
+	compadd -M 'm:{a-zA-Z}={A-Za-z} r:|.=* r:|=*' "$@" $config_hosts
+    fi
+  fi
 }
 
 _ssh "$@"


This message has been scanned for viruses by BlackSpider MailControl - www.blackspider.com

