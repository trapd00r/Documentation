From joda@pdc.kth.se Thu Jul 25 03:39:29 1996
Received: from euclid.skiles.gatech.edu (list@euclid.skiles.gatech.edu [130.207.146.50]) by melb.werple.net.au (8.7.5/8.7.3/2) with ESMTP id DAA17224 for <mason@werple.mira.net.au>; Thu, 25 Jul 1996 03:39:26 +1000 (EST)
Received: (from list@localhost) by euclid.skiles.gatech.edu (8.7.3/8.7.3) id NAA12862; Wed, 24 Jul 1996 13:33:39 -0400 (EDT)
Resent-Date: Wed, 24 Jul 1996 13:33:39 -0400 (EDT)
Sender: joda@pdc.kth.se
To: Bruce Stephens <stephens@math.ruu.nl>
Cc: zsh-workers@math.gatech.edu
Subject: Re: 3.0-pre3 fails on CRAY-YMP
References: <199607241417.QAA00042@cantecler.math.ruu.nl>
	<xof91c9hfkg.fsf@emma.pdc.kth.se>
Mime-Version: 1.0 (generated by tm-edit 7.70)
Content-Type: multipart/mixed;
 boundary="Multipart_Wed_Jul_24_19:32:31_1996-1"
Content-Transfer-Encoding: 7bit
From: joda@pdc.kth.se (Johan Danielsson)
Date: 24 Jul 1996 19:32:31 +0200
In-Reply-To: joda@pdc.kth.se's message of 24 Jul 1996 16:49:19 +0200
Message-ID: <xof7mrth80g.fsf@emma.pdc.kth.se>
Lines: 88
X-Mailer: Gnus v5.2.32/Emacs 19.31
Resent-Message-ID: <"LiYt2.0.u83.ovbzn"@euclid>
Resent-From: zsh-workers@math.gatech.edu
X-Mailing-List: <zsh-workers@math.gatech.edu> archive/latest/1759
X-Loop: zsh-workers@math.gatech.edu
Precedence: list
Resent-Sender: zsh-workers-request@math.gatech.edu
Content-Length: 2638
Status: O

--Multipart_Wed_Jul_24_19:32:31_1996-1
Content-Type: text/plain; charset=US-ASCII


> > The second is that there are a couple of calls to setlimits in
> > exec.c which aren't protected with #ifdef's for getrlimits, which
> > the Cray appears to lack.

Ok, this is a new bug in pre2 or pre3. This is the quick patch:

--Multipart_Wed_Jul_24_19:32:31_1996-1
Content-Type: text/plain; charset=US-ASCII

RCS file: RCS/exec.c,v
retrieving revision 1.1
diff -u -r1.1 exec.c
--- exec.c      1996/07/24 17:16:34     1.1
+++ exec.c      1996/07/24 17:16:46
@@ -1686,8 +1686,10 @@
            }
            if (type == SIMPLE) {
                closem(1);
+#ifdef HAVE_GETRLIMIT
                if (!forked)
                    setlimits(NULL);
+#endif
                execute((Cmdnam) hn, cflags & BINF_DASH);
            } else {            /* ( ... ) */
                list_pipe = 0;

--Multipart_Wed_Jul_24_19:32:31_1996-1
Content-Type: text/plain; charset=US-ASCII


However, shouldn't the ifdef stuff be in zsetlimit? This way you don't
have to add ifdefs in every place you want to change limits.


> One other problem I have is that it fails to change the terminal
> settings (with stty) - it looks like they get reset back when stty
> exits (and no I don't have that option on).

This is the symptoms. I haven't had time to look into this, it is a bit
hard to debug these things without a working debugger :-)

$ stty 
speed 9600 baud; -parity hupcl -cread 
rows = 32; columns = 80; ypixels = 0; xpixels = 0;
erase = ^h; 
brkint -inpck icrnl -ixany onlcr tab3 
echo echoe echok iexten 
$ stty erase '^?'
$ stty
speed 9600 baud; -parity hupcl -cread 
rows = 32; columns = 80; ypixels = 0; xpixels = 0;
erase = ^h; 
brkint -inpck icrnl -ixany onlcr tab3 
echo echoe echok iexten 
$ exec /bin/bash
$ stty erase
$ stty
speed 9600 baud; -parity hupcl -cread 
rows = 32; columns = 80; ypixels = 0; xpixels = 0;
erase = ^h; 
brkint -inpck icrnl -ixany onlcr tab3 
echo echoe echok iexten 
$ stty erase '^?'
$ stty # note that the erase character has changed
speed 9600 baud; -parity hupcl -cread 
rows = 32; columns = 80; ypixels = 0; xpixels = 0;
brkint -inpck icrnl -ixany onlcr tab3 
echo echoe echok iexten 
$ exec ./zsh
/scratch/joda/zsh-3.0-pre3/Src>stty
speed 9600 baud; -parity hupcl -cread 
rows = 32; columns = 80; ypixels = 0; xpixels = 0;
brkint -inpck icrnl -ixany onlcr tab3 
echo echoe echok iexten 
$ stty erase '^h'
$ stty
speed 9600 baud; -parity hupcl -cread 
rows = 32; columns = 80; ypixels = 0; xpixels = 0;
brkint -inpck icrnl -ixany onlcr tab3 
echo echoe echok iexten 

/Johan

--Multipart_Wed_Jul_24_19:32:31_1996-1--


