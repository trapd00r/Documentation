From zsh-workers-return-23313-mason-zsh=primenet.com.au@sunsite.dk Mon Apr 23 17:07:59 2007
Return-Path: <zsh-workers-return-23313-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 22563 invoked from network); 23 Apr 2007 17:07:56 -0000
X-Spam-Checker-Version: SpamAssassin 3.1.8 (2007-02-13) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=AWL,BAYES_00,FORGED_RCVD_HELO
	autolearn=ham version=3.1.8
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 23 Apr 2007 17:07:56 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 23737 invoked from network); 23 Apr 2007 17:07:51 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 23 Apr 2007 17:07:51 -0000
Received: (qmail 27221 invoked by alias); 23 Apr 2007 17:07:47 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 23313
Received: (qmail 27210 invoked from network); 23 Apr 2007 17:07:46 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 23 Apr 2007 17:07:46 -0000
Received: (qmail 23359 invoked from network); 23 Apr 2007 17:07:46 -0000
Received: from cluster-c.mailcontrol.com (168.143.177.190)
  by a.mx.sunsite.dk with SMTP; 23 Apr 2007 17:07:43 -0000
Received: from cameurexb01.EUROPE.ROOT.PRI ([62.189.241.200])
	by rly27c.srv.mailcontrol.com (MailControl) with ESMTP id l3NH7XEw002376
	for <zsh-workers@sunsite.dk>; Mon, 23 Apr 2007 18:07:36 +0100
Received: from news01.csr.com ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.1830);
	 Mon, 23 Apr 2007 18:07:33 +0100
Date: Mon, 23 Apr 2007 18:07:32 +0100
From: Peter Stephenson <pws@csr.com>
To: "Zsh hackers list" <zsh-workers@sunsite.dk>
Subject: Re: zsh 4.3.4 released
Message-Id: <20070423180732.2de69fd1.pws@csr.com>
In-Reply-To: <20070423174029.1e8293a9.pws@csr.com>
References: <200704161647.l3GGl2FE027950@news01.csr.com>
	<20070419120758.e9774528.pws@csr.com>
	<237967ef0704201440g1c072ca8l451439d2ec8578bf@mail.gmail.com>
	<20070423104151.1f5f368e.pws@csr.com>
	<237967ef0704230550k41ddb13fy60deebd526ecc5ec@mail.gmail.com>
	<200704231318.l3NDIONr006499@news01.csr.com>
	<237967ef0704230722u7546461ehd6b3280df79352a0@mail.gmail.com>
	<200704231506.l3NF6Njx011759@news01.csr.com>
	<237967ef0704230900r21af3aa1od42cd0b41abe2251@mail.gmail.com>
	<20070423174029.1e8293a9.pws@csr.com>
Organization: Cambridge Silicon Radio
X-Mailer: Sylpheed version 2.2.10 (GTK+ 2.10.8; i386-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
X-OriginalArrivalTime: 23 Apr 2007 17:07:33.0015 (UTC) FILETIME=[E2038270:01C785C9]
X-Scanned-By: MailControl A-06-00-00 (www.mailcontrol.com) on 10.67.0.137

Peter Stephenson <pws@csr.com> wrote:
> I think I've found the problem: parse.c doesn't get recompiled when
> version.h changes, so zcompile might output the wrong version, so the shell
> can't check properly when the ZWC file is loaded.

Errm... and, in fact, it doesn't even when it can.  And if it did, and
error checking was on, the error message would be wrong.  Presumably this
has always been broken.

Index: Src/parse.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/parse.c,v
retrieving revision 1.62
diff -u -r1.62 parse.c
--- Src/parse.c	23 Apr 2007 16:55:00 -0000	1.62
+++ Src/parse.c	23 Apr 2007 17:04:02 -0000
@@ -2617,9 +2617,10 @@
     }
     if (read(fd, buf, (FD_PRELEN + 1) * sizeof(wordcode)) !=
 	((FD_PRELEN + 1) * sizeof(wordcode)) ||
-	(v = (fdmagic(buf) != FD_MAGIC && fdmagic(buf) != FD_OMAGIC))) {
+	(v = (fdmagic(buf) != FD_MAGIC && fdmagic(buf) != FD_OMAGIC)) ||
+	strcmp(fdversion(buf), ZSH_VERSION)) {
 	if (err) {
-	    if (v) {
+	    if (!v) {
 		zwarnnam(nam, "zwc file has wrong version (zsh-%s): %s",
 			 fdversion(buf), name);
 	    } else

-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070


To access the latest news from CSR copy this link into a web browser:  http://www.csr.com/email_sig.php

To get further information regarding CSR, please visit our Investor Relations page at http://ir.csr.com/csr/about/overview

