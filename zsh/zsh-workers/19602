From zsh-workers-return-19602-mason-zsh=primenet.com.au@sunsite.dk Thu Mar 11 17:54:49 2004
Return-Path: <zsh-workers-return-19602-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 28469 invoked from network); 11 Mar 2004 17:54:48 -0000
Received: from sunsite.dk (130.225.247.90)
  by ns1.primenet.com.au with SMTP; 11 Mar 2004 17:54:48 -0000
Received: (qmail 7730 invoked by alias); 11 Mar 2004 17:54:38 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 19602
Received: (qmail 7717 invoked from network); 11 Mar 2004 17:54:38 -0000
Received: from localhost (HELO sunsite.dk) (127.0.0.1)
  by localhost with SMTP; 11 Mar 2004 17:54:38 -0000
X-MessageWall-Score: 0 (sunsite.dk)
Received: from [193.109.254.211] by sunsite.dk (MessageWall 1.0.8) with SMTP; 11 Mar 2004 17:54:37 -0000
X-VirusChecked: Checked
X-Env-Sender: okiddle@yahoo.co.uk
X-Msg-Ref: server-12.tower-36.messagelabs.com!1079027675!4541395
X-StarScan-Version: 5.2.5; banners=-,-,-
X-Originating-IP: [158.234.9.163]
Received: (qmail 8158 invoked from network); 11 Mar 2004 17:54:35 -0000
Received: from iris.logica.co.uk (158.234.9.163)
  by server-12.tower-36.messagelabs.com with SMTP; 11 Mar 2004 17:54:35 -0000
Received: from trentino.logica.co.uk ([158.234.142.61])
	by iris.logica.co.uk (8.12.3/8.12.3/Debian -4) with ESMTP id i2BHsZCk029856
	for <zsh-workers@sunsite.dk>; Thu, 11 Mar 2004 17:54:35 GMT
Received: from trentino.logica.co.uk (localhost [127.0.0.1])
	by trentino.logica.co.uk (Postfix) with ESMTP id CA0CA79721C1
	for <zsh-workers@sunsite.dk>; Thu, 11 Mar 2004 18:53:50 +0100 (CET)
X-VirusChecked: Checked
X-StarScan-Version: 5.1.13; banners=.,-,-
From: Oliver Kiddle <okiddle@yahoo.co.uk>
To: Zsh workers <zsh-workers@sunsite.dk>
Subject: PATCH: build problem with signals on HP/UX,ia64
Date: Thu, 11 Mar 2004 18:53:50 +0100
Message-ID: <24953.1079027630@trentino.logica.co.uk>

I traced the cause of the signals problem on HP/UX (ia64). The cause
was the preprocessor output as opposed to awk. The relevant lines of
sigtmp.out look like this:

#line 3
XXNAMES XXSIGHUP 1
 XXNAMES XXSIGINT 2
 XXNAMES XXSIGQUIT 3
 XXNAMES XXSIGILL 4

with all subsequent signals also indented by one space. signames2.awk's
regex looks like this:
  /^XXNAMES XXSIG[A-Z][A-Z0-9]*[\t ][\t ]*[1-9][0-9]*/ {

Obvious fix would be to add ` ?' to the beginning but the patch below adds
`[\t ]*' because I'm supposing that some other preprocessor might someday
decide to use some other indentation. I'll hold off till tomorrow before
committing this.

Current status with respect to HP testdrive machines is as follows:

Tru64 4.1               - couldn't log on so untried
Tru64 5.1   ev7     cc  - builds and tests fine
Tru64 5.1   ev7     gcc - untried (gcc was a broken symlink)
HP/UX 11.11 PA-RISC cc  - builds fine, completion tests using zpty hang,
                          otherwise fine
HP/UX 11.11 PA-RISC gcc - builds fine, tests fine except zpty fails to load
HP/UX 11.22 Itanium gcc - builds fine, tests fine[*], zpty fails to load
HP/UX 11.22 Itanium cc  - signals problem above, with the fix, all is okay:
                          build fine and and test okay (except Y01 zpty hang).
I was trying HP/UX 11.23 yesterday with similar results to 11.22. Haven't
tried it today. Haven't tried their BSD machines either.

Compilers on the Itanium systems seem to be quite different from those
on PA-RISC.

Since zpty failing is far from critical, that really just leaves AIX to
worry about. Unless we want to clear up the compiler warnings too.

Oliver

[*] actually a test in A04 fails because rm -f * didn't get rid of all
the files (it is not a local filesystem and rm fails a bit). I also get
[[ -g ... ]] tests failing on all HP testdrive systems because you
can't set setgid on files. Would it perhaps be worth doing tests with
files in /tmp or /var/tmp if we find it to be writable. That'd remove a
lot of NFS related failures.

Index: Src/signames2.awk
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/signames2.awk,v
retrieving revision 1.2
diff -u -r1.2 signames2.awk
--- Src/signames2.awk	3 Mar 2004 10:42:59 -0000	1.2
+++ Src/signames2.awk	11 Mar 2004 17:39:01 -0000
@@ -6,7 +6,7 @@
 # NB: On SunOS 4.1.3 - user-functions don't work properly, also \" problems
 # Without 0 + hacks some nawks compare numbers as strings
 #
-/^XXNAMES XXSIG[A-Z][A-Z0-9]*[\t ][\t ]*[1-9][0-9]*/ {
+/^[\t ]*XXNAMES XXSIG[A-Z][A-Z0-9]*[\t ][\t ]*[1-9][0-9]*/ {
     sigindex = index($0, "SIG")
     sigtail = substr($0, sigindex, 80)
     split(sigtail, tmp)

