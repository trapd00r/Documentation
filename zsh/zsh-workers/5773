From zsh-workers-return-5773-mason-zsh=primenet.com.au@sunsite.auc.dk Fri Mar 12 10:22:54 1999
Return-Path: <zsh-workers-return-5773-mason-zsh=primenet.com.au@sunsite.auc.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 1736 invoked from network); 12 Mar 1999 10:22:53 -0000
Received: from sunsite.auc.dk (130.225.51.30)
  by ns1.primenet.com.au with SMTP; 12 Mar 1999 10:22:53 -0000
Received: (qmail 15627 invoked by alias); 12 Mar 1999 10:22:22 -0000
Mailing-List: contact zsh-workers-help@sunsite.auc.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.auc.dk
X-Seq: 5773
Received: (qmail 15620 invoked from network); 12 Mar 1999 10:22:20 -0000
From: "Andrej Borsenkow" <borsenkow.msk@sni.de>
To: "Helmut Jarausch" <jarausch@numa1.igpm.rwth-aachen.de>,
        <zsh-workers@sunsite.auc.dk>
Subject: RE: Debug / cut'n'paste on IRIX
Date: Fri, 12 Mar 1999 13:21:30 +0300
Message-ID: <001201be6c72$18aaa260$21c9ca95@mowp.siemens.ru>
MIME-Version: 1.0
Content-Type: text/plain;
	charset="iso-8859-1"
Content-Transfer-Encoding: 7bit
X-Priority: 3 (Normal)
X-MSMail-Priority: Normal
X-Mailer: Microsoft Outlook IMO, Build 9.0.2416 (9.0.2910.0)
Importance: Normal
X-MimeOLE: Produced By Microsoft MimeOLE V5.00.2014.211

[I am sorry for all these mails]

>
> that's what happens. I could not find the relevant part in
> sources - anybody (Geoff) - could you get a look:
>
> Cut'n'pasted in another shell. As you see, after it gets first
> new line it does ioctl(10, TCSETSW,...) before PS2, that,
> unfortunately, throughs away all pending input :-( The following
> FIONREAD is useless in this case.
>


Looks, like it is done in settyinfo(), that is (unconditionally) called from
trashzle() that is called from zleread() after we've seen new line. (It is
actually using tcsetattr() on our system)

Fixing it is probably not trivial. Currently, the only place where FIONREAD
is used is setupterm(). If we find typeahed, we avoid calling sttyinfo() at
all. May be, we should come up with a single function that checks for
typeahead, reads it in buffer and changes tty modes after that?

And I wonder, if this is all ... We already had (still unresolved) case with
read -q ...

/andrej

