From zsh-workers-return-11616-mason-zsh=primenet.com.au@sunsite.auc.dk Sun May 28 20:50:33 2000
Return-Path: <zsh-workers-return-11616-mason-zsh=primenet.com.au@sunsite.auc.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 4713 invoked from network); 28 May 2000 20:50:32 -0000
Received: from sunsite.auc.dk (130.225.51.30)
  by ns1.primenet.com.au with SMTP; 28 May 2000 20:50:32 -0000
Received: (qmail 11724 invoked by alias); 28 May 2000 20:50:21 -0000
Mailing-List: contact zsh-workers-help@sunsite.auc.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.auc.dk
X-Seq: 11616
Received: (qmail 11717 invoked from network); 28 May 2000 20:50:20 -0000
To: zsh-workers@sunsite.auc.dk
Subject: Re: zftp.c doesn't compile on IRIX6.5 
In-reply-to: "jarausch@igpm.rwth-aachen.de"'s message of "Sun, 28 May 2000 17:53:58 +0200."
             <200005281554.RAA22070@numa1.igpm.rwth-aachen.de> 
Date: Sun, 28 May 2000 21:50:17 +0100
From: Peter Stephenson <pws@pwstephenson.fsnet.co.uk>
Message-Id: <E12wA0m-000319-00.2000-05-28-21-50-16@cmailg2.svr.pol.co.uk>

jarausch@igpm.rwth-aachen.de wrote:
> The cvs version from today doesn't compile on IRIX 6.5
> 
> It seems there is a bug on IRIX.
> It uses a type 'n_long' within <netinet/ip.h>
> but fails to include <netinet/in_systm.h>
> where this is defined.
> 
> I had to apply the following (ugly) workaround
> 
> *** zftp.c.orig Sun May 28 17:34:38 2000
> --- zftp.c      Sun May 28 17:34:39 2000
> ***************
> *** 64,69 ****
> --- 64,72 ----
>   #ifdef HAVE_NETINET_IN_SYSTM_H
>   # include <netinet/in_systm.h>
>   #endif
> + #ifdef __sgi
> +   #include <netinet/in_systm.h>
> + #endif
>   #include <netinet/in.h>
>   #include <netinet/ip.h>
>   #include <arpa/inet.h>

There's something extremely screwy here.  If <netinet/in_systm.h> exists,
why does configure not detect it?  I looked, and whether for the same
reason or not the test fails on linux, where gcc is outputting a warning
message:

In file included from /usr/include/sys/cdefs.h:24,
                 from /usr/include/netinet/in_systm.h:23,
                 from configure:2634:
/usr/include/features.h:254: warning: `__USE_LARGEFILE' redefined
/usr/include/features.h:198: warning: this is the location of the previous defin
ition

which is enough to make the test fail.

This is hard to fix, since it's not our problem.  For now we can just not
include the file where we know it's missing, and cygwin is the only case I
know, since no-one else every complained.

It would be splendid if this could be tested as soon as possible.

Index: Src/Modules/zftp.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Modules/zftp.c,v
retrieving revision 1.5
diff -u -r1.5 zftp.c
--- Src/Modules/zftp.c	2000/05/26 09:47:28	1.5
+++ Src/Modules/zftp.c	2000/05/28 20:48:01
@@ -61,7 +61,16 @@
 #include <sys/types.h>
 #include <sys/socket.h>
 #include <netdb.h>
-#ifdef HAVE_NETINET_IN_SYSTM_H
+/*
+ * For some reason, configure doesn't always detect netinet/in_systm.h.
+ * On some systems, including linux, this seems to be because gcc is
+ * throwing up a warning message about the redefinition of
+ * __USE_LARGEFILE.  This means the problem is somewhere in the
+ * header files where we can't get at it.  For now, revert to
+ * not including this file only on systems where we know it's missing.
+ * Currently this is just cygwin.
+ */
+#ifndef __CYGWIN__
 # include <netinet/in_systm.h>
 #endif
 #include <netinet/in.h>

-- 
Peter Stephenson <pws@pwstephenson.fsnet.co.uk>
Work: pws@CambridgeSiliconRadio.com
Web: http://www.pwstephenson.fsnet.co.uk

