From zsh-workers-return-10571-mason-zsh=primenet.com.au@sunsite.auc.dk Fri Apr 07 08:12:36 2000
Return-Path: <zsh-workers-return-10571-mason-zsh=primenet.com.au@sunsite.auc.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 11419 invoked from network); 7 Apr 2000 08:12:31 -0000
Received: from sunsite.auc.dk (130.225.51.30)
  by ns1.primenet.com.au with SMTP; 7 Apr 2000 08:12:31 -0000
Received: (qmail 27377 invoked by alias); 7 Apr 2000 08:11:45 -0000
Mailing-List: contact zsh-workers-help@sunsite.auc.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.auc.dk
X-Seq: 10571
Received: (qmail 27364 invoked from network); 7 Apr 2000 08:11:44 -0000
Date: Fri, 7 Apr 2000 10:11:37 +0200 (MET DST)
Message-Id: <200004070811.KAA23662@beta.informatik.hu-berlin.de>
From: Sven Wischnowsky <wischnow@informatik.hu-berlin.de>
To: zsh-workers@sunsite.auc.dk
In-reply-to: Peter Stephenson's message of Thu, 06 Apr 2000 19:45:40 +0100
Subject: PATCH: Re: More _zmodload misbehaviour


Peter Stephenson wrote:

> zmodload now removes the .so suffix again, thanks.
> 
> I had a problem completing with . in my path in the Doc directory.  At
> first I get a sensible list of modules.  After I type zsh/, however, I get
> the list:
> 
> Completing module file
> CVS/
> 
> because it's looking in the Zsh subdirectory.  Fine, because I have case
> insenstive matching, except there aren't any .so files there, and there
> certainly are in /usr/local/lib/zsh/3.1.6-dev-21/zsh.  If there's no Zsh
> subdirectory it works OK; I get the list of modules I'm expecting.
> It seems to be preferring things it shouldn't be.

Indeed. Missing initialisation in the loop for the -W paths.

The thing in _main_complete is just a small optimisation.

Bye
 Sven

Index: Completion/Core/_main_complete
===================================================================
RCS file: /cvsroot/zsh/zsh/Completion/Core/_main_complete,v
retrieving revision 1.4
diff -u -r1.4 _main_complete
--- Completion/Core/_main_complete	2000/04/05 10:50:08	1.4
+++ Completion/Core/_main_complete	2000/04/07 08:09:47
@@ -19,7 +19,7 @@
 setopt localoptions nullglob rcexpandparam extendedglob
 unsetopt markdirs globsubst shwordsplit nounset ksharrays
 
-local func funcs ret=1 tmp _compskip format _comp_ignore \
+local func funcs ret=1 tmp _compskip format \
       _completers _completer _completer_num curtag \
       _matchers _matcher _matcher_num _comp_tags \
       context state line opt_args val_args curcontext="$curcontext" \
@@ -29,7 +29,7 @@
       _saved_list="${compstate[list]}" \
       _saved_insert="${compstate[insert]}"
 
-typeset -U _lastdescr
+typeset -U _lastdescr _comp_ignore
 
 [[ -z "$curcontext" ]] && curcontext=:::
 
Index: Completion/Core/_path_files
===================================================================
RCS file: /cvsroot/zsh/zsh/Completion/Core/_path_files,v
retrieving revision 1.5
diff -u -r1.5 _path_files
--- Completion/Core/_path_files	2000/04/05 11:07:26	1.5
+++ Completion/Core/_path_files	2000/04/07 08:09:47
@@ -247,6 +247,8 @@
   # in the following loop, which walks through the pathname components
   # in the string from the line.
 
+  skipped=
+  cpre=
   tpre="$pre"
   tsuf="$suf"
   testpath="$donepath"

--
Sven Wischnowsky                         wischnow@informatik.hu-berlin.de

