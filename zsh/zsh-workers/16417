From zsh-workers-return-16417-mason-zsh=primenet.com.au@sunsite.dk Tue Jan 08 15:28:27 2002
Return-Path: <zsh-workers-return-16417-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 28976 invoked from network); 8 Jan 2002 15:28:26 -0000
Received: from sunsite.dk (130.225.247.90)
  by ns1.primenet.com.au with SMTP; 8 Jan 2002 15:28:26 -0000
Received: (qmail 7022 invoked by alias); 8 Jan 2002 15:28:21 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 16417
Received: (qmail 7011 invoked from network); 8 Jan 2002 15:28:21 -0000
From: Sven Wischnowsky <wischnow@berkom.de>
To: zsh-workers@sunsite.dk
Subject: PATCH: _arguments with multiple sets
Message-Id: <20020108152643.939D2245CE@wischnow.berkom.de>
Date: Tue,  8 Jan 2002 16:26:43 +0100 (CET)


Oliver pointed out to me that completion after `compdef -' was buggy
because the `-a' and `-n' options were listed multiple times.  That's
a result of _compdef using _arguments with multiple sets and the
C-code not removing multple identical specs reported back to the shell
code.  Here's a patch for that.


Bye
  Sven

Index: Src/Zle/computil.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/computil.c,v
retrieving revision 1.73
diff -u -r1.73 computil.c
--- Src/Zle/computil.c	2001/08/08 07:44:00	1.73
+++ Src/Zle/computil.c	2002/01/08 15:26:04
@@ -2315,6 +2315,7 @@
 	    LinkList direct = newlinklist();
 	    LinkList odirect = newlinklist();
 	    LinkList equal = newlinklist(), l;
+            LinkNode node;
 	    Caopt p;
 	    char *str;
 	    int ret = 1;
@@ -2349,7 +2350,13 @@
 				strcat(str, p->descr);
 			    } else
 				str = bslashcolon(p->name);
-			    addlinknode(l, str);
+
+                            for (node = firstnode(l); node; incnode(node))
+                                if (!strcmp(str, (char *) getdata(node)))
+                                    break;
+
+                            if (!node)
+                                addlinknode(l, str);
 			}
 		    }
 		}

-- 
Sven Wischnowsky                           wischnow@berkom.de

