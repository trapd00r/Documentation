From zsh-workers-return-26951-mason-zsh=primenet.com.au@sunsite.dk Fri May 08 14:20:58 2009
Return-Path: <zsh-workers-return-26951-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 21925 invoked from network); 8 May 2009 14:20:43 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 8 May 2009 14:20:43 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 77889 invoked from network); 8 May 2009 14:20:37 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 8 May 2009 14:20:37 -0000
Received: (qmail 10019 invoked by alias); 8 May 2009 14:20:31 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 26951
Received: (qmail 10007 invoked from network); 8 May 2009 14:20:30 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 8 May 2009 14:20:30 -0000
Received: from vms173017pub.verizon.net (vms173017pub.verizon.net [206.46.173.17])
	by bifrost.dotsrc.org (Postfix) with ESMTP id 892F282D4B6C
	for <zsh-workers@sunsite.dk>; Fri,  8 May 2009 16:20:25 +0200 (CEST)
Received: from torch.brasslantern.com ([96.249.201.13])
 by vms173017.mailsrvcs.net
 (Sun Java(tm) System Messaging Server 6.3-7.04 (built Sep 26 2008; 32bit))
 with ESMTPA id <0KJB00E3SX5JDAQY@vms173017.mailsrvcs.net> for
 zsh-workers@sunsite.dk; Fri, 08 May 2009 09:20:13 -0500 (CDT)
Received: from torch.brasslantern.com (localhost.localdomain [127.0.0.1])
	by torch.brasslantern.com (8.13.1/8.13.1) with ESMTP id n48EK6UY017363	for
 <zsh-workers@sunsite.dk>; Fri, 08 May 2009 07:20:07 -0700
Received: (from schaefer@localhost)	by torch.brasslantern.com
 (8.13.1/8.13.1/Submit) id n48EK64S017362	for zsh-workers@sunsite.dk; Fri,
 08 May 2009 07:20:06 -0700
From: Bart Schaefer <schaefer@brasslantern.com>
Message-id: <090508072006.ZM17359@torch.brasslantern.com>
Date: Fri, 08 May 2009 07:20:04 -0700
In-reply-to: <20090508093426.74ff4e59@news01>
Comments: In reply to Peter Stephenson <pws@csr.com>
 "Re: Modules on HP-UX (Re: D07multibyte.ztst failure on HP-UX 11.11)" (May  8,
  9:34am)
References: <20090501145253.GA5070@svalbard>
	<200905011518.n41FIlHi005089@news01.csr.com>	<20090505193931.GA2944@svalbard>
	<20090506202206.63bc26b0@pws-pc>	<20090506215026.GA5565@otaku>
	<20090507163819.1932f06e@news01>	<20090507170219.46d636e0@news01>
	<20090507220819.GA13920@svalbard>
	<090507163027.ZM15925@torch.brasslantern.com>	<20090508093426.74ff4e59@news01>
X-Mailer: OpenZMail Classic (0.9.2 24April2005)
To: zsh-workers@sunsite.dk
Subject: Re: Modules on HP-UX (Re: D07multibyte.ztst failure on HP-UX 11.11)
MIME-version: 1.0
Content-type: text/plain; charset=iso-8859-1
Content-transfer-encoding: quoted-printable
X-Virus-Scanned: ClamAV 0.92.1/9347/Fri May  8 07:10:18 2009 on bifrost
X-Virus-Status: Clean

On May 8,  9:34am, Peter Stephenson wrote:
} Subject: Re: Modules on HP-UX (Re: D07multibyte.ztst failure on HP-UX 11.1
}
} On Thu, 07 May 2009 16:30:27 -0700
} Bart Schaefer <schaefer@brasslantern.com> wrote:
} > schaefer<501> zmodload -u $(zmodload)
} > zmodload: module zsh/complete is in use by another module and cannot be=
 unloaded
} > zmodload: module zsh/zle is in use by another module and cannot be unlo=
aded
} > schaefer<502> zmodload -u $(zmodload)
} > Program received signal SIGSEGV, Segmentation fault.
} > 0x081284c7 in resetvideo () at ../../../zsh-4.0/Src/Zle/zle_refresh.c:7=
39
} > 739             if (nbuf[ln]) {
}=20
} Does this help?

It moves the segfault somewhere else, at least; now it craps out when
referencing the value of $COLUMNS in my precmd.  (Read more below the
stack trace.)

(gdb) where
#0  0x00462ed0 in _int_malloc () from /lib/tls/libc.so.6
#1  0x00464aa1 in malloc () from /lib/tls/libc.so.6
#2  0x0808ee3d in zshcalloc (size=3D48) at ../../zsh-4.0/Src/mem.c:601
#3  0x080973fb in createparam (name=3D0xb7cd63d8 "colno", flags=3D2097152)
    at ../../zsh-4.0/Src/params.c:841
#4  0x08052923 in typeset_single (cname=3D0xb7cd63a8 "local",=20
    pname=3D0xb7cd63d8 "colno", pm=3D0x0, func=3D0, on=3D2097152, off=3D0, =
roff=3D0,=20
    value=3D0x0, altpm=3D0x0, ops=3D0xbff46650, joinchar=3D0)
    at ../../zsh-4.0/Src/builtin.c:2168
#5  0x0805429d in bin_typeset (name=3D0xb7cd63a8 "local", argv=3D0xbff465fc=
,=20
    ops=3D0xbff46650, func=3D0) at ../../zsh-4.0/Src/builtin.c:2521
#6  0x0804d5b7 in execbuiltin (args=3D0xb7cd6360, bn=3D0x8153b7c)
    at ../../zsh-4.0/Src/builtin.c:439
#7  0x080679fa in execcmd (state=3D0xbff46e70, input=3D0, output=3D0, how=
=3D2, last1=3D2)
    at ../../zsh-4.0/Src/exec.c:3067
#8  0x08063975 in execpline2 (state=3D0xbff46e70, pcode=3D195, how=3D2, inp=
ut=3D0,=20
    output=3D0, last1=3D0) at ../../zsh-4.0/Src/exec.c:1561
#9  0x08062d76 in execpline (state=3D0xbff46e70, slcode=3D7170, how=3D2, la=
st1=3D0)
    at ../../zsh-4.0/Src/exec.c:1347
#10 0x080626d4 in execlist (state=3D0xbff46e70, dont_change_job=3D1, exitin=
g=3D0)
    at ../../zsh-4.0/Src/exec.c:1144
#11 0x0806219f in execode (p=3D0x837e470, dont_change_job=3D1, exiting=3D0)
    at ../../zsh-4.0/Src/exec.c:975
#12 0x0806a6bf in runshfunc (prog=3D0x837e470, wrap=3D0x0,=20
    name=3D0xb7cd6268 "prompt_bart_precmd") at ../../zsh-4.0/Src/exec.c:4459
#13 0x0806a410 in doshfunc (shfunc=3D0x837b9a8, doshargs=3D0x0, noreturnval=
=3D1)
    at ../../zsh-4.0/Src/exec.c:4353
#14 0x080be2c3 in callhookfunc (name=3D0x814796f "precmd", lnklst=3D0x0, ar=
rayp=3D1,=20
    retval=3D0x0) at ../../zsh-4.0/Src/utils.c:1184
#15 0x080be425 in preprompt () at ../../zsh-4.0/Src/utils.c:1237
#16 0x0807b006 in loop (toplevel=3D1, justonce=3D0) at ../../zsh-4.0/Src/in=
it.c:120
#17 0x0807e001 in zsh_main (argc=3D1, argv=3D0xbff47304)
    at ../../zsh-4.0/Src/init.c:1409
#18 0x0804cbea in main (argc=3D1, argv=3D0xbff47304) at ../../zsh-4.0/Src/m=
ain.c:93

If I turn off the precmd, it dies as soon as I type anything other than
a newline or a history motion at the prompt.  (Still more after this next
stack trace.)

(gdb) where
#0  0x00462ed0 in _int_malloc () from /lib/tls/libc.so.6
#1  0x00464aa1 in malloc () from /lib/tls/libc.so.6
#2  0x0808eccb in zalloc (size=3D44) at ../../zsh-4.0/Src/mem.c:583
#3  0x0813654f in mkundoent () at ../../../zsh-4.0/Src/Zle/zle_utils.c:1072
#4  0x0813633a in handleundo () at ../../../zsh-4.0/Src/Zle/zle_utils.c:1029
#5  0x0812078d in zlecore () at ../../../zsh-4.0/Src/Zle/zle_main.c:1061
#6  0x08120cb7 in zleread (lp=3D0x816c9b0, rp=3D0x0, flags=3D3, context=3D0)
    at ../../../zsh-4.0/Src/Zle/zle_main.c:1213
#7  0x08122a48 in zle_main_entry (cmd=3D1, ap=3D0xbfe63154 "`1=E6=BF")
    at ../../../zsh-4.0/Src/Zle/zle_main.c:1866
#8  0x0807dcd0 in zleentry (cmd=3D1) at ../../zsh-4.0/Src/init.c:1258
#9  0x0807e503 in inputline () at ../../zsh-4.0/Src/input.c:278
#10 0x0807e3b8 in ingetc () at ../../zsh-4.0/Src/input.c:214
#11 0x0807446e in ihgetc () at ../../zsh-4.0/Src/hist.c:263
#12 0x08085c2d in gettok () at ../../zsh-4.0/Src/lex.c:677
#13 0x0808550d in zshlex () at ../../zsh-4.0/Src/lex.c:364
#14 0x080a0140 in parse_event () at ../../zsh-4.0/Src/parse.c:451
#15 0x0807b049 in loop (toplevel=3D1, justonce=3D0) at ../../zsh-4.0/Src/in=
it.c:131
#16 0x0807e001 in zsh_main (argc=3D1, argv=3D0xbfe63334)
    at ../../zsh-4.0/Src/init.c:1409
#17 0x0804cbea in main (argc=3D1, argv=3D0xbfe63334) at ../../zsh-4.0/Src/m=
ain.c:93

So I tried something slightly different:

% zmodload -u $(zmodload)
zmodload: module zsh/complete is in use by another module and cannot be
unloaded
zmodload: module zsh/zle is in use by another module and cannot be unloaded
% zmodload -u $(zmodload); zmodload
% zmodload=20=20=20=20=20=20=20=20=20=20=20=20=20=20=20=20=20=20=20=20=20=
=20=20=20=20
zsh/compctl
zsh/complete
zsh/zle
%=20=20

Note that after the second zmodload -u, all modules really are unloaded,
but as soon as the prompt is printed the zle-based modules all have now
been reloaded again.  It's at this point that it segfaults.  So really
it appears to be a problem with booting up again after unloading, not
with unloading in the first place.

--=20

