From A.Main@dcs.warwick.ac.uk Thu May  9 10:04:57 1996
Received: from euclid.skiles.gatech.edu (list@euclid.skiles.gatech.edu [130.207.146.50]) by melb.werple.net.au (8.7.5/8.7.3) with ESMTP id KAA16487 for <mason@werple.mira.net.au>; Thu, 9 May 1996 10:04:55 +1000 (EST)
Received: (from list@localhost) by euclid.skiles.gatech.edu (8.7.3/8.7.3) id TAA20072; Wed, 8 May 1996 19:51:16 -0400 (EDT)
Resent-Date: Wed, 8 May 1996 19:51:16 -0400 (EDT)
From: Zefram <A.Main@dcs.warwick.ac.uk>
Message-Id: <7359.199605082350@stone.dcs.warwick.ac.uk>
Subject: fdtable bug
To: zsh-workers@math.gatech.edu (Z Shell workers mailing list)
Date: Thu, 9 May 1996 00:50:47 +0100 (BST)
X-Loop: zefram@dcs.warwick.ac.uk
X-Stardate: [-31]7474.96
X-US-Congress: Moronic fuckers
MIME-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
Resent-Message-ID: <"Z5Qfm3.0.Vv4.qDJan"@euclid>
Resent-From: zsh-workers@math.gatech.edu
X-Mailing-List: <zsh-workers@math.gatech.edu> archive/latest/1018
X-Loop: zsh-workers@math.gatech.edu
Precedence: list
Resent-Sender: zsh-workers-request@math.gatech.edu
Content-Length: 1309
Status: O

Someone posted a bug report, which had a pointer error deep within
exec.c, and mentioned that the bug went away when the shell was run
under gdb.  Well, I found a bug with exactly these properties.
Unfortunately it caused zsh to fall over while processing .zlogin, in
the account where I'd installed it.  Fortunately I was able to get into
the account without root intervention.

The effect of the bug is that movefd() can occasionally write 1 into
fdtable[-1].  In my case this was the low-order byte of shfunctab, and
so caused a bus error on the next command.

This happens because movefd() may be called upon to move a file
descriptor that is not actually valid.  We need to add a test in
movefd(), so that if the fd is invalid it doesn't write to fdtable.
movefd() is called from addfd() when creating a new multio, for the
purpose of saving the old file descriptor.  Unfortunately, I don't see
a simple way of saving an invalid file descriptor, because -1 in the
save array means that the fd hasn't been saved yet.  Maybe -2 should be
used for that, and then movefd() can return -1 for an invalid fd.

I don't include a patch, because I haven't thought through everything
involved yet.  I'll probably have a patch tomorrow (er, later today,
local British time), if nobody has done it by then.

-zefram


