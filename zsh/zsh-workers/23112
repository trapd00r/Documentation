From zsh-workers-return-23112-mason-zsh=primenet.com.au@sunsite.dk Tue Jan 16 03:01:32 2007
Return-Path: <zsh-workers-return-23112-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 19684 invoked from network); 16 Jan 2007 03:01:27 -0000
X-Spam-Checker-Version: SpamAssassin 3.1.7 (2006-10-05) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=AWL,BAYES_00,
	FORGED_RCVD_HELO autolearn=ham version=3.1.7
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 16 Jan 2007 03:01:27 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 20099 invoked from network); 16 Jan 2007 03:01:21 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 16 Jan 2007 03:01:21 -0000
Received: (qmail 12137 invoked by alias); 16 Jan 2007 03:01:18 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 23112
Received: (qmail 12128 invoked from network); 16 Jan 2007 03:01:18 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 16 Jan 2007 03:01:18 -0000
Received: (qmail 19809 invoked from network); 16 Jan 2007 03:01:18 -0000
Received: from vms042pub.verizon.net (206.46.252.42)
  by a.mx.sunsite.dk with SMTP; 16 Jan 2007 03:01:11 -0000
Received: from torch.brasslantern.com ([71.116.79.148])
 by vms042.mailsrvcs.net (Sun Java System Messaging Server 6.2-6.01 (built Apr
 3 2006)) with ESMTPA id <0JBX00BYPXP87RL5@vms042.mailsrvcs.net> for
 zsh-workers@sunsite.dk; Mon, 15 Jan 2007 21:00:45 -0600 (CST)
Received: from torch.brasslantern.com (localhost.localdomain [127.0.0.1])
	by torch.brasslantern.com (8.13.1/8.13.1) with ESMTP id l0G30hFg025671	for
 <zsh-workers@sunsite.dk>; Mon, 15 Jan 2007 19:00:44 -0800
Received: (from schaefer@localhost)	by torch.brasslantern.com
 (8.13.1/8.13.1/Submit) id l0G30heP025670	for zsh-workers@sunsite.dk; Mon,
 15 Jan 2007 19:00:43 -0800
Date: Mon, 15 Jan 2007 19:00:43 -0800
From: Bart Schaefer <schaefer@brasslantern.com>
Subject: Re: corrupt history file on NFS
In-reply-to: <20070116020321.GK10583@prunille.vinc17.org>
To: zsh-workers@sunsite.dk
Message-id: <070115190043.ZM25669@torch.brasslantern.com>
MIME-version: 1.0
X-Mailer: OpenZMail Classic (0.9.2 24April2005)
Content-type: text/plain; charset=us-ascii
References: <20070114202554.GB10583@prunille.vinc17.org>
	<20070115032716.GA22860@blorf.net>	<20070116020321.GK10583@prunille.vinc17.org>
Comments: In reply to Vincent Lefevre <vincent@vinc17.org>
 "Re: corrupt history file on NFS" (Jan 16,  3:03am)

On Jan 16,  3:03am, Vincent Lefevre wrote:
}
} *never* occurs if I read the history file with less before typing the

This sounds like an NFS synchronization issue.  Reading the file forces
the first write to be flushed out of the NFS cache.

This suggests that we might be able to work around it by always having
zsh seek to one btye short of the file size, and then read that byte,
before it attempts to append anything to the file.  However, it's really
not zsh's fault:  NFS writes are not required to be atomic, and zsh does
not know the file isn't local.  So this would have to be controlled by
an option, or something, so as not to penalize cases that don't need
NFS "safety".

