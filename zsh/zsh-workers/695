From zsh-workers-request@euclid.skiles.gatech.edu  Sat Dec 16 00:28:42 1995
Received: from euclid.skiles.gatech.edu (euclid.skiles.gatech.edu [130.207.146.50]) by werple.net.au (8.7/8.7.1) with ESMTP id AAA00157 for <mason@werple.mira.net.au>; Sat, 16 Dec 1995 00:28:34 +1100 (EST)
Received: (from list@localhost) by euclid.skiles.gatech.edu (8.7.3/8.7.3) id IAA18054; Fri, 15 Dec 1995 08:03:01 -0500 (EST)
Resent-Date: Fri, 15 Dec 1995 08:03:01 -0500 (EST)
Message-Id: <9512151303.AA25427@hydra.ifh.de>
To: zsh-workers@math.gatech.edu (Zsh hackers list)
Subject: watch formatting fix
Date: Fri, 15 Dec 1995 14:03:14 +0100
From: Peter Stephenson <pws@hydra.ifh.de>
Resent-Message-ID: <"6ovmz.0.0Q4.58Nqm"@euclid>
Resent-From: zsh-workers@math.gatech.edu
X-Mailing-List: <zsh-workers@math.gatech.edu> archive/latest/695
X-Loop: zsh-workers@math.gatech.edu
Precedence: list
Resent-Sender: zsh-workers-request@math.gatech.edu

This fixes the problem with standout etc. in $WATCHFMT strings.
The termcap routine was sending everything to the shell output file
regardless, which wasn't flushed until the next line, so that all the
rest of the stuff going to stdout wasn't emboldened.

There seems to be quite a lot of duplication between the watch
printing routine and the prompt printing routine.  I don't know
whether the txtchangeset stuff is necessary here or not.  It doesn't
seem to need it.

I've also corrected some indentation and deleted an unnecessary line
which sets the format when it's already been set, because I'm sad.

There weren't any comments so I didn't try adding any.

*** Src/watch.c.bak	Fri Dec 15 13:25:39 1995
--- Src/watch.c	Fri Dec 15 13:55:49 1995
***************
*** 226,258 ****
  		    putchar('%');
  		    break;
  		case 'S':
! 		   txtset(TXTSTANDOUT);
! 		   tsetcap(TCSTANDOUTBEG, 0);
! 		   break;
  		case 's':
! 		   txtset(TXTDIRTY);
! 		   txtunset(TXTSTANDOUT);
! 		   tsetcap(TCSTANDOUTEND, 0);
! 		   break;
  		case 'B':
! 		   txtset(TXTDIRTY);
! 		   txtset(TXTBOLDFACE);
! 		   tsetcap(TCBOLDFACEBEG, 0);
! 		  break;
  		case 'b':
! 		   txtset(TXTDIRTY);
! 		   txtunset(TXTBOLDFACE);
! 		   tsetcap(TCALLATTRSOFF, 0);
! 		   break;
  		case 'U':
! 		   txtset(TXTUNDERLINE);
! 		   tsetcap(TCUNDERLINEBEG, 0);
! 		   break;
  		case 'u':
! 		   txtset(TXTDIRTY);
! 		   txtunset(TXTUNDERLINE);
! 		   tsetcap(TCUNDERLINEEND, 0);
! 		   break;
  		default:
  		    putchar('%');
  		    putchar(*fm2);
--- 226,258 ----
  		    putchar('%');
  		    break;
  		case 'S':
! 		    txtset(TXTSTANDOUT);
! 		    tsetcap(TCSTANDOUTBEG, -1);
! 		    break;
  		case 's':
! 		    txtset(TXTDIRTY);
! 		    txtunset(TXTSTANDOUT);
! 		    tsetcap(TCSTANDOUTEND, -1);
! 		    break;
  		case 'B':
! 		    txtset(TXTDIRTY);
! 		    txtset(TXTBOLDFACE);
! 		    tsetcap(TCBOLDFACEBEG, -1);
! 		    break;
  		case 'b':
! 		    txtset(TXTDIRTY);
! 		    txtunset(TXTBOLDFACE);
! 		    tsetcap(TCALLATTRSOFF, -1);
! 		    break;
  		case 'U':
! 		    txtset(TXTUNDERLINE);
! 		    tsetcap(TCUNDERLINEBEG, -1);
! 		    break;
  		case 'u':
! 		    txtset(TXTDIRTY);
! 		    txtunset(TXTUNDERLINE);
! 		    tsetcap(TCUNDERLINEEND, -1);
! 		    break;
  		default:
  		    putchar('%');
  		    putchar(*fm2);
***************
*** 384,391 ****
      struct stat st;
  
      holdintr();
-     if (!fmt)
- 	fmt = "%n has %a %l from %m.";
      if (!wtab) {
  	readwtab();
  	noholdintr();
--- 384,389 ----
*** Src/zle_misc.c.bak	Fri Dec 15 13:43:46 1995
--- Src/zle_misc.c	Fri Dec 15 13:45:51 1995
***************
*** 696,703 ****
  tsetcap(int cap, int flag)
  {
      if (termok && !isset(SINGLELINEZLE) && tcstr[cap]) {
! 	if (flag == 0) 
! 	    tputs(tcstr[cap], 1, putshout);
  	else {
  	    if (!dontcount) {
  		int  t0;
--- 696,703 ----
  tsetcap(int cap, int flag)
  {
      if (termok && !isset(SINGLELINEZLE) && tcstr[cap]) {
! 	if (flag <= 0) 
! 	    tputs(tcstr[cap], 1, (flag < 0) ? putraw : putshout);
  	else {
  	    if (!dontcount) {
  		int  t0;

-- 
Peter Stephenson <pws@ifh.de>       Tel: +49 33762 77366
WWW:  http://www.ifh.de/~pws/       Fax: +49 33762 77330
Deutches Electronen-Synchrotron --- Institut fuer Hochenergiephysik Zeuthen
DESY-IfH, 15735 Zeuthen, Germany.

