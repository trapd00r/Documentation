From zsh-workers-return-11817-mason-zsh=primenet.com.au@sunsite.auc.dk Thu Jun 08 09:21:12 2000
Return-Path: <zsh-workers-return-11817-mason-zsh=primenet.com.au@sunsite.auc.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 12549 invoked from network); 8 Jun 2000 09:21:07 -0000
Received: from sunsite.auc.dk (130.225.51.30)
  by ns1.primenet.com.au with SMTP; 8 Jun 2000 09:21:07 -0000
Received: (qmail 16550 invoked by alias); 8 Jun 2000 09:20:46 -0000
Mailing-List: contact zsh-workers-help@sunsite.auc.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.auc.dk
X-Seq: 11817
Received: (qmail 16543 invoked from network); 8 Jun 2000 09:20:45 -0000
Date: Thu, 8 Jun 2000 11:20:38 +0200 (MET DST)
Message-Id: <200006080920.LAA20257@beta.informatik.hu-berlin.de>
From: Sven Wischnowsky <wischnow@informatik.hu-berlin.de>
To: zsh-workers@sunsite.auc.dk
In-reply-to: Felix Rosencrantz's message of Wed, 7 Jun 2000 19:50:52 -0700
	(PDT)
Subject: Re: PATCH: Small memory leak and doc fix


Felix Rosencrantz wrote:

> >The patch below seems to make sense, but I'm not sure if that was the
> >problem. Felix, could you try, please?
> 
> Sven, I built a cvs pull with your changes, and noticed that compmatch test
> failure that Vin is also seeing.

Yes, a thinko in the patch. Sorry.

> I used the shell during the day, and didn't see the memory problem I reported.
> However, some of completions I tried that I think will cause the problem also
> are failing.  So, the patch took care of the memory problem, but probably
> caused this new matching problem.

Ok. Could you try again with this patch? It should make things even
safer.

And I forgot to say: this might also have to do with the build.out
test failure some people saw (11653) and which couldn't
reproduce. Could someone who can reproduce that reliably (Andrej?
Felix?) try it again?


Bye
 Sven

Index: Src/Zle/compmatch.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/compmatch.c,v
retrieving revision 1.17
diff -u -r1.17 compmatch.c
--- Src/Zle/compmatch.c	2000/06/07 13:25:32	1.17
+++ Src/Zle/compmatch.c	2000/06/08 09:18:18
@@ -535,8 +535,7 @@
 		    }
 		    /* Give up if we don't have enough characters for the
 		     * line-string and the anchor. */
-		    if (ll < llen + alen ||
-			(sfx ? (lw < alen + aol) : (lw < alen || iw < aol)))
+		    if (ll < llen + alen || lw < alen)
 			continue;
 
 		    if (mp->flags & CMF_LEFT) {
@@ -561,8 +560,9 @@
 			if (!pattern_match(ap, l + aoff, NULL, NULL) ||
 			    (both &&
 			     (!pattern_match(ap, w + aoff, NULL, NULL) ||
-			      (aol && !pattern_match(aop, w + aoff - aol,
-						     NULL, NULL)) ||
+			      (aol && aol <= aoff + iw &&
+			       !pattern_match(aop, w + aoff - aol,
+					      NULL, NULL)) ||
 			      !match_parts(l + aoff, w + aoff, alen, part))))
 				continue;
 		    } else if (!both || il || iw)
@@ -572,19 +572,20 @@
 		     * string matched by the `*'. */
 		    if (sfx && (savl = l[-(llen + zoff)]))
 			l[-(llen + zoff)] = '\0';
-		    for (t = 0, tp = w, ct = 0,
-			     ict = lw - alen + 1 - (sfx ? aol : 0);
+		    for (t = 0, tp = w, ct = 0, ict = lw - alen + 1;
 			 ict;
 			 tp += add, ct++, ict--) {
 			if ((both &&
 			     (!ap || !test ||
 			      !pattern_match(ap, tp + aoff, NULL, NULL) ||
-			      (aol && !pattern_match(aop, tp + aoff - aol,
-						     NULL, NULL)))) ||
+			      (aol && aol <= aoff + ct + iw &&
+			       !pattern_match(aop, tp + aoff - aol,
+					      NULL, NULL)))) ||
 			    (!both &&
 			     pattern_match(ap, tp - moff, NULL, NULL) &&
-			     (!aol || pattern_match(aop, tp - moff - aol,
-						    NULL, NULL)) &&
+			     (!aol || (aol <= iw + ct - moff &&
+				       pattern_match(aop, tp - moff - aol,
+						     NULL, NULL))) &&
 			     (mp->wlen == -1 ||
 			      match_parts(l + aoff , tp - moff,
 						      alen, part)))) {

--
Sven Wischnowsky                         wischnow@informatik.hu-berlin.de

