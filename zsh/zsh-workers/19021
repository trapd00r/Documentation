From zsh-workers-return-19021-mason-zsh=primenet.com.au@sunsite.dk Wed Sep 03 13:55:13 2003
Return-Path: <zsh-workers-return-19021-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 19597 invoked from network); 3 Sep 2003 13:55:12 -0000
Received: from sunsite.dk (130.225.247.90)
  by ns1.primenet.com.au with SMTP; 3 Sep 2003 13:55:12 -0000
Received: (qmail 14606 invoked by alias); 3 Sep 2003 13:55:06 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 19021
Received: (qmail 14596 invoked from network); 3 Sep 2003 13:55:05 -0000
Received: from localhost (HELO sunsite.dk) (127.0.0.1)
  by localhost with SMTP; 3 Sep 2003 13:55:05 -0000
X-MessageWall-Score: 0 (sunsite.dk)
Received: from [193.109.254.211] by sunsite.dk (MessageWall 1.0.8) with SMTP; 3 Sep 2003 13:55:5 -0000
X-VirusChecked: Checked
X-Env-Sender: okiddle@yahoo.co.uk
X-Msg-Ref: server-4.tower-36.messagelabs.com!1062597303!322152
X-StarScan-Version: 5.0.7; banners=-,-,-
Received: (qmail 21394 invoked from network); 3 Sep 2003 13:55:03 -0000
Received: from iris.logica.co.uk (158.234.9.163)
  by server-4.tower-36.messagelabs.com with SMTP; 3 Sep 2003 13:55:03 -0000
Received: from gmcs3.local ([158.234.142.61])
	by iris.logica.co.uk (8.12.3/8.12.3/Debian -4) with ESMTP id h83Dt3HM029658
	for <zsh-workers@sunsite.dk>; Wed, 3 Sep 2003 14:55:03 +0100
Received: from gmcs3.local (localhost [127.0.0.1])
	by gmcs3.local (8.11.6/8.11.6/SuSE Linux 0.5) with ESMTP id h83Dv4k13619
	for <zsh-workers@sunsite.dk>; Wed, 3 Sep 2003 15:57:04 +0200
To: zsh-workers@sunsite.dk (Zsh hackers list)
X-VirusChecked: Checked
X-StarScan-Version: 5.0.7; banners=.,-,-
In-reply-to: <25211.1062585848@csr.com> 
From: Oliver Kiddle <okiddle@yahoo.co.uk>
References: <25211.1062585848@csr.com>
Subject: PATCH: Re: completing commands 
Date: Wed, 03 Sep 2003 15:57:04 +0200
Message-ID: <13617.1062597424@gmcs3.local>

Peter wrote:
> When I try to complete a command word with a path I often get,
> 
> Completing executable file or directory
> <list of directories>
> Completing directory
> <the same list of directories>
> 
> The second list comes from autocd --- it doesn't need to be the same
> list, because it can use cdpath, but often it is the same list because
> e.g. I typed ./ first.  Any thoughts about fixing this?  I suspect it's
> not trivial because it needs completion functions to be aware of one
> another.

In addition to that, it refuses to complete local directories in the
current directory.

There was some effort in _cd to handle the issue but it didn't go far
enough. I think this patch solves the problem.

Index: Completion/Zsh/Command/_cd
===================================================================
RCS file: /cvsroot/zsh/zsh/Completion/Zsh/Command/_cd,v
retrieving revision 1.6
diff -u -r1.6 _cd
--- Completion/Zsh/Command/_cd	30 Jan 2002 08:47:55 -0000	1.6
+++ Completion/Zsh/Command/_cd	3 Sep 2003 13:31:19 -0000
@@ -67,14 +67,15 @@
     # Don't complete local directories in command position, that's
     # already handled by _command_names (see _autocd)
 
-    [[ CURRENT -ne 1 ]] &&
+    [[ CURRENT -ne 1 || ( -z "$path[(r).]" && $PREFIX != */* ) ]] &&
         alt=( "${cdpath+local-}directories:${cdpath+local }directory:_path_files -/" "$alt[@]" )
 
     _alternative "$alt[@]" && ret=0
 
     return ret
   fi
-  _wanted directories expl directory _path_files -/ && ret=0
+  [[ CURRENT -ne 1 ]] && _wanted directories expl directory \
+      _path_files -/ && ret=0
 
   return ret
 fi

