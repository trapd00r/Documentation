From zsh-workers-return-23549-mason-zsh=primenet.com.au@sunsite.dk Mon Jun 11 20:22:30 2007
Return-Path: <zsh-workers-return-23549-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 7357 invoked from network); 11 Jun 2007 20:22:27 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.0 (2007-05-01) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=BAYES_00 autolearn=no
	version=3.2.0
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 11 Jun 2007 20:22:27 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 55067 invoked from network); 11 Jun 2007 20:22:21 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 11 Jun 2007 20:22:21 -0000
Received: (qmail 27894 invoked by alias); 11 Jun 2007 20:22:18 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 23549
Received: (qmail 27884 invoked from network); 11 Jun 2007 20:22:18 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 11 Jun 2007 20:22:18 -0000
Received: (qmail 54698 invoked from network); 11 Jun 2007 20:22:18 -0000
Received: from linuxtage.at (HELO mail.michael-prokop.at) (88.198.184.149)
  by a.mx.sunsite.dk with SMTP; 11 Jun 2007 20:22:14 -0000
Received: from mika.vc-graz.ac.at (mail.michael-prokop.at [88.198.6.110])
	by mail.michael-prokop.at (Postfix) with ESMTP id 51E7C478085
	for <zsh-workers@sunsite.dk>; Mon, 11 Jun 2007 22:22:12 +0200 (CEST)
Date: Mon, 11 Jun 2007 22:22:11 +0200
From: Michael Prokop <news@michael-prokop.at>
To: zsh-workers@sunsite.dk
Subject: zsh history gets destroyed when running out of disk space
Message-ID: <2007-06-11T21-20-52@devnull.michael-prokop.at>
Reply-To: Michael Prokop <zsh@michael-prokop.at>
Mail-Followup-To: zsh-workers@sunsite.dk
MIME-Version: 1.0
Content-Type: multipart/signed; micalg=pgp-sha1;
	protocol="application/pgp-signature"; boundary="buDNgeHiu+HCsDEc"
Content-Disposition: inline
X-URL: http://www.michael-prokop.at/
X-Operating-System: Debian GNU/Linux - 2.6.20-grml on a i686
X-Registered-Linux-User: 224337
X-Crypto: GnuPG/1.2.3 http://www.gnupg.org
X-GPG-Key-ID: 0x37E272E8
X-GPG-Key: http://www.michael-prokop.at/gpg
X-GPG-Fingerprint: 04AE E62C 9502 CD34 A7DA 857B D8DF 53FB 37E2 72E8
User-Agent: Mutt/1.5.13 (2006-08-11)


--buDNgeHiu+HCsDEc
Content-Type: multipart/mixed; boundary="vKcNkqnJHUUp475E"
Content-Disposition: inline


--vKcNkqnJHUUp475E
Content-Type: text/plain; charset=iso-8859-1
Content-Disposition: inline
Content-Transfer-Encoding: quoted-printable

Hi,

Problem:

Zsh truncates the zsh history file if you are running out of disk
space (AKA ENOSPC). If you don't have any space left in your $HOME
and exit zsh you'll find an empty $HISTFILE left.

Reason:

The savehistfile() function in Src/hist.c does not handle write
errors very smart.

Fix:

See attached patch (against version 4.3.4). The fix might need some
more work though. For example there should be much more and better
error handling; Zsh shouldn't exit with a return value of 0 when
such serious errors happen; the user should be informed about the
reason why it failed.

regards,
-mika-
--=20
 ,'"`.         http://www.michael-prokop.at/
(  grml.org -=BB Linux Live-CD for texttool-users and sysadmins
 `._,'         http://www.grml.org/

--vKcNkqnJHUUp475E
Content-Type: text/x-diff; charset=us-ascii
Content-Disposition: attachment; filename="zsh_fix_history_enospc.patch"
Content-Transfer-Encoding: quoted-printable

--- Src/hist.c.orig	2007-06-11 21:02:42.000000000 +0200
+++ Src/hist.c	2007-06-11 21:58:37.000000000 +0200
@@ -2158,6 +2158,11 @@
     Histent he;
     zlong xcurhist =3D curhist - !!(histactive & HA_ACTIVE);
     int extended_history =3D isset(EXTENDEDHISTORY);
+    int write_file =3D 1; // by default assume we can write the file
+
+    // make sure we don't write anything in case of an error
+    if (errno =3D=3D ENOSPC)
+      write_file =3D 0;
=20
     if (!interact || savehistsiz <=3D 0 || !hist_ring
      || (!fn && !(fn =3D getsparam("HISTFILE"))))
@@ -2222,7 +2227,7 @@
 #endif
 	}
     }
-    if (out) {
+    if (out && write_file) {
 	for (; he && he->histnum <=3D xcurhist; he =3D down_histent(he)) {
 	    if ((writeflags & HFILE_SKIPDUPS && he->node.flags & HIST_DUP)
 	     || (writeflags & HFILE_SKIPFOREIGN && he->node.flags & HIST_FOREIGN)

--vKcNkqnJHUUp475E--

--buDNgeHiu+HCsDEc
Content-Type: application/pgp-signature; name="signature.asc"
Content-Description: Digital signature
Content-Disposition: inline

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.6 (GNU/Linux)

iD8DBQFGba7z2N9T+zficugRAgHeAJ9ffVE74zRZC0fioPl18HDrhRcLggCeIn1n
X0bObtAuroObM1Tv60QRWzU=
=Ny/h
-----END PGP SIGNATURE-----

--buDNgeHiu+HCsDEc--

