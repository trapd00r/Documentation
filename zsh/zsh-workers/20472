From zsh-workers-return-20472-mason-zsh=primenet.com.au@sunsite.dk Tue Oct 12 01:53:28 2004
Return-Path: <zsh-workers-return-20472-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 7729 invoked from network); 12 Oct 2004 01:53:27 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 12 Oct 2004 01:53:27 -0000
Received: (qmail 275 invoked from network); 12 Oct 2004 01:53:19 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 12 Oct 2004 01:53:19 -0000
Received: (qmail 6800 invoked by alias); 12 Oct 2004 01:53:17 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 20472
Received: (qmail 6790 invoked from network); 12 Oct 2004 01:53:16 -0000
Received: from unknown (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 12 Oct 2004 01:53:16 -0000
Received: (qmail 99456 invoked from network); 12 Oct 2004 01:52:17 -0000
Received: from moonbase.zanshin.com (64.84.47.139)
  by a.mx.sunsite.dk with SMTP; 12 Oct 2004 01:52:15 -0000
Received: from toltec.zanshin.com (toltec.zanshin.com [64.84.47.166])
	by moonbase.zanshin.com (8.13.1/8.13.1) with ESMTP id i9C1qA9c014587;
	Mon, 11 Oct 2004 18:52:10 -0700
Date: Mon, 11 Oct 2004 18:52:10 -0700 (PDT)
From: Bart Schaefer <schaefer@brasslantern.com>
Reply-To: zsh-workers@sunsite.dk
To: Danek Duvall <duvall@comfychair.org>
cc: zsh-workers@sunsite.dk, Jordan Breeding <jordan.breeding@mac.com>
Subject: Re: prompt and prompt_cr option
In-Reply-To: <20041011232857.GB11629@lorien.comfychair.org>
Message-ID: <Pine.LNX.4.61.0410111742210.9416@toltec.zanshin.com>
References: <546D60C2-1A06-11D9-B624-000A95A6C222@mac.com>
 <Pine.LNX.4.61.0410111456360.9416@toltec.zanshin.com>
 <20041011232857.GB11629@lorien.comfychair.org>
MIME-Version: 1.0
Content-Type: TEXT/PLAIN; charset=US-ASCII
X-Spam-Checker-Version: SpamAssassin 2.63 on a.mx.sunsite.dk
X-Spam-Level: 
X-Spam-Status: No, hits=0.0 required=6.0 tests=none autolearn=no version=2.63
X-Spam-Hits: 0.0

On Mon, 11 Oct 2004, Danek Duvall wrote:

> On Mon, Oct 11, 2004 at 03:11:43PM -0700, Bart Schaefer wrote:
> 
> > For certain types of terminals you might be able to query the current 
> > cursor position and do something clever when it is not in column zero
> 
> On the other hand, you could write a precmd function that did this and 
> spit out an extra newline if necessary (and set nopromptcr), no?

Unfortunately it's not quite that simple.

As far as I can tell, there's no terminfo/termcap capability that defines
the "report cursor position" string.  So it can't easily be determined
whether the terminal supports it, or what to send.

If the terminal is ANSI/ECMA compliant, the query string is $'\e[6n' and 
the response is $'\e[ll;ccR' where cc and ll are the column and line 
numbers -- but if it is not ANSI then sending that string won't give any 
response (and may just garble the output further).

So the following might work, or might not.  It uses the prompt printed by
the read builtin to query the terminal and the combination of IFS and the
-d option to parse the response.

  precmd() {
    local escape colno lineno
    IFS='[;' read -s -d R escape\?$'\e[6n' lineno colno
    (( colno > 1 )) && echo ''
  }

