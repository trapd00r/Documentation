From zsh-workers-request@math.gatech.edu  Wed Aug 23 00:50:28 1995
Received: from gatech.edu (gatech.edu [130.207.244.244]) by werple.mira.net.au (8.6.12/8.6.9) with SMTP id AAA01826 for <mason@werple.mira.net.au>; Wed, 23 Aug 1995 00:50:17 +1000
Received: from math (math.skiles.gatech.edu) by gatech.edu with SMTP id AA00855
  (5.65c/Gatech-10.0-IDA for <mason@werple.mira.net.au>); Tue, 22 Aug 1995 10:38:30 -0400
Received: by math (5.x/SMI-SVR4)
	id AA13142; Tue, 22 Aug 1995 10:29:47 -0400
Resent-Date: Tue, 22 Aug 1995 16:31:43 +0200 (MET DST)
Old-Return-Path: <hzoli@cs.elte.hu>
From: Zoltan Hidvegi <hzoli@cs.elte.hu>
Message-Id: <199508221431.QAA00223@bolyai.cs.elte.hu>
Subject: HISTORY saving fixes
To: zsh-workers@math.gatech.edu (zsh-workers)
Date: Tue, 22 Aug 1995 16:31:43 +0200 (MET DST)
X-Mailer: ELM [version 2.4 PL24]
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
Resent-Message-Id: <"IHC6f2.0.GD3.QdUEm"@math>
Resent-From: zsh-workers@math.gatech.edu
X-Mailing-List: <zsh-workers@math.gatech.edu> archive/latest/337
X-Loop: zsh-workers@math.gatech.edu
Precedence: list
Resent-Sender: zsh-workers-request@math.gatech.edu

Zsh saves history on each command substitution.  I thought that this bug was
corrected long ago.

The patch below fixes this, and it also saves history when a builtin is
exec'ed.  It also disables history saving on exec in the startup files
(that's what Mark Borges complaind about a lot).  That's because zsh loads
the history file only after processing the startup files so saving it with
append_history unset would wipe out the history.  History saving is also
disabled in zexit for the same reason.

Unfortunately the exec part of this fix does not work as expected.  After
this patch zsh will never save anything on exec.  That is because subsh is
always true since entersubsh is called from exec.c near line 1241 for each
command or builtin executed with exec. This seems illogical for me but I do
not understand these things completely so I'd leave the fix to someone else.

The patch is for vanilla beta10.  For hzoli10.x the first hunk fails but it
can be merged easily by hand, and the really important part is the second
hunk.

Zoltan

PS. I will not read my mails till the end of next week.

*** Src/exec.c.~1~	Mon Aug 21 23:40:20 1995
--- Src/exec.c	Mon Aug 21 23:41:12 1995
***************
*** 1447,1454 ****
  		if (cmd->flags & CFLAG_EXEC) {
  		    if (subsh)
  			_exit(lastval);
! 		    else
! 			exit(lastval);
  		}
  		if (savelist) {
  		    /* Restore variables, freeing the list but not data. */
--- 1447,1456 ----
  		if (cmd->flags & CFLAG_EXEC) {
  		    if (subsh)
  			_exit(lastval);
! 		    if (unset(NORCS) && interact && sourcelevel < 32768)
! 			/* save the history file through execs */
! 			savehistfile(getsparam("HISTFILE"), 1, isset(APPENDHISTORY) ? 3 : 0);
! 		    exit(lastval);
  		}
  		if (savelist) {
  		    /* Restore variables, freeing the list but not data. */
***************
*** 1468,1474 ****
  	} else {
  	    if (cmd->flags & CFLAG_EXEC) {
  		setiparam("SHLVL", --shlvl);
! 		if (unset(NORCS) && interact)
  		    /* save the history file through execs */
  		    savehistfile(getsparam("HISTFILE"), 1, isset(APPENDHISTORY) ? 3 : 0);
  	    }
--- 1470,1476 ----
  	} else {
  	    if (cmd->flags & CFLAG_EXEC) {
  		setiparam("SHLVL", --shlvl);
! 		if (unset(NORCS) && interact && !subsh && sourcelevel < 32768)
  		    /* save the history file through execs */
  		    savehistfile(getsparam("HISTFILE"), 1, isset(APPENDHISTORY) ? 3 : 0);
  	    }
*** 1.28	1995/08/21 22:02:42
--- Src/builtin.c	1995/08/21 22:04:09
***************
*** 4829,4835 ****
  	    }
  	} else
  	    killrunjobs(); /* send SIGHUP to any jobs left running  */
!     if (unset(NORCS) && interact) {
  	if (isset(APPENDHISTORY))
  	    savehistfile(getsparam("HISTFILE"), 1, 3);
  	else
--- 4829,4835 ----
  	    }
  	} else
  	    killrunjobs(); /* send SIGHUP to any jobs left running  */
!     if (unset(NORCS) && interact && sourcelevel < 32768) {
  	if (isset(APPENDHISTORY))
  	    savehistfile(getsparam("HISTFILE"), 1, 3);
  	else

