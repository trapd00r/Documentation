From zsh-workers-return-28272-mason-zsh=primenet.com.au@zsh.org Sat Sep 18 16:50:49 2010
Return-Path: <zsh-workers-return-28272-mason-zsh=primenet.com.au@zsh.org>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 23872 invoked by alias); 18 Sep 2010 16:50:49 -0000
Mailing-List: contact zsh-workers-help@zsh.org; run by ezmlm
Precedence: bulk
X-No-Archive: yes
List-Id: Zsh Workers List <zsh-workers.zsh.org>
List-Post: <mailto:zsh-workers@zsh.org>
List-Help: <mailto:zsh-workers-help@zsh.org>
Delivered-To: mailing list zsh-workers@zsh.org
X-Seq: 28272
Received: (qmail 16213 invoked from network); 18 Sep 2010 16:50:46 -0000
X-Spam-Checker-Version: SpamAssassin 3.3.1 (2010-03-16) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.0 required=5.0 tests=BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,FREEMAIL_FROM,RCVD_IN_DNSWL_NONE autolearn=ham
	version=3.3.1
Received-SPF: pass (ns1.primenet.com.au: SPF record at _spf.google.com designates 209.85.212.43 as permitted sender)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=gamma;
        h=domainkey-signature:mime-version:received:received:date:message-id
         :subject:from:to:content-type;
        bh=UnRxw3EkEpCFt4KmCLCXHrk6yRL+rmCasaFUXHv+y6s=;
        b=j7w6p+4y/izL6YTWNK30QjvJQ0eTfA+nKENpTbUr5VIg7pf2F2wRws7WdyJMvclNJs
         Ix0MuKbia7McVQ7iKxfRZCgp1jKGsNQ4CkbUZWOPS5tyiloMAHFSCeKtmyw6exnqsjX9
         msF8U3rhFuSEPIY0PoOzwXHKHgDqBEMT2BZjA=
DomainKey-Signature: a=rsa-sha1; c=nofws;
        d=gmail.com; s=gamma;
        h=mime-version:date:message-id:subject:from:to:content-type;
        b=QjjLXYS4ErNvrK3neKadeuN7WwMH+4ti3/mVkvTZuPmMmoxNrKfve9sxgcUMEeyIyC
         AdBEyN5Z5LmE9TKpxbSR/0VzExgUavGn02gLBWwLceZaOiroGLei/O0m9tbrxWzklE/V
         +5ZsyoVG1KEftolN50WZwQtVLCe6avK3qts0o=
MIME-Version: 1.0
Date: Sat, 18 Sep 2010 18:50:42 +0200
Message-ID: <AANLkTinEDT7WjY3JFUuMXiN7mHLCYo5OJfsgs2jGW1Sd@mail.gmail.com>
Subject: Add a hook on isearch
From: Mikael Magnusson <mikachu@gmail.com>
To: zsh workers <zsh-workers@zsh.org>
Content-Type: text/plain; charset=UTF-8

This might make something explode, but it's probably pretty useful.

function _show_surroundings() {
  typeset -a output
  typeset -A star
  star[$HISTNO]="*"
  for ((i = HISTNO - ${NUMERIC:-5}; i < HISTNO + ${NUMERIC:-5} && i <
HISTCMD; i++)); do
    output=( "$star[$i]$i: $history[$i]" $output )
  done
  zle -M ${(pj:\n:)output}
}
zle -N zle-isearch-update _show_surroundings

% edit .zshrc
bck-i-search: edit .zshrc_
2293: src
*2292: edit .zshrc
2291: zle-isearch-update() { zle _show_surroundings }
2290: zle-isearch-update() { zle -M $HISTNO }
2289: zle-isearch-update() { zle -M lol }
2288: zle -N zle-isearch-update
2287: echo $history[HISTCMD]

commit 8ab10e2394da712db896662316fb4df304c212ef
Author: Mikael Magnusson <mikachu@gmail.com>
Date:   Sat Sep 18 18:46:38 2010 +0200

    Add zle-isearch-update

diff --git a/Src/Zle/zle_hist.c b/Src/Zle/zle_hist.c
index d9586b8..1daf8e1 100644
--- a/Src/Zle/zle_hist.c
+++ b/Src/Zle/zle_hist.c
@@ -1472,7 +1472,16 @@ doisearch(char **args, int dir, int pattern)
 	} else
 	    isearch_active = 0;
     ref:
+        if ((cmd = rthingy_nocreate("zle-isearch-update"))) {
+           char *args[2];
+           args[0] = cmd->nam;
+           args[1] = NULL;
+           execzlefunc(cmd, args, 1);
+           unrefthingy(cmd);
+        }
+
 	zrefresh();
+
 	if (!(cmd = getkeycmd()) || cmd == Th(z_sendbreak)) {
 	    int i;
 	    aborted = 1;


-- 
Mikael Magnusson

