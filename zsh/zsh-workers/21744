From zsh-workers-return-21744-mason-zsh=primenet.com.au@sunsite.dk Thu Sep 22 01:12:08 2005
Return-Path: <zsh-workers-return-21744-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 23645 invoked from network); 22 Sep 2005 01:12:05 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 22 Sep 2005 01:12:05 -0000
Received: (qmail 51197 invoked from network); 22 Sep 2005 01:11:59 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 22 Sep 2005 01:11:59 -0000
Received: (qmail 22981 invoked by alias); 22 Sep 2005 01:11:56 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 21744
Received: (qmail 22972 invoked from network); 22 Sep 2005 01:11:54 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 22 Sep 2005 01:11:54 -0000
Received: (qmail 50840 invoked from network); 22 Sep 2005 01:11:54 -0000
Received: from mail1.kontent.de (81.88.34.36)
  by a.mx.sunsite.dk with SMTP; 22 Sep 2005 01:11:53 -0000
Received: from caphuso.rueger.local (p5481CC88.dip.t-dialin.net [84.129.204.136])
	(using TLSv1 with cipher AES256-SHA (256/256 bits))
	(No client certificate requested)
	by Mail1.KONTENT.De (Postfix) with ESMTP id 97E2310C646B
	for <zsh-workers@sunsite.dk>; Thu, 22 Sep 2005 03:11:51 +0200 (CEST)
Received: from caphuso by caphuso.rueger.local with local (Exim 4.52)
	id 1EIFcm-00071d-Bx
	for zsh-workers@sunsite.dk; Thu, 22 Sep 2005 03:11:44 +0200
Date: Thu, 22 Sep 2005 03:11:44 +0200
From: Stephen Rueger <stephen.rueger@rechnerpost.org>
To: zsh-workers@sunsite.dk
Subject: maybe PATCH: 21731 broke handling of prompts with newlines in it
Message-ID: <20050922011144.GA26563@rechnerpost.org>
Mail-Followup-To: zsh-workers@sunsite.dk
Mime-Version: 1.0
Content-Type: text/plain; charset=iso-8859-1
Content-Disposition: inline
Content-Transfer-Encoding: 8bit
X-seti: 2502
User-Agent: Mutt/1.5.9i
X-Spam-Checker-Version: SpamAssassin 3.0.4 (2005-06-05) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=BAYES_00 autolearn=ham 
	version=3.0.4

Hello!

Disclaimer: I hardly know any C, and this is my first journey into the
Zsh source that didn't end with me giving up totally swamped, please
treat the following accordingly.

The new multibyte aware promptcount seems to have a test backwards that
checks if the special treatment of \n and \t can be skipped because the
shell is in the middle of processing a multibyte character.

This simple patch should solve the problem:

--- Src/prompt.c.old	2005-09-22 02:44:38.000000000 +0200
+++ Src/prompt.c	2005-09-22 02:45:30.000000000 +0200
@@ -859,7 +859,7 @@
 		 * relying on the character set being an extension
 		 * of ASCII so it's safe to test a single byte.
 		 */
-		if (multi) {
+		if (!multi) {
 #endif
 		    if (*str == '\t') {
 			w = (w | 7) + 1;



-- 
Stephen Rüger
stephen.rueger@rechnerpost.org

