From zsh-workers-return-20717-mason-zsh=primenet.com.au@sunsite.dk Sat Jan 15 19:28:33 2005
Return-Path: <zsh-workers-return-20717-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 19788 invoked from network); 15 Jan 2005 19:28:32 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 15 Jan 2005 19:28:32 -0000
Received: (qmail 32525 invoked from network); 15 Jan 2005 19:28:26 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 15 Jan 2005 19:28:26 -0000
Received: (qmail 14473 invoked by alias); 15 Jan 2005 19:28:12 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 20717
Received: (qmail 14463 invoked from network); 15 Jan 2005 19:28:11 -0000
Received: from unknown (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 15 Jan 2005 19:28:11 -0000
Received: (qmail 32026 invoked from network); 15 Jan 2005 19:27:12 -0000
Received: from cmailm1.svr.pol.co.uk (195.92.193.18)
  by a.mx.sunsite.dk with SMTP; 15 Jan 2005 19:27:08 -0000
Received: from modem-79.anthias-fish.dialup.pol.co.uk ([62.136.224.79] helo=pwstephenson.fsnet.co.uk)
	by cmailm1.svr.pol.co.uk with esmtp (Exim 4.41)
	id 1CptZh-00076K-Sx
	for zsh-workers@sunsite.dk; Sat, 15 Jan 2005 19:27:06 +0000
Received: by pwstephenson.fsnet.co.uk (Postfix, from userid 501)
	id D31B385AF; Sat, 15 Jan 2005 14:28:36 -0500 (EST)
Received: from pwstephenson.fsnet.co.uk (localhost [127.0.0.1])
	by pwstephenson.fsnet.co.uk (Postfix) with ESMTP id 983D08551
	for <zsh-workers@sunsite.dk>; Sat, 15 Jan 2005 19:28:36 +0000 (GMT)
To: Zsh hackers list <zsh-workers@sunsite.dk>
Subject: Re: Some groundwork for Unicode in Zle 
In-reply-to: <20050115173549.GA28859@scowler.net> 
References: <200501111352.j0BDqCKs001801@news01.csr.com> <200501111359.j0BDxbQn001884@news01.csr.com> <200501141310.j0EDAZj7014813@news01.csr.com> <20050115173549.GA28859@scowler.net>
Date: Sat, 15 Jan 2005 19:28:35 +0000
From: Peter Stephenson <pws@pwstephenson.fsnet.co.uk>
Message-Id: <20050115192836.D31B385AF@pwstephenson.fsnet.co.uk>
X-Spam-Checker-Version: SpamAssassin 3.0.2 on a.mx.sunsite.dk
X-Spam-Level: 
X-Spam-Status: No, score=-1.6 required=6.0 tests=BAYES_00,URIBL_SBL 
	autolearn=no version=3.0.2
X-Spam-Hits: -1.6

Clint Adams wrote:
> > Trapping and converting all direct or indirect uses of zlecs (cursor
> > position) and zlell (line length) outside the core zle code to use the
> > correct position with a multibyte string is likely to be a nightmare.
> 
> I wonder if moving the zlecs-/zlell-using functions from Src/hist.c and
> Src/lex.c to Src/Zle would be a good idea, since they seem to be
> operating directly on the input buffer.

That's a long term goal.  I'd like to have separate variables within the
main shell (and probably the completion system, though that's murkier)
so that zlecs and zlell are only ever used when referring directly to
zleline.  The idea is that when converting the line to a multibyte
string we also convert the character positions to refer to the position
in that rather than the original wide character array.

For now, the problem is that if we move them into zle, we need hooks to
get at them from the main shell when appropriate.  That's not worth
doing if they're going to disappear from the main shell eventually.

I had a brief go at replacing zlecs and zlell when used for completion
and it blew up.  I think the difficulties were actually in the
completion functions that set up and use the lexical analyser, however.
It wasn't clear when to convert and when to restore.  Any help there
would be appreciated.

-- 
Peter Stephenson <pws@pwstephenson.fsnet.co.uk>
Work: pws@csr.com
Web: http://www.pwstephenson.fsnet.co.uk

