From zsh-workers-return-22995-mason-zsh=primenet.com.au@sunsite.dk Fri Nov 10 16:12:10 2006
Return-Path: <zsh-workers-return-22995-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 12174 invoked from network); 10 Nov 2006 16:12:04 -0000
X-Spam-Checker-Version: SpamAssassin 3.1.7 (2006-10-05) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.4 required=5.0 tests=AWL,BAYES_00,
	FORGED_RCVD_HELO autolearn=ham version=3.1.7
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 10 Nov 2006 16:12:04 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 32116 invoked from network); 10 Nov 2006 16:11:58 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 10 Nov 2006 16:11:58 -0000
Received: (qmail 15793 invoked by alias); 10 Nov 2006 16:11:56 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 22995
Received: (qmail 15784 invoked from network); 10 Nov 2006 16:11:54 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 10 Nov 2006 16:11:54 -0000
Received: (qmail 31866 invoked from network); 10 Nov 2006 16:11:54 -0000
Received: from cluster-c.mailcontrol.com (168.143.177.190)
  by a.mx.sunsite.dk with SMTP; 10 Nov 2006 16:11:50 -0000
Received: from cameurexb01.EUROPE.ROOT.PRI ([62.189.241.200])
	by rly20c.srv.mailcontrol.com (MailControl) with ESMTP id kAAGBiCv018362
	for <zsh-workers@sunsite.dk>; Fri, 10 Nov 2006 16:11:45 GMT
Received: from news01.csr.com ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.1830);
	 Fri, 10 Nov 2006 16:09:12 +0000
Received: from news01.csr.com (localhost.localdomain [127.0.0.1])
	by news01.csr.com (8.13.7/8.13.4) with ESMTP id kAAG9BsB019941
	for <zsh-workers@sunsite.dk>; Fri, 10 Nov 2006 16:09:11 GMT
Received: from csr.com (pws@localhost)
	by news01.csr.com (8.13.7/8.13.7/Submit) with ESMTP id kAAG9ArT019938
	for <zsh-workers@sunsite.dk>; Fri, 10 Nov 2006 16:09:11 GMT
Message-Id: <200611101609.kAAG9ArT019938@news01.csr.com>
X-Authentication-Warning: news01.csr.com: pws owned process doing -bs
To: zsh-workers@sunsite.dk (Zsh hackers list)
Subject: Re: PATCH: exit status 
In-reply-to: <061110075808.ZM4615@torch.brasslantern.com> 
References: <200611100940.kAA9ewZY012583@news01.csr.com> <061110075808.ZM4615@torch.brasslantern.com>
Comments: In-reply-to Bart Schaefer <schaefer@brasslantern.com>
   message dated "Fri, 10 Nov 2006 07:58:08 -0800."
Date: Fri, 10 Nov 2006 16:09:10 +0000
From: Peter Stephenson <pws@csr.com>
X-OriginalArrivalTime: 10 Nov 2006 16:09:12.0272 (UTC) FILETIME=[8FA98500:01C704E2]
Content-Type: text/plain
MIME-Version: 1.0
X-Scanned-By: MailControl A-07-06-75 (www.mailcontrol.com) on 10.67.0.130

Bart Schaefer wrote:
> On Nov 10,  9:40am, Peter Stephenson wrote:
> }
> } A thread on the Austin group suggests the exit status of the shell
> } should be available in exit traps.
> 
> I'm leaning towards Don Cragun's camp (the prior-to-this-patch zsh
> behavior) on this one.

I can see arguments for both sides; it turns whether you consider the
"exit" command itself to have been executed before the exit traps run,
which is a bit Zen-like.  What finally convinced me is that knowing the
exit status in $? is potentially useful; knowing the status of whatever
command happened to run before is very unlikely to be.  In other
words, if we *do* leave it the old way it simply means the status isn't
useful.

> I think the answer (and a general issue about
> the new hook functions, incidentally) is tied to the answer to this
> other question:
> 
> What is the final exit status of the shell when the exit trap itself
> calls exit?
> 
> If
> 	trap 'exit 42' EXIT; exit 1
> 
> returns 42 to the calling environment, then Korn and the GNU guys are
> correct.  If it exits 1, then Don Cragun is correct.
> 
> Similarly, what happens if the zshexit hook calls exit?  What happens
> if the zshexit hook calls "return 37"?

I alluded to this briefly: hooks and traps run in special contexts which
don't alter the global status.  This has been the case for some time
(though I don't think it was originally like that---early versions were
fairly wayward about return statuses).  That's required in some specific
cases --- the DEBUG trap would be unusable (or at least need extreme
care in writing) if its status were returned to the main shell.  Also,
if we have multiple exit hooks and want them to get the same status
(since they shouldn't care about previous hooks) we need their return
statuses to be protected.  That's how it currently works.

-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070


To access the latest news from CSR copy this link into a web browser:  http://www.csr.com/email_sig.php

