From zsh-workers-return-17394-mason-zsh=primenet.com.au@sunsite.dk Wed Jul 03 07:58:07 2002
Return-Path: <zsh-workers-return-17394-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 28521 invoked from network); 3 Jul 2002 07:58:07 -0000
Received: from sunsite.dk (130.225.247.90)
  by ns1.primenet.com.au with SMTP; 3 Jul 2002 07:58:07 -0000
Received: (qmail 8428 invoked by alias); 3 Jul 2002 07:57:59 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 17394
Received: (qmail 8417 invoked from network); 3 Jul 2002 07:57:59 -0000
From: Sven Wischnowsky <wischnow@berkom.de>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Transfer-Encoding: 7bit
Message-ID: <15650.44729.712285.387456@wischnow.berkom.de>
Date: Wed, 3 Jul 2002 09:58:49 +0200
To: Felix Rosencrantz <f_rosencrantz@yahoo.com>,
	zsh-workers@sunsite.dk
Subject: Re: Menu selection
In-Reply-To: <20020627182621.70670.qmail@web10405.mail.yahoo.com>
References: <15642.49846.468542.689062@wischnow.berkom.de>
	<20020627182621.70670.qmail@web10405.mail.yahoo.com>
X-Mailer: VM 7.03 under 21.5 (patch 5) "beets" XEmacs Lucid


You wrote:

> Here is a recipe, that causes a core dump for me:
> 
> host% autoload -U compinit; compinit -D
> host% zmodload zsh/complist
> host% bindkey "^Bm" menu-select
> host% bindkey "^Bi" vi-insert
> host% mkdir bug ; cd bug
> host% touch a b ba bb c
> host% more [^Bm]zsh: segmentation fault  $SHELL -f
> 
> I intended to do "^Bi" after "^Bm", since menu-select usually works for me.
> I've been seeing the problem with vi-insert.

(Sorry for the delay, Felix.)

Problem was that `dat' isn't set when the menu-select widget is called
(instead of calling menu selection via styles). This should fix it.


Bye
  Sven

Index: Src/Zle/complist.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/complist.c,v
retrieving revision 1.51
diff -u -r1.51 complist.c
--- Src/Zle/complist.c	26 Jun 2002 11:07:46 -0000	1.51
+++ Src/Zle/complist.c	3 Jul 2002 07:55:33 -0000
@@ -2201,9 +2201,9 @@
 	    menucomplete(zlenoargs);
 	    iforcemenu = 0;
 
-	    if (dat->num < 1 || !minfo.cur || !*(minfo.cur)) {
+	    if ((dat ? dat->num : nmatches) < 1 || !minfo.cur || !*(minfo.cur)) {
 		nolist = 1;
-		if (dat->nmesg || nmessages) {
+		if ((dat ? (dat->nmesg || nmessages) : nmessages)) {
 		    showinglist = -2;
 		    zrefresh();
 		} else {
@@ -2768,13 +2768,13 @@
     mselect = mlastcols = mlastlines = -1;
     mstatus = NULL;
     inselect = mhasstat = 0;
-    if (acc) {
+    if (acc && validlist && minfo.cur) {
 	menucmp = lastambig = hasoldlist = 0;
 	do_single(*(minfo.cur));
     }
     if (wasnext || broken) {
 	menucmp = 2;
-	showinglist = -2;
+	showinglist = (validlist ? -2 : 0);
 	minfo.asked = 0;
 	if (!noselect) {
 	    int nos = noselect;
@@ -2784,7 +2784,7 @@
 	}
     }
     if (!noselect && (!dat || acc)) {
-	showinglist = -2;
+	showinglist = (validlist ? -2 : 0);
 	onlyexpl = oe;
 	if (!smatches)
 	    clearlist = 1;

-- 
Sven Wischnowsky                          wischnow@berkom.de

