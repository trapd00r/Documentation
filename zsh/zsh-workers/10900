From zsh-workers-return-10900-mason-zsh=primenet.com.au@sunsite.auc.dk Tue Apr 25 04:10:27 2000
Return-Path: <zsh-workers-return-10900-mason-zsh=primenet.com.au@sunsite.auc.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 20834 invoked from network); 25 Apr 2000 04:10:25 -0000
Received: from sunsite.auc.dk (130.225.51.30)
  by ns1.primenet.com.au with SMTP; 25 Apr 2000 04:10:25 -0000
Received: (qmail 26274 invoked by alias); 25 Apr 2000 04:10:18 -0000
Mailing-List: contact zsh-workers-help@sunsite.auc.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.auc.dk
X-Seq: 10900
Received: (qmail 26256 invoked from network); 25 Apr 2000 04:10:17 -0000
From: "Bart Schaefer" <schaefer@candle.brasslantern.com>
Message-Id: <1000425041008.ZM8030@candle.brasslantern.com>
Date: Tue, 25 Apr 2000 04:10:08 +0000
X-Mailer: Z-Mail (5.0.0 30July97)
To: zsh-workers@sunsite.auc.dk
Subject: PATCH: Break annoying make dependency cycle
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii

After weeks of being annoyed when init.o was unexpectedly recompiled, I at
last noticed that zsh always recompiles at least twice whenever there is
a change to any of the .mk or .in files.  Try it:  With an existing build
tree, run

    touch Src/Makefile.in
    make
    make

You'll see that zsh recreates modules-bltin and consequently recompiles on
the second make, even if it already relinked the zsh binary the first time.
(Maybe this is GNU-make-specific?)

This happens because the first make executes config.status to recreate the
Makefile, but it has already considered modules-bltin to be up to date at
that point -- so it doesn't rebuild *that* until the *second* make, even
though (and because) there's a dependency of modules-bltin on Makefile.

The reason for the dependency of modules-bltin on Makefile appears to be
the reference to the @D@ substitution in the modules-bltin action.  To
break this loop and assure that the *first* make really rebuilds anything
that may need rebuilding, the dependency should be on config.status, which
is guaranteed to change any time the @D@ substitution would change.

Almost two hundred times as many words to explain it as to fix it.  Whew.

Index: Src/Makefile.in
===================================================================
@@ -137,7 +137,7 @@
 	    cat mymods.conf > $@; \
 	fi
 
-modules-bltin:: Makefile $(sdir)/xmods.conf
+modules-bltin:: $(dir_top)/config.status $(sdir)/xmods.conf
 	if test -f mymods.conf; then \
 	    cat mymods.conf > $@; \
 	elif test @D@ = N; then \

-- 
Bart Schaefer                                 Brass Lantern Enterprises
http://www.well.com/user/barts              http://www.brasslantern.com

