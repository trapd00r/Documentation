From zsh-users-return-15623-mason-zsh=primenet.com.au@zsh.org Mon Dec 06 16:22:15 2010
Return-Path: <zsh-users-return-15623-mason-zsh=primenet.com.au@zsh.org>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 21380 invoked by alias); 6 Dec 2010 16:22:15 -0000
Mailing-List: contact zsh-users-help@zsh.org; run by ezmlm
Precedence: bulk
X-No-Archive: yes
List-Id: Zsh Users List <zsh-users.zsh.org>
List-Post: <mailto:zsh-users@zsh.org>
List-Help: <mailto:zsh-users-help@zsh.org>
Delivered-To: mailing list zsh-users@zsh.org
X-Seq: 15623
Received: (qmail 26195 invoked from network); 6 Dec 2010 16:22:05 -0000
X-Spam-Checker-Version: SpamAssassin 3.3.1 (2010-03-16) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-1.9 required=5.0 tests=BAYES_00,RCVD_IN_DNSWL_NONE
	autolearn=ham version=3.3.1
Received-SPF: none (ns1.primenet.com.au: domain at closedmail.com does not designate permitted sender hosts)
From: Bart Schaefer <schaefer@brasslantern.com>
Message-id: <101206082142.ZM2316@torch.brasslantern.com>
Date: Mon, 06 Dec 2010 08:21:42 -0800
In-reply-to: <20101206112436.GN1727@prunille.vinc17.org>
Comments: In reply to Vincent Lefevre <vincent@vinc17.net>
 "Re: exit status problem" (Dec  6, 12:24pm)
References: <20101203152438.GL1727@prunille.vinc17.org>
	<20101203160916.42e78913@pwslap01u.europe.root.pri>
	<20101204010313.GM1727@prunille.vinc17.org>
	<101204113617.ZM6156@torch.brasslantern.com>
	<20101206112436.GN1727@prunille.vinc17.org>
X-Mailer: OpenZMail Classic (0.9.2 24April2005)
To: zsh-users@zsh.org
Subject: Re: exit status problem
MIME-version: 1.0
Content-type: text/plain; charset=us-ascii

On Dec 6, 12:24pm, Vincent Lefevre wrote:
}
} > The status you're displaying is $? stored in psvar[1], correct?  And
} > that's set by precmd, and you're explicitly calling precmd
} > 
} > If I use %? instead, I get consistent behavior
} 
} What I don't understand is that if the problem is due to the precmd
} call from TRAPCLD, then why do I get
} 
} ypig:~[1]>                                                    <12:15:32
} [1]  + done       sleep 5
} ypig:~[1]>                                                    <12:15:35

It results from the timing of the trap handling.  The prompt is
reprinted because of the "[1]  + done" output before the CLD trap is
called; zsh does its internal signal handling before user traps.

Then on window resize the prompt is recomputed a second time, but this
time it's after your trap handler has run precmd.

} and why do I get "ypig:~[0]>" only after a window resize *and*
} typing [Enter].

If I poke something into RPS1 in a trap handler and then resize the
window, I see the change from the trap as soon as the window is
resized, not later after typing Enter.  But my xterm sends a stream
of SIGWINCH at the process underneath, it doesn't wait until I stop
resizing and then send the signal once.  Might that matter?

} If I do not resize the window, the prompt is not changed.

There is something confusing about the screen shots you first sent.
If those are in fact consecutive shots of the same terminal session,
as they appear to be, then it also appears that your prompt was

ypig:~[1]> 

at 15:59:59 *after* the screen resize, and then was *overwritten* at
16:00:03 by

ypig:~[0]> 

after which at 16:00:37 the prompt with [1] returns.  My question is,
what happened between 15:59:59 and 16:00:03 that caused the prompt to be
"updated in place"?  If all you did was hit Enter, the new prompt should
have appeared *below* the old one, not on top of it.

