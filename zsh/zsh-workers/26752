From zsh-workers-return-26752-mason-zsh=primenet.com.au@sunsite.dk Wed Mar 18 19:36:52 2009
Return-Path: <zsh-workers-return-26752-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 20465 invoked from network); 18 Mar 2009 19:36:40 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 18 Mar 2009 19:36:40 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 13841 invoked from network); 18 Mar 2009 19:36:32 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 18 Mar 2009 19:36:32 -0000
Received: (qmail 4495 invoked by alias); 18 Mar 2009 19:36:24 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 26752
Received: (qmail 4481 invoked from network); 18 Mar 2009 19:36:23 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 18 Mar 2009 19:36:23 -0000
Received: from mtaout02-winn.ispmail.ntl.com (mtaout02-winn.ispmail.ntl.com [81.103.221.48])
	by bifrost.dotsrc.org (Postfix) with ESMTP id 80092801E289
	for <zsh-workers@sunsite.dk>; Wed, 18 Mar 2009 20:36:20 +0100 (CET)
Received: from aamtaout01-winn.ispmail.ntl.com ([81.103.221.35])
          by mtaout02-winn.ispmail.ntl.com
          (InterMail vM.7.08.04.00 201-2186-134-20080326) with ESMTP
          id <20090318193619.UCPX4080.mtaout02-winn.ispmail.ntl.com@aamtaout01-winn.ispmail.ntl.com>
          for <zsh-workers@sunsite.dk>; Wed, 18 Mar 2009 19:36:19 +0000
Received: from pws-pc ([81.107.42.185]) by aamtaout01-winn.ispmail.ntl.com
          (InterMail vG.2.02.00.01 201-2161-120-102-20060912) with ESMTP
          id <20090318193619.ZCF13254.aamtaout01-winn.ispmail.ntl.com@pws-pc>
          for <zsh-workers@sunsite.dk>; Wed, 18 Mar 2009 19:36:19 +0000
Date: Wed, 18 Mar 2009 19:36:17 +0000
From: Peter Stephenson <p.w.stephenson@ntlworld.com>
To: zsh-workers@sunsite.dk
Subject: Re: Modifiers, command position, and so forth (Re: Bug#519535:
 history expansion: modifier completion missing)
Message-ID: <20090318193617.42747a6a@pws-pc>
In-Reply-To: <090317114606.ZM17772@torch.brasslantern.com>
References: <20090313105555.GA19025@piper.oerlikon.madduck.net>
	<20090315062253.GB14010@scru.org>
	<20090316181852.27e9420d@news01>
	<090316194434.ZM16487@torch.brasslantern.com>
	<20090317095717.02bedf7e@news01>
	<090317114606.ZM17772@torch.brasslantern.com>
X-Mailer: Claws Mail 3.7.0 (GTK+ 2.14.7; x86_64-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
X-Cloudmark-Analysis: v=1.0 c=1 a=PWqA-1TshY8A:10 a=_zpOwxrPnZYA:10 a=q2GGsy2AAAAA:8 a=NLZqzBF-AAAA:8 a=wNmx7KnxvhJoSnwwjmAA:9 a=yIY4BgB14YzDwW9AcP0A:7 a=STx7yRqgGtBruRN1OdtfLP-xb7EA:4 a=LY0hPdMaydYA:10 a=I6wTmPyJxzYA:10 a=_dQi-Dcv4p4A:10
X-Virus-Scanned: ClamAV 0.92.1/9131/Wed Mar 18 19:19:56 2009 on bifrost
X-Virus-Status: Clean

On Tue, 17 Mar 2009 11:46:05 -0700
Bart Schaefer <schaefer@brasslantern.com> wrote:
> I guess I'm a little skeptical of the utility of this new option in
> general.  All the other modifiers do something "inside" the history
> string, which would otherwise be difficult to do -- change case,
> truncate, substitute, etc.  This one is just prepending something in
> a way that can already easily be done with $PWD/!$ (for example).

If anything, the boot's on the other foot.  Most of the other modifiers
do simple string handling: find a fixed character, strip something off
in front or behind.  This one rationalises internal components and
possibly resolves symbolic links.

> Here's another case where some intelligence could be applied:
> 
> schaefer<549> cd Src/Zle
> schaefer<550> echo ../b*
> ../builtin.c
> schaefer<551> echo !$:a
> echo /usr/local/src/zsh/zsh-4.0/Src//b*
> /usr/local/src/zsh/zsh-4.0/Src//builtin.c
> 
> Double slash?

That's a bug.

The Meta handling didn't seem to be consistent, either.  I presume the
functions should be both taking and returning metafied strings.

I see it uses realpath() for normalising symbolic links.  I'm not sure
how standard that is (or rather used to be), and the Linux manual warns
about possible size problems.  We should probably use an improved
version of zgetdir(), which could also benefit from having PATH_MAX
removed.  However, zgetdir() is completely undocumented, so that's for
later.

Index: Src/hist.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/hist.c,v
retrieving revision 1.90
diff -u -r1.90 hist.c
--- Src/hist.c	15 Mar 2009 01:17:06 -0000	1.90
+++ Src/hist.c	18 Mar 2009 19:34:27 -0000
@@ -1507,7 +1507,7 @@
 	return 1;
 
     if (**junkptr != '/') {
-	*junkptr = zhtricat(zgetcwd(), "/", *junkptr);
+	*junkptr = zhtricat(metafy(zgetcwd(), -1, META_HEAPDUP), "/", *junkptr);
     }
 
     current = *junkptr;
@@ -1556,6 +1556,8 @@
 		    if (dest[-1] != '/')
 			dest--;
 		    current += 2;
+		    if (*current == '/')
+			current++;
 		} else if (dest == *junkptr + 1) {
 		    /* This might break with Cygwin's leading double slashes? */
 		    current += 2;
@@ -1567,7 +1569,7 @@
 	} else {
 	    while (*current != '/' && *current != '\0')
 		if ((*dest++ = *current++) == Meta)
-		    dest[-1] = *current++ ^ 32;
+		    *dest++ = *current++;
 	}
     }
     return 1;
@@ -1593,6 +1595,8 @@
     if (**junkptr != '/')
 	return 0;
 
+    unmetafy(*junkptr, NULL);
+
     lastpos = strend(*junkptr);
     nonreal = lastpos + 1;
 
@@ -1618,7 +1622,7 @@
 	str++;
     }
 
-    *junkptr = bicat(real, nonreal);
+    *junkptr = metafy(bicat(real, nonreal), -1, META_HEAPDUP);
 
     return 1;
 }


-- 
Peter Stephenson <p.w.stephenson@ntlworld.com>
Web page now at http://homepage.ntlworld.com/p.w.stephenson/

