From zsh-workers-return-16228-mason-zsh=primenet.com.au@sunsite.dk Fri Nov 09 16:45:27 2001
Return-Path: <zsh-workers-return-16228-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 11981 invoked from network); 9 Nov 2001 16:45:26 -0000
Received: from ns2.primenet.com.au (HELO primenet.com.au) (?/0g/ZH7yM/S0jc07xPJYSZNt08HA8boJ?@203.24.36.3)
  by ns1.primenet.com.au with SMTP; 9 Nov 2001 16:45:26 -0000
Received: (qmail 1427 invoked from network); 9 Nov 2001 16:45:25 -0000
Received: from sunsite.dk (130.225.247.90)
  by proxy.melb.primenet.com.au with SMTP; 9 Nov 2001 16:45:24 -0000
Received: (qmail 28737 invoked by alias); 9 Nov 2001 16:45:17 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 16228
Received: (qmail 28724 invoked from network); 9 Nov 2001 16:45:16 -0000
X-VirusChecked: Checked
X-Authentication-Warning: iris.logica.co.uk: Host kiddleo@rambo.logica.co.uk [158.234.33.58] claimed to be yahoo.co.uk
Sender: kiddleo@iris.logica.co.uk
Message-ID: <3BEC04E4.91BE18D1@yahoo.co.uk>
Date: Fri, 09 Nov 2001 16:31:32 +0000
From: Oliver Kiddle <okiddle@yahoo.co.uk>
X-Mailer: Mozilla 4.77 [en] (X11; U; Linux 2.2.15 i686)
X-Accept-Language: en
MIME-Version: 1.0
To: zsh-workers@sunsite.dk
Subject: printf again
Content-Type: text/plain; charset=us-ascii
Content-Transfer-Encoding: 7bit

This patch to printf just allows widths and precisions to be used with
%b and I'm only posting it now to get it out of my way. I've also
documented -r. Is there any reason why it shouldn't be possible to use
print -o in combination with -s/-z. Allowing it is a simple cut and
paste so I've changed it here.

It is doing my head in to try to work out how to do the memory
management for using sprintf so that print -f can work with -s/-z.
Formats like `%#010000000x' don't make it easy. The easy way would be
to use open_memstream but it is a glibc extension. I could check for it
with configure and otherwise use a temporary file. print -s and -z with
-f are probably not going to be used much anyway. Any views on that?

Oliver

Index: Doc/Zsh/builtins.yo
===================================================================
RCS file: /cvsroot/zsh/zsh/Doc/Zsh/builtins.yo,v
retrieving revision 1.41
diff -u -r1.41 builtins.yo
--- Doc/Zsh/builtins.yo	2001/11/06 15:07:00	1.41
+++ Doc/Zsh/builtins.yo	2001/11/09 16:23:10
@@ -745,9 +745,10 @@
 to future change.
 
 If arguments remain unused after formatting, the format string is reused
-until all arguments have been consumed. If more arguments are required by
-the format than have been specified, the behaviour is as if zero or an
-empty string had been specified as the argument.
+until all arguments have been consumed. With the tt(print) builtin, this
+can be suppressed by using the tt(-r) option. If more arguments are
+required by the format than have been specified, the behaviour is as if
+zero or an empty string had been specified as the argument.
 )
 findex(pushd)
 pindex(PUSHD_TO_HOME, use of)
Index: Src/builtin.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/builtin.c,v
retrieving revision 1.61
diff -u -r1.61 builtin.c
--- Src/builtin.c	2001/10/23 11:22:34	1.61
+++ Src/builtin.c	2001/11/09 16:23:10
@@ -2970,6 +2970,25 @@
 	}
     }
 
+    /* -o and -O -- sort the arguments */
+    if (ops['o']) {
+	if (fmt && !*args) return 0;
+	if (ops['i'])
+	    qsort(args, arrlen(args), sizeof(char *), cstrpcmp);
+	else
+	    qsort(args, arrlen(args), sizeof(char *), strpcmp);
+    } else if (ops['O']) {
+	if (fmt && !*args) return 0;
+	if (ops['i'])
+	    qsort(args, arrlen(args), sizeof(char *), invcstrpcmp);
+	else
+	    qsort(args, arrlen(args), sizeof(char *), invstrpcmp);
+    }
+    /* after sorting arguments, recalculate lengths */
+    if(ops['o'] || ops['O'])
+	for(n = 0; n < argc; n++)
+	    len[n] = strlen(args[n]);
+
     /* -z option -- push the arguments onto the editing buffer stack */
     if (ops['z']) {
 	queue_signals();
@@ -3028,25 +3047,6 @@
 	}
     }
 
-    /* -o and -O -- sort the arguments */
-    if (ops['o']) {
-	if (fmt && !*args) return 0;
-	if (ops['i'])
-	    qsort(args, arrlen(args), sizeof(char *), cstrpcmp);
-	else
-	    qsort(args, arrlen(args), sizeof(char *), strpcmp);
-    } else if (ops['O']) {
-	if (fmt && !*args) return 0;
-	if (ops['i'])
-	    qsort(args, arrlen(args), sizeof(char *), invcstrpcmp);
-	else
-	    qsort(args, arrlen(args), sizeof(char *), invstrpcmp);
-    }
-    /* after sorting arguments, recalculate lengths */
-    if(ops['o'] || ops['O'])
-	for(n = 0; n < argc; n++)
-	    len[n] = strlen(args[n]);
-
     /* -c -- output in columns */
     if (ops['c']) {
 	int l, nc, nr, sc, n, t, i;
@@ -3230,7 +3230,15 @@
 		if (curarg) {
 		    int l;
 		    char *b = getkeystring(curarg, &l, ops['b'] ? 2 : 0, &nnl);
+		    /* handle width/precision here and use fwrite so that
+		     * nul characters can be output */
+		    if (prec >= 0 && prec < l) l = prec;
+		    if (width > 0 && flags[2]) width = -width;
+		    if (width > 0 && l < width)
+		    	printf("%*c", width - l, ' ');
 		    fwrite(b, l, 1, fout);
+		    if (width < 0 && l < -width)
+		    	printf("%*c", -width - l, ' ');
 		    count += l;
 		}
 		break;

_____________________________________________________________________
This message has been checked for all known viruses by the 
MessageLabs Virus Scanning Service. For further information visit
http://www.messagelabs.com/stats.asp

