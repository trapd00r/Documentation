From zsh-users-return-6728-mason-zsh=primenet.com.au@sunsite.dk Wed Oct 22 06:39:24 2003
Return-Path: <zsh-users-return-6728-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 12354 invoked from network); 22 Oct 2003 06:39:23 -0000
Received: from sunsite.dk (130.225.247.90)
  by ns1.primenet.com.au with SMTP; 22 Oct 2003 06:39:23 -0000
Received: (qmail 10896 invoked by alias); 22 Oct 2003 06:39:06 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 6728
Received: (qmail 10820 invoked from network); 22 Oct 2003 06:39:06 -0000
Received: from localhost (HELO sunsite.dk) (127.0.0.1)
  by localhost with SMTP; 22 Oct 2003 06:39:06 -0000
X-MessageWall-Score: 0 (sunsite.dk)
Received: from [4.3.58.249] by sunsite.dk (MessageWall 1.0.8) with SMTP; 22 Oct 2003 6:39:5 -0000
Received: (from schaefer@localhost)
	by candle.brasslantern.com (8.11.6/8.11.6) id h9M6d4A04450
	for zsh-users@sunsite.dk; Tue, 21 Oct 2003 23:39:04 -0700
From: Bart Schaefer <schaefer@brasslantern.com>
Message-Id: <1031022063903.ZM4449@candle.brasslantern.com>
Date: Wed, 22 Oct 2003 06:39:03 +0000
In-Reply-To: <20031014062933.GC13457@lorien.emufarm.org>
Comments: In reply to Danek Duvall <duvall@emufarm.org>
        "need for a fancier _pick_variant?" (Oct 13, 11:29pm)
References: <20031014062933.GC13457@lorien.emufarm.org>
X-Mailer: Z-Mail (5.0.0 30July97)
To: zsh-users@sunsite.dk
Subject: Re: need for a fancier _pick_variant?
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii

[ I've been busy and then away, so catching up on some old stuff. ]

On Oct 13, 11:29pm, Danek Duvall wrote:
}
} _diff_options calls
} 
}     _pick_variant -c diff 'gnu=GNU' unix -v
} 
} which doesn't match anything for Solaris diff, so the generic unix diff
} options are chosen, and the result is thrown by the -u.
}
} Unfortunately, I don't know of any way of distinguishing Solaris diff by
} its output, short of a brittle check of its usage statement.

I don't have access to a Solaris machine.  Does `diff -v` produce the
usage message?  If so, I suggest that you use the "brittle" test just
to decide whether certain options (such as -u) are available, and then
apply a different test to differentiate further.  E.g. (I'm shooting
in the dark here, please edit as necessary):

    local difftype
    _pick_variant -r difftype -c $cmd gnu=GNU extended=' -u ' unix -v
    if [[ $difftype == extended ]]; then
	_pick_variant -r difftype -c what \
	    solaris=SunOS extended $(whence $cmd)
    fi
    case $difftype in
    gnu)
    	# The stuff now in the "if" part of _diff_options
	;;
    solaris)
    	# Your new section for solaris diff
	;;
    extended)
    	# The current "else" part of _diff_options, with -u added
	;;
    *)
    	# The current "else" part of _diff_options
	;;
    esac

You could enhance this a little by adding "solaris=SunOS" to the first 
of those two calls to _pick_variant, which allows the user to set the
"command" style in ":completion:*:diff:*:variant" context to something
that immediately returns "SunOS", thereby avoiding the second attempt.

} Hm.  In investigating all this, I noticed that all the completion
} directories end up duplicated in $fpath, which seems to be done in
} compaudit.  This seems to happen on 4.0.5 on Solaris, 4.1.1 on Solaris,
} and 4.1.1 on Linux, FWIW.

It *shouldn't* happen in compaudit; compaudit only tests things in the
fpath, it doesn't assign to it (except as a `local +h' parameter, which
should be reset when it goes out of scope).

