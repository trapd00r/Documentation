From zsh-workers-return-19976-mason-zsh=primenet.com.au@sunsite.dk Tue May 25 18:20:30 2004
Return-Path: <zsh-workers-return-19976-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 20419 invoked from network); 25 May 2004 18:20:30 -0000
Received: from thor.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.86)
  by ns1.primenet.com.au with SMTP; 25 May 2004 18:20:30 -0000
Received: (qmail 10532 invoked from network); 25 May 2004 18:20:12 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 25 May 2004 18:20:12 -0000
Received: (qmail 24703 invoked by alias); 25 May 2004 18:20:10 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 19976
Received: (qmail 24694 invoked from network); 25 May 2004 18:20:09 -0000
Received: from thor.dotsrc.org (HELO a.mx.sunsite.dk) (qmailr@130.225.247.86)
  by sunsite.dk with SMTP; 25 May 2004 18:20:06 -0000
Received: (qmail 10426 invoked from network); 25 May 2004 18:20:06 -0000
Received: from lhuumrelay3.lnd.ops.eu.uu.net (62.189.58.19)
  by a.mx.sunsite.dk with SMTP; 25 May 2004 18:20:04 -0000
Received: from MAILSWEEPER01.csr.com (mailhost1.csr.com [62.189.183.235])
	by lhuumrelay3.lnd.ops.eu.uu.net (8.11.0/8.11.0) with ESMTP id i4PIJXv25371
	for <zsh-workers@sunsite.dk>; Tue, 25 May 2004 18:19:34 GMT
Received: from EXCHANGE02.csr.com (unverified [192.168.137.45]) by MAILSWEEPER01.csr.com
 (Content Technologies SMTPRS 4.3.12) with ESMTP id <T69ca02a9f8c0a88d019fc@MAILSWEEPER01.csr.com>;
 Tue, 25 May 2004 19:18:58 +0100
Received: from news01.csr.com ([192.168.143.38]) by EXCHANGE02.csr.com with Microsoft SMTPSVC(5.0.2195.6713);
	 Tue, 25 May 2004 19:21:44 +0100
Received: from news01.csr.com (localhost.localdomain [127.0.0.1])
	by news01.csr.com (Postfix) with ESMTP
	id 854AF6E0205; Tue, 25 May 2004 19:19:32 +0100 (BST)
Received: from csr.com (pws@localhost)
	by news01.csr.com (8.12.10/8.12.10/Submit) with ESMTP id i4PIJOTL007015;
	Tue, 25 May 2004 19:19:32 +0100
Message-Id: <200405251819.i4PIJOTL007015@news01.csr.com>
X-Authentication-Warning: news01.csr.com: pws owned process doing -bs
To: Nicolas Cavigneaux <bounga@altern.org>,
   zsh-workers@sunsite.dk (Zsh hackers list)
Subject: Re: Job table full 
In-reply-to: "Wayne Davison"'s message of "Tue, 25 May 2004 10:56:05 PDT."
             <20040525175605.GD7832@blorf.net> 
Date: Tue, 25 May 2004 19:19:24 +0100
From: Peter Stephenson <pws@csr.com>
X-OriginalArrivalTime: 25 May 2004 18:21:44.0680 (UTC) FILETIME=[224D6E80:01C44285]
X-Spam-Checker-Version: SpamAssassin 2.63 on a.mx.sunsite.dk
X-Spam-Level: 
X-Spam-Status: No, hits=0.0 required=6.0 tests=BAYES_50 autolearn=no 
	version=2.63
X-Spam-Hits: 0.0

Wayne Davison wrote:
> On Wed, May 12, 2004 at 02:40:29PM +0100, Peter Stephenson wrote:
> > A reliable way of reproducing it would help.
> 
> It's pretty easy:
> 
>     zsh -f
>     preexec() { x=`echo hi` }
>     sleep 1 &
>     :              [execute any 20 commands]
> 
> The problem appears to be that, after the job-control run, the value of
> "thisjob" in the preexec() function becomes -1.  This comparison then
> fails due to a signed/unsigned mismatch:
> 
>     if (thisjob >= jobtabsize - 1 && !expandjobtab()) {

Aha.  That's good.

thisjob is allowed to be -1, it simply means there's no valid
current job.  So the-test-that-no-one-understands should simply have
`thisjob != -1' in it, as in other places in the code.

Here is a fix with some other paranoid tests for thisjob when debugging
is turned on.

Index: Src/exec.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/exec.c,v
retrieving revision 1.62
diff -u -r1.62 exec.c
--- Src/exec.c	21 May 2004 11:19:30 -0000	1.62
+++ Src/exec.c	25 May 2004 18:18:06 -0000
@@ -219,7 +219,7 @@
     /*
      * Is anybody willing to explain this test?
      */
-    if (thisjob >= jobtabsize - 1 && !expandjobtab()) {
+    if (thisjob != -1 && thisjob >= jobtabsize - 1 && !expandjobtab()) {
 	zerr("job table full", NULL, 0);
 	return -1;
     }
Index: Src/jobs.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/jobs.c,v
retrieving revision 1.28
diff -u -r1.28 jobs.c
--- Src/jobs.c	2 May 2004 19:55:58 -0000	1.28
+++ Src/jobs.c	25 May 2004 18:18:07 -0000
@@ -904,6 +904,7 @@
     Process pn, *pnlist;
     struct timezone dummy_tz;
 
+    DPUTS(thisjob == -1, "No valid job in addproc.");
     pn = (Process) zshcalloc(sizeof *pn);
     pn->pid = pid;
     if (text)
@@ -1035,6 +1036,7 @@
 waitjobs(void)
 {
     Job jn = jobtab + thisjob;
+    DPUTS(thisjob == -1, "No valid job in waitjobs.");
 
     if (jn->procs || jn->auxprocs)
 	zwaitjob(thisjob, 0);
@@ -1129,6 +1131,7 @@
 {
     Process pn;
 
+    DPUTS(thisjob == -1, "No valid job in spawnjob.");
     /* if we are not in a subshell */
     if (!subsh) {
 	if (curjob == -1 || !(jobtab[curjob].stat & STAT_STOPPED)) {

-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR Ltd., Science Park, Milton Road,
Cambridge, CB4 0WH, UK                          Tel: +44 (0)1223 692070


**********************************************************************
This email and any files transmitted with it are confidential and
intended solely for the use of the individual or entity to whom they
are addressed. If you have received this email in error please notify
the system manager.

This footnote also confirms that this email message has been swept by
MIMEsweeper for the presence of computer viruses.

www.mimesweeper.com
**********************************************************************

