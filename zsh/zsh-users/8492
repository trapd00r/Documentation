From zsh-users-return-8492-mason-zsh=primenet.com.au@sunsite.dk Mon Feb 14 15:57:09 2005
Return-Path: <zsh-users-return-8492-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 531 invoked from network); 14 Feb 2005 15:57:07 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 14 Feb 2005 15:57:07 -0000
Received: (qmail 44084 invoked from network); 14 Feb 2005 15:57:01 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 14 Feb 2005 15:57:01 -0000
Received: (qmail 13497 invoked by alias); 14 Feb 2005 15:56:44 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 8492
Received: (qmail 13479 invoked from network); 14 Feb 2005 15:56:43 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 14 Feb 2005 15:56:43 -0000
Received: (qmail 43015 invoked from network); 14 Feb 2005 15:56:40 -0000
Received: from vinc17.net4.nerim.net (HELO ay.vinc17.org) (62.212.121.106)
  by a.mx.sunsite.dk with SMTP; 14 Feb 2005 15:56:32 -0000
Received: from lefevre by ay.vinc17.org with local (Exim 4.34)
	id 1D0iaM-0001zs-Vn; Mon, 14 Feb 2005 16:56:31 +0100
Date: Mon, 14 Feb 2005 16:56:30 +0100
From: Vincent Lefevre <vincent@vinc17.org>
To: zsh-users@sunsite.dk
Subject: Re: History corruption (over NFS)
Message-ID: <20050214155630.GB6395@ay.vinc17.org>
Mail-Followup-To: zsh-users@sunsite.dk
References: <20050210165417.GG30487@ay.vinc17.org> <1050210184111.ZM22490@candle.brasslantern.com>
Mime-Version: 1.0
Content-Type: text/plain; charset=iso-8859-1
Content-Disposition: inline
Content-Transfer-Encoding: 8bit
In-Reply-To: <1050210184111.ZM22490@candle.brasslantern.com>
X-Mailer-Info: http://www.vinc17.org/mutt/
User-Agent: Mutt/1.5.7-vl-20050209i
X-Spam-Checker-Version: SpamAssassin 3.0.2 on a.mx.sunsite.dk
X-Spam-Level: 
X-Spam-Status: No, score=-2.4 required=6.0 tests=AWL,BAYES_00 autolearn=ham 
	version=3.0.2
X-Spam-Hits: -2.4

On 2005-02-10 18:41:11 +0000, Bart Schaefer wrote:
> One thing to check is whether the file on the NFS server actually does
> contain those nul bytes, or if it's only the NFS client that sees them.
> I vaguely recall that you may need to explicitly specify "noac" in the
> NFS mount options, but it's been quite some time since I encountered
> this particular problem.

The "noac" didn't change anything (except making command execution
slower).

Here's what my corrupted .zhistory file looked like:

[...]
: 1108388462:0;ssh priam
^@^@^@^@^@^@^@^@[...]^@^@: 1108388476:0;t3-exec ulysse 0 -c=3 -l=3 [...]
: 1108390243:0;lt results.*
: 1108390256:0;head old-xtp/results.ctp.-3.54.1
: 1108390282:0;t3-secstep -f=ctp -e=-3 -m=54 -i=40 -n=44 --imax=7935
: 1108390290:0;screen -h 6000 -t server 1 zsh -c "./t3-server -v
+results.ctp.-3.54 2> server.out"
: 1108390309:0;ssh priam
[...]

If I've understood correctly, the first "ssh priam" started a zsh that
truncated the history file (since its size was above the limit). Note
that I quit this shell immediately. Then the current zsh instances
went on writing to the history file without noticing that it had been
truncated, hence the null bytes. The corrupt history was detected when
I started the second "ssh priam".

-- 
Vincent Lefèvre <vincent@vinc17.org> - Web: <http://www.vinc17.org/>
100% accessible validated (X)HTML - Blog: <http://www.vinc17.org/blog/>
Work: CR INRIA - computer arithmetic / SPACES project at LORIA

