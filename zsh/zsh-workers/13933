From zsh-workers-return-13933-mason-zsh=primenet.com.au@sunsite.dk Mon Apr 09 20:03:59 2001
Return-Path: <zsh-workers-return-13933-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 28311 invoked from network); 9 Apr 2001 20:03:58 -0000
Received: from sunsite.dk (130.225.51.30)
  by ns1.primenet.com.au with SMTP; 9 Apr 2001 20:03:58 -0000
Received: (qmail 2412 invoked by alias); 9 Apr 2001 20:03:53 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 13933
Received: (qmail 2396 invoked from network); 9 Apr 2001 20:03:51 -0000
Date: Mon, 9 Apr 2001 13:03:46 -0700 (PDT)
From: Wayne Davison <wayned@users.sourceforge.net>
To: Zsh Workers <zsh-workers@sunsite.auc.dk>
Subject: PATCH: preexec sometimes gets wrong command
Message-ID: <Pine.LNX.4.30.0104091157140.28864-200000@phong.blorf.net>
MIME-Version: 1.0
Content-Type: MULTIPART/MIXED; BOUNDARY="-1463796991-870265595-986846626=:28864"

  This message is in MIME format.  The first part should be readable text,
  while the remaining parts are likely unreadable without MIME-aware tools.
  Send mail to mime@docserver.cac.washington.edu for more info.

---1463796991-870265595-986846626=:28864
Content-Type: TEXT/PLAIN; charset=US-ASCII

I just noticed that preexec gets passed the wrong command when the
current command is discarded from the history (as is often the case
when the user is ignoring functions, history commands, and/or lines
that start with a space).  In this case, preexec got passed the
previous command from the history buffer.  I couldn't think of any
other way to grab the actual text that the user typed, so I decided to
set the first parameter to an empty string when this happens.  Perhaps
a better solution would be to pass the current (expanded) command
string?

Speaking of expanded commands, I was really hoping to have access to
the alias-expanded command string for my preexec processing, so I also
decided to pass this information to the preexec function as the second
parameter.  It would be very easy to tweak my patch to supply this
value as both parameters (instead of the empty string in the first)
when we don't have the history text for the first argument.

The following patch implements these two changes and tweaks the doc.

Let me know what you think.  If people approve, I'll be glad to check
the changes into CVS.

..wayne..

---1463796991-870265595-986846626=:28864
Content-Type: TEXT/PLAIN; charset=US-ASCII; name="preexec.patch"
Content-Transfer-Encoding: BASE64
Content-ID: <Pine.LNX.4.30.0104091303460.28864@phong.blorf.net>
Content-Description: preexec changes
Content-Disposition: attachment; filename="preexec.patch"

SW5kZXg6IERvYy9ac2gvZnVuYy55bw0KQEAgLTE3Miw4ICsxNzIsMTEgQEAN
CiBmaW5kZXgocHJlZXhlYykNCiBpdGVtKHR0KHByZWV4ZWMpKSgNCiBFeGVj
dXRlZCBqdXN0IGFmdGVyIGEgY29tbWFuZCBoYXMgYmVlbiByZWFkIGFuZCBp
cyBhYm91dCB0byBiZQ0KLWV4ZWN1dGVkLiAgSWYgdGhlIGhpc3RvcnkgbWVj
aGFuaXNtIGlzIGFjdGl2ZSwgdGhlIHN0cmluZyB0byBiZQ0KLWV4ZWN1dGVk
IGlzIHBhc3NlZCBhcyBhbiBhcmd1bWVudC4NCitleGVjdXRlZC4gIElmIHRo
ZSBoaXN0b3J5IG1lY2hhbmlzbSBpcyBhY3RpdmUgKGFuZCB0aGUgbGluZSB3
YXMgbm90DQorZGlzY2FyZGVkIGZyb20gdGhlIGhpc3RvcnkgYnVmZmVyKSwg
dGhlIHN0cmluZyB0aGF0IHRoZSB1c2VyIHR5cGVkIGlzDQorcGFzc2VkIGFz
IHRoZSBmaXJzdCBhcmd1bWVudCwgb3RoZXJ3aXNlIGl0IGlzIGFuIGVtcHR5
IHN0cmluZy4gIFRoZQ0KK2FjdHVhbCBjb21tYW5kIHRoYXQgd2lsbCBiZSBl
eGVjdXRlZCAoaW5jbHVkaW5nIGV4cGFuZGVkIGFsaWFzZXMpIGlzDQorcGFz
c2VkIGFzIHRoZSBzZWNvbmQgYXJndW1lbnQgKGFuZCBpcyBhbHdheXMgcHJl
c2VudCkuDQogKQ0KIGl0ZW0odHQoVFJBUCl2YXIoTkFMKSkoDQogY2luZGV4
KHNpZ25hbHMsIHRyYXBwaW5nKQ0KSW5kZXg6IFNyYy9pbml0LmMNCkBAIC0x
MzUsMTUgKzEzNSwyMiBAQA0KIAkgICAgaWYgKHRvcGxldmVsICYmIChwcmVw
cm9nID0gZ2V0c2hmdW5jKCJwcmVleGVjIikpICE9ICZkdW1teV9lcHJvZykg
ew0KIAkJTGlua0xpc3QgYXJnczsNCiAJCWludCBvc2MgPSBzZmNvbnRleHQ7
DQorCQljaGFyICpjbWRzdHIgPSBnZXRwZXJtdGV4dChwcm9nLCBOVUxMKTsN
CiANCiAJCWFyZ3MgPSB6bmV3bGlua2xpc3QoKTsNCiAJCXphZGRsaW5rbm9k
ZShhcmdzLCAicHJlZXhlYyIpOw0KLQkJaWYgKGhpc3RfcmluZykNCisJCS8q
IElmIGN1cmxpbmUgZ290IGR1bXBlZCBmcm9tIHRoZSBoaXN0b3J5LCB3ZSBk
b24ndCBrbm93DQorCQkgKiB3aGF0IHRoZSB1c2VyIHR5cGVkLiAqLw0KKwkJ
aWYgKGhpc3RfcmluZyAmJiBjdXJsaW5lLmhpc3RudW0gPT0gY3VyaGlzdCkN
CiAJCSAgICB6YWRkbGlua25vZGUoYXJncywgaGlzdF9yaW5nLT50ZXh0KTsN
CisJCWVsc2UNCisJCSAgICB6YWRkbGlua25vZGUoYXJncywgIiIpOw0KKwkJ
emFkZGxpbmtub2RlKGFyZ3MsIGNtZHN0cik7DQogDQogCQlzZmNvbnRleHQg
PSBTRkNfSE9PSzsNCiAJCWRvc2hmdW5jKCJwcmVleGVjIiwgcHJlcHJvZywg
YXJncywgMCwgMSk7DQogCQlzZmNvbnRleHQgPSBvc2M7DQorCQl6c2ZyZWUo
Y21kc3RyKTsNCiAJCWZyZWVsaW5rbGlzdChhcmdzLCAoRnJlZUZ1bmMpIE5V
TEwpOw0KIAkJZXJyZmxhZyA9IDA7DQogCSAgICB9DQo=
---1463796991-870265595-986846626=:28864--

