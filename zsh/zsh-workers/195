From zsh-workers-request@math.gatech.edu  Tue Jul 11 06:14:56 1995
Received: from gatech.edu (gatech.edu [130.207.244.244]) by werple.mira.net.au (8.6.12/8.6.9) with SMTP id GAA21656 for <mason@werple.mira.net.au>; Tue, 11 Jul 1995 06:14:52 +1000
Received: from math (math.skiles.gatech.edu) by gatech.edu with SMTP id AA26649
  (5.65c/Gatech-10.0-IDA for <mason@werple.mira.net.au>); Mon, 10 Jul 1995 16:15:12 -0400
Received: by math (5.x/SMI-SVR4)
	id AA24904; Mon, 10 Jul 1995 16:11:46 -0400
Resent-Date: Mon, 10 Jul 1995 21:12:39 +0100 (BST)
Old-Return-Path: <zefram@dcs.warwick.ac.uk>
From: Zefram <A.Main@dcs.warwick.ac.uk>
Message-Id: <19866.199507102012@stone.dcs.warwick.ac.uk>
Subject: Prompt code patch
To: zsh-workers@math.gatech.edu (Z Shell workers mailing list)
Date: Mon, 10 Jul 1995 21:12:39 +0100 (BST)
X-Loop: zefram@dcs.warwick.ac.uk
X-Stardate: [-31]5959.21
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
Resent-Message-Id: <"S4LDZ3.0.256.1cO0m"@math>
Resent-From: zsh-workers@math.gatech.edu
X-Mailing-List: <zsh-workers@math.gatech.edu> archive/latest/195
X-Loop: zsh-workers@math.gatech.edu
Precedence: list
Resent-Sender: zsh-workers-request@math.gatech.edu

-----BEGIN PGP SIGNED MESSAGE-----

Below is a large patch to the prompt expansion code.  It solves the
following problems:

o If the prompt changes while ZLE is active, e.g. if a completion on ~
  involving a list being output causes a path in the prompt to be
  abbreviated, then the prompt does not actually change on the screen
  until a redisplay is done, but its new length is used immediately.
  This is solved by not recalculating the prompt in such
  circumstances.

o The prompt is truncated to 256 characters.  After the patch, memory
  for the prompt is dynamically allocated, also removing the necessity
  for the kludgy three rotated fixed-length buffers.

o Prompts an exact multiple of the screen width, or one less, in length
  get an extra space added, which ZLE displays, but ZLE thinks the
  prompt doesn't go that far onto the screen.  The code to do this was
  also invoking undefined behaviour a little.

o In some cases of the prompt format string ending unexpectedly, such
  as if it consists only of a single % character, the prompt expansion
  code walks off the end of the string and return garbage.

o Truncation of %~ doesn't work, big time.

In addition, it documents the %[ (truncation control) sequence.  Could
whoever designed that bit (it's rather good) please check that I got it
right -- I think I got down everything relevant from the source, but
I'm not certain.

(Is anyone still reading this?)  There are a couple of odd bits of code
in there that I'm not sure should be there.  Can someone explain why
these are in there, and whether we need them:

o A ! on its own is replaced by the history number.  Considering that
  %! already does this, is this necessary?  It's the only special
  sequence that doesn't start with a %, so it's an ugly exception.

o Another ugly exception is that a backslash will escape the next
  character.  As the only characters that need escaping are % (which
  can be escaped by doubling to %% anyway) and the aforementioned !
  (which IMHO shouldn't have that special behaviour), isn't it rather
  nasty to have \ special like this?  Or is this for PROMPT_SUBST --
  isn't there another solution for escaping $ characters?

o Prompts of a multiple of the screen width (other than 0), and one
  less, in length get spaces added to take them to one greater than a
  multiple of the screen width.  What's the point?

Finally: should %{/%} pairs nest?  I think they should, and it's pretty
easy to add.

 -zefram

begin 600 prompt-diffs.gz
M'XL(" Z  3   W!R;VUP="UD:69F<P#56_MOVT:V_EG]*\9>)'I1#BE9LF0W
M+?HPBNSF=H,TBP5N$J0T-;*)4"1!4E:=-OW;[W?./#B4*<>[]>UFA42FYGG.
M-^<U,X>#P4#\5$1/+C9Q4L7I4724)<O._V2I^.LF$8$O@MFI/ST-QB)8+*9?
MC$:C9O-&T_GI9'SJGZBF@^:'?HOCZ=CW\#457$2CF:(3@5^C+X3H"'SBE>AE
M>?FZ^Z+[MD^%G;"X%$]%OJGR(EOG50^_/?$XD:DG?OS'\^>>\/MGIO=J6\25
M5$VX1>")5;:IT&)HQG>&1UEG54CNH ;YB"_Z2V2@L'P=H-E 0Q6GH.*^0.G&
M.PV#X!08[(5I[ ?>V)_5(*F"'8C22N1Y!?XLW_AYL5DU8.I%5V$A!OTXO915
ME*,H 6RJGT$NJ)%3P(T]T?OGRV>OSM]]\_*'=^-WK_IJ9$]/6./(L*G*&KE.
MHJ@P<W\(DR2+>N/I3+599N)7BV:29?E]P51M=[&$R/G[L0R"L1<$)S66JF!N
ML6P#D\O*JFA J?Y,]L'G2AZZ&JQ8^,IJ*8M"P5;CAE9NUU6R*:]ZMFF3C!66
MK^PY2'H"WQX(S^O5 _H&UDT5)^5]<=6-;P-[?'P7L),3 'D\=J%519,:W,'E
M1I8E&.@^[=XEIZ7Z>Y=L:FR;HG@+WE:IW(,O%5L"5W%15B2Q=0\I\QY:&DP_
M)/+=.MQC),?ST['?A+5NOV,ECT_L$K0A.UDLO&/_N,95%4PMJH MZG7?%%VP
M?J7LFA#&;%9K*J%F81(6:_V;L*'/I4P5TF7/]@*=853%UQ(H!*:PD*6L4BF7
M<MDL!KB <1>6N(SN*VUU>[?MV#\=+TZG\_VPS(XGWFRJ81'B.HN77[!ZA,NE
M-C5+XOM7%XQBDT9DL5 ZXM(.J?H21> *??'06RIIH/9<\95PNVEA4!-4Z,65
MI)5#!8LU("R.#8-<->:I:JE3Y5S]I9U-?%T_CE3EJ?#K*4#?P$[^%"KU55<3
MV-E>Q8D4/709C?I0#1*0P7(XQ(P$NX)N9@3H#NB4E+1CI.K0!7I5YA&#U12]
M)FQ_"J!:Y6NJ*D/5GPUTJ\S.YM[L9%*K\NS$1X%="7");XR"F7J,NKL,-5.!
MQ7EPD0^'8&GI K_,HFR3*JT':>7%<-A.STD0>"<3W^@0_CT9P"94(A3*+!"T
MB!7$X E5'^!G6,617BRVNX.+Q,?W:HTOBB?.ZE;$P$411C+/RC,S/(^D^BM6
MM<571:MUG'K<<0#"<_VXU0^1XLGHKDL,:/%?PP6^]>@QJ!_'_ BY%PY !S2/
M7D.>" CZ5NNW>=^Z@ZVN.A"=0E:;(A6'AP9J'1;2Q[")QJ- *=E)< QL [.T
M_QZV>7!OA)E;",?#(OTPF'VHBN4F[QT>]C^-7:N<3B"G,VOKV1NOR4F#)#,B
M"[JAB<,*POBIU08\$E=0=G0]Y7B"H5*RA+7YV_-_?/_#N?CF^?G+5P="_/,J
MK,16BJL0GO!*%E*$^%]=(9@@I%>R*$]U9S$0+'4B3)<L<R),*EFD886FLMI*
M6)07/ZGJ%S\AG*[@IB^O!*Q'="7BTAG&EF$9EA*#@$,:9BESF2Y)7. CRUPF
M270EH_<H\,1A*1,958>>.P["^R/('DU52I'ELH#$9&D)TLH,<8)B!EY=5-O,
M,'349,@G.C8E7/XJ*T#]C99<(J,B>-9A&E[*4E098,I!H6"#Z-(!]U[(<-GK
M*YYHA,N"0JQ>&5^F80+3&^807J(74>R%C$+,V#Y"(4>H*XEND6>04Y LE(B!
MQBIK+H([!I5MXR3!^"+*TA4S!;F5,<8J1+;2.('&[%H6%%I6,JWA>**?5)Q:
M1TA?*YA.1:_'54^9A+XJ'Z.<?YZ9WJ08T&;!S1R;!->#]2@*"D=CY:Z,$!NU
M):WMP1ITW_A=MX%6/JV7K'J89L33C)126"5EC3AX*@IZ<'PO=7L$]<B2S3HM
M67&MXZ,1;15&#/I4K6?R/>N NJ+;Z'A +1X_5M;%VH9.H[G>("I[H" RED7Q
M0"!93K4MT84?E9&=C&$8K)%].,,P;%DP6GFUXU*6%K_5)M8T#E!B[<H?6-GA
M7BC^,RN.?K3FS?C#D0+]HT42/NX7B;V#$@5]BEA:969H!FX(SUXA:?,F\V#B
MS<<VZNE@>59)2.=)V+#@A^NC6*)@_'IGY#*9>OP!HK#&O#N$T"#<XYB$$3>K
M);Z"=(S]/I6S=,"&O6>>U-%5[3II0(HJ'W6=!:**>!E?QE5O,!RNUGV> A(_
M#WQO'NC-7QMWBV#F+<;65ZK@.H1MZ_[>/>6@M?)Y?YLNEW'1R[=ZO\.TH.J 
MW+!9'985 __O:EW-,01M%M)PC4'*UY7_]@C/LG^K!<9'(.^VLP'Y#B[JL*@F
M=PERB>,%@M1%L&B<=OTAALH<<5>U(BV>P'O^_JA\5!YZ8I<7CSNH$XH]3.SP
M2@/>F[76M9OYWF+F'(<NIE,4!/4!2CUF/=J5@J$N.$#!L*%;$,0SP5'.W_\F
M-CGY2H13%W$ETLWZ@MPH1XN=CL4&@>#AHR5@B3;%55SJS6H'XCVT&ZZ+W)0J
MJMI8"OQ@[@7^Y,0-WG8_=OL%"XNQJRSI4;C[F+X"WP:-[D<FB!(^.1ITS3A?
M]\,G/!=Y6Y7>T365O?NVJU6\-I-::]^\Z7)#$$P;UCXK?*=#.GMF.PS*DE5H
M0,9"%7]L(7YWTWS0RIYM10>&>]K0YT/)!U^V:2VN- )!0!@H=]XQ%':_9"5O
M^PS4P1V\U+X6]2;91/PL(;<;?]PKR[]JE7:WL=KR09*.(4GU<>)>$O[?).EV
MB]M+IG6?@P$2,5-REV#Q$K1(U6K-5PW6#BFIXI^W_:;UDUK*S,0?[9-C#W:D
M@<EUQ<'8_#O$@8,C(PYJJ#:1VXOKCJ P7(%#EQM/M8@0KYN#^$/@6P/7:<-0
M?<<K1#+PR+92QQS^V;\JU>WV<GX"*5],K .OXQUUYA6O)1^3X6^/T'$\3D6Q
M+P)4;#^I]C&W=2 %V"NN(?-.0<J08A0*6/"[6J_6%?UQ!F3,+C@@1/2EKMXZ
MT=4F>E\;?[56NVY!:>QBX@6![S=O5QZ&EUJ8Y]:YS7G'&A9P;$58W(C348\<
M6RO[)XN'9KE].1=T!S)>U,NI@X5+6;W#-K2@4*/7[^\7G@3"<Z"%9U!5-^C/
MH=9N]$$72&FTSGMU&_CP)TMY_00E\.1S['%J6:];00JFV/@T"N9]#;6VCHV9
M#GO]PSL(_EI+>S.62"B8Z"59>ME/PK*Z#I/[A!2-@1_I@:UU>M3=W_@O.XT)
M<+F)E\#Z:^H)CM%F?_]K1V</Z"JXEKSB4ML&H<3NU974<9283-59492M92E6
MV.#1'G$$+1MAB[?E.A30H8_N3[#&'V3&\2C=XXU9B+DK'730><0JR;:BDB6=
MN"RE""NJ<0:HLER=84A!EZ(>GW<$/ SV+E3\QA<7-Y7I2KN7(Z495K3"@A<@
M+Z_#HD^[%]JGP$;2.71?KPY7OJ8**/?;OO@2_/9WI6.GD0IW6(Q&.V)TEQ"=
M,_RW'$<IJRC,>Z^^^^[Y^3<OS_^N[P35=:./^""8'-?6YJ%4S=T\4!#TP*IV
M:R-1EKKLH_@W]>]!PO\'4MDF+>9^_-Y*?'?W!U5K=;5YET9\6MH?1J!;?4DP
MF:G[=.M+]&%"M%Z6N9,[0 <6O"GF"E!&T2M]C49GHO+5@07W-Y=^ZR5)8_F:
M.E1A])XVN6]-8*GS7IQ R0BB.'0\XL=ZJVL04'IY'(#LJ1,%_+EDFP"P&378
ML)F*69J>FI,KP\0>IMK79DI,SA;-L$W3^5)=]7SB;& I5^$FJ?;X.'VYN%JW
MRI@Z#U,QL1OH'G"<N\Q8KYWSI4_L\]L#G'J*QCD5HFC_;4M8353:,-HT-J2T
M\=0XSU.B,YU3=LZX&4#>#]6AJWW8IBA+T@C6&ZCOF,Q]9NJ!UN'61?5];?1G
ML7JMA[>[Z.P]JFU7H 4IT,+)<PG&Y-#'XSI_R!W%JBW9"YJ,5AS_^.)SJ)(:
MA@Z^=*U)"2R4X&<3&U8]>V#;IQ,^U(NO]$6J7B5U79HE2W4#P"?+0SJY[7'K
MQPCGIGW#*Q?!*?'?W[A*I3&@7O6'M)@K!'-C2PO%E*EFN;YM&.K#9#6UKK1W
M$53+!_YN=4PB$5AJ]"&$&2MHMC9 UEEBE(JC,WK^E>P=VZ71?,%Y39.[LC^]
MZ=1)/5! #U*%$^=[=3I0AU1NQ76\E.:64B1Q*D<7-R/ZJWK!4X<W2C]8+ 99
M/<@9#P)F[CW(SE6\RAP[<[TV!M1W^&HTXT6( .=J/DO2J%),Y(6\CK--:?8)
MB-9IYM+I2)_L.DG1H=%#D0T%+^$?\ZR,Z1Z7>YN^ZG3$9,"U?3 >ZBZK*YJX
M0?KMMNZ V_;A7 2V\9*&3449%731W3J@>KB.2D_4'+8SIBZ>H%<NA[K_.OQE
MIS=*XO5F?0O61K]MG((1?%_IOGA<8D>E2'^,'5M\>579I5!YR"2<=>[&YRJ<
MB<E_'!1&3G>%L_PLI#,QXEG<EM/]TEE^2CJ+O$U$=Z2SO$L\_]NDL\V4+J9>
MX(\;5WXL9:^3]*T]I%6SJ=C*(+B;=YODS:S;QPKE.H6!ZM^%%1_=5K_0W75Z
M*=V;:>K0MXE#G;5<8X?3([U!F.'1D1KGZFY5O*"KL[9J=?_EV>/#UJAA-O&<
MH)L^CH3':8*82.E82 $!):X4DM:4UG+/QRX,YQRFG.:@%@8="TF%I)9;V2WP
MG17O559.I^[<22%+*CTBO>811H%W2Z:T*-%1#0N3'6 D.NUBS8)=D#2,&L:W
MTW$GYQW4*%!L5^N\TVG4TV>34O(-0A1E1$IM!51*#?&=\2F1:Y/<&0:5L0*[
M/2BZL3[1\D.QW S1W6RV?R75.PWSMEM"-E0D;S:#PPA;7)+T_/3LQQ^>GS]_
M]N/Y_SX_[XO??A.4-Y6]IPN H+\SF%X9]TK!!NM*ZBD&/N"\#<H*N'T/=T?B
MN<V^5OM9G6)>EW(H3#/5PRMT%G,P/VV[V/K3F*]9)@"TN=[+O?4[R1_EOTT8
M)A"&B5_OI3_PM5*J+1H;RRW?MD+!:C.WDWH#^309=)).7CG3BX74U2#Y"TQ$
MR5H8A:E88;\%TT#-M,-P'<ZNN2QVS27K;6#OO8H]YE(/N*G>%3H9J18]][Q5
MFTW:0V!D\:5B?*3RHC6;?&JBS-29D5L>)Z$<YY3$!QO+)+6G)\ %2V R&]<9
MK!A[)4KI@^<.RXKO8SR5N\10(,I);D:<-*>::JT>0VXG?GW@^GFLDP-K\=^'
M:ZL^',^\R73L&D<*&R&'F^HV5* BS/&,K3JECBJ;S?;-(D,F+E&6+K.ESO'0
M.KN65=;S/8L,_@.JOCT-N+<55#;'!9B0XO=)V/V$$7D0TI'X8E.I9%).+J4&
M%S?,'KTV8R*Z^A3$*A3ICU$T%3=,CF% CD]<@_J9 %88Q(K/"+(VF9O[<V\>
M-//(KLOX@\K,XU^M[_51&Y7&J-01(5Z4W_2NC9BHXPBMER,=QJN0C]<H36XH
MYU@I3!X6E;,IJ&-M4F#JM!O>7M/IR;6=8WMFCA+G_L2;^\TLLC_,3F+Y2?Y4
MAEKW /["6P3.ZW<+_]A;C)W<,8B5DU99GZ4Y1V?T0AAEBH-:N:K8VK*F:'K9
M0+6<LCFOD5&)>\2F4T(2^_Y=H[C8*4Y:G*S9D]A(P]F4J%Y[O.Q0^^#]?KNX
M[;A-IWW[''5:]GT6/?E07F$UP_51<.NH;'[JGYP&\_JHK-E^IRV]ZW;'6])3
M?^I- VO\?X9CZO:5OK.GN2#OAUU/4<&-:)\89>NUV5@<B6<K<1E?2]IK4*@N
M+V6!@?2FU"3RW^CW44J;*,]'O7)YA+9'KUY _H^^Q=>C<_S^CEP8VQV)6?2^
MUC3$][?BT5^8<46\%<+_*/'_ NFMZS '*PN_5K#I_-B;^98W]'R'/Z^*#0?4
M(;VP1BK_9O4L?;-Z 2,O05J4I2!U$T&7MI0,H'EG EZ>0_R(C"&3\?H7=%5\
MO5E]^Q9CH.*G7$;Q*B:C3TE4_%('^ 68<;8IC@0G(V2Y3&E7^O/K+M"Y47C(
MB-_>S J,LLI@W+;X!6]1X^KIMT_*>@[V).H0(Z<0K:)ULH<U&(GWB6'!9T%F
M#7A5*$K#O,NXS)/PAEZW4*NK5!"$/J.$A;C$&'IZRE?X((O, XUBC>T-O]WB
ML(EZ#!=>),"+@:XK>)2XBF&T;QJ-*/=A]0Q(OG1<9YPN8W0%@VZ\R4N!@73*
MA!:/T+RG%5O(>620CQ@4A3]_U?7J_MR%<#%-G>X6"Y6@828I)$4/C3$AT< F
MO<1 M$%C1&).\"CX)94T<[@QKQC1>+3B-/;/;S51AHM/D51C923NI=4E=PTQ
D#IXC:?)-ZD'SK.#%H-FL0AJYQO>+[_G[Q1?_!TI*V3ME0@  
 
end

-----BEGIN PGP SIGNATURE-----
Version: 2.6.i

iQBVAgUBMAGHTmWJ8JfKi+e9AQEIbQH9FPy+RDVTnMYcaoC5/oZU0+/Z5JxmBL+4
FXbk0/PawGyiGV75gMd6clF6Cek2b0jSEwYBD+u3U4d6PecrXz+faA==
=8eIt
-----END PGP SIGNATURE-----

