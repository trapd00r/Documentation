From zsh-workers-return-25710-mason-zsh=primenet.com.au@sunsite.dk Mon Sep 22 14:12:07 2008
Return-Path: <zsh-workers-return-25710-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 5221 invoked from network); 22 Sep 2008 14:12:04 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 22 Sep 2008 14:12:04 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 86626 invoked from network); 22 Sep 2008 14:11:50 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 22 Sep 2008 14:11:50 -0000
Received: (qmail 29162 invoked by alias); 22 Sep 2008 14:11:45 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 25710
Received: (qmail 29153 invoked from network); 22 Sep 2008 14:11:44 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 22 Sep 2008 14:11:44 -0000
Received: from cluster-g.mailcontrol.com (cluster-g.mailcontrol.com [208.87.233.190])
	by bifrost.dotsrc.org (Postfix) with ESMTPS id 1243C8058998
	for <zsh-workers@sunsite.dk>; Mon, 22 Sep 2008 16:11:34 +0200 (CEST)
Received: from cameurexb01.EUROPE.ROOT.PRI ([193.128.72.68])
	by rly02g.srv.mailcontrol.com (MailControl) with ESMTP id m8MEBCQp004521
	for <zsh-workers@sunsite.dk>; Mon, 22 Sep 2008 15:11:13 +0100
Received: from news01.csr.com ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.3959);
	 Mon, 22 Sep 2008 15:11:11 +0100
Received: from news01.csr.com (localhost.localdomain [127.0.0.1])
	by news01.csr.com (8.14.2/8.13.4) with ESMTP id m8MEB6ET015066
	for <zsh-workers@sunsite.dk>; Mon, 22 Sep 2008 15:11:06 +0100
Received: from csr.com (pws@localhost)
	by news01.csr.com (8.14.2/8.14.2/Submit) with ESMTP id m8MEB2JD015056
	for <zsh-workers@sunsite.dk>; Mon, 22 Sep 2008 15:11:06 +0100
X-Authentication-Warning: news01.csr.com: pws owned process doing -bs
To: zsh-workers@sunsite.dk (Zsh hackers list)
Subject: Minor VCS Info things
X-Mailer: MH-E 8.0.3; nmh 1.3; GNU Emacs 22.1.1
Date: Mon, 22 Sep 2008 15:11:02 +0100
Message-ID: <15055.1222092662@csr.com>
From: Peter Stephenson <pws@csr.com>
X-OriginalArrivalTime: 22 Sep 2008 14:11:11.0770 (UTC) FILETIME=[111427A0:01C91CBD]
X-Scanned-By: MailControl A-08-50-14 (www.mailcontrol.com) on 10.71.0.112
X-Virus-Scanned: ClamAV 0.92.1/8307/Mon Sep 22 07:05:57 2008 on bifrost
X-Virus-Status: Clean

Some minor changes for VCS_Info I'd like to suggest, if they're
uncontroversial.

vcs_comm needs to be local in all top-level functions, otherwise you get
errors trying to set elements in it when it doesn't exist from
e.g. vcs_info_printsys.

I think it's better to sanitize all options with "emulate" rather than
second guess which ones are needed, because there are lots and trying to
guess can easily cause problems (compare the completion code).  If there
are options that need to be kept they can be handled specially.  The
special problem in completion that stopped us from using "emulate" was
that completion's own behaviour is controlled by options and they're not
easily characterised by their emulation behaviour; I don't think we
should have that problem in an add-on non-interactive function suite,
but we can see.

It's confusing that if you run "vcs_info_printsys" to see what is
available it shows nothing if you haven't yet run "vcs_info" or
"vcs_info_setsys".  I think it should run vcs_info_setsys in that case.

The Perforce detector doesn't work very well.  $P4CONFIG is not tied to
being in the Perforce workspace: you can have a config file outside a
workspace to set a default client etc., and you don't need one at all if
the client etc. are set via environment variables.  The only good way of
detecting whether you're in a workspace is to ask the server.
Unfortunately this can hang (though not permanently) if the server is
not available, so I haven't sent a patch.  It could be fixed by adding
an explicit style to use the server and also a global (per server:port
pair) flag that the server didn't respond, so that it only hangs (for a
second or two) the first time.

Index: Functions/VCS_Info/vcs_info_lastmsg
===================================================================
RCS file: /cvsroot/zsh/zsh/Functions/VCS_Info/vcs_info_lastmsg,v
retrieving revision 1.1
diff -u -r1.1 vcs_info_lastmsg
--- Functions/VCS_Info/vcs_info_lastmsg	19 Sep 2008 12:58:52 -0000	1.1
+++ Functions/VCS_Info/vcs_info_lastmsg	22 Sep 2008 13:55:25 -0000
@@ -2,7 +2,8 @@
 ## Written by Frank Terbeck <ft@bewatermyfriend.org>
 ## Distributed under the same BSD-ish license as zsh itself.
 
-setopt localoptions NO_shwordsplit
+emulate -L zsh
+
 local -i i
 local -ix maxexports
 
Index: Functions/VCS_Info/vcs_info_printsys
===================================================================
RCS file: /cvsroot/zsh/zsh/Functions/VCS_Info/vcs_info_printsys,v
retrieving revision 1.1
diff -u -r1.1 vcs_info_printsys
--- Functions/VCS_Info/vcs_info_printsys	19 Sep 2008 12:58:52 -0000	1.1
+++ Functions/VCS_Info/vcs_info_printsys	22 Sep 2008 13:55:25 -0000
@@ -2,13 +2,20 @@
 ## Written by Frank Terbeck <ft@bewatermyfriend.org>
 ## Distributed under the same BSD-ish license as zsh itself.
 
-setopt localoptions noksharrays extendedglob NO_shwordsplit
+emulate -L zsh
+setopt extendedglob
+
 local sys
 local -a disabled enabled
+local -Ax vcs_comm
 
 zstyle -a ":vcs_info:-init-:${1:-default}:-all-" "enable" enabled
 (( ${#enabled} == 0 )) && enabled=( all )
 
+if (( ${+VCS_INFO_backends} == 0 )); then
+  vcs_info_setsys
+fi
+
 if [[ -n ${(M)enabled:#(#i)all} ]] ; then
     enabled=( ${VCS_INFO_backends} )
     zstyle -a ":vcs_info:-init-:${1:-default}:-all-" "disable" disabled
Index: Functions/VCS_Info/vcs_info_setsys
===================================================================
RCS file: /cvsroot/zsh/zsh/Functions/VCS_Info/vcs_info_setsys,v
retrieving revision 1.1
diff -u -r1.1 vcs_info_setsys
--- Functions/VCS_Info/vcs_info_setsys	19 Sep 2008 12:58:52 -0000	1.1
+++ Functions/VCS_Info/vcs_info_setsys	22 Sep 2008 13:55:25 -0000
@@ -2,7 +2,9 @@
 ## Written by Frank Terbeck <ft@bewatermyfriend.org>
 ## Distributed under the same BSD-ish license as zsh itself.
 
-setopt localoptions noksharrays extendedglob typeset_silent NO_shwordsplit
+emulate -L zsh
+setopt extendedglob typeset_silent
+
 local sys
 typeset -g VCS_INFO_backends
 


-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070

