From zsh-workers-return-23100-mason-zsh=primenet.com.au@sunsite.dk Thu Jan 11 22:33:08 2007
Return-Path: <zsh-workers-return-23100-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 27726 invoked from network); 11 Jan 2007 22:33:01 -0000
X-Spam-Checker-Version: SpamAssassin 3.1.7 (2006-10-05) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=AWL,BAYES_00,
	FORGED_RCVD_HELO autolearn=ham version=3.1.7
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 11 Jan 2007 22:33:01 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 47135 invoked from network); 11 Jan 2007 22:32:56 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 11 Jan 2007 22:32:56 -0000
Received: (qmail 1820 invoked by alias); 11 Jan 2007 22:32:52 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 23100
Received: (qmail 1810 invoked from network); 11 Jan 2007 22:32:52 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 11 Jan 2007 22:32:52 -0000
Received: (qmail 46774 invoked from network); 11 Jan 2007 22:32:52 -0000
Received: from mtaout01-winn.ispmail.ntl.com (81.103.221.47)
  by a.mx.sunsite.dk with SMTP; 11 Jan 2007 22:32:48 -0000
Received: from aamtaout02-winn.ispmail.ntl.com ([81.103.221.35])
          by mtaout01-winn.ispmail.ntl.com with ESMTP
          id <20070111223247.HGRA9447.mtaout01-winn.ispmail.ntl.com@aamtaout02-winn.ispmail.ntl.com>;
          Thu, 11 Jan 2007 22:32:47 +0000
Received: from pwslaptop.csr.com ([81.107.40.197])
          by aamtaout02-winn.ispmail.ntl.com with ESMTP
          id <20070111223247.TTPE17393.aamtaout02-winn.ispmail.ntl.com@pwslaptop.csr.com>;
          Thu, 11 Jan 2007 22:32:47 +0000
Received: from pwslaptop.csr.com (pwslaptop.csr.com [127.0.0.1])
	by pwslaptop.csr.com (8.13.8/8.13.7) with ESMTP id l0BMWX4G003770;
	Thu, 11 Jan 2007 22:32:35 GMT
Message-Id: <200701112232.l0BMWX4G003770@pwslaptop.csr.com>
From: Peter Stephenson <p.w.stephenson@ntlworld.com>
To: nwsgpamachine@alcatel-lucent.com,
        zsh-workers@sunsite.dk (Zsh hackers list)
Subject: Re: "trap ... DEBUG" to execute before (instead of after) each 
In-Reply-To: Message from nwsgpamachine@alcatel-lucent.com 
   of "Wed, 10 Jan 2007 01:44:47 CST." <200701100744.l0A7il227749@nwsgpa.ih.lucent.com> 
Date: Thu, 11 Jan 2007 22:32:33 +0000

(Not sent to the mailing list, so I've quoted it in full and answered
underneath.)

nwsgpamachine@alcatel-lucent.com wrote:
> Dear Peter,
> 
> Thank you very much for your quick reply. Your help is very much
> appreciated. Let's continue the effort to make this really work.
> 
> I applied your patch to my version, which is 4.3.2 that I downloaded
> a while ago. I notice that your version of "options.c" is different
> from mine:
> 
>    mine:  {NULL, "debugbeforecmd",     OPT_EMULATE,		 DEBUGBEFORECMD
> },
>    yours: {{NULL, "debugbeforecmd",     OPT_EMULATE},		 DEBUGBEFORECMD
> },
> 
> but that is not the main problem. After changing the above line, the
> patched version compiled ok.
> 
> !! The BIG problem is that the patched version does not report 
> !! LINENO values correctly. 
> 
> (Before you send me your patch, I have actually tried out something
> along the same line as your changes in exec.c and I already noticed
> these problems then). Here is a test program:
> 
> ********************************************************************
> 
> #!/BUILD_DIR/zsh-4.3.2/Src/zsh
> 
> dbg() {
>    print "xx $1 yy"
> }
> 
> # setopt DEBUGBEFORECMD      # uncomment for second try
> trap 'dbg $LINENO' DEBUG; 
> 
> date
> x=2
> print $x
> 
> case $x in
>   1) print I am 1;;
>   2) print We are 2;;
>   3) print They are 3;;
>   *) print I don\'t know;;
> esac
> 
> ********************************************************************
> 
> When I run it with the DEBUGBEFORECMD option unset, I got the output
> 
>    *****************************************
>    *                                       *
> 1  *  xx 8 yy                              *
> 2  *  Wed Jan 10 01:16:51 CST 2007         *
> 3  *  xx 10 yy                             *
> 4  *  xx 11 yy                             *
> 5  *  2                                    *
> 6  *  xx 12 yy                             *
> 7  *  We are 2                             *
> 8  *  xx 16 yy                             *
> 9  *  xx 14 yy                             *
>    *                                       *
>    *****************************************
> 
> which is reasonablelele.
> 
> But when I run it with DEBUGBEFORECMD set, I got
> 
>    *****************************************
>    *                                       *
> 1  *  xx 11 yy                             *
> 2  *  Wed Jan 10 01:15:34 CST 2007         *
> 3  *  xx 12 yy                             *
> 4  *  xx 13 yy                             *
> 5  *  2                                    *
> 6  *  xx 20 yy                             *
> 7  *  xx 14 yy                             *
> 8  *  We are 2                             *
>    *                                       *
>    *****************************************
> 
> Note that all the LINENO is 1 more than the correct value. 
> 
> For example, line 1 above is the output of the DEBUG TRAP before the
> "date" command. It prints "xx 11 yy", but "date" is on line 10. In
> the first output (when DEBUGBEFORECMD is not set), line 3 gives the
> correct LINENO as 10.
> 
> When it comes to the "case" structure, the problem is even worse.
> First of all, it prints "xx 20 yy" (line 6), which refers to the
> statement "esac" (remember that LINENO is off by 1), whereas one
> would expect to see the statement "case" reported first. Another
> thing is that the output "We are 2" (line 8) comes from the
> statement "2) print We are 2;;" which is at line 16 of the script,
> but the DEBUG TRAP prints "xx 14 yy" (line 7 in the output) instead.
> 
> I don't know the source code enough to figure it out myself why this
> happened.
> 
> Would apprecaite if you can help to get to the bottom of these.
> 
> mk

Yes, I forgot about the line number stuff which isn't particularly well
implemented at the moment.  What happens is that execution of a command
(actually, the start of a pipeline) causes the line number to be set to
the value recorded for the code where that command occurs, which is
buried inside the parsed command (the wordcode).  This global line
number is then referred to by the LINENO variable.  Setting it in this
fashion happens too late for execution of the debug trap with the new
option.

I'm not quite sure how to deal with this at the moment; I'll think about
the neatest way, and if it can be combined with an improvement to the 
way the line number is handled.

-- 
Peter Stephenson <p.w.stephenson@ntlworld.com>
Web page now at http://homepage.ntlworld.com/p.w.stephenson/

