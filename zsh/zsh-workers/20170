From zsh-workers-return-20170-mason-zsh=primenet.com.au@sunsite.dk Fri Jul 16 19:42:55 2004
Return-Path: <zsh-workers-return-20170-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 7611 invoked from network); 16 Jul 2004 19:42:55 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 16 Jul 2004 19:42:55 -0000
Received: (qmail 52978 invoked from network); 16 Jul 2004 19:42:49 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 16 Jul 2004 19:42:49 -0000
Received: (qmail 13963 invoked by alias); 16 Jul 2004 19:41:45 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 20170
Received: (qmail 13954 invoked from network); 16 Jul 2004 19:41:45 -0000
Received: from unknown (HELO a.mx.sunsite.dk) (130.225.247.88)
  by 130.225.247.90 with SMTP; 16 Jul 2004 19:41:45 -0000
Received: (qmail 47047 invoked from network); 16 Jul 2004 19:39:48 -0000
Received: from acolyte.scowler.net (216.254.112.45)
  by a.mx.sunsite.dk with SMTP; 16 Jul 2004 19:39:45 -0000
Received: from localhost (localhost [127.0.0.1])
	by acolyte.scowler.net (Postfix) with ESMTP id DEA3F70014
	for <zsh-workers@sunsite.dk>; Fri, 16 Jul 2004 15:39:43 -0400 (EDT)
Received: from acolyte.scowler.net ([127.0.0.1])
	by localhost (acolyte [127.0.0.1]) (amavisd-new, port 10024)
	with LMTP id 28439-02 for <zsh-workers@sunsite.dk>;
	Fri, 16 Jul 2004 15:39:39 -0400 (EDT)
Received: by acolyte.scowler.net (Postfix, from userid 1000)
	id 136637004E; Fri, 16 Jul 2004 15:39:38 -0400 (EDT)
Date: Fri, 16 Jul 2004 15:39:38 -0400
From: Clint Adams <clint@zsh.org>
To: zsh-workers@sunsite.dk
Subject: use mremap where available
Message-ID: <20040716193938.GA28603@scowler.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
User-Agent: Mutt/1.5.6+20040523i
X-Virus-Scanned: by amavisd-new-20030616-p10 (Debian) at scowler.net
X-Spam-Checker-Version: SpamAssassin 2.63 on a.mx.sunsite.dk
X-Spam-Level: 
X-Spam-Status: No, hits=0.0 required=6.0 tests=none autolearn=no version=2.63
X-Spam-Hits: 0.0

I'm not committing this.

Index: configure.ac
===================================================================
RCS file: /cvsroot/zsh/zsh/configure.ac,v
retrieving revision 1.18
diff -u -r1.18 configure.ac
--- configure.ac	8 Jun 2004 13:34:12 -0000	1.18
+++ configure.ac	16 Jul 2004 19:12:28 -0000
@@ -1129,7 +1129,7 @@
 
 AC_FUNC_MMAP
 if test x$ac_cv_func_mmap_fixed_mapped = xyes; then
-  AC_CHECK_FUNCS(munmap msync)
+  AC_CHECK_FUNCS(munmap msync mremap)
 fi
 
 if test $ac_cv_func_setpgrp = yes; then
Index: Src/mem.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/mem.c,v
retrieving revision 1.11
diff -u -r1.11 mem.c
--- Src/mem.c	2 Jun 2004 22:14:26 -0000	1.11
+++ Src/mem.c	16 Jul 2004 19:12:29 -0000
@@ -493,6 +493,13 @@
 	    n -= n % HEAPSIZE;
 
 #ifdef USE_MMAP
+# if defined(HAVE_MREMAP) && defined(MREMAP_MAYMOVE)
+	    size_t pgsz = sysconf(_SC_PAGESIZE);     /* SVR4 */
+	    h = (Heap) mremap(h, h->size, (n + pgsz-1) & ~(pgsz-1), MREMAP_MAYMOVE);
+	    if (errno)
+		    zwarn("mremap: %e", NULL, errno);
+	    DPUTS((h == MAP_FAILED), "BUG: mremap failed");
+# else
 	    {
 		/*
 		 * I don't know any easy portable way of requesting
@@ -507,6 +514,7 @@
 		munmap((void *)h, h->size);
 		h = hnew;
 	    }
+# endif
 #else
 	    h = (Heap) realloc(h, n);
 #endif

