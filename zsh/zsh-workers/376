From zsh-workers-request@math.gatech.edu  Sat Sep  9 03:08:13 1995
Received: from gatech.edu (gatech.edu [130.207.244.244]) by werple.mira.net.au (8.6.12/8.6.9) with SMTP id DAA20310 for <mason@werple.mira.net.au>; Sat, 9 Sep 1995 03:08:08 +1000
Received: from math (math.skiles.gatech.edu) by gatech.edu with SMTP id AA10741
  (5.65c/Gatech-10.0-IDA for <mason@werple.mira.net.au>); Fri, 8 Sep 1995 13:02:16 -0400
Received: by math (5.x/SMI-SVR4)
	id AA03918; Fri, 8 Sep 1995 12:28:17 -0400
Resent-Date: Fri, 08 Sep 95 17:29:08 +0100
Old-Return-Path: <P.Stephenson@swansea.ac.uk>
Message-Id: <14719.9509081629@pyro.swan.ac.uk>
To: zsh-workers@math.gatech.edu (Zsh hackers list)
Cc: kasahara@csce.kyushu-u.ac.jp (Yoshiaki KASAHARA)
Subject: Re: history file re-writing in sub-shell
In-Reply-To: "hzoli@cs.elte.hu"'s message of "Thu, 07 Sep 95 22:03:53 +0200." <199509072003.WAA01387@bolyai.cs.elte.hu>
Date: Fri, 08 Sep 95 17:29:08 +0100
From: P.Stephenson@swansea.ac.uk
X-Mts: smtp
Resent-Message-Id: <"Xj18U3.0.8z.Wy6Km"@math>
Resent-From: zsh-workers@math.gatech.edu
X-Mailing-List: <zsh-workers@math.gatech.edu> archive/latest/376
X-Loop: zsh-workers@math.gatech.edu
Precedence: list
Resent-Sender: zsh-workers-request@math.gatech.edu

hzoli@cs.elte.hu wrote:
> > 
> > Hello.  I'm not a subscriber of this list, but I found a weirdness
> > while using zsh-2.6-beta8 and 10, so I'll report it here.
> > 
> > After I replaced my zsh from 2.5 to 2.6beta, I found that saved
> > history was not read correctly.
> > 
> > Finally I found that when I use $(non-zsh-builtin-command), the
> > content of $HISTFILE is changed (just like when an interactive shell
> > exits).  I believe there are something wrong with command
> > substitution...  I have never encountered such a problem with zsh 2.5.
> 
> I send a `fix' for that in article 337 some time ago, I send it
> again as noon e responded.  It fixes the problem but is completely
> disables saving history on exec since an other bug I'm not going to
> fix (I have no time and I do not know exec.c well enough).

Sorry, I meant to have a look at this but I've been busy too.

If you apply this after Zoltan's patch, it should restore the expected
behaviour.  It simply changes the flag for subshells (subsh) in the
case where it's not a true subshell but an exec about to happen.  I
can't see a problem with this and the obvious tests seem to work.

*** Src/exec.c~	Fri Sep  8 17:14:24 1995
--- Src/exec.c	Fri Sep  8 17:18:07 1995
***************
*** 1281,1286 ****
--- 1281,1287 ----
  	    holdintr();
      } else if ((cmd->flags & CFLAG_EXEC) && !nullexec) {
  	entersubsh(bkg, 1);
+ 	subsh = 2;		/* we're execing, not a true subshell */
      } else {
      /* Job is running in current shell. */
  	jobtab[thisjob].stat |= STAT_CURSH;
***************
*** 1502,1508 ****
  
  	    if (!forked) {
  		if (cmd->flags & CFLAG_EXEC) {
! 		    if (subsh)
  			_exit(lastval);
  		    if (unset(NORCS) && interact && sourcelevel < 32768)
  			/* save the history file through execs */
--- 1503,1509 ----
  
  	    if (!forked) {
  		if (cmd->flags & CFLAG_EXEC) {
! 		    if (subsh == 1)
  			_exit(lastval);
  		    if (unset(NORCS) && interact && sourcelevel < 32768)
  			/* save the history file through execs */
***************
*** 1528,1534 ****
  	} else {
  	    if (cmd->flags & CFLAG_EXEC) {
  		setiparam("SHLVL", --shlvl);
! 		if (unset(NORCS) && interact && !subsh && sourcelevel < 32768)
  		    /* save the history file through execs */
  		    savehistfile(getsparam("HISTFILE"), 1, isset(APPENDHISTORY) ? 3 : 0);
  	    }
--- 1529,1536 ----
  	} else {
  	    if (cmd->flags & CFLAG_EXEC) {
  		setiparam("SHLVL", --shlvl);
! 		if (unset(NORCS) && interact && subsh != 1
! 		    && sourcelevel < 32768)
  		    /* save the history file through execs */
  		    savehistfile(getsparam("HISTFILE"), 1, isset(APPENDHISTORY) ? 3 : 0);
  	    }

-- 
Peter Stephenson <P.Stephenson@swansea.ac.uk>  Tel: +44 1792 205678 extn. 4461
WWW:  http://python.swan.ac.uk/~pypeters/      Fax: +44 1792 295324
Department of Physics, University of Wales, Swansea,
Singleton Park, Swansea, SA2 8PP, U.K.

