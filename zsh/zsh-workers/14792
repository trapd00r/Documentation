From zsh-workers-return-14792-mason-zsh=primenet.com.au@sunsite.dk Thu Jun 07 20:42:59 2001
Return-Path: <zsh-workers-return-14792-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 13617 invoked from network); 7 Jun 2001 20:42:58 -0000
Received: from sunsite.dk (130.225.51.30)
  by ns1.primenet.com.au with SMTP; 7 Jun 2001 20:42:58 -0000
Received: (qmail 5357 invoked by alias); 7 Jun 2001 20:42:39 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 14792
Received: (qmail 5346 invoked from network); 7 Jun 2001 20:42:38 -0000
From: Bart Schaefer <schaefer@zanshin.com>
To: zsh-workers@sunsite.dk
Subject: PATCH Re: Problem compiling tcp module
Reply-to: Bart Schaefer <schaefer@zanshin.com>
Message-Id: <E1586cD-0003h7-00@aztec.zanshin.com>
Date: Thu, 07 Jun 2001 13:42:49 -0700

Also a change to comptest so that "make check" works under emacs.

Index: Src/Modules/tcp.h
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Modules/tcp.h,v
retrieving revision 1.1
diff -u -r1.1 tcp.h
--- Src/Modules/tcp.h	2001/06/06 18:53:56	1.1
+++ Src/Modules/tcp.h	2001/06/07 20:39:59
@@ -27,10 +27,33 @@
  *
  */
 
+/*
+ * We need to include the zsh headers later to avoid clashes with
+ * the definitions on some systems, however we need the configuration
+ * file to decide whether we can include netinet/in_systm.h, which
+ * doesn't exist on cygwin.
+ */
 #include "../../config.h"
+
 #include <sys/types.h>
 #include <sys/socket.h>
 #include <netdb.h>
+
+/*
+ * For some reason, configure doesn't always detect netinet/in_systm.h.
+ * On some systems, including linux, this seems to be because gcc is
+ * throwing up a warning message about the redefinition of
+ * __USE_LARGEFILE.  This means the problem is somewhere in the
+ * header files where we can't get at it.  For now, revert to
+ * not including this file only on systems where we know it's missing.
+ * Currently this is just cygwin.
+ */
+#ifndef __CYGWIN__
+# include <netinet/in_systm.h>
+#endif
+#include <netinet/in.h>
+#include <netinet/ip.h>
+#include <arpa/inet.h>
 
 /* Is IPv6 supported by the library? */
 
Index: Src/Modules/zftp.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Modules/zftp.c,v
retrieving revision 1.13
diff -u -r1.13 zftp.c
--- Src/Modules/zftp.c	2001/06/06 18:53:56	1.13
+++ Src/Modules/zftp.c	2001/06/07 20:39:59
@@ -49,33 +49,6 @@
 struct zftp_session;
 typedef struct zftp_session *Zftp_session;
 
-/*
- * We need to include the zsh headers later to avoid clashes with
- * the definitions on some systems, however we need the configuration
- * file to decide whether we can include netinet/in_systm.h, which
- * doesn't exist on cygwin.
- */
-#include "../../config.h"
-
-#include <sys/types.h>
-#include <sys/socket.h>
-#include <netdb.h>
-/*
- * For some reason, configure doesn't always detect netinet/in_systm.h.
- * On some systems, including linux, this seems to be because gcc is
- * throwing up a warning message about the redefinition of
- * __USE_LARGEFILE.  This means the problem is somewhere in the
- * header files where we can't get at it.  For now, revert to
- * not including this file only on systems where we know it's missing.
- * Currently this is just cygwin.
- */
-#ifndef __CYGWIN__
-# include <netinet/in_systm.h>
-#endif
-#include <netinet/in.h>
-#include <netinet/ip.h>
-#include <arpa/inet.h>
-
 #include "tcp.h"
 #include "zftp.mdh"
 #include "zftp.pro"
Index: Test/comptest
===================================================================
RCS file: /cvsroot/zsh/zsh/Test/comptest,v
retrieving revision 1.13
diff -u -r1.13 comptest
--- Test/comptest	2001/05/08 10:26:58	1.13
+++ Test/comptest	2001/06/07 20:39:59
@@ -8,7 +8,7 @@
   zmodload -i zsh/zpty
 
   comptest_zsh=${ZSH:-zsh}
-  termcap_ce="$(echotc ce)"
+  termcap_ce="$(echotc ce 2>/dev/null)"
 
   while getopts z: opt; do
     case $opt in
@@ -30,6 +30,7 @@
 "module_path=( $module_path )" \
 "fpath=( $fpath )" \
 'LISTMAX=10000000
+TERM=vt100
 stty columns 80 rows 24
 setopt zle
 bindkey -e

