From zsh-workers-return-18465-mason-zsh=primenet.com.au@sunsite.dk Wed Apr 23 18:20:48 2003
Return-Path: <zsh-workers-return-18465-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 26462 invoked from network); 23 Apr 2003 18:20:47 -0000
Received: from sunsite.dk (130.225.247.90)
  by ns1.primenet.com.au with SMTP; 23 Apr 2003 18:20:47 -0000
Received: (qmail 5603 invoked by alias); 23 Apr 2003 18:20:42 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 18465
Received: (qmail 5595 invoked from network); 23 Apr 2003 18:20:42 -0000
Received: from localhost (HELO sunsite.dk) (127.0.0.1)
  by localhost with SMTP; 23 Apr 2003 18:20:42 -0000
X-MessageWall-Score: 0 (sunsite.dk)
Received: from [195.92.195.174] by sunsite.dk (MessageWall 1.0.8) with SMTP; 23 Apr 2003 18:20:41 -0000
Received: from modem-206.south-carolina.dialup.pol.co.uk ([62.137.91.206] helo=pwstephenson.fsnet.co.uk)
	by cmailg4.svr.pol.co.uk with esmtp (Exim 4.14)
	id 198OrI-00015E-1W
	for zsh-workers@sunsite.dk; Wed, 23 Apr 2003 19:20:40 +0100
Received: by pwstephenson.fsnet.co.uk (Postfix, from userid 501)
	id BC5E91B76A; Wed, 23 Apr 2003 18:25:23 +0100 (BST)
Received: from pwstephenson.fsnet.co.uk (localhost [127.0.0.1])
	by pwstephenson.fsnet.co.uk (Postfix) with ESMTP id 631531B769
	for <zsh-workers@sunsite.dk>; Wed, 23 Apr 2003 18:25:23 +0100 (BST)
To: zsh-workers@sunsite.dk (Zsh hackers list)
Subject: Re: Rewrite of compsys.yo 
In-reply-to: "Oliver Kiddle"'s message of "Fri, 18 Apr 2003 15:17:00 +0200."
             <6750.1050671820@gmcs3.logica.co.uk> 
Date: Wed, 23 Apr 2003 18:25:17 +0100
From: Peter Stephenson <pws@pwstephenson.fsnet.co.uk>
Message-Id: <20030423172523.BC5E91B76A@pwstephenson.fsnet.co.uk>

Oliver Kiddle wrote:
> For _arguments, there seems to now be no documentation for the option
> descriptions that appear in square brackets.

Do you mean something other than this chunk?

item(var(optspec)tt([)var(explanation)tt(]))(
An explanation string may be appended to any of the preceding forms of
var(optspec) by enclosing it in brackets, as in `tt(-q[query operation])'.

The tt(verbose) style is used to decide whether the explanation strings
are displayed with the option in a completion listing.

If no bracketed explanation string is given but the tt(auto-description)
style is set and only one argument is described for this var(optspec), the
value of the style is displayed, with any appearance of the sequence
`tt(%d)' in it replaced by the var(message) of the first var(optarg)
that follows the var(optspec); see below.
)
 
> The old documentation also seemed to be implying that setting $context,
> $line and $opt_args was dependant on using -R.

It did indeed, I just copied that.

> Also,
> someone has recently posted about a bug with pwd and metafy() to the
> sourceforge tracker which probably needs looking at.

The fix looks all right and I've just committed it to both branches:

*Submitted By:* IKEGAMI, Tsutomu (ikegami)
*Date Submitted:* 2003-04-16 09:18

Symptom:
I'm using zsh on Mac OS X, where filenames are encoded with UTF-8.
There, pwd builtin command gives a wrong answer if:
1) used inside of a shell-script,
2) there's no preceding cd command,
3) chase_links option is off,
4) and the script is launched from a 'Kanji' directory.
The 'Kanji' directory means that some characters outside of ASCII set
(0x20-0x7f) are contained in the path.

Origin:
Pwd command uses internal variable char *pwd for its answer. *Pwd
is initialized in init.c, where PWD environment variable is refered.
PWD environment variable may contain META characters under UTF-8
encoding, but it is used without metafy().

Solution:
--- Src/init.c.org Wed Apr 16 17:26:33 2003
+++ Src/init.c Wed Apr 16 17:51:29 2003
@@ -753,7 +753,8 @@
* initialize `PWD' from `HOME' */
if (ispwd(home))
pwd = ztrdup(home);
- else if ((ptr = zgetenv("PWD")) && ispwd(ptr))
+ else if ( (ptr = zgetenv("PWD")) && (strlen(ptr) < PATH_MAX) &&
+ (ptr = metafy(ptr, -1, META_STATIC), ispwd(ptr)) )
pwd = ztrdup(ptr);
else
pwd = metafy(zgetcwd(), -1, META_DUP);

-- 
Peter Stephenson <pws@pwstephenson.fsnet.co.uk>
Work: pws@csr.com
Web: http://www.pwstephenson.fsnet.co.uk

