From zsh-workers-return-28779-mason-zsh=primenet.com.au@zsh.org Sat Feb 19 18:50:53 2011
Return-Path: <zsh-workers-return-28779-mason-zsh=primenet.com.au@zsh.org>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 12562 invoked by alias); 19 Feb 2011 18:50:53 -0000
Mailing-List: contact zsh-workers-help@zsh.org; run by ezmlm
Precedence: bulk
X-No-Archive: yes
List-Id: Zsh Workers List <zsh-workers.zsh.org>
List-Post: <mailto:zsh-workers@zsh.org>
List-Help: <mailto:zsh-workers-help@zsh.org>
Delivered-To: mailing list zsh-workers@zsh.org
X-Seq: 28779
Received: (qmail 539 invoked from network); 19 Feb 2011 18:50:40 -0000
X-Spam-Checker-Version: SpamAssassin 3.3.1 (2010-03-16) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-1.9 required=5.0 tests=BAYES_00 autolearn=ham
	version=3.3.1
Received-SPF: none (ns1.primenet.com.au: domain at hightek.org does not designate permitted sender hosts)
Date: Sat, 19 Feb 2011 12:50:31 -0600
From: Vincent Stemen <vince.lists@hightek.org>
To: zsh-workers@zsh.org
Subject: Re: make test hangs on the Y tests
Message-ID: <20110219185031.GA82582@quark.hightek.org>
References: <20110219042528.GA73105@quark.hightek.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20110219042528.GA73105@quark.hightek.org>
User-Agent: Mutt/1.5.18 (2008-05-17)
Sender: Vincent Stemen <vince@hightek.org>

On Fri, Feb 18, 2011 at 10:25:29PM -0600, Vincent Stemen wrote:
> Hi.  On the master branch from git as of yesterday, running "make test"
> hangs when it gets to the Y01completion test.  It seems to hang on any
> of the 'Y' tests.
> 
>     # ZTST_verbose=2 make TESTNUM=Y test
>     cd Test ; make check
>     if test -n "gcc"; then  cd .. && DESTDIR=  make MODDIR=`pwd`/Test/Modules install.modules > /dev/null;  fi
>     if ZTST_testlist="`for f in ./Y*.ztst;  do echo $f; done`"  ZTST_srcdir="."  ZTST_exe=../Src/zsh  ../Src/zsh +Z -f ./runtests.zsh; then  stat=0;  else  stat=1;  fi;  sleep 1;  rm -rf Modules .zcompdump;  exit $stat
>     ./Y01completion.ztst: starting.
>     ZTST_getsect: read section name: prep
>     ZTST_getchunk: read code chunk:
>       if ( zmodload -i zsh/zpty ) >/dev/null 2>&1; then
>         . $ZTST_srcdir/comptest
>         mkdir comp.tmp
>         cd comp.tmp
>         comptestinit -z $ZTST_testdir/../Src/zsh &&
>         {
>           mkdir dir1 &&
>           mkdir dir2 &&
>           touch file1 &&
>           touch file2
>         }
>       else
>         ZTST_unimplemented="the zsh/zpty module is not available"
>       fi
>     ^C
> 
> As you can see at the bottom, I eventually hit ^C to break out.

Just as a reminder, this is on FreeBSD, in case it might make any
difference.

I have tracked down where it is hanging, but I don't know enough zsh
internals to know why.

When processing the %prep section of the Y tests,
it calls
    comptestinit -z $ZTST_testdir/../Src/zsh
which calls comptesteval() in Test/comptest.

On line 83 in comptesteval() it calls
    zpty -r -m zsh log_eval "*<PROMPT>*"
and thats where it hangs.  zpty never returns.

I hope this helps.  Let me know if there is anything more I can do to help
troubleshoot it.

Vince

