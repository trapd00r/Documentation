From zsh-workers-return-28947-mason-zsh=primenet.com.au@zsh.org Mon Mar 28 04:48:28 2011
Return-Path: <zsh-workers-return-28947-mason-zsh=primenet.com.au@zsh.org>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 12077 invoked by alias); 28 Mar 2011 04:48:28 -0000
Mailing-List: contact zsh-workers-help@zsh.org; run by ezmlm
Precedence: bulk
X-No-Archive: yes
List-Id: Zsh Workers List <zsh-workers.zsh.org>
List-Post: <mailto:zsh-workers@zsh.org>
List-Help: <mailto:zsh-workers-help@zsh.org>
Delivered-To: mailing list zsh-workers@zsh.org
X-Seq: 28947
Received: (qmail 17104 invoked from network); 28 Mar 2011 04:48:16 -0000
X-Spam-Checker-Version: SpamAssassin 3.3.1 (2010-03-16) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-1.9 required=5.0 tests=BAYES_00,RCVD_IN_DNSWL_NONE
	autolearn=ham version=3.3.1
Received-SPF: none (ns1.primenet.com.au: domain at closedmail.com does not designate permitted sender hosts)
From: Bart Schaefer <schaefer@brasslantern.com>
Message-id: <110327214759.ZM26228@torch.brasslantern.com>
Date: Sun, 27 Mar 2011 21:47:59 -0700
In-reply-to: <AANLkTinOF8x4XY8dtiPUkN=MaAcnyN59a_9yujM5KQAo@mail.gmail.com>
Comments: In reply to Mikael Magnusson <mikachu@gmail.com>
 "Re: crash/memory corruption when completing dynamic named directory" (Mar 27,
  1:32pm)
References: <AANLkTi=qwPYqiwCGVw=vkN75JUFntDDrLgiO-CjYQQH9@mail.gmail.com>
	<AANLkTi=DsVZv5J2m26e86XgaD3qJtRtWMfDdWEoh3baD@mail.gmail.com>
	<alpine.LNX.2.01.1103261818320.22141@hp>
	<AANLkTinOF8x4XY8dtiPUkN=MaAcnyN59a_9yujM5KQAo@mail.gmail.com>
X-Mailer: OpenZMail Classic (0.9.2 24April2005)
To: zsh workers <zsh-workers@zsh.org>
Subject: Re: crash/memory corruption when completing dynamic named directory
MIME-version: 1.0
Content-type: text/plain; charset=us-ascii

On Mar 27,  1:32pm, Mikael Magnusson wrote:
} Subject: Re: crash/memory corruption when completing dynamic named directo
}
} Would you believe that accessing $CURSOR from within a completer will
} actually unmetafy zlemetaline in place? :)

I don't disbelieve it.

} pws, afaict, only the first little bit of zlemetaline is needed for
} this, ie the outcs calculation. Would it be okay to split this out to
} a separate function and call that from get_cursor and stringaszleline?
} [...]  Or does outcs actually depend on the conversion too?

I see PWS already replied, but:  It appears to me that to compute outcs
it's necessary to unmetafy the line in the MULTIBYTE_SUPPORT case, so we
are probably stuck with your patch from 28941.

} Otherwise we have to copy zlemetaline first and then run
} stringaszleline, and discard all that work, which seems silly.

It'd probably be possible to write a routine that decodes metatifed
characters on the fly and counts what they decode to, without updating
the buffer in place, but that's not what's available now.

