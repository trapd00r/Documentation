From zsh-workers-return-24107-mason-zsh=primenet.com.au@sunsite.dk Tue Nov 20 15:43:45 2007
Return-Path: <zsh-workers-return-24107-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 3782 invoked from network); 20 Nov 2007 15:43:36 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.3 (2007-08-08) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.3
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 20 Nov 2007 15:43:36 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 40734 invoked from network); 20 Nov 2007 15:43:26 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 20 Nov 2007 15:43:26 -0000
Received: (qmail 6946 invoked by alias); 20 Nov 2007 15:43:22 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 24107
Received: (qmail 6930 invoked from network); 20 Nov 2007 15:43:21 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 20 Nov 2007 15:43:21 -0000
Received: (qmail 40393 invoked from network); 20 Nov 2007 15:43:21 -0000
Received: from cluster-g.mailcontrol.com (85.115.41.190)
  by a.mx.sunsite.dk with SMTP; 20 Nov 2007 15:43:13 -0000
Received: from cameurexb01.EUROPE.ROOT.PRI ([62.189.241.200])
	by rly02g.srv.mailcontrol.com (MailControl) with ESMTP id lAKFfEi4023303
	for <zsh-workers@sunsite.dk>; Tue, 20 Nov 2007 15:43:00 GMT
Received: from news01 ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.1830);
	 Tue, 20 Nov 2007 15:42:47 +0000
Date: Tue, 20 Nov 2007 15:42:46 +0000
From: Peter Stephenson <pws@csr.com>
To: "Zsh Hackers' List" <zsh-workers@sunsite.dk>
Subject: Re: zsh-4.3.4-dev-2.tar.gz
Message-ID: <20071120154246.30388170@news01>
In-Reply-To: <4742F733.4030908@math.technion.ac.il>
References: <11649.1195558694@csr.com>
	<4742DC87.5030901@math.technion.ac.il>
	<20071120141442.55f7ac28@news01>
	<4742F733.4030908@math.technion.ac.il>
Organization: CSR
X-Mailer: Claws Mail 3.0.2 (GTK+ 2.10.14; i386-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
X-OriginalArrivalTime: 20 Nov 2007 15:42:47.0149 (UTC) FILETIME=[FFC331D0:01C82B8B]
X-Scanned-By: MailControl A-06-00-00 (www.mailcontrol.com) on 10.71.0.112

On Tue, 20 Nov 2007 17:03:15 +0200
"Zvi Har'El" <rl@math.technion.ac.il> wrote:
> I believe ncurses.h is in the standard place, but not where it is
> configures looks for and the sources include it:
>...
> so, one should have
> #include <ncursesw/ncurses.h>

Aieee.

This looks for the header in more places and tries to be consistent about
multibyte support.

It also tries to be consistent the other way:  if we haven't found
the ncurses library, we shouldn't be using the headers.

Index: configure.ac
===================================================================
RCS file: /cvsroot/zsh/zsh/configure.ac,v
retrieving revision 1.79
diff -u -r1.79 configure.ac
--- configure.ac	20 Nov 2007 14:20:00 -0000	1.79
+++ configure.ac	20 Nov 2007 15:39:40 -0000
@@ -557,7 +557,8 @@
 		 unistd.h sys/capability.h \
 		 utmp.h utmpx.h sys/types.h pwd.h grp.h poll.h sys/mman.h \
 		 netinet/in_systm.h pcre.h langinfo.h wchar.h stddef.h \
-		 sys/stropts.h iconv.h ncurses.h)
+		 sys/stropts.h iconv.h ncurses.h ncursesw/ncurses.h \
+		 ncurses/ncurses.h)
 if test x$dynamic = xyes; then
   AC_CHECK_HEADERS(dlfcn.h)
   AC_CHECK_HEADERS(dl.h)
@@ -639,7 +640,7 @@
 dnl Various features of ncurses depend on having the right header
 dnl (the system's own curses.h may well not be good enough).
 dnl So don't search for ncurses unless we found the header.
-if test x$ac_cv_header_ncurses_h = xyes; then
+if test x$ac_cv_header_ncurses_h = xyes || test x$ac_cv_header_ncurses_ncurses_h = xyes || test x$ac_cv_header_ncursesw_ncurses_h = xyes; then
   ncursesw_test=ncursesw
   ncurses_test=ncurses
 else
@@ -719,6 +720,16 @@
 AC_MSG_RESULT(no)
 fi
 
+dnl If our terminal library is not ncurses, don't try including
+dnl any ncurses headers.
+AH_TEMPLATE([ZSH_IGNORE_NCURSES],
+[Define to 1 to ignore any ncurses library headers found on the system.])
+case $LIBS in
+  ncurses*) ;;
+  *)
+  AC_DEFINE(ZSH_IGNORE_NCURSES) ;;
+esac
+
 AC_MSG_CHECKING(if boolcodes is available)
 AC_TRY_LINK([#ifdef TERM_H_NEEDS_CURSES_H
 #include <curses.h>
@@ -1381,7 +1392,7 @@
 AC_CACHE_CHECK(where curses key definitions are located, zsh_cv_path_curses_keys_h,
 [dnl This is an identical trick to errno.h, except we use ncurses.h
 dnl if we can.
-if test x$ac_cv_header_ncurses_h = xyes; then
+if test x$ac_cv_header_ncurses_h = xyes || test x$ac_cv_header_ncurses_ncurses_h = xyes || test x$ac_cv_header_ncursesw_ncurses_h = xyes; then
   echo "#include <ncurses.h>" >nametmp.c
 else
   if test x$ac_cv_header_curses_h = xyes; then
Index: Src/Modules/curses.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Modules/curses.c,v
retrieving revision 1.40
diff -u -r1.40 curses.c
--- Src/Modules/curses.c	12 Nov 2007 12:16:52 -0000	1.40
+++ Src/Modules/curses.c	20 Nov 2007 15:39:41 -0000
@@ -32,20 +32,35 @@
 #include "curses.mdh"
 #include "curses.pro"
 
-#ifdef HAVE_NCURSES_H
-# include <ncurses.h>
-#else
-# ifdef HAVE_CURSES_H
-#  include <curses.h>
-# endif
-#endif
-
 #ifndef MULTIBYTE_SUPPORT
 # undef HAVE_GETCCHAR
 # undef HAVE_SETCCHAR
 # undef HAVE_WADDWSTR
 # undef HAVE_WGET_WCH
 # undef HAVE_WIN_WCH
+# undef HAVE_NCURSESW_NCURSES_H
+#endif
+
+#ifdef ZSH_IGNORE_NCURSES
+# ifdef HAVE_CURSES_H
+#  include <curses.h>
+# endif
+#else
+# ifdef HAVE_NCURSESW_NCURSES_H
+#  include <ncursesw/ncurses.h>
+# else
+#  ifdef HAVE_NCURSES_H
+#   include <ncurses.h>
+#  else
+#   ifdef HAVE_NCURSES_NCURSES_H
+#    include <ncurses/ncurses.h>
+#   else
+#    ifdef HAVE_CURSES_H
+#     include <curses.h>
+#    endif
+#   endif
+#  endif
+# endif
 #endif
 
 #ifdef HAVE_SETCCHAR

-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070

