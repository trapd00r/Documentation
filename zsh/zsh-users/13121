From zsh-users-return-13121-mason-zsh=primenet.com.au@sunsite.dk Sun Aug 10 13:05:52 2008
Return-Path: <zsh-users-return-13121-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 12477 invoked from network); 10 Aug 2008 13:05:48 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 10 Aug 2008 13:05:48 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 96454 invoked from network); 10 Aug 2008 13:04:28 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 10 Aug 2008 13:04:28 -0000
Received: (qmail 16005 invoked by alias); 10 Aug 2008 13:03:33 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 13121
Received: (qmail 15981 invoked from network); 10 Aug 2008 13:03:29 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 10 Aug 2008 13:03:29 -0000
Received: from mx.spodhuis.org (redoubt.spodhuis.org [193.202.115.177])
	by bifrost.dotsrc.org (Postfix) with ESMTPS id 712AD809A180
	for <zsh-users@sunsite.dk>; Sun, 10 Aug 2008 15:03:24 +0200 (CEST)
DomainKey-Signature: a=rsa-sha1; q=dns; c=nofws; s=d200807; d=spodhuis.org;
	h=Received:Date:From:To:Cc:Subject:Message-ID:Mail-Followup-To:References:MIME-Version:Content-Type:Content-Disposition:In-Reply-To;
	b=NwW2LzOuBEfX/kJvswwFwgI/DLvosATbTnecIoGUpdrGgLuHIVgLFM8uGtabvRnjkzNzJZHq29Fbf3bE6tTnvIH/2aOcqz284XkWz/728rUv6mZQP0mQ8bfELRlE69xULTl6wF8IZb0TW6H2MOcXGlWtnaEwkBp59EML2PADAfk=;
Received: by smtp.spodhuis.org with local 
	id 1KSAZv-000CR1-Op; Sun, 10 Aug 2008 13:03:23 +0000
Date: Sun, 10 Aug 2008 06:03:23 -0700
From: Phil Pennock <zsh-workers+phil.pennock@spodhuis.org>
To: "Eric D. Friedman" <eric_friedman@mac.com>
Cc: "Benjamin R. Haskell" <zsh@benizi.com>,
	Zsh Users <zsh-users@sunsite.dk>
Subject: Re: Multi-Minute Startup?
Message-ID: <20080810130323.GA75798@redoubt.spodhuis.org>
Mail-Followup-To: "Eric D. Friedman" <eric_friedman@mac.com>,
	"Benjamin R. Haskell" <zsh@benizi.com>,
	Zsh Users <zsh-users@sunsite.dk>
References: <c4e763ac0808062357g44f7b75amf30db12fc1535409@mail.gmail.com> <alpine.LNX.1.10.0808070254580.26055@elation.Princeton.EDU> <c4e763ac0808070020r595f3b64u38eeefbc37bc85b6@mail.gmail.com> <alpine.LNX.1.10.0808070327310.26055@elation.Princeton.EDU> <c4e763ac0808070152k2846913dn4b637fe9ea275ef2@mail.gmail.com> <alpine.LNX.1.10.0808070509320.26055@elation.Princeton.EDU> <19AAE650-59D0-4C1D-A26B-A7761B4C05BC@mac.com>
MIME-Version: 1.0
Content-Type: multipart/signed; micalg=pgp-ripemd160;
	protocol="application/pgp-signature"; boundary="envbJBWh7q8WU6mo"
Content-Disposition: inline
In-Reply-To: <19AAE650-59D0-4C1D-A26B-A7761B4C05BC@mac.com>
X-Virus-Scanned: ClamAV 0.92.1/7999/Sun Aug 10 13:05:47 2008 on bifrost
X-Virus-Status: Clean


--envbJBWh7q8WU6mo
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
Content-Transfer-Encoding: quoted-printable

On 2008-08-08 at 11:16 -0700, Eric D. Friedman wrote:
> I was the original poster with that long completion pause and none of =20
> the suggested solutions actually worked out.  Following the advice in =20
> this thread, I ran a shell with -l -x on and captured the relavant =20
> bits.

Working in an NFS/LDAP/Kerberos environment with a largish number of
users (>10k), I periodically have to debug "what's gone wrong now?".

In ~/.zshenv I set:
----------------------------8< cut here >8------------------------------
[[ -n $TRACE_ZSH_TIME ]] && PS4=3D'+[%D{%M:%S}]%N:%i> '
if [[ -n $TRACE_ZSH ]]; then
        [[ -n "$TRACE_ZSH_FILE" ]] && exec 2> "${TRACE_ZSH_FILE}"
        setopt xtrace
fi
----------------------------8< cut here >8------------------------------

% TRACE_ZSH_TIME=3Dt TRACE_ZSH=3Dt TRACE_ZSH_FILE=3D$HOME/ztrace.out zsh

This is often informative.

>        The big pause occurs at the last line in the following.  Any =20
> ideas as to what else I could try? My goal is to not have the =20
> completion system show me every user in my company's home dir when I =20
> do the first cd<TAB>; I'd never use that completion and it takes far =20
> too long to get it anyway.
[...]
> +_all_labels:39> compadd -F _comp_ignore -J -default- -qS/ -k userdirs

Various things I tried were never sufficient, as userdirs would always
get populated somehow.  Until I cheated.

The short version: ensure that 'userdirs' is a local variable inside the
completion system, populated with the values you want.  I do this by
adding to $_comp_setup -- making sure that none of the rest of the
things that hit LDAP cause slow-downs have led to what I have below.

I keep the users I want to tab-complete in a file, ~/.userdirs and then
hack things so that only that is used.  My code uses zfilter_comments()
which is a function I frequently use to pull in files for data and skip
comments, etc.  Comments in files are handy, reading those files
efficiently in zsh also handy.

The main things are to avoid the automatic population of userdirs when
it's empty and to ensure that things like ssh, scp, etc don't hit LDAP
either.  I have ~/.sshusers contain things like my own usercode, "root"
and various production accounts.  ~/.sshhosts contains hostnames.

Note that I have "users whose home-directories I care about" and "users
I ssh to the accounts of" and these are very different; the former
includes colleagues and the latter includes role accounts.  Because of
this split, we have the loop setting completion of users to $sshusers
for only some commands.  Hrm, wonder why 'users' is used, not
'accounts'?

Note that using "zstyle -e" and "reply=3D($array)" lets me modify the
array at run-time and have it immediately affect completion.

"is-at-least" is one of the Misc/ functions provided, I autoload it
before this point.

I make sure that I split up the completion dumps by host since different
hosts have different versions of zsh, etc etc, so I don't want that
continually getting trashed within NFS.

Here's hoping that I'm not missing anything relevant when looking over
my config now.  Believe it or not, this is simplified.

----------------------------8< cut here >8------------------------------
function zfilter_comments {
        local f infile=3D"$1"
        while read f; do
                [[ -n ${f%%[$' \t']*\#*} && ${f#[#;]} =3D=3D $f ]] || conti=
nue=20
                print -r -- ${f%%[$' \t']*\#*}=20
        done < "$infile"
}

typeset -a sshhosts sshusers
[[ -f ~/.sshhosts ]] && sshhosts=3D( $(zfilter_comments ~/.sshhosts) )
[[ -f ~/.sshusers ]] && sshusers=3D( $(zfilter_comments ~/.sshusers) )

local c
for c in ssh rsync sftp scp slogin
do
        [[ ${#sshhosts} -gt 0 ]] && \
          zstyle -e ':completion:*:'"$c"':*' hosts 'reply=3D($sshhosts)'
        [[ ${#sshusers} -gt 0 ]] && \
          zstyle -e ':completion:*:'"$c"':*' users 'reply=3D($sshusers)'
done
unset c

zstyle -e ':completion:*' my-accounts 'reply=3D($sshusers)'
zstyle ':completion:*' other-accounts ''
zstyle -e ':completion:*' accounts 'reply=3D($sshusers)'

function reset_userdirs {
# There is a zsh internal map, userdirs, exposed by zsh/parameter;
# it's read-only though.
	[[ -f ~/.userdirs ]] || return
	local _u
	local -a _ud
	_ud=3D( $(zfilter_comments ~/.userdirs) )
	for _u in $_ud; do hash -d $_u=3D"/home/$_u"; done
}

if is-at-least 4.2.0; then autoload -Uz compinit ; else autoload -U compini=
t ; fi
[[ -d "${ZDOTDIR:-$HOME}/.zcompdumps" ]] || mkdir -m 0700 -p "${ZDOTDIR:-$H=
OME}/.zcompdumps"
compinit -u -d "${ZDOTDIR:-$HOME}/.zcompdumps/${HOST%%.*}"

# Hack to turn off userdirs completion by overriding userdirs.
# This overrides userdirs as a local variable inside the completion
# system, not touching the global variable.  We don't need to load
# zsh/parameter to achieve this.
_comp_setup+=3D$'\ntypeset -a userdirs\nreset_userdirs'
reset_userdirs
----------------------------8< cut here >8------------------------------

-Phil

--envbJBWh7q8WU6mo
Content-Type: application/pgp-signature
Content-Disposition: inline

-----BEGIN PGP SIGNATURE-----

iEYEAREDAAYFAkie5xsACgkQQDBDFTkDY3+1AACdH33jz7KBR7rnA/1ivk/mA2Qt
PXkAni3hN8SlZ3/gMxRW1tmB2dh8/agd
=bLXL
-----END PGP SIGNATURE-----

--envbJBWh7q8WU6mo--

