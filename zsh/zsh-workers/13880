From zsh-workers-return-13880-mason-zsh=primenet.com.au@sunsite.dk Mon Apr 02 14:35:42 2001
Return-Path: <zsh-workers-return-13880-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 2141 invoked from network); 2 Apr 2001 14:35:40 -0000
Received: from sunsite.dk (130.225.51.30)
  by ns1.primenet.com.au with SMTP; 2 Apr 2001 14:35:40 -0000
Received: (qmail 17890 invoked by alias); 2 Apr 2001 14:35:34 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 13880
Received: (qmail 17879 invoked from network); 2 Apr 2001 14:35:34 -0000
Date: Mon, 2 Apr 2001 16:35:33 +0200 (MET DST)
Message-Id: <200104021435.QAA12732@beta.informatik.hu-berlin.de>
From: Sven Wischnowsky <wischnow@informatik.hu-berlin.de>
To: zsh-workers@sunsite.dk
In-reply-to: =?iso-8859-1?q?Oliver=20Kiddle?='s message of Mon, 2 Apr 2001
	15:01:41 +0100 (BST)
Subject: PATCH: Re: Functions moved


Oliver Kiddle wrote:

> ...
>
> > - Configure-stuff: I hope to have got everything right so that one
> >   directory-level from the completion directories is removed on
> >   installation (all Zsh/*/* functions are installed under Zsh/).  We
> 
> A few things aren't quite right. I did configure with
> --enable-function-subdirs. I got some old directories (User, Bsd,
> Builtins) - we should be able to remove them.

You probably was a bit faster than me removing the .distfiles in those 
directories and the directories themselves.  Or maybe you aren't using 
cvs update with -P (I think it was -P).  But anyway.  I've now
discovered why Peter had to type all thos directories in
complete.mmd.  They are used when building zshpaths.h... the $fpath
problem.

The patch below should fix this and...

> compinit, compdump etc
> got placed in their very own subdirectory and $fpath is wrong.

this.  Once you've made zshpaths.h be re-build (and config.modules on
which building zshpaths.h relies).

> Should I
> not have used --enable-function-subdirs?

As I tried to write, this should have worked.


Bye
 Sven

P.S.: It seems that I also forgot to cvs add the two files:
       Completion/Unix/Type/_dict_words and Functions/Compctl/.distfiles.


Index: Config/installfns.sh
===================================================================
RCS file: /cvsroot/zsh/zsh/Config/installfns.sh,v
retrieving revision 1.5
diff -u -r1.5 installfns.sh
--- Config/installfns.sh	2001/04/02 13:04:05	1.5
+++ Config/installfns.sh	2001/04/02 14:32:48
@@ -15,6 +15,10 @@
   if test -f $sdir_top/$file; then
     if test x$FUNCTIONS_SUBDIRS != x -a x$FUNCTIONS_SUBDIRS != xno; then
       case "$file" in
+      Completion/comp*)
+        subdir="`echo $file | sed -e 's%/[^/]*/[^/]*$%%'`"
+        instdir="$fndir/Completion"
+        ;;
       Completion/*)
         subdir="`echo $file | sed -e 's%/[^/]*/[^/]*$%%'`"
         instdir="$fndir/$subdir"
Index: Src/zsh.mdd
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/zsh.mdd,v
retrieving revision 1.6
diff -u -r1.6 zsh.mdd
--- Src/zsh.mdd	2000/12/04 19:21:09	1.6
+++ Src/zsh.mdd	2001/04/02 14:32:48
@@ -49,7 +49,7 @@
 	    $(dir_top)/config.modules | sed -e '/^#/d' -e '/ link=no/d' \
 	    -e 's/^.* functions=//'`"; \
 	    fpath_tmp=`for f in $$fpath_tmp; do \
-	      echo $$f | sed -e 's%^Functions/%%' -e 's%/[^/]*$$%%'; \
+	      echo $$f | sed -e 's%^Functions/%%' -e 's%/[^/]*$$%%' -e 's%/\*%%'; \
 	    done | sort | uniq`; \
 	    fpath_tmp=`echo $$fpath_tmp | sed 's/ /\", \"/g'`; \
 	    echo "#define FPATH_SUBDIRS { \"$$fpath_tmp\" }" \

--
Sven Wischnowsky                         wischnow@informatik.hu-berlin.de

