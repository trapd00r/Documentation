From zsh-users-return-12100-mason-zsh=primenet.com.au@sunsite.dk Wed Oct 24 15:10:31 2007
Return-Path: <zsh-users-return-12100-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 26814 invoked from network); 24 Oct 2007 15:10:22 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.3 (2007-08-08) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.3
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 24 Oct 2007 15:10:22 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 26481 invoked from network); 24 Oct 2007 15:10:15 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 24 Oct 2007 15:10:15 -0000
Received: (qmail 14041 invoked by alias); 24 Oct 2007 15:10:07 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 12100
Received: (qmail 13998 invoked from network); 24 Oct 2007 15:10:04 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 24 Oct 2007 15:10:04 -0000
Received: (qmail 25078 invoked from network); 24 Oct 2007 15:10:04 -0000
Received: from cluster-g.mailcontrol.com (85.115.41.190)
  by a.mx.sunsite.dk with SMTP; 24 Oct 2007 15:09:54 -0000
Received: from cameurexb01.EUROPE.ROOT.PRI ([62.189.241.200])
	by rly01g.srv.mailcontrol.com (MailControl) with ESMTP id l9OF98K9032248
	for <zsh-users@sunsite.dk>; Wed, 24 Oct 2007 16:09:42 +0100
Received: from news01.csr.com ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.1830);
	 Wed, 24 Oct 2007 16:09:34 +0100
Received: from news01.csr.com (localhost.localdomain [127.0.0.1])
	by news01.csr.com (8.14.1/8.13.4) with ESMTP id l9OF9Yux028028
	for <zsh-users@sunsite.dk>; Wed, 24 Oct 2007 16:09:34 +0100
Received: from csr.com (pws@localhost)
	by news01.csr.com (8.14.1/8.14.1/Submit) with ESMTP id l9OF9Ybg028025
	for <zsh-users@sunsite.dk>; Wed, 24 Oct 2007 16:09:34 +0100
Message-Id: <200710241509.l9OF9Ybg028025@news01.csr.com>
X-Authentication-Warning: news01.csr.com: pws owned process doing -bs
To: "Zsh Users" <zsh-users@sunsite.dk>
Subject: Re: Completion problems on cygwin when nocaseglob is set
In-reply-to: <20a807210710240701w1f83e299k8dfcf6e658adffff@mail.gmail.com>
References: <DD74FBB8EE28D441903D56487861CD9D223A0DF0@lonpexch01.citrite.net> <DD74FBB8EE28D441903D56487861CD9D224E86E7@lonpexch01.citrite.net> <20071022123128.2db6000c@news01> <DD74FBB8EE28D441903D56487861CD9D224E8A05@lonpexch01.citrite.net> <20071023101151.3757a369@news01> <DD74FBB8EE28D441903D56487861CD9D225F6432@lonpexch01.citrite.net> <200710231156.l9NBuQwA019246@news01.csr.com> <DD74FBB8EE28D441903D56487861CD9D225F6859@lonpexch01.citrite.net> <20071023165708.41f29476@news01> <DD74FBB8EE28D441903D56487861CD9D22719439@lonpexch01.citrite.net> <20a807210710240701w1f83e299k8dfcf6e658adffff@mail.gmail.com>
Comments: In-reply-to "Vin Shelton" <acs@alumni.princeton.edu>
   message dated "Wed, 24 Oct 2007 10:01:52 -0400."
Date: Wed, 24 Oct 2007 16:09:34 +0100
From: Peter Stephenson <pws@csr.com>
X-OriginalArrivalTime: 24 Oct 2007 15:09:34.0592 (UTC) FILETIME=[E2F3E000:01C8164F]
X-Scanned-By: MailControl A-07-08-10 (www.mailcontrol.com) on 10.71.0.111

"Vin Shelton" wrote:
> I'm very confused.  Running zsh built from the latest CVS sources,
> here's what I see:

... even with NO_CASE_GLOB set, completion doesn't match
case-insensitively unless there's a matcher spec to do it.

Oh dear, I hate it when people are confused about completion because
that invariably means a hard time.

It looks like _path_files is doing the right thing internally (via
compfiles, which understands glob settings), but it then passes the
matched string to compadd without the -U flag, which says "sorry mate,
it's more than my job's worth to match case-insensitively".  _path_files
does most of its file handling itself or via compfiles, but it doesn't
do the special matching stuff, hence we can't pass -U in that case.

We could make a rule that we use case-insensitive matching with
NO_CASE_GLOB unless an explicit matcher spec is in force, I suppose, but
we can't actually have the combined effect of nocaseglob and matchers
without either some kind of internal rewrite, or editing the matchers
passed down through _path_files.  If the former is acceptable, this is
fairly straightforward.

Index: Completion/Unix/Type/_path_files
===================================================================
RCS file: /cvsroot/zsh/zsh/Completion/Unix/Type/_path_files,v
retrieving revision 1.25
diff -u -r1.25 _path_files
--- Completion/Unix/Type/_path_files	7 Mar 2006 12:52:27 -0000	1.25
+++ Completion/Unix/Type/_path_files	24 Oct 2007 15:08:14 -0000
@@ -101,7 +101,16 @@
   (( $mopts[(I)-F] )) || mopts=( "$mopts[@]" -F _comp_ignore )
 fi
 
-(( $#matcher )) && mopts=( "$mopts[@]" "$matcher[@]" )
+if [[ $#matcher -eq 0 && -o nocaseglob ]]; then
+  # If globbing is case insensitive and there's no matcher,
+  # do case-insensitive matching.
+  matcher=( -M 'm:{a-zA-Z}={A-Za-z}' )
+fi
+
+if (( $#matcher )); then
+  # Add the current matcher to the options to compadd.
+  mopts=( "$mopts[@]" "$matcher[@]" )
+fi
 
 if zstyle -s ":completion:${curcontext}:" file-sort tmp1; then
   case "$tmp1" in
Index: Doc/Zsh/compsys.yo
===================================================================
RCS file: /cvsroot/zsh/zsh/Doc/Zsh/compsys.yo,v
retrieving revision 1.202
diff -u -r1.202 compsys.yo
--- Doc/Zsh/compsys.yo	19 Jun 2007 09:28:06 -0000	1.202
+++ Doc/Zsh/compsys.yo	24 Oct 2007 15:08:22 -0000
@@ -1968,6 +1968,11 @@
 one to three strings will give acceptable performance.  On the other
 hand, putting multiple space-separated values into the same string does
 not have an appreciable impact on performance.
+
+If there is no current matcher or it is empty, and the option
+tt(NO_CASE_GLOB) is in effect, the matching for files is performed
+case-insensitively in any case.  However, any matcher must
+explicitly specify case-insensitive matching if that is required.
 )
 kindex(max-errors, completion style)
 item(tt(max-errors))(

-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070

