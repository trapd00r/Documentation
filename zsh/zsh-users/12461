From zsh-users-return-12461-mason-zsh=primenet.com.au@sunsite.dk Sat Jan 19 19:34:09 2008
Return-Path: <zsh-users-return-12461-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 17444 invoked from network); 19 Jan 2008 19:34:07 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.4 (2008-01-01) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.4
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 19 Jan 2008 19:34:07 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 56384 invoked from network); 19 Jan 2008 19:33:47 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 19 Jan 2008 19:33:47 -0000
Received: (qmail 25254 invoked by alias); 19 Jan 2008 19:33:36 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 12461
Received: (qmail 25234 invoked from network); 19 Jan 2008 19:33:35 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 19 Jan 2008 19:33:35 -0000
Received: from virusfilter.dotsrc.org (bifrost [127.0.0.1])
	by spamfilter.dotsrc.org (Postfix) with ESMTP id 3D3B0808B2B9
	for <zsh-users@sunsite.dk>; Sat, 19 Jan 2008 20:33:31 +0100 (CET)
Received: from mtaout02-winn.ispmail.ntl.com (mtaout02-winn.ispmail.ntl.com [81.103.221.48])
	by bifrost.dotsrc.org (Postfix) with ESMTP
	for <zsh-users@sunsite.dk>; Sat, 19 Jan 2008 20:33:31 +0100 (CET)
Received: from aamtaout02-winn.ispmail.ntl.com ([81.103.221.35])
          by mtaout02-winn.ispmail.ntl.com with ESMTP
          id <20080119193450.UGUB6054.mtaout02-winn.ispmail.ntl.com@aamtaout02-winn.ispmail.ntl.com>
          for <zsh-users@sunsite.dk>; Sat, 19 Jan 2008 19:34:50 +0000
Received: from pws-pc ([81.107.42.63]) by aamtaout02-winn.ispmail.ntl.com
          with SMTP
          id <20080119193427.YPHM17393.aamtaout02-winn.ispmail.ntl.com@pws-pc>
          for <zsh-users@sunsite.dk>; Sat, 19 Jan 2008 19:34:27 +0000
Date: Sat, 19 Jan 2008 19:32:32 +0000
From: Peter Stephenson <p.w.stephenson@ntlworld.com>
To: "zsh users" <zsh-users@sunsite.dk>
Subject: Re: Bug in umount completion
Message-Id: <20080119193232.450595d9.p.w.stephenson@ntlworld.com>
In-Reply-To: <2d460de70801181400vc04d907va3bfa29fd468306a@mail.gmail.com>
References: <2d460de70801181400vc04d907va3bfa29fd468306a@mail.gmail.com>
X-Mailer: Sylpheed 2.4.7 (GTK+ 2.12.3; x86_64-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
X-Virus-Scanned: ClamAV using ClamSMTP

On Fri, 18 Jan 2008 23:00:32 +0100
"Richard Hartmann" <richih.mailinglist@gmail.com> wrote:
> zsh 4.3.4 fails to fully escape mounted directories.
 
Yes, I suspect there are a lot of places where you don't usually
get special characters in names for which completions aren't quoted
properly.

> As an aside, the whitespace is completed as \040 which is also strange.

This is a low-level feature of Linux so that when the "mount" arguments
are split the space doesn't confuse matters.  I've fixed this so that it
handles octal escapes generally; this may well be overkill and it would
have been much simpler and quite possibly good enough just to replace
\040.  I don't know how far the \OOO trick has spread, and I've assumed
it's more useful to handle that everywhere and run the small risk of
real filenames of that form than limit the fix to Linux.

I've added the quoting to devices as well as mount points; it's unlikely
to be needed, but it's at least harmless.  I haven't tried applying the
octal escape hackery to devices.

As you'll see, I've add a simplified explanation of how I fixed the
octal escapes.

Index: Completion/Unix/Command/_mount
===================================================================
RCS file: /cvsroot/zsh/zsh/Completion/Unix/Command/_mount,v
retrieving revision 1.26
diff -u -r1.26 _mount
--- Completion/Unix/Command/_mount	28 Nov 2007 17:28:57 -0000	1.26
+++ Completion/Unix/Command/_mount	19 Jan 2008 19:23:23 -0000
@@ -867,8 +867,27 @@
     ;;
   esac
 
-  dpath_tmp=( "${(@M)dev_tmp:#/*}" )
-  dev_tmp=( "${(@)dev_tmp:#/*}" )
+  # "Mummy, why is mount point matching full of squiggles?"
+  #
+  # "Well, dear, the clever people who wrote Linux decided that some
+  # funny characters that might confuse programmes looking at the names
+  # would be encoded as octal escapes, like for example \040 for space.
+  # The clever people who wrote zsh decided that nothing would
+  # ever be quite as simple as it should be, so to substitute octal
+  # escapes everywhere in a string, even though the shell understands
+  # them natively in print escapes, needs some hackery where you match
+  # the octal number using the numeric closure syntax introduced after
+  # 4.3.4, then reinput the number in a standard math mode format as 8#OOO,
+  # and turn that into a character using the (#) parameter flag."
+  #
+  # "Mummy, why is nothing ever quite as simple as it should be?"
+  #
+  # "Well, dear, if it was then the clever people who write programmes would
+  # have been replaced by intelligent monkeys and then they'd be out
+  # of working roaming the streets, and we wouldn't want that, would we?"
+  mp_tmp=("${(@q)mp_tmp//(#m)\\[0-7](#c3)/${(#)$(( 8#${MATCH[2,-1]} ))}}")
+  dpath_tmp=( "${(@Mq)dev_tmp:#/*}" )
+  dev_tmp=( "${(@q)dev_tmp:#/*}" )
 
   _alternative \
     'device-labels:device label:compadd -a dev_tmp' \

-- 
Peter Stephenson <p.w.stephenson@ntlworld.com>
Web page now at http://homepage.ntlworld.com/p.w.stephenson/

