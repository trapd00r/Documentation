<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html>
<head>
  <meta name="generator" content=
  "HTML Tidy for Linux (vers 25 March 2009), see www.w3.org">
  <meta http-equiv="Content-Type" content=
  "text/html; charset=utf-8">

  <title>Git Magic - Chapter&nbsp;8.&nbsp;Secrets Revealed</title>
  <link rel="stylesheet" href="default.css" type="text/css">
  <meta name="generator" content="DocBook XSL Stylesheets V1.75.2">
  <link rel="home" href="index.html" title="Git Magic">
  <link rel="up" href="index.html" title="Git Magic">
  <link rel="prev" href="ch07.html" title=
  "Chapter&nbsp;7.&nbsp;Git Grandmastery">
  <link rel="next" href="apa.html" title=
  "Appendix&nbsp;A.&nbsp;Git Shortcomings">
</head>

<body bgcolor="white" text="black" link="#0000FF" vlink="#840084"
alink="#0000FF">
    <div class="toc">
      <ul>
<li><b>Git Magic</b></li>
        <li>
          <span class="preface"><a href=
          "index.html">Preface</a></span>

          <ul>
            <li><span class="section"><a href=
            "index.html#_thanks">Thanks!</a></span></li>

            <li><span class="section"><a href=
            "index.html#_license">License</a></span></li>
          </ul>
        </li>

        <li>
          <span class="chapter"><a href="ch01.html">1.
          Introduction</a></span>

          <ul>
            <li><span class="section"><a href=
            "ch01.html#_work_is_play">Work is Play</a></span></li>

            <li><span class="section"><a href=
            "ch01.html#_version_control">Version
            Control</a></span></li>

            <li><span class="section"><a href=
            "ch01.html#_distributed_control">Distributed
            Control</a></span></li>

            <li><span class="section"><a href=
            "ch01.html#_a_silly_superstition">A Silly
            Superstition</a></span></li>

            <li><span class="section"><a href=
            "ch01.html#_merge_conflicts">Merge
            Conflicts</a></span></li>
          </ul>
        </li>

        <li>
          <span class="chapter"><a href="ch02.html">2. Basic
          Tricks</a></span>

          <ul>
            <li><span class="section"><a href=
            "ch02.html#_saving_state">Saving State</a></span></li>

            <li><span class="section"><a href=
            "ch02.html#_add_delete_rename">Add, Delete,
            Rename</a></span></li>

            <li><span class="section"><a href=
            "ch02.html#_advanced_undo_redo">Advanced
            Undo/Redo</a></span></li>

            <li><span class="section"><a href=
            "ch02.html#_reverting">Reverting</a></span></li>

            <li><span class="section"><a href=
            "ch02.html#_changelog_generation">Changelog
            Generation</a></span></li>

            <li><span class="section"><a href=
            "ch02.html#_downloading_files">Downloading
            Files</a></span></li>

            <li><span class="section"><a href=
            "ch02.html#_the_bleeding_edge">The Bleeding
            Edge</a></span></li>

            <li><span class="section"><a href=
            "ch02.html#_instant_publishing">Instant
            Publishing</a></span></li>

            <li><span class="section"><a href=
            "ch02.html#_what_have_i_done">What Have I
            Done?</a></span></li>

            <li><span class="section"><a href=
            "ch02.html#_exercise">Exercise</a></span></li>
          </ul>
        </li>

        <li>
          <span class="chapter"><a href="ch03.html">3. Cloning
          Around</a></span>

          <ul>
            <li><span class="section"><a href=
            "ch03.html#_sync_computers">Sync
            Computers</a></span></li>

            <li><span class="section"><a href=
            "ch03.html#_classic_source_control">Classic Source
            Control</a></span></li>

            <li><span class="section"><a href=
            "ch03.html#_secret_source">Secret
            Source</a></span></li>

            <li><span class="section"><a href=
            "ch03.html#_bare_repositories">Bare
            repositories</a></span></li>

            <li><span class="section"><a href=
            "ch03.html#_push_versus_pull">Push versus
            pull</a></span></li>

            <li><span class="section"><a href=
            "ch03.html#_forking_a_project">Forking a
            Project</a></span></li>

            <li><span class="section"><a href=
            "ch03.html#_ultimate_backups">Ultimate
            Backups</a></span></li>

            <li><span class="section"><a href=
            "ch03.html#_light_speed_multitask">Light-Speed
            Multitask</a></span></li>

            <li><span class="section"><a href=
            "ch03.html#_guerilla_version_control">Guerilla Version
            Control</a></span></li>

            <li><span class="section"><a href=
            "ch03.html#_mercurial">Mercurial</a></span></li>

            <li><span class="section"><a href=
            "ch03.html#_bazaar">Bazaar</a></span></li>

            <li><span class="section"><a href=
            "ch03.html#_why_i_use_git">Why I use
            Git</a></span></li>
          </ul>
        </li>

        <li>
          <span class="chapter"><a href="ch04.html">4. Branch
          Wizardry</a></span>

          <ul>
            <li><span class="section"><a href=
            "ch04.html#_the_boss_key">The Boss Key</a></span></li>

            <li><span class="section"><a href=
            "ch04.html#_dirty_work">Dirty Work</a></span></li>

            <li><span class="section"><a href=
            "ch04.html#_quick_fixes">Quick Fixes</a></span></li>

            <li><span class="section"><a href=
            "ch04.html#_merging">Merging</a></span></li>

            <li><span class="section"><a href=
            "ch04.html#_uninterrupted_workflow">Uninterrupted
            Workflow</a></span></li>

            <li><span class="section"><a href=
            "ch04.html#_reorganizing_a_medley">Reorganizing a
            Medley</a></span></li>

            <li><span class="section"><a href=
            "ch04.html#_managing_branches">Managing
            Branches</a></span></li>

            <li><span class="section"><a href=
            "ch04.html#_temporary_branches">Temporary
            Branches</a></span></li>

            <li><span class="section"><a href=
            "ch04.html#_work_how_you_want">Work How You
            Want</a></span></li>
          </ul>
        </li>

        <li>
          <span class="chapter"><a href="ch05.html">5. Lessons of
          History</a></span>

          <ul>
            <li><span class="section"><a href=
            "ch05.html#_i_stand_corrected">I Stand
            Corrected</a></span></li>

            <li><span class="section"><a href=
            "ch05.html#_8230_and_then_some">… And Then
            Some</a></span></li>

            <li><span class="section"><a href=
            "ch05.html#_local_changes_last">Local Changes
            Last</a></span></li>

            <li><span class="section"><a href=
            "ch05.html#_rewriting_history">Rewriting
            History</a></span></li>

            <li><span class="section"><a href=
            "ch05.html#_making_history">Making
            History</a></span></li>

            <li><span class="section"><a href=
            "ch05.html#_where_did_it_all_go_wrong">Where Did It All
            Go Wrong?</a></span></li>

            <li><span class="section"><a href=
            "ch05.html#_who_made_it_all_go_wrong">Who Made It All
            Go Wrong?</a></span></li>

            <li><span class="section"><a href=
            "ch05.html#_personal_experience">Personal
            Experience</a></span></li>
          </ul>
        </li>

        <li>
          <span class="chapter"><a href="ch06.html">6. Multiplayer
          Git</a></span>

          <ul>
            <li><span class="section"><a href=
            "ch06.html#_who_am_i">Who Am I?</a></span></li>

            <li><span class="section"><a href=
            "ch06.html#_git_over_ssh_http">Git Over SSH,
            HTTP</a></span></li>

            <li><span class="section"><a href=
            "ch06.html#_git_over_anything">Git Over
            Anything</a></span></li>

            <li><span class="section"><a href=
            "ch06.html#_patches_the_global_currency">Patches: The
            Global Currency</a></span></li>

            <li><span class="section"><a href=
            "ch06.html#_sorry_we_8217_ve_moved">Sorry, We’ve
            Moved</a></span></li>

            <li><span class="section"><a href=
            "ch06.html#_remote_branches">Remote
            Branches</a></span></li>

            <li><span class="section"><a href=
            "ch06.html#_multiple_remotes">Multiple
            Remotes</a></span></li>

            <li><span class="section"><a href=
            "ch06.html#_my_preferences">My
            Preferences</a></span></li>
          </ul>
        </li>

        <li>
          <span class="chapter"><a href="ch07.html">7. Git
          Grandmastery</a></span>

          <ul>
            <li><span class="section"><a href=
            "ch07.html#_source_releases">Source
            Releases</a></span></li>

            <li><span class="section"><a href=
            "ch07.html#_commit_what_changed">Commit What
            Changed</a></span></li>

            <li><span class="section"><a href=
            "ch07.html#_my_commit_is_too_big">My Commit Is Too
            Big!</a></span></li>

            <li><span class="section"><a href=
            "ch07.html#_the_index_git_8217_s_staging_area">The
            Index: Git’s Staging Area</a></span></li>

            <li><span class="section"><a href=
            "ch07.html#_don_8217_t_lose_your_head">Don’t Lose Your
            HEAD</a></span></li>

            <li><span class="section"><a href=
            "ch07.html#_head_hunting">HEAD-hunting</a></span></li>

            <li><span class="section"><a href=
            "ch07.html#_building_on_git">Building On
            Git</a></span></li>

            <li><span class="section"><a href=
            "ch07.html#_daring_stunts">Daring
            Stunts</a></span></li>

            <li><span class="section"><a href=
            "ch07.html#_preventing_bad_commits">Preventing Bad
            Commits</a></span></li>
          </ul>
        </li>

        <li>
          <span class="chapter"><a href="ch08.html">8. Secrets
          Revealed</a></span>

          <ul>
            <li><span class="section"><a href=
            "ch08.html#_invisibility">Invisibility</a></span></li>

            <li><span class="section"><a href=
            "ch08.html#_integrity">Integrity</a></span></li>

            <li><span class="section"><a href=
            "ch08.html#_intelligence">Intelligence</a></span></li>

            <li><span class="section"><a href=
            "ch08.html#_indexing">Indexing</a></span></li>

            <li><span class="section"><a href=
            "ch08.html#_git_8217_s_origins">Git’s
            Origins</a></span></li>

            <li><span class="section"><a href=
            "ch08.html#_the_object_database">The Object
            Database</a></span></li>

            <li><span class="section"><a href=
            "ch08.html#_blobs">Blobs</a></span></li>

            <li><span class="section"><a href=
            "ch08.html#_trees">Trees</a></span></li>

            <li><span class="section"><a href=
            "ch08.html#_commits">Commits</a></span></li>

            <li><span class="section"><a href=
            "ch08.html#_indistinguishable_from_magic">Indistinguishable
            From Magic</a></span></li>
          </ul>
        </li>

        <li>
          <span class="appendix"><a href="apa.html">A. Git
          Shortcomings</a></span>

          <ul>
            <li><span class="section"><a href=
            "apa.html#_sha1_weaknesses">SHA1
            Weaknesses</a></span></li>

            <li><span class="section"><a href=
            "apa.html#_microsoft_windows">Microsoft
            Windows</a></span></li>

            <li><span class="section"><a href=
            "apa.html#_unrelated_files">Unrelated
            Files</a></span></li>

            <li><span class="section"><a href=
            "apa.html#_who_8217_s_editing_what">Who’s Editing
            What?</a></span></li>

            <li><span class="section"><a href=
            "apa.html#_file_history">File History</a></span></li>

            <li><span class="section"><a href=
            "apa.html#_initial_clone">Initial Clone</a></span></li>

            <li><span class="section"><a href=
            "apa.html#_volatile_projects">Volatile
            Projects</a></span></li>

            <li><span class="section"><a href=
            "apa.html#_global_counter">Global
            Counter</a></span></li>

            <li><span class="section"><a href=
            "apa.html#_empty_subdirectories">Empty
            Subdirectories</a></span></li>

            <li><span class="section"><a href=
            "apa.html#_initial_commit">Initial
            Commit</a></span></li>

            <li><span class="section"><a href=
            "apa.html#_interface_quirks">Interface
            Quirks</a></span></li>
          </ul>
        </li>

        <li><span class="appendix"><a href="apb.html">B.
        Translating This Guide</a></span></li>
      </ul>
    </div>
<div class="content">
  <div class="chapter" title=
  "Chapter&nbsp;8.&nbsp;Secrets Revealed">
    <div class="titlepage">
      <div>
        <div>
          <h2 class="title"><a name=
          "_secrets_revealed"></a>Chapter&nbsp;8.&nbsp;Secrets
          Revealed</h2>
        </div>
      </div>
    </div>

    <p>We take a peek under the hood and explain how Git performs
    its miracles. I will skimp over details. For in-depth
    descriptions refer to <a class="ulink" href=
    "http://schacon.github.com/git/user-manual.html" target=
    "_top">the user manual</a>.</p>

    <div class="section" title="Invisibility">
      <div class="titlepage">
        <div>
          <div>
            <h2 class="title"><a name=
            "_invisibility"></a>Invisibility</h2>
          </div>
        </div>
      </div>

      <p>How can Git be so unobtrusive? Aside from occasional
      commits and merges, you can work as if you were unaware that
      version control exists. That is, until you need it, and
      that’s when you’re glad Git was watching over you the whole
      time.</p>

      <p>Other version control systems force you to constantly
      struggle with red tape and bureaucracy. Permissions of files
      may be read-only unless you explicitly tell a central server
      which files you intend to edit. The most basic commands may
      slow to a crawl as the number of users increases. Work grinds
      to a halt when the network or the central server goes
      down.</p>

      <p>In contrast, Git simply keeps the history of your project
      in the <code class="literal">.git</code> directory in your
      working directory. This is your own copy of the history, so
      you can stay offline until you want to communicate with
      others. You have total control over the fate of your files
      because Git can easily recreate a saved state from
      <code class="literal">.git</code> at any time.</p>
    </div>

    <div class="section" title="Integrity">
      <div class="titlepage">
        <div>
          <div>
            <h2 class="title"><a name=
            "_integrity"></a>Integrity</h2>
          </div>
        </div>
      </div>

      <p>Most people associate cryptography with keeping
      information secret, but another equally important goal is
      keeping information safe. Proper use of cryptographic hash
      functions can prevent accidental or malicious data
      corruption.</p>

      <p>A SHA1 hash can be thought of as a unique 160-bit ID
      number for every string of bytes you’ll encounter in your
      life. Actually more than that: every string of bytes that any
      human will ever use over many lifetimes.</p>

      <p>As a SHA1 hash is itself a string of bytes, we can hash
      strings of bytes containing other hashes. This simple
      observation is surprisingly useful: look up <span class=
      "emphasis"><em>hash chains</em></span>. We’ll later see how
      Git uses it to efficiently guarantee data integrity.</p>

      <p>Briefly, Git keeps your data in the <code class=
      "literal">.git/objects</code> subdirectory, where instead of
      normal filenames, you’ll find only IDs. By using IDs as
      filenames, as well as a few lockfiles and timestamping
      tricks, Git transforms any humble filesystem into an
      efficient and robust database.</p>
    </div>

    <div class="section" title="Intelligence">
      <div class="titlepage">
        <div>
          <div>
            <h2 class="title"><a name=
            "_intelligence"></a>Intelligence</h2>
          </div>
        </div>
      </div>

      <p>How does Git know you renamed a file, even though you
      never mentioned the fact explicitly? Sure, you may have run
      <span class="strong"><strong>git mv</strong></span>, but that
      is exactly the same as a <span class="strong"><strong>git
      rm</strong></span> followed by a <span class=
      "strong"><strong>git add</strong></span>.</p>

      <p>Git heuristically ferrets out renames and copies between
      successive versions. In fact, it can detect chunks of code
      being moved or copied around between files! Though it cannot
      cover all cases, it does a decent job, and this feature is
      always improving. If it fails to work for you, try options
      enabling more expensive copy detection, and consider
      upgrading.</p>
    </div>

    <div class="section" title="Indexing">
      <div class="titlepage">
        <div>
          <div>
            <h2 class="title"><a name="_indexing"></a>Indexing</h2>
          </div>
        </div>
      </div>

      <p>For every tracked file, Git records information such as
      its size, creation time and last modification time in a file
      known as the <span class="emphasis"><em>index</em></span>. To
      determine whether a file has changed, Git compares its
      current stats with those cached in the index. If they match,
      then Git can skip reading the file again.</p>

      <p>Since stat calls are considerably faster than file reads,
      if you only edit a few files, Git can update its state in
      almost no time.</p>

      <p>We stated earlier that the index is a staging area. Why is
      a bunch of file stats a staging area? Because the add command
      puts files into Git’s database and updates these stats, while
      the commit command, without options, creates a commit based
      only on these stats and the files already in the
      database.</p>
    </div>

    <div class="section" title="Git’s Origins">
      <div class="titlepage">
        <div>
          <div>
            <h2 class="title"><a name=
            "_git_8217_s_origins"></a>Git’s Origins</h2>
          </div>
        </div>
      </div>

      <p>This <a class="ulink" href=
      "http://lkml.org/lkml/2005/4/6/121" target="_top">Linux
      Kernel Mailing List post</a> describes the chain of events
      that led to Git. The entire thread is a fascinating
      archaeological site for Git historians.</p>
    </div>

    <div class="section" title="The Object Database">
      <div class="titlepage">
        <div>
          <div>
            <h2 class="title"><a name=
            "_the_object_database"></a>The Object Database</h2>
          </div>
        </div>
      </div>

      <p>Every version of your data is kept in the <span class=
      "emphasis"><em>object database</em></span>, which lives in
      the subdirectory <code class="literal">.git/objects</code>;
      the other residents of <code class="literal">.git/</code>
      hold lesser data: the index, branch names, tags,
      configuration options, logs, the current location of the head
      commit, and so on. The object database is elementary yet
      elegant, and the source of Git’s power.</p>

      <p>Each file within <code class="literal">.git/objects</code>
      is an <span class="emphasis"><em>object</em></span>. There
      are 3 kinds of objects that concern us: <span class=
      "emphasis"><em>blob</em></span> objects, <span class=
      "emphasis"><em>tree</em></span> objects, and <span class=
      "emphasis"><em>commit</em></span> objects.</p>
    </div>

    <div class="section" title="Blobs">
      <div class="titlepage">
        <div>
          <div>
            <h2 class="title"><a name="_blobs"></a>Blobs</h2>
          </div>
        </div>
      </div>

      <p>First, a magic trick. Pick a filename, any filename. In an
      empty directory:</p>
      <pre class="literallayout">
$ echo sweet &gt; YOUR_FILENAME
$ git init
$ git add .
$ find .git/objects -type f
</pre>

      <p>You’ll see <code class=
      "literal">.git/objects/aa/823728ea7d592acc69b36875a482cdf3fd5c8d</code>.</p>

      <p>How do I know this without knowing the filename? It’s
      because the SHA1 hash of:</p>
      <pre class="literallayout">
"blob" SP "6" NUL "sweet" LF
</pre>

      <p>is aa823728ea7d592acc69b36875a482cdf3fd5c8d, where SP is a
      space, NUL is a zero byte and LF is a linefeed. You can
      verify this by typing:</p>
      <pre class="literallayout">
$ printf "blob 6\000sweet\n" | sha1sum
</pre>

      <p>Git is <span class=
      "emphasis"><em>content-addressable</em></span>: files are not
      stored according to their filename, but rather by the hash of
      the data they contain, in a file we call a <span class=
      "emphasis"><em>blob object</em></span>. We can think of the
      hash as a unique ID for a file’s contents, so in a sense we
      are addressing files by their content. The initial
      <code class="literal">blob 6</code> is merely a header
      consisting of the object type and its length in bytes; it
      simplifies internal bookkeeping.</p>

      <p>Thus I could easily predict what you would see. The file’s
      name is irrelevant: only the data inside is used to construct
      the blob object.</p>

      <p>You may be wondering what happens to identical files. Try
      adding copies of your file, with any filenames whatsoever.
      The contents of <code class="literal">.git/objects</code>
      stay the same no matter how many you add. Git only stores the
      data once.</p>

      <p>By the way, the files within <code class=
      "literal">.git/objects</code> are compressed with zlib so you
      should not stare at them directly. Filter them through
      <a class="ulink" href="http://www.zlib.net/zpipe.c" target=
      "_top">zpipe -d</a>, or type:</p>
      <pre class="literallayout">
$ git cat-file -p aa823728ea7d592acc69b36875a482cdf3fd5c8d
</pre>

      <p>which pretty-prints the given object.</p>
    </div>

    <div class="section" title="Trees">
      <div class="titlepage">
        <div>
          <div>
            <h2 class="title"><a name="_trees"></a>Trees</h2>
          </div>
        </div>
      </div>

      <p>But where are the filenames? They must be stored somewhere
      at some stage. Git gets around to the filenames during a
      commit:</p>
      <pre class="literallayout">
$ git commit  # Type some message.
$ find .git/objects -type f
</pre>

      <p>You should now see 3 objects. This time I cannot tell you
      what the 2 new files are, as it partly depends on the
      filename you picked. We’ll proceed assuming you chose “rose”.
      If you didn’t, you can rewrite history to make it look like
      you did:</p>
      <pre class="literallayout">
$ git filter-branch --tree-filter 'mv YOUR_FILENAME rose'
$ find .git/objects -type f
</pre>

      <p>Now you should see the file <code class=
      "literal">.git/objects/05/b217bb859794d08bb9e4f7f04cbda4b207fbe9</code>,
      because this is the SHA1 hash of its contents:</p>
      <pre class="literallayout">
"tree" SP "32" NUL "100644 rose" NUL 0xaa823728ea7d592acc69b36875a482cdf3fd5c8d
</pre>

      <p>Check this file does indeed contain the above by
      typing:</p>
      <pre class="literallayout">
$ echo 05b217bb859794d08bb9e4f7f04cbda4b207fbe9 | git cat-file --batch
</pre>

      <p>With zpipe, it’s easy to verify the hash:</p>
      <pre class="literallayout">
$ zpipe -d &lt; .git/objects/05/b217bb859794d08bb9e4f7f04cbda4b207fbe9 | sha1sum
</pre>

      <p>Hash verification is trickier via cat-file because its
      output contains more than the raw uncompressed object
      file.</p>

      <p>This file is a <span class="emphasis"><em>tree</em></span>
      object: a list of tuples consisting of a file type, a
      filename, and a hash. In our example, the file type is
      100644, which means ‘rose` is a normal file, and the hash is
      the blob object that contains the contents of `rose’. Other
      possible file types are executables, symlinks or directories.
      In the last case, the hash points to a tree object.</p>

      <p>If you ran filter-branch, you’ll have old objects you no
      longer need. Although they will be jettisoned automatically
      once the grace period expires, we’ll delete them now to make
      our toy example easier to follow:</p>
      <pre class="literallayout">
$ rm -r .git/refs/original
$ git reflog expire --expire=now --all
$ git prune
</pre>

      <p>For real projects you should typically avoid commands like
      this, as you are destroying backups. If you want a clean
      repository, it is usually best to make a fresh clone. Also,
      take care when directly manipulating <code class=
      "literal">.git</code>: what if a Git command is running at
      the same time, or a sudden power outage occurs? In general,
      refs should be deleted with <span class="strong"><strong>git
      update-ref -d</strong></span>, though usually it’s safe to
      remove <code class="literal">refs/original</code> by
      hand.</p>
    </div>

    <div class="section" title="Commits">
      <div class="titlepage">
        <div>
          <div>
            <h2 class="title"><a name="_commits"></a>Commits</h2>
          </div>
        </div>
      </div>

      <p>We’ve explained 2 of the 3 objects. The third is a
      <span class="emphasis"><em>commit</em></span> object. Its
      contents depend on the commit message as well as the date and
      time it was created. To match what we have here, we’ll have
      to tweak it a little:</p>
      <pre class="literallayout">
$ git commit --amend -m Shakespeare  # Change the commit message.
$ git filter-branch --env-filter 'export
    GIT_AUTHOR_DATE="Fri 13 Feb 2009 15:31:30 -0800"
    GIT_AUTHOR_NAME="Alice"
    GIT_AUTHOR_EMAIL="alice@example.com"
    GIT_COMMITTER_DATE="Fri, 13 Feb 2009 15:31:30 -0800"
    GIT_COMMITTER_NAME="Bob"
    GIT_COMMITTER_EMAIL="bob@example.com"'  # Rig timestamps and authors.
$ find .git/objects -type f
</pre>

      <p>You should now see <code class=
      "literal">.git/objects/49/993fe130c4b3bf24857a15d7969c396b7bc187</code>
      which is the SHA1 hash of its contents:</p>
      <pre class="literallayout">
"commit 158" NUL
"tree 05b217bb859794d08bb9e4f7f04cbda4b207fbe9" LF
"author Alice &lt;alice@example.com&gt; 1234567890 -0800" LF
"committer Bob &lt;bob@example.com&gt; 1234567890 -0800" LF
LF
"Shakespeare" LF
</pre>

      <p>As before, you can run zpipe or cat-file to see for
      yourself.</p>

      <p>This is the first commit, so there are no parent commits,
      but later commits will always contain at least one line
      identifying a parent commit.</p>
    </div>

    <div class="section" title="Indistinguishable From Magic">
      <div class="titlepage">
        <div>
          <div>
            <h2 class="title"><a name=
            "_indistinguishable_from_magic"></a>Indistinguishable
            From Magic</h2>
          </div>
        </div>
      </div>

      <p>Git’s secrets seem too simple. It looks like you could mix
      together a few shell scripts and add a dash of C code to cook
      it up in a matter of hours: a melange of basic filesystem
      operations and SHA1 hashing, garnished with lock files and
      fsyncs for robustness. In fact, this accurately describes the
      earliest versions of Git. Nonetheless, apart from ingenious
      packing tricks to save space, and ingenious indexing tricks
      to save time, we now know how Git deftly changes a filesystem
      into a database perfect for version control.</p>

      <p>For example, if any file within the object database is
      corrupted by a disk error, then its hash will no longer
      match, alerting us to the problem. By hashing hashes of other
      objects, we maintain integrity at all levels. Commits are
      atomic, that is, a commit can never only partially record
      changes: we can only compute the hash of a commit and store
      it in the database after we already have stored all relevant
      trees, blobs and parent commits. The object database is
      immune to unexpected interruptions such as power outages.</p>

      <p>We defeat even the most devious adversaries. Suppose
      somebody attempts to stealthily modify the contents of a file
      in an ancient version of a project. To keep the object
      database looking healthy, they must also change the hash of
      the corresponding blob object since it’s now a different
      string of bytes. This means they’ll have to change the hash
      of any tree object referencing the file, and in turn change
      the hash of all commit objects involving such a tree, in
      addition to the hashes of all the descendants of these
      commits. This implies the hash of the official head differs
      to that of the bad repository. By following the trail of
      mismatching hashes we can pinpoint the mutilated file, as
      well as the commit where it was first corrupted.</p>

      <p>In short, so long as the 20 bytes representing the last
      commit are safe, it’s impossible to tamper with a Git
      repository.</p>

      <p>What about Git’s famous features? Branching? Merging?
      Tags? Mere details. The current head is kept in the file
      <code class="literal">.git/HEAD</code>, which contains a hash
      of a commit object. The hash gets updated during a commit as
      well as many other commands. Branches are almost the same:
      they are files in <code class=
      "literal">.git/refs/heads</code>. Tags too: they live in
      <code class="literal">.git/refs/tags</code> but they are
      updated by a different set of commands.</p>
    </div>
  </div><script type="text/javascript" src="find_selflink.js">
</script><script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
  document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
  </script><script type="text/javascript">
var pageTracker = _gat._getTracker("UA-1901330-2");
  pageTracker._initData();
  pageTracker._trackPageview();
  </script>
</div>
</div><div class="footer"><a href="/~blynn/">Ben Lynn</a></div>
</body>
</html>
