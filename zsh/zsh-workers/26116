From zsh-workers-return-26116-mason-zsh=primenet.com.au@sunsite.dk Sun Dec 07 18:43:46 2008
Return-Path: <zsh-workers-return-26116-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 16043 invoked from network); 7 Dec 2008 18:43:41 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 7 Dec 2008 18:43:41 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 36772 invoked from network); 7 Dec 2008 18:43:33 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 7 Dec 2008 18:43:33 -0000
Received: (qmail 19038 invoked by alias); 7 Dec 2008 18:43:27 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 26116
Received: (qmail 19021 invoked from network); 7 Dec 2008 18:43:27 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 7 Dec 2008 18:43:27 -0000
Received: from mtaout03-winn.ispmail.ntl.com (mtaout03-winn.ispmail.ntl.com [81.103.221.49])
	by bifrost.dotsrc.org (Postfix) with ESMTP id 2F3C980308BE
	for <zsh-workers@sunsite.dk>; Sun,  7 Dec 2008 19:43:21 +0100 (CET)
Received: from aamtaout02-winn.ispmail.ntl.com ([81.103.221.35])
          by mtaout03-winn.ispmail.ntl.com
          (InterMail vM.7.08.04.00 201-2186-134-20080326) with ESMTP
          id <20081207184321.GIEA1691.mtaout03-winn.ispmail.ntl.com@aamtaout02-winn.ispmail.ntl.com>;
          Sun, 7 Dec 2008 18:43:21 +0000
Received: from pws-pc ([81.107.43.40]) by aamtaout02-winn.ispmail.ntl.com
          (InterMail vG.2.02.00.01 201-2161-120-102-20060912) with ESMTP
          id <20081207184321.JVQM21638.aamtaout02-winn.ispmail.ntl.com@pws-pc>;
          Sun, 7 Dec 2008 18:43:21 +0000
Date: Sun, 7 Dec 2008 18:43:15 +0000
From: Peter Stephenson <p.w.stephenson@ntlworld.com>
To: gak@klanderman.net, Zsh list <zsh-workers@sunsite.dk>
Subject: Re: bug in delete-to-char in 4.3.9
Message-ID: <20081207184315.2dc9c42e@pws-pc>
In-Reply-To: <18747.30899.211329.617624@gargle.gargle.HOWL>
References: <18747.30899.211329.617624@gargle.gargle.HOWL>
X-Mailer: Claws Mail 3.6.0 (GTK+ 2.14.4; x86_64-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
X-Cloudmark-Analysis: v=1.0 c=1 a=rhzdPR8nzn4A:10 a=NLZqzBF-AAAA:8 a=ti1Xw5H8Tn5m_DhXynYA:9 a=vs5B0d2ftslzVUEG5XgA:7 a=jQ0X1bhuYvPCnWVRznGKPLF9GP8A:4 a=LY0hPdMaydYA:10
X-Virus-Scanned: ClamAV 0.92.1/8730/Sun Dec  7 07:03:03 2008 on bifrost
X-Virus-Status: Clean

On Sun, 7 Dec 2008 02:18:11 -0500
Greg Klanderman <gak@klanderman.net> wrote:
> Hi, there appears to be a small bug in delete-to-char in zsh 4.3.9.
> I'm upgrading from 4.2.5 so don't know how long ago it was introduced.
> The bug causes either incorrect behavior, or the crash:
> 
> | zsh: fatal error: out of memory
> 
> zap-to-char works so long as you don't give it a prefix (count)
> argument.

Yes, it's got a bit knocked about.

Index: Src/Zle/deltochar.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/deltochar.c,v
retrieving revision 1.9
diff -u -r1.9 deltochar.c
--- Src/Zle/deltochar.c	13 Apr 2008 16:58:42 -0000	1.9
+++ Src/Zle/deltochar.c	7 Dec 2008 18:42:27 -0000
@@ -44,11 +44,10 @@
     if (n > 0) {
 	while (n-- && dest != zlell) {
 	    while (dest != zlell && (ZLE_INT_T)zleline[dest] != c)
-		dest++;
+		INCPOS(dest);
 	    if (dest != zlell) {
-		/* HERE adjust dest for trailing combining chars */
 		if (!zap || n > 0)
-		    INCCS();
+		    INCPOS(dest);
 		if (!n) {
 		    forekill(dest - zlecs, CUT_RAW);
 		    ok++;
@@ -58,10 +57,10 @@
     } else {
 	/* ignore character cursor is on when scanning backwards */
 	if (dest)
-	    dest--;
+	    DECPOS(dest);
 	while (n++ && dest != 0) {
 	    while (dest != 0 && (ZLE_INT_T)zleline[dest] != c)
-		dest--;
+		DECPOS(dest);
 	    if ((ZLE_INT_T)zleline[dest] == c) {
 		if (!n) {
 		    /* HERE adjust zap for trailing combining chars */
@@ -69,7 +68,7 @@
 		    ok++;
 		}
 		if (dest)
-		    dest--;
+		    DECPOS(dest);
 	    }
 	}
     }


-- 
Peter Stephenson <p.w.stephenson@ntlworld.com>
Web page now at http://homepage.ntlworld.com/p.w.stephenson/

