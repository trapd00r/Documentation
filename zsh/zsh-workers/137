From zsh-workers-request@math.gatech.edu  Mon Jul  3 21:25:11 1995
Received: from gatech.edu (gatech.edu [130.207.244.244]) by werple.mira.net.au (8.6.12/8.6.9) with SMTP id VAA13883 for <mason@werple.mira.net.au>; Mon, 3 Jul 1995 21:25:01 +1000
Received: from math (math.skiles.gatech.edu) by gatech.edu with SMTP id AA00481
  (5.65c/Gatech-10.0-IDA for <mason@werple.mira.net.au>); Mon, 3 Jul 1995 07:24:53 -0400
Received: by math (5.x/SMI-SVR4)
	id AA02639; Mon, 3 Jul 1995 07:21:33 -0400
Resent-Date: Mon, 03 Jul 95 12:21:58 +0100
Old-Return-Path: <P.Stephenson@swansea.ac.uk>
Message-Id: <14989.9507031121@pyro.swan.ac.uk>
To: zsh-workers@math.gatech.edu (Zsh hackers list)
Subject: Re: $@ bug
In-Reply-To: "A.Main@dcs.warwick.ac.uk"'s message of "Fri, 30 Jun 95 23:30:01 BST." <26234.199506302230@stone.dcs.warwick.ac.uk>
Date: Mon, 03 Jul 95 12:21:58 +0100
From: P.Stephenson@swansea.ac.uk
X-Mts: smtp
Resent-Message-Id: <"QeTFW1.0.9f.yAzzl"@math>
Resent-From: zsh-workers@math.gatech.edu
X-Mailing-List: <zsh-workers@math.gatech.edu> archive/latest/137
X-Loop: zsh-workers@math.gatech.edu
Precedence: list
Resent-Sender: zsh-workers-request@math.gatech.edu

A.Main@dcs.warwick.ac.uk wrote:
> -----BEGIN PGP SIGNED MESSAGE-----
> 
> ~/tmp> fn () { $@ }
> ~/tmp> fn echo wibble
> wibble
> ~/tmp> fn
> ~> cd tmp
> ~/tmp> fn () { echo $@ }
> ~/tmp> fn
> 
> ~/tmp>
> 
> 
> (i.e., the function does a "cd" when executing an empty $@.)

The behaviour was actually inconsistent between empty arrays ("no
command") or other empty variables (did nothing).

This seems to fix it without changing too much.  It means another test
in execcmd(), but that's unavoidable in the circumstances.  (If
anybody can think of another reason why the argument list should be
empty at this point I'll stick in another test, but as far as I can
tell, this is O.K.)

*** Src/exec.c.empty	Fri Jun 30 23:06:14 1995
--- Src/exec.c	Mon Jul  3 12:09:42 1995
***************
*** 1120,1129 ****
  		   | (assign ? 02 : isset(MAGICEQUALSUBST))));
  
      zsfree(underscore);
!     if (full(args) && (underscore = ztrdup((char *) getdata(lastnode(args)))))
! 	untokenize(underscore); 
!     else
    	underscore = ztrdup("");
  
      /* warn about "rm *" */
      if (unset(RMSTARSILENT) && interact && isset(SHINSTDIN) &&
--- 1120,1141 ----
  		   | (assign ? 02 : isset(MAGICEQUALSUBST))));
  
      zsfree(underscore);
!     if (full(args)) {
! 	if ((underscore = ztrdup((char *) getdata(lastnode(args)))))
! 	    untokenize(underscore); 
!     } else {
    	underscore = ztrdup("");
+ 	if (type == SIMPLE && !nullexec) {
+ 	    /*
+ 	     * No command found after expansion.  This forces the shell
+ 	     * to run an empty list in the current shell.
+ 	     * Note that variables never get put into the environment
+ 	     * (for e.g. `foo=bar $@' where $@ is empty), but this is
+ 	     * what we want in this case.
+ 	     */
+ 	    type = CURSH;
+ 	}
+     }
  
      /* warn about "rm *" */
      if (unset(RMSTARSILENT) && interact && isset(SHINSTDIN) &&

-- 
Peter Stephenson <P.Stephenson@swansea.ac.uk>  Tel: +44 1792 205678 extn. 4461
WWW:  http://python.swan.ac.uk/~pypeters/      Fax: +44 1792 295324
Department of Physics, University of Wales, Swansea,
Singleton Park, Swansea, SA2 8PP, U.K.

