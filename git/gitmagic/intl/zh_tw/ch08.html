<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html>
<head>
  <meta name="generator" content=
  "HTML Tidy for Linux (vers 25 March 2009), see www.w3.org">
  <meta http-equiv="Content-Type" content=
  "text/html; charset=utf-8">

  <title>Git Magic - 章 8. 揭開面紗</title>
  <link rel="stylesheet" href="default.css" type="text/css">
  <meta name="generator" content="DocBook XSL Stylesheets V1.75.2">
  <link rel="home" href="index.html" title="Git 魔法">
  <link rel="up" href="index.html" title="Git 魔法">
  <link rel="prev" href="ch07.html" title="章 7. Git大師技">
  <link rel="next" href="ch09.html" title="章 9. 附錄 A: Git的缺點">
</head>

<body bgcolor="white" text="black" link="#0000FF" vlink="#840084"
alink="#0000FF">
    <div class="toc">
      <ul>
<li><b>Git Magic</b></li>
        <li>
          <span class="preface"><a href="index.html">前言</a></span>

          <ul>
            <li><span class="section"><a href=
            "index.html#_%E8%87%B4%E8%AC%9D">致謝！</a></span></li>

            <li><span class="section"><a href=
            "index.html#_%E8%A8%B1%E5%8F%AF">許可</a></span></li>
          </ul>
        </li>

        <li>
          <span class="chapter"><a href="ch01.html">1.
          入門</a></span>

          <ul>
            <li><span class="section"><a href=
            "ch01.html#_%E5%B7%A5%E4%BD%9C%E6%98%AF%E7%8E%A9">工作是玩</a></span></li>

            <li><span class="section"><a href=
            "ch01.html#_%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6">版本控制</a></span></li>

            <li><span class="section"><a href=
            "ch01.html#_%E5%88%86%E4%BD%88%E6%8E%A7%E5%88%B6">分佈控制</a></span></li>

            <li><span class="section"><a href=
            "ch01.html#_%E4%B8%80%E5%80%8B%E8%AA%A4%E5%8D%80">一個誤區</a></span></li>

            <li><span class="section"><a href=
            "ch01.html#_%E5%90%88%E4%BD%B5%E8%A1%9D%E7%AA%81">合併衝突</a></span></li>
          </ul>
        </li>

        <li>
          <span class="chapter"><a href="ch02.html">2.
          基本技巧</a></span>

          <ul>
            <li><span class="section"><a href=
            "ch02.html#_%E4%BF%9D%E5%AD%98%E7%8B%80%E6%85%8B">保存狀態</a></span></li>

            <li><span class="section"><a href=
            "ch02.html#_%E6%B7%BB%E5%8A%A0_%E5%88%AA%E9%99%A4_%E9%87%8D%E5%91%BD%E5%90%8D">
            添加、刪除、重命名</a></span></li>

            <li><span class="section"><a href=
            "ch02.html#_%E9%80%B2%E9%9A%8E%E6%92%A4%E9%8A%B7_%E9%87%8D%E5%81%9A">
            進階撤銷/重做</a></span></li>

            <li><span class="section"><a href=
            "ch02.html#_%E6%92%A4%E9%8A%B7">撤銷</a></span></li>

            <li><span class="section"><a href=
            "ch02.html#_%E8%AE%8A%E6%9B%B4%E6%97%A5%E8%AA%8C%E7%94%9F%E6%88%90">
            變更日誌生成</a></span></li>

            <li><span class="section"><a href=
            "ch02.html#_%E4%B8%8B%E8%BC%89%E6%AA%94%E6%A1%88">下載檔案</a></span></li>

            <li><span class="section"><a href=
            "ch02.html#_%E5%88%B0%E6%9C%80%E6%96%B0">到最新</a></span></li>

            <li><span class="section"><a href=
            "ch02.html#_%E5%BF%AB%E9%80%9F%E7%99%BC%E4%BD%88">快速發佈</a></span></li>

            <li><span class="section"><a href=
            "ch02.html#_%E6%88%91%E5%80%91%E5%B7%B2%E7%B6%93%E5%81%9A%E4%BA%86%E4%BB%80%E9%BA%BC">
            我們已經做了什麼？</a></span></li>

            <li><span class="section"><a href=
            "ch02.html#_%E7%B7%B4%E7%BF%92">練習</a></span></li>
          </ul>
        </li>

        <li>
          <span class="chapter"><a href="ch03.html">3.
          克隆周邊</a></span>

          <ul>
            <li><span class="section"><a href=
            "ch03.html#_%E8%A8%88%E7%AE%97%E6%A9%9F%E9%96%93%E5%90%8C%E6%AD%A5">
            計算機間同步</a></span></li>

            <li><span class="section"><a href=
            "ch03.html#_%E5%85%B8%E5%9E%8B%E6%BA%90%E7%A2%BC%E6%8E%A7%E5%88%B6">
            典型源碼控制</a></span></li>

            <li><span class="section"><a href=
            "ch03.html#_%E5%B0%81%E9%96%89%E6%BA%90%E7%A2%BC">封閉源碼</a></span></li>

            <li><span class="section"><a href=
            "ch03.html#_%E8%A3%B8%E5%80%89%E5%BA%AB">裸倉庫</a></span></li>

            <li><span class="section"><a href=
            "ch03.html#_%E6%8E%A8%E9%82%84%E6%98%AF%E6%8B%BD">推還是拽</a></span></li>

            <li><span class="section"><a href=
            "ch03.html#_%E9%A0%85%E7%9B%AE%E5%88%86%E5%8F%89">項目分叉</a></span></li>

            <li><span class="section"><a href=
            "ch03.html#_%E7%B5%82%E6%A5%B5%E5%82%99%E4%BB%BD">終極備份</a></span></li>

            <li><span class="section"><a href=
            "ch03.html#_%E8%BC%95%E5%BF%AB%E5%A4%9A%E4%BB%BB%E5%8B%99">
            輕快多任務</a></span></li>

            <li><span class="section"><a href=
            "ch03.html#_%E6%B8%B8%E6%93%8A%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6">
            游擊版本控制</a></span></li>

            <li><span class="section"><a href=
            "ch03.html#_mercurial">Mercurial</a></span></li>

            <li><span class="section"><a href=
            "ch03.html#_bazaar">Bazaar</a></span></li>

            <li><span class="section"><a href=
            "ch03.html#_%E6%88%91%E5%81%8F%E6%84%9Bgit%E7%9A%84%E5%8E%9F%E5%9B%A0">
            我偏愛Git的原因</a></span></li>
          </ul>
        </li>

        <li>
          <span class="chapter"><a href="ch04.html">4.
          分支巫術</a></span>

          <ul>
            <li><span class="section"><a href=
            "ch04.html#_%E8%80%81%E9%97%86%E9%8D%B5">老闆鍵</a></span></li>

            <li><span class="section"><a href=
            "ch04.html#_%E9%AA%AF%E9%AB%92%E7%9A%84%E5%B7%A5%E4%BD%9C">
            骯髒的工作</a></span></li>

            <li><span class="section"><a href=
            "ch04.html#_%E5%BF%AB%E9%80%9F%E4%BF%AE%E8%A8%82">快速修訂</a></span></li>

            <li><span class="section"><a href=
            "ch04.html#_%E5%90%88%E4%BD%B5">合併</a></span></li>

            <li><span class="section"><a href=
            "ch04.html#_%E4%B8%8D%E9%96%93%E6%96%B7%E5%B7%A5%E4%BD%9C%E6%B5%81">
            不間斷工作流</a></span></li>

            <li><span class="section"><a href=
            "ch04.html#_%E9%87%8D%E7%B5%84%E9%9B%9C%E4%BA%82">重組雜亂</a></span></li>

            <li><span class="section"><a href=
            "ch04.html#_%E7%AE%A1%E7%90%86%E5%88%86%E6%94%AF">管理分支</a></span></li>

            <li><span class="section"><a href=
            "ch04.html#_%E8%87%A8%E6%99%82%E5%88%86%E6%94%AF">臨時分支</a></span></li>

            <li><span class="section"><a href=
            "ch04.html#_%E6%8C%89%E4%BD%A0%E5%B8%8C%E6%9C%9B%E7%9A%84%E6%96%B9%E5%BC%8F%E5%B7%A5%E4%BD%9C">
            按你希望的方式工作</a></span></li>
          </ul>
        </li>

        <li>
          <span class="chapter"><a href="ch05.html">5.
          關於歷史</a></span>

          <ul>
            <li><span class="section"><a href=
            "ch05.html#_%E6%88%91%E8%AA%8D%E9%8C%AF">我認錯</a></span></li>

            <li><span class="section"><a href=
            "ch05.html#_%E6%9B%B4%E8%A4%87%E9%9B%9C%E6%83%85%E6%B3%81">
            更複雜情況</a></span></li>

            <li><span class="section"><a href=
            "ch05.html#_%E6%9C%AC%E5%9C%B0%E8%AE%8A%E6%9B%B4%E4%B9%8B%E5%BE%8C">
            本地變更之後</a></span></li>

            <li><span class="section"><a href=
            "ch05.html#_%E9%87%8D%E5%AF%AB%E6%AD%B7%E5%8F%B2">重寫歷史</a></span></li>

            <li><span class="section"><a href=
            "ch05.html#_%E8%A3%BD%E9%80%A0%E6%AD%B7%E5%8F%B2">製造歷史</a></span></li>

            <li><span class="section"><a href=
            "ch05.html#_%E5%93%AA%E5%85%92%E9%8C%AF%E4%BA%86">哪兒錯了？</a></span></li>

            <li><span class="section"><a href=
            "ch05.html#_%E8%AA%B0%E8%AE%93%E4%BA%8B%E6%83%85%E8%AE%8A%E7%B3%9F%E4%BA%86">
            誰讓事情變糟了？</a></span></li>

            <li><span class="section"><a href=
            "ch05.html#_%E5%80%8B%E4%BA%BA%E7%B6%93%E9%A9%97">個人經驗</a></span></li>
          </ul>
        </li>

        <li>
          <span class="chapter"><a href="ch06.html">6.
          多人Git</a></span>

          <ul>
            <li><span class="section"><a href=
            "ch06.html#_%E6%88%91%E6%98%AF%E8%AA%B0">我是誰？</a></span></li>

            <li><span class="section"><a href=
            "ch06.html#_git%E5%9C%A8ssh_http%E4%B8%8A">Git在SSH,
            HTTP上</a></span></li>

            <li><span class="section"><a href=
            "ch06.html#_git%E5%9C%A8%E9%9A%A8%E4%BE%BF%E4%BB%80%E9%BA%BC%E4%B8%8A">
            Git在隨便什麼上</a></span></li>

            <li><span class="section"><a href=
            "ch06.html#_%E8%A3%9C%E4%B8%81_%E5%85%A8%E7%90%83%E8%B2%A8%E5%B9%A3">
            補丁：全球貨幣</a></span></li>

            <li><span class="section"><a href=
            "ch06.html#_%E5%B0%8D%E4%B8%8D%E8%B5%B7_%E7%A7%BB%E8%B5%B0%E4%BA%86">
            對不起，移走了</a></span></li>

            <li><span class="section"><a href=
            "ch06.html#_%E9%81%A0%E7%AB%AF%E5%88%86%E6%94%AF">遠端分支</a></span></li>

            <li><span class="section"><a href=
            "ch06.html#_%E5%A4%9A%E9%81%A0%E7%AB%AF">多遠端</a></span></li>

            <li><span class="section"><a href=
            "ch06.html#_%E6%88%91%E7%9A%84%E5%96%9C%E5%A5%BD">我的喜好</a></span></li>
          </ul>
        </li>

        <li>
          <span class="chapter"><a href="ch07.html">7.
          Git大師技</a></span>

          <ul>
            <li><span class="section"><a href=
            "ch07.html#_%E6%BA%90%E7%A2%BC%E7%99%BC%E4%BD%88">源碼發佈</a></span></li>

            <li><span class="section"><a href=
            "ch07.html#_%E6%8F%90%E4%BA%A4%E8%AE%8A%E6%9B%B4">提交變更</a></span></li>

            <li><span class="section"><a href=
            "ch07.html#_%E6%88%91%E7%9A%84%E6%8F%90%E4%BA%A4%E5%A4%AA%E5%A4%A7%E4%BA%86">
            我的提交太大了！</a></span></li>

            <li><span class="section"><a href=
            "ch07.html#_%E7%B4%A2%E5%BC%95_git%E7%9A%84%E4%B8%AD%E8%BD%89%E5%8D%80%E5%9F%9F">
            索引：Git的中轉區域</a></span></li>

            <li><span class="section"><a href=
            "ch07.html#_%E5%88%A5%E4%B8%9F%E4%BA%86%E4%BD%A0%E7%9A%84head">
            別丟了你的HEAD</a></span></li>

            <li><span class="section"><a href=
            "ch07.html#_head%E6%8D%95%E7%8D%B5">HEAD捕獵</a></span></li>

            <li><span class="section"><a href=
            "ch07.html#_%E5%9F%BA%E4%BA%8Egit%E6%A7%8B%E5%BB%BA">基于Git構建</a></span></li>

            <li><span class="section"><a href=
            "ch07.html#_%E5%A4%A7%E8%86%BD%E7%9A%84%E7%89%B9%E6%8A%80">
            大膽的特技</a></span></li>

            <li><span class="section"><a href=
            "ch07.html#_%E9%98%BB%E6%AD%A2%E5%A3%9E%E6%8F%90%E4%BA%A4">
            阻止壞提交</a></span></li>
          </ul>
        </li>

        <li>
          <span class="chapter"><a href="ch08.html">8.
          揭開面紗</a></span>

          <ul>
            <li><span class="section"><a href=
            "ch08.html#_%E5%A4%A7%E8%B1%A1%E7%84%A1%E5%BD%A2">大象無形</a></span></li>

            <li><span class="section"><a href=
            "ch08.html#_%E6%95%B8%E6%93%9A%E5%AE%8C%E6%95%B4%E6%80%A7">
            數據完整性</a></span></li>

            <li><span class="section"><a href=
            "ch08.html#_%E6%99%BA%E8%83%BD">智能</a></span></li>

            <li><span class="section"><a href=
            "ch08.html#_%E7%B4%A2%E5%BC%95">索引</a></span></li>

            <li><span class="section"><a href=
            "ch08.html#_git%E7%9A%84%E6%BA%90%E8%B5%B7">Git的源起</a></span></li>

            <li><span class="section"><a href=
            "ch08.html#_%E5%B0%8D%E8%B1%A1%E8%B3%87%E6%96%99%E5%BA%AB">
            對象資料庫</a></span></li>

            <li><span class="section"><a href=
            "ch08.html#_blob%E5%B0%8D%E8%B1%A1">Blob對象</a></span></li>

            <li><span class="section"><a href=
            "ch08.html#_tree%E5%B0%8D%E8%B1%A1">Tree對象</a></span></li>

            <li><span class="section"><a href=
            "ch08.html#_commit%E5%B0%8D%E8%B1%A1">Commit對象</a></span></li>

            <li><span class="section"><a href=
            "ch08.html#_%E6%B2%92%E9%82%A3%E9%BA%BC%E7%A5%9E">沒那麼神</a></span></li>
          </ul>
        </li>

        <li>
          <span class="chapter"><a href="ch09.html">9. 附錄 A:
          Git的缺點</a></span>

          <ul>
            <li><span class="section"><a href=
            "ch09.html#_sha1_%E7%9A%84%E5%BC%B1%E9%BB%9E">SHA1
            的弱點</a></span></li>

            <li><span class="section"><a href=
            "ch09.html#_%E5%BE%AE%E8%BB%9F_windows">微軟
            Windows</a></span></li>

            <li><span class="section"><a href=
            "ch09.html#_%E4%B8%8D%E7%9B%B8%E9%97%9C%E7%9A%84%E6%AA%94%E6%A1%88">
            不相關的檔案</a></span></li>

            <li><span class="section"><a href=
            "ch09.html#_%E8%AA%B0%E5%9C%A8%E7%B7%A8%E8%BC%AF%E4%BB%80%E9%BA%BC">
            誰在編輯什麼？</a></span></li>

            <li><span class="section"><a href=
            "ch09.html#_%E6%AA%94%E6%A1%88%E6%AD%B7%E5%8F%B2">檔案歷史</a></span></li>

            <li><span class="section"><a href=
            "ch09.html#_%E5%88%9D%E5%A7%8B%E5%85%8B%E9%9A%86">初始克隆</a></span></li>

            <li><span class="section"><a href=
            "ch09.html#_%E4%B8%8D%E7%A9%A9%E5%AE%9A%E7%9A%84%E9%A0%85%E7%9B%AE">
            不穩定的項目</a></span></li>

            <li><span class="section"><a href=
            "ch09.html#_%E5%85%A8%E5%B1%80%E8%A8%88%E6%95%B8%E5%99%A8">
            全局計數器</a></span></li>

            <li><span class="section"><a href=
            "ch09.html#_%E7%A9%BA%E5%AD%90%E7%9B%AE%E9%8C%84">空子目錄</a></span></li>

            <li><span class="section"><a href=
            "ch09.html#_%E5%88%9D%E5%A7%8B%E6%8F%90%E4%BA%A4">初始提交</a></span></li>

            <li><span class="section"><a href=
            "ch09.html#_%E4%BB%8B%E9%9D%A2%E6%80%AA%E7%99%96">介面怪癖</a></span></li>
          </ul>
        </li>

        <li><span class="chapter"><a href="ch10.html">10. 附錄 B:
        本指南的翻譯</a></span></li>
      </ul>
    </div>
<div class="content">
  <div class="chapter" title="章 8. 揭開面紗">
    <div class="titlepage">
      <div>
        <div>
          <h2 class="title"><a name=
          "_%E6%8F%AD%E9%96%8B%E9%9D%A2%E7%B4%97"></a>章 8.
          揭開面紗</h2>
        </div>
      </div>
    </div>

    <p>我們揭開Git神秘面紗，往裡瞧瞧它是如何創造奇蹟的。我會跳過細節。更深入的描述參 見 <a class="ulink"
    href=
    "http://www.kernel.org/pub/software/scm/git/docs/user-manual.html"
    target="_top">用戶手 冊</a>。</p>

    <div class="section" title="大象無形">
      <div class="titlepage">
        <div>
          <div>
            <h2 class="title"><a name=
            "_%E5%A4%A7%E8%B1%A1%E7%84%A1%E5%BD%A2"></a>大象無形</h2>
          </div>
        </div>
      </div>

      <p>Git怎麼這麼謙遜寡言呢？除了偶爾提交和合併外，你可以如常工作，就像不知道版本控
      制系統存在一樣。那就是，直到你需要它的時候，而且那是你歡欣的時候，Git一直默默 注視着你。</p>

      <p>其他版本控制系統強迫你與繁文縟節和官僚主義不斷鬥爭。檔案的權限可能是隻讀的，
      除非你顯式地告訴中心伺服器哪些檔案你打算編輯。即使最基本的命令，隨着用戶數目
      的增多，也會慢的像爬一樣。中心伺服器可能正跟蹤什麼人，什麼時候check out了什麼
      代碼。當網絡連接斷了的時候，你就遭殃了。開發人員不斷地與這些版本控制系統的種
      種限製作鬥爭。一旦網絡或中心伺服器癱瘓，工作就嘎然而止。</p>

      <p>與之相反，Git簡單地在你工作目錄下的<code class=
      "literal">.git`目錄保存你項目的歷史。這是你自己的歷
      史拷貝，因此你可以保持離線，直到你想和他人溝通為止。你擁有你的檔案命運完全的
      控制權，因為Git可以輕易在任何時候從</code>.git`重建一個保存狀態。</p>
    </div>

    <div class="section" title="數據完整性">
      <div class="titlepage">
        <div>
          <div>
            <h2 class="title"><a name=
            "_%E6%95%B8%E6%93%9A%E5%AE%8C%E6%95%B4%E6%80%A7"></a>數據完整性</h2>
          </div>
        </div>
      </div>

      <p>很多人把加密和保持信息機密關聯起來，但一個同等重要的目標是保證信息安全。合理
      使用哈希加密功能可以防止無意或有意的數據損壞行為。</p>

      <p>一個SHA1哈希值可被認為是一個唯一的160位ID數，用它可以唯一標識你一生中遇到的每 個位元組串。
      實際上不止如此：每個位元組串可供任何人用好多輩子。</p>

      <p>對一個檔案而言，其整體內容的哈希值可以被看作這個檔案的唯一標識ID數。</p>

      <p>因為一個SHA1哈希值本身也是一個位元組串，我們可以哈希包括其他哈希值的位元組串。這
      個簡單的觀察出奇地有用：查看“哈希鏈”。我們之後會看Git如何利用這一點來高效地 保證數據完整性。</p>

      <p>簡言之，Git把你數據保存在`.git/objects`子目錄，那裡看不到正常檔案名，相反你只
      看到ID。通過用ID作為檔案名，加上一些檔案鎖和時間戳技巧，Git把任意一個原始的文
      件系統轉化為一個高效而穩定的資料庫。</p>
    </div>

    <div class="section" title="智能">
      <div class="titlepage">
        <div>
          <div>
            <h2 class="title"><a name=
            "_%E6%99%BA%E8%83%BD"></a>智能</h2>
          </div>
        </div>
      </div>

      <p>Git是如何知道你重命名了一個檔案，即使你從來沒有明確提及這個事實？當然，你或許 是運行了 <span class=
      "strong"><strong>git mv</strong></span> ，但這個命令和 <span class=
      "strong"><strong>git add</strong></span> 緊接 <span class=
      "strong"><strong>git rm</strong></span> 是完全一樣的。</p>

      <p>Git啟發式地找出相連版本之間的重命名和拷貝。實際上，它能檢測檔案之間代碼塊的移
      動或拷貝！儘管它不能覆蓋所有的情況，但它已經做的很好了，並且這個功能也總在改
      進中。如果它在你那兒不工作的話，可以嘗試打開開銷更高的拷貝檢測選項，並考慮升 級。</p>
    </div>

    <div class="section" title="索引">
      <div class="titlepage">
        <div>
          <div>
            <h2 class="title"><a name=
            "_%E7%B4%A2%E5%BC%95"></a>索引</h2>
          </div>
        </div>
      </div>

      <p>為每個加入管理的檔案，Git在一個名為“index”的檔案裡記錄統計信息，諸如大小，
      創建時間和最後修改時間。為了確定檔案是否更改，Git比較其當前統計信息與那些在索
      引裡的統計信息。如果一致，那Git就跳過重新讀檔案。</p>

      <p>因為統計信息的調用比讀檔案內容快的很多，如果你僅僅編輯了少數幾個檔案，Git几乎
      不需要什麼時間就能更新他們的統計信息。</p>

      <p>我們前面講過索引是一個中轉區。為什麼一堆檔案的統計數據是一個中轉區？因為添加
      命令將檔案放到Git的資料庫並更新它們的統計信息，而無參數的提交命令創建一個提交，
      只基于這些統計信息和已經在資料庫裡的檔案。</p>
    </div>

    <div class="section" title="Git的源起">
      <div class="titlepage">
        <div>
          <div>
            <h2 class="title"><a name=
            "_git%E7%9A%84%E6%BA%90%E8%B5%B7"></a>Git的源起</h2>
          </div>
        </div>
      </div>

      <p>這個 <a class="ulink" href=
      "http://lkml.org/lkml/2005/4/6/121" target=
      "_top">Linux內核郵件列表帖子</a> 描述了導致Git
      的一系列事件。整個討論線索是一個令人着迷的歷史探究過程，對Git史學家而言。</p>
    </div>

    <div class="section" title="對象資料庫">
      <div class="titlepage">
        <div>
          <div>
            <h2 class="title"><a name=
            "_%E5%B0%8D%E8%B1%A1%E8%B3%87%E6%96%99%E5%BA%AB"></a>對象資料庫</h2>
          </div>
        </div>
      </div>

      <p>你數據的每個版本都保存在“對象資料庫”裡，其位於子目錄<code class=
      "literal">.git/objects`；其他位
      于</code>.git/`的較少數據：索引，分支名，標籤，配置選項，日誌，頭提交的當前位置等。
      對象資料庫樸素而優雅，是Git的力量之源。</p>

      <p>`.git/objects`裡的每個檔案是一個對象。有3中對象跟我們有關：“blob”對象，
      “tree”對象，和“commit”對象。</p>
    </div>

    <div class="section" title="Blob對象">
      <div class="titlepage">
        <div>
          <div>
            <h2 class="title"><a name=
            "_blob%E5%B0%8D%E8%B1%A1"></a>Blob對象</h2>
          </div>
        </div>
      </div>

      <p>首先來一個小把戲。去一個檔案名，任意檔案名。在一個空目錄：</p>
      <pre class="literallayout">
$ echo sweet &gt; YOUR_FILENAME
$ git init
$ git add .
$ find .git/objects -type f
</pre>

      <p>你將看到 <code class=
      "literal">.git/objects/aa/823728ea7d592acc69b36875a482cdf3fd5c8d</code>
      。</p>

      <p>我如何在不知道檔案名的情況下知道這個？這是因為以下內容的SHA1哈希值：</p>
      <pre class="literallayout">
"blob" SP "6" NUL "sweet" LF
</pre>

      <p>是
      aa823728ea7d592acc69b36875a482cdf3fd5c8d，這裡SP是一個空格，NUL是一個0位元組，
      LF是一個換行符。你可以驗證這一點，鍵入：</p>
      <pre class="literallayout">
$ printf "blob 6\000sweet\n" | sha1sum
</pre>

      <p>Git基于“內容定址”：檔案並不按它們的檔案名存儲，而是按它們包含內容的哈希值，
      在一個叫“blob對象”的檔案裡。我們可以把檔案內容的哈希值看作一個唯一ID，這樣
      在某種意義上我們通過他們內容放置檔案。開始的“blob 6”只是一個包含對象類型與 其長度的頭；它簡化了內部存儲。</p>

      <p>這樣我可以輕易語言你所看到的。檔案名是無關的：只有裡面的內容被用作構建blob對象。</p>

      <p>你可能想知道對相同的檔案什麼會發生。試圖加一個你檔案的拷貝，什麼檔案名都行。 在 <code class=
      "literal">.git/objects</code> 的內容保持不變，不管你加了多少。Git只存儲一次數據。</p>

      <p>順便說一句，在 <code class="literal">.git/objects</code>
      裡的檔案用zlib壓縮，因此你不應該直接查看他們。 可以通過<a class="ulink" href=
      "http://www.zlib.net/zpipe.c" target="_top">zpipe -d</a> 管道，
      或者鍵入：</p>
      <pre class="literallayout">
$ git cat-file -p aa823728ea7d592acc69b36875a482cdf3fd5c8d
</pre>

      <p>這漂亮地打印出給定的對象。</p>
    </div>

    <div class="section" title="Tree對象">
      <div class="titlepage">
        <div>
          <div>
            <h2 class="title"><a name=
            "_tree%E5%B0%8D%E8%B1%A1"></a>Tree對象</h2>
          </div>
        </div>
      </div>

      <p>但檔案名在哪？它們必定在某個階段保存在某個地方。Git在提交時得到檔案名：</p>
      <pre class="literallayout">
$ git commit  # 輸入一些信息。
$ find .git/objects -type f
</pre>

      <p>你應看到3個對象。這次我不能告訴你這兩個新檔案是什麼，因為它部分依賴你選擇的文
      件名。我繼續進行，假設你選了‘`rose’'。如果你沒有，你可以重寫歷史以讓它看起來 像似你做了：</p>
      <pre class="literallayout">
$ git filter-branch --tree-filter 'mv YOUR_FILENAME rose'
$ find .git/objects -type f
</pre>

      <p>現在你硬看到檔案 <code class=
      "literal">.git/objects/05/b217bb859794d08bb9e4f7f04cbda4b207fbe9</code>
      ，因為這是以下內容的SHA1哈希值：</p>
      <pre class="literallayout">
"tree" SP "32" NUL "100644 rose" NUL 0xaa823728ea7d592acc69b36875a482cdf3fd5c8d
</pre>

      <p>檢查這個檔案真的包含上面內容通過鍵入：</p>
      <pre class="literallayout">
$ echo 05b217bb859794d08bb9e4f7f04cbda4b207fbe9 | git cat-file --batch
</pre>

      <p>使用zpipe，驗證哈希值是容易的：</p>
      <pre class="literallayout">
$ zpipe -d &lt; .git/objects/05/b217bb859794d08bb9e4f7f04cbda4b207fbe9 | sha1sum
</pre>

      <p>與查看檔案相比，哈希值驗證更技巧一些，因為其輸出不止包含原始未壓縮檔案。</p>

      <p>這個檔案是一個“tree”對象：一組數據包含檔案類型，檔案名和哈希值。在我們的例
      子裡，檔案類型是100644，這意味着“rose”是一個一般檔案，並且哈希值指blob對象，
      包含“rose”的內容。其他可能檔案類型有可執行，連結或者目錄。在最後一個例子裡， 哈希值指向一個tree對象。</p>

      <p>在一些過渡性的分支，你會有一些你不在需要的老的對象，儘管有寬限過期之後，它們
      會被自動清除，現在我們還是將其刪除，以使我們比較容易跟上這個玩具例子。</p>
      <pre class="literallayout">
$ rm -r .git/refs/original
$ git reflog expire --expire=now --all
$ git prune
</pre>

      <p>在真實項目裡你通常應該避免像這樣的命令，因為你在破換備份。如果你期望一個乾淨
      的倉庫，通常最好做一個新的克隆。還有，直接操作 <code class="literal">.git</code>
      時一定要小心：如果 Git命令同時也在運行會怎樣，或者突然停電？一般，引用應由 <span class=
      "strong"><strong>git update-ref -d</strong></span>
      刪除，儘管通常手工刪除 <code class="literal">refs/original</code>
      也是安全的。</p>
    </div>

    <div class="section" title="Commit對象">
      <div class="titlepage">
        <div>
          <div>
            <h2 class="title"><a name=
            "_commit%E5%B0%8D%E8%B1%A1"></a>Commit對象</h2>
          </div>
        </div>
      </div>

      <p>我們已經解釋了三個對象中的兩個。第三個是“commit”對象。其內容依賴于提交信息
      以及其創建的日期和時間。為滿足這裡我們所有的，我們不得不調整一下：</p>
      <pre class="literallayout">
$ git commit --amend -m Shakespeare  # 改提交信息
$ git filter-branch --env-filter 'export
    GIT_AUTHOR_DATE="Fri 13 Feb 2009 15:31:30 -0800"
    GIT_AUTHOR_NAME="Alice"
    GIT_AUTHOR_EMAIL="alice@example.com"
    GIT_COMMITTER_DATE="Fri, 13 Feb 2009 15:31:30 -0800"
    GIT_COMMITTER_NAME="Bob"
    GIT_COMMITTER_EMAIL="bob@example.com"'  # Rig timestamps and authors.
$ find .git/objects -type f
</pre>

      <p>你現在應看到 <code class=
      "literal">.git/objects/49/993fe130c4b3bf24857a15d7969c396b7bc187</code>
      是下列 內容的SHA1哈希值：</p>
      <pre class="literallayout">
"commit 158" NUL
"tree 05b217bb859794d08bb9e4f7f04cbda4b207fbe9" LF
"author Alice &lt;alice@example.com&gt; 1234567890 -0800" LF
"committer Bob &lt;bob@example.com&gt; 1234567890 -0800" LF
LF
"Shakespeare" LF
</pre>

      <p>和前面一樣，你可以運行zpipe或者cat-file來自己看。</p>

      <p>這是第一個提交，因此沒有父提交，但之後的提交將總有至少一行，指定一個父提交。</p>
    </div>

    <div class="section" title="沒那麼神">
      <div class="titlepage">
        <div>
          <div>
            <h2 class="title"><a name=
            "_%E6%B2%92%E9%82%A3%E9%BA%BC%E7%A5%9E"></a>沒那麼神</h2>
          </div>
        </div>
      </div>

      <p>Git的秘密似乎太簡單。看起來似乎你可以整合幾個shell腳本，加幾行C代碼來弄起來，
      也就幾個小時的事：一個基本檔案操作和SHA1哈希化的混雜，用鎖檔案裝飾一下，檔案
      同步保證健壯性。實際上，這準確描述了Git的最早期版本。儘管如此，除了巧妙地打包
      以節省空間，巧妙地索引以省時間，我們現在知道Git如何靈巧地改造檔案系統成為一個 對版本控制完美的資料庫。</p>

      <p>例如，如果對象資料庫裡的任何一個檔案由於硬碟錯誤損毀，那麼其哈希值將不再匹配，
      這個錯誤會報告給我們。通過哈希化其他對象的哈希值，我們在所有層面維護數據完整
      性。Commit對象是原子的，也就是說，一個提交永遠不會部分地記錄變更：在我們已經
      存儲所有相關tree對象，blob對象和父commit對象之後，我們才可以計算提交的的哈希
      值並將其存儲在資料庫，對象資料庫不受諸如停電之類的意外中斷影響。</p>

      <p>我們打敗即使是最狡猾的對手。假設有誰試圖悄悄修改一個項目裡一個遠古版本檔案的
      內容。為使對象據庫看起來健康，他們也必須修改相應blob對象的哈希值，既然它現在
      是一個不同的位元組串。這意味着他們講不得不引用這個檔案的tree對象的哈希值，並反
      過來改變所有與這個tree相關的commit對象的哈希值，還要加上這些提交所有後裔的哈
      希值。這暗示官方head的哈希值與這個壞倉庫不同。通過跟蹤不匹配哈希值線索，我
      們可以查明殘缺檔案，以及第一個被破壞的提交。</p>

      <p>總之，只要20個位元組代表最後一次提交的是安全的，不可能篡改一個Git倉庫。</p>

      <p>那麼Git的著名功能怎樣呢？分支？合併？標籤？單純的細節。當前head保存在檔案 <code class=
      "literal">.git /HEAD</code>
      ，其中包含了一個commit對象的哈希值。該哈希值在運行提交以及其他命 令是更新。分支几乎一樣：它們是保存在
      <code class="literal">.git/refs/heads</code> 的檔案。標籤也是：它們 住在住在
      <code class="literal">.git/refs/tags</code>
      ，但它們由一套不同的命令更新。</p>
    </div>
  </div><script type="text/javascript" src="find_selflink.js">
</script><script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
  document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
  </script><script type="text/javascript">
var pageTracker = _gat._getTracker("UA-1901330-2");
  pageTracker._initData();
  pageTracker._trackPageview();
  </script>
</div>
</div><div class="footer"><a href="/~blynn/">Ben Lynn</a></div>
</body>
</html>
