From A.Main@dcs.warwick.ac.uk Fri Jul 19 00:31:16 1996
Received: from euclid.skiles.gatech.edu (list@euclid.skiles.gatech.edu [130.207.146.50]) by melb.werple.net.au (8.7.5/8.7.3/2) with ESMTP id AAA10120 for <mason@werple.mira.net.au>; Fri, 19 Jul 1996 00:31:13 +1000 (EST)
Received: (from list@localhost) by euclid.skiles.gatech.edu (8.7.3/8.7.3) id KAA03749; Thu, 18 Jul 1996 10:24:57 -0400 (EDT)
Resent-Date: Thu, 18 Jul 1996 10:24:57 -0400 (EDT)
From: Zefram <A.Main@dcs.warwick.ac.uk>
Message-Id: <11897.199607181424@granite.dcs.warwick.ac.uk>
Subject: vi-replace-chars and vi-repeat-last-change
To: zsh-workers@math.gatech.edu (Z Shell workers mailing list)
Date: Thu, 18 Jul 1996 15:24:00 +0100 (BST)
X-Patch: 119
X-Loop: zefram@dcs.warwick.ac.uk
X-Stardate: [-31]7828.00
X-US-Congress: Moronic fuckers
MIME-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
Resent-Message-ID: <"3O-No3.0.Vw.uaaxn"@euclid>
Resent-From: zsh-workers@math.gatech.edu
X-Mailing-List: <zsh-workers@math.gatech.edu> archive/latest/1696
X-Loop: zsh-workers@math.gatech.edu
Precedence: list
Resent-Sender: zsh-workers-request@math.gatech.edu
Content-Length: 2791
Status: O

-----BEGIN PGP SIGNED MESSAGE-----

The patch below makes vi-replace-chars repeat correctly with
vi-repeat-change.  The comment added explains the details.

 -zefram

      Index: Src/zle_vi.c
      ===================================================================
      RCS file: /home/zefram/usr/cvsroot/zsh/Src/zle_vi.c,v
      retrieving revision 1.11
      diff -c -r1.11 zle_vi.c
      *** zle_vi.c	1996/07/17 16:12:28	1.11
      --- zle_vi.c	1996/07/18 12:44:13
      ***************
      *** 442,468 ****
            startvitext(0);
        }
        
        /**/
        void
        vireplacechars(void)
        {
            int ch;
        
      !     /* check argument range */
      !     if (zmult < 0)
      ! 	return;
      !     if (zmult + cs > findeol()) {
        	feep();
        	return;
            }
      !     /* get key */
      !     if((ch = vigetkey()) == -1) {
        	feep();
        	return;
            }
      -     ungetkey(ch);
      -     startvichange(1);
      -     getkey(0);
            /* do change */
            if (ch == '\r' || ch == '\n') {
        	/* <return> handled specially */
      --- 442,476 ----
            startvitext(0);
        }
        
      + /* vi-replace-chars has some oddities relating to vi-repeat-change.  In *
      +  * the real vi, if one does 3r at the end of a line, it feeps without   *
      +  * reading the argument.  A successful rx followed by 3. at the end of  *
      +  * a line (or 3rx followed by . at the end of a line) will obviously    *
      +  * feep after the ., even though it has the argument available.  Here   *
      +  * repeating is tied very closely to argument reading, such that we     *
      +  * can't do that.  The solution is to just read the argument even if    *
      +  * the command will fail -- not exactly vi compatible, but it is more   *
      +  * consistent (consider dd in an empty file in vi).                     */
      + 
        /**/
        void
        vireplacechars(void)
        {
            int ch;
        
      !     startvichange(1);
      !     /* get key */
      !     if((ch = vigetkey()) == -1) {
      ! 	vichgflag = 0;
        	feep();
        	return;
            }
      !     /* check argument range */
      !     if (zmult < 0 || zmult + cs > findeol()) {
      ! 	vichgflag = 0;
        	feep();
        	return;
            }
            /* do change */
            if (ch == '\r' || ch == '\n') {
        	/* <return> handled specially */

-----BEGIN PGP SIGNATURE-----
Version: 2.6.2

iQCVAwUBMe4yjnD/+HJTpU/hAQHcfwP/aLd1MTv3VEbFfH/6cCVEgUXWmFMgsOvK
RJOiYSKyagqOTjCuRJn+Klf+lVqRC3W59B21JkQr8L8FgNM9G/pKw7ea/fYiTyiY
Kehm34n4hW1eEBfZQPJXO3YmesNIrKfmDRWB0yKQNvnCPLQ7hGdcC3Bgo9GiBSp6
PM6HqjJtmyE=
=As9e
-----END PGP SIGNATURE-----


