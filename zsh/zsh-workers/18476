From zsh-workers-return-18476-mason-zsh=primenet.com.au@sunsite.dk Sun Apr 27 09:27:16 2003
Return-Path: <zsh-workers-return-18476-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 20942 invoked from network); 27 Apr 2003 09:27:15 -0000
Received: from sunsite.dk (130.225.247.90)
  by ns1.primenet.com.au with SMTP; 27 Apr 2003 09:27:15 -0000
Received: (qmail 14250 invoked by alias); 27 Apr 2003 09:27:08 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 18476
Received: (qmail 14241 invoked from network); 27 Apr 2003 09:27:07 -0000
Received: from localhost (HELO sunsite.dk) (127.0.0.1)
  by localhost with SMTP; 27 Apr 2003 09:27:07 -0000
X-MessageWall-Score: 0 (sunsite.dk)
Received: from [195.34.32.123] by sunsite.dk (MessageWall 1.0.8) with SMTP; 27 Apr 2003 9:27:7 -0000
Received: from ppp148-213.dialup.mtu-net.ru (ppp148-213.dialup.mtu-net.ru [62.118.148.213])
	by hueymiccailhuitl.mtu.ru (Postfix) with ESMTP id 48950F8556
	for <zsh-workers@sunsite.dk>; Sun, 27 Apr 2003 13:25:52 +0400 (MSD)
	(envelope-from arvidjaar@mail.ru)
From: Andrey Borzenkov <arvidjaar@mail.ru>
To: zsh-workers@sunsite.dk
Subject: PATCH: fix menu completion on terminal with do=^J/without do
Date: Sun, 27 Apr 2003 12:49:49 +0400
User-Agent: KMail/1.5
MIME-Version: 1.0
Content-Type: Multipart/Mixed;
  boundary="Boundary-00=_tm5q+t3H7RXzV9P"
Message-Id: <200304271249.49111.arvidjaar@mail.ru>


--Boundary-00=_tm5q+t3H7RXzV9P
Content-Type: text/plain;
  charset="us-ascii"
Content-Transfer-Encoding: 7bit
Content-Disposition: inline

Standard termcap for Linux console defines "do" (down_cursor) as ^J.  Zsh 
init_term ignores it in this case (Geoff, could you enlighten why it does 
it?); it then provides workaround in zle_refresh by actually using ^J but 
moving cursor to needed column then.

Unfortunately complist is using termcap directly and thus outputs no 
down_cursor at all but believes it has moved to correct line.

The patch exports tc_downcurs and makes complist using it. I refrain from 
removing ^J code in init_term not knowing reasons or possible implications.

If it is OK I commit it tomorrow.

-andrey


--Boundary-00=_tm5q+t3H7RXzV9P
Content-Type: text/x-diff;
  charset="us-ascii";
  name="zsh_tcdown.patch"
Content-Transfer-Encoding: 7bit
Content-Disposition: attachment; filename="zsh_tcdown.patch"

--- Src/Zle/complist.c.tcdown	2002-10-15 22:00:02.000000000 +0400
+++ Src/Zle/complist.c	2003-04-27 11:22:26.000000000 +0400
@@ -1556,7 +1556,7 @@ singledraw()
     mcc2 = singlecalc(&mc2, ml2, &lc2);
 
     if (md1)
-        tcmultout(TCDOWN, TCMULTDOWN, md1);
+        tc_downcurs(md1);
     if (mc1)
         tcmultout(TCRIGHT, TCMULTRIGHT, mc1);
     g = mgtab[ml1 * columns + mc1];
@@ -1565,7 +1565,7 @@ singledraw()
     putc('\r', shout);
 
     if (md2 != md1)
-        tcmultout(TCDOWN, TCMULTDOWN, md2 - md1);
+        tc_downcurs(md2 - md1);
     if (mc2)
         tcmultout(TCRIGHT, TCMULTRIGHT, mc2);
     g = mgtab[ml2 * columns + mc2];
@@ -1576,7 +1576,7 @@ singledraw()
     if (mstatprinted) {
         int i = lines - md2 - nlnct;
 
-        tcmultout(TCDOWN, TCMULTDOWN, i - 1);
+        tc_downcurs(i - 1);
         compprintfmt(NULL, 0, 1, 1, mline, NULL);
         tcmultout(TCUP, TCMULTUP, lines - 1);
     } else
--- Src/Zle/zle_refresh.c.tcdown	2003-04-04 17:56:44.000000000 +0400
+++ Src/Zle/zle_refresh.c	2003-04-27 11:21:14.000000000 +0400
@@ -1062,7 +1062,7 @@ tc_rightcurs(int ct)
 }
 
 /**/
-static int
+mod_export int
 tc_downcurs(int ct)
 {
     int ret = 0;

--Boundary-00=_tm5q+t3H7RXzV9P--

