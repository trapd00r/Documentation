From zsh-workers-return-24106-mason-zsh=primenet.com.au@sunsite.dk Tue Nov 20 15:12:27 2007
Return-Path: <zsh-workers-return-24106-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 1219 invoked from network); 20 Nov 2007 15:12:16 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.3 (2007-08-08) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.4 required=5.0 tests=AWL,BAYES_00,HTML_MESSAGE
	autolearn=ham version=3.2.3
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 20 Nov 2007 15:12:16 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 20291 invoked from network); 20 Nov 2007 15:12:11 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 20 Nov 2007 15:12:11 -0000
Received: (qmail 11850 invoked by alias); 20 Nov 2007 15:12:07 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 24106
Received: (qmail 11827 invoked from network); 20 Nov 2007 15:12:06 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 20 Nov 2007 15:12:06 -0000
Received: (qmail 19930 invoked from network); 20 Nov 2007 15:12:06 -0000
Received: from mailgw10.technion.ac.il (132.68.225.10)
  by a.mx.sunsite.dk with SMTP; 20 Nov 2007 15:11:59 -0000
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: Ah4FAA6IQkeERHMC/2dsb2JhbACCPTYp
X-IronPort-AV: E=Sophos;i="4.21,442,1188766800"; 
   d="scan'208,217";a="68896845"
Received: from leeor.math.technion.ac.il ([132.68.115.2])
  by mailgw10.technion.ac.il with ESMTP; 20 Nov 2007 17:11:57 +0200
Received: from [127.0.0.1] (localhost [127.0.0.1])
	by leeor.math.technion.ac.il (8.12.11/8.12.11) with ESMTP id lAKFBpQi000201;
	Tue, 20 Nov 2007 17:11:51 +0200 (IST)
Message-ID: <4742F936.8060205@math.technion.ac.il>
Disposition-Notification-To: "Zvi Har'El" <rl@math.technion.ac.il>
Date: Tue, 20 Nov 2007 17:11:50 +0200
From: "Zvi Har'El" <rl@math.technion.ac.il>
Organization: Technion--Israel Institute of Technology
User-Agent: Thunderbird 2.0.0.9 (X11/20071031)
MIME-Version: 1.0
To: Peter Stephenson <pws@csr.com>
CC: "Zsh Hackers' List" <zsh-workers@sunsite.dk>
Subject: Re: zsh-4.3.4-dev-2.tar.gz
References: <11649.1195558694@csr.com>	<4742DC87.5030901@math.technion.ac.il> <20071120141442.55f7ac28@news01> <4742F733.4030908@math.technion.ac.il>
In-Reply-To: <4742F733.4030908@math.technion.ac.il>
X-Enigmail-Version: 0.95.5
OpenPGP: id=AF1F5245;
	url=http://www.math.technion.ac.il/~rl/etc/pubkey.html
Content-Type: multipart/alternative;
 boundary="------------030607060003040906010406"

This is a multi-part message in MIME format.
--------------030607060003040906010406
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 7bit

Yes. CPPFLAGS=-I/usr/local/include/ncursesw ./configure
--enable-multibyte does the trick.

On 20/11/07 17:03, Zvi Har'El wrote:

> I believe ncurses.h is in the standard place, but not where it is
> configures looks for and the sources include it:
>
> /usr/local/src/build/zsh-4.3.4-dev-2$ grep 'include.*curses' **/*.c
> Src/Modules/curses.c:#include "curses.mdh"
> Src/Modules/curses.c:#include "curses.pro"
> Src/Modules/curses.c:# include <ncurses.h>
> Src/Modules/curses.c:#  include <curses.h>
> Src/Modules/curses.c:#include "curses_keys.h"
> Src/Modules/termcap.c:#   include <curses.h>
> Src/Modules/terminfo.c:# include <curses.h>
>
> /usr/local/src/build/zsh-4.3.4-dev-2$ locate ncurses.h
> /usr/local/include/ncurses/ncurses.h
> /usr/local/include/ncursesw/ncurses.h
>
> so, one should have
> #include <ncursesw/ncurses.h>
>
> rather than
> #include <ncurses.h>
>
> in Src/Modules/curses.c
>
> Perhaps I should add -I/usr/local/include/ncursesw to the CPPFLAGS?
>
> On 20/11/07 16:14, Peter Stephenson wrote:
>> On Tue, 20 Nov 2007 15:09:27 +0200
>> "Zvi Har'El" <rl@math.technion.ac.il> wrote:
>>   
>>> Another problem. I have two Solaris systems, 2.8 and 2.9. The tar, as
>>> well as the CVS Head, do not build. Last time I was able to build was,
>>> from the Head
>>>
>>> -rwxr-xr-x 2 root root 548196 2007-11-08 10:24:53.000000000 +0200
>>> /usr/local/bin/zsh
>>>
>>> The I have in these systems, in addition to Solaris's curses, also gnu
>>> ncurses 5.6 (installed at /usr/local). For some reason, configure finds
>>> ncursesw.so but doesn't find ncurses.h. I attach config.log and
>>> config.h.
>>>     
>>
>> Thanks.  We shouldn't search the ncurses library if we haven't found
>> the ncurses header.
>>
>> Obviously it's better to find the header, but the shell may need help doing
>> that.  I've added a note to the installation instructions.
>>
>> The last hunk was supposed to add "-expect_unresolved '*'" to DLLDFLAGS on
>> Tru64 Unix, but the mail I sent seems to have gone astray.  I haven't
>> tested this.  The idea that the OS still appeared to autoconf as osf* was
>> suggested by Google but I don't know that for sure either.
>>
>> Index: INSTALL
>> ===================================================================
>> RCS file: /cvsroot/zsh/zsh/INSTALL,v
>> retrieving revision 1.32
>> diff -u -r1.32 INSTALL
>> --- INSTALL	12 Oct 2007 10:18:58 -0000	1.32
>> +++ INSTALL	20 Nov 2007 14:08:56 -0000
>> @@ -328,6 +328,14 @@
>>  to the developers at zsh-workers@sunsite.dk and attempt to recompile with
>>  --with-term-lib="tinfo termcap ncurses curses" (see below).
>>  
>> +Note that use of ncurses requires the header ncurses.h, so this
>> +needs to be in the include path.  configure will not search for
>> +ncurses or ncursesw unless this is the case.  If you have installed
>> +ncurses.h in a non-standard place you may need to pass
>> +CPPFLAGS=-I/usr/local/include (or wherever the header is found) to
>> +configure.  Similarly, you may need to pass LDFLAGS=-L/usr/local/lib
>> +(or wherever) in order to find the library.
>> +
>>  On some systems a suitable development package with a name such as
>>  curses-devel or ncurses-devel needs to be installed before zsh can
>>  be compiled.  This is likely to be contained on any installation media,
>> Index: configure.ac
>> ===================================================================
>> RCS file: /cvsroot/zsh/zsh/configure.ac,v
>> retrieving revision 1.78
>> diff -u -r1.78 configure.ac
>> --- configure.ac	10 Nov 2007 20:29:27 -0000	1.78
>> +++ configure.ac	20 Nov 2007 14:08:58 -0000
>> @@ -636,6 +636,17 @@
>>  
>>  AC_CHECK_LIB(m, pow)
>>  
>> +dnl Various features of ncurses depend on having the right header
>> +dnl (the system's own curses.h may well not be good enough).
>> +dnl So don't search for ncurses unless we found the header.
>> +if test x$ac_cv_header_ncurses_h = xyes; then
>> +  ncursesw_test=ncursesw
>> +  ncurses_test=ncurses
>> +else
>> +  ncursesw_test=
>> +  ncurses_test=
>> +fi
>> +
>>  dnl Prefer BSD termcap library to SysV curses library, except on certain
>>  dnl SYSV-derived systems.  However, if we find terminfo and termcap
>>  dnl stuff in the same library we will use that; typically this
>> @@ -648,12 +659,13 @@
>>    termcap_curses_order="$withval"
>>    AC_SEARCH_LIBS(tigetstr, [$termcap_curses_order])
>>  else
>> -  termcap_curses_order="ncursesw tinfo termcap ncurses curses"
>> +  termcap_curses_order="$ncursesw_test tinfo termcap $ncurses_test curses"
>>  fi],
>>  [case "$host_os" in
>>    hpux10.*|hpux11.*|solaris*)
>> -      termcap_curses_order="Hcurses ncursesw ncurses curses termcap" ;;
>> -  *)             termcap_curses_order="ncursesw tinfo termcap ncurses curses" ;;
>> +   termcap_curses_order="Hcurses $ncursesw_test $ncurses_test curses termcap" ;;
>> +  *)
>> +   termcap_curses_order="$ncursesw_test tinfo termcap $ncurses_test curses" ;;
>>  esac])dnl
>>  
>>  AH_TEMPLATE([HAVE_BOOLCODES],
>> @@ -2357,7 +2369,8 @@
>>      esac
>>    fi
>>    case "$host_os" in
>> -    *freebsd*|linux*|irix*|osf*|gnu*|dragonfly*) DLLDFLAGS="${DLLDFLAGS=-shared}" ;;
>> +    osf*) DLLDFLAGS="${DLLDFLAGS=-shared -expect_unresolved '*'}" ;;
>> +    *freebsd*|linux*|irix*|gnu*|dragonfly*) DLLDFLAGS="${DLLDFLAGS=-shared}" ;;
>>      sunos*)       DLLDFLAGS="${DLLDFLAGS=-assert nodefinitions}" ;;
>>      sysv4*|esix*) DLLDFLAGS="${DLLDFLAGS=-G $ldflags}" ;;
>>      netbsd*)      DLLDFLAGS="${DLLDFLAGS=${DLLDARG}-x -shared --whole-archive}" ;;
>>
>>   
>
> -- 
> Dr. Zvi Har'El      mailto:rl@math.technion.ac.il    Department of Mathematics
> tel:+972-54-4227607                  Technion - Israel Institute of Technology
> fax:+972-4-8293388  http://www.math.technion.ac.il/~rl/    Haifa 32000, ISRAEL
> "If you can't say somethin' nice, don't say nothin' at all." -- Thumper (1942)
>   

-- 
Dr. Zvi Har'El      mailto:rl@math.technion.ac.il    Department of Mathematics
tel:+972-54-4227607                  Technion - Israel Institute of Technology
fax:+972-4-8293388  http://www.math.technion.ac.il/~rl/    Haifa 32000, ISRAEL
"If you can't say somethin' nice, don't say nothin' at all." -- Thumper (1942)


--------------030607060003040906010406
Content-Type: text/html; charset=ISO-8859-1
Content-Transfer-Encoding: 7bit

<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html style="direction: ltr;">
<head>
  <meta content="text/html;charset=ISO-8859-1" http-equiv="Content-Type">
</head>
<body style="direction: ltr;" bgcolor="#ffffff" text="#000000">
<p style="margin-bottom: 0cm; margin-top: 0pt;">Yes.
CPPFLAGS=-I/usr/local/include/ncursesw ./configure --enable-multibyte
does the trick.<br>
<br>
On 20/11/07 17:03, Zvi Har'El wrote:<br>
</p>
<blockquote cite="mid:4742F733.4030908@math.technion.ac.il" type="cite">
  <meta content="text/html;charset=ISO-8859-1" http-equiv="Content-Type">
  <title></title>
I believe ncurses.h is in the standard place, but not where it is
configures looks for and the sources include it:<br>
  <br>
/usr/local/src/build/zsh-4.3.4-dev-2$ grep 'include.*curses' **/*.c<br>
Src/Modules/curses.c:#include "curses.mdh"<br>
Src/Modules/curses.c:#include "curses.pro"<br>
Src/Modules/curses.c:# include &lt;ncurses.h&gt;<br>
Src/Modules/curses.c:#&nbsp; include &lt;curses.h&gt;<br>
Src/Modules/curses.c:#include "curses_keys.h"<br>
Src/Modules/termcap.c:#&nbsp;&nbsp; include &lt;curses.h&gt;<br>
Src/Modules/terminfo.c:# include &lt;curses.h&gt;<br>
  <br>
/usr/local/src/build/zsh-4.3.4-dev-2$ locate ncurses.h<br>
/usr/local/include/ncurses/ncurses.h<br>
/usr/local/include/ncursesw/ncurses.h<br>
  <br>
so, one should have <br>
#include &lt;ncursesw/ncurses.h&gt;<br>
  <br>
rather than <br>
#include &lt;ncurses.h&gt;<br>
  <br>
in Src/Modules/curses.c<br>
  <br>
Perhaps I should add -I/usr/local/include/ncursesw to the CPPFLAGS?<br>
  <br>
On 20/11/07 16:14, Peter Stephenson wrote:
  <blockquote cite="mid:20071120141442.55f7ac28@news01" type="cite">
    <pre wrap="">On Tue, 20 Nov 2007 15:09:27 +0200
"Zvi Har'El" <a moz-do-not-send="true" class="moz-txt-link-rfc2396E"
 href="mailto:rl@math.technion.ac.il">&lt;rl@math.technion.ac.il&gt;</a> wrote:
  </pre>
    <blockquote type="cite">
      <pre wrap="">Another problem. I have two Solaris systems, 2.8 and 2.9. The tar, as
well as the CVS Head, do not build. Last time I was able to build was,
from the Head

-rwxr-xr-x 2 root root 548196 2007-11-08 10:24:53.000000000 +0200
/usr/local/bin/zsh

The I have in these systems, in addition to Solaris's curses, also gnu
ncurses 5.6 (installed at /usr/local). For some reason, configure finds
ncursesw.so but doesn't find ncurses.h. I attach config.log and
config.h.
    </pre>
    </blockquote>
    <pre wrap=""><!---->
Thanks.  We shouldn't search the ncurses library if we haven't found
the ncurses header.

Obviously it's better to find the header, but the shell may need help doing
that.  I've added a note to the installation instructions.

The last hunk was supposed to add "-expect_unresolved '*'" to DLLDFLAGS on
Tru64 Unix, but the mail I sent seems to have gone astray.  I haven't
tested this.  The idea that the OS still appeared to autoconf as osf* was
suggested by Google but I don't know that for sure either.

Index: INSTALL
===================================================================
RCS file: /cvsroot/zsh/zsh/INSTALL,v
retrieving revision 1.32
diff -u -r1.32 INSTALL
--- INSTALL	12 Oct 2007 10:18:58 -0000	1.32
+++ INSTALL	20 Nov 2007 14:08:56 -0000
@@ -328,6 +328,14 @@
 to the developers at <a moz-do-not-send="true"
 class="moz-txt-link-abbreviated" href="mailto:zsh-workers@sunsite.dk">zsh-workers@sunsite.dk</a> and attempt to recompile with
 --with-term-lib="tinfo termcap ncurses curses" (see below).
 
+Note that use of ncurses requires the header ncurses.h, so this
+needs to be in the include path.  configure will not search for
+ncurses or ncursesw unless this is the case.  If you have installed
+ncurses.h in a non-standard place you may need to pass
+CPPFLAGS=-I/usr/local/include (or wherever the header is found) to
+configure.  Similarly, you may need to pass LDFLAGS=-L/usr/local/lib
+(or wherever) in order to find the library.
+
 On some systems a suitable development package with a name such as
 curses-devel or ncurses-devel needs to be installed before zsh can
 be compiled.  This is likely to be contained on any installation media,
Index: configure.ac
===================================================================
RCS file: /cvsroot/zsh/zsh/configure.ac,v
retrieving revision 1.78
diff -u -r1.78 configure.ac
--- configure.ac	10 Nov 2007 20:29:27 -0000	1.78
+++ configure.ac	20 Nov 2007 14:08:58 -0000
@@ -636,6 +636,17 @@
 
 AC_CHECK_LIB(m, pow)
 
+dnl Various features of ncurses depend on having the right header
+dnl (the system's own curses.h may well not be good enough).
+dnl So don't search for ncurses unless we found the header.
+if test x$ac_cv_header_ncurses_h = xyes; then
+  ncursesw_test=ncursesw
+  ncurses_test=ncurses
+else
+  ncursesw_test=
+  ncurses_test=
+fi
+
 dnl Prefer BSD termcap library to SysV curses library, except on certain
 dnl SYSV-derived systems.  However, if we find terminfo and termcap
 dnl stuff in the same library we will use that; typically this
@@ -648,12 +659,13 @@
   termcap_curses_order="$withval"
   AC_SEARCH_LIBS(tigetstr, [$termcap_curses_order])
 else
-  termcap_curses_order="ncursesw tinfo termcap ncurses curses"
+  termcap_curses_order="$ncursesw_test tinfo termcap $ncurses_test curses"
 fi],
 [case "$host_os" in
   hpux10.*|hpux11.*|solaris*)
-      termcap_curses_order="Hcurses ncursesw ncurses curses termcap" ;;
-  *)             termcap_curses_order="ncursesw tinfo termcap ncurses curses" ;;
+   termcap_curses_order="Hcurses $ncursesw_test $ncurses_test curses termcap" ;;
+  *)
+   termcap_curses_order="$ncursesw_test tinfo termcap $ncurses_test curses" ;;
 esac])dnl
 
 AH_TEMPLATE([HAVE_BOOLCODES],
@@ -2357,7 +2369,8 @@
     esac
   fi
   case "$host_os" in
-    *freebsd*|linux*|irix*|osf*|gnu*|dragonfly*) DLLDFLAGS="${DLLDFLAGS=-shared}" ;;
+    osf*) DLLDFLAGS="${DLLDFLAGS=-shared -expect_unresolved '*'}" ;;
+    *freebsd*|linux*|irix*|gnu*|dragonfly*) DLLDFLAGS="${DLLDFLAGS=-shared}" ;;
     sunos*)       DLLDFLAGS="${DLLDFLAGS=-assert nodefinitions}" ;;
     sysv4*|esix*) DLLDFLAGS="${DLLDFLAGS=-G $ldflags}" ;;
     netbsd*)      DLLDFLAGS="${DLLDFLAGS=${DLLDARG}-x -shared --whole-archive}" ;;

  </pre>
  </blockquote>
  <br>
  <pre class="moz-signature" cols="79">-- 
Dr. Zvi Har'El      <a moz-do-not-send="true"
 class="moz-txt-link-freetext" href="mailto:rl@math.technion.ac.il">mailto:rl@math.technion.ac.il</a>    Department of Mathematics
tel:+972-54-4227607                  Technion - Israel Institute of Technology
fax:+972-4-8293388  <a moz-do-not-send="true"
 class="moz-txt-link-freetext"
 href="http://www.math.technion.ac.il/%7Erl/">http://www.math.technion.ac.il/~rl/</a>    Haifa 32000, ISRAEL
"If you can't say somethin' nice, don't say nothin' at all." -- Thumper (1942)
  </pre>
</blockquote>
<br>
<pre class="moz-signature" cols="79">-- 
Dr. Zvi Har'El      <a class="moz-txt-link-freetext" href="mailto:rl@math.technion.ac.il">mailto:rl@math.technion.ac.il</a>    Department of Mathematics
tel:+972-54-4227607                  Technion - Israel Institute of Technology
fax:+972-4-8293388  <a class="moz-txt-link-freetext" href="http://www.math.technion.ac.il/~rl/">http://www.math.technion.ac.il/~rl/</a>    Haifa 32000, ISRAEL
"If you can't say somethin' nice, don't say nothin' at all." -- Thumper (1942)
</pre>
</body>
</html>

--------------030607060003040906010406--

