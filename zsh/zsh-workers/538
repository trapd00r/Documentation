From zsh-workers-request@math.gatech.edu  Tue Nov  7 10:43:35 1995
Received: from math.gatech.edu (euclid.skiles.gatech.edu [130.207.146.50]) by werple.net.au (8.7/8.7.1) with SMTP id KAA26437 for <mason@werple.mira.net.au>; Tue, 7 Nov 1995 10:43:19 +1100 (EST)
Received: by math.gatech.edu (5.x/SMI-SVR4)
	id AA14187; Mon, 6 Nov 1995 18:19:44 -0500
Resent-Date: Tue, 7 Nov 1995 00:20:25 +0100 (MET)
Old-Return-Path: <hzoli@cs.elte.hu>
From: Zoltan Hidvegi <hzoli@cs.elte.hu>
Message-Id: <199511062320.AAA09730@bolyai.cs.elte.hu>
Subject: Disabling history saves in init scripts
To: zsh-workers@math.gatech.edu (zsh-workers)
Date: Tue, 7 Nov 1995 00:20:25 +0100 (MET)
X-Mailer: ELM [version 2.4 PL24]
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
Resent-Message-Id: <"sSeGo.0.YT3.FWfdm"@euclid>
Resent-From: zsh-workers@math.gatech.edu
X-Mailing-List: <zsh-workers@math.gatech.edu> archive/latest/538
X-Loop: zsh-workers@math.gatech.edu
Precedence: list
Resent-Sender: zsh-workers-request@math.gatech.edu

Here is a patch which disables history saving from the init scripts.  Explicit
saves with fc are not disabled.

On startup zsh runs all of the init scripts then it examines if the HISTFILE
parameter is set.  If it is set it loads the history from the file it points
to.  This means that we should not save history while executing the init
scripts since we may wipe out the existing history if the HISTFILE parameter
is set.

Cheers,

  Zoltan

*** 1.16	1995/11/05 19:31:55
--- Src/builtin.c	1995/11/06 00:06:18
***************
*** 4464,4470 ****
  	}
      }
      if (unset(NORCS) && interact) {
! 	savehistfile(getsparam("HISTFILE"), 1, isset(APPENDHISTORY) ? 3 : 0);
  	if (islogin && !subsh) {
  	    sourcehome(".zlogout");
  #ifdef GLOBAL_ZLOGOUT
--- 4464,4471 ----
  	}
      }
      if (unset(NORCS) && interact) {
! 	if (!nohistsave)
! 	    savehistfile(getsparam("HISTFILE"), 1, isset(APPENDHISTORY) ? 3 : 0);
  	if (islogin && !subsh) {
  	    sourcehome(".zlogout");
  #ifdef GLOBAL_ZLOGOUT
*** 1.9	1995/11/05 19:41:48
--- Src/exec.c	1995/11/06 00:08:29
***************
*** 1519,1525 ****
  
  	    if (cmd->flags & (CFLAG_EXEC|CFLAG_FAKE_EXEC)) {
  		/* only save the history file on a real exec */
! 		if ((cmd->flags & CFLAG_EXEC) && unset(NORCS) && interact)
  		    savehistfile(getsparam("HISTFILE"), 1, isset(APPENDHISTORY) ? 3 : 0);
  		exit(lastval);
  	    }
--- 1519,1525 ----
  
  	    if (cmd->flags & (CFLAG_EXEC|CFLAG_FAKE_EXEC)) {
  		/* only save the history file on a real exec */
! 		if ((cmd->flags & CFLAG_EXEC) && unset(NORCS) && interact && !nohistsave)
  		    savehistfile(getsparam("HISTFILE"), 1, isset(APPENDHISTORY) ? 3 : 0);
  		exit(lastval);
  	    }
***************
*** 1531,1537 ****
  	    /* only save the history file on a real exec */
  	    if (cmd->flags & CFLAG_EXEC) {
  		setiparam("SHLVL", --shlvl);
! 		if (unset(NORCS) && interact)
  		    /* save the history file through execs */
  		    savehistfile(getsparam("HISTFILE"), 1, isset(APPENDHISTORY) ? 3 : 0);
  	    }
--- 1531,1537 ----
  	    /* only save the history file on a real exec */
  	    if (cmd->flags & CFLAG_EXEC) {
  		setiparam("SHLVL", --shlvl);
! 		if (unset(NORCS) && interact && !nohistsave)
  		    /* save the history file through execs */
  		    savehistfile(getsparam("HISTFILE"), 1, isset(APPENDHISTORY) ? 3 : 0);
  	    }
*** 1.9	1995/11/05 19:59:57
--- Src/globals.h	1995/11/05 19:59:58
***************
*** 98,103 ****
--- 98,107 ----
   * trapping of SIGZERR, SIGEXIT. */
  
  EXTERN int noerrexit;
+ 
+ /* do not save history on exec and exit */
+ 
+ EXTERN int nohistsave;
   
  /* error/break flag */
   
*** 1.9	1995/11/05 20:02:20
--- Src/init.c	1995/11/06 00:05:21
***************
*** 688,693 ****
--- 688,694 ----
      locallevel = sourcelevel = 0;
      trapreturn = 0;
      noerrexit = 0;
+     nohistsave = 1;
      dirstack = newlinklist();
      bufstack = newlinklist();
      hsubl = hsubr = NULL;
***************
*** 796,801 ****
--- 797,803 ----
  	}
      }
      noerrexit = 0;
+     nohistsave = 0;
  }
  
  /* Miscellaneous initializations that happen after init scripts are run */

