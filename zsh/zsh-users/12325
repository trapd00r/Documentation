From zsh-users-return-12325-mason-zsh=primenet.com.au@sunsite.dk Wed Dec 12 16:57:39 2007
Return-Path: <zsh-users-return-12325-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 5164 invoked from network); 12 Dec 2007 16:57:31 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.3 (2007-08-08) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.3
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 12 Dec 2007 16:57:31 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 36308 invoked from network); 12 Dec 2007 16:56:58 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 12 Dec 2007 16:56:58 -0000
Received: (qmail 16287 invoked by alias); 12 Dec 2007 16:56:46 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 12325
Received: (qmail 16271 invoked from network); 12 Dec 2007 16:56:45 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 12 Dec 2007 16:56:45 -0000
Received: from virusfilter.dotsrc.org (bifrost [127.0.0.1])
	by spamfilter.dotsrc.org (Postfix) with ESMTP id 24D338058F53
	for <zsh-users@sunsite.dk>; Wed, 12 Dec 2007 17:54:06 +0100 (CET)
Received: from cluster-g.mailcontrol.com (cluster-g.mailcontrol.com [85.115.41.190])
	by bifrost.dotsrc.org (Postfix) with ESMTP
	for <zsh-users@sunsite.dk>; Wed, 12 Dec 2007 17:54:05 +0100 (CET)
Received: from cameurexb01.EUROPE.ROOT.PRI ([62.189.241.200])
	by rly16g.srv.mailcontrol.com (MailControl) with ESMTP id lBCGtcNw010422
	for <zsh-users@sunsite.dk>; Wed, 12 Dec 2007 16:56:29 GMT
Received: from news01 ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.1830);
	 Wed, 12 Dec 2007 16:55:08 +0000
Date: Wed, 12 Dec 2007 16:55:08 +0000
From: Peter Stephenson <pws@csr.com>
To: Zsh users list <zsh-users@sunsite.dk>
Subject: Re: 4.3.4-dev-4 and 4.2.6-dev-2 available
Message-ID: <20071212165508.51186a06@news01>
In-Reply-To: <200712121510.lBCFAS8Z030561@news01.csr.com>
References: <22582.1197372038@csr.com>
	<20071212010837.GZ13079@prunille.vinc17.org>
	<20071212130703.5e6931dc@news01>
	<20071212143146.GD28728@prunille.vinc17.org>
	<200712121510.lBCFAS8Z030561@news01.csr.com>
Organization: CSR
X-Mailer: Claws Mail 3.1.0 (GTK+ 2.10.14; i386-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
X-OriginalArrivalTime: 12 Dec 2007 16:55:08.0813 (UTC) FILETIME=[C0AF0BD0:01C83CDF]
X-Scanned-By: MailControl A-06-00-00 (www.mailcontrol.com) on 10.71.0.126
X-Virus-Scanned: ClamAV using ClamSMTP

On Wed, 12 Dec 2007 15:10:28 +0000
Peter Stephenson <pws@csr.com> wrote:
> Vincent Lefevre wrote:
> > > Furthermore, this change makes
> > >   ( ! -e ) )
> > > an error:
> > 
> > Hmm... I don't think so.
> 
> I'm now inclined to leave this alone and just make the explicit tests
> for numbers of arguments up to and including 4.

I think all we need to change is the following (the other rules are already
handled either by the normal syntax or explicit tests), which is
reassuringly simple and localized and worries me a lot less than the
previous patch.

I have, however, attempted to worry users more.

Index: Doc/Zsh/builtins.yo
===================================================================
RCS file: /cvsroot/zsh/zsh/Doc/Zsh/builtins.yo,v
retrieving revision 1.100
diff -u -r1.100 builtins.yo
--- Doc/Zsh/builtins.yo	12 Dec 2007 13:46:37 -0000	1.100
+++ Doc/Zsh/builtins.yo	12 Dec 2007 16:53:25 -0000
@@ -1235,7 +1235,15 @@
 syntactically, so for example an empty variable expansion may cause an
 argument to be omitted; syntax errors cause status 2 to be returned instead
 of a shell error; and arithmetic operators expect integer arguments rather
-than arithemetic expressions.
+than arithmetic expressions.
+
+The command attempts to implement POSIX and its extensions where these
+are specified.  Unfortunately there are intrinisic ambiguities in
+the syntax; in particular there is no distinction between test operators
+and strings that resemble them.  The standard attempts to resolve these
+for small numbers of arguments (up to four); for five or more arguments
+compatibility cannot be relied on.  Users are urged wherever possible to
+use the `tt([[)' test syntax which does not have these ambiguities.
 )
 findex(times)
 cindex(shell, timing)
Index: Src/builtin.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/builtin.c,v
retrieving revision 1.182
diff -u -r1.182 builtin.c
--- Src/builtin.c	11 Dec 2007 14:05:53 -0000	1.182
+++ Src/builtin.c	12 Dec 2007 16:53:26 -0000
@@ -5506,6 +5506,7 @@
     char **s;
     Eprog prog;
     struct estate state;
+    int nargs;
 
     /* if "test" was invoked as "[", it needs a matching "]" *
      * which is subsequently ignored                         */
@@ -5521,6 +5522,20 @@
     if (!*argv)
 	return 1;
 
+    /*
+     * Implement some XSI extensions to POSIX here.
+     * See
+     * http://www.opengroup.org/onlinepubs/009695399/utilities/test.html.
+     */
+    nargs = arrlen(argv);
+    if (nargs == 3 || nargs == 4)
+    {
+	if (*argv[0] == '(' && *argv[nargs-1] == ')') {
+	    argv[nargs-1] = NULL;
+	    argv++;
+	}
+    }
+
     testargs = argv;
     tok = NULLTOK;
     condlex = testlex;

-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070

