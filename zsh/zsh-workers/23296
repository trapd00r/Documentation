From zsh-workers-return-23296-mason-zsh=primenet.com.au@sunsite.dk Tue Apr 17 15:49:00 2007
Return-Path: <zsh-workers-return-23296-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 11938 invoked from network); 17 Apr 2007 15:48:56 -0000
X-Spam-Checker-Version: SpamAssassin 3.1.8 (2007-02-13) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=BAYES_00,FORGED_RCVD_HELO
	autolearn=ham version=3.1.8
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 17 Apr 2007 15:48:56 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 85761 invoked from network); 17 Apr 2007 15:48:47 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 17 Apr 2007 15:48:47 -0000
Received: (qmail 21074 invoked by alias); 17 Apr 2007 15:48:42 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 23296
Received: (qmail 21064 invoked from network); 17 Apr 2007 15:48:40 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 17 Apr 2007 15:48:40 -0000
Received: (qmail 85294 invoked from network); 17 Apr 2007 15:48:40 -0000
Received: from cs1.cs.huji.ac.il (132.65.16.10)
  by a.mx.sunsite.dk with SMTP; 17 Apr 2007 15:48:37 -0000
Received: from w3.cs.huji.ac.il ([132.65.16.18] helo=webmail.cs.huji.ac.il)
	by cs1.cs.huji.ac.il with esmtp
	id 1Hdpv1-000DLI-Qc; Tue, 17 Apr 2007 18:48:35 +0300
Received: from 192.114.82.139
        (SquirrelMail authenticated user davidpeer)
        by webmail.cs.huji.ac.il with HTTP;
        Tue, 17 Apr 2007 18:48:35 +0300 (IDT)
Message-ID: <10057.192.114.82.139.1176824915.squirrel@webmail.cs.huji.ac.il>
In-Reply-To: <20070417141526.GA56078@cs.huji.ac.il>
References: <462493C0.20700@cowan.name>
    <20070417141526.GA56078@cs.huji.ac.il>
Date: Tue, 17 Apr 2007 18:48:35 +0300 (IDT)
Subject: Re: Bug in ulimit ?
From: David Peer <davidpeer@cs.huji.ac.il>
To: "Tom Alsberg" <alsbergt@cs.huji.ac.il>
Cc: "Micah Cowan" <micah@cowan.name>,
 "David Peer" <davidpeer@cs.huji.ac.il>,
 "Zsh Workers List" <zsh-workers@sunsite.dk>
User-Agent: SquirrelMail/1.5.2 [CVS]
MIME-Version: 1.0
Content-Type: text/plain;charset=iso-8859-1
Content-Transfer-Encoding: 8bit

Thanks Tom for quick, fast fix and for sending me and others the kernel
patch.
Lets hope kernel developers will apply it in the next release, although
they know about it since 2.6.17.

Thanks!
David

On Tue, April 17, 2007 5:15 pm, Tom Alsberg wrote:
> I checked the problem earlier today (by reference of David who pointed
> it out to me - thanks, David).  The problem is apparently in the Linux
> kernel, where the check for trying to set RLIMIT_CPU = 0 is done a bit too
> late, and has nothing to do with zsh.  Specifically, the same symptoms
> were visible with other shells (ash, bash) too.
>
> I checked the Linux kernel sources and found the solution in
> kernel/sys.c.  Attached is a copy of my message with the patch to the
> Linux-Kernel Mailing List.
>
>
> One issue that may be relevant within zsh, though, is that it appears
> that zsh caches the limits set, and since that check in Linux "cheats" by
> setting the value to 1 when 0 is requested, entering "ulimit -a" does not
> call getrlimit(...) at all and does show 0 after issuing the command
> "ulimit -t 0", although getrlimit(RLIMIT_CPU, ...) would
> return 1.  The correct limit is seen in a subshell where this is not yet
> cached.
>
> I expect my patch to be in the next Linux 2.6.21 release candidate.
>
>
> Cheers,
> -- Tom
>
>
> On Tue, Apr 17, 2007 at 02:30:40AM -0700, Micah Cowan wrote:
>
>> David Peer wrote:
>>
>>> If the user run: ulimit -t 0, he can run jobs without any cputime
>>> limitation:
>>>
>>
>> This sounds more like a kernel problem to me than a zsh bug. I get the
>> same behavior on my Ubuntu 7.04 (beta) system, in _bash_.
>>
>> I note that getrlimit(2) says:
>>
>>
>> In 2.6.x kernels before 2.6.17, a RLIMIT_CPU  limit  of  0  is  wrongly
>>  treated  as "no limit" (like RLIM_INFINITY).  Since kernel 2.6.17,
>> set‐ ting a limit of 0 does have an effect, but is  actually  treated
>> as  a limit of 1 second.
>>
>> However, I'm running 2.6.20(-14-generic), and still experiencing that
>> symptom.
>
> --
> Tom Alsberg - hacker (being the best description fitting this space)
> Web page:	http://www.cs.huji.ac.il/~alsbergt/
> DISCLAIMER:  The above message does not even necessarily represent what
> my fingers have typed on the keyboard, save anything further.
>


