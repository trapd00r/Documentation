From zsh-workers-return-28202-mason-zsh=primenet.com.au@zsh.org Tue Aug 24 17:38:30 2010
Return-Path: <zsh-workers-return-28202-mason-zsh=primenet.com.au@zsh.org>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 5187 invoked by alias); 24 Aug 2010 17:38:30 -0000
Mailing-List: contact zsh-workers-help@zsh.org; run by ezmlm
Precedence: bulk
X-No-Archive: yes
List-Id: Zsh Workers List <zsh-workers.zsh.org>
List-Post: <mailto:zsh-workers@zsh.org>
List-Help: <mailto:zsh-workers-help@zsh.org>
Delivered-To: mailing list zsh-workers@zsh.org
X-Seq: 28202
Received: (qmail 10452 invoked from network); 24 Aug 2010 17:38:27 -0000
X-Spam-Checker-Version: SpamAssassin 3.3.1 (2010-03-16) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.0 required=5.0 tests=BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,FREEMAIL_FROM,RCVD_IN_DNSWL_NONE autolearn=ham
	version=3.3.1
Received-SPF: pass (ns1.primenet.com.au: SPF record at _spf.google.com designates 209.85.212.43 as permitted sender)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=gamma;
        h=domainkey-signature:mime-version:received:received:in-reply-to
         :references:date:message-id:subject:from:to:content-type;
        bh=rP2tPCD7Wt8TxEwEZtMA+uxPlrFIqnShSI8fLGRwyJE=;
        b=DxPPSUbcWqWT83EIHBES3MvJbi/zb6Lyz/3ZdY8NNr7kmJZHUto3ajDGqolMW65AxC
         ptIBwjsn5++1MU6CsBJyYY2fg6nX/afc53+X23npfnh37jrxgV8u7e74i9hWAFFuUtE+
         35R7QrpBAk5UTxRHyuQmhGpJyzkbjqkHcJcBE=
DomainKey-Signature: a=rsa-sha1; c=nofws;
        d=gmail.com; s=gamma;
        h=mime-version:in-reply-to:references:date:message-id:subject:from:to
         :content-type;
        b=MDH9xyqLtIsS1WnTGWn1jRtg8BqJLOqWaKQQk2wgkg+OPLnEoB6bm3oyuiEMOX3mYL
         MD1SHs8Szqt5KtrmUD1bbREZIdhiGJRq8Xb09wtPFkK1BIqRBAipMqz4PI7uFZy2zV2x
         0l2xYQagJUijxZMnlcaKKamySIpjwtWySEoFY=
MIME-Version: 1.0
In-Reply-To: <100824094939.ZM28482@torch.brasslantern.com>
References: <AANLkTikuH91W+P4bWKTEVzW=gtBZQfPwDJQphKyy=mz1@mail.gmail.com>
	<100824081606.ZM28228@torch.brasslantern.com>
	<AANLkTik+UHjVpnwq7LiKQrRZQJQGDi0t+1J3zKWEwLJq@mail.gmail.com>
	<100824094939.ZM28482@torch.brasslantern.com>
Date: Tue, 24 Aug 2010 19:38:21 +0200
Message-ID: <AANLkTikB0H4b+7sygv8fS+yrxwD6Ua+66FAML6vwNK5C@mail.gmail.com>
Subject: Re: Crash in reverse-menu-complete with menu-selection
From: Mikael Magnusson <mikachu@gmail.com>
To: zsh workers <zsh-workers@zsh.org>
Content-Type: text/plain; charset=UTF-8

On 24 August 2010 18:49, Bart Schaefer <schaefer@brasslantern.com> wrote:
> On Aug 24,  5:23pm, Mikael Magnusson wrote:
> }
> } > I can't reproduce, but when I hit that first ctrl-f I still get nothing,
> } > as reported in the earlier thread about menu-select crashing.
> }
> } Which one?
>
> Starts with workers/28150, here:
> http://www.zsh.org/mla/workers/2010/msg00599.html
> Get's interesting 28158, here:
> http://www.zsh.org/mla/workers/2010/msg00607.html

Compiling with --enable-zsh-debug prints zle_utils.c:1153: line
metafied which means... something? It looks like one of zleline and
zlemetaline is always NULL, and at this point the wrong one is.

Hmm... this fixes it (ie, this specific case) but I have absolutely no
idea which of these functions expect the line to be metafied and
unmetafied, and who is doing it wrong.

diff --git a/Src/Zle/complist.c b/Src/Zle/complist.c
index bac072e..37ccc7b 100644
--- a/Src/Zle/complist.c
+++ b/Src/Zle/complist.c
@@ -3217,7 +3217,9 @@ domenuselect(Hookdef dummy, Chdata dat)
                   !strcmp(cmd->nam, "reverse-menu-complete")) {
             mode = 0;
            comprecursive = 1;
+            unmetafy_line();
            reversemenucomplete(zlenoargs);
+            metafy_line();
            mselect = (*(minfo.cur))->gnum;
            setwish = 1;

-- 
Mikael Magnusson

