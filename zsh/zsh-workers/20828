From zsh-workers-return-20828-mason-zsh=primenet.com.au@sunsite.dk Fri Feb 18 17:26:31 2005
Return-Path: <zsh-workers-return-20828-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 29664 invoked from network); 18 Feb 2005 17:26:30 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 18 Feb 2005 17:26:30 -0000
Received: (qmail 23813 invoked from network); 18 Feb 2005 17:26:24 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 18 Feb 2005 17:26:24 -0000
Received: (qmail 28216 invoked by alias); 18 Feb 2005 17:26:21 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 20828
Received: (qmail 28200 invoked from network); 18 Feb 2005 17:26:21 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 18 Feb 2005 17:26:21 -0000
Received: (qmail 23497 invoked from network); 18 Feb 2005 17:26:21 -0000
Received: from mailhost1.csr.com (HELO MAILSWEEPER01.csr.com) (81.105.217.43)
  by a.mx.sunsite.dk with SMTP; 18 Feb 2005 17:26:10 -0000
Received: from exchange03.csr.com (unverified [10.100.137.60]) by MAILSWEEPER01.csr.com
 (Content Technologies SMTPRS 4.3.12) with ESMTP id <T6f32e8b6670a6c8d018f0@MAILSWEEPER01.csr.com> for <zsh-workers@sunsite.dk>;
 Fri, 18 Feb 2005 17:24:41 +0000
Received: from news01.csr.com ([10.103.143.38]) by exchange03.csr.com with Microsoft SMTPSVC(5.0.2195.6713);
	 Fri, 18 Feb 2005 17:26:52 +0000
Received: from news01.csr.com (localhost.localdomain [127.0.0.1])
	by news01.csr.com (8.13.1/8.12.11) with ESMTP id j1IHQ8mA009674
	for <zsh-workers@sunsite.dk>; Fri, 18 Feb 2005 17:26:08 GMT
Received: from csr.com (pws@localhost)
	by news01.csr.com (8.13.1/8.13.1/Submit) with ESMTP id j1IHQ8Jn009671
	for <zsh-workers@sunsite.dk>; Fri, 18 Feb 2005 17:26:08 GMT
Message-Id: <200502181726.j1IHQ8Jn009671@news01.csr.com>
X-Authentication-Warning: news01.csr.com: pws owned process doing -bs
To: zsh-workers@sunsite.dk (Zsh hackers list)
Subject: Re: PATCH: zle input changes for Unicode 
In-reply-to: <1050218165946.ZM19867@candle.brasslantern.com> 
References: <200502181350.j1IDobbt031241@news01.csr.com> <1050218165946.ZM19867@candle.brasslantern.com>
Date: Fri, 18 Feb 2005 17:26:07 +0000
From: Peter Stephenson <pws@csr.com>
X-OriginalArrivalTime: 18 Feb 2005 17:26:52.0936 (UTC) FILETIME=[0963E880:01C515DF]
X-Spam-Checker-Version: SpamAssassin 3.0.2 on a.mx.sunsite.dk
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=6.0 tests=AWL,BAYES_00 autolearn=ham 
	version=3.0.2
X-Spam-Hits: -2.5

Bart Schaefer wrote:
> The obvious question is whether there is any case where getkey() was
> called but lastchar was not updated.  Scanning through the patch I see
> two places where that might have been true -- in deltochar() and in
> getkeybuf() -- and one where it appears really to be true, that is, in
> getzlequery().  But maybe the callers fix up something thereafter, I
> didn't look carefully at the whole context.

The question then was whether the callers of those functions would want
to have something other than the actual last character read available to
them.  I didn't think that was the case.

Previously, lastchar was always set to the return value from the only
call to getkeybuf, which must surely be the same value it's set to now,
right?  (In fact getkeybuf doesn't need to return that byte at all now,
so it might be neater to remove it.)

> Misc. remarks:
> 
> Is last_widechar_valid set to 1 too soon in getrestchar()?

If you mean, should it be set when last_widechar is set to WEOF as well
as when it's a genuine character, the answer is yes; WEOF is a usable
value as far as the rest of the code is concerned.  (It needs to be
tested before inserting, etc., but we don't want to attempt to read more
of a multibyte character, which would be the result of setting the flag
false.)

> Sometimes you assign 1 to last_widechar_valid, and sometimes TRUE.

Gag.  TRUE isn't even defined.  I've borrowed that from the other code I
was writing today.

Index: Src/Zle/zle_misc.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/zle_misc.c,v
retrieving revision 1.15
diff -u -r1.15 zle_misc.c
--- Src/Zle/zle_misc.c	18 Feb 2005 13:57:28 -0000	1.15
+++ Src/Zle/zle_misc.c	18 Feb 2005 17:21:59 -0000
@@ -86,7 +86,7 @@
      * with multibyte input.
      */
     lastchar_wide = (ZLE_CHAR_T)lastchar;
-    lastchar_wide_valid = TRUE;
+    lastchar_wide_valid = 1;
 #endif
 }
 
Index: Src/Zle/zle_tricky.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/zle_tricky.c,v
retrieving revision 1.48
diff -u -r1.48 zle_tricky.c
--- Src/Zle/zle_tricky.c	18 Feb 2005 13:57:28 -0000	1.48
+++ Src/Zle/zle_tricky.c	18 Feb 2005 17:22:00 -0000
@@ -2308,7 +2308,7 @@
      * since lastchar is a full character, but it's safer anyway...
      */
     lastchar_wide = L' ';
-    lastchar_wide_valid = TRUE;
+    lastchar_wide_valid = 1;
 #endif
 }
 


-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070


**********************************************************************
This email and any files transmitted with it are confidential and
intended solely for the use of the individual or entity to whom they
are addressed. If you have received this email in error please notify
the system manager.

**********************************************************************

