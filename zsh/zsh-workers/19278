From zsh-workers-return-19278-mason-zsh=primenet.com.au@sunsite.dk Fri Dec 05 11:33:34 2003
Return-Path: <zsh-workers-return-19278-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 8332 invoked from network); 5 Dec 2003 11:33:28 -0000
Received: from sunsite.dk (130.225.247.90)
  by ns1.primenet.com.au with SMTP; 5 Dec 2003 11:33:28 -0000
Received: (qmail 8344 invoked by alias); 5 Dec 2003 11:33:01 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 19278
Received: (qmail 8332 invoked from network); 5 Dec 2003 11:33:01 -0000
Received: from localhost (HELO sunsite.dk) (127.0.0.1)
  by localhost with SMTP; 5 Dec 2003 11:33:01 -0000
X-MessageWall-Score: 0 (sunsite.dk)
Received: from [193.109.254.211] by sunsite.dk (MessageWall 1.0.8) with SMTP; 5 Dec 2003 11:33:1 -0000
X-VirusChecked: Checked
X-Env-Sender: okiddle@yahoo.co.uk
X-Msg-Ref: server-9.tower-36.messagelabs.com!1070623979!2294942
X-StarScan-Version: 5.1.13; banners=-,-,-
Received: (qmail 5960 invoked from network); 5 Dec 2003 11:32:59 -0000
Received: from iris.logica.co.uk (158.234.9.163)
  by server-9.tower-36.messagelabs.com with SMTP; 5 Dec 2003 11:32:59 -0000
Received: from gmcs3.local ([158.234.142.61])
	by iris.logica.co.uk (8.12.3/8.12.3/Debian -4) with ESMTP id hB5BWxuB011473
	for <zsh-workers@sunsite.dk>; Fri, 5 Dec 2003 11:32:59 GMT
Received: from gmcs3.local (localhost [127.0.0.1])
	by gmcs3.local (8.11.6/8.11.6/SuSE Linux 0.5) with ESMTP id hB5Bau215584
	for <zsh-workers@sunsite.dk>; Fri, 5 Dec 2003 12:36:56 +0100
X-VirusChecked: Checked
X-StarScan-Version: 5.1.13; banners=.,-,-
From: Oliver Kiddle <okiddle@yahoo.co.uk>
To: Zsh workers <zsh-workers@sunsite.dk>
Subject: Adding the original string from completion
Date: Fri, 05 Dec 2003 12:36:56 +0100
Message-ID: <15582.1070624216@gmcs3.local>

A good few completers can insert the original string as a match
allowing the user to easily get back to what they typed first. 
Typically, this is done with a line looking like this:

compadd "$expl[@]" -U -Q - "$PREFIX$SUFFIX"

When called from _prefix, the result is that the suffix is lost.

The fix is to change the line to:

compadd "$expl[@]" -i "$IPREFIX" -I "$ISUFFIX" -U -Q - "$PREFIX$SUFFIX"

Only problem is if _prefix's add-space style is set. It sticks an
additional space at the beginning of ISUFFIX. That space is then
inserted after the cursor. That's still better than loosing the suffix
so I will do this change as a minimum. Adding $words[CURRENT], which is
unchanged, as the match looses the cursor position so that isn't much
help.

The hack round this is to use something like:
  local isuf=${words[CURRENT][1+${#:-$QIPREFIX$IPREFIX$PREFIX$SUFFIX},-1]}
  compadd "$expl[@]" -I "$isuf" -Q -U -S '' - "$IPREFIX$PREFIX$SUFFIX"

Though that needs a bit more tweaking to cope with all forms of
quoting.

This amounts to trusting $words[CURRENT] to be unchanged instead of
$ISUFFIX. If we do this, I'm inclined to factor it out into an new
_original function though. Anyone got any better ideas? Does that hack
seem reasonable?

_ignored is actually not using -Q or -U so it can end up quoting the
original string too. So that needs fixing.

There is also the option of only adding original strings at the end from
_main_complete. Given certain styles and whether menu completion if
enabled that is.

Oliver

