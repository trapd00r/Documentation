From zsh-workers-return-25443-mason-zsh=primenet.com.au@sunsite.dk Tue Aug 12 19:47:07 2008
Return-Path: <zsh-workers-return-25443-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 13929 invoked from network); 12 Aug 2008 19:46:55 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 12 Aug 2008 19:46:55 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 34098 invoked from network); 12 Aug 2008 19:46:32 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 12 Aug 2008 19:46:32 -0000
Received: (qmail 3114 invoked by alias); 12 Aug 2008 19:46:17 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 25443
Received: (qmail 3079 invoked from network); 12 Aug 2008 19:46:10 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 12 Aug 2008 19:46:10 -0000
Received: from mtaout01-winn.ispmail.ntl.com (mtaout01-winn.ispmail.ntl.com [81.103.221.47])
	by bifrost.dotsrc.org (Postfix) with ESMTP id E143780EA0B3
	for <zsh-workers@sunsite.dk>; Tue, 12 Aug 2008 21:46:05 +0200 (CEST)
Received: from aamtaout03-winn.ispmail.ntl.com ([81.103.221.35])
          by mtaout01-winn.ispmail.ntl.com with ESMTP
          id <20080812194605.LUYC777.mtaout01-winn.ispmail.ntl.com@aamtaout03-winn.ispmail.ntl.com>
          for <zsh-workers@sunsite.dk>; Tue, 12 Aug 2008 20:46:05 +0100
Received: from pws-pc.ntlworld.com ([81.107.40.67])
          by aamtaout03-winn.ispmail.ntl.com with ESMTP
          id <20080812194605.YFFT29597.aamtaout03-winn.ispmail.ntl.com@pws-pc.ntlworld.com>
          for <zsh-workers@sunsite.dk>; Tue, 12 Aug 2008 20:46:05 +0100
Received: from pws-pc (pws-pc [127.0.0.1])
	by pws-pc.ntlworld.com (8.14.2/8.14.2) with ESMTP id m7CJk2MR008934
	for <zsh-workers@sunsite.dk>; Tue, 12 Aug 2008 20:46:02 +0100
From: Peter Stephenson <p.w.stephenson@ntlworld.com>
To: zsh-workers@sunsite.dk (Zsh hackers list)
Subject: PATCH: trace information for sourced files
X-Mailer: MH-E 8.0.3; nmh 1.3; GNU Emacs 22.2.1
Date: Tue, 12 Aug 2008 20:46:02 +0100
Message-ID: <8933.1218570362@pws-pc>
X-Virus-Scanned: ClamAV 0.92.1/8020/Tue Aug 12 20:03:03 2008 on bifrost
X-Virus-Status: Clean

This enables the trace information for sourced files.  Again, the key is
to make sure the information reflects the calling context.

I'm not sure what to put in $funcsourcetrace since there is no separate
point of definition from that of the caller in this case.  As we need
something to keep the array lengths consistent, I've simply put in the
same information as in $functrace.  Arguably it should be something
special.

Note that I will be away for holiday in two parts after tomorrow.

Index: Doc/Zsh/mod_parameter.yo
===================================================================
RCS file: /cvsroot/zsh/zsh/Doc/Zsh/mod_parameter.yo,v
retrieving revision 1.9
diff -u -r1.9 mod_parameter.yo
--- Doc/Zsh/mod_parameter.yo	11 Aug 2008 19:22:54 -0000	1.9
+++ Doc/Zsh/mod_parameter.yo	12 Aug 2008 19:39:43 -0000
@@ -173,6 +173,9 @@
 function in native zsh format where only the body of the function occurs
 in the file the line number is reported as zero.
 The format of each element is var(filename)tt(:)var(lineno).
+Trace information is also shown for files that have been executed
+by the tt(source) or tt(.) builtins; in this case it
+is identical to that provided by the tt(functrace) parameter.
 )
 vindex(funcstack)
 item(tt(funcstack))(
@@ -185,5 +188,7 @@
 This array contains the names and line numbers of the callers
 corresponding to the functions currently being executed.
 The format of each element is var(name)tt(:)var(lineno).
+Callers are also shown for sourced files; the caller is the point
+where the tt(source) or tt(.) command was executed.
 )
 enditem()
Index: Src/init.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/init.c,v
retrieving revision 1.92
diff -u -r1.92 init.c
--- Src/init.c	11 Aug 2008 19:22:54 -0000	1.92
+++ Src/init.c	12 Aug 2008 19:39:43 -0000
@@ -1100,16 +1100,17 @@
     trap_state = TRAP_STATE_INACTIVE;
 
     sourcelevel++;
-    /* { */
-    /*   struct funcstack fstack; */
-    /*   fstack.name = dupstring("source"); */
-    /*   fstack.caller = dupstring(scriptfilename); */
-    /*   fstack.flineno = oldlineno; */
-    /*   fstack.lineno = oldlineno; */
-    /*   fstack.filename = NULL; */
-    /*   fstack.prev = funcstack; */
-    /*   funcstack = &fstack; */
-    /* } */
+    {
+       struct funcstack fstack;
+       fstack.name = dupstring("source");
+       fstack.caller = dupstring(old_scriptfilename ? old_scriptfilename :
+				 "zsh");
+       fstack.flineno = oldlineno;
+       fstack.lineno = oldlineno;
+       fstack.filename = fstack.caller;
+       fstack.prev = funcstack;
+       funcstack = &fstack;
+    }
     
     if (prog) {
 	pushheap();
@@ -1118,7 +1119,7 @@
 	popheap();
     } else
 	loop(0, 0);		     /* loop through the file to be sourced  */
-    /* funcstack = funcstack->prev; */
+    funcstack = funcstack->prev;
     sourcelevel--;
 
     trap_state = otrap_state;
Index: Test/V06parameter.ztst
===================================================================
RCS file: /cvsroot/zsh/zsh/Test/V06parameter.ztst,v
retrieving revision 1.2
diff -u -r1.2 V06parameter.ztst
--- Test/V06parameter.ztst	11 Aug 2008 19:29:26 -0000	1.2
+++ Test/V06parameter.ztst	12 Aug 2008 19:39:43 -0000
@@ -1,5 +1,8 @@
 %test
 
+  print 'print In sourced file
+  print $LINENO + $functrace + $funcsourcetrace
+  ' >sourcedfile
   print -r -- 'print Started functrace.zsh
   module_path=(./Modules)
   print $LINENO + $functrace + $funcsourcetrace
@@ -20,7 +23,8 @@
   autoload autofn
   :
   autofn
-  autofn' >functrace.zsh
+  autofn
+  . ./sourcedfile' >functrace.zsh
   $ZTST_testdir/../Src/zsh +Z -f ./functrace.zsh
 0:Function tracing
 >Started functrace.zsh
@@ -31,3 +35,5 @@
 >2 + ./functrace.zsh:20 + ./autofn:0
 >Inside autofn
 >2 + ./functrace.zsh:21 + ./autofn:0
+>In sourced file
+>2 + ./functrace.zsh:22 + ./functrace.zsh:22


-- 
Peter Stephenson <p.w.stephenson@ntlworld.com>
Web page now at http://homepage.ntlworld.com/p.w.stephenson/

