From zsh-workers-return-21313-mason-zsh=primenet.com.au@sunsite.dk Mon Jun 06 16:43:04 2005
Return-Path: <zsh-workers-return-21313-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 564 invoked from network); 6 Jun 2005 16:43:03 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 6 Jun 2005 16:43:03 -0000
Received: (qmail 32334 invoked from network); 6 Jun 2005 16:42:57 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 6 Jun 2005 16:42:57 -0000
Received: (qmail 9861 invoked by alias); 6 Jun 2005 16:42:47 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 21313
Received: (qmail 9719 invoked from network); 6 Jun 2005 16:42:45 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 6 Jun 2005 16:42:45 -0000
Received: (qmail 30006 invoked from network); 6 Jun 2005 16:42:45 -0000
Received: from cluster-e.mailcontrol.com (HELO rly16e.srv.mailcontrol.com) (217.79.216.190)
  by a.mx.sunsite.dk with SMTP; 6 Jun 2005 16:42:34 -0000
Received: from iris.logica.co.uk (iris.logica.co.uk [158.234.9.163])
	by rly16e.srv.mailcontrol.com (MailControl) with ESMTP id j56GgUe5018950;
	Mon, 6 Jun 2005 17:42:31 +0100
Received: from trentino.logica.co.uk ([158.234.142.59])
	by iris.logica.co.uk (8.12.3/8.12.3/Debian -4) with ESMTP id j56GgUKM012965;
	Mon, 6 Jun 2005 17:42:30 +0100
Received: from trentino.groupinfra.com (localhost [127.0.0.1])
	by trentino.logica.co.uk (Postfix) with ESMTP id 031142FD30;
	Mon,  6 Jun 2005 18:42:29 +0200 (CEST)
X-VirusChecked: Checked
X-StarScan-Version: 5.0.7; banners=.,-,-
In-reply-to: <20050602123718.GA21218@xpeerience.u-strasbg.fr> 
From: Oliver Kiddle <okiddle@yahoo.co.uk>
References: <20050527141638.GA9644@xpeerience.u-strasbg.fr> <7779.1117444705@trentino.groupinfra.com> <20050530135757.GA12204@xpeerience.u-strasbg.fr> <13199.1117464233@trentino.groupinfra.com> <20050602123718.GA21218@xpeerience.u-strasbg.fr>
To: Marc Chantreux <marc.chantreux@ulpmm.u-strasbg.fr>
Cc: zsh-workers@sunsite.dk
Subject: Re: can't run _email-mutt 
Date: Mon, 06 Jun 2005 18:42:29 +0200
Message-ID: <22509.1118076149@trentino.groupinfra.com>
X-Scanned-By: MailControl A-05-01-01 (www.mailcontrol.com)
X-Spam-Checker-Version: SpamAssassin 3.0.2 on a.mx.sunsite.dk
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=6.0 tests=AWL,BAYES_00 autolearn=ham 
	version=3.0.2
X-Spam-Hits: -2.6

On 2 Jun, Marc Chantreux wrote:
> 
> a pure zsh solution is trying to parse all files that are sourced (
> using the source command ) by .muttrc.

Following patch is an attempt to do that. I'd be interested in any
feedback on how well this copes with your setup and if it breaks for
anyone's mutt/mush/zmail/whatever setup.

Has anyone got any ideas on how to narrow the context for the plugin
tag-order. Currently, if you want to specify a list of plugins as a
global setting, you need a context like ':completion:*'. That's not
nice  but the best alternative is listing commands:
':completion:*:(mailx|Mail|mutt|mush|ali|netscape):*'
Ideally, _tags should allow me to put 'email-addresses' in as a tag. It
should perhaps use $curtag.

Oliver

Index: Completion/Unix/Type/_email_addresses
===================================================================
RCS file: /cvsroot/zsh/zsh/Completion/Unix/Type/_email_addresses,v
retrieving revision 1.3
diff -u -r1.3 _email_addresses
--- Completion/Unix/Type/_email_addresses	15 Jan 2004 16:56:56 -0000	1.3
+++ Completion/Unix/Type/_email_addresses	6 Jun 2005 16:26:35 -0000
@@ -14,7 +14,16 @@
 # plugins
 (( $+functions[_email-mail] )) ||
 _email-mail() {
-  reply=( ${${${(M)${(f)"$(<$files[$plugin])"}:#alias*}##alias[[:blank:]]##}/[[:blank:]]##/:} )
+  local rc rcfiles i
+
+  rcfiles=( $files[$plugin] )
+  for ((i=1;i<=$#rcfiles;i++)); do
+    rcfiles+=( ${~${(M)${(f)"$(<$rcfiles[i])"}:#source*}##source[[:blank:]]##}(N) )
+  done
+  reply=()
+  for rc in $rcfiles; do
+    reply+=( ${${${(M)${(f)"$(<$rc)"}:#alias*}##alias[[:blank:]]##}/[[:blank:]]##/:} )
+  done
   return 300
 }
 (( $+functions[_email-mutt] )) || _email-mutt() { _email-mail }
@@ -79,7 +88,7 @@
 _email_addresses() {
   local -a plugins reply list args
   local -A opts files
-  local plugin rcfile expl ret fret
+  local plugin rcfile muttrc expl ret fret
 
   local __specialx='][()<>@,;:\\".'
   local __spacex=" 	"				# Space, tab
@@ -119,7 +128,10 @@
   fi
 
   # get list of all plugins except any with missing config files
-  files=( MH ${MH:-~/.mh_profile} mutt ~/.muttrc mush ~/.mushrc mail ${MAILRC:-~/.mailrc} pine ~/.addressbook )
+  if ! zstyle -s ":completion:${curcontext}:email-addresses" muttrc muttrc; then
+    [[ -e ~/mutt/muttrc ]] && muttrc="~/mutt/muttrc" || muttrc="~/.muttrc"
+  fi
+  files=( MH ${MH:-~/.mh_profile} mutt $muttrc mush ~/.mushrc mail ${MAILRC:-~/.mailrc} pine ~/.addressbook )
   plugins=( 
     ${${(k)functions[(I)_email-*]#*-}:#(${(kj.|.)~files})}
     $files(Ne:'REPLY=( ${(k)files[(r)$REPLY]} ):')


This e-mail and any attachment is for authorised use by the intended recipient(s) only. It may contain proprietary material, confidential information and/or be subject to legal privilege. It should not be copied, disclosed to, retained or used by, any other party. If you are not an intended recipient then please promptly delete this e-mail and any attachment and all copies and inform the sender. Thank you.

