From zsh-workers-return-9087-mason-zsh=primenet.com.au@sunsite.auc.dk Thu Dec 16 16:08:16 1999
Return-Path: <zsh-workers-return-9087-mason-zsh=primenet.com.au@sunsite.auc.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 8576 invoked from network); 16 Dec 1999 16:08:15 -0000
Received: from sunsite.auc.dk (130.225.51.30)
  by ns1.primenet.com.au with SMTP; 16 Dec 1999 16:08:15 -0000
Received: (qmail 29498 invoked by alias); 16 Dec 1999 16:08:04 -0000
Mailing-List: contact zsh-workers-help@sunsite.auc.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.auc.dk
X-Seq: 9087
Received: (qmail 29487 invoked from network); 16 Dec 1999 16:08:03 -0000
Message-ID: <38590E5B.C98B5BA8@u.genie.co.uk>
Date: Thu, 16 Dec 1999 16:07:55 +0000
From: Oliver Kiddle <opk@u.genie.co.uk>
X-Mailer: Mozilla 4.7 [en] (Win95; I)
X-Accept-Language: en
MIME-Version: 1.0
To: Zsh workers <zsh-workers@sunsite.auc.dk>
Subject: PATCH: Re: AIX and .export files again
References: <38567EFA.924D538D@u.genie.co.uk>
Content-Type: text/plain; charset=us-ascii
Content-Transfer-Encoding: 7bit

I wrote:
> Unfortunately, though this will now compile on AIX, it won't work: I get
> messages of the form 'failed to load module: rlimits'. pws-10 has this
> problem aswell but I haven't had much time to investigate why.

I've now investigated this problem. The problem results from the changes
in 8770 - the modules list containing both linked and dynamic modules
meant that load_and_bind tried to call AIX's loadbind for staticly
linked modules. The patch against module.c below fixes this.

Compiling pws-12 gave me one unresolved for zutil.so which was in
complete.so. The patch adds complete to zutil's dependencies. This
actually causes problems again with the .export file dependencies
because the complete module is in a different directory to zutil.
Hopefully Zefram's latest patch (9083) will sort that out though.

Oliver

*** Src/module.c.bak	Mon Dec  6 23:15:45 1999
--- Src/module.c	Thu Dec 16 15:48:55 1999
***************
*** 296,302 ****
  	int err = loadbind(0, (void *) addbuiltin, ret);
  	for (node = firstnode(modules); !err && node; incnode(node)) {
  	    Module m = (Module) getdata(node);
! 	    if (m->u.handle)
  		err |= loadbind(0, m->u.handle, ret);
  	}
  
--- 296,302 ----
  	int err = loadbind(0, (void *) addbuiltin, ret);
  	for (node = firstnode(modules); !err && node; incnode(node)) {
  	    Module m = (Module) getdata(node);
! 	    if (m->u.handle && !(m->flags & MOD_LINKED))
  		err |= loadbind(0, m->u.handle, ret);
  	}
  
*** Src/Modules/zutil.mdd.bak	Fri Dec 10 19:39:40 1999
--- Src/Modules/zutil.mdd	Thu Dec 16 14:06:21 1999
***************
*** 1,3 ****
--- 1,5 ----
+ moddeps="complete"
+ 
  objects="zutil.o"
  
  autobins="zformat zstyle"

