From zsh-workers-request@math.gatech.edu  Mon Aug  7 22:06:05 1995
Received: from gatech.edu (gatech.edu [130.207.244.244]) by werple.mira.net.au (8.6.12/8.6.9) with SMTP id WAA00758 for <mason@werple.mira.net.au>; Mon, 7 Aug 1995 22:06:02 +1000
Received: from math (math.skiles.gatech.edu) by gatech.edu with SMTP id AA16999
  (5.65c/Gatech-10.0-IDA for <mason@werple.mira.net.au>); Mon, 7 Aug 1995 08:03:27 -0400
Received: by math (5.x/SMI-SVR4)
	id AA09102; Mon, 7 Aug 1995 07:58:56 -0400
Resent-Date: Mon, 7 Aug 1995 13:51:33 +0200 (MET DST)
Old-Return-Path: <kaefer@aglaia.snafu.DE>
Message-Id: <m0sfQiU-00007BC@aglaia.snafu.DE>
Subject: COMPLETE_IN_WORD dumps core if reserved word match
To: zsh-workers@math.gatech.edu
Date: Mon, 7 Aug 1995 13:51:33 +0200 (MET DST)
In-Reply-To: <m0scCmr-00007BC@aglaia.snafu.DE> from "Thorsten Meinecke" at Jul 29, 95 04:22:44 pm
From: Thorsten Meinecke <kaefer@aglaia.snafu.de>
Organization: none. Location: Berlin, Germany
X-Mailer: ELM [version 2.4 PL23]
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
Resent-Message-Id: <"5ByAq.0.6E2.__V9m"@math>
Resent-From: zsh-workers@math.gatech.edu
X-Mailing-List: <zsh-workers@math.gatech.edu> archive/latest/290
X-Loop: zsh-workers@math.gatech.edu
Precedence: list
Resent-Sender: zsh-workers-request@math.gatech.edu

I wrote, 
Subject: COMPLETE_IN_WORD dumps core if built-in functions match,

>   Starting program: /u/home/kaefer/wrk/zsh/zsh-2.6-beta10/Src/./zsh -f
>   aglaia:~/wrk/zsh/zsh-2.6-beta10/Src> setopt autolist completeinword 
>   aglaia:~/wrk/zsh/zsh-2.6-beta10/Src> rt
>                                         ^
> [cursor position is here, and completion requested]
> 
>   Program received signal SIGSEGV, Segmentation fault.
>   0x804ed39 in addmatch (s=0x8059424 "epeat", t=0x8059424 "epeat")
>       at zle_tricky.c:1524
>   1524                *e = '\0';
>   (gdb)
> 
> The obvious way around (at least for GCC) is to recompile with
> -fwritable-strings.

Digging a little further shows that only the list of 24 reserved
words is subject to this problem. We're attempting to modify
"string constants", which can't be done portably.

The fix is to copy these words, at the expense of a-hundred-and-a-
few bytes increased memory usage, as it was done in earlier releases.

This is still for zsh-2.6-beta10:


*** hashtable.c.orig	Sat Jul  1 00:06:17 1995
--- hashtable.c	Mon Aug  7 01:49:09 1995
***************
*** 441,454 ****
      reswdtab->printinfo = printhashtabinfo;
      reswdtab->tablename = ztrdup("reswdtab");
  #endif
  
!     /* Add the actual words, not copies, to the table, *
!      * as we do not expect to modify the table again.  */
      for (i = 0; reswds[i]; i++) {
  	struct reswd *ptr = (struct reswd *) zcalloc(sizeof *ptr);
  	ptr->cmd = i + DO;
! 	reswdtab->addnode(reswdtab, reswds[i], ptr);
      }
  }
  
  
--- 441,455 ----
      reswdtab->printinfo = printhashtabinfo;
      reswdtab->tablename = ztrdup("reswdtab");
  #endif
  
!     /* Add copies of the actual words to the table, as we do not *
!      * expect to modify the table permanently, but we do insert  *
!      * end-of-string markers for COMPLETE_IN_WORD temporarily    */
      for (i = 0; reswds[i]; i++) {
  	struct reswd *ptr = (struct reswd *) zcalloc(sizeof *ptr);
  	ptr->cmd = i + DO;
! 	reswdtab->addnode(reswdtab, ztrdup(reswds[i]), ptr);
      }
  }
  
  

