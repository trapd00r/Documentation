From zsh-workers-return-26077-mason-zsh=primenet.com.au@sunsite.dk Thu Nov 20 23:56:59 2008
Return-Path: <zsh-workers-return-26077-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 15097 invoked from network); 20 Nov 2008 23:56:56 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.4 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 20 Nov 2008 23:56:56 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 3012 invoked from network); 20 Nov 2008 23:56:48 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 20 Nov 2008 23:56:48 -0000
Received: (qmail 4266 invoked by alias); 20 Nov 2008 23:56:42 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 26077
Received: (qmail 4252 invoked from network); 20 Nov 2008 23:56:41 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 20 Nov 2008 23:56:41 -0000
Received: from vms173005pub.verizon.net (vms173005pub.verizon.net [206.46.173.5])
	by bifrost.dotsrc.org (Postfix) with ESMTP id DF1A580525B4
	for <zsh-workers@sunsite.dk>; Fri, 21 Nov 2008 00:56:35 +0100 (CET)
Received: from torch.brasslantern.com ([96.238.220.215])
 by vms173005.mailsrvcs.net
 (Sun Java System Messaging Server 6.2-6.01 (built Apr  3 2006))
 with ESMTPA id <0KAN00A0JP65MLQ2@vms173005.mailsrvcs.net> for
 zsh-workers@sunsite.dk; Thu, 20 Nov 2008 17:56:30 -0600 (CST)
Received: from torch.brasslantern.com (localhost.localdomain [127.0.0.1])
	by torch.brasslantern.com (8.13.1/8.13.1) with ESMTP id mAKNuSSL024610	for
 <zsh-workers@sunsite.dk>; Thu, 20 Nov 2008 15:56:29 -0800
Received: (from schaefer@localhost)	by torch.brasslantern.com
 (8.13.1/8.13.1/Submit) id mAKNuS9w024609	for zsh-workers@sunsite.dk; Thu,
 20 Nov 2008 15:56:28 -0800
Date: Thu, 20 Nov 2008 15:56:28 -0800
From: Bart Schaefer <schaefer@brasslantern.com>
Subject: Re: ZSH hangs with redirection
In-reply-to: <slrngibfsl.h6j.joerg@alea.gnuu.de>
To: zsh-workers@sunsite.dk
Message-id: <081120155628.ZM24608@torch.brasslantern.com>
MIME-version: 1.0
X-Mailer: OpenZMail Classic (0.9.2 24April2005)
Content-type: text/plain; charset=us-ascii
References: <slrngibfsl.h6j.joerg@alea.gnuu.de>
Comments: In reply to ( Text in unknown character set UTF-8 not shown )  Sommer
 <joerg@alea.gnuu.de>        "ZSH hangs with redirection" (Nov 20,  7:50pm)
X-Virus-Scanned: ClamAV 0.92.1/8656/Thu Nov 20 23:12:54 2008 on bifrost
X-Virus-Status: Clean

On Nov 20,  7:50pm, Jorg wrote:
} Subject: ZSH hangs with redirection
}
} % ( echo bla >&2 ) >&1 >/tmp/a 2>&1
} bla
} ^C
} 
} I have to press ^C to get the prompt. Otherwise the process hangs. Why?
} Doing I something wrong?

Well, you've invoked a multio:  >&1 >/tmp/a connects stdout to a pipe
to an "invisible" process whose job it is to read its input and write
a copy of that input to both the original stdout and to /tmp/a.

Next 2>&1 connects the standard error of the subshell to that pipe, and
last inside the subshell >&2 connects the output of echo to the same
pipe.  So now you have the pipe open twice, and even though "echo bla"
exits, the pipe isn't closed, so the invisible copy job never exits.

You can force the subshell to exit by writing this:

% ( echo bla >&2 ; exit ) >&1 >/tmp/a 2>&1

Then the pipe gets closed and everything "works."  I suppose it's a bug
in process handling that the subshell doesn't exit and close the pipe
once echo has finished.  It's stuck here:

(gdb) where
#0  0x009107a2 in _dl_sysinfo_int80 () from /lib/ld-linux.so.2
#1  0x00951d7c in sigsuspend () from /lib/tls/libc.so.6
#2  0x080affa3 in signal_suspend (sig=17) at ../../zsh-4.0/Src/signals.c:361
#3  0x08080c84 in zwaitjob (job=1, wait_cmd=0) at ../../zsh-4.0/Src/jobs.c:1220
#4  0x08080e5b in waitjobs () at ../../zsh-4.0/Src/jobs.c:1265
#5  0x080679e2 in execcmd (state=0xbfe78050, input=0, output=0, how=18, 
    last1=2) at ../../zsh-4.0/Src/exec.c:3174
#6  0x080635e1 in execpline2 (state=0xbfe78050, pcode=1027, how=18, input=0, 
    output=0, last1=0) at ../../zsh-4.0/Src/exec.c:1561
#7  0x080629e2 in execpline (state=0xbfe78050, slcode=22530, how=18, last1=0)
    at ../../zsh-4.0/Src/exec.c:1347
#8  0x08062340 in execlist (state=0xbfe78050, dont_change_job=0, exiting=0)
    at ../../zsh-4.0/Src/exec.c:1144
#9  0x08061e0b in execode (p=0xb7d9c5e0, dont_change_job=0, exiting=0)
    at ../../zsh-4.0/Src/exec.c:975
#10 0x0807a553 in loop (toplevel=1, justonce=0) at ../../zsh-4.0/Src/init.c:181
#11 0x0807d2a4 in zsh_main (argc=1, argv=0xbfe78194)
    at ../../zsh-4.0/Src/init.c:1406
#12 0x0804cba6 in main (argc=1, argv=0xbfe78194) at ../../zsh-4.0/Src/main.c:93

