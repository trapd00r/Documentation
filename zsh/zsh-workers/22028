From zsh-workers-return-22028-mason-zsh=primenet.com.au@sunsite.dk Fri Nov 25 10:30:33 2005
Return-Path: <zsh-workers-return-22028-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 836 invoked from network); 25 Nov 2005 10:30:31 -0000
X-Spam-Checker-Version: SpamAssassin 3.1.0 (2005-09-13) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=AWL,BAYES_00,
	FORGED_RCVD_HELO autolearn=ham version=3.1.0
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 25 Nov 2005 10:30:31 -0000
Received: (qmail 95847 invoked from network); 25 Nov 2005 10:30:26 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 25 Nov 2005 10:30:26 -0000
Received: (qmail 12369 invoked by alias); 25 Nov 2005 10:30:24 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 22028
Received: (qmail 12359 invoked from network); 25 Nov 2005 10:30:23 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 25 Nov 2005 10:30:23 -0000
Received: (qmail 95658 invoked from network); 25 Nov 2005 10:30:23 -0000
Received: from cluster-d.mailcontrol.com (HELO rly29d.srv.mailcontrol.com) (217.69.20.190)
  by a.mx.sunsite.dk with SMTP; 25 Nov 2005 10:30:22 -0000
Received: from exchange03.csr.com ([62.189.241.194])
	by rly29d.srv.mailcontrol.com (MailControl) with ESMTP id jAPAUJOg022803
	for <zsh-workers@sunsite.dk>; Fri, 25 Nov 2005 10:30:19 GMT
Received: from csr.com ([10.103.143.38]) by exchange03.csr.com with Microsoft SMTPSVC(5.0.2195.6713);
	 Fri, 25 Nov 2005 10:33:04 +0000
To: zsh-workers@sunsite.dk (Zsh hackers list)
Subject: PATCH: bug in WARN_CREATE_GLOBAL
Date: Fri, 25 Nov 2005 10:30:18 +0000
From: Peter Stephenson <pws@csr.com>
Message-ID: <EXCHANGE03mvzUZvKkx0000defa@exchange03.csr.com>
X-OriginalArrivalTime: 25 Nov 2005 10:33:04.0970 (UTC) FILETIME=[9E6EF2A0:01C5F1AB]
Content-Type: text/plain
MIME-Version: 1.0
X-Scanned-By: MailControl A-05-40-01 (www.mailcontrol.com) on 10.68.0.139

This is a bug:

% fn() {
  setopt warncreateglobal
  PWD=~ echo
}
% fn
fn:2: scalar parameter PWD created globally in function

because PWD was already set.  The warning occurs because PWD was
temporarily removed from the parameter table to be restored after the
builtin finished.  The fix is to pass a special flag to addvars() if
that is happening.  I've taken the opportunity to tidy up the other
flags to addvars().

Index: Src/exec.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/exec.c,v
retrieving revision 1.94
diff -u -r1.94 exec.c
--- Src/exec.c	13 Oct 2005 16:30:14 -0000	1.94
+++ Src/exec.c	25 Nov 2005 10:24:42 -0000
@@ -30,6 +30,17 @@
 #include "zsh.mdh"
 #include "exec.pro"
 
+/* Flags for last argument of addvars */
+
+enum {
+    /* Export the variable for "VAR=val cmd ..." */
+    ADDVAR_EXPORT =   1 << 0,
+    /* Apply restrictions for variable */
+    ADDVAR_RESTRICT = 1 << 1,
+    /* Variable list is being restored later */
+    ADDVAR_RESTORE =  1 << 2
+};
+
 /* used to suppress ERREXIT and trapping of SIGZERR, SIGEXIT. */
 
 /**/
@@ -1644,7 +1655,7 @@
 
 /**/
 static void
-addvars(Estate state, Wordcode pc, int export)
+addvars(Estate state, Wordcode pc, int addflags)
 {
     LinkList vl;
     int xtr, isstr, htok = 0;
@@ -1655,7 +1666,14 @@
     wordcode ac;
     local_list1(svl);
 
-    flags = (locallevel > 0 && isset(WARNCREATEGLOBAL)) ?
+    /*
+     * Warn when creating a global without using typeset -g in a
+     * function.  Don't do this if there is a list of variables marked
+     * to be restored after the command, since then the assignment
+     * is implicitly scoped.
+     */
+    flags = (!(addflags & ADDVAR_RESTORE) &&
+	     locallevel > 0 && isset(WARNCREATEGLOBAL)) ?
 	ASSPM_WARN_CREATE : 0;
     xtr = isset(XTRACE);
     if (xtr) {
@@ -1708,8 +1726,8 @@
 		quotedzputs(val, xtrerr);
 		fputc(' ', xtrerr);
 	    }
-	    if (export && !strchr(name, '[')) {
-		if (export < 0 && isset(RESTRICTED) &&
+	    if ((addflags & ADDVAR_EXPORT) && !strchr(name, '[')) {
+		if ((addflags & ADDVAR_RESTRICT) && isset(RESTRICTED) &&
 		    (pm = (Param) paramtab->removenode(paramtab, name)) &&
 		    (pm->flags & PM_RESTRICTED)) {
 		    zerr("%s: restricted", pm->nam, 0);
@@ -2520,7 +2538,13 @@
 		/* Export this if the command is a shell function,
 		 * but not if it's a builtin.
 		 */
-		addvars(state, varspc, is_shfunc);
+		int flags = 0;
+		if (is_shfunc)
+		    flags |= ADDVAR_EXPORT;
+		if (restorelist)
+		    flags |= ADDVAR_RESTORE;
+
+		addvars(state, varspc, flags);
 		if (errflag) {
 		    if (restorelist)
 			restore_params(restorelist, removelist);
@@ -2597,7 +2621,7 @@
 	    }
 	    if (type == WC_SIMPLE) {
 		if (varspc) {
-		    addvars(state, varspc, -1);
+		    addvars(state, varspc, ADDVAR_EXPORT|ADDVAR_RESTRICT);
 		    if (errflag)
 			_exit(1);
 		}

-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070


This message has been scanned for viruses by BlackSpider MailControl - www.blackspider.com

