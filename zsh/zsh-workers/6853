From zsh-workers-return-6853-mason-zsh=primenet.com.au@sunsite.auc.dk Fri Jun 25 13:35:36 1999
Return-Path: <zsh-workers-return-6853-mason-zsh=primenet.com.au@sunsite.auc.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 9024 invoked from network); 25 Jun 1999 13:35:34 -0000
Received: from sunsite.auc.dk (130.225.51.30)
  by ns1.primenet.com.au with SMTP; 25 Jun 1999 13:35:34 -0000
Received: (qmail 25568 invoked by alias); 25 Jun 1999 13:35:07 -0000
Mailing-List: contact zsh-workers-help@sunsite.auc.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.auc.dk
X-Seq: 6853
Received: (qmail 25560 invoked from network); 25 Jun 1999 13:35:06 -0000
Message-Id: <9906251306.AA34377@ibmth.df.unipi.it>
To: zsh-workers@sunsite.auc.dk (Zsh hackers list)
Subject: Re: PATCH: pws-??: typeset -g & more wretched typeset scoping bugs 
In-Reply-To: "Peter Stephenson"'s message of "Fri, 25 Jun 1999 14:35:21 DFT."
             <9906251235.AA17296@ibmth.df.unipi.it> 
Date: Fri, 25 Jun 1999 15:06:24 +0200
From: Peter Stephenson <pws@ibmth.df.unipi.it>

Peter Stephenson wrote:
> (Please God, let this be correct this time.)

Except that it now totally fails to list anything.

--- Src/builtin.c.ts2	Fri Jun 25 14:15:03 1999
+++ Src/builtin.c	Fri Jun 25 15:01:06 1999
@@ -1527,6 +1527,7 @@
     }
 
     if (usepm) {
+	on &= ~PM_LOCAL;
 	if (!on && !roff && !value) {
 	    paramtab->printnode((HashNode)pm, 0);
 	    return pm;
@@ -1656,9 +1657,6 @@
 	    off |= bit;
     roff = off;
 
-    if (!ops['g'])
-	on |= PM_LOCAL;
-
     /* Sanity checks on the options.  Remove conficting options. */
     if (on & PM_INTEGER)
 	off |= PM_RIGHT_B | PM_LEFT | PM_RIGHT_Z | PM_UPPER | PM_ARRAY;
@@ -1688,6 +1686,9 @@
 	scanhashtable(paramtab, 1, on|roff, 0, paramtab->printnode, printflags);
 	return 0;
     }
+
+    if (!ops['g'])
+	on |= PM_LOCAL;
 
     if (on & PM_TIED) {
 	Param apm;

-- 
Peter Stephenson <pws@ibmth.df.unipi.it>       Tel: +39 050 844536
WWW:  http://www.ifh.de/~pws/
Dipartimento di Fisica, Via Buonarroti 2, 56127 Pisa, Italy

