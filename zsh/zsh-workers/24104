From zsh-workers-return-24104-mason-zsh=primenet.com.au@sunsite.dk Tue Nov 20 14:16:11 2007
Return-Path: <zsh-workers-return-24104-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 21568 invoked from network); 20 Nov 2007 14:16:01 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.3 (2007-08-08) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.3
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 20 Nov 2007 14:16:01 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 88700 invoked from network); 20 Nov 2007 14:15:56 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 20 Nov 2007 14:15:56 -0000
Received: (qmail 27694 invoked by alias); 20 Nov 2007 14:15:53 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 24104
Received: (qmail 27675 invoked from network); 20 Nov 2007 14:15:52 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 20 Nov 2007 14:15:52 -0000
Received: (qmail 88416 invoked from network); 20 Nov 2007 14:15:52 -0000
Received: from cluster-g.mailcontrol.com (85.115.41.190)
  by a.mx.sunsite.dk with SMTP; 20 Nov 2007 14:15:45 -0000
Received: from cameurexb01.EUROPE.ROOT.PRI ([62.189.241.200])
	by rly09g.srv.mailcontrol.com (MailControl) with ESMTP id lAKEEVdq026117
	for <zsh-workers@sunsite.dk>; Tue, 20 Nov 2007 14:15:38 GMT
Received: from news01 ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.1830);
	 Tue, 20 Nov 2007 14:14:42 +0000
Date: Tue, 20 Nov 2007 14:14:42 +0000
From: Peter Stephenson <pws@csr.com>
To: "Zsh Hackers' List" <zsh-workers@sunsite.dk>
Subject: Re: zsh-4.3.4-dev-2.tar.gz
Message-ID: <20071120141442.55f7ac28@news01>
In-Reply-To: <4742DC87.5030901@math.technion.ac.il>
References: <11649.1195558694@csr.com>
	<4742DC87.5030901@math.technion.ac.il>
Organization: CSR
X-Mailer: Claws Mail 3.0.2 (GTK+ 2.10.14; i386-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
X-OriginalArrivalTime: 20 Nov 2007 14:14:42.0766 (UTC) FILETIME=[B20656E0:01C82B7F]
X-Scanned-By: MailControl A-06-00-00 (www.mailcontrol.com) on 10.71.0.119

On Tue, 20 Nov 2007 15:09:27 +0200
"Zvi Har'El" <rl@math.technion.ac.il> wrote:
> Another problem. I have two Solaris systems, 2.8 and 2.9. The tar, as
> well as the CVS Head, do not build. Last time I was able to build was,
> from the Head
> 
> -rwxr-xr-x 2 root root 548196 2007-11-08 10:24:53.000000000 +0200
> /usr/local/bin/zsh
> 
> The I have in these systems, in addition to Solaris's curses, also gnu
> ncurses 5.6 (installed at /usr/local). For some reason, configure finds
> ncursesw.so but doesn't find ncurses.h. I attach config.log and
> config.h.

Thanks.  We shouldn't search the ncurses library if we haven't found
the ncurses header.

Obviously it's better to find the header, but the shell may need help doing
that.  I've added a note to the installation instructions.

The last hunk was supposed to add "-expect_unresolved '*'" to DLLDFLAGS on
Tru64 Unix, but the mail I sent seems to have gone astray.  I haven't
tested this.  The idea that the OS still appeared to autoconf as osf* was
suggested by Google but I don't know that for sure either.

Index: INSTALL
===================================================================
RCS file: /cvsroot/zsh/zsh/INSTALL,v
retrieving revision 1.32
diff -u -r1.32 INSTALL
--- INSTALL	12 Oct 2007 10:18:58 -0000	1.32
+++ INSTALL	20 Nov 2007 14:08:56 -0000
@@ -328,6 +328,14 @@
 to the developers at zsh-workers@sunsite.dk and attempt to recompile with
 --with-term-lib="tinfo termcap ncurses curses" (see below).
 
+Note that use of ncurses requires the header ncurses.h, so this
+needs to be in the include path.  configure will not search for
+ncurses or ncursesw unless this is the case.  If you have installed
+ncurses.h in a non-standard place you may need to pass
+CPPFLAGS=-I/usr/local/include (or wherever the header is found) to
+configure.  Similarly, you may need to pass LDFLAGS=-L/usr/local/lib
+(or wherever) in order to find the library.
+
 On some systems a suitable development package with a name such as
 curses-devel or ncurses-devel needs to be installed before zsh can
 be compiled.  This is likely to be contained on any installation media,
Index: configure.ac
===================================================================
RCS file: /cvsroot/zsh/zsh/configure.ac,v
retrieving revision 1.78
diff -u -r1.78 configure.ac
--- configure.ac	10 Nov 2007 20:29:27 -0000	1.78
+++ configure.ac	20 Nov 2007 14:08:58 -0000
@@ -636,6 +636,17 @@
 
 AC_CHECK_LIB(m, pow)
 
+dnl Various features of ncurses depend on having the right header
+dnl (the system's own curses.h may well not be good enough).
+dnl So don't search for ncurses unless we found the header.
+if test x$ac_cv_header_ncurses_h = xyes; then
+  ncursesw_test=ncursesw
+  ncurses_test=ncurses
+else
+  ncursesw_test=
+  ncurses_test=
+fi
+
 dnl Prefer BSD termcap library to SysV curses library, except on certain
 dnl SYSV-derived systems.  However, if we find terminfo and termcap
 dnl stuff in the same library we will use that; typically this
@@ -648,12 +659,13 @@
   termcap_curses_order="$withval"
   AC_SEARCH_LIBS(tigetstr, [$termcap_curses_order])
 else
-  termcap_curses_order="ncursesw tinfo termcap ncurses curses"
+  termcap_curses_order="$ncursesw_test tinfo termcap $ncurses_test curses"
 fi],
 [case "$host_os" in
   hpux10.*|hpux11.*|solaris*)
-      termcap_curses_order="Hcurses ncursesw ncurses curses termcap" ;;
-  *)             termcap_curses_order="ncursesw tinfo termcap ncurses curses" ;;
+   termcap_curses_order="Hcurses $ncursesw_test $ncurses_test curses termcap" ;;
+  *)
+   termcap_curses_order="$ncursesw_test tinfo termcap $ncurses_test curses" ;;
 esac])dnl
 
 AH_TEMPLATE([HAVE_BOOLCODES],
@@ -2357,7 +2369,8 @@
     esac
   fi
   case "$host_os" in
-    *freebsd*|linux*|irix*|osf*|gnu*|dragonfly*) DLLDFLAGS="${DLLDFLAGS=-shared}" ;;
+    osf*) DLLDFLAGS="${DLLDFLAGS=-shared -expect_unresolved '*'}" ;;
+    *freebsd*|linux*|irix*|gnu*|dragonfly*) DLLDFLAGS="${DLLDFLAGS=-shared}" ;;
     sunos*)       DLLDFLAGS="${DLLDFLAGS=-assert nodefinitions}" ;;
     sysv4*|esix*) DLLDFLAGS="${DLLDFLAGS=-G $ldflags}" ;;
     netbsd*)      DLLDFLAGS="${DLLDFLAGS=${DLLDARG}-x -shared --whole-archive}" ;;

-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070

