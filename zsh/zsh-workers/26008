From zsh-workers-return-26008-mason-zsh=primenet.com.au@sunsite.dk Wed Nov 05 12:56:09 2008
Return-Path: <zsh-workers-return-26008-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 2252 invoked from network); 5 Nov 2008 12:56:06 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.2 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 5 Nov 2008 12:56:06 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 50670 invoked from network); 5 Nov 2008 12:56:00 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 5 Nov 2008 12:56:00 -0000
Received: (qmail 10420 invoked by alias); 5 Nov 2008 12:55:55 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 26008
Received: (qmail 10404 invoked from network); 5 Nov 2008 12:55:55 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 5 Nov 2008 12:55:55 -0000
Received: from cluster-d.mailcontrol.com (cluster-d.mailcontrol.com [217.69.20.190])
	by bifrost.dotsrc.org (Postfix) with ESMTPS id 42DC580308BE
	for <zsh-workers@sunsite.dk>; Wed,  5 Nov 2008 13:55:40 +0100 (CET)
Received: from cameurexb01.EUROPE.ROOT.PRI ([193.128.72.68])
	by rly43d.srv.mailcontrol.com (MailControl) with ESMTP id mA5CtcQI015996
	for <zsh-workers@sunsite.dk>; Wed, 5 Nov 2008 12:55:38 GMT
Received: from news01.csr.com ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.3959);
	 Wed, 5 Nov 2008 12:55:36 +0000
Received: from news01.csr.com (localhost.localdomain [127.0.0.1])
	by news01.csr.com (8.14.2/8.13.4) with ESMTP id mA5Ctajk016221
	for <zsh-workers@sunsite.dk>; Wed, 5 Nov 2008 12:55:36 GMT
Received: from csr.com (pws@localhost)
	by news01.csr.com (8.14.2/8.14.2/Submit) with ESMTP id mA5CtaBW016217
	for <zsh-workers@sunsite.dk>; Wed, 5 Nov 2008 12:55:36 GMT
X-Authentication-Warning: news01.csr.com: pws owned process doing -bs
To: zsh-workers@sunsite.dk (Zsh hackers list)
Subject: PATCH: small bug with "typeset -g"
X-Mailer: MH-E 8.0.3; nmh 1.3; GNU Emacs 22.1.1
Date: Wed, 05 Nov 2008 12:55:36 +0000
Message-ID: <16216.1225889736@csr.com>
From: Peter Stephenson <pws@csr.com>
X-OriginalArrivalTime: 05 Nov 2008 12:55:36.0947 (UTC) FILETIME=[CC4A1430:01C93F45]
X-Scanned-By: MailControl A-08-50-15 (www.mailcontrol.com) on 10.68.0.153
X-Virus-Scanned: ClamAV 0.92.1/8571/Wed Nov  5 12:25:50 2008 on bifrost
X-Virus-Status: Clean

I've been using WARN_CREATE_GLOBAL to look for missing "local" statements
and consequently adding "typeset -g"s in my functions.

I think this is a bug, or should be treated as one:

%  unsetopt typesetsilent
%  silent1(){ typeset -g silence; }
%  silent2(){ local silence; silent1; }
%  silent2
silence=''

The intention is surely simply to ensure that "silence" is defined as a
variable in the enclosing context, so this should be like calls to
typeset that turn flags on or off (even though in practice it doesn't),
which are silent regardless of the setting of TYPESET_SILENT.

Index: Src/builtin.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/builtin.c,v
retrieving revision 1.216
diff -u -r1.216 builtin.c
--- Src/builtin.c	31 Oct 2008 23:43:37 -0000	1.216
+++ Src/builtin.c	5 Nov 2008 12:50:07 -0000
@@ -1951,7 +1951,8 @@
 	if (!on && !roff && !value) {
 	    if (OPT_ISSET(ops,'p'))
 		paramtab->printnode(&pm->node, PRINT_TYPESET);
-	    else if (unset(TYPESETSILENT) || OPT_ISSET(ops,'m'))
+	    else if (!OPT_ISSET(ops,'g') &&
+		     (unset(TYPESETSILENT) || OPT_ISSET(ops,'m')))
 		paramtab->printnode(&pm->node, PRINT_INCLUDEVALUE);
 	    return pm;
 	}
Index: Test/B02typeset.ztst
===================================================================
RCS file: /cvsroot/zsh/zsh/Test/B02typeset.ztst,v
retrieving revision 1.20
diff -u -r1.20 B02typeset.ztst
--- Test/B02typeset.ztst	15 Sep 2008 08:57:28 -0000	1.20
+++ Test/B02typeset.ztst	5 Nov 2008 12:50:07 -0000
@@ -453,3 +453,9 @@
 >typeset -a array
 >array=(foo bar)
 ?fn:typeset: no such variable: nonexistent
+
+ unsetopt typesetsilent
+ silent1(){ typeset -g silence; }
+ silent2(){ local silence; silent1; }
+ silent2
+0:typeset -g should be silent even without TYPESET_SILENT


-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070

