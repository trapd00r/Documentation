From zsh-workers-return-26756-mason-zsh=primenet.com.au@sunsite.dk Thu Mar 19 16:09:36 2009
Return-Path: <zsh-workers-return-26756-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 29266 invoked from network); 19 Mar 2009 16:09:32 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.4 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 19 Mar 2009 16:09:32 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 65058 invoked from network); 19 Mar 2009 16:09:27 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 19 Mar 2009 16:09:27 -0000
Received: (qmail 21687 invoked by alias); 19 Mar 2009 16:09:22 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 26756
Received: (qmail 21670 invoked from network); 19 Mar 2009 16:09:21 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 19 Mar 2009 16:09:21 -0000
Received: from cluster-g.mailcontrol.com (cluster-g.mailcontrol.com [208.87.233.190])
	by bifrost.dotsrc.org (Postfix) with ESMTPS id A814F8056E25
	for <zsh-workers@sunsite.dk>; Thu, 19 Mar 2009 17:09:16 +0100 (CET)
Received: from cameurexb01.EUROPE.ROOT.PRI ([193.128.72.68])
	by rly27g.srv.mailcontrol.com (MailControl) with ESMTP id n2JG9Ag5032685
	for <zsh-workers@sunsite.dk>; Thu, 19 Mar 2009 16:09:10 GMT
Received: from news01.csr.com ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.3959);
	 Thu, 19 Mar 2009 16:09:06 +0000
Received: from news01.csr.com (localhost.localdomain [127.0.0.1])
	by news01.csr.com (8.14.2/8.13.4) with ESMTP id n2JG96Vu031993
	for <zsh-workers@sunsite.dk>; Thu, 19 Mar 2009 16:09:06 GMT
Received: from csr.com (pws@localhost)
	by news01.csr.com (8.14.2/8.14.2/Submit) with ESMTP id n2JG95hf031989
	for <zsh-workers@sunsite.dk>; Thu, 19 Mar 2009 16:09:06 GMT
Message-Id: <200903191609.n2JG95hf031989@news01.csr.com>
X-Authentication-Warning: news01.csr.com: pws owned process doing -bs
To: zsh-workers@sunsite.dk
Subject: Re: Bug#519535: history expansion: modifier completion missing
In-reply-to: <237967ef0903190828k4b9f7edbyc85405b630c50d5d@mail.gmail.com>
References: <20090313105555.GA19025@piper.oerlikon.madduck.net> <20090315062253.GB14010@scru.org> <20090316181852.27e9420d@news01> <237967ef0903190828k4b9f7edbyc85405b630c50d5d@mail.gmail.com>
Comments: In-reply-to Mikael Magnusson <mikachu@gmail.com>
   message dated "Thu, 19 Mar 2009 16:28:55 +0100."
Date: Thu, 19 Mar 2009 16:09:04 +0000
From: Peter Stephenson <pws@csr.com>
X-OriginalArrivalTime: 19 Mar 2009 16:09:06.0533 (UTC) FILETIME=[077ED150:01C9A8AD]
X-Scanned-By: MailControl A_08_51_00 (www.mailcontrol.com) on 10.71.0.137
X-Virus-Scanned: ClamAV 0.92.1/9140/Thu Mar 19 16:16:32 2009 on bifrost
X-Virus-Status: Clean

Mikael Magnusson wrote:
> Is it supposed to work here? $PWD:<tab> (it doesn't for me).

No, wihin parameters the completion system doesn't handle any case
except parameter names and values properly.  It doesn't know there's
anything special to do there.  Parsing it would be horrible.  (It will,
of course, expand a complete expression as an entirely separate matter.)

> It does
> complete if you write $PWD(:<tab>, but also in ${PWD(:<tab>, but
> accepting one of the latter produces a syntax error:
> % echo ${PWD(:A)}
> zsh: bad substitution
> (regardless of which modifier you use)

That's because it is a syntax error.  Same answer: the completion system
doesn't know that's special, handling all these special cases is
horrific.  It ought to be possible for someone with that sort of time on
their hands to extend check_param() in compcore.c to add new parameter
contexts, but it seems a funny thing to do with your life.  (Actually,
in the case of brace parameters that ought to be easy, it already knows
you're in a brace parameter and it already knows the brace isn't
complete, so it could do the same as it does for completing the
parameter but set a different context to show it's in the trailing
matter.  But that still leaves the non-brace case.)

(Of course, the right way to do this is to have the shell parsed by
examining a grammar which is also used for generating the cases for
completing shell syntax.  Our infinite team of monkeys should have this
done by the next ice age.)

> Also, i get this:
> $PWD(:s-<tab>
> _history_modifiers:34: bad math expression: operand expected at `^-'
> _history_modifiers:34: bad math expression: operand expected at `^-'
> _history_modifiers:34: bad math expression: operand expected at `^-'
> _history_modifiers:34: bad math expression: operand expected at `^-'
> _history_modifiers:34: bad math expression: operand expected at `^-'
> _history_modifiers:34: bad math expression: operand expected at `^-'
> (same with / or other separator (but it says `^/' then, of course))

I obviously didn't try this bit.  It's supposed to give you hints.  Note
this doesn't currently work for !-history itself---out of fear, I used a
very simple test in _normal that only works with a trailing ":".

> As an aside, after i write $PWD(:<tab> to get the s, how do i "accept"
> the completion to make tab complete the - instead of cycling to the
> next completer? The only way i found is typing something and deleting
> it... When completing directories i usually just type a /.

Just type the string that's got to come next; it always does, or the s
is useless: there's no point typing anything you need to delete, just
use what you don't need to delete.  Actually, why don't you just type
"s-"?  The "completion" is really only there as a mnemonic of what can
go at that point, it doesn't save you any typing even in the optimal
case.

Index: Completion/Zsh/Type/_history_modifiers
===================================================================
RCS file: /cvsroot/zsh/zsh/Completion/Zsh/Type/_history_modifiers,v
retrieving revision 1.3
diff -u -r1.3 _history_modifiers
--- Completion/Zsh/Type/_history_modifiers	17 Mar 2009 10:03:24 -0000	1.3
+++ Completion/Zsh/Type/_history_modifiers	19 Mar 2009 15:54:28 -0000
@@ -31,11 +31,11 @@
       fi
       delim=$PREFIX[1]
       compset -p 1
-      if ! compset "[^$delim]#$delim[^$delim]#$delim"; then
-	if compset "[^$delim]#$delim"; then
-	  _message original string
+      if ! compset -P "[^${delim}]#${delim}[^${delim}]#${delim}"; then
+	if compset -P "[^${delim}]#${delim}"; then
+	  _message "replacement string"
 	else
-	  _message replacement string
+	  _message "original string"
 	fi
 	return
       fi


-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070

