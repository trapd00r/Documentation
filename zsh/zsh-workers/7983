From zsh-workers-return-7983-mason-zsh=primenet.com.au@sunsite.auc.dk Tue Sep 21 13:46:06 1999
Return-Path: <zsh-workers-return-7983-mason-zsh=primenet.com.au@sunsite.auc.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 18057 invoked from network); 21 Sep 1999 13:46:03 -0000
Received: from sunsite.auc.dk (130.225.51.30)
  by ns1.primenet.com.au with SMTP; 21 Sep 1999 13:46:03 -0000
Received: (qmail 27142 invoked by alias); 21 Sep 1999 13:45:52 -0000
Mailing-List: contact zsh-workers-help@sunsite.auc.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.auc.dk
X-Seq: 7983
Received: (qmail 27135 invoked from network); 21 Sep 1999 13:45:51 -0000
Message-Id: <9909211310.AA26994@ibmth.df.unipi.it>
To: zsh-workers@sunsite.auc.dk (Zsh hackers list)
Subject: PATCH: 3.1.6-pws-5: hungetc() after keyboard interruption
Date: Tue, 21 Sep 1999 15:10:17 +0200
From: Peter Stephenson <pws@ibmth.df.unipi.it>

With debugging enabled,

% ((foo
math> ^C
BUG: wrong character in hungetc() 
BUG: hungetc attempted at buffer start
BUG: wrong character in hungetc() 

The error happens because when the interruption occurs the input is flushed
completely, which a hungetc() later on in lexing doesn't notice, so it
tries to put nonsense back into the input queue.  hungetc() is only used
during lexing, which always returns a LEXERR if errflag is set, so I hope
it's possible simply not to unget when errflag is set.  But there's no
special flag to say that the error came from the keyboard, or that input
has been flushed, so it's possible that may be too drastic.

Unless somebody remember explicitly removing this test?

--- Src/hist.c.hu	Mon Sep 20 10:59:52 1999
+++ Src/hist.c	Tue Sep 21 15:00:31 1999
@@ -642,7 +642,7 @@
 {
     int doit = 1;
 
-    while (!lexstop) {
+    while (!lexstop && !errflag) {
 	if (hptr[-1] != (char) c && stophist < 4 &&
 	    hptr > chline + 1 && hptr[-1] == '\n' && hptr[-2] == '\\')
 	    hungetc('\n'), hungetc('\\');

-- 
Peter Stephenson <pws@ibmth.df.unipi.it>       Tel: +39 050 844536
WWW:  http://www.ifh.de/~pws/
Dipartimento di Fisica, Via Buonarroti 2, 56127 Pisa, Italy

