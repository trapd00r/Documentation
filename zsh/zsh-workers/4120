From zsh-workers-request@math.gatech.edu Mon Jun 15 14:02:57 1998
Return-Path: <zsh-workers-request@math.gatech.edu>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 11852 invoked from network); 15 Jun 1998 14:02:56 -0000
Received: from math.gatech.edu (list@130.207.146.50)
  by ns1.primenet.com.au with SMTP; 15 Jun 1998 14:02:56 -0000
Received: (from list@localhost)
	by math.gatech.edu (8.8.5/8.8.5) id JAA11655;
	Mon, 15 Jun 1998 09:57:42 -0400 (EDT)
Resent-Date: Mon, 15 Jun 1998 09:57:42 -0400 (EDT)
From: Martin Aumueller <aumuelle@mi.uni-erlangen.de>
Message-Id: <199806151358.PAA13243@helena.mi.uni-erlangen.de>
Subject: Wrong emulation mode if exec'd by su
To: zsh-workers@math.gatech.edu
Date: Mon, 15 Jun 1998 15:58:41 +0200 (MET DST)
Cc: aumuelle@mi.mi.uni-erlangen.de
Reply-To: aumuelle@mi.uni-erlangen.de
X-Mailer: ELM [version 2.4 PL25]
MIME-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
Resent-Message-ID: <"Ilb4L.0.2s2.MXIXr"@math>
Resent-From: zsh-workers@math.gatech.edu
X-Mailing-List: <zsh-workers@math.gatech.edu> archive/latest/4120
X-Loop: zsh-workers@math.gatech.edu
Precedence: list
Resent-Sender: zsh-workers-request@math.gatech.edu

Hi!

I have a problem with zsh-3.1.4: If I su - to an account the zsh sees
"su" as executable name -- starting with 's' -- and thus switches to
Bourne shell emulation mode, not the behaviour desired by me. I have
solved this problem by testing the full executable names against "sh",
"csh" and "ksh" with strcmp and now it works as I expect it.

However, in the patch below I didn't take into account the case
starting with 'b', don't know what that should be, but besides this,
it should do.

Bye, Martin


diff -r -u zsh-3.1.4/Src/options.c zsh-3.1.4-patched/Src/options.c
--- zsh-3.1.4/Src/options.c	Wed Apr 29 23:42:50 1998
+++ zsh-3.1.4-patched/Src/options.c	Sun Jun 14 13:20:32 1998
@@ -432,6 +432,7 @@
 void
 emulate(const char *zsh_name, int fully)
 {
+#if 0
     char ch = *zsh_name;
 
     if (ch == 'r')
@@ -442,10 +443,25 @@
 	emulation = EMULATE_CSH;
     else if (ch == 'k')
 	emulation = EMULATE_KSH;
-    else if (ch == 's' || ch == 'b')
+    else if (ch == 's' || ch == 'b')        
 	emulation = EMULATE_SH;
     else
 	emulation = EMULATE_ZSH;
+#else
+    const char *name = zsh_name;
+    
+    if (*name == 'r')
+      name++;
+
+    if (!strcmp(name,"csh"))
+      emulation = EMULATE_CSH;
+    else if (!strcmp(name,"ksh"))
+      emulation = EMULATE_KSH;
+    else if (!strcmp(name,"sh"))
+      emulation = EMULATE_SH;
+    else
+      emulation = EMULATE_ZSH;
+#endif
 
     scanhashtable(optiontab, 0, 0, 0, setemulate, fully);
 }

