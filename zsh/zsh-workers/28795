From zsh-workers-return-28795-mason-zsh=primenet.com.au@zsh.org Wed Feb 23 09:25:23 2011
Return-Path: <zsh-workers-return-28795-mason-zsh=primenet.com.au@zsh.org>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 25330 invoked by alias); 23 Feb 2011 09:25:22 -0000
Mailing-List: contact zsh-workers-help@zsh.org; run by ezmlm
Precedence: bulk
X-No-Archive: yes
List-Id: Zsh Workers List <zsh-workers.zsh.org>
List-Post: <mailto:zsh-workers@zsh.org>
List-Help: <mailto:zsh-workers-help@zsh.org>
Delivered-To: mailing list zsh-workers@zsh.org
X-Seq: 28795
Received: (qmail 18642 invoked from network); 23 Feb 2011 09:25:14 -0000
X-Spam-Checker-Version: SpamAssassin 3.3.1 (2010-03-16) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-1.9 required=5.0 tests=BAYES_00,RCVD_IN_DNSWL_NONE
	autolearn=ham version=3.3.1
Received-SPF: pass (ns1.primenet.com.au: SPF record at ntlworld.com designates 81.103.221.47 as permitted sender)
Date: Wed, 23 Feb 2011 09:25:06 +0000
From: Peter Stephenson <p.w.stephenson@ntlworld.com>
To: "zsh-workers@zsh.org" <zsh-workers@zsh.org>
Subject: Re: sh compatibility issue
Message-ID: <20110223092506.200da440@pws-pc.ntlworld.com>
In-Reply-To: <AANLkTinqaQorhmAU9HDf2smS-K1BcGjg4QwhfNLpctQo@mail.gmail.com>
References: <20110218103012.27fd1869@pwslap01u.europe.root.pri>
	<20110219230540.GA81416@stack.nl>
	<20110220191159.12627718@pws-pc.ntlworld.com>
	<4D618A11.3050406@case.edu>
	<20110222200259.2aab2dcc@pws-pc.ntlworld.com>
	<20110223010817.GA36733@quark.hightek.org>
	<AANLkTinqaQorhmAU9HDf2smS-K1BcGjg4QwhfNLpctQo@mail.gmail.com>
X-Mailer: Claws Mail 3.7.8 (GTK+ 2.22.0; x86_64-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: quoted-printable
X-Cloudmark-Analysis: v=1.1 cv=R50lirqlHffDPPkwUlkuVa99MrvKdVWo//yz83qex8g= c=1 sm=0 a=IkcTkHD0fZMA:10 a=q2GGsy2AAAAA:8 a=LHRxVVMyAAAA:8 a=NLZqzBF-AAAA:8 a=LDaNVmno8pq8OfTbbtwA:9 a=93X4Ht5zYISbEA85OkQA:7 a=201mYzMcq1SBeJBOYv8naukVFuoA:4 a=QEXdDO2ut3YA:10 a=I6wTmPyJxzYA:10 a=RWfRqLBnHQMA:10 a=_dQi-Dcv4p4A:10 a=HpAAvcLHHh0Zw7uRqdWCyQ==:117

On Tue, 22 Feb 2011 17:51:18 -0800
Bart Schaefer <schaefer@brasslantern.com> wrote:
> On Tuesday, February 22, 2011, Vincent Stemen <vince.lists@hightek.org> w=
rote:
> >
> > I don't think it worked. =C2=A0With this patch added, the bahaviour did=
 not
> > change from the previous patch. =C2=A0Fatal error in sh mode not not in=
 zsh
> > mode.
>=20
> That's intentional.  Zsh is not a POSIX shell unless you tell it to
> be, so in zsh mode it behaves the way zsh always has.
>=20
> As I understand it, the patch should change the behavior of other
> special builtins (in addition to exec), but only when POSIXBUILTINS is
> set.

Bart's right, sorry, I wasn't clear enough.  Yes, this is the
long-standing policy.

If we'd been designing zsh from scratch now, there would be no point in
all these small areas where it's a bit different from POSIX by accident
rather than design.  As it is, given the shell's manifold differences in
native mode, there's no point squeezing extra POSIX-compliance out of
native mode at the expense of backward compatibility.

By the way, one small tweak which should be rarely visible: now I've
upped the ante, there may be cases where we're forked at the point we
need to exit.

Index: Src/exec.c
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D
RCS file: /cvsroot/zsh/zsh/Src/exec.c,v
retrieving revision 1.190
diff -p -u -r1.190 exec.c
--- Src/exec.c	22 Feb 2011 20:09:20 -0000	1.190
+++ Src/exec.c	23 Feb 2011 09:21:32 -0000
@@ -3306,8 +3306,10 @@ execcmd(Estate state, int input, int out
 	 */
 	if (redir_err || errflag) {
 	    if (!isset(INTERACTIVE)) {
-		/* We've already _exit'ed if forked */
-		exit(1);
+		if (forked)
+		    _exit(1);
+		else
+		    exit(1);
 	    }
 	    errflag =3D 1;
 	}
--=20
Peter Stephenson <p.w.stephenson@ntlworld.com>
Web page now at http://homepage.ntlworld.com/p.w.stephenson/

