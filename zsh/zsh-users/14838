From zsh-users-return-14838-mason-zsh=primenet.com.au@zsh.org Thu Feb 18 23:00:59 2010
Return-Path: <zsh-users-return-14838-mason-zsh=primenet.com.au@zsh.org>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 26505 invoked by alias); 18 Feb 2010 23:00:59 -0000
Mailing-List: contact zsh-users-help@zsh.org; run by ezmlm
Precedence: bulk
X-No-Archive: yes
List-Id: Zsh Users List <zsh-users.zsh.org>
List-Post: <mailto:zsh-users@zsh.org>
List-Help: <mailto:zsh-users-help@zsh.org>
Delivered-To: mailing list zsh-users@zsh.org
X-Seq: 14838
Received: (qmail 785 invoked from network); 18 Feb 2010 23:00:41 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received-SPF: none (ns1.primenet.com.au: domain at seiken.de does not designate permitted sender hosts)
From: Joke de Buhr <joke@seiken.de>
Organization: http://www.seiken.de/
To: zsh-users@zsh.org
Subject: Hugh number of file descriptor checks
Date: Fri, 19 Feb 2010 00:00:27 +0100
User-Agent: KMail/1.12.2 (Linux/2.6.31-19-generic; KDE/4.3.2; x86_64; ; )
MIME-Version: 1.0
Content-Type: multipart/signed;
  boundary="nextPart2392206.vZoDiMt4Et";
  protocol="application/pgp-signature";
  micalg=pgp-sha1
Content-Transfer-Encoding: 7bit
Message-Id: <201002190000.27806.joke@seiken.de>

--nextPart2392206.vZoDiMt4Et
Content-Type: text/plain;
  charset="utf-8"
Content-Transfer-Encoding: quoted-printable

I did some system call traces of a c program while I discovered zsh doing a=
=20
large amount of file descriptor checks during startup which seem unnecessar=
y.

Doing a simple strace like "strace zsh -c 'echo hello'" produces an output =
of=20
about 4280 system calls which include a sequence of 4032 system calls like:

    fcntl(64, F_GETFL)      =3D -1 EBADF (Bad file descriptor)
    fcntl(65, F_GETFL)      =3D -1 EBADF (Bad file descriptor)
    fcntl(66, F_GETFL)      =3D -1 EBADF (Bad file descriptor)
    .................. sequence continues ..................
    fcntl(4092, F_GETFL)    =3D -1 EBADF (Bad file descriptor)
    fcntl(4093, F_GETFL)    =3D -1 EBADF (Bad file descriptor)
    fcntl(4094, F_GETFL)    =3D -1 EBADF (Bad file descriptor)
    fcntl(4095, F_GETFL)    =3D -1 EBADF (Bad file descriptor)

I checked if bash or debian's almquist shell do these kind of system calls =
but=20
they don't. There may be a good reason why zsh does these checks but they=20
decrease zsh's performance for non interactive shells, especially on short=
=20
scripts.

If they could be removed zsh would be nearly as effective as bash.

Number of system calls: "strace zsh -c 'echo hello'"
    dash:  43
    bash: 169
    zsh: 4285


zsh verion 4.3.10 (x86_64-unknown-linux-gnu) (ubuntu karmic)

--nextPart2392206.vZoDiMt4Et
Content-Type: application/pgp-signature; name=signature.asc 
Content-Description: This is a digitally signed message part.

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.9 (GNU/Linux)

iQIcBAABCgAGBQJLfcaLAAoJEMcNQWzYfbLsyrQP/iis3QIVHN89NyJboY1a641q
FR3B4xiQTn9qt63K8WGb1XXIh/FdjQcYgFJqLhETTB45/YIkw0KIOayrCDJRZQSq
1mcyB4cvJ/yHZOllIWSB+DL4UfvonepL9LHxpRRk1hwvie/qfXz//B8HpM8iBmR3
7F9SKDCU5goseW15tP91D9lH8G5ljsHDUlkj0dGcO1KcjGK3l9rnKZJs+p4FYall
GqeTE5NeLF7dL9JDvjOx4UlyJ8BX1uk2SsIBxvZUJ27lyvbuqf24JY/6/Ex4++t3
hR/OY2/X8Uu7N+JbRrWbvufl+oVe0/tPn2j2kMUk46mnlYrKYPj+Bh7Afp9GkRD5
1Lnt0f2McQssdKF6tiyB5HoUIO2/g5p50KdeogsrZ0i7QI2M+xuQOzws4kIJf0zZ
wiPICOfNt/hZb5vY7iqO+kublc3wmpWVDVZIo7OYa5BtRBkQzJoRiitCM0faggWi
5xp3LLTCpF0ypikWCi0s1dFlzUXBX1ftDi18q/9V2LNxPoh8MtKwmlbrMw6xshaH
QcrKp12/RNhQx9gW6GWgA2yZWbXu+yC2TmR/updPyfGt+97eWEOjA2JXMsPCxOg8
9Jop3Pf01XPq6pvRIzYEJd/FjQ8YNlbQvxYaiQQFl2qgcL4YdBouupTDvjwpP6cI
0J9/XagRvHny3D0c7+oG
=IRB3
-----END PGP SIGNATURE-----

--nextPart2392206.vZoDiMt4Et--

