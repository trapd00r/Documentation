From zsh-workers-return-25797-mason-zsh=primenet.com.au@sunsite.dk Thu Oct 02 06:22:15 2008
Return-Path: <zsh-workers-return-25797-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 29628 invoked from network); 2 Oct 2008 06:22:13 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=BAYES_00 autolearn=ham
	version=3.2.5
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 2 Oct 2008 06:22:13 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 93070 invoked from network); 2 Oct 2008 06:21:38 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 2 Oct 2008 06:21:38 -0000
Received: (qmail 26965 invoked by alias); 2 Oct 2008 06:21:14 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 25797
Received: (qmail 26944 invoked from network); 2 Oct 2008 06:21:11 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 2 Oct 2008 06:21:11 -0000
Received: from vms173001pub.verizon.net (vms173001pub.verizon.net [206.46.173.1])
	by bifrost.dotsrc.org (Postfix) with ESMTP id 0F5378030847
	for <zsh-workers@sunsite.dk>; Thu,  2 Oct 2008 08:21:04 +0200 (CEST)
Received: from torch.brasslantern.com ([96.238.220.215])
 by vms173001.mailsrvcs.net
 (Sun Java System Messaging Server 6.2-6.01 (built Apr  3 2006))
 with ESMTPA id <0K8300B8OLN2VDF4@vms173001.mailsrvcs.net> for
 zsh-workers@sunsite.dk; Thu, 02 Oct 2008 01:21:03 -0500 (CDT)
Received: from torch.brasslantern.com (localhost.localdomain [127.0.0.1])
	by torch.brasslantern.com (8.13.1/8.13.1) with ESMTP id m926L1un013476	for
 <zsh-workers@sunsite.dk>; Wed, 01 Oct 2008 23:21:02 -0700
Received: (from schaefer@localhost)	by torch.brasslantern.com
 (8.13.1/8.13.1/Submit) id m926L0wv013475	for zsh-workers@sunsite.dk; Wed,
 01 Oct 2008 23:21:00 -0700
Date: Wed, 01 Oct 2008 23:21:00 -0700
From: Bart Schaefer <schaefer@brasslantern.com>
Subject: Re: fc -l doesn't match %h number?
In-reply-to: <6cd6de210810010854y37b51e98wc10e5008cf89423c@mail.gmail.com>
To: "Zsh hackers list" <zsh-workers@sunsite.dk>
Message-id: <081001232100.ZM13474@torch.brasslantern.com>
MIME-version: 1.0
X-Mailer: OpenZMail Classic (0.9.2 24April2005)
Content-type: text/plain; charset=us-ascii
References: <6cd6de210810010854y37b51e98wc10e5008cf89423c@mail.gmail.com>
Comments: In reply to "Rocky Bernstein" <rocky.bernstein@gmail.com>
 "fc -l doesn't match %h number?" (Oct  1, 11:54am)
X-Virus-Scanned: ClamAV 0.92.1/8370/Thu Oct  2 05:51:47 2008 on bifrost
X-Virus-Status: Clean

On Oct 1, 11:54am, Rocky Bernstein wrote:
} 
} Am I doing something wrong? Thought's about what's going on here?

Subshells have their own copy of the history, because they're forked.
I think the history mechanism is becoming confused because it's not
expecting to have anything added to the history in the middle of
command execution.

If you keep going from where you stopped:

hist<3> c
    1  a
    2  b
subshell level: 1
y=4 
hist<4> d
    1  a
subshell level: 0
x=5 
hist<3> 

Note that everything that happened at "level: 1" has vanished, including
the value shown by %h, when we get back to "level: 0".  Add a few more
lines to the script so as to keep going and:

hist<3> e
    1  a
    2  b
subshell level: 0
x=6 
hist<4> f
    1  a
    2  b
    3  e
subshell level: 0
x=7 
hist<5> q

Replace the ( ) with { } and it all works, so it has something to do
with prepping to fork.

Also, nothing is ever written to /tmp/hist even if INC_APPEND_HISTORY
is set, which is probably be a bug in "print -s".

