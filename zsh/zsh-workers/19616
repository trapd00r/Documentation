From zsh-workers-return-19616-mason-zsh=primenet.com.au@sunsite.dk Fri Mar 12 16:18:52 2004
Return-Path: <zsh-workers-return-19616-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 16409 invoked from network); 12 Mar 2004 16:18:51 -0000
Received: from sunsite.dk (130.225.247.90)
  by ns1.primenet.com.au with SMTP; 12 Mar 2004 16:18:51 -0000
Received: (qmail 4782 invoked by alias); 12 Mar 2004 16:18:40 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 19616
Received: (qmail 4769 invoked from network); 12 Mar 2004 16:18:39 -0000
Received: from localhost (HELO sunsite.dk) (127.0.0.1)
  by localhost with SMTP; 12 Mar 2004 16:18:39 -0000
X-MessageWall-Score: 0 (sunsite.dk)
Received: from [193.109.254.211] by sunsite.dk (MessageWall 1.0.8) with SMTP; 12 Mar 2004 16:18:39 -0000
X-VirusChecked: Checked
X-Env-Sender: okiddle@yahoo.co.uk
X-Msg-Ref: server-9.tower-36.messagelabs.com!1079108318!4595623
X-StarScan-Version: 5.2.5; banners=-,-,-
X-Originating-IP: [158.234.9.163]
Received: (qmail 25524 invoked from network); 12 Mar 2004 16:18:38 -0000
Received: from iris.logica.co.uk (158.234.9.163)
  by server-9.tower-36.messagelabs.com with SMTP; 12 Mar 2004 16:18:38 -0000
Received: from trentino.logica.co.uk ([158.234.142.61])
	by iris.logica.co.uk (8.12.3/8.12.3/Debian -4) with ESMTP id i2CGIbCk007179
	for <zsh-workers@sunsite.dk>; Fri, 12 Mar 2004 16:18:38 GMT
Received: from trentino.logica.co.uk (localhost [127.0.0.1])
	by trentino.logica.co.uk (Postfix) with ESMTP id CA88F79721C1
	for <zsh-workers@sunsite.dk>; Fri, 12 Mar 2004 17:17:52 +0100 (CET)
X-VirusChecked: Checked
X-StarScan-Version: 5.0.7; banners=.,-,-
In-reply-to: <18997.1079032558@csr.com> 
From: Oliver Kiddle <okiddle@yahoo.co.uk>
References: <18997.1079032558@csr.com>
To: zsh-workers@sunsite.dk (Zsh hackers list)
Subject: Re: PATCH: omit completion tests if no zpty 
Date: Fri, 12 Mar 2004 17:17:52 +0100
Message-ID: <1430.1079108272@trentino.logica.co.uk>

Peter wrote:
> This should prevent the lack of zpty causing unnecessary grief, although
> obviously it doesn't help if zpty is present but not working.

Note that we're now slightly inconsistent on wording for warnings about
missing modules:
./V01zmodload.ztst: starting.
Warning: zsh/example not linked: not checking autoloading
./V01zmodload.ztst: all tests successful.
./Y01completion.ztst: starting.
./Y01completion.ztst: skipped (the zsh/zpty module is not available)

though I appreciate that in V01, it is only some tests being skipped.

> I will try and get 4.2.0-pre-4 out when Oliver has finished off HP-UX
> for the time being.  I imagine we will have to do without zpty there.

With gcc, dynamic modules were being disabled. Hence, it couldn't load
the modules. The problem was it was trying to use the linker options from
the native compiler. With the patch below, gcc now builds a dynamic zsh.

> It would be nice at least to have some way of detecting if it doesn't
> work.  (Does it have /dev/ptmx?  Is it defining __SVR4?  If so, it might
> be getting into problems fiddling with STREAMS, which is the problem
> we had with the first go using /dev/ptmx on Linux.  If that looks
> likely, restricting the STREAMS stuff to Solaris is probably the best
> bet.  But that's only one of a dozen possibilities.)

__SVR4 is not defined. configure finds /dev/ptmx and deems it usable.
sys/stropts.h also found and deemed usable. Cutting off the two
`&& defined(__SVR4)' sections doesn't help. What else might I try?

Oliver

Index: configure.ac
===================================================================
RCS file: /cvsroot/zsh/zsh/configure.ac,v
retrieving revision 1.13
diff -u -r1.13 configure.ac
--- configure.ac	4 Mar 2004 14:03:48 -0000	1.13
+++ configure.ac	12 Mar 2004 16:07:08 -0000
@@ -2007,18 +2007,21 @@
   fi
   if test -n "$GCC"; then
     case "$host_os" in
+      hpux*)   DLLDFLAGS="${DLLDFLAGS=-shared}" ;;
       darwin*) DLCFLAGS="${DLCFLAGS=-fno-common}" ;;
       *)       DLCFLAGS="${DLCFLAGS=-fPIC}" ;;
     esac
   else
     case "$host_os" in
-      hpux*)                 DLCFLAGS="${DLCFLAGS=+z}" ;;
+      hpux*)
+        DLCFLAGS="${DLCFLAGS=+z}"
+        DLLDFLAGS="${DLLDFLAGS=-b}"
+      ;;
       sunos*)                DLCFLAGS="${DLCFLAGS=-pic}" ;;
       solaris*|sysv4*|esix*) DLCFLAGS="${DLCFLAGS=-KPIC}" ;;
     esac
   fi
   case "$host_os" in
-    hpux*)        DLLDFLAGS="${DLLDFLAGS=-b}" ;;
     freebsd*|linux*|irix*|osf*|gnu*) DLLDFLAGS="${DLLDFLAGS=-shared}" ;;
     sunos*)       DLLDFLAGS="${DLLDFLAGS=-assert nodefinitions}" ;;
     sysv4*|esix*) DLLDFLAGS="${DLLDFLAGS=-G $ldflags}" ;;

