From zsh-workers-return-16172-mason-zsh=primenet.com.au@sunsite.dk Fri Oct 26 12:02:54 2001
Return-Path: <zsh-workers-return-16172-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 25448 invoked from network); 26 Oct 2001 12:02:54 -0000
Received: from ns2.primenet.com.au (HELO primenet.com.au) (?tOnwH6TCa4Go9XKtKa5JS27fClzMaAcl?@203.24.36.3)
  by ns1.primenet.com.au with SMTP; 26 Oct 2001 12:02:54 -0000
Received: (qmail 4942 invoked from network); 26 Oct 2001 12:02:50 -0000
Received: from sunsite.dk (130.225.247.90)
  by proxy.melb.primenet.com.au with SMTP; 26 Oct 2001 12:02:50 -0000
Received: (qmail 16465 invoked by alias); 26 Oct 2001 12:02:40 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 16172
Received: (qmail 16447 invoked from network); 26 Oct 2001 12:02:39 -0000
To: zsh-workers@sunsite.dk (Zsh hackers list)
Subject: PATCH: tcp/zftp function name
Date: Fri, 26 Oct 2001 13:02:06 +0100
Message-ID: <11058.1004097726@csr.com>
From: Peter Stephenson <pws@csr.com>

This fixes one of the two remaining problems I'm having with tcp and zftp,
namely an error message from zsh's free().  It seems an undocumented
library function which called free() was insinuating its way in, though
where from I still haven't a clue; gdb couldn't trace it, so it's unlikely
to be a stray bit of zsh.

Now there's just the matter of
  zfclose:3: connection close failed: bad file number
to deal with.

Index: Src/Modules/tcp.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Modules/tcp.c,v
retrieving revision 1.19
diff -u -r1.19 tcp.c
--- Src/Modules/tcp.c	2001/10/14 17:23:30	1.19
+++ Src/Modules/tcp.c	2001/10/26 11:56:38
@@ -194,7 +194,7 @@
 
 /**/
 mod_export void
-freehostent(struct hostent *ptr)
+zfreehostent(struct hostent *ptr)
 {
 }
 
Index: Src/Modules/zftp.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Modules/zftp.c,v
retrieving revision 1.22
diff -u -r1.22 zftp.c
--- Src/Modules/zftp.c	2001/10/26 11:09:48	1.22
+++ Src/Modules/zftp.c	2001/10/26 11:56:38
@@ -1793,7 +1793,7 @@
 		tcp_close(zfsess->control);
 		zfsess->control = NULL;
 	    }
-	    freehostent(zhostp);
+	    zfreehostent(zhostp);
 	    zfunsetparam("ZFTP_HOST");
 	    FAILED();
 	    zwarnnam(name, "socket failed: %e", NULL, errno);
@@ -1821,7 +1821,7 @@
 	}
 
 	if (err) {
-	    freehostent(zhostp);
+	    zfreehostent(zhostp);
 	    zfclose(0);
 	    FAILED();
 	    zwarnnam(name, "connect failed: %e", NULL, errno);
@@ -1842,7 +1842,7 @@
 	zsh_inet_ntop(af, *addrp, pbuf, sizeof(pbuf));
 	zfsetparam("ZFTP_IP", ztrdup(pbuf), ZFPM_READONLY);
     }
-    freehostent(zhostp);
+    zfreehostent(zhostp);
     /* now we can talk to the control connection */
     zcfinish = 0;
 
-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR Ltd., Science Park, Milton Road,
Cambridge, CB4 0WH, UK                          Tel: +44 (0)1223 392070


**********************************************************************
The information transmitted is intended only for the person or
entity to which it is addressed and may contain confidential 
and/or privileged material. 
Any review, retransmission, dissemination or other use of, or
taking of any action in reliance upon, this information by 
persons or entities other than the intended recipient is 
prohibited.  
If you received this in error, please contact the sender and 
delete the material from any computer.
**********************************************************************

