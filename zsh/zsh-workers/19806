From zsh-workers-return-19806-mason-zsh=primenet.com.au@sunsite.dk Wed Apr 21 08:19:51 2004
Return-Path: <zsh-workers-return-19806-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 484 invoked from network); 21 Apr 2004 08:19:51 -0000
Received: from sunsite.dk (130.225.247.90)
  by ns1.primenet.com.au with SMTP; 21 Apr 2004 08:19:51 -0000
Received: (qmail 20875 invoked by alias); 21 Apr 2004 08:19:41 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 19806
Received: (qmail 20864 invoked from network); 21 Apr 2004 08:19:41 -0000
Received: from localhost (HELO sunsite.dk) (127.0.0.1)
  by localhost with SMTP; 21 Apr 2004 08:19:40 -0000
X-MessageWall-Score: 0 (sunsite.dk)
Received: from [130.225.247.86] by sunsite.dk (MessageWall 1.0.8) with SMTP; 21 Apr 2004 8:19:40 -0000
Received: (qmail 12341 invoked from network); 21 Apr 2004 08:19:40 -0000
Received: from mail36.messagelabs.com (193.109.254.211)
  by a.mx.sunsite.dk with SMTP; 21 Apr 2004 08:19:37 -0000
X-VirusChecked: Checked
X-Env-Sender: okiddle@yahoo.co.uk
X-Msg-Ref: server-18.tower-36.messagelabs.com!1082535549!5556585
X-StarScan-Version: 5.2.10; banners=-,-,-
X-Originating-IP: [158.234.9.163]
Received: (qmail 23162 invoked from network); 21 Apr 2004 08:19:09 -0000
Received: from iris.logica.co.uk (158.234.9.163)
  by server-18.tower-36.messagelabs.com with SMTP; 21 Apr 2004 08:19:09 -0000
Received: from trentino.logica.co.uk ([158.234.142.61])
	by iris.logica.co.uk (8.12.3/8.12.3/Debian -4) with ESMTP id i3L8J8MO025167;
	Wed, 21 Apr 2004 09:19:09 +0100
Received: from trentino.logica.co.uk (localhost [127.0.0.1])
	by trentino.logica.co.uk (Postfix) with ESMTP
	id 3B3AF7922922; Wed, 21 Apr 2004 10:18:24 +0200 (CEST)
Cc: Matthias Kopfermann <matthias@kopfermann.org>
X-VirusChecked: Checked
X-StarScan-Version: 5.0.7; banners=.,-,-
In-reply-to: <20040421010442.GA13744@scowler.net> 
From: Oliver Kiddle <okiddle@yahoo.co.uk>
References: <20040421010442.GA13744@scowler.net>
To: zsh-workers@sunsite.dk
Subject: PATCH: prompt bug (Re: [matthias@kopfermann.org: Re: pcre-module])
Date: Wed, 21 Apr 2004 10:18:24 +0200
Message-ID: <18782.1082535504@trentino.logica.co.uk>
X-Spam-Checker-Version: SpamAssassin 2.63 on a.mx.sunsite.dk
X-Spam-Level: 
X-Spam-Status: No, hits=0.0 required=6.0 tests=none autolearn=no version=2.63
X-Spam-Hits: 0.0

Clint Adams wrote:
> ----- Forwarded message from Matthias Kopfermann <matthias@kopfermann.org> -----
> As Bart is busy (I told him), there is a _serious_ - I guess so, but I am
> not quite sure- bug in zsh that I found out today:
> 
> Its with the prompt variable %v.
> I tried `print -P %-10v' and i got a segfault on all 4.x

Thanks for spotting this.

This should fix it.

Oliver

Index: Src/prompt.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/prompt.c,v
retrieving revision 1.14
diff -u -r1.14 prompt.c
--- Src/prompt.c	13 Nov 2003 14:34:38 -0000	1.14
+++ Src/prompt.c	21 Apr 2004 08:10:29 -0000
@@ -579,7 +579,7 @@
 		    arg = 1;
 		else if (arg < 0)
 		    arg += arrlen(psvar) + 1;
-		if (arrlen(psvar) >= arg)
+		if (arg > 0 && arrlen(psvar) >= arg)
 		    stradd(psvar[arg - 1]);
 		break;
 	    case 'E':

