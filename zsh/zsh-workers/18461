From zsh-workers-return-18461-mason-zsh=primenet.com.au@sunsite.dk Wed Apr 23 10:18:54 2003
Return-Path: <zsh-workers-return-18461-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 12409 invoked from network); 23 Apr 2003 10:18:53 -0000
Received: from sunsite.dk (130.225.247.90)
  by ns1.primenet.com.au with SMTP; 23 Apr 2003 10:18:53 -0000
Received: (qmail 13574 invoked by alias); 23 Apr 2003 10:18:47 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 18461
Received: (qmail 13559 invoked from network); 23 Apr 2003 10:18:47 -0000
Received: from localhost (HELO sunsite.dk) (127.0.0.1)
  by localhost with SMTP; 23 Apr 2003 10:18:47 -0000
X-MessageWall-Score: 0 (sunsite.dk)
Received: from [212.125.75.4] by sunsite.dk (MessageWall 1.0.8) with SMTP; 23 Apr 2003 10:18:46 -0000
Received: (qmail 20204 invoked from network); 23 Apr 2003 10:17:08 -0000
Received: from iris.logica.co.uk (158.234.9.163)
  by server-18.tower-1.messagelabs.com with SMTP; 23 Apr 2003 10:17:08 -0000
Received: from gmcs3.logica.co.uk ([158.234.142.61])
	by iris.logica.co.uk (8.9.3/8.9.3/Debian 8.9.3-21) with ESMTP id LAA27077;
	Wed, 23 Apr 2003 11:17:08 +0100
X-Authentication-Warning: iris.logica.co.uk: Host [158.234.142.61] claimed to be gmcs3.logica.co.uk
Received: from gmcs3.logica.co.uk (localhost [127.0.0.1])
	by gmcs3.logica.co.uk (8.11.6/8.11.6/SuSE Linux 0.5) with ESMTP id h3NAH2F22802;
	Wed, 23 Apr 2003 12:17:02 +0200
cc: zw <zsh-workers@sunsite.dk>
X-VirusChecked: Checked
In-reply-to: <20030401151646.34142.qmail@web10411.mail.yahoo.com> 
From: Oliver Kiddle <okiddle@yahoo.co.uk>
References: <20030401151646.34142.qmail@web10411.mail.yahoo.com>
To: Felix Rosencrantz <f_rosencrantz@yahoo.com>
Subject: PATCH: Re: Bug with _perl_builtin_funcs 
Date: Wed, 23 Apr 2003 12:17:02 +0200
Message-ID: <22800.1051093022@gmcs3.logica.co.uk>

On 1 Apr, Felix Rosencrantz wrote:
> There is a bug in the function _perl_builtin_funcs.  This function attempts to
> build a list of perl builtin funcs by parsing the man page for perlfunc.  When
> it parses the man page it assume it is plain text.  However, on RH the man page
> is compressed with gzip.

This should make it use bzip2 or gzip as appropriate. I also had
problems with the lines starting .IP instead of .Ip so I fixed that so
it now works on my system.

Oliver

Index: _perl_builtin_funcs
===================================================================
RCS file: /cvsroot/zsh/zsh/Completion/Unix/Type/_perl_builtin_funcs,v
retrieving revision 1.1
diff -u -r1.1 _perl_builtin_funcs
--- _perl_builtin_funcs	2 Apr 2001 11:40:15 -0000	1.1
+++ _perl_builtin_funcs	23 Apr 2003 10:10:22 -0000
@@ -8,24 +8,31 @@
 # for future use.
 #
 
-if [[ ${+_perl_builtin_funcs} -eq 0 ]]; then
+if (( ! $+_perl_builtin_funcs )); then
   typeset -agU _perl_builtin_funcs
   local perlfunc
 
-  if [[ -n "${perlfunc:=$(man -w perlfunc 2>/dev/null; print -l ${^manpath}/man1/perlfunc.1(N) {/usr/man,/usr/share/man,/usr/local/man}/man1/perlfunc.1(N))}" ]]; then
-    _perl_builtin_funcs=( `perl -lne '
-                             $in_funcs++, next if /Alphabetical/;     \
-                             next unless $in_funcs;                   \
-                             if (/^\.Ip "(\w+)/) {                    \
-                               print $1 unless $func{$1}; $func{$1}++ \
-                             }' $=perlfunc`
-               )
+  if [[ -n "${perlfunc:=$(man -w perlfunc 2>/dev/null; print -l ${^manpath:-${(s.:.)$(manpath)}}/man1/perlfunc.1(|[zZ]|gz|bz2)(N) {/usr/man,/usr/share/man,/usr/local/man}/man1/perlfunc.1(|[zZ]|gz|bz2)(N))}" ]]; then
+    case $perlfunc in
+      *.bz2) perlfunc="bzip2 -cd $perlfunc" ;;
+      *[zZ]) perlfunc="gzip -cd $perlfunc" ;;
+      *) perlfunc="cat $perlfunc" ;;
+    esac
+    _perl_builtin_funcs=(
+      $($=perlfunc | perl -lne '
+      $in_funcs++, next if /Alphabetical/;
+      next unless $in_funcs;
+      if (/^\.I[pP] "(\w+)/) {
+        print $1 unless $func{$1}; $func{$1}++
+      }')
+    )
   else
-    echo "Couldn't find perlfunc man page; giving up."
+    _message "can't find perlfunc man page; giving up"
     return 1
   fi
 fi
 
 local expl
 
-_wanted functions expl 'Perl built-in functions' compadd -a _perl_builtin_funcs
+_wanted functions expl 'perl built-in function' compadd "$@" -a - \
+    _perl_builtin_funcs

