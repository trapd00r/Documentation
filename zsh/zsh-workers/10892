From zsh-workers-return-10892-mason-zsh=primenet.com.au@sunsite.auc.dk Sat Apr 22 16:11:30 2000
Return-Path: <zsh-workers-return-10892-mason-zsh=primenet.com.au@sunsite.auc.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 8984 invoked from network); 22 Apr 2000 16:11:30 -0000
Received: from sunsite.auc.dk (130.225.51.30)
  by ns1.primenet.com.au with SMTP; 22 Apr 2000 16:11:30 -0000
Received: (qmail 24244 invoked by alias); 22 Apr 2000 16:11:23 -0000
Mailing-List: contact zsh-workers-help@sunsite.auc.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.auc.dk
X-Seq: 10892
Received: (qmail 24236 invoked from network); 22 Apr 2000 16:11:23 -0000
Date: Sat, 22 Apr 2000 17:11:21 +0100
From: Adam Spiers <adam@spiers.net>
To: zsh workers mailing list <zsh-workers@sunsite.auc.dk>
Subject: PATCH: improved _perl_modules
Message-ID: <20000422171121.F8684@thelonious.new.ox.ac.uk>
Reply-To: Adam Spiers <adam@spiers.net>
Mail-Followup-To: zsh workers mailing list <zsh-workers@sunsite.auc.dk>
Mime-Version: 1.0
Content-Type: text/plain; charset=us-ascii
X-Mailer: Mutt 1.0.1i
X-Home-Page: http://www.new.ox.ac.uk/~adam/
X-OS: RedHat Linux

If Perl isn't found by the `which' below, it might be nice to warn the
user, but I don't know how to do that.  I thought of _message but the
list of completions gets in the way ...  Maybe it's not worth the
effort.

I haven't committed this to CVS yet, because I lost track of what was
decided about references to sequence numbers and ChangeLogs etc.  Can
some kind soul please summarise the procedure? (and confirm that I'm
trusted enough to make small changes like this without cocking up
badly ;-)  Thanks.


Index: Completion/User/_perl_modules
===================================================================
RCS file: /cvsroot/zsh/zsh/Completion/User/_perl_modules,v
retrieving revision 1.1.1.6
diff -u -r1.1.1.6 _perl_modules
--- Completion/User/_perl_modules	2000/03/23 04:19:30	1.1.1.6
+++ Completion/User/_perl_modules	2000/04/22 16:05:40
@@ -26,7 +26,17 @@
     _perl_modules=( $(pminst) )
   else
     local inc libdir new_pms
-    inc=( $( perl -e 'print "@INC"' ) )
+    if which perl >/dev/null; then
+      inc=( $( perl -e 'print "@INC"' ) )
+    else
+      # If perl isn't there, one wonders why the user's trying to
+      # complete Perl modules.  Maybe her $path is wrong?
+
+      setopt localoptions extendedglob
+      inc=( /usr/lib/perl5{,/{site_perl/,}<5->.([0-9]##)}(N) 
+            ${(s.:.)PERL5LIB} )
+    fi
+
     typeset -agU _perl_modules  # _perl_modules is global, no duplicates
     _perl_modules=( )
 
@@ -36,7 +46,7 @@
 
       # Find all modules
       cd $libdir
-      new_pms=( {[A-Z]*/**/,}*.pm(N) )
+      new_pms=( {[A-Z]*/***/,}*.pm~*blib*(N) )
       cd $OLDPWD
 
       # Convert to Perl nomenclature

