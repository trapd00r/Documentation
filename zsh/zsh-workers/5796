From zsh-workers-return-5796-mason-zsh=primenet.com.au@sunsite.auc.dk Mon Mar 15 09:54:20 1999
Return-Path: <zsh-workers-return-5796-mason-zsh=primenet.com.au@sunsite.auc.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 25866 invoked from network); 15 Mar 1999 09:54:15 -0000
Received: from sunsite.auc.dk (130.225.51.30)
  by ns1.primenet.com.au with SMTP; 15 Mar 1999 09:54:15 -0000
Received: (qmail 3041 invoked by alias); 15 Mar 1999 09:53:58 -0000
Mailing-List: contact zsh-workers-help@sunsite.auc.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.auc.dk
X-Seq: 5796
Received: (qmail 3033 invoked from network); 15 Mar 1999 09:53:57 -0000
Date: Mon, 15 Mar 1999 10:51:46 +0100 (MET)
Message-Id: <199903150951.KAA22815@beta.informatik.hu-berlin.de>
From: Sven Wischnowsky <wischnow@informatik.hu-berlin.de>
To: zsh-workers@sunsite.auc.dk
Subject: PATCH: nomenucom and globcomp


This week's first apologies go to those who don't use menucompletion
but have globcomplete set.

The patch I sent in 5775 (turn on menucompletion if `compstate[pattern_match]'
was explicitly set) made menucompletion always turned on for them.


Bye
 Sven

diff -u os/Zle/zle_tricky.c Src/Zle/zle_tricky.c
--- os/Zle/zle_tricky.c	Fri Mar 12 20:39:48 1999
+++ Src/Zle/zle_tricky.c	Fri Mar 12 20:40:31 1999
@@ -5032,6 +5032,7 @@
 docompletion(char *s, int lst, int incmd)
 {
     HEAPALLOC {
+	char *opm;
 	LinkNode n;
 
 	pushheap();
@@ -5045,7 +5046,7 @@
 		   ((isset(AUTOLIST) && !isset(BASHAUTOLIST)) ? 
 		    (isset(LISTAMBIGUOUS) ? 3 : 2) : 0) : 1);
 	zsfree(comppatmatch);
-	comppatmatch = ztrdup(useglob ? "yes" : "");
+	opm = comppatmatch = ztrdup(useglob ? "yes" : "");
 	zsfree(compforcelist);
 	compforcelist = ztrdup("");
 	haspattern = 0;
@@ -5057,7 +5058,7 @@
 	    clearlist = 1;
 	    goto compend;
 	}
-	if (comppatmatch && *comppatmatch)
+	if (comppatmatch && *comppatmatch && comppatmatch != opm)
 	    haspattern = 1;
 	if (!useline && uselist)
 	    /* All this and the guy only wants to see the list, sigh. */

--
Sven Wischnowsky                         wischnow@informatik.hu-berlin.de

