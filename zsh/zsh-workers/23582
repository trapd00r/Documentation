From zsh-workers-return-23582-mason-zsh=primenet.com.au@sunsite.dk Fri Jun 22 22:40:34 2007
Return-Path: <zsh-workers-return-23582-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 15813 invoked from network); 22 Jun 2007 22:40:32 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.1 (2007-05-02) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.1
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 22 Jun 2007 22:40:32 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 75833 invoked from network); 22 Jun 2007 22:40:26 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 22 Jun 2007 22:40:26 -0000
Received: (qmail 28790 invoked by alias); 22 Jun 2007 22:40:23 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 23582
Received: (qmail 28781 invoked from network); 22 Jun 2007 22:40:22 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 22 Jun 2007 22:40:22 -0000
Received: (qmail 75552 invoked from network); 22 Jun 2007 22:40:22 -0000
Received: from linuxtage.at (HELO mail.michael-prokop.at) (88.198.184.149)
  by a.mx.sunsite.dk with SMTP; 22 Jun 2007 22:40:18 -0000
Received: from mika.vc-graz.ac.at (mail.michael-prokop.at [88.198.6.110])
	by mail.michael-prokop.at (Postfix) with ESMTP id 4EC5C47808D
	for <zsh-workers@sunsite.dk>; Sat, 23 Jun 2007 00:40:09 +0200 (CEST)
Date: Sat, 23 Jun 2007 00:40:09 +0200
From: Michael Prokop <news@michael-prokop.at>
To: zsh-workers@sunsite.dk
Subject: Re: zsh history gets destroyed when running out of disk space
Message-ID: <2007-06-23T00-31-50@devnull.michael-prokop.at>
Mail-Followup-To: zsh-workers@sunsite.dk
References: <2007-06-11T21-20-52@devnull.michael-prokop.at> <20070621080454.GA3303@fsst.voodoo.lan> <20070622212825.a8d29679.p.w.stephenson@ntlworld.com>
MIME-Version: 1.0
Content-Type: multipart/signed; micalg=pgp-sha1;
	protocol="application/pgp-signature"; boundary="E0IhBwMLbrMClE+H"
Content-Disposition: inline
In-Reply-To: <20070622212825.a8d29679.p.w.stephenson@ntlworld.com>
X-URL: http://www.michael-prokop.at/
X-Operating-System: Debian GNU/Linux - 2.6.20-grml on a i686
X-Registered-Linux-User: 224337
X-Crypto: GnuPG/1.2.3 http://www.gnupg.org
X-GPG-Key-ID: 0x37E272E8
X-GPG-Key: http://www.michael-prokop.at/gpg
X-GPG-Fingerprint: 04AE E62C 9502 CD34 A7DA 857B D8DF 53FB 37E2 72E8
User-Agent: Mutt/1.5.13 (2006-08-11)


--E0IhBwMLbrMClE+H
Content-Type: text/plain; charset=iso-8859-1
Content-Disposition: inline
Content-Transfer-Encoding: quoted-printable

* Peter Stephenson <p.w.stephenson@ntlworld.com> [20070622 22:31]:
> On Thu, 21 Jun 2007 10:04:54 +0200 Frank Terbeck <ft@bewatermyfriend.org>=
 wrote:
> > Michael Prokop <news@michael-prokop.at>:

> > > Problem:
> > > Zsh truncates the zsh history file if you are running out of disk
> > > space (AKA ENOSPC). If you don't have any space left in your $HOME
> > > and exit zsh you'll find an empty $HISTFILE left.

> > Hey, I experienced just the same a few days back. So, I also think
> > this should be addressed.

> The following detects errors during writing better.  If you're writing a
> new file it'll leave it wherever it gets to; if you're replacing an old
> file it will leave the old file alone.  That's about the best we can do.
> I haven't tested this on a failure, but it should be better than what
> we've got.

Verified, works.

Exiting shell quits with:

| zsh: failed to write history file /home/grml/.zsh_history.new: unknown er=
ror 1182546552

and an empty /home/grml/.zsh_history.new file is left. My original
/home/grml/.zsh_history is left untouched (no truncating anymore).
During a shell session the history file is getting longer only as
long as there a free bits left (as you intented to). The error code
might be improved though. ;)

regards,
-mika-
--=20
 ,'"`.         http://www.michael-prokop.at/
(  grml.org -=BB Linux Live-CD for texttool-users and sysadmins
 `._,'         http://www.grml.org/

--E0IhBwMLbrMClE+H
Content-Type: application/pgp-signature; name="signature.asc"
Content-Description: Digital signature
Content-Disposition: inline

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.6 (GNU/Linux)

iD8DBQFGfE/I2N9T+zficugRAh98AJ0a2ofIY0WuBzuZ/wD3H2pUmH0yqQCfWG+4
4BLit9pNKB4xQaQN/MCVsMY=
=tP0D
-----END PGP SIGNATURE-----

--E0IhBwMLbrMClE+H--

