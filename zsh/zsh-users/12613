From zsh-users-return-12613-mason-zsh=primenet.com.au@sunsite.dk Sun Feb 17 19:27:42 2008
Return-Path: <zsh-users-return-12613-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 23026 invoked from network); 17 Feb 2008 19:27:39 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.4 (2008-01-01) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.4
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 17 Feb 2008 19:27:39 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 99529 invoked from network); 17 Feb 2008 19:27:24 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 17 Feb 2008 19:27:24 -0000
Received: (qmail 519 invoked by alias); 17 Feb 2008 19:27:15 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 12613
Received: (qmail 505 invoked from network); 17 Feb 2008 19:27:14 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 17 Feb 2008 19:27:14 -0000
Received: from mtaout03-winn.ispmail.ntl.com (mtaout03-winn.ispmail.ntl.com [81.103.221.49])
	by bifrost.dotsrc.org (Postfix) with ESMTP id 57A0B8026E0B
	for <zsh-users@sunsite.dk>; Sun, 17 Feb 2008 20:27:11 +0100 (CET)
Received: from aamtaout01-winn.ispmail.ntl.com ([81.103.221.35])
          by mtaout03-winn.ispmail.ntl.com with ESMTP
          id <20080217192934.PXPE19530.mtaout03-winn.ispmail.ntl.com@aamtaout01-winn.ispmail.ntl.com>
          for <zsh-users@sunsite.dk>; Sun, 17 Feb 2008 19:29:34 +0000
Received: from pws-pc.ntlworld.com ([81.107.42.63])
          by aamtaout01-winn.ispmail.ntl.com with ESMTP
          id <20080217192941.JUO219.aamtaout01-winn.ispmail.ntl.com@pws-pc.ntlworld.com>
          for <zsh-users@sunsite.dk>; Sun, 17 Feb 2008 19:29:41 +0000
Received: from pws-pc (pws-pc [127.0.0.1])
	by pws-pc.ntlworld.com (8.14.2/8.14.2) with ESMTP id m1HJPbE8009696
	for <zsh-users@sunsite.dk>; Sun, 17 Feb 2008 19:25:37 GMT
Message-Id: <200802171925.m1HJPbE8009696@pws-pc.ntlworld.com>
From: Peter Stephenson <p.w.stephenson@ntlworld.com>
To: zsh-users@sunsite.dk
Subject: Re: _approximate doesn't work
In-Reply-To: Message from Anthony Charles <antho.charles@gmail.com>
   of "Sun, 17 Feb 2008 19:17:02 +0100." <20080217181702.GA5143@localhost.localdomain>
Date: Sun, 17 Feb 2008 19:25:37 +0000
X-Cloudmark-Analysis: v=1.0 c=1 a=lo-UgsnH840A:15 a=3FTp5y5X6ml6ZCsPBftHHg==:17 a=NLZqzBF-AAAA:8 a=nBN9wxYaGgTZFV2YQsgA:9 a=Lr-PrRYhIFbxkB-IPUooeGNrRTQA:4 a=_dQi-Dcv4p4A:10 a=kJVaTwQnZmMA:10
X-Virus-Scanned: ClamAV 0.91.2/5851/Sun Feb 17 20:12:36 2008 on bifrost
X-Virus-Status: Clean

Anthony Charles wrote:
> There's a lot of differences

The business end of command completion changed.  It used simply to add
the commands array directly; now it goes through the function
_path_commands.  The problem is around this bit that's used if descriptions
for the commands are needed (the verbose style is set and at least some
commands have descriptions):

  for cmd in ${(@)commands[(I)$PREFIX*]}; do
    desc=$_command_descriptions[$cmd]
    if [[ -z $desc ]]; then
      cmds+=$cmd
    else
      dcmds+=$cmd
      descs+="$cmd:$desc"
    fi
  done

I can see that _path_commands is skipping this loop, indicating the
expansion was empty.  However, I can't see why this is happening.
PREFIX at this point is apparently (#a1)apt_g, so we should get apt-get
as a match in the special commands associative array.  This works for me
if I use xsane_g to search for xsane-gimp (since I don't have apt-get).

It's possible this is part of problems with pattern matching: we've had
two independent reports of odd failures suggesting there's something
going on in memory allocation.  Ideally, it would be good to debug why
(#a1)apt_g* is failing to match apt-get (having confirmed it is indeed
trying to do so).  I can't reproduce any such failure at the moment.

It would be very useful to have someone else cast their eyes over
pattern.c and over any parameter code that allocates memory in order to
call into pattern.c to see if I've made any errors in length calculations.
It's quite likely to be a week before I get a chance to look at it and I
might well miss any problems again.

-- 
Peter Stephenson <p.w.stephenson@ntlworld.com>
Web page now at http://homepage.ntlworld.com/p.w.stephenson/

