From zsh-workers-request@math.gatech.edu  Thu Jun  8 21:21:28 1995
Received: from gatech.edu (gatech.edu [130.207.244.244]) by werple.mira.net.au (8.6.12/8.6.9) with SMTP id VAA17327 for <mason@werple.mira.net.au>; Thu, 8 Jun 1995 21:21:24 +1000
Received: from math (math.skiles.gatech.edu) by gatech.edu with SMTP id AA26057
  (5.65c/Gatech-10.0-IDA for <mason@werple.mira.net.au>); Thu, 8 Jun 1995 07:19:47 -0400
Received: by math (5.x/SMI-SVR4)
	id AA11813; Thu, 8 Jun 1995 07:17:49 -0400
Resent-Date: Thu, 08 Jun 95 12:17:34 +0100
Old-Return-Path: <P.Stephenson@swansea.ac.uk>
Message-Id: <12218.9506081117@pyro.swan.ac.uk>
To: zsh-workers@math.gatech.edu (Zsh hackers list)
Subject: Ultrix typeahead fix
Date: Thu, 08 Jun 95 12:17:34 +0100
From: P.Stephenson@swansea.ac.uk
X-Mts: smtp
Resent-Message-Id: <"RmEGe2.0.Ru2.Snjrl"@math>
Resent-From: zsh-workers@math.gatech.edu
X-Mailing-List: <zsh-workers@math.gatech.edu> archive/latest/88
X-Loop: zsh-workers@math.gatech.edu
Precedence: list
Resent-Sender: zsh-workers-request@math.gatech.edu

I reported a couple of days ago that typeahead was broken on Ultrix
(4.3, at least).

I'm delighted to report this is not my fault.  I'm only slightly less
delighted to report a fix :-) :-).

In fact, the code is there already, #ifdef'd behind a test for
CLOBBERS_TYPEAHEAD (actually, that was a bit of a giveaway).  This is
one of the old buildzsh definitions that hasn't made it into configure
yet.  The problem is that it's not that easy to test.  I've therefore
just added an ad hoc test for Ultrix to configure.in.

It would be much better to find a proper test: write a C program which
waits for a bit, then switches from canonical to non-canonical input
while a complete line was put into the input queue, and sees if the
read blocks.  (Unfortunately select() tells you there is something in
the queue, so there seems to be no way round actually trying to get a
character.  I haven't investigated what happens with a non-blocking
read().)

However, this fix is 100% vital in any case so we should certainly use
something like the following for the time being.  I wondered if it
fixed the OSF/1 problem (read() blocking on typeahead until a new key
is typed), but it didn't seem to.

By the way, there's another phantom preprocessor definition:
TTY_NEEDS_DRAINING.  Someone, somewhere may find this coming back to
haunt them.

(FIONREAD sounds extremely Gaelic.  I can't believe he's not a
relative of Finn McCumhal.)

*** config.h.in.clob	Wed May 31 05:09:34 1995
--- config.h.in	Thu Jun  8 11:18:55 1995
***************
*** 333,335 ****
--- 333,338 ----
  
  /* Define if you have the nsl library (-lnsl).  */
  #undef HAVE_LIBNSL
+ 
+ /* Define if your system's typeahead disappears from the shell editor. */
+ #undef CLOBBERS_TYPEAHEAD
*** configure.clob	Thu Jun  8 11:26:56 1995
--- configure	Thu Jun  8 11:37:18 1995
***************
*** 2321,2326 ****
--- 2321,2338 ----
  
  echo "$ac_t""$wtmp_file" 1>&6
  
+ echo $ac_n "checking if typeahead needs FIONREAD""... $ac_c" 1>&6
+ if test `echo $host_os | sed 's/^\([a-z]*\).*/\1/'` = ultrix; then
+   cat >> confdefs.h <<\EOF
+ #define CLOBBERS_TYPEAHEAD 1
+ EOF
+ 
+   zsh_cv_clobbers_typeahead=yes
+ else
+   zsh_cv_clobbers_typeahead=no
+ fi
+ echo "$ac_t""$zsh_cv_clobbers_typeahead" 1>&6
+ 
  trap '' 1 2 15
  cat > confcache <<\EOF
  # This file is a shell script that caches the results of configure
*** configure.in.clob	Wed May 31 05:09:21 1995
--- configure.in	Thu Jun  8 11:37:13 1995
***************
*** 415,420 ****
--- 415,435 ----
  AC_DEFINE_UNQUOTED(WTMP_FILE_CONFIG, "$wtmp_file")
  AC_MSG_RESULT($wtmp_file)
  
+ dnl Some systems clobber typeahead when you go from canonical input
+ dnl processing to non-canonical, so we need a FIONREAD ioctl.
+ dnl I don't know how to check this with configure, so I am using the
+ dnl system names directly.
+ dnl Note doubled square brackets for M4.
+ dnl (PWS 1995/06/08)
+ AC_MSG_CHECKING(if typeahead needs FIONREAD)
+ if test `echo $host_os | sed 's/^\([[a-z]]*\).*/\1/'` = ultrix; then
+   AC_DEFINE(CLOBBERS_TYPEAHEAD)
+   zsh_cv_clobbers_typeahead=yes
+ else
+   zsh_cv_clobbers_typeahead=no
+ fi
+ AC_MSG_RESULT($zsh_cv_clobbers_typeahead)
+ 
  AC_OUTPUT(Makefile Src/Makefile Doc/Makefile Etc/Makefile Misc/Makefile \
  Util/Makefile Functions/Makefile Startup_Files/Makefile, \
  [echo > stamp-h])

-- 
Peter Stephenson <P.Stephenson@swansea.ac.uk>  Tel: +44 1792 205678 extn. 4461
WWW:  http://python.swan.ac.uk/~pypeters/      Fax: +44 1792 295324
Department of Physics, University of Wales, Swansea,
Singleton Park, Swansea, SA2 8PP, U.K.

