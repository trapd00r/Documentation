From zsh-workers-request@math.gatech.edu  Fri Jun  9 05:24:10 1995
Received: from gatech.edu (gatech.edu [130.207.244.244]) by werple.mira.net.au (8.6.12/8.6.9) with SMTP id FAA03973 for <mason@werple.mira.net.au>; Fri, 9 Jun 1995 05:24:06 +1000
Received: from math (math.skiles.gatech.edu) by gatech.edu with SMTP id AA01931
  (5.65c/Gatech-10.0-IDA); Thu, 8 Jun 1995 15:03:12 -0400
Received: by math (5.x/SMI-SVR4)
	id AA17223; Thu, 8 Jun 1995 15:01:12 -0400
Resent-Date: Thu, 08 Jun 1995 14:59:54 -0400
Old-Return-Path: <coleman@math.gatech.edu>
Message-Id: <9506081859.AA07274@redwood.skiles.gatech.edu>
X-Mailer: exmh version 1.5.3 12/28/94
To: zsh-workers@math.gatech.edu
Subject: Re: typeahead fix 
In-Reply-To: Your message of "Thu, 08 Jun 1995 12:17:34 BST."
             <12218.9506081117@pyro.swan.ac.uk> 
Mime-Version: 1.0
Content-Type: text/plain; charset="us-ascii"
Date: Thu, 08 Jun 1995 14:59:54 -0400
From: Richard Coleman <coleman@math.gatech.edu>
Resent-Message-Id: <"ORqYo2.0.1D4.tZqrl"@math>
Resent-From: zsh-workers@math.gatech.edu
X-Mailing-List: <zsh-workers@math.gatech.edu> archive/latest/90
X-Loop: zsh-workers@math.gatech.edu
Precedence: list
Resent-Sender: zsh-workers-request@math.gatech.edu

> In fact, the code is there already, #ifdef'd behind a test for
> CLOBBERS_TYPEAHEAD (actually, that was a bit of a giveaway).  This is
> one of the old buildzsh definitions that hasn't made it into configure
> yet.  The problem is that it's not that easy to test.  I've therefore
> just added an ad hoc test for Ultrix to configure.in.
> 
> By the way, there's another phantom preprocessor definition:
> TTY_NEEDS_DRAINING.  Someone, somewhere may find this coming back to
> haunt them.


I've looked through the configuration scripts for zsh 2.5.03 and it
defines CLOBBERS_TYPEAHEAD for ultrix and dgux.  It defines
TTY_NEEDS_DRAINING for ultrix.  People on these machines should check
whether either of these are needed.

What is the relationship/lineage between ultrix and dgux?

I've changed the patch around a little.  Test this and make sure it is
ok.

rc

*** configure.in	1995/05/23 03:50:13	1.23
--- configure.in	1995/06/08 18:36:36	1.25
***************
*** 414,419 ****
--- 414,433 ----
  done
  AC_DEFINE_UNQUOTED(WTMP_FILE_CONFIG, "$wtmp_file")
  AC_MSG_RESULT($wtmp_file)
+ 
+ dnl Some systems clobber typeahead when you go from canonical input
+ dnl processing to non-canonical, so we need a FIONREAD ioctl.
+ dnl I don't know how to check this with configure, so I am using the
+ dnl system names directly.
+ dnl The doubled square brackets are necessary because autoconf uses m4.
+ AC_MSG_CHECKING(if typeahead needs FIONREAD)
+ AC_CACHE_VAL(zsh_cv_clobbers_typeahead,
+ [test `echo $host_os | sed 's/^\([[a-z]]*\).*/\1/'` = ultrix &&
+ zsh_cv_clobbers_typeahead=yes || zsh_cv_clobbers_typeahead=no])
+ AC_MSG_RESULT($zsh_cv_clobbers_typeahead)
+ if test $zsh_cv_clobbers_typeahead = yes; then
+   AC_DEFINE(CLOBBERS_TYPEAHEAD)
+ fi
  
  AC_OUTPUT(Makefile Src/Makefile Doc/Makefile Etc/Makefile Misc/Makefile \
  Util/Makefile Functions/Makefile Startup_Files/Makefile, \

