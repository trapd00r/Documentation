From zsh-workers-return-10005-mason-zsh=primenet.com.au@sunsite.auc.dk Wed Mar 08 07:30:59 2000
Return-Path: <zsh-workers-return-10005-mason-zsh=primenet.com.au@sunsite.auc.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 3486 invoked from network); 8 Mar 2000 07:30:58 -0000
Received: from sunsite.auc.dk (130.225.51.30)
  by ns1.primenet.com.au with SMTP; 8 Mar 2000 07:30:58 -0000
Received: (qmail 12728 invoked by alias); 8 Mar 2000 07:30:45 -0000
Mailing-List: contact zsh-workers-help@sunsite.auc.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.auc.dk
X-Seq: 10005
Received: (qmail 12698 invoked from network); 8 Mar 2000 07:30:43 -0000
From: "Bart Schaefer" <schaefer@candle.brasslantern.com>
Message-Id: <1000308073038.ZM8573@candle.brasslantern.com>
Date: Wed, 8 Mar 2000 07:30:38 +0000
In-Reply-To: <slrn8buads.pqj.mason@coral.primenet.com.au>
Comments: In reply to mason@primenet.com.au (Geoff Wing)
        "Re: Preliminary release of 3.0.8 - please test" (Mar  3,  2:55am)
References: <slrn8bn840.2ac.mason@coral.primenet.com.au> 
	<1000229161839.ZM29768@candle.brasslantern.com> 
	<slrn8buads.pqj.mason@coral.primenet.com.au>
X-Mailer: Z-Mail (5.0.0 30July97)
To: zsh-workers@sunsite.auc.dk
Subject: Bogus "no such job" (Re: Preliminary release of 3.0.8 - please test)
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii

On Mar 3,  2:55am, Geoff Wing wrote:
} Subject: Re: Preliminary release of 3.0.8 - please test
}
} Bart Schaefer <schaefer@candle.brasslantern.com> typed:
} :On Feb 29, 10:33am, Geoff Wing wrote:
} :} Subject: Re: Preliminary release of 3.0.8 - please test
} :} After some initial usage, got it into a state of:
} :} % %
} :} fg: no such job: 3
} :} % %%
} :} fg: no such job: 3
} :} % fg
} :} fg: no current job
} :} % jobs
} :} %
} :Hrm.  The job handling code is now identical to 3.1.6-dev-19, so if you
} :can get 3.0.8 into that state theres a problem for 3.1.6 as well.
} 
} I'm thinking that getjob() may need a setcurjob() before it checks curjob.

Since Sven has been incommunicado for a couple of days, I tried to look
into this myself in more detail.  The only two places where getjob() is
called are from bin_kill(), and from bin_fg() *after* the setcurjob()
that you noted.

I can believe that a race condition might cause "no such job: 3" once,
but twice in a row is impossible.  So the only possible answer is that
the one and only job has STAT_NOPRINT set but *not* STAT_SUBJOB, which
in turn happens only at exec.c:768 and 806 (in 3.0.8; in 3.1.6-dev-19,
exec.c:993 and 1031), both in execpline().  See jobs.c:setprevjob(),
which is called from setcurjob().

Now, it may be that the right solution is to have setprevjob() ignore
jobs that have STAT_NOPRINT set, but I wouldn't want that to mask some
more serious job-state problem.  If you have any insights, share 'em.

-- 
Bart Schaefer                                 Brass Lantern Enterprises
http://www.well.com/user/barts              http://www.brasslantern.com

