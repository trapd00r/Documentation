From zsh-users-return-14899-mason-zsh=primenet.com.au@zsh.org Fri Feb 26 15:07:55 2010
Return-Path: <zsh-users-return-14899-mason-zsh=primenet.com.au@zsh.org>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 1320 invoked by alias); 26 Feb 2010 15:07:55 -0000
Mailing-List: contact zsh-users-help@zsh.org; run by ezmlm
Precedence: bulk
X-No-Archive: yes
List-Id: Zsh Users List <zsh-users.zsh.org>
List-Post: <mailto:zsh-users@zsh.org>
List-Help: <mailto:zsh-users-help@zsh.org>
Delivered-To: mailing list zsh-users@zsh.org
X-Seq: 14899
Received: (qmail 27443 invoked from network); 26 Feb 2010 15:07:52 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received-SPF: none (ns1.primenet.com.au: domain at vinc17.org does not designate permitted sender hosts)
Date: Fri, 26 Feb 2010 16:07:49 +0100
From: Vincent Lefevre <vincent@vinc17.org>
To: zsh-users@zsh.org
Subject: Re: segfault in strftime
Message-ID: <20100226150748.GE13766@prunille.vinc17.org>
Mail-Followup-To: zsh-users@zsh.org
References: <A73C7D9C-66C5-4BFA-8FB3-8560FE65B529@biskalar.de>
 <20100226125256.GC13766@prunille.vinc17.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=iso-8859-1
Content-Disposition: inline
Content-Transfer-Encoding: 8bit
In-Reply-To: <20100226125256.GC13766@prunille.vinc17.org>
X-Mailer-Info: http://www.vinc17.org/mutt/
User-Agent: Mutt/1.5.20-6045-vl-r30587 (2010-02-23)

On 2010-02-26 13:52:56 +0100, Vincent Lefevre wrote:
> Also, it seems to have a problem with -1:
> 
> Under Mac OS X:
> 
> $ strftime "%a %d.%m.%Y %H:%M:%S" -2
> Thu 01.01.1970 00:59:58
> $ strftime "%a %d.%m.%Y %H:%M:%S" -1
> strftime: -1: unknown error: 0
> 
> Under Linux/x86_64 (Debian/unstable):
> 
> $ strftime "%a %d.%m.%Y %H:%M:%S" -2
> Thu 01.01.1970 00:59:58
> $ strftime "%a %d.%m.%Y %H:%M:%S" -1
> strftime: -1: success

Concerning this one:

    secs = (time_t)strtoul(argv[1], &endptr, 10);
    if (secs == (time_t)ULONG_MAX) {
        zwarnnam(nam, "%s: %e", argv[1], errno);
        return 1;
    } else if (*endptr != '\0') {
        zwarnnam(nam, "%s: invalid decimal number", argv[1]);
        return 1;
    }

ULONG_MAX is not necessarily an error! You need to check errno.
The C99 standard says:

  The strtol, strtoll, strtoul, and strtoull functions return the
  converted value, if any. If no conversion could be performed, zero
  is returned. If the correct value is outside the range of
  representable values, LONG_MIN, LONG_MAX, LLONG_MIN, LLONG_MAX,
  ULONG_MAX, or ULLONG_MAX is returned (according to the return type
  and sign of the value, if any), and the value of the macro ERANGE
  is stored in errno.

-- 
Vincent Lefèvre <vincent@vinc17.net> - Web: <http://www.vinc17.net/>
100% accessible validated (X)HTML - Blog: <http://www.vinc17.net/blog/>
Work: CR INRIA - computer arithmetic / Arénaire project (LIP, ENS-Lyon)

