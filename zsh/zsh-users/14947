From zsh-users-return-14947-mason-zsh=primenet.com.au@zsh.org Sat Mar 20 17:50:49 2010
Return-Path: <zsh-users-return-14947-mason-zsh=primenet.com.au@zsh.org>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 1936 invoked by alias); 20 Mar 2010 17:50:49 -0000
Mailing-List: contact zsh-users-help@zsh.org; run by ezmlm
Precedence: bulk
X-No-Archive: yes
List-Id: Zsh Users List <zsh-users.zsh.org>
List-Post: <mailto:zsh-users@zsh.org>
List-Help: <mailto:zsh-users-help@zsh.org>
Delivered-To: mailing list zsh-users@zsh.org
X-Seq: 14947
Received: (qmail 27338 invoked from network); 20 Mar 2010 17:50:47 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received-SPF: none (ns1.primenet.com.au: domain at closedmail.com does not designate permitted sender hosts)
From: Bart Schaefer <schaefer@brasslantern.com>
Message-id: <100320105027.ZM20067@torch.brasslantern.com>
Date: Sat, 20 Mar 2010 10:50:27 -0700
In-reply-to: <20100315164237.GA23224@fermat.math.technion.ac.il>
Comments: In reply to "Nadav Har'El" <nyh@math.technion.ac.il>
 "Re: Append cancelled commands to history" (Mar 15,  6:42pm)
References: <c16a574a0809181450t61a5b5ddq2e80797fde37636e@mail.gmail.com>
	<20080919162045.GA22435@ruderich.org>
	<20090706151644.6BF508027106@bifrost.dotsrc.org>
	<20090706154309.GA15663@fermat.math.technion.ac.il>
	<20090706155337.GB15663@fermat.math.technion.ac.il>
	<20100315164237.GA23224@fermat.math.technion.ac.il>
X-Mailer: OpenZMail Classic (0.9.2 24April2005)
To: zsh-users@zsh.org
Subject: Re: Append cancelled commands to history
MIME-version: 1.0
Content-type: text/plain; charset=us-ascii

On Mar 15,  6:42pm, Nadav Har'El wrote:
>
> Does anyone know why zsh saves interrupted partial multiline commands,
> but without their last line?

Every time a new prompt is printed -- even if it's the PS2 prompt rather
than the top-level prompt -- is a new "instance" of the line editor.
Looked at another way, as soon as you hit "enter" (accept-line) the
current $BUFFER is stored in the "pending history".  You can't yet
scroll back to it from the following PS2 prompt, but it has been
remembered as something you input and might want to revisit later.

Conversely, if you hit the interrupt key or ctrl-g (send-break), the
current buffer has not been stored and ZLE presumes that interruption
means you DON'T want to revisit this later.  You can subvert the latter
behavior, but because a new ZLE instance started at accept-line, it's
already too late to subvert the former.

> Can this be avoided? And what was the rationale to save the beginning
> of a multiline command and not everything - or not at all for a single
> line command?

There's a reason the widget is called "accept-line".  If the line has
been accepted (even if it doesn't form a complete command yet), it's
something you want; if you "send-break" or do an interrupt, it's not
accepted and therefore something you don't want.

> I thought this would be simple - just replace the print line with
> 	print -s -r -- "$PREBUFFER$BUFFER"

Hmm.  When I use TRAPINT, $PREBUFFER is always empty.

torch% print $ZSH_VERSION $ZSH_PATCHLEVEL 
4.3.10-dev-1 1.4940

