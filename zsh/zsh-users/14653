From zsh-users-return-14653-mason-zsh=primenet.com.au@zsh.org Wed Dec 16 15:59:50 2009
Return-Path: <zsh-users-return-14653-mason-zsh=primenet.com.au@zsh.org>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 27096 invoked by alias); 16 Dec 2009 15:59:50 -0000
Mailing-List: contact zsh-users-help@zsh.org; run by ezmlm
Precedence: bulk
X-No-Archive: yes
List-Id: Zsh Users List <zsh-users.zsh.org>
List-Post: <mailto:zsh-users@zsh.org>
List-Help: <mailto:zsh-users-help@zsh.org>
Delivered-To: mailing list zsh-users@zsh.org
X-Seq: 14653
Received: (qmail 26539 invoked from network); 16 Dec 2009 15:59:38 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=BAYES_00,HTML_MESSAGE
	autolearn=ham version=3.2.5
Received-SPF: pass (ns1.primenet.com.au: SPF record at _spf.google.com designates 209.85.222.174 as permitted sender)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=gamma;
        h=domainkey-signature:mime-version:received:in-reply-to:references
         :date:message-id:subject:from:to:cc:content-type;
        bh=DPNOpfnwPaNE/zV8O+0PSdQWar+BEZ1timh9mAmdamU=;
        b=xI0WYHqxqRfBxY8JXmg3a7O/6FesNPRLmDXVSGccITCzrS6qOphYbNU1/bTlvrf0OD
         Y+JsMUsLbfczvywZhjkX928XW6p159PYOQJwBfToITXLKL8buys98VGdhJA5vgBadqAY
         0i65EcNsv+rjSu7IzJLVNuiJ8oegAUC0nOVxM=
DomainKey-Signature: a=rsa-sha1; c=nofws;
        d=gmail.com; s=gamma;
        h=mime-version:in-reply-to:references:date:message-id:subject:from:to
         :cc:content-type;
        b=bL8ed6RQLlUbjrn2f4j5aKBelb8icsQs8r/Df5Wh4cgTeZk1Sqnt/0hGmalm0uccsh
         qIHRKm/CxqTG2eihzyDjZJaCosb0vWxK2YiGP2hfD0cQ3EGbtO/qKUgUXbcfnCAwbmOX
         VVOfuBpgt9sU4NjzpF1wtCmnFBq6pRI9iKFdY=
MIME-Version: 1.0
In-Reply-To: <1260800369.32429.1350005931@webmail.messagingengine.com>
References: <1260800369.32429.1350005931@webmail.messagingengine.com>
Date: Wed, 16 Dec 2009 07:54:08 -0800
Message-ID: <733654e30912160754q5e505cabo4a2510b41bf1d892@mail.gmail.com>
Subject: Re: Unable to read history on latest Cygwin
From: Wayne Davison <4wayned@gmail.com>
To: Thorsten Kampe <thorsten@thorstenkampe.de>
Cc: zsh-users@zsh.org
Content-Type: multipart/alternative; boundary=000e0cd13a725b0610047ada84af

--000e0cd13a725b0610047ada84af
Content-Type: text/plain; charset=UTF-8

On Mon, Dec 14, 2009 at 6:19 AM, Thorsten Kampe
<thorsten@thorstenkampe.de>wrote:

> The result of that is that I'm not able to run zsh "portable" from a
> FAT32 USB thumb drive: "zsh: failed to create hard link as lock file
> /home/thorsten/.zhistory.LOCK: operation not permitted".
>

One simple possibility is to change the two #ifdef HAVE_LINK lines in hist.c
to this:

#if defined HAVE_LINK && !defined __CYGWIN__

That should make it use the open with O_EXCL, which is hopefully atomic.

As for Peter's idea of using a symlink, do you know if the cygwin folks
mention if their emulation of a symlink is an atomic operation?  We could
completely get rid of the temp file (used in the hard-link code) and just
create a symlink named for the lock file, pointing at (essentially)
$PID/$HOST (since it doesn't matter if the link is valid, just that it
exists).  According to various web docs, symlinks are atomic on NFS, so that
might be a good thing to use in general (replacing the use of link()).

..wayne..

--000e0cd13a725b0610047ada84af--

