From zsh-users-return-4678-mason-zsh=primenet.com.au@sunsite.dk Sat Feb 16 09:29:24 2002
Return-Path: <zsh-users-return-4678-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 28219 invoked from network); 16 Feb 2002 09:29:24 -0000
Received: from sunsite.dk (130.225.247.90)
  by ns1.primenet.com.au with SMTP; 16 Feb 2002 09:29:24 -0000
Received: (qmail 2065 invoked by alias); 16 Feb 2002 09:29:02 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 4678
Received: (qmail 2041 invoked from network); 16 Feb 2002 09:28:56 -0000
Date: Sat, 16 Feb 2002 01:28:25 -0800 (PST)
From: Wayne Davison <wayned@users.sourceforge.net>
X-X-Sender:  <wayne@phong.blorf.net>
To: Adam Spiers <adam@spiers.net>
Cc: zsh users mailing list <zsh-users@sunsite.auc.dk>
Subject: Re: vanishing history
In-Reply-To: <20011128161905.A9726@corelli.new.ox.ac.uk>
Message-ID: <Pine.LNX.4.33L2.0202160123440.1473-100000@phong.blorf.net>
MIME-Version: 1.0
Content-Type: TEXT/PLAIN; charset=US-ASCII

On Wed, 28 Nov 2001, Adam Spiers wrote:
> Does anyone have any idea why my .zshhistory occasionally looses the
> vast majority of its contents?  I can't reproduce it, so I can't begin
> to track down what's going on.

I've seen this from time to time, but also have been unable to reproduce
it.  In pouring over the code I did finally see one potential way that
the loss of contents could happen: if the history file is locked by
another process while we're trying to rewrite it.  Here's the fix (which
causes us to just punt on the rewrite if we read nothing):

Index: Src/hist.c
--- Src/hist.c	16 Feb 2002 09:15:07 -0000	1.39
+++ Src/hist.c	16 Feb 2002 09:21:16 -0000
@@ -2083,7 +2083,8 @@
 	    hist_ignore_all_dups |= isset(HISTSAVENODUPS);
 	    readhistfile(fn, err, 0);
 	    hist_ignore_all_dups = isset(HISTIGNOREALLDUPS);
-	    savehistfile(fn, err, 0);
+	    if (histlinect)
+		savehistfile(fn, err, 0);
 	    deletehashtable(histtab);

 	    curhist = remember_curhist;

..wayne..

