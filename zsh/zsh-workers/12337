From zsh-workers-return-12337-mason-zsh=primenet.com.au@sunsite.auc.dk Fri Jul 21 07:49:20 2000
Return-Path: <zsh-workers-return-12337-mason-zsh=primenet.com.au@sunsite.auc.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 8269 invoked from network); 21 Jul 2000 07:49:18 -0000
Received: from sunsite.auc.dk (130.225.51.30)
  by ns1.primenet.com.au with SMTP; 21 Jul 2000 07:49:18 -0000
Received: (qmail 4976 invoked by alias); 21 Jul 2000 07:49:11 -0000
Mailing-List: contact zsh-workers-help@sunsite.auc.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.auc.dk
X-Seq: 12337
Received: (qmail 4969 invoked from network); 21 Jul 2000 07:49:10 -0000
Date: Fri, 21 Jul 2000 09:49:09 +0200 (MET DST)
Message-Id: <200007210749.JAA13854@beta.informatik.hu-berlin.de>
From: Sven Wischnowsky <wischnow@informatik.hu-berlin.de>
To: zsh-workers@sunsite.auc.dk
In-reply-to: mason@primenet.com.au's message of 21 Jul 2000 01:07:07 GMT
Subject: PATCH: Re: Couple of bugs in 3.1.9-dev-3


Geoff Wing wrote:

> coral% zsh-3.1.9-dev-3 -f
> % time | time
> unknown word code in gettext2()
> unknown word code in gettext2()
> unknown word code in gettext2()
> unknown word code in gettext2()
> unknown word code in gettext2()
> % time | echo
> zsh: 14281 segmentation fault (core dumped)  zsh -f
> coral% zsh-3.1.9-dev-3 -f
> % time | time; echo
> zsh: 14281 segmentation fault (core dumped)  zsh -f

Uh, oh. Wrong parsing of `time' withoout a command to measure.

Bye
 Sven

Index: Src/parse.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/parse.c,v
retrieving revision 1.11
diff -u -r1.11 parse.c
--- Src/parse.c	2000/07/19 20:40:18	1.11
+++ Src/parse.c	2000/07/21 07:48:40
@@ -1389,9 +1389,13 @@
 
     p = ecadd(0);
     ecadd(0);
-    f = par_sublist2(&c);
-    ecbuf[p] = WCB_TIMED((p + 1 == ecused) ? WC_TIMED_EMPTY : WC_TIMED_PIPE);
-    set_sublist_code(p + 1, WC_SUBLIST_END, f, ecused - 2 - p, c);
+    if ((f = par_sublist2(&c)) < 0) {
+	ecused--;
+	ecbuf[p] = WCB_TIMED(WC_TIMED_EMPTY);
+    } else {
+	ecbuf[p] = WCB_TIMED(WC_TIMED_PIPE);
+	set_sublist_code(p + 1, WC_SUBLIST_END, f, ecused - 2 - p, c);
+    }
 }
 
 /*

--
Sven Wischnowsky                         wischnow@informatik.hu-berlin.de

