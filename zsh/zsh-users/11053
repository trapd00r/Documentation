From zsh-users-return-11053-mason-zsh=primenet.com.au@sunsite.dk Tue Dec 05 14:03:00 2006
Return-Path: <zsh-users-return-11053-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 10030 invoked from network); 5 Dec 2006 14:02:55 -0000
X-Spam-Checker-Version: SpamAssassin 3.1.7 (2006-10-05) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=BAYES_00,FORGED_RCVD_HELO 
	autolearn=ham version=3.1.7
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 5 Dec 2006 14:02:55 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 41724 invoked from network); 5 Dec 2006 14:02:44 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 5 Dec 2006 14:02:44 -0000
Received: (qmail 12486 invoked by alias); 5 Dec 2006 14:01:35 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 11053
Received: (qmail 11693 invoked from network); 5 Dec 2006 14:01:05 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 5 Dec 2006 14:01:05 -0000
Received: (qmail 34648 invoked from network); 5 Dec 2006 14:01:05 -0000
Received: from adsl-66-136-183-236.dsl.stlsmo.swbell.net (HELO mail.borho.org) (66.136.183.236)
  by a.mx.sunsite.dk with SMTP; 5 Dec 2006 14:01:01 -0000
Received: from localhost (localhost [127.0.0.1])
	by mail.borho.org (Postfix) with ESMTP id 2451A1A5A48
	for <zsh-users@sunsite.dk>; Tue,  5 Dec 2006 07:54:59 -0600 (CST)
X-Virus-Scanned: amavisd-new at borho.org
Received: from mail.borho.org ([127.0.0.1])
	by localhost (mail.borho.org [127.0.0.1]) (amavisd-new, port 10024)
	with ESMTP id phOHvQqfsgET for <zsh-users@sunsite.dk>;
	Tue,  5 Dec 2006 07:54:53 -0600 (CST)
Received: from mre (ppp-70-242-136-37.dsl.stlsmo.swbell.net [70.242.136.37])
	by mail.borho.org (Postfix) with ESMTP id ED2321A581C
	for <zsh-users@sunsite.dk>; Tue,  5 Dec 2006 07:54:52 -0600 (CST)
From: Steve Borho <steve@borho.org>
Organization: Ageia Technologies, Inc
To: Zsh Users <zsh-users@sunsite.dk>
Subject: passing partial command arguments to completion functions
Date: Tue, 5 Dec 2006 07:54:10 -0600
User-Agent: KMail/1.9.5
MIME-Version: 1.0
Content-Type: text/plain;
  charset="us-ascii"
Content-Transfer-Encoding: 7bit
Content-Disposition: inline
Message-Id: <200612050754.10233.steve@borho.org>

Hello everyone,

I have a nit I would like to fix in the Mercurial completion function, as seen 
here:

http://www.selenic.com/hg/log/adbf440a81e0/contrib/zsh_completion

The problem is in the way it completes files.  Most file completions are 
performed by asking mercurial for a list of files that we're interested in, 
then passing those files to _wanted.  Here's a snippit for how we complete 
hg add <TAB>

_hg_status() {
  status_files=(${(ps:\0:)"$(_hg_cmd status -0n$1 . 2>/dev/null)"})
}

_hg_unknown() {
  typeset -a status_files
  _hg_status u
  _wanted files expl 'unknown files' _multi_parts / status_files
}

_hg_cmd_add() {
  _arguments -s -w : $_hg_global_opts $_hg_pat_opts $_hg_dryrun_opts \
  '*:unknown files:_hg_unknown'
}


This will ask mercurial for the list of unknown files in the current directory 
`hg status -0nu .` and pass those to _wanted.  This works for most normal 
cases.  Where it falls down is when you're completing a relative path like 
this:

hg add ../foo/bar<TAB>

I need to be able to pass the partial path to hg status, but this is one notch 
above my current belt level :)   Can anyone give me some hints, or point me 
at some completion functions which do something similar?

-- 
Steve Borho (steve@borho.org)

