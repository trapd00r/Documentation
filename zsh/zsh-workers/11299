From zsh-workers-return-11299-mason-zsh=primenet.com.au@sunsite.auc.dk Wed May 10 13:06:13 2000
Return-Path: <zsh-workers-return-11299-mason-zsh=primenet.com.au@sunsite.auc.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 6969 invoked from network); 10 May 2000 13:06:12 -0000
Received: from sunsite.auc.dk (130.225.51.30)
  by ns1.primenet.com.au with SMTP; 10 May 2000 13:06:12 -0000
Received: (qmail 2341 invoked by alias); 10 May 2000 13:05:55 -0000
Mailing-List: contact zsh-workers-help@sunsite.auc.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.auc.dk
X-Seq: 11299
Received: (qmail 2330 invoked from network); 10 May 2000 13:05:55 -0000
Date: Wed, 10 May 2000 14:05:25 +0100
From: Peter Stephenson <pws@cambridgesiliconradio.com>
Subject: PATCH: edit-command-line
To: zsh-workers@sunsite.auc.dk (Zsh hackers list)
Message-id: <0FUC00L2BHP1Y5@la-la.cambridgesiliconradio.com>
Content-transfer-encoding: 7BIT

This adds a zle function for editing the command line using an ordinary
editor, based on what Bart suggested (except being me I rewrote it without
looking at that again).

I think the LBUFFER= and RBUFFER= are redundant, I put them there while I
was wondering why the display didn't appear properly after the function,
which is why I eventually added the `zle redisplay'.  The answer must be
that zle doesn't know that what was on the line already was removed by the
editor, so this is a perfectly resonable solution and I don't think there's
a problem.

As written, this doesn't execute the line edited.

Index: Functions/Zle/.distfiles
===================================================================
RCS file: /cvsroot/zsh/zsh/Functions/Zle/.distfiles,v
retrieving revision 1.1.1.3
diff -u -r1.1.1.3 .distfiles
--- Functions/Zle/.distfiles	1999/09/22 12:36:25	1.1.1.3
+++ Functions/Zle/.distfiles	2000/05/10 12:59:52
@@ -1,4 +1,4 @@
 DISTFILES_SRC='
-    .distfiles history-search-end incremental-complete-word
+    .distfiles history-search-end edit-command-line incremental-complete-word
     incarg insert-files predict-on
 '
Index: Functions/Zle/edit-command-line
===================================================================
RCS file: edit-command-line
diff -N edit-command-line
--- /dev/null	Tue May  5 13:32:27 1998
+++ edit-command-line	Wed May 10 05:59:52 2000
@@ -0,0 +1,18 @@
+# Edit the command line using your usual editor.
+# Binding this to 'v' in the vi command mode map,
+#   autoload edit-command-line
+#   zle -N edit-command-line
+#   bindkey -M vicmd v edit-command-line
+# will give ksh-like behaviour for that key.
+
+local tmpfile=${TMPPREFIX:-/tmp/zsh}ecl$$
+
+print $BUFFER >$tmpfile
+exec </dev/tty
+${VISUAL:-${EDITOR:-vi}} $tmpfile
+LBUFFER=
+RBUFFER=
+BUFFER=$(<$tmpfile)
+
+rm -f $tmpfile
+zle redisplay

-- 
Peter Stephenson <pws@cambridgesiliconradio.com>
Cambridge Silicon Radio, Unit 300, Science Park, Milton Road,
Cambridge, CB4 0XL, UK                          Tel: +44 (0)1223 392070

