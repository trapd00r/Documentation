From zsh-workers-return-26744-mason-zsh=primenet.com.au@sunsite.dk Mon Mar 16 18:22:35 2009
Return-Path: <zsh-workers-return-26744-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 29055 invoked from network); 16 Mar 2009 18:22:20 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-1.7 required=5.0 tests=AWL,BAYES_00,MISSING_HEADERS
	autolearn=no version=3.2.5
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 16 Mar 2009 18:22:20 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 80604 invoked from network); 16 Mar 2009 18:20:06 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 16 Mar 2009 18:20:06 -0000
Received: (qmail 16251 invoked by alias); 16 Mar 2009 18:20:00 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 26744
Received: (qmail 16221 invoked from network); 16 Mar 2009 18:19:59 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 16 Mar 2009 18:19:59 -0000
Received: from cluster-g.mailcontrol.com (cluster-g.mailcontrol.com [208.87.233.190])
	by bifrost.dotsrc.org (Postfix) with ESMTPS id 31E9980307F8
	for <zsh-workers@sunsite.dk>; Mon, 16 Mar 2009 19:19:44 +0100 (CET)
Received: from rly24g.srv.mailcontrol.com (localhost.localdomain [127.0.0.1])
	by rly24g.srv.mailcontrol.com (MailControl) with ESMTP id n2GIJTw2005715
	for <zsh-workers@sunsite.dk>; Mon, 16 Mar 2009 18:19:40 GMT
Received: from submission.mailcontrol.com (submission.mailcontrol.com [86.111.216.190])
	by rly24g.srv.mailcontrol.com (MailControl) id n2GIItNf001889
	for zsh-workers@sunsite.dk; Mon, 16 Mar 2009 18:18:55 GMT
Received: from cameurexb01.EUROPE.ROOT.PRI ([193.128.72.68])
	by rly24g-eth0.srv.mailcontrol.com (envelope-sender Peter.Stephenson@csr.com) (MIMEDefang) with ESMTP id n2GIIrMJ001533; Mon, 16 Mar 2009 18:18:55 +0000 (GMT)
Received: from news01 ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.3959);
	 Mon, 16 Mar 2009 18:18:52 +0000
Date: Mon, 16 Mar 2009 18:18:52 +0000
From: Peter Stephenson <pws@csr.com>
Cc: zsh-workers@sunsite.dk, 519535@bugs.debian.org
Subject: Re: Bug#519535: history expansion: modifier completion missing
Message-ID: <20090316181852.27e9420d@news01>
In-Reply-To: <20090315062253.GB14010@scru.org>
References: <20090313105555.GA19025@piper.oerlikon.madduck.net>
	<20090315062253.GB14010@scru.org>
Organization: CSR
X-Mailer: Claws Mail 3.5.0 (GTK+ 2.12.8; i386-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
X-OriginalArrivalTime: 16 Mar 2009 18:18:52.0771 (UTC) FILETIME=[A9373330:01C9A663]
X-Scanned-By: MailControl A_08_51_00 (www.mailcontrol.com) on 10.71.1.134
X-Virus-Scanned: ClamAV 0.92.1/9115/Mon Mar 16 14:30:44 2009 on bifrost
X-Virus-Status: Clean

On Sun, 15 Mar 2009 06:22:53 +0000
Clint Adams <schizo@debian.org> wrote:
> On Fri, Mar 13, 2009 at 11:55:55AM +0100, martin f krafft wrote:
> > I tried to show off zsh to a sceptic today and had to find out the
> > hard way that it does not (yet) provide completion for history
> > expansion modifiers, e.g.
> > 
> >   echo !$:<TAB>

I thought this was going to be harder than it turned out to be; as you can
see it's really quite simple, particularly since I already wrote modifer
completion and it would appear had the foresight to make it handle the
history case.

It's in _normal which is where we handle normal command arguments.  I think
this is both the first and last place where get to massage command line
arguments generically---we don't just want this in default completion since
history expansion, if active, trumps everything else.

It probably needs to go in _value for assignments; is right at the top the
appropriate place?  Or should it actually go higher, in _complete itself,
outside the "if" that decides whether it's _normal or otherwise?  I don't
think so, because that screws up vared.  Hmmm... I think that's true of
putting it in _value, which _in_vared uses.  Maybe leaving it discretely
alone might work well.

The rum thing is the way $PREFIX acquires quoted !'s.  I thought $PREFIX
was fairly raw, so you could handle special characters?  Obviously I'm
misremembering, because I traced the quoting to some completely general
code for all special characters.  Anyway, that has two effects:  first you
have to check $words, because that does have the raw form, and secondly you
have to update $PREFIX so that you get the raw !'s inserted into the
command line.  (But you don't usually have to do that even if you're
inserting special characters, do you?  You just need to make sure compadd
has the argument -Q, which it does here, except that's not good enough.
Baaaaaaa.)

I think -z $compstate[quote] ensures we're not already doing something
clever inside nested quotes, which would mean the expression couldn't be a
history expansion.  I think.

So it seems to work fine (possibly depending on your options and
completers---there are other things around that will do other things to
!'s), but I'm still a bit confused.

Index: Completion/Base/Core/_normal
===================================================================
RCS file: /cvsroot/zsh/zsh/Completion/Base/Core/_normal,v
retrieving revision 1.4
diff -u -r1.4 _normal
--- Completion/Base/Core/_normal	13 Mar 2002 09:28:05 -0000	1.4
+++ Completion/Base/Core/_normal	16 Mar 2009 18:05:48 -0000
@@ -9,6 +9,19 @@
   _compskip=''
 fi
 
+# Check for a history reference to complete modifiers.
+# $PREFIX has a quoted form of the !, so we can't test that
+# (it might the start of a real argument), but words has the
+# raw McCoy.
+if [[ -o BANG_HIST && $words[CURRENT] = \!*: && -z $compstate[quote] ]]; then
+  # This looks like a real history expansion; in that case
+  # we'd better put the !'s back the way pfalstad intended.
+  PREFIX=${PREFIX//\\!/!}
+  compset -P '*:'
+  _history_modifiers h
+  return
+fi
+
 # Completing in command position?
 
 if [[ CURRENT -eq 1 ]]; then


