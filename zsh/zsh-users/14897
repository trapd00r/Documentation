From zsh-users-return-14897-mason-zsh=primenet.com.au@zsh.org Fri Feb 26 14:17:34 2010
Return-Path: <zsh-users-return-14897-mason-zsh=primenet.com.au@zsh.org>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 12701 invoked by alias); 26 Feb 2010 14:17:34 -0000
Mailing-List: contact zsh-users-help@zsh.org; run by ezmlm
Precedence: bulk
X-No-Archive: yes
List-Id: Zsh Users List <zsh-users.zsh.org>
List-Post: <mailto:zsh-users@zsh.org>
List-Help: <mailto:zsh-users-help@zsh.org>
Delivered-To: mailing list zsh-users@zsh.org
X-Seq: 14897
Received: (qmail 25326 invoked from network); 26 Feb 2010 14:17:23 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-3.0 required=5.0 tests=AWL,BAYES_00,
	RCVD_IN_DNSWL_LOW,SPF_HELO_PASS autolearn=ham version=3.2.5
Received-SPF: none (ns1.primenet.com.au: domain at csr.com does not designate permitted sender hosts)
Date: Fri, 26 Feb 2010 14:17:15 +0000
From: Peter Stephenson <pws@csr.com>
To: zsh-users@zsh.org
Subject: Re: segfault in strftime
Message-ID: <20100226141715.44468996@news01>
In-Reply-To: <2A337AAE-8D40-4796-A733-9E7F30FABFF8@biskalar.de>
References: <A73C7D9C-66C5-4BFA-8FB3-8560FE65B529@biskalar.de>
	<201002261303.o1QD3Sqq018901@news01.csr.com>
	<2A337AAE-8D40-4796-A733-9E7F30FABFF8@biskalar.de>
Organization: CSR
X-Mailer: Claws Mail 3.5.0 (GTK+ 2.12.8; i386-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: quoted-printable
X-OriginalArrivalTime: 26 Feb 2010 14:17:15.0900 (UTC) FILETIME=[65BF7BC0:01CAB6EE]
X-Scanned-By: MailControl A-09-22-10 (www.mailcontrol.com) on 10.71.0.124

On Fri, 26 Feb 2010 14:59:09 +0100
Sebastian Stark <seb-zsh@biskalar.de> wrote:
> I'm not used to produce or read backtraces, is the following helpful?

That's very interesting, thank you.

> Does it mean the problem is my libc?

No...

> #1  0x000000000049bb54 in ztrftime (buf=3D0x6feed0 "\001J!=CE=A7+", bufsi=
ze=3D158, fmt=3D0x2ba7cd751832 " %d.%m.%Y %H:%M:%S", tm=3D0x0)
                    ^^^^^^
>     at utils.c:2603

This is the interesting bit.  localtime() dectected a value it couldn't
convert to a structure and returned NULL.  It's allowed to do that if it
didn't like the value passed, though I'm not sure why it wouldn't.  It
seems not all time_t's can be converted to times, a fact I was hitherto
unaware of.

Index: Src/Modules/datetime.c
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D
RCS file: /cvsroot/zsh/zsh/Src/Modules/datetime.c,v
retrieving revision 1.18
diff -p -u -r1.18 datetime.c
--- Src/Modules/datetime.c	9 Dec 2007 14:58:36 -0000	1.18
+++ Src/Modules/datetime.c	26 Feb 2010 14:08:55 -0000
@@ -121,6 +121,10 @@ bin_strftime(char *nam, char **argv, Opt
     }
=20
     t =3D localtime(&secs);
+    if (!t) {
+	zwarnnam(nam, "%s: unable to convert to time", argv[1]);
+	return 1;
+    }
     bufsize =3D strlen(argv[0]) * 8;
     buffer =3D zalloc(bufsize);
=20

--=20
Peter Stephenson <pws@csr.com>            Software Engineer
Tel: +44 (0)1223 692070                   Cambridge Silicon Radio Limited
Churchill House, Cambridge Business Park, Cowley Road, Cambridge, CB4 0WZ, =
UK


Member of the CSR plc group of companies. CSR plc registered in England and=
 Wales, registered number 4187346, registered office Churchill House, Cambr=
idge Business Park, Cowley Road, Cambridge, CB4 0WZ, United Kingdom

