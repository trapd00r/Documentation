From zsh-users-return-8863-mason-zsh=primenet.com.au@sunsite.dk Wed May 18 10:28:07 2005
Return-Path: <zsh-users-return-8863-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 29421 invoked from network); 18 May 2005 10:28:06 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 18 May 2005 10:28:06 -0000
Received: (qmail 34442 invoked from network); 18 May 2005 10:28:01 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 18 May 2005 10:28:01 -0000
Received: (qmail 15988 invoked by alias); 18 May 2005 10:27:52 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 8863
Received: (qmail 15979 invoked from network); 18 May 2005 10:27:52 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 18 May 2005 10:27:52 -0000
Received: (qmail 33351 invoked from network); 18 May 2005 10:27:52 -0000
Received: from mailhost1.csr.com (HELO MAILSWEEPER01.csr.com) (81.105.217.43)
  by a.mx.sunsite.dk with SMTP; 18 May 2005 10:27:40 -0000
Received: from exchange03.csr.com (unverified [10.100.137.60]) by MAILSWEEPER01.csr.com
 (Content Technologies SMTPRS 4.3.12) with ESMTP id <T70fbf632360a6c8d01618@MAILSWEEPER01.csr.com> for <zsh-users@sunsite.dk>;
 Wed, 18 May 2005 11:25:53 +0100
Received: from news01.csr.com ([10.103.143.38]) by exchange03.csr.com with Microsoft SMTPSVC(5.0.2195.6713);
	 Wed, 18 May 2005 11:29:04 +0100
Received: from news01.csr.com (localhost.localdomain [127.0.0.1])
	by news01.csr.com (8.13.1/8.12.11) with ESMTP id j4IARdLW003304
	for <zsh-users@sunsite.dk>; Wed, 18 May 2005 11:27:39 +0100
Received: from csr.com (pws@localhost)
	by news01.csr.com (8.13.1/8.13.1/Submit) with ESMTP id j4IARchB003301
	for <zsh-users@sunsite.dk>; Wed, 18 May 2005 11:27:39 +0100
Message-Id: <200505181027.j4IARchB003301@news01.csr.com>
X-Authentication-Warning: news01.csr.com: pws owned process doing -bs
To: Zsh User <zsh-users@sunsite.dk>
Subject: PATCH: Re: which-command help 
In-reply-to: <200505171555.j4HFtUOb012962@news01.csr.com> 
References: <20050517132000.GB9627@let.rug.nl> <200505171447.j4HElTUj011344@news01.csr.com> <1050517153211.ZM27474@candle.brasslantern.com> <200505171555.j4HFtUOb012962@news01.csr.com>
Date: Wed, 18 May 2005 11:27:38 +0100
From: Peter Stephenson <pws@csr.com>
X-OriginalArrivalTime: 18 May 2005 10:29:04.0328 (UTC) FILETIME=[6A19A480:01C55B94]
X-Spam-Checker-Version: SpamAssassin 3.0.2 on a.mx.sunsite.dk
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=6.0 tests=AWL,BAYES_00 autolearn=ham 
	version=3.0.2
X-Spam-Hits: -2.6

Latest version of the which-command widget.  Added a style to give the
`whence' variant.  Also fixed up the correct behaviour in the case of
some abstruse aliases:  for example, after 'alias \ls=ls', you might get
something like

% \ls<Esc-?>
\ls: aliased to ls
ls: aliased to ls --color=tty
ls () {
        local ls
        if [[ -n $LS_COLORS ]]
        then
                ls=(ls --color=auto)
        else
                ls=(ls -F)
        fi
        command $ls $*
}

(The remainder is an example of what happens when your distributed
initialisation scripts are over-clever...)

"whence -c" might not be the best default for the type command seeing
that functions can be arbitrarily long.

You should be able to use this with any recent zsh by taking the second
hunk and stripping off the initial +'s.

[I meant to send this yesterday but didn't hit C-c C-c for some
reason... I hope I haven't forgotten something...]

Index: Doc/Zsh/contrib.yo
===================================================================
RCS file: /cvsroot/zsh/zsh/Doc/Zsh/contrib.yo,v
retrieving revision 1.41
diff -u -r1.41 contrib.yo
--- Doc/Zsh/contrib.yo	21 Feb 2005 14:40:35 -0000	1.41
+++ Doc/Zsh/contrib.yo	17 May 2005 18:04:24 -0000
@@ -858,6 +858,18 @@
 zstyle :insert-last-assignment match '[[:alpha:]][][[:alnum:]]#=*'
 bindkey '\e=' insert-last-assignment)
 )
+tindex(which-command)
+item(tt(which-command))(
+This function is a drop-in replacement for the builtin widget
+tt(which-command).  It has enhanced behaviour, in that it correctly
+detects whether or not the command word needs to be expanded as an
+alias; if so, it continues tracing the command word from the expanded
+alias until it reaches the command that will be executed.
+
+The style tt(whence) is available in the context tt(:zle:$WIDGET); this
+may be set to an array to give the command and options that will be used to
+investigate the command word found.  The default is tt(whence -c).
+)
 enditem()
 
 subsect(Styles)
Index: Functions/Zle/which-command
===================================================================
RCS file: Functions/Zle/which-command
diff -N Functions/Zle/which-command
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ Functions/Zle/which-command	17 May 2005 18:04:24 -0000
@@ -0,0 +1,42 @@
+zmodload -i zsh/parameter zsh/zutil
+
+zle -I
+
+local -a whencecmd wds
+
+# Set the whence style to your favourite function
+# (but NOT which-command!)
+zstyle -a :zle:$WIDGET whence whencecmd || whencecmd=(whence -c --)
+
+wds=(${(z)LBUFFER})
+local wd barewd
+local -A seen
+
+while true; do
+  wd=${wds[1]}
+  barewd=${(Q)wd}
+
+  if [[ $barewd != $wd || -n $seen[$barewd] ]]; then
+    # quoted or already expanded, see if original word is an alias...
+    if [[ -z $seen[$barewd] && -n $aliases[$wd] ]]; then
+      # yes, so we need to decode that, with no extra expansion...
+      $whencecmd $wd
+      seen[$wd]=1
+      wds=(${(z)aliases[$wd]})
+      continue
+    else
+      # use unquoted word, don't expand alias
+      (unalias -- $barewd 2>/dev/null; $whencecmd $barewd)
+    fi
+  else
+    # turn on globsubst for =ls etc.
+    $whencecmd ${~barewd}
+    if [[ -n $aliases[$barewd] && -z $seen[$barewd] ]]; then
+      # Recursively expand aliases
+      seen[$barewd]=1
+      wds=(${(z)aliases[$barewd]})
+      continue
+    fi
+  fi
+  break
+done

-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070


**********************************************************************
This email and any files transmitted with it are confidential and
intended solely for the use of the individual or entity to whom they
are addressed. If you have received this email in error please notify
the system manager.

**********************************************************************

