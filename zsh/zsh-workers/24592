From zsh-workers-return-24592-mason-zsh=primenet.com.au@sunsite.dk Tue Feb 26 14:17:16 2008
Return-Path: <zsh-workers-return-24592-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 5140 invoked from network); 26 Feb 2008 14:17:13 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.4 (2008-01-01) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.4 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.4
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 26 Feb 2008 14:17:13 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 19190 invoked from network); 26 Feb 2008 14:17:06 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 26 Feb 2008 14:17:06 -0000
Received: (qmail 18186 invoked by alias); 26 Feb 2008 14:17:02 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 24592
Received: (qmail 18164 invoked from network); 26 Feb 2008 14:17:01 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 26 Feb 2008 14:17:01 -0000
Received: from cluster-g.mailcontrol.com (cluster-g.mailcontrol.com [85.115.41.190])
	by bifrost.dotsrc.org (Postfix) with ESMTP id BC8128026E0B
	for <zsh-workers@sunsite.dk>; Tue, 26 Feb 2008 15:16:56 +0100 (CET)
Received: from rly02g.srv.mailcontrol.com (localhost.localdomain [127.0.0.1])
	by rly02g.srv.mailcontrol.com (MailControl) with ESMTP id m1QEGPqC030722
	for <zsh-workers@sunsite.dk>; Tue, 26 Feb 2008 14:16:45 GMT
Received: from submission.mailcontrol.com (submission.mailcontrol.com [86.111.216.190])
	by rly02g.srv.mailcontrol.com (MailControl) id m1QEFXrV027767
	for zsh-workers@sunsite.dk; Tue, 26 Feb 2008 14:15:33 GMT
Received: from cameurexb01.EUROPE.ROOT.PRI ([62.189.241.200])
	by rly02g-eth0.srv.mailcontrol.com (envelope-sender Peter.Stephenson@csr.com) (MIMEDefang) with ESMTP id m1QEC6KG016328; Tue, 26 Feb 2008 14:15:33 +0000 (GMT)
Received: from news01 ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.3959);
	 Tue, 26 Feb 2008 14:14:59 +0000
Date: Tue, 26 Feb 2008 14:14:59 +0000
From: Peter Stephenson <pws@csr.com>
To: Dagobert Michelsen <dam@blastwave.org>
Cc: zsh-workers@sunsite.dk
Subject: Re: Failed tests of zsh 4.3.5 in Solaris 10 w/Sun Studio 12 CC
Message-ID: <20080226141459.76dc362c@news01>
In-Reply-To: <8AABEECB-A9A6-43EA-BED2-4BE376CBE349@blastwave.org>
References: <8AABEECB-A9A6-43EA-BED2-4BE376CBE349@blastwave.org>
Organization: CSR
X-Mailer: Claws Mail 3.3.0 (GTK+ 2.12.5; i386-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
X-OriginalArrivalTime: 26 Feb 2008 14:14:59.0221 (UTC) FILETIME=[F850AC50:01C87881]
X-Scanned-By: MailControl A-08-00-04 (www.mailcontrol.com) on 10.71.1.112
X-Virus-Scanned: ClamAV 0.91.2/6003/Tue Feb 26 12:34:31 2008 on bifrost
X-Virus-Status: Clean

On Tue, 26 Feb 2008 14:18:14 +0100
Dagobert Michelsen <dam@blastwave.org> wrote:
> I am building zsh 4.3.5 on Solaris 10 x86 with the
> Sun Studio 12 compiler and I have some failed tests
> in the teststuite:
>...
> ./A03quoting.ztst: starting.
> Test ./A03quoting.ztst failed: bad status 1, expected 0 from:
>    print '<\u0041>'
>    printf '%s\n' $'<\u0042>'
>    print '<\u0043>'
>    printf '%s\n' $'<\u0044>'
> Error output:
> (eval):1: cannot do charset conversion
>...
> ./D07multibyte.ztst: starting.
> Testing multibyte with locale en_US.UTF-8
> *** /tmp/zsh.ztst.out.19793     Tue Feb 26 08:06:28 2008
> --- /tmp/zsh.ztst.tout.19793    Tue Feb 26 08:06:28 2008
> ***************
> *** 1,4 ****
> ! OK
> ! OK
> ! OK
> ! OK
> --- 1,4 ----
> ! Failed: no error message and no question mark
> ! Failed: no error message and no question mark
> ! Failed: no error message and no question mark
> ! Failed: no error message and no question mark
> Test ./D07multibyte.ztst failed: output differs from expected as  

This means the it hasn't found either iconv or any other library to do
character conversion.  (The error message is suppressed in the second case
but there's a good chance it's the same error.)  The shell has two basic
ways of doing this:

(i) compile environment directly supports ISO 10646
(ii) libraries support nl_langinfo(CODESET) and
     (a) the current locale uses UTF-8 so the shell
         can do a trivial conversion to UTF-8.
     (b) iconv() is available in -liconv.

(i) or (ii) are handled at compile time.  The choice between (ii)(a) and
(ii)(b) is handled at run time so long as nl_langinfo(CODESET) is
available.  I don't think (ii)(a) applies in these tests, so this
presumably means both that the environment doesn't support ISO 10646, and
that iconv wasn't found.

It might for developers' purposes (this doesn't affect you directly except
as far as bug reports go) be useful to distinguish what failed...

Index: Src/utils.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/utils.c,v
retrieving revision 1.176
diff -u -r1.176 utils.c
--- Src/utils.c	25 Jan 2008 16:48:23 -0000	1.176
+++ Src/utils.c	26 Feb 2008 14:09:43 -0000
@@ -4877,7 +4877,7 @@
 
     	    	    cd = iconv_open(nl_langinfo(CODESET), "UCS-4BE");
 		    if (cd == (iconv_t)-1) {
-			zerr("cannot do charset conversion");
+			zerr("cannot do charset conversion (iconv failed)");
 			CHARSET_FAILED();
 		    }
                     count = iconv(cd, &inptr, &inbytes, &t, &outbytes);
@@ -4889,12 +4889,12 @@
 		    if ((how & GETKEY_UPDATE_OFFSET) && s - sstart < *misc)
 			(*misc) += count;
 #   else
-                    zerr("cannot do charset conversion");
+                    zerr("cannot do charset conversion (iconv not available)");
 		    CHARSET_FAILED();
 #   endif
 		}
 #  else
-                zerr("cannot do charset conversion");
+                zerr("cannot do charset conversion (NLS not supported)");
 		CHARSET_FAILED();
 #  endif
 # endif

