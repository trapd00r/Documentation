From zsh-workers-return-12160-mason-zsh=primenet.com.au@sunsite.auc.dk Tue Jul 04 16:02:24 2000
Return-Path: <zsh-workers-return-12160-mason-zsh=primenet.com.au@sunsite.auc.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 13427 invoked from network); 4 Jul 2000 16:02:23 -0000
Received: from sunsite.auc.dk (130.225.51.30)
  by ns1.primenet.com.au with SMTP; 4 Jul 2000 16:02:23 -0000
Received: (qmail 12704 invoked by alias); 4 Jul 2000 16:02:11 -0000
Mailing-List: contact zsh-workers-help@sunsite.auc.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.auc.dk
X-Seq: 12160
Received: (qmail 12675 invoked from network); 4 Jul 2000 16:02:09 -0000
From: "Bart Schaefer" <schaefer@candle.brasslantern.com>
Message-Id: <1000704155825.ZM3854@candle.brasslantern.com>
Date: Tue, 4 Jul 2000 15:58:25 +0000
In-Reply-To: <000401bfe591$f057fca0$21c9ca95@mow.siemens.ru>
Comments: In reply to "Andrej Borsenkow" <Andrej.Borsenkow@mow.siemens.ru>
        "Test hanger disappeared, but ... RE: PATCH: Fix ZDOTDIR during "make check" for static builds" (Jul  4, 12:29pm)
References: <000401bfe591$f057fca0$21c9ca95@mow.siemens.ru>
X-Mailer: Z-Mail (5.0.0 30July97)
To: "Andrej Borsenkow" <Andrej.Borsenkow@mow.siemens.ru>,
        <zsh-workers@sunsite.auc.dk>
Subject: PATCH: compdump (Re: Test hanger disappeared, but ...)
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii

On Jul 4, 12:29pm, Andrej Borsenkow wrote:
} 
} > When I made my earlier patch for this (12039), I forgot that
} > Test/Modules doesn't get created when the build is static.
} 
} May be, it is something different - but now completion tests do not hang
} anymore.

It looks like compdump failure causes compinit to abort completely when
ZDOTDIR points to a nonexistent location.  The redirection on line 34
prints "no such file or directory" and then everything stops.

We seem to be running into a lot of things that cause zsh to abort all
the way back to top level.  Do other shells give up so thoroughly in
these situations?

Index: Completion/Core/compdump
===================================================================
@@ -21,6 +21,8 @@
 _d_file=${_comp_dumpfile-${0:h}/compinit.dump}.$HOST.$$
 [[ $_d_file = //* ]] && _d_file=${_d_file[2,-1]}
 
+[[ -w ${_d_file:h} ]] || return 1
+
 _d_files=( ${^~fpath:/.}/^([^_]*|*~|*.zwc)(N) )
 
 if [[ -n "$_comp_secure" ]]; then

-- 
Bart Schaefer                                 Brass Lantern Enterprises
http://www.well.com/user/barts              http://www.brasslantern.com

Zsh: http://www.zsh.org | PHPerl Project: http://phperl.sourceforge.net   

