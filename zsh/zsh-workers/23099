From zsh-workers-return-23099-mason-zsh=primenet.com.au@sunsite.dk Wed Jan 10 22:41:42 2007
Return-Path: <zsh-workers-return-23099-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 1079 invoked from network); 10 Jan 2007 22:41:36 -0000
X-Spam-Checker-Version: SpamAssassin 3.1.7 (2006-10-05) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-1.1 required=5.0 tests=BAYES_00,FORGED_RCVD_HELO,
	HTML_10_20,HTML_MESSAGE autolearn=no version=3.1.7
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 10 Jan 2007 22:41:36 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 77838 invoked from network); 10 Jan 2007 22:41:24 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 10 Jan 2007 22:41:24 -0000
Received: (qmail 20622 invoked by alias); 10 Jan 2007 22:41:22 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 23099
Received: (qmail 20611 invoked from network); 10 Jan 2007 22:41:21 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 10 Jan 2007 22:41:21 -0000
Received: (qmail 77521 invoked from network); 10 Jan 2007 22:41:21 -0000
Received: from wr-out-0506.google.com (64.233.184.227)
  by a.mx.sunsite.dk with SMTP; 10 Jan 2007 22:41:18 -0000
Received: by wr-out-0506.google.com with SMTP id i4so200169wra
        for <zsh-workers@sunsite.dk>; Wed, 10 Jan 2007 14:41:13 -0800 (PST)
DomainKey-Signature: a=rsa-sha1; c=nofws;
        d=gmail.com; s=beta;
        h=received:message-id:date:from:to:subject:mime-version:content-type;
        b=YzV67wXgXTZxbESlVAYmIIWgMmoR6oLyN6PndeJTnyQ3Ro2EmJ760eV/EzhnXb8Pfp2TUkBWllJoOK/AwQ4zATbcR56TPre09WETqIn2I0yYzg8XlbuNUKdTu+DsCnoqvZ8Z+KNf4GIBdDipVYe0jsMKcHCRpvr++CMKYevgIu0=
Received: by 10.90.52.2 with SMTP id z2mr618571agz.1168468873429;
        Wed, 10 Jan 2007 14:41:13 -0800 (PST)
Received: by 10.90.78.19 with HTTP; Wed, 10 Jan 2007 14:41:13 -0800 (PST)
Message-ID: <bf7e3eaf0701101441o33b52166x2979e12287b6f605@mail.gmail.com>
Date: Wed, 10 Jan 2007 17:41:13 -0500
From: "Gene Carter" <gananda@gmail.com>
To: zsh-workers@sunsite.dk
Subject: bug: ZERR traps and functions.
MIME-Version: 1.0
Content-Type: multipart/alternative; 
	boundary="----=_Part_16037_28985011.1168468873405"

------=_Part_16037_28985011.1168468873405
Content-Type: text/plain; charset=ISO-8859-1; format=flowed
Content-Transfer-Encoding: 7bit
Content-Disposition: inline

Greetings,

I believe I've found a bug in how ZSH handles functions and error trapping.

with zsh 4.3.2 on AIX 4.3.3...

If you set error trapping and a function returns non-zero, the shell exits,
but the code specified in the trap doesn't get executed.

This appears to be because of line 866 in exec.c, where the execution of
code depends on retflag being zero. Going in and taking out that condition
allows the code to work, but I don't have a concept for how many other
things that breaks.

Example of the bug:

########################
function a
{
    return 1
}

trap "print err" ZERR
set -e

print "###############\npre a"
a
print "post a\n###############"
##########################

Output:
17:33: [rfgadm@isriscwc {8}] /rfgadm/zsh 2
###############
pre a
17:33: [rfgadm@isriscwc {9}]

Thanks,
Gene Carter

------=_Part_16037_28985011.1168468873405
Content-Type: text/html; charset=ISO-8859-1
Content-Transfer-Encoding: 7bit
Content-Disposition: inline

Greetings,<br><br>I believe I&#39;ve found a bug in how ZSH handles functions and error trapping.<br><br>with zsh 4.3.2 on AIX 4.3.3...<br><br>If you set error trapping and a function returns non-zero, the shell exits, but the code specified in the trap doesn&#39;t get executed.
<br><br>This appears to be because of line 866 in exec.c, where the execution of code depends on retflag being zero. Going in and taking out that condition allows the code to work, but I don&#39;t have a concept for how many other things that breaks. 
<br><br>Example of the bug:<br><br>########################<br>function a<br>{<br>&nbsp;&nbsp;&nbsp; return 1<br>}<br><br>trap &quot;print err&quot; ZERR<br>set -e<br><br>print &quot;###############\npre a&quot;<br>a<br>print &quot;post a\n###############&quot;
<br>##########################<br><br>Output:<br>17:33: [rfgadm@isriscwc {8}] /rfgadm/zsh 2<br>###############<br>pre a<br>17:33: [rfgadm@isriscwc {9}]<br><br>Thanks,<br>Gene Carter<br><br>

------=_Part_16037_28985011.1168468873405--

