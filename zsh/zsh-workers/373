From zsh-workers-request@math.gatech.edu  Fri Sep  8 06:10:53 1995
Received: from gatech.edu (gatech.edu [130.207.244.244]) by werple.mira.net.au (8.6.12/8.6.9) with SMTP id GAA09381 for <mason@werple.mira.net.au>; Fri, 8 Sep 1995 06:10:49 +1000
Received: from math (math.skiles.gatech.edu) by gatech.edu with SMTP id AA24286
  (5.65c/Gatech-10.0-IDA for <mason@werple.mira.net.au>); Thu, 7 Sep 1995 16:09:53 -0400
Received: by math (5.x/SMI-SVR4)
	id AA25184; Thu, 7 Sep 1995 16:04:32 -0400
Resent-Date: Thu, 7 Sep 1995 22:03:53 +0200 (MET DST)
Old-Return-Path: <hzoli@cs.elte.hu>
From: Zoltan Hidvegi  <hzoli@cs.elte.hu>
Message-Id: <199509072003.WAA01387@bolyai.cs.elte.hu>
Subject: Re: history file re-writing in sub-shell
To: kasahara@csce.kyushu-u.ac.jp (Yoshiaki KASAHARA)
Date: Thu, 7 Sep 1995 22:03:53 +0200 (MET DST)
Cc: zsh-workers@math.gatech.edu (zsh-workers)
In-Reply-To: <199509071926.EAA15966@biyo.csce.kyushu-u.ac.jp> from "Yoshiaki KASAHARA" at Sep 8, 95 04:26:56 am
X-Mailer: ELM [version 2.4 PL24]
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
Resent-Message-Id: <"uTZlw2.0.Q96.F1rJm"@math>
Resent-From: zsh-workers@math.gatech.edu
X-Mailing-List: <zsh-workers@math.gatech.edu> archive/latest/373
X-Loop: zsh-workers@math.gatech.edu
Precedence: list
Resent-Sender: zsh-workers-request@math.gatech.edu

> 
> Hello.  I'm not a subscriber of this list, but I found a weirdness
> while using zsh-2.6-beta8 and 10, so I'll report it here.
> 
> After I replaced my zsh from 2.5 to 2.6beta, I found that saved
> history was not read correctly.
> 
> Finally I found that when I use $(non-zsh-builtin-command), the
> content of $HISTFILE is changed (just like when an interactive shell
> exits).  I believe there are something wrong with command
> substitution...  I have never encountered such a problem with zsh 2.5.
> 
> Please send me responses (if any).  Thank you.

I send a `fix' for that in article 337 some time ago, I send it again as noone
responded.  It fixes the problem but is completely disables saving history on
exec since an other bug I'm not going to fix (I have no time and I do not know
exec.c well enough).

Zoltan

>From hzoli Tue Aug 22 16:31:43 1995
Subject: HISTORY saving fixes
To: zsh-workers@math.gatech.edu (zsh-workers)

Zsh saves history on each command substitution.  I thought that this bug was
corrected long ago.

The patch below fixes this, and it also saves history when a builtin is
exec'ed.  It also disables history saving on exec in the startup files
(that's what Mark Borges complaind about a lot).  That's because zsh loads
the history file only after processing the startup files so saving it with
append_history unset would wipe out the history.  History saving is also
disabled in zexit for the same reason.

Unfortunately the exec part of this fix does not work as expected.  After
this patch zsh will never save anything on exec.  That is because subsh is
always true since entersubsh is called from exec.c near line 1241 for each
command or builtin executed with exec. This seems illogical for me but I do
not understand these things completely so I'd leave the fix to someone else.

The patch is for vanilla beta10.  For hzoli10.x the first hunk fails but it
can be merged easily by hand, and the really important part is the second
hunk.

Zoltan

*** Src/exec.c.~1~	Mon Aug 21 23:40:20 1995
--- Src/exec.c	Mon Aug 21 23:41:12 1995
***************
*** 1447,1454 ****
  		if (cmd->flags & CFLAG_EXEC) {
  		    if (subsh)
  			_exit(lastval);
! 		    else
! 			exit(lastval);
  		}
  		if (savelist) {
  		    /* Restore variables, freeing the list but not data. */
--- 1447,1456 ----
  		if (cmd->flags & CFLAG_EXEC) {
  		    if (subsh)
  			_exit(lastval);
! 		    if (unset(NORCS) && interact && sourcelevel < 32768)
! 			/* save the history file through execs */
! 			savehistfile(getsparam("HISTFILE"), 1, isset(APPENDHISTORY) ? 3 : 0);
! 		    exit(lastval);
  		}
  		if (savelist) {
  		    /* Restore variables, freeing the list but not data. */
***************
*** 1468,1474 ****
  	} else {
  	    if (cmd->flags & CFLAG_EXEC) {
  		setiparam("SHLVL", --shlvl);
! 		if (unset(NORCS) && interact)
  		    /* save the history file through execs */
  		    savehistfile(getsparam("HISTFILE"), 1, isset(APPENDHISTORY) ? 3 : 0);
  	    }
--- 1470,1476 ----
  	} else {
  	    if (cmd->flags & CFLAG_EXEC) {
  		setiparam("SHLVL", --shlvl);
! 		if (unset(NORCS) && interact && !subsh && sourcelevel < 32768)
  		    /* save the history file through execs */
  		    savehistfile(getsparam("HISTFILE"), 1, isset(APPENDHISTORY) ? 3 : 0);
  	    }
*** 1.28	1995/08/21 22:02:42
--- Src/builtin.c	1995/08/21 22:04:09
***************
*** 4829,4835 ****
  	    }
  	} else
  	    killrunjobs(); /* send SIGHUP to any jobs left running  */
!     if (unset(NORCS) && interact) {
  	if (isset(APPENDHISTORY))
  	    savehistfile(getsparam("HISTFILE"), 1, 3);
  	else
--- 4829,4835 ----
  	    }
  	} else
  	    killrunjobs(); /* send SIGHUP to any jobs left running  */
!     if (unset(NORCS) && interact && sourcelevel < 32768) {
  	if (isset(APPENDHISTORY))
  	    savehistfile(getsparam("HISTFILE"), 1, 3);
  	else

