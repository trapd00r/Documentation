From zsh-users-return-6964-mason-zsh=primenet.com.au@sunsite.dk Mon Dec 29 08:02:41 2003
Return-Path: <zsh-users-return-6964-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 26011 invoked from network); 29 Dec 2003 08:02:40 -0000
Received: from sunsite.dk (130.225.247.90)
  by ns1.primenet.com.au with SMTP; 29 Dec 2003 08:02:40 -0000
Received: (qmail 26266 invoked by alias); 29 Dec 2003 08:02:16 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 6964
Received: (qmail 26203 invoked from network); 29 Dec 2003 08:02:15 -0000
Received: from localhost (HELO sunsite.dk) (127.0.0.1)
  by localhost with SMTP; 29 Dec 2003 08:02:15 -0000
X-MessageWall-Score: 0 (sunsite.dk)
Received: from [68.1.17.114] by sunsite.dk (MessageWall 1.0.8) with SMTP; 29 Dec 2003 8:2:15 -0000
Received: from quark.localdomain ([68.12.75.33]) by lakemtao07.cox.net
          (InterMail vM.5.01.06.05 201-253-122-130-105-20030824) with ESMTP
          id <20031229080213.TICY2432.lakemtao07.cox.net@quark.localdomain>
          for <zsh-users@sunsite.dk>; Mon, 29 Dec 2003 03:02:13 -0500
Received: from quark.localdomain (localhost.localdomain [127.0.0.1])
	by quark.localdomain (8.12.9/8.12.9) with ESMTP id hBT82MuO075515
	for <zsh-users@sunsite.dk>; Mon, 29 Dec 2003 02:02:22 -0600 (CST)
	(envelope-from vince@quark.localdomain)
Received: (from vince@localhost)
	by quark.localdomain (8.12.9/8.12.9/Submit) id hBT82Mph075514
	for zsh-users@sunsite.dk; Mon, 29 Dec 2003 02:02:22 -0600 (CST)
Date: Mon, 29 Dec 2003 02:02:22 -0600
From: Vincent Stemen <zsh@hightek.org>
To: zsh-users@sunsite.dk
Subject: Possible bug in zsh
Message-ID: <20031229080222.GA75453@quark.localdomain>
Mime-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
User-Agent: Mutt/1.4.1i

I think I may have encountered a bug in Z shell.  It began when I
tried linking /bin/sh to zsh on FreeBSD-5.1.  When it reboots, I get a
lot of errors from the init scripts because the rootfs does not get
re-mounted read-writable.  I have isolated the piece of init script
code and included a small script below, extracted from the init
scripts and modified for testing, that reproduces the problem.  See
the comments in the script.

The problem goes away if I remove the [ -n "$_precmd" ] statement
which, so far as I can tell, should have no effect on the following if
statement where the problem is.  I tested with zsh-4.0.9 and
zsh-4.1.0.dev5.


<script>

root_start()
{
    # This function normally remounts / in rw mode
    echo "<< Running root_start() >>"
}


_cmd=root_start

if [ -n "$_cmd" ]; then
            # if the precmd failed and force
            # isn't set, exit
            #

    # Remove or comment out these two lines and the problem goes away.
    # ie. zsh does not return 1 in the next statement.
    [ -n "$_precmd" ] &&
        echo "run_rc_command: evaluating ${_precmd}()."

    # $_precmd is null.
    # zsh enters this if statement and returns 1, causing root_start() to
    # never get run, thus leaving /
    # mounted ro.  FreeBSD's sh and bash do not.

    if ! eval $_precmd && [ -z "$rc_force" ]; then
        return 1
    fi

    [ -n "$_cmd" ] &&
        echo "run_rc_command: evaluating ${_cmd}()."
    if ! eval $_cmd && [ -z "$rc_force" ]; then
        return 1
    fi

    return 0
fi

</script>

-- 
Vincent Stemen
Avoid the VeriSign/Network Solutions domain registration trap!
http://www.InetAddresses.net

