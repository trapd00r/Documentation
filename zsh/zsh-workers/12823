From zsh-workers-return-12823-mason-zsh=primenet.com.au@sunsite.auc.dk Sun Sep 17 16:44:45 2000
Return-Path: <zsh-workers-return-12823-mason-zsh=primenet.com.au@sunsite.auc.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 20700 invoked from network); 17 Sep 2000 16:44:15 -0000
Received: from sunsite.auc.dk (130.225.51.30)
  by ns1.primenet.com.au with SMTP; 17 Sep 2000 16:44:15 -0000
Received: (qmail 19138 invoked by alias); 17 Sep 2000 16:43:23 -0000
Mailing-List: contact zsh-workers-help@sunsite.auc.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.auc.dk
X-Seq: 12823
Received: (qmail 19131 invoked from network); 17 Sep 2000 16:43:23 -0000
Date: Sun, 17 Sep 2000 12:43:16 -0400
From: Clint Adams <schizo@debian.org>
To: Bart Schaefer <schaefer@candle.brasslantern.com>
Cc: zsh-workers@sunsite.auc.dk
Subject: Re: PATCH: zasprintf
Message-ID: <20000917124316.A4695@dman.com>
References: <20000916145333.A29559@dman.com> <1000917004721.ZM18698@candle.brasslantern.com> <20000917002552.A31354@dman.com> <1000917053751.ZM18817@candle.brasslantern.com> <20000917110403.A4270@dman.com> <1000917161356.ZM19396@candle.brasslantern.com>
Mime-Version: 1.0
Content-Type: text/plain; charset=us-ascii
User-Agent: Mutt/1.1.2i
In-Reply-To: <1000917161356.ZM19396@candle.brasslantern.com>; from schaefer@candle.brasslantern.com on Sun, Sep 17, 2000 at 04:13:56PM +0000

> This is a case where a zsh-heap-allocating version of tricat() would be
> slightly preferable to a permanent-heap-allocating version.

Index: Src/builtin.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/builtin.c,v
retrieving revision 1.34
diff -u -r1.34 builtin.c
--- Src/builtin.c	2000/09/17 16:24:06	1.34
+++ Src/builtin.c	2000/09/17 16:38:39
@@ -3297,25 +3297,25 @@
 		break;
 	    }
 	if (!*s || (ret && isset(PATHDIRS) && diddot < 2 && dotdot == 0)) {
+	    pushheap();
 	    /* search path for script */
 	    for (t = path; *t; t++) {
 		if (!(*t)[0] || ((*t)[0] == '.' && !(*t)[1])) {
 		    if (diddot)
 			continue;
 		    diddot = 1;
-		    buf = ztrdup(arg0);
+		    buf = dupstring(arg0);
 		} else
-		    buf = tricat(*t, "/", arg0);
+		    buf = zhtricat(*t, "/", arg0);
 
 		s = unmeta(buf);
 		if (access(s, F_OK) == 0 && stat(s, &st) >= 0
 		    && !S_ISDIR(st.st_mode)) {
 		    ret = source(enam = buf);
-		    zsfree(buf);
 		    break;
 		}
-		zsfree(buf);
 	    }
+	    popheap();
 	}
     }
     /* clean up and return */
Index: Src/utils.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/utils.c,v
retrieving revision 1.14
diff -u -r1.14 utils.c
--- Src/utils.c	2000/08/29 20:27:48	1.14
+++ Src/utils.c	2000/09/17 16:38:46
@@ -3473,6 +3473,20 @@
 }
 
 /**/
+mod_export char *
+zhtricat(char const *s1, char const *s2, char const *s3)
+{
+    char *ptr;
+    
+    ptr = (char *)zhalloc(strlen(s1) + strlen(s2) + strlen(s3) + 1);
+    strcpy(ptr, s1);
+    strcat(ptr, s2);
+    strcat(ptr, s3);
+    return ptr;
+}
+
+
+/**/
 static int
 upchdir(int n)
 {

