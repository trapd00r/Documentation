From zsh-workers-return-14817-mason-zsh=primenet.com.au@sunsite.dk Fri Jun 08 19:47:54 2001
Return-Path: <zsh-workers-return-14817-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 4828 invoked from network); 8 Jun 2001 19:47:53 -0000
Received: from sunsite.dk (130.225.51.30)
  by ns1.primenet.com.au with SMTP; 8 Jun 2001 19:47:53 -0000
Received: (qmail 8631 invoked by alias); 8 Jun 2001 19:47:33 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 14817
Received: (qmail 8620 invoked from network); 8 Jun 2001 19:47:32 -0000
X-Authentication-Warning: candle.brasslantern.com: schaefer set sender to lantern@shell10.ba.best.com using -f
From: "Bart Schaefer" <schaefer@candle.brasslantern.com>
Message-Id: <010608124608.ZM5942@candle.brasslantern.com>
Date: Fri, 8 Jun 2001 12:46:08 -0700
In-Reply-To: <20010608150445.A5394@dman.com>
Comments: In reply to Clint Adams <clint@zsh.org>
        "Re: PATCH: check deleted .zwc files" (Jun  8,  3:04pm)
References: <20010608141719.A4626@dman.com> 
	<010608115028.ZM5876@candle.brasslantern.com> 
	<20010608150445.A5394@dman.com>
X-Mailer: Z-Mail Lite (5.0.0 30July97)
To: Clint Adams <clint@zsh.org>
Subject: Re: PATCH: check deleted .zwc files
Cc: zsh-workers@sunsite.dk
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii

On Jun 8,  3:04pm, Clint Adams wrote:
> Subject: Re: PATCH: check deleted .zwc files
> 
> > What happens if the file has been deleted and re-created?  zwcstat()
> > will return the stat info for the newly-created file, but what will
> > autoloading do with the now-obsolete (?) file handle?
> 
> Oops.  It will do nothing with it, just as it did nothing with it before.

Maybe this is a flaw in the whole .zwc loading scheme, then.

What I'm getting at is this scenario:

I have a .zwc file for several functions.  I update one of those functions.
I then remove and rebuild the .zwc file.  Now, stat() of the .zwc shows
that it is newer than the function file, but any running zsh still has a
mapped descriptor on the removed file.  With this code:

>      if (stat(filename, buf)) {
>  #ifdef HAVE_FSTAT
>  	for (f = dumps; f; f = f->next) {
> +	    if (!strncmp(filename, f->filename, strlen(f->filename)) &&
> +		!fstat(f->fd, buf))
> +		return 0;
>  	}
>  #endif
>  	return 1;

zwcstat() will cause zsh to decide that it can keep using the mapped copy,
even though the function file is actually newer than the mapped copy.

The only safe thing to do is to try the fstat() first, then stat().  To be
really complete, if fstat() and stat() disagree zsh should throw out the
mapped file and reload it, but that could get pretty tricky.

