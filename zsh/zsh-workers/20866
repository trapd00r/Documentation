From zsh-workers-return-20866-mason-zsh=primenet.com.au@sunsite.dk Thu Feb 24 21:08:22 2005
Return-Path: <zsh-workers-return-20866-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 24384 invoked from network); 24 Feb 2005 21:08:19 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 24 Feb 2005 21:08:19 -0000
Received: (qmail 10569 invoked from network); 24 Feb 2005 21:08:10 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 24 Feb 2005 21:08:10 -0000
Received: (qmail 25682 invoked by alias); 24 Feb 2005 21:08:08 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 20866
Received: (qmail 25671 invoked from network); 24 Feb 2005 21:08:07 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 24 Feb 2005 21:08:07 -0000
Received: (qmail 10297 invoked from network); 24 Feb 2005 21:08:07 -0000
Received: from cmailg1.svr.pol.co.uk (195.92.195.171)
  by a.mx.sunsite.dk with SMTP; 24 Feb 2005 21:08:02 -0000
Received: from modem-211.high-hat.dialup.pol.co.uk ([62.137.27.211] helo=pwstephenson.fsnet.co.uk)
	by cmailg1.svr.pol.co.uk with esmtp (Exim 4.14)
	id 1D4QDJ-00041O-8s
	for zsh-workers@sunsite.dk; Thu, 24 Feb 2005 21:08:01 +0000
Received: by pwstephenson.fsnet.co.uk (Postfix, from userid 501)
	id 3D60A864B; Thu, 24 Feb 2005 16:11:42 -0500 (EST)
Received: from pwstephenson.fsnet.co.uk (localhost [127.0.0.1])
	by pwstephenson.fsnet.co.uk (Postfix) with ESMTP id F40E18646
	for <zsh-workers@sunsite.dk>; Thu, 24 Feb 2005 21:11:41 +0000 (GMT)
To: zsh-workers@sunsite.dk
Subject: Re: PATCH: zle status line 
In-reply-to: <200502242244.53160.arvidjaar@newmail.ru> 
References: <200502241349.j1ODnc5a018479@news01.csr.com> <200502242244.53160.arvidjaar@newmail.ru>
Date: Thu, 24 Feb 2005 21:11:40 +0000
From: Peter Stephenson <pws@pwstephenson.fsnet.co.uk>
Message-Id: <20050224211142.3D60A864B@pwstephenson.fsnet.co.uk>
X-Spam-Checker-Version: SpamAssassin 3.0.2 on a.mx.sunsite.dk
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=6.0 tests=BAYES_00 autolearn=ham 
	version=3.0.2
X-Spam-Hits: -2.6

Andrey Borzenkov wrote:
> e-n-c passes constant prmt that unmetafy is trying to assign to. It is too 
> late for me to decide whether all callers of stringaslinezle or it itself 
> should provide a writable copy of instr.

Oops, it should be the caller and it's even documented.  I hope there
aren't other cases I've missed.  There's also a typo that only
gets triggered on completion in execute-named-command owing to lazy
symbol resolution.

Index: Src/Zle/zle_misc.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/zle_misc.c,v
retrieving revision 1.19
diff -u -r1.19 zle_misc.c
--- Src/Zle/zle_misc.c	24 Feb 2005 15:32:57 -0000	1.19
+++ Src/Zle/zle_misc.c	24 Feb 2005 21:07:09 -0000
@@ -775,10 +775,13 @@
     char *okeymap = ztrdup(curkeymapname);
 
     clearlist = 1;
+    /* prmt may be constant */
+    prmt = ztrdup(prmt);
     zprmt = stringaszleline((unsigned char *)prmt, &l, NULL);
     cmdbuf = zhalloc((l + NAMLEN + 2) * ZLE_CHAR_SIZE);
     ZS_memcpy(cmdbuf, zprmt, l);
     free(zprmt);
+    zsfree(prmt);
     statusline = cmdbuf;
     selectkeymap("main", 1);
     ptr = cmdbuf += l;
@@ -919,7 +922,7 @@
 		    int ltmp;
 		    ZLE_STRING_T ztmp = stringaszleline(peekfirst(cmdll),
 							&ltmp, NULL);
-		    ZS_mempcy(cmdbuf, ztmp, ltmp);
+		    ZS_memcpy(cmdbuf, ztmp, ltmp);
 		    free(ztmp);
 		    ptr = cmdbuf + cmdambig;
 		    *ptr = ZWC('_');


-- 
Peter Stephenson <pws@pwstephenson.fsnet.co.uk>
Work: pws@csr.com
Web: http://www.pwstephenson.fsnet.co.uk

