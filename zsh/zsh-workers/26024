From zsh-workers-return-26024-mason-zsh=primenet.com.au@sunsite.dk Tue Nov 11 16:32:05 2008
Return-Path: <zsh-workers-return-26024-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 28285 invoked from network); 11 Nov 2008 16:32:02 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 11 Nov 2008 16:32:02 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 96738 invoked from network); 11 Nov 2008 16:31:54 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 11 Nov 2008 16:31:54 -0000
Received: (qmail 25132 invoked by alias); 11 Nov 2008 16:31:48 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 26024
Received: (qmail 25122 invoked from network); 11 Nov 2008 16:31:48 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 11 Nov 2008 16:31:48 -0000
Received: from n5a.bullet.ukl.yahoo.com (n5a.bullet.ukl.yahoo.com [217.146.183.153])
	by bifrost.dotsrc.org (Postfix) with SMTP id 0DD4780308BE
	for <zsh-workers@sunsite.dk>; Tue, 11 Nov 2008 17:31:44 +0100 (CET)
Received: from [217.146.182.178] by n5.bullet.ukl.yahoo.com with NNFMP; 11 Nov 2008 16:31:44 -0000
Received: from [87.248.110.108] by t4.bullet.ukl.yahoo.com with NNFMP; 11 Nov 2008 16:31:44 -0000
Received: from [127.0.0.1] by omp213.mail.ukl.yahoo.com with NNFMP; 11 Nov 2008 16:31:44 -0000
X-Yahoo-Newman-Id: 536255.9391.bm@omp213.mail.ukl.yahoo.com
Received: (qmail 47794 invoked from network); 11 Nov 2008 16:31:44 -0000
DomainKey-Signature: a=rsa-sha1; q=dns; c=nofws;
  s=s1024; d=yahoo.co.uk;
  h=Received:X-YMail-OSG:X-Yahoo-Newman-Property:Received:From:To:Subject:Date:Message-ID;
  b=ccVdbCzfI6PNllze4Hivr1AqEAxVgSl67+MONcIrIBu4G8XFWnGQqzLp1kva8uUWnD0+n2V2y7QlY6NTA6R6EvQdsEYwSs/RU386PlUbmeQqXIWiYerfLK6jjV+pkvTfQ4KN9zJH6ilqONopYywfqy98rhvqY1B8l8G0YSaxE4M=  ;
Received: from unknown (HELO thecus) (okiddle@89.48.43.161 with plain)
  by smtp122.mail.ukl.yahoo.com with SMTP; 11 Nov 2008 16:31:44 -0000
X-YMail-OSG: AuDjgm8VM1nZrURqjlRdYa8rAWp21_VnFXYMYLAmXJQRiRQI0mVDw8xu2x.26iPzvBS.4OF.IyigbqG5F2P6cVk8M7QnirQSXD1luxM7J9HIrbPI7GDMPbDVXW1VhwLxUITl0T278asR..vxbXIQDZkC6gxoyIWrBjxAMDA-
X-Yahoo-Newman-Property: ymail-3
Received: from localhost ([127.0.0.1] helo=thecus)
	by thecus with esmtp (Exim 4.63)
	(envelope-from <okiddle@yahoo.co.uk>)
	id 1Kzw9W-0007Pw-FQ
	for zsh-workers@sunsite.dk; Tue, 11 Nov 2008 17:31:42 +0100
From: Oliver Kiddle <okiddle@yahoo.co.uk>
To: Zsh workers <zsh-workers@sunsite.dk>
Subject: PATCH: bindkey resource leak
Date: Tue, 11 Nov 2008 17:31:42 +0100
Message-ID: <28515.1226421102@thecus>
X-Virus-Scanned: ClamAV 0.92.1/8609/Tue Nov 11 13:53:28 2008 on bifrost
X-Virus-Status: Clean

Either of these run repeatedly will increment the reference counter for
the "thingy". The first case is CID 107. I don't think coverity picked
up on the second case.

bindkey -R B-A thingy
bindkey '' thingy

Oliver

Index: Src/Zle/zle_keymap.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/zle_keymap.c,v
retrieving revision 1.29
diff -u -r1.29 zle_keymap.c
--- Src/Zle/zle_keymap.c	3 Apr 2008 15:20:24 -0000	1.29
+++ Src/Zle/zle_keymap.c	11 Nov 2008 16:17:43 -0000
@@ -918,11 +918,12 @@
 		    metafy(m, 1, META_NOALLOC);
 		    bindkey(km, m, refthingy(fn), str);
 		}
-		unrefthingy(fn);
 	    }
+	    unrefthingy(fn);
 	} else {
 	    if(bindkey(km, seq, fn, str)) {
 		zwarnnam(name, "cannot bind to an empty key sequence");
+		unrefthingy(fn);
 		ret = 1;
 	    }
 	}


