From zsh-workers-return-21583-mason-zsh=primenet.com.au@sunsite.dk Mon Aug 08 22:59:52 2005
Return-Path: <zsh-workers-return-21583-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 1553 invoked from network); 8 Aug 2005 22:59:49 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 8 Aug 2005 22:59:49 -0000
Received: (qmail 70804 invoked from network); 8 Aug 2005 22:59:43 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 8 Aug 2005 22:59:43 -0000
Received: (qmail 16107 invoked by alias); 8 Aug 2005 22:59:36 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 21583
Received: (qmail 16098 invoked from network); 8 Aug 2005 22:59:35 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 8 Aug 2005 22:59:35 -0000
Received: (qmail 70213 invoked from network); 8 Aug 2005 22:59:35 -0000
Received: from mail.gmx.net (213.165.64.20)
  by a.mx.sunsite.dk with SMTP; 8 Aug 2005 22:59:32 -0000
Received: (qmail invoked by alias); 08 Aug 2005 22:59:30 -0000
Received: from Bcb40.b.pppool.de (EHLO pcdahl4201) [213.7.203.64]
  by mail.gmx.net (mp014) with SMTP; 09 Aug 2005 00:59:30 +0200
X-Authenticated: #21620914
Message-ID: <003401c59c6e$21b6f060$6183fea9@pcdahl4201>
From: "Thorsten Dahlheimer" <tdahlheim@gmx.net>
To: <zsh-workers@sunsite.dk>
Subject: PATCH: Prevent circular module aliases
Date: Tue, 9 Aug 2005 01:08:27 +0200
MIME-Version: 1.0
Content-Type: multipart/mixed;
	boundary="----=_NextPart_000_0030_01C59C7E.D96DEF00"
X-Priority: 3
X-MSMail-Priority: Normal
X-Mailer: Microsoft Outlook Express 6.00.2800.1409
X-MimeOLE: Produced By Microsoft MimeOLE V6.00.2800.1409
X-Y-GMX-Trusted: 0
X-Spam-Checker-Version: SpamAssassin 3.0.4 (2005-06-05) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham 
	version=3.0.4

This is a multi-part message in MIME format.

------=_NextPart_000_0030_01C59C7E.D96DEF00
Content-Type: text/plain;
	charset="Windows-1252"
Content-Transfer-Encoding: 7bit

The check that zmodload -A performs to prevent the creation of circular
alias chains is not thorough enough:

    % zmodload -A A=B B=C B=A
    % zmodload -A
    A -> B
    B -> A
    % zmodload A
    <stack overflow>

I've fixed that.

Regards,
Thorsten Dahlheimer
------=_NextPart_000_0030_01C59C7E.D96DEF00
Content-Type: application/octet-stream;
	name="zmodload2.patch"
Content-Transfer-Encoding: quoted-printable
Content-Disposition: attachment;
	filename="zmodload2.patch"

Index: Src/module.c=0A=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=0A=
RCS file: /cvsroot/zsh/zsh/Src/module.c,v=0A=
retrieving revision 1.18=0A=
diff -u -p -r1.18 module.c=0A=
--- Src/module.c	20 Jul 2005 16:08:22 -0000	1.18=0A=
+++ Src/module.c	8 Aug 2005 22:38:26 -0000=0A=
@@ -1093,12 +1091,15 @@ bin_zmodload_alias(char *nam, char **arg=0A=
 		    zwarnnam(nam, "invalid module name `%s'", aliasname, 0);=0A=
 		    return 1;=0A=
 		}=0A=
-		find_module(aliasname, 1, &mname);=0A=
-		if (!strcmp(mname, *args)) {=0A=
-		    zwarnnam(nam, "module alias would refer to itself: %s",=0A=
-			     *args, 0);=0A=
-		    return 1;=0A=
-		}=0A=
+		do {=0A=
+		    if (!strcmp(mname, *args)) {=0A=
+			zwarnnam(nam, "module alias would refer to itself: %s",=0A=
+				 *args, 0);=0A=
+			return 1;=0A=
+		    }=0A=
+		} while ((node =3D find_module(mname, 0, NULL))=0A=
+			 && ((m =3D (Module) getdata(node))->flags & MOD_ALIAS)=0A=
+			 && (mname =3D m->u.alias));=0A=
 		node =3D find_module(*args, 0, NULL);=0A=
 		if (node) {=0A=
 		    m =3D (Module) getdata(node);=0A=

------=_NextPart_000_0030_01C59C7E.D96DEF00--

