From zsh-workers-return-17192-mason-zsh=primenet.com.au@sunsite.dk Tue May 21 07:46:54 2002
Return-Path: <zsh-workers-return-17192-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 7901 invoked from network); 21 May 2002 07:46:53 -0000
Received: from sunsite.dk (130.225.247.90)
  by ns1.primenet.com.au with SMTP; 21 May 2002 07:46:53 -0000
Received: (qmail 4408 invoked by alias); 21 May 2002 07:46:47 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 17192
Received: (qmail 4396 invoked from network); 21 May 2002 07:46:46 -0000
From: Sven Wischnowsky <wischnow@berkom.de>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Transfer-Encoding: 7bit
Message-ID: <15593.64339.44554.401342@wischnow.berkom.de>
Date: Tue, 21 May 2002 09:46:27 +0200
To: zsh-workers@sunsite.dk
Subject: PATCH: Re: still completion in quotes
In-Reply-To: <6134254DE87BD411908B00A0C99B044F0369C375@mowd019a.mow.siemens.ru>
References: <6134254DE87BD411908B00A0C99B044F0369C375@mowd019a.mow.siemens.ru>
X-Mailer: VM 6.95 under 21.5 (patch 3) "asparagus" XEmacs Lucid


Borsenkow Andrej wrote:

> bor@itsrm2% ls
> a b       c\ d      uudecode
> bor@itsrm2% zsh -c "ls a\\TAB
> bor@itsrm2% zsh -c "ls aa\\*
> 
> sorry?

Oh, das ist gemein ;-)

Well, yes, we had to treat that backslash-at-the-end special
elsewhere, so we have to do the same in the nested-quotes case, too.
Right.


Bye
  Sven

Index: Src/Zle/compcore.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/compcore.c,v
retrieving revision 1.58
diff -u -r1.58 compcore.c
--- Src/Zle/compcore.c	15 May 2002 07:40:36 -0000	1.58
+++ Src/Zle/compcore.c	21 May 2002 07:45:14 -0000
@@ -1428,8 +1428,8 @@
     for (p = ns, i = swb; *p; p++, i++) {
 	if (INULL(*p)) {
 	    if (i < scs) {
-		if (*p == Bnull && p[1]) {
-                    if (remq)
+		if (*p == Bnull) {
+                    if (p[1] && remq)
                         swb -= 2;
                     if (odq) {
                         swb--;
@@ -1526,6 +1526,10 @@
 	    untokenize(ss);
 	    compsuffix = ztrdup(ss);
 	}
+        if ((i = strlen(compprefix)) &&
+            compprefix[i - 1] == '\\' && compprefix[i - 2] != '\\')
+            compprefix[i - 1] = '\0';
+        
 	tmp = tricat(compqiprefix, compiprefix, multiquote(qp, 1));
 	zsfree(compqiprefix);
 	compqiprefix = tmp;

-- 
Sven Wischnowsky                          wischnow@berkom.de

