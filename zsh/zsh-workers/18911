From zsh-workers-return-18911-mason-zsh=primenet.com.au@sunsite.dk Mon Jul 28 07:11:45 2003
Return-Path: <zsh-workers-return-18911-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 22080 invoked from network); 28 Jul 2003 07:11:44 -0000
Received: from sunsite.dk (130.225.247.90)
  by ns1.primenet.com.au with SMTP; 28 Jul 2003 07:11:44 -0000
Received: (qmail 3041 invoked by alias); 28 Jul 2003 07:11:39 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 18911
Received: (qmail 3030 invoked from network); 28 Jul 2003 07:11:39 -0000
Received: from localhost (HELO sunsite.dk) (127.0.0.1)
  by localhost with SMTP; 28 Jul 2003 07:11:39 -0000
X-MessageWall-Score: 0 (sunsite.dk)
Received: from [199.67.51.101] by sunsite.dk (MessageWall 1.0.8) with SMTP; 28 Jul 2003 7:11:38 -0000
Received: (from dan@localhost)
	by dan.emsphone.com (8.12.9/8.12.9) id h6S7BViA084932;
	Mon, 28 Jul 2003 02:11:31 -0500 (CDT)
	(envelope-from dan)
Date: Mon, 28 Jul 2003 02:11:30 -0500
From: Dan Nelson <dnelson@allantgroup.com>
To: Borzenkov Andrey <Andrey.Borzenkov@siemens.com>
Cc: "'zsh-workers@sunsite.dk'" <zsh-workers@sunsite.dk>
Subject: Re: Order of variable substitution (any SUS guru out there?)
Message-ID: <20030728071130.GG42396@dan.emsphone.com>
References: <6134254DE87BD411908B00A0C99B044F06498092@mowd019a.mow.siemens.ru>
Mime-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <6134254DE87BD411908B00A0C99B044F06498092@mowd019a.mow.siemens.ru>
X-OS: FreeBSD 5.1-CURRENT
X-message-flag: Outlook Error
User-Agent: Mutt/1.5.4i

In the last episode (Jul 28), Borzenkov Andrey said:
> Several times I happily removed files by doing
> 
> find . -name ... | (cd /master/rep; cpio -pmv $PWD)
> 
> the problem is apparently $PWD is evaluated only after  cwd is
> changed so cpio tries to copy files over themselves and removes them.
> 
> Reading SUS gives impression it is wrong. All substitutions are done
> (conceptually) in one pass before any command executes.

Are you referring to 
http://www.opengroup.org/onlinepubs/007904975/utilities/xcu_chap02.html#tag_02_09_01
?  That section talks about "simple commands".  You've got a pipeline
and a compound command, composed of three simple commands, each of
which gets its variables expanded at different times.

Under your interpretation, "(a=1 ; echo $a)" would not work, since "$a"
would be evaluated beofre "a=1" was executed.  :)

> Shell here also behaves the same:
> 
> $ find . -type f | (cd ../foo-m; cpio -pmv $PWD)
> /home/bor/tmp/foo/id_dsa
> /home/bor/tmp/foo/id_dsa.pub
> /home/bor/tmp/foo/id_rsa
> /home/bor/tmp/foo/id_rsa.pub
> 11 blocks

"Shell" being what?  
 
> while zsh gives
> 
> bor@itsrm2% find . -type f | (cd ../foo-m; cpio -pmv $PWD)
> cpio: Attempt to pass a file to itself.
> cpio: Attempt to pass a file to itself.
> cpio: Attempt to pass a file to itself.
> cpio: Attempt to pass a file to itself.
> 0 blocks
> 4 error(s)

Ash and bash do the same as zsh.  Try storing your original PWD in
another variable first:

pwd=$PWD ; find . -type f | (cd ../foo-m; cpio -pmv $pwd)
 
-- 
	Dan Nelson
	dnelson@allantgroup.com

