From zsh-workers-return-21698-mason-zsh=primenet.com.au@sunsite.dk Mon Sep 05 13:40:37 2005
Return-Path: <zsh-workers-return-21698-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 27589 invoked from network); 5 Sep 2005 13:40:33 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 5 Sep 2005 13:40:33 -0000
Received: (qmail 57311 invoked from network); 5 Sep 2005 13:40:26 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 5 Sep 2005 13:40:26 -0000
Received: (qmail 18685 invoked by alias); 5 Sep 2005 13:40:23 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 21698
Received: (qmail 18676 invoked from network); 5 Sep 2005 13:40:23 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 5 Sep 2005 13:40:23 -0000
Received: (qmail 57034 invoked from network); 5 Sep 2005 13:40:23 -0000
Received: from 195-13-58-165.oxyd.net (HELO caraldi.com) (195.13.58.165)
  by a.mx.sunsite.dk with SMTP; 5 Sep 2005 13:40:17 -0000
Received: from vision.anyware (10.21.96-84.rev.gaoland.net [84.96.21.10])
	by caraldi.com (Postfix) with ESMTP id 731B261A3
	for <zsh-workers@sunsite.dk>; Mon,  5 Sep 2005 15:40:16 +0200 (CEST)
Received: by vision.anyware (Postfix, from userid 1021)
	id C7F6A613D; Mon,  5 Sep 2005 15:40:13 +0200 (CEST)
Date: Mon, 5 Sep 2005 15:40:13 +0200
From: Jean-Baptiste Quenot <jb.quenot@caraldi.com>
To: zsh-workers@sunsite.dk
Subject: Re: [PATCH] Ant Completion: Find targets recursively
Message-ID: <20050905134013.GB55316@vision.anyware>
Mail-Followup-To: Jean-Baptiste Quenot <jb.quenot@caraldi.com>,
	zsh-workers@sunsite.dk
References: <jb.quenot@caraldi.com> <20050826121710.GA90620@vision.anyware> <20050827200547.ECB768664@pwstephenson.fsnet.co.uk> <20050902082501.GB40558@vision.anyware>
Mime-Version: 1.0
Content-Type: multipart/mixed; boundary="a8Wt8u1KmwUX3Y2C"
Content-Disposition: inline
In-Reply-To: <20050902082501.GB40558@vision.anyware>
User-Agent: mutt-ng/devel-r445 (FreeBSD)
X-Spam-Checker-Version: SpamAssassin 3.0.4 (2005-06-05) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=BAYES_00 autolearn=ham 
	version=3.0.4


--a8Wt8u1KmwUX3Y2C
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline

Thank you for committing the patch:

----------------------------
revision 1.14
date: 2005/09/02 09:17:32;  author: pws;  state: Exp;  lines: +13 -5
21693: Jean-Baptiste Quenot: recursively find ant targets

However, there was an error in  this patch: it has the side effect
to change  current working directory when  build.xml imports files
from other directories.

Thanks to Philippe Gassmann for pointing out.

Please see patch attached.
-- 
Jean-Baptiste Quenot
http://caraldi.com/jbq/

--a8Wt8u1KmwUX3Y2C
Content-Type: text/plain; charset=us-ascii
Content-Disposition: attachment; filename=patch-zsh-ant-find-targets-bug

Index: _ant
===================================================================
RCS file: /cvsroot/zsh/zsh/Completion/Unix/Command/_ant,v
retrieving revision 1.14
diff -u -r1.14 _ant
--- _ant	2 Sep 2005 09:17:32 -0000	1.14
+++ _ant	5 Sep 2005 13:33:26 -0000
@@ -8,14 +8,13 @@
 
 find_targets() {
     importedfiles=( $(sed -n "s/ *<import[^>]* file=[\"']\([^\"']*\)[\"'].*/\1/p" < $1) )
-    targets=( $(sed -n "s/ *<target[^>]* name=[\"']\([^\"']*\)[\"'].*/\1/p" $1) )
+    sed -n "s/ *<target[^>]* name=[\"']\([^\"']*\)[\"'].*/\1/p" $1
     if (( $#importedfiles )) ; then
-	cd $1:h
+	( cd $1:h
     	for file in $importedfiles ; do
 	    find_targets $file
-	done
+	done )
     fi
-    _wanted targets expl target compadd -a targets && ret=0
 }
 
 if [[ $service = *ANT_ARGS* ]]; then
@@ -126,7 +125,8 @@
         )//$'\015'}"
         _describe 'target' tmp && ret=0
       else
-        find_targets $buildfile
+        targets=( $(find_targets $buildfile) )
+        _wanted targets expl target compadd -a targets && ret=0
       fi
     else
       _message -e targets target

--a8Wt8u1KmwUX3Y2C--

