From zsh-workers-return-20192-mason-zsh=primenet.com.au@sunsite.dk Sat Jul 24 18:37:25 2004
Return-Path: <zsh-workers-return-20192-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 21603 invoked from network); 24 Jul 2004 18:37:24 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 24 Jul 2004 18:37:24 -0000
Received: (qmail 40193 invoked from network); 24 Jul 2004 18:37:18 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 24 Jul 2004 18:37:18 -0000
Received: (qmail 1578 invoked by alias); 24 Jul 2004 18:37:06 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 20192
Received: (qmail 1568 invoked from network); 24 Jul 2004 18:37:06 -0000
Received: from unknown (HELO a.mx.sunsite.dk) (130.225.247.88)
  by 130.225.247.90 with SMTP; 24 Jul 2004 18:37:05 -0000
Received: (qmail 38397 invoked from network); 24 Jul 2004 18:35:07 -0000
Received: from unknown (HELO moonbase.zanshin.com) (167.160.213.139)
  by a.mx.sunsite.dk with SMTP; 24 Jul 2004 18:35:05 -0000
Received: from toltec.zanshin.com (toltec.zanshin.com [64.84.47.166])
	by moonbase.zanshin.com (8.12.11/8.12.11) with ESMTP id i6OIZ3Co007360
	for <zsh-workers@sunsite.dk>; Sat, 24 Jul 2004 11:35:03 -0700
Date: Sat, 24 Jul 2004 11:35:02 -0700 (PDT)
From: Bart Schaefer <schaefer@brasslantern.com>
Reply-To: zsh-workers@sunsite.dk
To: zsh-workers@sunsite.dk
Subject: Re: Before 4.2.1 is finalized ...
In-Reply-To: <87smbitvdq.fsf@ceramic.fifi.org>
Message-ID: <Pine.LNX.4.61.0407241032360.7539@toltec.zanshin.com>
References: <Pine.LNX.4.61.0407231103340.29347@toltec.zanshin.com>
 <87smbitvdq.fsf@ceramic.fifi.org>
MIME-Version: 1.0
Content-Type: TEXT/PLAIN; charset=US-ASCII
X-Spam-Checker-Version: SpamAssassin 2.63 on a.mx.sunsite.dk
X-Spam-Level: 
X-Spam-Status: No, hits=-4.9 required=6.0 tests=BAYES_00 autolearn=no 
	version=2.63
X-Spam-Hits: -4.9

On Fri, 23 Jul 2004, Philippe Troin wrote:

> I'd be interested in the strace output of the problem shell.

In my original message, I reported:

	glibc-2.3.2-95.6
	gcc-3.2.3-24

I've since upgraded CentOS, so I now have:

	glibc-2.3.2-95.20
	gcc-3.2.3-34

Also the kernel changed from:

	kernel-smp-2.4.21-9.0.1.EL.c0

To:

	kernel-smp-2.4.21-15.0.3.EL.c0

I can no longer reproduce the problem with a freshly-compiled 4.2.x from 
CVS.  I *can* stil reproduce it with the 4.0.7 zsh binary that was 
originally installed from RPM (zsh-4.0.7-1).  I don't have an unpatched
copy of the 4.2.0 binary compiled with the old compiler/libraries, so I
can't make a comparison to that.

I diffed the strace output from the failing 4.0.7 and the working 4.2.x, 
and found that 4.0.7 *never* makes the ioctl(TIOCSPGRP) system call.  At 
first I thought this meant the failure return from tcsetpgrp() must be 
coming from glibc itself, but ltrace shows that even tcsetpgrp() is not 
called.  I can follow the trace through what must be the init_shout() call 
in init_io(), but it goes awry -- it's as if the 4.0.7 RPM were built with 
#undef JOB_CONTROL.  Yet I *was* having this identical problem with 4.2.0, 
previously, and I built that myself and I did see tcsetpgrp() called (and 
failing) when tracing through 4.2.0 with GDB.

Maybe the RPM builders knew tcsetpgrp() was unreliable and just compiled 
it out entirely, but that seems pretty strange, and there's no mention of
it in the RPM changelog.  (The SRPM is straight from RedHat.)

So perhaps this rates a mention in the MACHINES file, or perhaps not, but 
I guess no change for this is required.  The infinite loop I mentioned 
still bothers me, but I don't have a specific suggestion.

