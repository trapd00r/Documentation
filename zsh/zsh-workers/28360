From zsh-workers-return-28360-mason-zsh=primenet.com.au@zsh.org Tue Oct 19 10:58:16 2010
Return-Path: <zsh-workers-return-28360-mason-zsh=primenet.com.au@zsh.org>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 18041 invoked by alias); 19 Oct 2010 10:58:16 -0000
Mailing-List: contact zsh-workers-help@zsh.org; run by ezmlm
Precedence: bulk
X-No-Archive: yes
List-Id: Zsh Workers List <zsh-workers.zsh.org>
List-Post: <mailto:zsh-workers@zsh.org>
List-Help: <mailto:zsh-workers-help@zsh.org>
Delivered-To: mailing list zsh-workers@zsh.org
X-Seq: 28360
Received: (qmail 28104 invoked from network); 19 Oct 2010 10:58:14 -0000
X-Spam-Checker-Version: SpamAssassin 3.3.1 (2010-03-16) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=BAYES_00,RCVD_IN_DNSWL_LOW,
	SPF_HELO_PASS autolearn=ham version=3.3.1
Received-SPF: none (ns1.primenet.com.au: domain at csr.com does not designate permitted sender hosts)
X-Authentication-Warning: pwslap01u.europe.root.pri: pws owned process doing -bs
To: zsh-workers@zsh.org (Zsh hackers list)
Subject: PATCH: bug with NO_UNSET option
X-Mailer: MH-E 8.2; nmh 1.3; GNU Emacs 23.1.1
Date: Tue, 19 Oct 2010 11:57:55 +0100
Message-ID: <14671.1287485875@csr.com>
From: Peter Stephenson <pws@csr.com>
X-OriginalArrivalTime: 19 Oct 2010 10:57:59.0177 (UTC) FILETIME=[7E0F9790:01CB6F7C]
Content-Type: text/plain
MIME-Version: 1.0
X-Scanned-By: MailControl A-10-90-01 (www.mailcontrol.com) on 10.71.0.121

A discussion on the Austin group mailing list suggests that when the
option NO_UNSET (-u) is in effect, not just ${foo} but ${foo#bar}
etc. should fail if foo is not set.  This was for standards compliance,
but it seems obviously right now it's pointed out so I think it's a
straightforward bug.

Index: Src/subst.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/subst.c,v
retrieving revision 1.107
diff -p -u -r1.107 subst.c
--- Src/subst.c	2 Oct 2010 19:55:30 -0000	1.107
+++ Src/subst.c	19 Oct 2010 10:52:56 -0000
@@ -2649,8 +2649,14 @@ paramsubst(LinkList l, LinkNode n, char 
 		}
 		getmatcharr(&aval, s, flags, flnum, replstr);
 	    } else {
-		if (vunset)
+		if (vunset) {
+		    if (unset(UNSET)) {
+			*idend = '\0';
+			zerr("%s: parameter not set", idbeg);
+			return NULL;
+		    }
 		    val = dupstring("");
+		}
 		if (!copied) {
 		    val = dupstring(val);
 		    copied = 1;
Index: Test/E01options.ztst
===================================================================
RCS file: /cvsroot/zsh/zsh/Test/E01options.ztst,v
retrieving revision 1.22
diff -p -u -r1.22 E01options.ztst
--- Test/E01options.ztst	11 Aug 2008 08:40:57 -0000	1.22
+++ Test/E01options.ztst	19 Oct 2010 10:52:56 -0000
@@ -998,7 +998,7 @@
 >two
 >words
 
-  fn() { unset foo; print $foo; }
+  fn() { unset foo; print value is $foo; }
   setopt nounset
   print option unset unset by setting nounset
   eval fn
@@ -1008,9 +1008,32 @@
 0:UNSET option
 >option unset unset by setting nounset
 >option unset reset
->
+>value is
 ?fn: foo: parameter not set
 
+  fn1() { unset foo; print value 1 is ${foo#bar}; }
+  fn2() { unset foo; print value 2 is ${foo%bar}; }
+  fn3() { unset foo; print value 3 is ${foo/bar}; }
+  setopt nounset
+  print option unset unset by setting nounset
+  eval fn1
+  eval fn2
+  eval fn3
+  print option unset reset
+  setopt unset
+  fn1
+  fn2
+  fn3
+0:UNSET option with operators
+>option unset unset by setting nounset
+>option unset reset
+>value 1 is
+>value 2 is
+>value 3 is
+?fn1: foo: parameter not set
+?fn2: foo: parameter not set
+?fn3: foo: parameter not set
+
   fn() {
     emulate -L zsh
     setopt warncreateglobal

-- 
Peter Stephenson <pws@csr.com>            Software Engineer
Tel: +44 (0)1223 692070                   Cambridge Silicon Radio Limited
Churchill House, Cambridge Business Park, Cowley Road, Cambridge, CB4 0WZ, UK


Member of the CSR plc group of companies. CSR plc registered in England and Wales, registered number 4187346, registered office Churchill House, Cambridge Business Park, Cowley Road, Cambridge, CB4 0WZ, United Kingdom

