From zsh-users-return-12087-mason-zsh=primenet.com.au@sunsite.dk Tue Oct 23 15:59:09 2007
Return-Path: <zsh-users-return-12087-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 10789 invoked from network); 23 Oct 2007 15:59:01 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.3 (2007-08-08) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.3
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 23 Oct 2007 15:59:01 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 31149 invoked from network); 23 Oct 2007 15:58:53 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 23 Oct 2007 15:58:53 -0000
Received: (qmail 8409 invoked by alias); 23 Oct 2007 15:58:45 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 12087
Received: (qmail 8387 invoked from network); 23 Oct 2007 15:58:44 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 23 Oct 2007 15:58:44 -0000
Received: (qmail 30062 invoked from network); 23 Oct 2007 15:58:44 -0000
Received: from cluster-g.mailcontrol.com (85.115.41.190)
  by a.mx.sunsite.dk with SMTP; 23 Oct 2007 15:58:38 -0000
Received: from cameurexb01.EUROPE.ROOT.PRI ([62.189.241.200])
	by rly07g.srv.mailcontrol.com (MailControl) with ESMTP id l9NFtmti006111
	for <zsh-users@sunsite.dk>; Tue, 23 Oct 2007 16:58:19 +0100
Received: from news01 ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.1830);
	 Tue, 23 Oct 2007 16:57:08 +0100
Date: Tue, 23 Oct 2007 16:57:08 +0100
From: Peter Stephenson <pws@csr.com>
To: "Zsh Users" <zsh-users@sunsite.dk>
Subject: Re: Completion problems on cygwin when nocaseglob is set
Message-ID: <20071023165708.41f29476@news01>
In-Reply-To: <DD74FBB8EE28D441903D56487861CD9D225F6859@lonpexch01.citrite.net>
References: <DD74FBB8EE28D441903D56487861CD9D223A0DF0@lonpexch01.citrite.net>
	<20a807210710200509t43730713oa909fce4e0a57940@mail.gmail.com>
	<DD74FBB8EE28D441903D56487861CD9D223A0DF8@lonpexch01.citrite.net>
	<20071022103452.6c0580c6@news01>
	<DD74FBB8EE28D441903D56487861CD9D224E86E7@lonpexch01.citrite.net>
	<20071022123128.2db6000c@news01>
	<DD74FBB8EE28D441903D56487861CD9D224E8A05@lonpexch01.citrite.net>
	<20071023101151.3757a369@news01>
	<DD74FBB8EE28D441903D56487861CD9D225F6432@lonpexch01.citrite.net>
	<200710231156.l9NBuQwA019246@news01.csr.com>
	<DD74FBB8EE28D441903D56487861CD9D225F6859@lonpexch01.citrite.net>
Organization: CSR
X-Mailer: Claws Mail 3.0.2 (GTK+ 2.10.14; i386-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
X-OriginalArrivalTime: 23 Oct 2007 15:57:08.0700 (UTC) FILETIME=[5DB871C0:01C8158D]
X-Scanned-By: MailControl A-07-08-10 (www.mailcontrol.com) on 10.71.0.117

OK, I've found the underlying problem.  The cause is as discussed---"c"
doesn't appear in the directory listing for "/", which still strikes me as
a bug.

I next noticed that "print /c/*" doesn't work.  The reason is that globbing
couldn't find /c.  That #ifdef I pointed out before in pattern.c is
supposed to ensure that we don't do globbing on a directory just because
nocaseglob is in effect on Cygwin, since we'll find files with any case
without having to search.  However, it turns out there's another piece of
code that's turning off the flag that says we've got a straight string that
doesn't need globbing.  Using the same trick here allows us to pick up /c
without globbing to find it again.  c:/* now works again, too.

This means that /c*/* still doesn't find any files under /c, but this time
I think it's a natural and unavoidable consequence of the fact that c
doesn't appear in the directory listing for /.

I haven't looked at fake-files.

Index: Src/pattern.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/pattern.c,v
retrieving revision 1.40
diff -u -r1.40 pattern.c
--- Src/pattern.c	27 Jul 2007 21:51:33 -0000	1.40
+++ Src/pattern.c	23 Oct 2007 15:47:38 -0000
@@ -1167,7 +1167,26 @@
 	 * ..(#a1).. (i.e. the (#a1) has no effect), but if you're
 	 * going to write funny patterns, you get no sympathy from me.
 	 */
-	if (patglobflags & (0xFF|GF_LCMATCHUC|GF_IGNCASE)) {
+	if (patglobflags &
+#ifdef __CYGWIN__
+	    /*
+	     * As above: don't use pattern matching for files
+	     * just because of case insensitivity if file system
+	     * is known to be case insensitive.
+	     *
+	     * This is known to be necessary in at least one case:
+	     * if "mount -c /" is in effect, so that drives appear
+	     * directly under / instead of the usual /cygdrive, they
+	     * aren't shown by readdir().  So it's vital we don't use
+	     * globbing to find "/c", since that'll fail.
+	     */
+	    ((patflags & PAT_FILE) ?
+	    (0xFF|GF_LCMATCHUC) :
+	    (0xFF|GF_LCMATCHUC|GF_IGNCASE))
+#else
+	    (0xFF|GF_LCMATCHUC|GF_IGNCASE)
+#endif
+	    ) {
 	    if (!(patflags & PAT_FILE))
 		flags &= ~P_PURESTR;
 	    else if (!(nptr[0] == '.' &&


-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070

