From zsh-workers-return-20736-mason-zsh=primenet.com.au@sunsite.dk Sat Jan 22 16:23:57 2005
Return-Path: <zsh-workers-return-20736-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 14793 invoked from network); 22 Jan 2005 16:23:56 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 22 Jan 2005 16:23:56 -0000
Received: (qmail 65024 invoked from network); 22 Jan 2005 16:23:50 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 22 Jan 2005 16:23:50 -0000
Received: (qmail 9984 invoked by alias); 22 Jan 2005 16:23:42 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 20736
Received: (qmail 9969 invoked from network); 22 Jan 2005 16:23:41 -0000
Received: from unknown (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 22 Jan 2005 16:23:41 -0000
Received: (qmail 64672 invoked from network); 22 Jan 2005 16:23:05 -0000
Received: from acolyte.scowler.net (216.254.112.45)
  by a.mx.sunsite.dk with SMTP; 22 Jan 2005 16:23:01 -0000
Received: by acolyte.scowler.net (Postfix, from userid 1000)
	id B1C397004A; Sat, 22 Jan 2005 11:22:59 -0500 (EST)
Date: Sat, 22 Jan 2005 11:22:59 -0500
From: Clint Adams <clint@zsh.org>
To: Peter Stephenson <pws@csr.com>
Cc: zsh-workers@sunsite.dk
Subject: Re: PATCH: minor zle_utils fix
Message-ID: <20050122162259.GA12782@scowler.net>
Mail-Followup-To: Peter Stephenson <pws@csr.com>,
	zsh-workers@sunsite.dk
References: <20050116162247.GA26801@scowler.net> <200501171040.j0HAe6mY003515@news01.csr.com> <20050119012630.GA2463@scowler.net> <200501191049.j0JAn8US032409@news01.csr.com>
Mime-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <200501191049.j0JAn8US032409@news01.csr.com>
User-Agent: Mutt/1.5.6+20040907i
X-Spam-Checker-Version: SpamAssassin 3.0.2 on a.mx.sunsite.dk
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=6.0 tests=AWL,BAYES_00 autolearn=ham 
	version=3.0.2
X-Spam-Hits: -2.6

And these:

> We probably also need to metafy the line.  The only call to zlegetline()
[...]
> Same here in the alternative branch: we need to duplicate the first
> zlell characters and metafy.  This is the same as the

M  Src/Zle/zle_utils.c

* modified files

--- orig/Src/Zle/zle_utils.c
+++ mod/Src/Zle/zle_utils.c
@@ -72,14 +72,11 @@
 
 /*
  * Insert a character, called from main shell.
- *
- * WCHAR: type is wrong, should be a genuine wide character,
- * when available in the caller.
  */
 
 /**/
 mod_export void
-zleaddtoline(int chr)
+zleaddtoline(ZLE_CHAR_T chr)
 {
     spaceinline(1);
     zleline[zlecs++] = chr;
@@ -109,15 +106,13 @@
     }
 
     *ll = mb_len;
-
-    return (unsigned char *)s;
 #else
     *ll = zlell;
     *cs = zlecs;
 
     s = ztrdup(zleline);
-    return (unsigned char *)s;
 #endif
+    return (unsigned char *) metafy((char *) s, zlell, META_REALLOC);
 }
 
 

