From zsh-workers-return-23409-mason-zsh=primenet.com.au@sunsite.dk Thu May 10 06:02:32 2007
Return-Path: <zsh-workers-return-23409-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 22170 invoked from network); 10 May 2007 06:02:30 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.0 (2007-05-01) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=no
	version=3.2.0
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 10 May 2007 06:02:30 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 83937 invoked from network); 10 May 2007 06:02:24 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 10 May 2007 06:02:24 -0000
Received: (qmail 18848 invoked by alias); 10 May 2007 06:02:22 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 23409
Received: (qmail 18838 invoked from network); 10 May 2007 06:02:22 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 10 May 2007 06:02:22 -0000
Received: (qmail 83620 invoked from network); 10 May 2007 06:02:22 -0000
Received: from flock1.newmail.ru (82.204.219.207)
  by a.mx.sunsite.dk with SMTP; 10 May 2007 06:02:17 -0000
Received: (qmail 17580 invoked from network); 10 May 2007 06:02:15 -0000
Received: from unknown (HELO cooker.local) (arvidjaar@newmail.ru@85.141.134.196)
  by smtpd.newmail.ru with SMTP; 10 May 2007 06:02:15 -0000
From: Andrey Borzenkov <arvidjaar@newmail.ru>
To: zsh-workers@sunsite.dk
Subject: Re: Prompt redrawing bug with ctrl-d
Date: Thu, 10 May 2007 10:02:03 +0400
User-Agent: KMail/1.9.6
References: <237967ef0705010238y5155269ev1738d449460e3b90@mail.gmail.com> <200705100018.58161.arvidjaar@newmail.ru>
In-Reply-To: <200705100018.58161.arvidjaar@newmail.ru>
MIME-Version: 1.0
Content-Type: multipart/signed;
  boundary="nextPart1874320.aAs57ZTtMg";
  protocol="application/pgp-signature";
  micalg=pgp-sha1
Content-Transfer-Encoding: 7bit
Message-Id: <200705101002.08584.arvidjaar@newmail.ru>

--nextPart1874320.aAs57ZTtMg
Content-Type: text/plain;
  charset="utf-8"
Content-Transfer-Encoding: quoted-printable
Content-Disposition: inline

On Thursday 10 May 2007, Andrey Borzenkov wrote:
> On Tuesday 01 May 2007, Mikael Magnusson wrote:
> > Hello, noticed this a while ago.
> >
> > % zsh -f
> > % setopt ignoreeof
> > % <ctrl-d>
> >
> > zsh: use 'exit' to exit.
> >
> > The prompt is now invisible.
>
> message is displayed using showmsg() that sets "clearflag" which should
> tell zrefresh() to not clear until end of screen (to preserve message).
> Unfortunately this flag has side effect that zrefresh() does not redisplay
> prompt either and skips over it.
>
> Unfortunately I do not see any easy way short of adding yet another flag.=
 I
> have started git cvsimport to try bisect; have no idea how long it takes.

OK here is the attempt to fix it. It is using use_exit_printed as flag and=
=20
moves its resetting a bit later, so flag is available in preprompt (where=20
prompt was overwritten in case promptsp). If there are no objections I'll=20
commit it.

P.S. git cvsimport still runs for over 9 hours now :)

Index: Src/init.c
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D
RCS file: /cvsroot/zsh/zsh/Src/init.c,v
retrieving revision 1.72
diff -u -p -r1.72 init.c
=2D-- Src/init.c  8 Nov 2006 17:43:32 -0000       1.72
+++ Src/init.c  10 May 2007 05:58:39 -0000
@@ -123,6 +123,7 @@ loop(int toplevel, int justonce)
                errflag =3D 0;
            }
        }
+       use_exit_printed =3D 0;
        intr();                 /* interrupts on            */
        lexinit();              /* initialize lexical state */
        if (!(prog =3D parse_event())) {  /* if we couldn't parse a list */
@@ -1335,7 +1336,6 @@ zsh_main(UNUSED(int argc), char **argv)
     init_misc();

     for (;;) {
=2D       use_exit_printed =3D 0;
        /*
         * See if we can free up some of jobtab.
         * We only do this at top level, because if we are
Index: Src/utils.c
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D
RCS file: /cvsroot/zsh/zsh/Src/utils.c,v
retrieving revision 1.163
diff -u -p -r1.163 utils.c
=2D-- Src/utils.c 26 Apr 2007 09:27:44 -0000      1.163
+++ Src/utils.c 10 May 2007 05:58:40 -0000
@@ -1156,7 +1156,7 @@ preprompt(void)
     int period =3D getiparam("PERIOD");
     int mailcheck =3D getiparam("MAILCHECK");

=2D    if (isset(PROMPTSP) && isset(PROMPTCR)) {
+    if (isset(PROMPTSP) && isset(PROMPTCR) && !use_exit_printed) {
        /* The PROMPT_SP heuristic will move the prompt down to a new line
         * if there was any dangling output on the line (assuming the termi=
nal
         * has automatic margins, but we try even if hasam isn't set). */


--nextPart1874320.aAs57ZTtMg
Content-Type: application/pgp-signature

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.7 (GNU/Linux)

iD8DBQBGQrVbR6LMutpd94wRAsgKAJ9TYDrlCXIXJUQ7rp0IZ/0LLIT1MQCfRy6b
9uprMPon+L7V1iSGcxImmLU=
=bImE
-----END PGP SIGNATURE-----

--nextPart1874320.aAs57ZTtMg--

