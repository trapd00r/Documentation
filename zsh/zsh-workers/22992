From zsh-workers-return-22992-mason-zsh=primenet.com.au@sunsite.dk Fri Nov 10 09:41:39 2006
Return-Path: <zsh-workers-return-22992-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 18806 invoked from network); 10 Nov 2006 09:41:33 -0000
X-Spam-Checker-Version: SpamAssassin 3.1.7 (2006-10-05) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.4 required=5.0 tests=AWL,BAYES_00,
	FORGED_RCVD_HELO autolearn=ham version=3.1.7
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 10 Nov 2006 09:41:33 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 30306 invoked from network); 10 Nov 2006 09:41:22 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 10 Nov 2006 09:41:22 -0000
Received: (qmail 22412 invoked by alias); 10 Nov 2006 09:41:17 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 22992
Received: (qmail 22393 invoked from network); 10 Nov 2006 09:41:16 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 10 Nov 2006 09:41:16 -0000
Received: (qmail 29957 invoked from network); 10 Nov 2006 09:41:16 -0000
Received: from cluster-d.mailcontrol.com (217.69.20.190)
  by a.mx.sunsite.dk with SMTP; 10 Nov 2006 09:41:12 -0000
Received: from cameurexb01.EUROPE.ROOT.PRI ([62.189.241.200])
	by rly30d.srv.mailcontrol.com (MailControl) with ESMTP id kAA9f0Mw000487
	for <zsh-workers@sunsite.dk>; Fri, 10 Nov 2006 09:41:00 GMT
Received: from news01.csr.com ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.1830);
	 Fri, 10 Nov 2006 09:40:59 +0000
Received: from news01.csr.com (localhost.localdomain [127.0.0.1])
	by news01.csr.com (8.13.7/8.13.4) with ESMTP id kAA9exDH012586
	for <zsh-workers@sunsite.dk>; Fri, 10 Nov 2006 09:40:59 GMT
Received: from csr.com (pws@localhost)
	by news01.csr.com (8.13.7/8.13.7/Submit) with ESMTP id kAA9ewZY012583
	for <zsh-workers@sunsite.dk>; Fri, 10 Nov 2006 09:40:59 GMT
Message-Id: <200611100940.kAA9ewZY012583@news01.csr.com>
X-Authentication-Warning: news01.csr.com: pws owned process doing -bs
To: zsh-workers@sunsite.dk (Zsh hackers list)
Subject: PATCH: exit status
Date: Fri, 10 Nov 2006 09:40:58 +0000
From: Peter Stephenson <pws@csr.com>
X-OriginalArrivalTime: 10 Nov 2006 09:41:00.0367 (UTC) FILETIME=[549ADDF0:01C704AC]
Content-Type: text/plain
MIME-Version: 1.0
X-Scanned-By: MailControl A-07-06-70 (www.mailcontrol.com) on 10.68.0.140

A thread on the Austin group suggests the exit status of the shell
should be available in exit traps.  This is potentially useful,
particularly since there's no other way of getting the exit status.
It's hard to see how it can cause problems since previously the exit
status wasn't tied to any particular command (it was whatever happened
to run just before the exit) so didn't have a useful value inside the
trap.

There was one special case: on an implicit exit it always was and still
is the status of the last command before exit, however as you couldn't
tell if it was an implicit exit from the trap even that wasn't
particularly useful.

This will apply inside the next zshexit hooks, too.  It already applies
to traps on return from functions---that's a separate piece of code.
(It's preserved if multiple functions/hooks run; this is already handled
by the context used for a trap or hook.)

Obviously the status is only available until the first statement within
the trap/hook has run.

Index: Doc/Zsh/builtins.yo
===================================================================
RCS file: /cvsroot/zsh/zsh/Doc/Zsh/builtins.yo,v
retrieving revision 1.87
diff -u -r1.87 builtins.yo
--- Doc/Zsh/builtins.yo	20 Sep 2006 09:22:34 -0000	1.87
+++ Doc/Zsh/builtins.yo	10 Nov 2006 09:37:12 -0000
@@ -1252,6 +1252,8 @@
 If var(sig) is tt(0) or tt(EXIT)
 and the tt(trap) statement is executed inside the body of a function,
 then the command var(arg) is executed after the function completes.
+The value of tt($?) at the start of execution is the exit status of the
+shell or the return status of the function exiting.
 If var(sig) is tt(0) or tt(EXIT)
 and the tt(trap) statement is not executed inside the body of a function,
 then the command var(arg) is executed when the shell terminates.
Index: Doc/Zsh/func.yo
===================================================================
RCS file: /cvsroot/zsh/zsh/Doc/Zsh/func.yo,v
retrieving revision 1.14
diff -u -r1.14 func.yo
--- Doc/Zsh/func.yo	9 Nov 2006 11:04:11 -0000	1.14
+++ Doc/Zsh/func.yo	10 Nov 2006 09:37:12 -0000
@@ -248,6 +248,8 @@
 item(tt(TRAPEXIT))(
 Executed when the shell exits,
 or when the current function exits if defined inside a function.
+The value of tt($?) at the start of execution is the exit status of the
+shell or the return status of the function exiting.
 )
 findex(TRAPZERR)
 findex(TRAPERR)
Index: Src/builtin.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/builtin.c,v
retrieving revision 1.168
diff -u -r1.168 builtin.c
--- Src/builtin.c	9 Nov 2006 11:04:11 -0000	1.168
+++ Src/builtin.c	10 Nov 2006 09:37:14 -0000
@@ -4434,6 +4434,7 @@
 #endif
 	}
     }
+    lastval = val;
     if (sigtrapped[SIGEXIT])
 	dotrap(SIGEXIT);
     callhookfunc("zshexit", NULL, 1);


-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070


To access the latest news from CSR copy this link into a web browser:  http://www.csr.com/email_sig.php

