From zsh-users-return-12564-mason-zsh=primenet.com.au@sunsite.dk Thu Feb 14 03:55:24 2008
Return-Path: <zsh-users-return-12564-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 29336 invoked from network); 14 Feb 2008 03:55:22 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.4 (2008-01-01) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.4
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 14 Feb 2008 03:55:22 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 83024 invoked from network); 14 Feb 2008 03:55:12 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 14 Feb 2008 03:55:12 -0000
Received: (qmail 24813 invoked by alias); 14 Feb 2008 03:54:54 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 12564
Received: (qmail 24793 invoked from network); 14 Feb 2008 03:54:53 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 14 Feb 2008 03:54:53 -0000
Received: from flock1.newmail.ru (flock1.newmail.ru [82.204.219.207])
	by bifrost.dotsrc.org (Postfix) with SMTP id ED9D180482A1
	for <zsh-users@sunsite.dk>; Thu, 14 Feb 2008 04:54:45 +0100 (CET)
Received: (qmail 6871 invoked from network); 14 Feb 2008 03:54:44 -0000
Received: from unknown (HELO cooker.net) (arvidjaar@newmail.ru@91.77.252.164)
  by smtpd.newmail.ru with SMTP; 14 Feb 2008 03:54:44 -0000
From: Andrey Borzenkov <arvidjaar@newmail.ru>
To: zsh-users@sunsite.dk
Subject: Re: Phil's prompt is not working when LANG is set to UTF-8
Date: Thu, 14 Feb 2008 06:54:36 +0300
User-Agent: KMail/1.9.6 (enterprise 0.20071123.740460)
References: <20080211033116.GD19613@phoenix.nasreddine.info> <200802132201.21702.arvidjaar@newmail.ru> <20080214022813.GB11647@phoenix.nasreddine.info>
In-Reply-To: <20080214022813.GB11647@phoenix.nasreddine.info>
MIME-Version: 1.0
Content-Type: multipart/signed;
  boundary="nextPart10940177.ykxtZi1px6";
  protocol="application/pgp-signature";
  micalg=pgp-sha1
Content-Transfer-Encoding: 7bit
Message-Id: <200802140654.42913.arvidjaar@newmail.ru>
X-Virus-Scanned: ClamAV 0.91.2/5805/Thu Feb 14 00:29:12 2008 on bifrost
X-Virus-Status: Clean

--nextPart10940177.ykxtZi1px6
Content-Type: text/plain;
  charset="utf-8"
Content-Transfer-Encoding: quoted-printable
Content-Disposition: inline

On Thursday 14 February 2008, Wael Nasreddine wrote:
> This One Time, at Band Camp, Andrey Borzenkov <arvidjaar@newmail.ru> said=
, On=20
Wed, Feb 13, 2008 at 10:01:21PM +0300:
> > On Wednesday 13 February 2008, Andrey Borzenkov wrote:
> > > On Monday 11 February 2008, Peter Stephenson wrote:
>=20
> > > > On Mon, 11 Feb 2008 16:07:09 +0100
> > > > antho.charles@gmail.com wrote:
> > > > > I didn't have this problem on Debian etch, but it appears when I
> > > > > upgraded to lenny. It's the same problem: if I set LANG to a non =
utf8
> > > > > encoding (fr_FR instead of fr_FR.UTF-8), RPROMPT is good, otherwi=
se
> > > > > it's partially on another line and the cusor is after RPROMPT.
> > > > > (cf. http://tinyurl.com/3xjeqt)
>=20
> > > > Sounds like it ought to be fairly reproducible, but it's not happen=
ing=20
on
> > > > Fedora 8 (and it still sounds suspiciously like the shell is gettin=
g=20
duff
> > > > information about the environment, though that's certainly not the =
only
> > > > possibility).  I've tried adding multibyte characters to the comman=
d=20
line
> > > > and complicating the RPROMPT and even adding multibyte characters t=
o=20
that,
> > > > but it still works OK.
>=20
> > > > Are there any particular things on the command line, forms of RPROM=
PT=20
etc.
> > > > etc. that show this up?  (We really need something that narrows thi=
s=20
down.)
>=20
>=20
> > > I can reproduce it on Mandriva cooker with locale en_US.UTF-8 or=20
ru_RU.UTF-8.=20
> > It=20
> > > does not matter whether there are UTF-8 characters on the screen (at=
=20
least, I=20
> > am=20
> > > not sure whether there are - en_US.UTF-8 should not emit any non-ASCI=
I=20
strings=20
> > > as far as I can tell).
>=20
>=20
> > Actually the problem seems to be that terminal description contains=20
non-UTF-8=20
> > conform characters.
>=20
> > {pts/0}% infocmp | grep acsc
> >         acsc=3D``aaffggiijjkkllmmnnooppqqrrssttuuvvwwxxyyzz{{||}}~~,
> > {pts/0}% infocmp linux | grep acsc
> >         acsc=3D+\020\,
> >=20
\021-\030.^Y0\333`\004a\261f\370g\361h\260i\316j\331k\277l\332m\300n\305o~p=
\304q\304r\304s_t\303u\264v\301w\302x\263y\363z\362
> > {\343|\330}\234~\376,
>=20
> > the first one is for dtterm, the second - for linux console.
>=20
> > The prompt is using q, l, m, j, k - at least some of them have high bit=
 set.
>=20
> > So something gets confused computing prompt width. I am not really sure
> > how to fix it except teaching zsh about ACS mode. Is there any curses=20
function
> > that would return screen width of character string?
>=20
> Maybe that's the reason, but changing TERM has no effect whatsoever,

But replacing all ACS characters with space has:

    PR_SET_CHARSET=3D""
    PR_SHIFT_IN=3D""
    PR_SHIFT_OUT=3D""
    PR_HBAR=3D' '
    PR_ULCORNER=3D' '
    PR_LLCORNER=3D' '
    PR_LRCORNER=3D' '
    PR_URCORNER=3D' '

If you have time you could try them one by one to see which one(s) break pr=
ompt.

--nextPart10940177.ykxtZi1px6
Content-Type: application/pgp-signature; name=signature.asc 
Content-Description: This is a digitally signed message part.

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.8 (GNU/Linux)

iEYEABECAAYFAkezu30ACgkQR6LMutpd94yO+wCfdz9ISk8cqPpPbytgBQXazsPO
1poAoMjQT9lD/Zz4pDApYCiq8a/kmHte
=3tlD
-----END PGP SIGNATURE-----

--nextPart10940177.ykxtZi1px6--

