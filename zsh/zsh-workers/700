From zsh-workers-request@euclid.skiles.gatech.edu  Wed Jan  3 08:22:02 1996
Received: from euclid.skiles.gatech.edu (euclid.skiles.gatech.edu [130.207.146.50]) by werple.net.au (8.7/8.7.1) with ESMTP id IAA18884 for <mason@werple.mira.net.au>; Wed, 3 Jan 1996 08:21:58 +1100 (EST)
Received: (from list@localhost) by euclid.skiles.gatech.edu (8.7.3/8.7.3) id QAA12638; Tue, 2 Jan 1996 16:05:31 -0500 (EST)
Resent-Date: Tue, 2 Jan 1996 16:05:31 -0500 (EST)
From: Zoltan Hidvegi <hzoli@cs.elte.hu>
Message-Id: <199601022106.WAA02430@bolyai.cs.elte.hu>
Subject: Important bugfix to beta13
To: zsh-workers@math.gatech.edu (zsh-workers)
Date: Tue, 2 Jan 1996 22:06:02 +0100 (MET)
Organization: Dept. of Comp. Sci., Eotvos University, Budapest, Hungary
Phone: (36 1)2669833 ext: 2667, home phone: (36 1) 2752368
X-Mailer: ELM [version 2.4 PL24 PGP3 *ALPHA*]
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
Resent-Message-ID: <"njSvo2.0.O53.QuPwm"@euclid>
Resent-From: zsh-workers@math.gatech.edu
X-Mailing-List: <zsh-workers@math.gatech.edu> archive/latest/700
X-Loop: zsh-workers@math.gatech.edu
Precedence: list
Resent-Sender: zsh-workers-request@math.gatech.edu

The patch below fixes a serious bug in doexpandhist.  So far each completion
used some already freed memory but it was only noticable on long lines.  This
caused strange random crashes sometimes (e.g. when editing files in zed
when magic-space is bound to space).  The patch is against the vanilla beta13
release.

Cheers,

Zoltan

diff -u Src/zle_tricky.c.orig Src/zle_tricky.c
--- Src/zle_tricky.c.orig	Tue Jan  2 21:52:36 1996
+++ Src/zle_tricky.c	Tue Jan  2 21:55:28 1996
@@ -3863,8 +3863,6 @@
     errflag = zleparse = 0;
     lexrestore();
     expanding = 0;
-    popheap();
-    permalloc();
     cs = (ce ? ll : excs);
 
     /* Compensate for the added space above. */
@@ -3883,6 +3881,8 @@
 	references like everything else, rather than doing the whole line? */
 	if (viinsbegin > findbol())
 	    viinsbegin = findbol();
+	popheap();
+	permalloc();
 	return 1;
     }
 
@@ -3890,6 +3890,8 @@
     ll = oll;
     cs = ocs;
 
+    popheap();
+    permalloc();
     return 0;
 }
 

