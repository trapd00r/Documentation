From zsh-workers-return-24854-mason-zsh=primenet.com.au@sunsite.dk Mon Apr 21 09:57:21 2008
Return-Path: <zsh-workers-return-24854-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 28559 invoked from network); 21 Apr 2008 09:57:19 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.4 (2008-01-01) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.4
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 21 Apr 2008 09:57:19 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 27116 invoked from network); 21 Apr 2008 09:57:14 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 21 Apr 2008 09:57:14 -0000
Received: (qmail 17681 invoked by alias); 21 Apr 2008 09:57:10 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 24854
Received: (qmail 17664 invoked from network); 21 Apr 2008 09:57:09 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 21 Apr 2008 09:57:09 -0000
Received: from rcpt-expgw.biglobe.ne.jp (rcpt-expgw.biglobe.ne.jp [133.205.19.66])
	by bifrost.dotsrc.org (Postfix) with ESMTP id ECE3B808A37A
	for <zsh-workers@sunsite.dk>; Mon, 21 Apr 2008 11:57:00 +0200 (CEST)
Received: from smtp-gw.biglobe.ne.jp
	by rcpt-expgw.biglobe.ne.jp (kbkr/0208160408) with ESMTP id m3L9uu6L022575
	for <zsh-workers@sunsite.dk>; Mon, 21 Apr 2008 18:56:56 +0900
X-Biglobe-Sender: <takimoto-j@kba.biglobe.ne.jp>
Received: from [133.24.86.14] (133.24.86.14 [133.24.86.14]) by smtp-gw.biglobe.ne.jp
	id SAPRAC15AFD5; Mon, 21 Apr 2008 18:56:56 +0900 (JST)
Mime-Version: 1.0
X-Mailer: QUALCOMM MacOS X Eudora Version 6.2J rev3.3
Message-Id: <a06001004c43214de24b1@kba.biglobe.ne.jp>
Date: Mon, 21 Apr 2008 18:56:55 +0900
To: zsh-workers@sunsite.dk
From: "Jun T." <takimoto-j@kba.biglobe.ne.jp>
Subject: completing in the middle of the command line causes coredump
Content-Type: text/plain; charset="us-ascii"
X-Virus-Scanned: ClamAV 0.91.2/6861/Mon Apr 21 09:50:29 2008 on bifrost
X-Virus-Status: Clean

zsh (the latest CVS) coredumps while completing in the middle of the command line.

zsh -f
setopt combiningchars
ls a<TAB>       # this is OK
ls a<^B><TAB>   # coredump

Here, <^B> is to move the cursor back to 'a'.
zsh coredumps if you hit <TAB> when the cursor is on 'a'.

coredump is at line 58 of zle_move.c:

58          if (!iswpunct(zleline[loccs]) || wcwidth(zleline[loccs]) != 0)

zleline is NULL because the command line is metafied.

If there is no files staring with 'a' in the current directory, the gdb back
trace is

(gdb) bt
#0  0x00215584 in alignmultiwordleft (pos=0x236c40, setpos=0) at zle_move.c:58
#1  0x00215725 in alignmultiwordright (pos=0x236c40, setpos=1) at zle_move.c:98
#2  0x0022a96f in foredel (ct=4, flags=4) at zle_utils.c:667
#3  0x000ddc7d in do_completion (dummy=0x2363d4, dat=0xbffff584) at compcore.c:352
#4  0x0004e95a in runhookdef (h=0x2363d4, d=0xbffff584) at module.c:996
#5  0x00227142 in docompletion (s=0x310de0 "a", lst=0, incmd=0) at zle_tricky.c:2135
#6  0x00222d22 in docomplete (lst=0) at zle_tricky.c:859
#7  0x002215f5 in expandorcomplete (args=0x236320) at zle_tricky.c:315
#8  0x0020fe32 in execzlefunc (func=0x2341f0, args=0x236320, set_bindk=0) at zle_main.c:1298
#9  0x0020f20d in zlecore () at zle_main.c:1043
#10 0x0020f9e4 in zleread (lp=0xa1f60, rp=0x0, flags=3, context=0) at zle_main.c:1205
#11 0x000391d4 in inputline () at input.c:278
#12 0x00038fe6 in ingetc () at input.c:214
#13 0x0002d74d in ihgetc () at hist.c:240
#14 0x00041fa2 in gettok () at lex.c:663
#15 0x00041484 in yylex () at lex.c:350
#16 0x00060739 in parse_event () at parse.c:451
#17 0x00035400 in loop (toplevel=1, justonce=0) at init.c:129
#18 0x00038b64 in zsh_main (argc=2, argv=0xbffffb3c) at init.c:1352
#19 0x00001b6a in main (argc=2, argv=0xbffffb3c) at main.c:93
(gdb) 

If there are files staring with 'a', #0 to #4 is replaced by the following 5 lines:

(gdb) bt
#0  0x00215584 in alignmultiwordleft (pos=0x236c40, setpos=0) at zle_move.c:58
#1  0x00215725 in alignmultiwordright (pos=0x236c40, setpos=1) at zle_move.c:98
#2  0x0022a96f in foredel (ct=3, flags=4) at zle_utils.c:667
#3  0x000f171a in do_single (m=0x314410) at compresult.c:981
#4  0x000ddff3 in do_completion (dummy=0x2363d4, dat=0xbffff584) at compcore.c:413
#5  0x0004e95a in runhookdef (h=0x2363d4, d=0xbffff584) at module.c:996

