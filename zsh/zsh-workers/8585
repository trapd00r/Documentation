From zsh-workers-return-8585-mason-zsh=primenet.com.au@sunsite.auc.dk Mon Nov 08 03:16:51 1999
Return-Path: <zsh-workers-return-8585-mason-zsh=primenet.com.au@sunsite.auc.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 15664 invoked from network); 8 Nov 1999 03:16:50 -0000
Received: from sunsite.auc.dk (130.225.51.30)
  by ns1.primenet.com.au with SMTP; 8 Nov 1999 03:16:50 -0000
Received: (qmail 17842 invoked by alias); 8 Nov 1999 03:09:57 -0000
Mailing-List: contact zsh-workers-help@sunsite.auc.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.auc.dk
X-Seq: 8585
Received: (qmail 17835 invoked from network); 8 Nov 1999 03:09:57 -0000
Date: Sun, 7 Nov 1999 22:09:50 -0500
From: Clint Adams <schizo@debian.org>
To: zsh-workers@sunsite.auc.dk
Subject: PATCH: line count imprecision in calclist()
Message-ID: <19991107220950.A21153@dman.com>
Mime-Version: 1.0
Content-Type: text/plain; charset=us-ascii
User-Agent: Mutt/1.0pre4i

To recreate, run zsh -f in an 80x24, compctl (to load completion modules),
and then the following:

mkdir -p /tmp/xxxxx/yyy/zzzzz
cd /tmp/xxxxx/yyy/zzzzz
touch aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
touch bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
touch cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
touch ddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddd
touch eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
touch fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
touch gggg
touch hhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhh
touch iiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiii
touch jjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjj
touch kkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkk
touch lllllllllllllllllllllllllllllllllllllllllllllllllllllllllllllllllllllllllllllllllll
touch mmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmm
mkdir ppppppp


You should now have a situation wherein you can type

ls /tmp/xxxxx/yyy/zzzzz/<TAB>

and find your cursor a line too high.  Behavior is normal if no scrolling
occurs.  If you rename the i+ file to something two characters shorter,
the cursor will be two lines too high.

It seems to have something to do with
 	glines += 1 + ((1 + mlens[m->gnum]) / columns);
in calclist() when mlens[m->gnum] is 79 (and therefore glines += 2).


This seems to correct the problem..

--- compresult.c        1999/11/05 09:10:44     1.1.1.3
+++ compresult.c        1999/11/08 03:05:58
@@ -1287,7 +1287,7 @@
                                if (!(m->flags & CMF_DISPLINE))
                                    glines += 1 + (mlens[m->gnum] / columns);
                            } else if (!(m->flags & CMF_NOLIST))
-                               glines += 1 + ((1 + mlens[m->gnum]) / columns);
+                               glines += 1 + ((mlens[m->gnum]) / columns);
                        }
                }
            }

However, it makes me uneasy that something will break elsewhere.

