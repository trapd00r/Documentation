From zsh-workers-return-19299-mason-zsh=primenet.com.au@sunsite.dk Tue Dec 16 16:06:33 2003
Return-Path: <zsh-workers-return-19299-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 893 invoked from network); 16 Dec 2003 16:06:33 -0000
Received: from sunsite.dk (130.225.247.90)
  by ns1.primenet.com.au with SMTP; 16 Dec 2003 16:06:33 -0000
Received: (qmail 5741 invoked by alias); 16 Dec 2003 16:06:24 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 19299
Received: (qmail 5708 invoked from network); 16 Dec 2003 16:06:24 -0000
Received: from localhost (HELO sunsite.dk) (127.0.0.1)
  by localhost with SMTP; 16 Dec 2003 16:06:24 -0000
X-MessageWall-Score: 0 (sunsite.dk)
Received: from [193.109.254.211] by sunsite.dk (MessageWall 1.0.8) with SMTP; 16 Dec 2003 16:6:23 -0000
X-VirusChecked: Checked
X-Env-Sender: okiddle@yahoo.co.uk
X-Msg-Ref: server-7.tower-36.messagelabs.com!1071590781!2514400
X-StarScan-Version: 5.1.15; banners=-,-,-
Received: (qmail 21482 invoked from network); 16 Dec 2003 16:06:21 -0000
Received: from iris.logica.co.uk (158.234.9.163)
  by server-7.tower-36.messagelabs.com with SMTP; 16 Dec 2003 16:06:21 -0000
Received: from gmcs3.local ([158.234.142.61])
	by iris.logica.co.uk (8.12.3/8.12.3/Debian -4) with ESMTP id hBGG6LuB002482
	for <zsh-workers@sunsite.dk>; Tue, 16 Dec 2003 16:06:21 GMT
Received: from gmcs3.local (localhost [127.0.0.1])
	by gmcs3.local (8.11.6/8.11.6/SuSE Linux 0.5) with ESMTP id hBGG9mr13560
	for <zsh-workers@sunsite.dk>; Tue, 16 Dec 2003 17:09:48 +0100
X-VirusChecked: Checked
X-StarScan-Version: 5.1.13; banners=.,-,-
From: Oliver Kiddle <okiddle@yahoo.co.uk>
To: Zsh workers <zsh-workers@sunsite.dk>
Subject: PATCH: completing devices in _mount
Date: Tue, 16 Dec 2003 17:09:48 +0100
Message-ID: <13558.1071590988@gmcs3.local>

_mount used to do compadd /dev/* for completing devices. This was
annoying because it couldn't complete things like /dev/dsk/c0t0d0s0. In
19244, I tried changing it to use _files but this has problems because
of the /dev prefix and because it is used with _alternative for mount
point completion. Debian bug 223291 (which this fixes) concerns this
problem.

I think the best solution is perhaps this below. A user can always use a
file-patterns style if they want to group mount points separately from
devices.

Oliver

Index: Completion/Unix/Command/_mount
===================================================================
RCS file: /cvsroot/zsh/zsh/Completion/Unix/Command/_mount,v
retrieving revision 1.16
diff -u -r1.16 _mount
--- Completion/Unix/Command/_mount	14 Nov 2003 11:56:55 -0000	1.16
+++ Completion/Unix/Command/_mount	16 Dec 2003 15:59:23 -0000
@@ -771,9 +771,11 @@
       'directories:mount point:compadd -a mp_tmp' && ret=0
     ;;
   *)
-    _alternative \
-      'devices:device:_files -P /dev/ -W /dev' \
-      'directories:mount point:_directories' && ret=0
+    if (( ${${(s.,.)opt_args[-o]}[(I)loop(|=*)]} )) ; then
+      _wanted device-files expl 'loop device file' _files && ret=0
+    else
+      _wanted files expl 'device or mount point' _files -g "*(-%,-/)" && ret=0
+    fi
     ;;
   esac
   ;;

