From zsh-users-return-15635-mason-zsh=primenet.com.au@zsh.org Tue Dec 07 17:30:43 2010
Return-Path: <zsh-users-return-15635-mason-zsh=primenet.com.au@zsh.org>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 24534 invoked by alias); 7 Dec 2010 17:30:42 -0000
Mailing-List: contact zsh-users-help@zsh.org; run by ezmlm
Precedence: bulk
X-No-Archive: yes
List-Id: Zsh Users List <zsh-users.zsh.org>
List-Post: <mailto:zsh-users@zsh.org>
List-Help: <mailto:zsh-users-help@zsh.org>
Delivered-To: mailing list zsh-users@zsh.org
X-Seq: 15635
Received: (qmail 4641 invoked from network); 7 Dec 2010 17:30:39 -0000
X-Spam-Checker-Version: SpamAssassin 3.3.1 (2010-03-16) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-1.9 required=5.0 tests=BAYES_00,RCVD_IN_DNSWL_NONE
	autolearn=ham version=3.3.1
Received-SPF: none (ns1.primenet.com.au: domain at closedmail.com does not designate permitted sender hosts)
From: Bart Schaefer <schaefer@brasslantern.com>
Message-id: <101207093000.ZM3911@torch.brasslantern.com>
Date: Tue, 07 Dec 2010 09:30:00 -0800
In-reply-to: <20101207122457.GP1727@prunille.vinc17.org>
Comments: In reply to Vincent Lefevre <vincent@vinc17.net>
 "Re: exit status problem" (Dec  7,  1:24pm)
References: <20101203152438.GL1727@prunille.vinc17.org>
	<20101203160916.42e78913@pwslap01u.europe.root.pri>
	<20101204010313.GM1727@prunille.vinc17.org>
	<101204113617.ZM6156@torch.brasslantern.com>
	<20101206112436.GN1727@prunille.vinc17.org>
	<101206082142.ZM2316@torch.brasslantern.com>
	<20101206190912.GO1727@prunille.vinc17.org>
	<101206201638.ZM2809@torch.brasslantern.com>
	<20101207122457.GP1727@prunille.vinc17.org>
X-Mailer: OpenZMail Classic (0.9.2 24April2005)
To: zsh-users@zsh.org
Subject: Re: exit status problem
MIME-version: 1.0
Content-type: text/plain; charset=us-ascii

On Dec 7,  1:24pm, Vincent Lefevre wrote:
}
} Yes, when I hit [Enter], the following two things occurred:
} 1. the current prompt (shown in Screenshot 1) was *replaced* by
}    the one with 16:00:03;
} 2. a new prompt was printed (the one with 16:00:37).
} 
} I think that (1) should have been done at resize time. That would
} also solve the problem mentioned above about %*.
} 
} [...] there are the same problems with GNOME Terminal. So, I think
} that the bug is in zsh. Are you sure that zsh flushes its output?

zrefresh() definitely calls fflush(shout), but refreshline() (which
is sometimes called after the flush) seems ultimately to be relying
on fputc() [at the end of a convoluted path through various macros
and wide character handling].

You could try applying this hunk to Src/Zle/zle_refresh.c to see if
that appears to clear up the problem [this is at the very end of
refreshline()] but I'm not confident that's the best place to call
fflush() for the general case.  (Line numbers may be inaccurate.)

@@ -2069,6 +2124,8 @@
 		 (nl->chr == WEOF && ol->chr));
 #endif
     }
+
+    fflush(shout);
 }
 
 /* move the cursor to line ln (relative to the prompt line),

