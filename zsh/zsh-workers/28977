From zsh-workers-return-28977-mason-zsh=primenet.com.au@zsh.org Wed Apr 06 00:01:07 2011
Return-Path: <zsh-workers-return-28977-mason-zsh=primenet.com.au@zsh.org>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 10726 invoked by alias); 6 Apr 2011 00:01:07 -0000
Mailing-List: contact zsh-workers-help@zsh.org; run by ezmlm
Precedence: bulk
X-No-Archive: yes
List-Id: Zsh Workers List <zsh-workers.zsh.org>
List-Post: <mailto:zsh-workers@zsh.org>
List-Help: <mailto:zsh-workers-help@zsh.org>
Delivered-To: mailing list zsh-workers@zsh.org
X-Seq: 28977
Received: (qmail 9088 invoked from network); 6 Apr 2011 00:01:05 -0000
X-Spam-Checker-Version: SpamAssassin 3.3.1 (2010-03-16) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=BAYES_00,DKIM_SIGNED,
	DKIM_VALID,RCVD_IN_DNSWL_LOW autolearn=ham version=3.3.1
Received-SPF: pass (ns1.primenet.com.au: SPF record at _spf.google.com designates 209.85.160.43 as permitted sender)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=gamma;
        h=domainkey-signature:mime-version:sender:date:x-google-sender-auth
         :message-id:subject:from:to:content-type;
        bh=QWng/tCkuINeYJZmiQk9yPo7LFRxFrGpA8LFSOjOqOU=;
        b=n0SeExkGqP+GjMVAwOgvrRd/C+t500Nl1ciASFh6jRJaCVwHjkexrn1BSlrTnlCMuI
         UcdwA+uZwnllyucCayZscsJ5ZQtYK9hMSa4uoo/JVQzVmrSD0wQZU1D6Z9hhA2KQN0/V
         brzv6vkhxFOdK1fjL8Ee1uo9SY1yHsICl3MVU=
DomainKey-Signature: a=rsa-sha1; c=nofws;
        d=gmail.com; s=gamma;
        h=mime-version:sender:date:x-google-sender-auth:message-id:subject
         :from:to:content-type;
        b=q/Kjt9Z+2zaAV2AJmTR/s8Xti46hbpJlZBvE46Zzv7LaFAp9jXebR6x6UCsa3rBRid
         jKqzE2fAmVqrfEGotzV05bTcZAix/aptnOfar6PRZIxkPNoBXY4lIp4//waFJRBPOreV
         KOKC62Bx2lorUIxodGc3Cfdug51ipYkwTQjc0=
MIME-Version: 1.0
Sender: 4wayned@gmail.com
Date: Tue, 5 Apr 2011 16:54:30 -0700
X-Google-Sender-Auth: yv5Pppwv1ky1OTzm38wjxs6fkvc
Message-ID: <BANLkTimU9q+xRj4Ay9n3YrtFyNnJ8Vvn7A@mail.gmail.com>
Subject: Uninitialized strcpy in spname() for long strings
From: Wayne Davison <wayned@users.sourceforge.net>
To: Zsh list <zsh-workers@zsh.org>
Content-Type: multipart/mixed; boundary=001636e1fd84e60b5804a03498f8

--001636e1fd84e60b5804a03498f8
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: quoted-printable

I was testing a really long command-line arg to a program, and zsh
kept either prompting me for a corrupted correction, or crashing.
Turns out that the spname() function has a problem in it where a
really long path component (whether it really is or not) can cause the
thresh value to be larger than the maximum distance value that
mindist() can return, which causes spname() to copy an uninitialized
buffer (spnamebest). =C2=A0Several possible fixes come to mind:

 - Set thresh to a maximum of 100, so the ">=3D" check will not think
mindist() succeeded when it failed.

 - Skip the call to mindist() if the length of the string is greater
than NAME_MAX.  At that max length, thresh can't be larger than the
maximal dist return (100 > 255/4+1).

Some combination of the two.

I'm attaching the simplest of the two changes which avoids the copying
of uninitialized memory.  I'll check this in, and if anyone wants to
tweak it further, feel free.

..wayne..

--001636e1fd84e60b5804a03498f8
Content-Type: text/x-patch; charset=US-ASCII; name="uninitialized-copy.patch"
Content-Disposition: attachment; filename="uninitialized-copy.patch"
Content-Transfer-Encoding: base64
X-Attachment-Id: f_gm5hgxre0

aW5kZXggOTg1NzMwMy4uMjJiZmZhMiAxMDA2NDQKLS0tIGEvU3JjL3V0aWxzLmMKKysrIGIvU3Jj
L3V0aWxzLmMKQEAgLTM2ODQsNiArMzY4NCw4IEBAIHNwbmFtZShjaGFyICpvbGRuYW1lKQogCXRo
cmVzaCA9IChpbnQpKHAgLSBzcG5hbWVndWVzcykgLyA0ICsgMTsKIAlpZiAodGhyZXNoIDwgMykK
IAkgICAgdGhyZXNoID0gMzsKKwllbHNlIGlmICh0aHJlc2ggPiAxMDApCisJICAgIHRocmVzaCA9
IDEwMDsKIAlpZiAoKHRoaXNkaXN0ID0gbWluZGlzdChuZXduYW1lLCBzcG5hbWVndWVzcywgc3Bu
YW1lYmVzdCkpID49IHRocmVzaCkgewogCSAgICAvKiBUaGUgbmV4dCB0ZXN0IGlzIGFsd2F5cyB0
cnVlLCBleGNlcHQgZm9yIHRoZSBmaXJzdCBwYXRoICAgICoKIAkgICAgICogY29tcG9uZW50LiAg
V2UgY291bGQgaW5pdGlhbGl6ZSBiZXN0ZGlzdCB0byBzb21lIGxhcmdlICAgICAqCg==
--001636e1fd84e60b5804a03498f8--

