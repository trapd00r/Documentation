From zsh-workers-return-25733-mason-zsh=primenet.com.au@sunsite.dk Tue Sep 23 16:46:24 2008
Return-Path: <zsh-workers-return-25733-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 7043 invoked from network); 23 Sep 2008 16:46:20 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 23 Sep 2008 16:46:20 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 50456 invoked from network); 23 Sep 2008 16:46:15 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 23 Sep 2008 16:46:15 -0000
Received: (qmail 7248 invoked by alias); 23 Sep 2008 16:46:09 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 25733
Received: (qmail 7225 invoked from network); 23 Sep 2008 16:46:08 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 23 Sep 2008 16:46:08 -0000
Received: from cluster-d.mailcontrol.com (cluster-d.mailcontrol.com [217.69.20.190])
	by bifrost.dotsrc.org (Postfix) with ESMTPS id 2A23280307AB
	for <zsh-workers@sunsite.dk>; Tue, 23 Sep 2008 18:45:59 +0200 (CEST)
Received: from cameurexb01.EUROPE.ROOT.PRI ([193.128.72.68])
	by rly40d.srv.mailcontrol.com (MailControl) with ESMTP id m8NGjtJC028641
	for <zsh-workers@sunsite.dk>; Tue, 23 Sep 2008 17:45:58 +0100
Received: from news01.csr.com ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.3959);
	 Tue, 23 Sep 2008 17:45:50 +0100
Received: from news01.csr.com (localhost.localdomain [127.0.0.1])
	by news01.csr.com (8.14.2/8.13.4) with ESMTP id m8NGjjm3016812
	for <zsh-workers@sunsite.dk>; Tue, 23 Sep 2008 17:45:45 +0100
Received: from csr.com (pws@localhost)
	by news01.csr.com (8.14.2/8.14.2/Submit) with ESMTP id m8NGjj9w016808
	for <zsh-workers@sunsite.dk>; Tue, 23 Sep 2008 17:45:45 +0100
X-Authentication-Warning: news01.csr.com: pws owned process doing -bs
To: zsh-workers@sunsite.dk (Zsh hackers list)
Subject: PATCH: vcs_info: Perforce revision numbers and backend names
X-Mailer: MH-E 8.0.3; nmh 1.3; GNU Emacs 22.1.1
Date: Tue, 23 Sep 2008 17:45:45 +0100
Message-ID: <16807.1222188345@csr.com>
From: Peter Stephenson <pws@csr.com>
X-OriginalArrivalTime: 23 Sep 2008 16:45:50.0760 (UTC) FILETIME=[D6336A80:01C91D9B]
X-Scanned-By: MailControl A-08-50-15 (www.mailcontrol.com) on 10.68.0.150
X-Virus-Scanned: ClamAV 0.92.1/8316/Tue Sep 23 11:40:56 2008 on bifrost
X-Virus-Status: Clean

This fixes up revision numbers in Perforce---it's taken to be the
most recent change to which the hierarchy from the current directory
down is synced, which is about the best I can do in a single
number---and also adds the abbreviation for each backend to the initial
list.

Index: Doc/Zsh/contrib.yo
===================================================================
RCS file: /cvsroot/zsh/zsh/Doc/Zsh/contrib.yo,v
retrieving revision 1.89
diff -u -r1.89 contrib.yo
--- Doc/Zsh/contrib.yo	23 Sep 2008 16:11:01 -0000	1.89
+++ Doc/Zsh/contrib.yo	23 Sep 2008 16:43:15 -0000
@@ -328,19 +328,20 @@
 
 In order to do that, you may use the tt(vcs_info) function.
 
-The following VCSs are supported:
+The following VCSs are supported, showing the abbreviated name by which
+they are referred to within the system:
 startsitem()
-sitem(tt(bazaar))(http://bazaar-vcs.org/)
-sitem(tt(codeville))(http://codeville.org/)
-sitem(tt(cvs))(http://www.nongnu.org/cvs/)
+sitem(Bazaar (tt(bzr)))(http://bazaar-vcs.org/)
+sitem(Codeville (tt(cdv)))(http://codeville.org/)
+sitem(Concurrent Versioning System (tt(cvs)))(http://www.nongnu.org/cvs/)
 sitem(tt(darcs))(http://darcs.net/)
 sitem(tt(git))(http://git.or.cz/)
-sitem(tt(gnu arch))(http://www.gnu.org/software/gnu-arch/)
-sitem(tt(mercurial))(http://selenic.com/mercurial/)
-sitem(tt(monotone))(http://monotone.ca/)
-sitem(tt(perforce))(http://www.perforce.com/)
-sitem(tt(subversion))(http://subversion.tigris.org/)
-sitem(tt(svk))(http://svk.bestpractical.com/)
+sitem(GNU arch (tt(tla)))(http://www.gnu.org/software/gnu-arch/)
+sitem(Mercurial (tt(hg)))(http://selenic.com/mercurial/)
+sitem(Monotone (tt(mtn)))(http://monotone.ca/)
+sitem(Perforce (tt(p4)))(http://www.perforce.com/)
+sitem(Subversion (tt(svn)))(http://subversion.tigris.org/)
+sitem(SVK (tt(svk)))(http://svk.bestpractical.com/)
 endsitem()
 
 To load var(vcs_info):
Index: Functions/VCS_Info/Backends/VCS_INFO_get_data_p4
===================================================================
RCS file: /cvsroot/zsh/zsh/Functions/VCS_Info/Backends/VCS_INFO_get_data_p4,v
retrieving revision 1.1
diff -u -r1.1 VCS_INFO_get_data_p4
--- Functions/VCS_Info/Backends/VCS_INFO_get_data_p4	19 Sep 2008 12:58:54 -0000	1.1
+++ Functions/VCS_Info/Backends/VCS_INFO_get_data_p4	23 Sep 2008 16:43:15 -0000
@@ -10,5 +10,15 @@
 p4 info | while IFS=: read a b; do p4info[${a// /_}]="${b## #}"; done
 p4base=${vcs_comm[basedir]}
 
-# We'll use the client name as the branch; close enough
-VCS_INFO_formats '' "${p4info[Client_name]}" "${p4base}"
+# We'll use the client name as the branch; close enough.
+local p4branch change
+# We'll use the latest change number to which the hierarchy from
+# here down is synced as the revision.
+# I suppose the following might be slow on a tortuous client view.
+change="${${$(p4 changes -m 1 ...)##Change }%% *}"
+zstyle -s ":vcs_info:${vcs}:${usercontext}:${rrn}" branchformat p4branch ||
+p4branch="%b:%r"
+zformat -f p4branch "${p4branch}" "b:${p4info[Client_name]}" \
+"r:$change"
+
+VCS_INFO_formats '' "${p4branch}" "${p4base}"


-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070

