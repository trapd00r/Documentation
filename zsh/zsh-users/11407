From zsh-users-return-11407-mason-zsh=primenet.com.au@sunsite.dk Mon Apr 16 14:58:44 2007
Return-Path: <zsh-users-return-11407-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 19876 invoked from network); 16 Apr 2007 14:58:41 -0000
X-Spam-Checker-Version: SpamAssassin 3.1.8 (2007-02-13) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=BAYES_00,FORGED_RCVD_HELO
	autolearn=ham version=3.1.8
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 16 Apr 2007 14:58:41 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 13721 invoked from network); 16 Apr 2007 14:58:36 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 16 Apr 2007 14:58:36 -0000
Received: (qmail 12213 invoked by alias); 16 Apr 2007 14:58:20 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 11407
Received: (qmail 12198 invoked from network); 16 Apr 2007 14:58:19 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 16 Apr 2007 14:58:19 -0000
Received: (qmail 12403 invoked from network); 16 Apr 2007 14:58:19 -0000
Received: from wx-out-0506.google.com (66.249.82.236)
  by a.mx.sunsite.dk with SMTP; 16 Apr 2007 14:58:15 -0000
Received: by wx-out-0506.google.com with SMTP id s16so91319wxc
        for <zsh-users@sunsite.dk>; Mon, 16 Apr 2007 07:58:14 -0700 (PDT)
DKIM-Signature: a=rsa-sha1; c=relaxed/relaxed;
        d=gmail.com; s=beta;
        h=domainkey-signature:received:received:message-id:date:from:to:subject:cc:in-reply-to:mime-version:content-type:content-transfer-encoding:content-disposition:references;
        b=Fnn4w21MVupj39WZ9TSDvqYtKbSIK/qUxRrcNaxwoXSN9YGIivCgFOak99bBdHppCWtG/hYOD/GYt6Aoblq2gBYqBXewjx1Qoty5jMvIUl4G4rR4lPwu97fjWgADWFJ/8/0KrLzCkqCsHVROwR9w8SI8v5kglQXK2xepAaiq1KY=
DomainKey-Signature: a=rsa-sha1; c=nofws;
        d=gmail.com; s=beta;
        h=received:message-id:date:from:to:subject:cc:in-reply-to:mime-version:content-type:content-transfer-encoding:content-disposition:references;
        b=h9R/W1y3Jy1LA4zG/ILCePMqxST5r86NgfrFtoHCkHa/Ow8SFYPAwrle2En72f/UjcjmCbW7vipBL4LQiCyahiyZIZmXCH4m4wdLY/8hRw2kJkhi436Eabj8uealJ+fYl6F8T6VZueWBXwsdweU6YXRkPKLmYY3hfuG28wDA2tg=
Received: by 10.70.28.7 with SMTP id b7mr10730859wxb.1176735493958;
        Mon, 16 Apr 2007 07:58:13 -0700 (PDT)
Received: by 10.70.31.5 with HTTP; Mon, 16 Apr 2007 07:58:13 -0700 (PDT)
Message-ID: <dc507f4a0704160758l7703b392w74e6a784a40c02d5@mail.gmail.com>
Date: Mon, 16 Apr 2007 07:58:13 -0700
From: "Felix Rosencrantz" <f.rosencrantz@gmail.com>
To: "Peter Stephenson" <p.w.stephenson@ntlworld.com>
Subject: Re: Problems with vi-goto-mark and vi-set-mark
Cc: "Zsh users list" <zsh-users@sunsite.dk>
In-Reply-To: <200704151953.l3FJrjRg003045@pwslaptop.csr.com>
MIME-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1; format=flowed
Content-Transfer-Encoding: 7bit
Content-Disposition: inline
References: <f.rosencrantz@gmail.com>
	 <dc507f4a0704150949p39a6fd4bleb56f7d7c00cd1e9@mail.gmail.com>
	 <200704151953.l3FJrjRg003045@pwslaptop.csr.com>

Thanks for the patch, Peter.  It seems to be working better now.

Though there does seem to be some oddness when trying multiple
vi-goto-mark-line  and then doing a vi-goto-mark for the same mark.
Though not sure, will need to come up with a reproducible case.

-FR.
On 4/15/07, Peter Stephenson <p.w.stephenson@ntlworld.com> wrote:
> "Felix Rosencrantz" wrote:
> > I've recently been trying to use viins/vicmd mode.  I've hit a small
> > problem with the vi-set-mark and vi-goto-mark, they seem to be broken
> > in the latest version of zsh.  Though it looks like it was working in
> > 4.2.5.
>
> Yes, I don't use vi mode so don't notice this sort of thing.  We could
> do with someone writing interactive tests for zle commands.  We could
> also do with someone to look after vi mode.  We could do with people
> doing a lot of things.
>
> The change is that getchar() used not to set the last character, which
> was done at a higher level, but the replacements which support multibyte
> do (even if multibyte mode isn't compiled in).  This means the character
> read is always treated as if it was the same as the last character.
>
> I think the following fixes it, but I'm not sure what the feature is in
> vi-goto-mark that has the special behaviour if the last character is
> repeated.  If you know and can test it, please do.
>
> Index: Src/Zle/zle.h
> ===================================================================
> RCS file: /cvsroot/zsh/zsh/Src/Zle/zle.h,v
> retrieving revision 1.34
> diff -u -r1.34 zle.h
> --- Src/Zle/zle.h       3 Dec 2006 21:07:18 -0000       1.34
> +++ Src/Zle/zle.h       15 Apr 2007 19:22:16 -0000
> @@ -72,6 +72,7 @@
>  #define ZC_toupper towupper
>
>  #define LASTFULLCHAR   lastchar_wide
> +#define LASTFULLCHAR_T  ZLE_INT_T
>
>  #else  /* Not MULTIBYTE_SUPPORT: old single-byte code */
>
> @@ -130,6 +131,7 @@
>  #define ZC_toupper tuupper
>
>  #define LASTFULLCHAR   lastchar
> +#define LASTFULLCHAR_T int
>
>  #endif
>
> Index: Src/Zle/zle_move.c
> ===================================================================
> RCS file: /cvsroot/zsh/zsh/Src/Zle/zle_move.c,v
> retrieving revision 1.8
> diff -u -r1.8 zle_move.c
> --- Src/Zle/zle_move.c  1 Nov 2005 02:50:29 -0000       1.8
> +++ Src/Zle/zle_move.c  15 Apr 2007 19:22:16 -0000
> @@ -484,9 +484,10 @@
>  vigotomark(UNUSED(char **args))
>  {
>      ZLE_INT_T ch;
> +    LASTFULLCHAR_T lfc = LASTFULLCHAR;
>
>      ch = getfullchar(0);
> -    if (ch == LASTFULLCHAR)
> +    if (ch == lfc)
>         ch = 26;
>      else {
>         if (ch < ZWC('a') || ch > ZWC('z'))
>
> --
> Peter Stephenson <p.w.stephenson@ntlworld.com>
> Web page now at http://homepage.ntlworld.com/p.w.stephenson/
>

