From zsh-users-return-12622-mason-zsh=primenet.com.au@sunsite.dk Mon Feb 18 09:34:22 2008
Return-Path: <zsh-users-return-12622-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 10286 invoked from network); 18 Feb 2008 09:34:20 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.4 (2008-01-01) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.4
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 18 Feb 2008 09:34:20 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 30831 invoked from network); 18 Feb 2008 09:33:57 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 18 Feb 2008 09:33:57 -0000
Received: (qmail 27971 invoked by alias); 18 Feb 2008 09:33:46 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 12622
Received: (qmail 27959 invoked from network); 18 Feb 2008 09:33:45 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 18 Feb 2008 09:33:45 -0000
Received: from vms040pub.verizon.net (vms040pub.verizon.net [206.46.252.40])
	by bifrost.dotsrc.org (Postfix) with ESMTP id 83FAC8026E0B
	for <zsh-users@sunsite.dk>; Mon, 18 Feb 2008 10:33:41 +0100 (CET)
Received: from torch.brasslantern.com ([71.121.18.67])
 by vms040.mailsrvcs.net (Sun Java System Messaging Server 6.2-6.01 (built Apr
 3 2006)) with ESMTPA id <0JWF00J1RHC5AYRH@vms040.mailsrvcs.net> for
 zsh-users@sunsite.dk; Mon, 18 Feb 2008 03:36:06 -0600 (CST)
Received: from torch.brasslantern.com (localhost.localdomain [127.0.0.1])
	by torch.brasslantern.com (8.13.1/8.13.1) with ESMTP id m1I9XcJs015028	for
 <zsh-users@sunsite.dk>; Mon, 18 Feb 2008 01:33:39 -0800
Received: (from schaefer@localhost)	by torch.brasslantern.com
 (8.13.1/8.13.1/Submit) id m1I9XcKY015027	for zsh-users@sunsite.dk; Mon,
 18 Feb 2008 01:33:38 -0800
Date: Mon, 18 Feb 2008 01:33:38 -0800
From: Bart Schaefer <schaefer@brasslantern.com>
Subject: Re: _approximate doesn't work
In-reply-to: <200802171925.m1HJPbE8009696@pws-pc.ntlworld.com>
To: zsh-users@sunsite.dk
Message-id: <080218013338.ZM15026@torch.brasslantern.com>
MIME-version: 1.0
X-Mailer: OpenZMail Classic (0.9.2 24April2005)
Content-type: text/plain; charset=us-ascii
References: <200802171925.m1HJPbE8009696@pws-pc.ntlworld.com>
Comments: In reply to Peter Stephenson <p.w.stephenson@ntlworld.com>
 "Re: _approximate doesn't work" (Feb 17,  7:25pm)
X-Virus-Scanned: ClamAV 0.91.2/5867/Mon Feb 18 08:12:11 2008 on bifrost
X-Virus-Status: Clean

On Feb 17,  7:25pm, Peter Stephenson wrote:
} Subject: Re: _approximate doesn't work
}
} Anthony Charles wrote:
} > There's a lot of differences
} 
} The business end of command completion changed.  It used simply to add
} the commands array directly; now it goes through the function
} _path_commands.

Skipping that for the moment, on line 641 of the 4.3.5 output (which
corresponds to line 394 in 4.3.4), the tag "commands" is being added
to the _comp_tags list twice:

+_next_label:11> _comp_tags=' commands  commands  builtins ' 

This appears to related to the call to "_wanted commands ..." from
_path_commands, at about line 322.  Note that PREFIX has not yet been
set when that first call to _path_commands occurs -- but it is set
later, before _path_commands is called again.

In any case, now that commands is in _comp_tags again, _path_commands
is going to be called again, and everything that's in _comp_tags at
that point eventually ends up duplicated:  at line 2291 "commands" is
appended again, and so on, until by line 5875 we have everything in
there three times and "commands" six times.

Something similar happens in 4.3.4, but only after returning to
_main_complete and calling _approximate, so there's only one set of
duplicates.

I think perhaps _main_complete needs to clear _comp_tags at the point
where it increments _completer_num, around line 169.  That would get
rid of one set of the duplicate tags.  (I've tried poking that in to
a running shell with zed, and it seems to be OK.)

The other set of duplicate tags seems result from _path_commands having
two consecutive calls to _wanted:

  _wanted commands expl 'external command' \
      compadd "$@" -ld descs -a dcmds && ret=0
  _wanted commands expl 'external command' compadd "$@" -a cmds && ret=0

Why?  Anyway the tweak to _main_complete should snuff that as well, I
think, once we get back that far.

} The problem is around this bit that's used if descriptions
} for the commands are needed (the verbose style is set and at least some
} commands have descriptions):
} 
}   for cmd in ${(@)commands[(I)$PREFIX*]}; do
[...]
} I can see that _path_commands is skipping this loop, indicating the
} expansion was empty.  However, I can't see why this is happening.

Hmm, I get

: _path_commands:15:then then for; line=whatis: -s: unknown option

which then means all my descriptions are empty, so $need_desc is set
to the empty string and it never even gets near that loop, nor does it
execute the pair of _wanted calls quoted above.  Instead it just falls
straight through to

_wanted commands expl 'external command' compadd "$@" -k commands && ret=0

which works like the 4.3.4 code and everything is fine.

Apparently _path_commands should not assume that whatis accepts any
options.  Have we got Debian or Solaris dependencies creeping in here?

That's about as far as I can get with this, I'm afraid.

