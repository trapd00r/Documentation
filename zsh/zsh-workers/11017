From zsh-workers-return-11017-mason-zsh=primenet.com.au@sunsite.auc.dk Sat Apr 29 15:46:53 2000
Return-Path: <zsh-workers-return-11017-mason-zsh=primenet.com.au@sunsite.auc.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 13678 invoked from network); 29 Apr 2000 15:46:51 -0000
Received: from sunsite.auc.dk (130.225.51.30)
  by ns1.primenet.com.au with SMTP; 29 Apr 2000 15:46:51 -0000
Received: (qmail 17977 invoked by alias); 29 Apr 2000 15:46:42 -0000
Mailing-List: contact zsh-workers-help@sunsite.auc.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.auc.dk
X-Seq: 11017
Received: (qmail 17965 invoked from network); 29 Apr 2000 15:46:41 -0000
Date: Sat, 29 Apr 2000 16:46:40 +0100
From: Adam Spiers <adam@spiers.net>
To: zsh workers mailing list <zsh-workers@sunsite.auc.dk>
Subject: Re: PATCH: bugfixes for _rpm
Message-ID: <20000429164640.A3421@thelonious.new.ox.ac.uk>
Reply-To: Adam Spiers <adam@spiers.net>
Mail-Followup-To: zsh workers mailing list <zsh-workers@sunsite.auc.dk>
References: <20000426173759.A11067@thelonious.new.ox.ac.uk> <1000426172340.ZM20629@candle.brasslantern.com>
Mime-Version: 1.0
Content-Type: text/plain; charset=us-ascii
X-Mailer: Mutt 1.0.1i
In-Reply-To: <1000426172340.ZM20629@candle.brasslantern.com>; from schaefer@candle.brasslantern.com on Wed, Apr 26, 2000 at 05:23:39PM +0000
X-Home-Page: http://www.new.ox.ac.uk/~adam/
X-OS: RedHat Linux

Bart Schaefer (schaefer@candle.brasslantern.com) wrote:
> On Apr 26,  5:37pm, Adam Spiers wrote:
> } Subject: PATCH: bugfixes for _rpm
> }
> } --rmsource completion still doesn't work exactly as I'd like it to
> } after the patch is applied - it completes all files, not just *.spec.
> } Have I done something wrong, or do I have to finally take the plunge
> } and try to understand the file-patterns style?
> 
> You've done something wrong.
> 
> } +  spec_file)
> } +    _wanted specfiles expl 'spec file' \
> } +        _files "$expl[@]" -g \*.spec && ret=0
> } +    ;;

This does it right.  It also fixes 10772, which broke _rpm in other
ways by putting the target) case in the middle of two continuation
cases.

I haven't fixed _hash yet.

Index: Completion/Linux/_rpm
===================================================================
RCS file: /cvsroot/zsh/zsh/Completion/Linux/_rpm,v
retrieving revision 1.6
diff -u -r1.6 _rpm
--- Completion/Linux/_rpm	2000/04/17 08:42:18	1.6
+++ Completion/Linux/_rpm	2000/04/29 15:37:12
@@ -70,8 +70,9 @@
   '--erase:*:uninstall:->uninstall' \
   -'b+[build mode (spec file)]:build stage:((p\:execute\ \%prep\ stage l\:do\ a\ list\ check c\:execute\ build\ stage i\:execute\ install\ stage b\:build\ a\ binary\ package a\:build\ binary\ and\ source\ packages)):*:build:->build_b' \
   -'t+[build mode (tar file)]:build stage:((p\:execute\ \%prep\ stage l\:do\ a\ list\ check c\:execute\ build\ stage i\:execute\ install\ stage b\:build\ a\ binary\ package a\:build\ binary\ and\ source\ packages)):*:build:->build_t' \
-  --{rmsource,recompile,resign,addsign}':*:RPM package:->package' \
-  '--rebuild:*:Src RPM files:->package_src' \
+  --{resign,addsign}':*:RPM package:->package' \
+  '--rmsource:*:spec file:->spec_file' \
+  --{rebuild,recompile}':*:Src RPM files:->package_src' \
     '-K+[signature check mode]:*:sigcheck:->sigcheck' \
   '--checksig:*:sigcheck:->sigcheck' \
   '--rebuilddb:*:rebuild:->rebuild' && ret=0
@@ -187,24 +188,28 @@
       '--dbpath:RPM database path:_files -/' \
       '*:RPM source package file:->package_file' && ret=0
     ;;
-  package_or_file)
-    state=package_file
-    ;&
   target)
     _wanted target expl 'Target platforms' \
         compadd $(_call target rpm --showrc |grep 'compatible archs'|sed 's/.*: //') && ret=0
     ;;
+  package_or_file)
+    state=package_file
+    ;&
   package)
     _wanted packages expl 'RPM package' \
         compadd -M 'r:|-=* r:|=*' - $(_call packages rpm -qa) && ret=0
     ;;
+  spec_file)
+    _wanted specfiles expl 'spec file' \
+        _files -g \*.spec && ret=0
+    ;;
   package_file)
     if compset -P ftp://; then
       _hosts -S/ && ret=0
     else
       _alternative \
           'files:RPM package file:_files -g \*.\(\#i\)rpm' \
-	  'prefixes:ftp URL prefix:compadd ftp://' && ret=0
+          'prefixes:ftp URL prefix:compadd ftp://' && ret=0
     fi
     ;;
   package_src)

