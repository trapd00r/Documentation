From zsh-workers-return-19436-mason-zsh=primenet.com.au@sunsite.dk Wed Feb 18 12:13:17 2004
Return-Path: <zsh-workers-return-19436-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 9634 invoked from network); 18 Feb 2004 12:13:16 -0000
Received: from sunsite.dk (130.225.247.90)
  by ns1.primenet.com.au with SMTP; 18 Feb 2004 12:13:16 -0000
Received: (qmail 22915 invoked by alias); 18 Feb 2004 12:13:08 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 19436
Received: (qmail 22872 invoked from network); 18 Feb 2004 12:13:07 -0000
Received: from localhost (HELO sunsite.dk) (127.0.0.1)
  by localhost with SMTP; 18 Feb 2004 12:13:07 -0000
X-MessageWall-Score: 0 (sunsite.dk)
Received: from [193.109.254.211] by sunsite.dk (MessageWall 1.0.8) with SMTP; 18 Feb 2004 12:13:7 -0000
X-VirusChecked: Checked
X-Env-Sender: okiddle@yahoo.co.uk
X-Msg-Ref: server-12.tower-36.messagelabs.com!1077106386!3937875
X-StarScan-Version: 5.2.5; banners=-,-,-
X-Originating-IP: [158.234.9.163]
Received: (qmail 23075 invoked from network); 18 Feb 2004 12:13:06 -0000
Received: from iris.logica.co.uk (158.234.9.163)
  by server-12.tower-36.messagelabs.com with SMTP; 18 Feb 2004 12:13:06 -0000
Received: from trentino.logica.co.uk ([158.234.142.61])
	by iris.logica.co.uk (8.12.3/8.12.3/Debian -4) with ESMTP id i1ICD6kb002527
	for <zsh-workers@sunsite.dk>; Wed, 18 Feb 2004 12:13:06 GMT
Received: from trentino.logica.co.uk (localhost [127.0.0.1])
	by trentino.logica.co.uk (Postfix) with ESMTP id 0240A7979FD6
	for <zsh-workers@sunsite.dk>; Wed, 18 Feb 2004 12:47:39 +0100 (CET)
X-VirusChecked: Checked
X-StarScan-Version: 5.1.13; banners=.,-,-
From: Oliver Kiddle <okiddle@yahoo.co.uk>
To: Zsh workers <zsh-workers@sunsite.dk>
Subject: PATCH: completing stuff from NIS
Date: Wed, 18 Feb 2004 12:47:39 +0100
Message-ID: <23043.1077104859@trentino.logica.co.uk>

In _groups, if it finds ypcat, it only completes those groups found by
NIS. The list should really be merged with those from /etc/group
because the conventional setup involves using both.

On at least recent Solaris and Linux, the getent programme does a
better job of getting the groups. It should in theory work for ldap
setups too. For this reason, I've got it to try getent first. Hopefully
that doesn't cause problems on other systems. The only difference I
notice is that it isn't returning the ipv6 hosts. Whether that's a
limitation or a feature I don't know (I don't have ipv6 enabled but
/etc/hosts contains the ipv6 loopback things).

If we're going to pull groups from NIS, it can't do any harm to do a
similar thing for _hosts and _printers. I also add that in the patch
below. The printer part only works for Solaris.

Long ago, someone posted a patch to use a DNS search in _hosts. Any
thoughts on how we can reasonably add that. Perhaps a style to enable
it? Or we could do something like _email_addresses.

Oliver

Index: Completion/Unix/Type/_groups
===================================================================
RCS file: /cvsroot/zsh/zsh/Completion/Unix/Type/_groups,v
retrieving revision 1.2
diff -u -r1.2 _groups
--- Completion/Unix/Type/_groups	6 Aug 2001 14:42:04 -0000	1.2
+++ Completion/Unix/Type/_groups	18 Feb 2004 11:46:18 -0000
@@ -6,11 +6,14 @@
 
 if ! zstyle -a ":completion:${curcontext}:" groups groups; then
   (( $+_cache_groups )) ||
-      if (( ${+commands[ypcat]} )) &&
-	  tmp=$(_call_program groups ypcat group.byname 2>/dev/null); then
-        : ${(A)_cache_groups:=${${(f)tmp}%%:*}} # If you use YP
+      if (( ${+commands[getent]} )); then
+        : ${(A)_cache_groups:=${${(s: :)$(_call_program groups getent group 2>/dev/null)}%%:*}}
       else
-        : ${(A)_cache_groups:=${${(s: :)$(</etc/group)}%%:*}}
+        : ${(A)_cache_groups:=${${${(s: :)$(</etc/group)}%%:*}:#+}}
+	if (( ${+commands[ypcat]} )) &&
+	    tmp=$(_call_program groups ypcat group.byname 2>/dev/null); then
+          _cache_groups+=( ${${(f)tmp}%%:*} ) # If you use YP
+	fi
       fi
 
   groups=( "$_cache_groups[@]" )
Index: Completion/Unix/Type/_hosts
===================================================================
RCS file: /cvsroot/zsh/zsh/Completion/Unix/Type/_hosts,v
retrieving revision 1.2
diff -u -r1.2 _hosts
--- Completion/Unix/Type/_hosts	12 Apr 2002 23:22:57 -0000	1.2
+++ Completion/Unix/Type/_hosts	18 Feb 2004 11:46:18 -0000
@@ -1,10 +1,18 @@
 #compdef ftp ping rwho rup xping traceroute host aaaa zone mx ns soa txt
 
-local expl hosts
+local expl hosts tmp
 
 if ! zstyle -a ":completion:${curcontext}:hosts" hosts hosts; then
   (( $+_cache_hosts )) ||
-      : ${(A)_cache_hosts:=${(s: :)${(ps:\t:)${${(f)~~"$(</etc/hosts)"}%%\#*}##[:blank:]#[^[:blank:]]#}}}
+      if (( ${+commands[getent]} )); then
+	: ${(A)_cache_hosts:=${(s: :)${(ps:\t:)${(f)~~"$(_call_program hosts getent hosts 2>/dev/null)"}##[:blank:]#[^[:blank:]]#}}}
+      else
+        : ${(A)_cache_hosts:=${(s: :)${(ps:\t:)${${(f)~~"$(</etc/hosts)"}%%\#*}##[:blank:]#[^[:blank:]]#}}}
+	if (( ${+commands[ypcat]} )) &&
+	    tmp=$(_call_program hosts ypcat hosts.byname 2>/dev/null); then
+          _cache_hosts+=( ${=${(f)tmp}##[:blank:]#[^[:blank:]]#} ) # If you use YP
+	fi
+      fi
 
   hosts=( "$_cache_hosts[@]" )
 fi
Index: Completion/Unix/Type/_printers
===================================================================
RCS file: /cvsroot/zsh/zsh/Completion/Unix/Type/_printers,v
retrieving revision 1.4
diff -u -r1.4 _printers
--- Completion/Unix/Type/_printers	13 Mar 2002 09:28:05 -0000	1.4
+++ Completion/Unix/Type/_printers	18 Feb 2004 11:46:18 -0000
@@ -1,6 +1,6 @@
 #compdef -value-,PRINTER,-default- -value-,LPDEST,-default-
 
-local expl ret=1 list disp sep
+local expl ret=1 list disp sep tmp
 
 if (( $+commands[lsallq] )); then
   # Use AIX's command to list print queues
@@ -39,6 +39,12 @@
       fi
     done < $file[1]
   fi
+
+  if [[ $OSTYPE = solaris* ]] && (( ${+commands[ypcat]} )) &&
+      tmp=$(_call_program printers ypcat printers.conf.byname 2>/dev/null); then
+    _lp_cache+=( ${${${(S)${(f)tmp}/(#b):*((#e)|description=([^:]#):)*/:${match[2]}|}%%|*}:#_default*} ) # If you use YP
+  fi
+
   (( $#_lp_cache )) || _lp_cache=( 'lp0:Guessed default printer' )
   (( $#_lp_alias_cache )) || unset _lp_alias_cache
 fi

