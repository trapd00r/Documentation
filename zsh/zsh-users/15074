From zsh-users-return-15074-mason-zsh=primenet.com.au@zsh.org Sat May 22 06:20:04 2010
Return-Path: <zsh-users-return-15074-mason-zsh=primenet.com.au@zsh.org>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 29249 invoked by alias); 22 May 2010 06:20:04 -0000
Mailing-List: contact zsh-users-help@zsh.org; run by ezmlm
Precedence: bulk
X-No-Archive: yes
List-Id: Zsh Users List <zsh-users.zsh.org>
List-Post: <mailto:zsh-users@zsh.org>
List-Help: <mailto:zsh-users-help@zsh.org>
Delivered-To: mailing list zsh-users@zsh.org
X-Seq: 15074
Received: (qmail 3043 invoked from network); 22 May 2010 06:19:52 -0000
X-Spam-Checker-Version: SpamAssassin 3.3.1 (2010-03-16) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-1.9 required=5.0 tests=BAYES_00,RCVD_IN_DNSWL_NONE
	autolearn=ham version=3.3.1
Received-SPF: none (ns1.primenet.com.au: domain at brasslantern.com does not designate permitted sender hosts)
MIME-Version: 1.0
In-Reply-To: <20100522024655.GA19291@spiegl.de>
References: <20100519125713.GA17396@spiegl.de>
	 <AANLkTilf4VJehRx3kf_XNUc4B8YO1EexzsZIaaclnFJ2@mail.gmail.com>
	 <20100519173756.GA1456@spiegl.de>
	 <AANLkTika1EUAfmPwiTnKLv5IXofGH07sgFoRwZGQNXnL@mail.gmail.com>
	 <20100522024655.GA19291@spiegl.de>
Date: Fri, 21 May 2010 23:14:23 -0700
Message-ID: <AANLkTim9eraoSP7Jw4GUQYtAmLDD-56MVOwCj7UzgzpI@mail.gmail.com>
Subject: Re: Bug in _gnu_generic for "cp -a"?
From: Bart Schaefer <schaefer@brasslantern.com>
To: zsh-users@zsh.org
Content-Type: text/plain; charset=ISO-8859-1

On Fri, May 21, 2010 at 7:46 PM, Andy Spiegl <zsh.Andy@spiegl.de> wrote:
> On 2010-05-20, 07:45, Bart Schaefer wrote:
>> On Wed, May 19, 2010 at 10:37 AM, Andy Spiegl <zsh.Andy@spiegl.de> wrote:
>> > On 2010-05-19, 08:30, Bart Schaefer wrote:
>> >>
>> You said before that you have this completion problem only with the
>> -a option, but do you by chance also have it with the -d option,
>> which also has an "=" in the description?
>
> I tested and: YES
> Also with -p which also has an "=" in the help description.
> So I guess your assumption is very good!

OK, so the problem seems to be here:

      # Ignore :descriptions at the ends of lopts for matching this;
      # they aren't in the patterns.
      tmp=("${(@M)lopts:##$~pattern(|:*)}")
      lopts=("${(@)lopts:##$~pattern(|:*)}")

I'm still not quite following this, but I think that stuff is supposed
to distinguish descriptions of options from descriptions of the
arguments those options accept.  If that doesn't happen correctly, the
options having descriptions containing an "=" later reach this ...

      # Descriptions with `=': mandatory argument.
      # Basically the same as the foregoing.
      # TODO: could they be combined?

      tmpo=("${(@M)tmp:#*\=*}")
      if (( $#tmpo )); then
        tmp=("${(@)tmp:#*\=*}")

and in that block they get transformed from e.g -a:description: to
-a=[description] which is wrong.

