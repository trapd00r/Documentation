From zsh-users-return-14095-mason-zsh=primenet.com.au@sunsite.dk Wed May 06 07:36:33 2009
Return-Path: <zsh-users-return-14095-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 26320 invoked from network); 6 May 2009 07:36:27 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=BAYES_00 autolearn=ham
	version=3.2.5
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 6 May 2009 07:36:27 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 86959 invoked from network); 6 May 2009 07:36:10 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 6 May 2009 07:36:10 -0000
Received: (qmail 28581 invoked by alias); 6 May 2009 07:35:53 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 14095
Received: (qmail 27700 invoked from network); 6 May 2009 07:34:11 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 6 May 2009 07:34:11 -0000
Received: from mail-gx0-f160.google.com (mail-gx0-f160.google.com [209.85.217.160])
	by bifrost.dotsrc.org (Postfix) with ESMTP id 7985780590A3
	for <zsh-users@sunsite.dk>; Wed,  6 May 2009 09:33:37 +0200 (CEST)
Received: by gxk4 with SMTP id 4so335843gxk.21
        for <zsh-users@sunsite.dk>; Wed, 06 May 2009 00:34:05 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=gamma;
        h=domainkey-signature:mime-version:sender:reply-to:received:date
         :x-google-sender-auth:message-id:subject:from:to:content-type
         :content-transfer-encoding;
        bh=n0K/DbHHdMUcwk9ZLNl8kEa92EVT6BoySPkQ5CaKkhk=;
        b=v5BloKx/GiUMqgtwPSnS7AbdNv1MnlQT4tI54N7ksSsFiPybpyWAVoj0egsPNaETZo
         rSxUk7p3m6IIfu3h/bLkGGQGhjsTSF9MHgVC9+KQPxR5jiZQnlQ6TOKEHA3aQs2z0xCe
         FW4rC9IKYDhB7Z5/1HgBQ0Yl1J1AjDTHVcM1o=
DomainKey-Signature: a=rsa-sha1; c=nofws;
        d=gmail.com; s=gamma;
        h=mime-version:sender:reply-to:date:x-google-sender-auth:message-id
         :subject:from:to:content-type:content-transfer-encoding;
        b=hSzXgnEFnYjGWdxSErhvfSva1eWYvnnxNsgL6/nUmEBB2MkFKw+V2wQXan4nfRCL/D
         r6OCobgZvGaqjz3+Rs2klDfucbiDFzrcsrt6DVWqicdHME0zxUVSADKEltZjtCyjynpd
         nNLljwZpePO+7h4Vr30D6ooaV37YnSNiwaswQ=
MIME-Version: 1.0
Sender: con.amalgamate@gmail.com
Reply-To: simon.haines@con-amalgamate.net
Received: by 10.151.138.8 with SMTP id q8mr148194ybn.40.1241595245632; Wed, 06 
	May 2009 00:34:05 -0700 (PDT)
Date: Wed, 6 May 2009 17:34:05 +1000
X-Google-Sender-Auth: 662a016a8718caa7
Message-ID: <d6b42a530905060034m58952a70ybb59d22e439eddb0@mail.gmail.com>
Subject: Quoting with compadd
From: Simon Haines <simon.haines@con-amalgamate.net>
To: zsh-users@sunsite.dk
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 7bit
X-Virus-Scanned: ClamAV 0.92.1/9333/Wed May  6 05:55:26 2009 on bifrost
X-Virus-Status: Clean

Hi there, I'm trying to build a completion function for the mighty zsh
to provide filename completion for the 'j' script
(http://github.com/rupa/j/tree/master). It seems whenever I use
compadd, newlines are incorrectly quoted.

This awful attempt is the best I could come up with so far (assuming
'compdef j_complete j')
j_complete() {
	local -a dirs
	dirs=$(grep -o -e ${words[CURRENT]}'[^|]*' < ~/.j)
	compadd $dirs
}

However, the newlines in $dirs are quoted by compadd (as are the
spaces). I'm assuming that compadd would prefer spaces in the
filenames be quoted and newlines turned into spaces. I've tried piping
into sed to manually quote spaces, then into tr to turn newlines into
spaces, but compadd then quotes the lot.

The completion needs to scan the file ~/.j for directories containing
the completion word. The file has the format <dir>|<count>|<time>
(notice non-greedy matching in egrep because of the second '|').
Ideally completion should only be offered where the completion word
matches the beginning of a path or part of a path string that follows
'/'.

