From zsh-workers-request@math.gatech.edu Mon Aug 24 01:59:28 1998
Return-Path: <zsh-workers-request@math.gatech.edu>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 1844 invoked from network); 24 Aug 1998 01:59:27 -0000
Received: from math.gatech.edu (root@130.207.146.50)
  by ns1.primenet.com.au with SMTP; 24 Aug 1998 01:59:27 -0000
Received: (from list@localhost)
	by math.gatech.edu (8.9.1/8.9.1) id UAA11353;
	Sun, 23 Aug 1998 20:20:35 -0400 (EDT)
Resent-Date: Sun, 23 Aug 1998 20:20:35 -0400 (EDT)
From: "Bart Schaefer" <schaefer@brasslantern.com>
Message-Id: <980823172313.ZM6272@candle.brasslantern.com>
Date: Sun, 23 Aug 1998 17:23:13 -0700
In-Reply-To: <980805162756.ZM2128@candle.brasslantern.com>
Comments: In reply to "Bart Schaefer" <schaefer>
        "Zsh 3.1.4 "BUG: useheap in doexpandhist()" on completion from zle widget" (Aug  5,  4:27pm)
References: <980805162756.ZM2128@candle.brasslantern.com>
X-Mailer: Z-Mail (4.0b.820 20aug96)
To: zsh-workers@math.gatech.edu
Subject: PATCH: Re: Zsh 3.1.4 "BUG: useheap in doexpandhist()" on completion from zle widget
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Resent-Message-ID: <"WlzLk3.0.Kn2.J7Bur"@math>
Resent-From: zsh-workers@math.gatech.edu
X-Mailing-List: <zsh-workers@math.gatech.edu> archive/latest/4350
X-Loop: zsh-workers@math.gatech.edu
Precedence: list
Resent-Sender: zsh-workers-request@math.gatech.edu

On Aug 5,  4:27pm, Bart Schaefer wrote:
} Subject: Zsh 3.1.4 "BUG: useheap in doexpandhist()" on completion from zle
}
} Any call to expand-or-complete (or related widgets)
} from a user-defined widget will trigger the problem.

It took a bit of staring to figure out where to put this fix, but it looks
pretty straightforward.  Have I overlooked anything?

Index: Src/Zle/zle_thingy.c
===================================================================
RCS file: /extra/cvsroot/zsh/zsh-3.1/Src/Zle/zle_thingy.c,v
retrieving revision 1.1.1.1
diff -u -r1.1.1.1 zle_thingy.c
--- zle_thingy.c	1998/06/01 17:08:46	1.1.1.1
+++ zle_thingy.c	1998/08/24 00:17:42
@@ -468,7 +468,9 @@
 	return 1;
     }
     t = rthingy(args[0]);
-    execzlefunc(t);
+    PERMALLOC {
+      execzlefunc(t);
+    } LASTALLOC;
     unrefthingy(t);
     return 0;
 }

-- 
Bart Schaefer                                 Brass Lantern Enterprises
http://www.well.com/user/barts              http://www.brasslantern.com

