From zsh-workers-return-22708-mason-zsh=primenet.com.au@sunsite.dk Fri Sep 15 09:58:52 2006
Return-Path: <zsh-workers-return-22708-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 25575 invoked from network); 15 Sep 2006 09:58:49 -0000
X-Spam-Checker-Version: SpamAssassin 3.1.5 (2006-08-29) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.4 required=5.0 tests=AWL,BAYES_00,
	FORGED_RCVD_HELO autolearn=ham version=3.1.5
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 15 Sep 2006 09:58:49 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 54901 invoked from network); 15 Sep 2006 09:58:42 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 15 Sep 2006 09:58:42 -0000
Received: (qmail 21012 invoked by alias); 15 Sep 2006 09:58:39 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 22708
Received: (qmail 21002 invoked from network); 15 Sep 2006 09:58:39 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 15 Sep 2006 09:58:39 -0000
Received: (qmail 54620 invoked from network); 15 Sep 2006 09:58:39 -0000
Received: from cluster-c.mailcontrol.com (168.143.177.190)
  by a.mx.sunsite.dk with SMTP; 15 Sep 2006 09:58:37 -0000
Received: from cameurexb01.EUROPE.ROOT.PRI ([62.189.241.200])
	by rly27c.srv.mailcontrol.com (MailControl) with ESMTP id k8F9s7EN021238
	for <zsh-workers@sunsite.dk>; Fri, 15 Sep 2006 10:58:24 +0100
Received: from news01.csr.com ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.1830);
	 Fri, 15 Sep 2006 10:57:05 +0100
Received: from news01.csr.com (localhost.localdomain [127.0.0.1])
	by news01.csr.com (8.13.4/8.13.4) with ESMTP id k8F9v4MM021516
	for <zsh-workers@sunsite.dk>; Fri, 15 Sep 2006 10:57:04 +0100
Received: from csr.com (pws@localhost)
	by news01.csr.com (8.13.4/8.13.4/Submit) with ESMTP id k8F9v4uq021513
	for <zsh-workers@sunsite.dk>; Fri, 15 Sep 2006 10:57:04 +0100
Message-Id: <200609150957.k8F9v4uq021513@news01.csr.com>
X-Authentication-Warning: news01.csr.com: pws owned process doing -bs
To: zsh-workers@sunsite.dk (Zsh hackers list)
Subject: Re: Core dump with latest CVS 
In-reply-to: <20a807210609141402v31714a98wab9b75ff7736327@mail.gmail.com> 
References: <20a807210609141402v31714a98wab9b75ff7736327@mail.gmail.com>
Date: Fri, 15 Sep 2006 10:57:04 +0100
From: Peter Stephenson <pws@csr.com>
X-OriginalArrivalTime: 15 Sep 2006 09:57:05.0496 (UTC) FILETIME=[4CBBDD80:01C6D8AD]
Content-Type: text/plain
MIME-Version: 1.0
X-Scanned-By: MailControl A-07-04-01 (www.mailcontrol.com) on 10.67.0.137

"Vin Shelton" wrote:
> Peter,
> 
> I think your latest prompt/subst changes broke something.  Here's a recipe:
> 
> zsh -f
> setopt NO_PROMPT_SP
> autoload -U promptinit
> promptinit
> prompt bart
> 
> zsh: floating point exception (core dumped)

Yes, I get this.

The reason is this:

${(pl.COLUMNS..\b.)}

\b used to be treated as length 1; now we take its width.  For control
characters currently we assume width 1.  This causes the padding width
to be zero, which causes the shell to crash: I can fix the crash easily.

The other question is how to make the padding work when it's simply used
for repetition:

- Mostly the problem is just control characters.  I noted one before.
We could assume these have length 1 rather than 0 (and document this,
obviously).  It's not particularly logical but it fixes up most of the
problem cases without any need for tricks involving multibyte mode or
new features.  Most users probably won't be (directly) affected anyway.

- I could add a flag (b is available) to force the old way just for
the current padding.

- Something else involving new flags.

- require an explicit "unsetopt multibyte" for that to work as it used
to.  Yuk.

-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070


To access the latest news from CSR copy this link into a web browser:  http://www.csr.com/email_sig.php

