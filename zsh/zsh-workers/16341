From zsh-workers-return-16341-mason-zsh=primenet.com.au@sunsite.dk Sat Dec 15 01:17:49 2001
Return-Path: <zsh-workers-return-16341-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 12067 invoked from network); 15 Dec 2001 01:17:48 -0000
Received: from ns2.primenet.com.au (HELO primenet.com.au) (?AZZBo476OeDde90VbjrX1OrEF+sXCdIx?@203.24.36.3)
  by ns1.primenet.com.au with SMTP; 15 Dec 2001 01:17:48 -0000
Received: (qmail 2742 invoked from network); 15 Dec 2001 01:17:46 -0000
Received: from sunsite.dk (130.225.247.90)
  by proxy.melb.primenet.com.au with SMTP; 15 Dec 2001 01:17:46 -0000
Received: (qmail 22593 invoked by alias); 15 Dec 2001 01:17:40 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 16341
Received: (qmail 22581 invoked from network); 15 Dec 2001 01:17:40 -0000
To: zsh-workers@sunsite.auc.dk (Zsh hackers list)
Subject: forward: update to fix I sent yesterday
MIME-Version: 1.0
Content-Type: message/rfc822
Content-ID: <2503.1008379232.1@pwstephenson.fsnet.co.uk>
Content-Description: JohnW@bops.com
Date: Sat, 15 Dec 2001 01:20:47 +0000
From: Peter Stephenson <pws@pwstephenson.fsnet.co.uk>
Message-Id: <20011215012052.6C97014280@pwstephenson.fsnet.co.uk>

Return-Path: JohnW@bops.com
Delivery-Date: Sat Dec 15 01:01:50 2001
Return-Path: <JohnW@bops.com>
Delivered-To: pws@pwstephenson.fsnet.co.uk
Received: from localhost (pwstephenson.fsnet.co.uk [127.0.0.1])
	by pwstephenson.fsnet.co.uk (Postfix) with ESMTP id 9594414280
	for <pws@pwstephenson.fsnet.co.uk>; Sat, 15 Dec 2001 01:01:49 +0000 (GMT)
X-From_: JohnW@bops.com Tue Dec 11 18:04:29 2001
Envelope-to: pws@pwstephenson.fsnet.co.uk
Delivery-date: Tue, 11 Dec 2001 18:04:29 +0000
Received: from pop.pol.net.uk [195.92.195.154]
	by localhost with POP3 (fetchmail-5.7.4)
	for pws@pwstephenson.fsnet.co.uk (single-drop); Sat, 15 Dec 2001 01:01:49 +0000 (GMT)
Received: from [203.24.36.2] (helo=primenet.com.au)
	by imailm1.svr.pol.co.uk with smtp (Exim 3.33 #1)
	id 16DrGV-0000wH-00
	for pws@pwstephenson.fsnet.co.uk; Tue, 11 Dec 2001 18:04:28 +0000
Received: (qmail 17181 invoked by alias); 11 Dec 2001 18:04:24 -0000
Delivered-To: zsh_alias-coordinator@zsh.org
Received: (qmail 17179 invoked from network); 11 Dec 2001 18:04:24 -0000
Received: from ns2.primenet.com.au (HELO primenet.com.au) (?8QuJRcR5pJtAmijDK8NPXDig5Cj1ggkF?@203.24.36.3)
  by ns1.primenet.com.au with SMTP; 11 Dec 2001 18:04:24 -0000
Received: (qmail 3226 invoked from network); 11 Dec 2001 18:04:22 -0000
Received: from webmail.bops.com (HELO mail-austin.bops.com) (65.195.220.133)
  by proxy.melb.primenet.com.au with SMTP; 11 Dec 2001 18:04:22 -0000
Received: by aussrv001.austin.bops.com with Internet Mail Service (5.5.2653.19)
	id <W021H9K0>; Tue, 11 Dec 2001 12:04:16 -0600
Message-ID: <A148C710488FD411BC4000508BD922D859F2F9@aussrv001.austin.bops.com>
From: JohnW@bops.com
To: coordinator@zsh.org
Subject: update to fix I sent yesterday
Date: Tue, 11 Dec 2001 12:04:11 -0600
MIME-Version: 1.0
X-Mailer: Internet Mail Service (5.5.2653.19)
Content-Type: multipart/mixed;
	boundary="----_=_NextPart_000_01C1826E.3C251080"

This message is in MIME format. Since your mail reader does not understand
this format, some or all of this message may not be legible.

------_=_NextPart_000_01C1826E.3C251080
Content-Type: text/plain;
	charset="iso-8859-1"

I haven't actually changed anything in the fix, but I made a diff so
hopefully that'll be more convenient.
 <<patch.diff>> 

------_=_NextPart_000_01C1826E.3C251080
Content-Type: application/octet-stream;
	name="patch.diff"
Content-Disposition: attachment;
	filename="patch.diff"

diff -urH zsh-4.0.4/Src/exec.c zsh-4.0.5/Src/exec.c
--- zsh-4.0.4/Src/exec.c	Wed Oct 24 06:16:32 2001
+++ zsh-4.0.5/Src/exec.c	Mon Dec 10 13:33:48 2001
@@ -3470,7 +3470,7 @@
 getfpfunc(char *s, int *ksh)
 {
     char **pp, buf[PATH_MAX];
-    off_t len;
+    off_t len, textlen;
     char *d;
     Eprog r;
     int fd;
@@ -3490,12 +3490,12 @@
 	    if ((len = lseek(fd, 0, 2)) != -1) {
 		d = (char *) zalloc(len + 1);
 		lseek(fd, 0, 0);
-		if (read(fd, d, len) == len) {
+		if ((textlen = read(fd, d, len)) >= 0) {
 		    char *oldscriptname = scriptname;
 
 		    close(fd);
-		    d[len] = '\0';
-		    d = metafy(d, len, META_REALLOC);
+		    d[textlen] = '\0';
+		    d = metafy(d, textlen, META_REALLOC);
 
 		    scriptname = dupstring(s);
 		    r = parse_string(d, 1);
diff -urH zsh-4.0.4/Src/parse.c zsh-4.0.5/Src/parse.c
--- zsh-4.0.4/Src/parse.c	Wed Oct 24 06:16:32 2001
+++ zsh-4.0.5/Src/parse.c	Mon Dec 10 13:23:12 2001
@@ -2405,7 +2405,7 @@
     int fd, v = 0;
     wordcode buf[FD_PRELEN + 1];
 
-    if ((fd = open(name, O_RDONLY)) < 0) {
+    if ((fd = open(name, O_RDONLY | O_BINARY)) < 0) {
 	if (err)
 	    zwarnnam(nam, "can't open zwc file: %s", name, 0);
 	return NULL;
@@ -2542,7 +2542,7 @@
 static int
 build_dump(char *nam, char *dump, char **files, int ali, int map, int flags)
 {
-    int dfd, fd, hlen, tlen, flen, ona = noaliases;
+    int dfd, fd, hlen, tlen, flen, ona = noaliases, textlen;
     LinkList progs;
     char *file;
     Eprog prog;
@@ -2577,9 +2577,8 @@
 	    return 1;
 	}
 	file = (char *) zalloc(flen + 1);
-	file[flen] = '\0';
 	lseek(fd, 0, 0);
-	if (read(fd, file, flen) != flen) {
+	if ((textlen = read(fd, file, flen)) < 0) {
 	    close(fd);
 	    close(dfd);
 	    zfree(file, flen);
@@ -2589,7 +2588,8 @@
 	    return 1;
 	}
 	close(fd);
-	file = metafy(file, flen, META_REALLOC);
+	file[textlen] = '\0';
+	file = metafy(file, textlen, META_REALLOC);
 
 	if (!(prog = parse_string(file, 1)) || errflag) {
 	    errflag = 0;
@@ -3014,7 +3014,7 @@
 	    Patprog *pp;
 	    int np, fd, po = h->npats * sizeof(Patprog);
 
-	    if ((fd = open(file, O_RDONLY)) < 0 ||
+	    if ((fd = open(file, O_RDONLY | O_BINARY)) < 0 ||
 		lseek(fd, ((h->start * sizeof(wordcode)) +
 			   ((fdflags(d) & FDF_OTHER) ? fdother(d) : 0)), 0) < 0) {
 		if (fd >= 0)

------_=_NextPart_000_01C1826E.3C251080--

