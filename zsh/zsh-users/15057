From zsh-users-return-15057-mason-zsh=primenet.com.au@zsh.org Tue May 11 16:44:18 2010
Return-Path: <zsh-users-return-15057-mason-zsh=primenet.com.au@zsh.org>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 27685 invoked by alias); 11 May 2010 16:44:18 -0000
Mailing-List: contact zsh-users-help@zsh.org; run by ezmlm
Precedence: bulk
X-No-Archive: yes
List-Id: Zsh Users List <zsh-users.zsh.org>
List-Post: <mailto:zsh-users@zsh.org>
List-Help: <mailto:zsh-users-help@zsh.org>
Delivered-To: mailing list zsh-users@zsh.org
X-Seq: 15057
Received: (qmail 22779 invoked from network); 11 May 2010 16:44:06 -0000
X-Spam-Checker-Version: SpamAssassin 3.3.1 (2010-03-16) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=BAYES_00,RCVD_IN_DNSWL_LOW,
	SPF_HELO_PASS autolearn=ham version=3.3.1
Received-SPF: none (ns1.primenet.com.au: domain at csr.com does not designate permitted sender hosts)
Date: Tue, 11 May 2010 17:43:56 +0100
From: Peter Stephenson <pws@csr.com>
To: zsh-users@zsh.org
Subject: Re: Bug in parameter expansion flag 'o'?
Message-ID: <20100511174356.10edb472@csr.com>
In-Reply-To: <4BE979A1.7000209@nickpope.me.uk>
References: <4BE979A1.7000209@nickpope.me.uk>
Organization: Cambridge Silicon Radio
X-Mailer: Claws Mail 3.7.5 (GTK+ 2.18.9; i686-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: quoted-printable
X-OriginalArrivalTime: 11 May 2010 16:43:57.0334 (UTC) FILETIME=[26613B60:01CAF129]
X-Scanned-By: MailControl A_09_40_00 (www.mailcontrol.com) on 10.71.0.128

On Tue, 11 May 2010 16:37:05 +0100
Nick Pope <nick@nickpope.me.uk> wrote:
> It seems to be that there is a possible bug in the parameter
> expansion flag 'o' when the variable is referenced in a string:
>=20
>      $ x=3D(a c b); echo ${(o)x}; echo "${(o)x}"
>      a b c
>      a c b
>=20
> It should be noted that other flags still work alongside:
>=20
>      $ x=3D(a c b); echo ${(Uo)x}; echo "${(Uo)x}"
>      A B C
>      A C B
>=20
> Is this because arrays are being incorrectly converted to string
> prior to getting around to the sorting?

No, it's because arrays are correctly being converted to a string prior to
getting around to the sorting.  Transformations specified by flags are done
late on in the expansion because typically they need the result of any of
the basic operations such as joining and splitting.  It so happens in this
case the effect isn't particularly helpful.  The U flag doesn't care
whether it's operating on a string or an array.

The order of operations at each level of parameter expansions is documented
at the end of the PARAMETER EXPANSION section of zshexpn; here's an
extract.  Note in particular the disclaimer.

   Rules
       Here  is  a  summary  of  the rules for substitution; this assumes t=
hat
       braces are present around the substitution, i.e. ${...}.  Some parti=
cu-
       lar  examples  are  given  below.   Note that the Zsh Development Gr=
oup
       accepts no responsibility for any brain damage which may  occur  dur=
ing
       the reading of the following rules.

...

       5. Double-Quoted Joining
              If  the  value after this process is an array, and the substi=
tu-
              tion appears in double quotes, and no (@) flag is present at =
the
              current  level, the words of the value are joined with the fi=
rst
              character of the parameter $IFS, by  default  a  space,  betw=
een
              each  word  (single  word  arrays are not modified).  If the =
(j)
              flag is present, that is used for joining instead of $IFS.

...

       12. Ordering
              If  the  result  is still an array and one of the =E2=80=98(o=
)=E2=80=99 or =E2=80=98(O)=E2=80=99
              flags was present, the array is reordered.

As you'll see from where things happen in that list, for once the shell is
just being consistent.  This admittedly unusual phenomenon makes the
maintainer's job easier (though in the case of the particular piece of C
code that implements parameter substitution, alas, not very much).

I realise you may need to quote the result for some other reason; if you
can tell us what it is there may be a simple workaround.  Obviously there's
an obvious less simple workaround of assigning to a sorted array before
quoting.

--=20
Peter Stephenson <pws@csr.com>            Software Engineer
Tel: +44 (0)1223 692070                   Cambridge Silicon Radio Limited
Churchill House, Cambridge Business Park, Cowley Road, Cambridge, CB4 0WZ, =
UK


Member of the CSR plc group of companies. CSR plc registered in England and=
 Wales, registered number 4187346, registered office Churchill House, Cambr=
idge Business Park, Cowley Road, Cambridge, CB4 0WZ, United Kingdom

