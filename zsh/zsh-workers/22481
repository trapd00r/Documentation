From zsh-workers-return-22481-mason-zsh=primenet.com.au@sunsite.dk Fri Jun 02 14:09:52 2006
Return-Path: <zsh-workers-return-22481-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 2216 invoked from network); 2 Jun 2006 14:09:50 -0000
X-Spam-Checker-Version: SpamAssassin 3.1.2 (2006-05-25) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=AWL,BAYES_00,
	FORGED_RCVD_HELO autolearn=ham version=3.1.2
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 2 Jun 2006 14:09:50 -0000
Received: (qmail 72620 invoked from network); 2 Jun 2006 14:09:44 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 2 Jun 2006 14:09:44 -0000
Received: (qmail 1657 invoked by alias); 2 Jun 2006 14:09:41 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 22481
Received: (qmail 1642 invoked from network); 2 Jun 2006 14:09:40 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 2 Jun 2006 14:09:40 -0000
Received: (qmail 72341 invoked from network); 2 Jun 2006 14:09:40 -0000
Received: from acolyte.scowler.net (216.254.112.45)
  by a.mx.sunsite.dk with SMTP; 2 Jun 2006 14:09:39 -0000
Received: by acolyte.scowler.net (Postfix, from userid 1000)
	id 8DAA870055; Fri,  2 Jun 2006 10:09:36 -0400 (EDT)
Date: Fri, 2 Jun 2006 10:09:36 -0400
From: Clint Adams <clint@zsh.org>
To: zsh-workers@sunsite.dk
Subject: PATCH: _subversion
Message-ID: <20060602140936.GA10481@scowler.net>
Mail-Followup-To: zsh-workers@sunsite.dk
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
User-Agent: Mutt/1.5.11+cvs20060403

This is from Oliver.

Index: Completion/Unix/Command/_subversion
===================================================================
RCS file: /cvsroot/zsh/zsh/Completion/Unix/Command/_subversion,v
retrieving revision 1.17
diff -u -r1.17 _subversion
--- Completion/Unix/Command/_subversion	27 Sep 2005 13:56:55 -0000	1.17
+++ Completion/Unix/Command/_subversion	2 Jun 2006 14:08:30 -0000
@@ -49,6 +49,11 @@
               '*:file:_files -g ".svn(/e:_svn_deletedfiles:)"'
             )
           ;;
+          diff)
+            args+=(
+	      '*: : _alternative "files:file:_files -g \*\(e:_svn_status:\)" "urls:URL:_svn_urls"'
+	    )
+          ;;
           help)
             args+=(
               '*::sub command:_svn_commands'
@@ -60,6 +65,11 @@
 	      '*:file:_files -g "*(e:_svn_controlled:)"'
             )
           ;;
+          resolved)
+            args+=(
+              '*:file:_files -g "*(e:_svn_conflicts:)"'
+            )
+          ;;
           revert)
             args+=(
               '*:file:_files -g "(.svn|*)(/e:_svn_deletedfiles:,e:_svn_status:)"'
@@ -141,6 +151,11 @@
   [[ -f ${(M)REPLY##*/}.svn/text-base/${REPLY##*/}.svn-base ]]
 }
 
+(( $+functions[_svn_conflicts] )) ||
+_svn_conflicts() {
+  [ -n $REPLY.(mine|r<->)(N[1]) ]
+}
+
 (( $+functions[_svn_deletedfiles] )) ||
 _svn_deletedfiles() {
   # Typical usage would be _files -g '.svn(/e:_svn_deletedfiles:)'
@@ -167,15 +182,32 @@
 
 (( $+functions[_svn_urls] )) ||
 _svn_urls() {
-  local expl
+  local expl remfiles remdispf remdispd suf ret=1
 
-  if [[ -prefix *: ]]; then
-    _urls
+  if [[ -prefix *: ]] && ! _urls &&
+      zstyle -T ":completion:${curcontext}:" remote-access
+  then
+    remfiles=( ${(f)"$(svn list $IPRFIX${PREFIX%%[^./][^/]#} 2>/dev/null)"} )
+    compset -P '*/'
+    compset -S '/*' || suf=file
+    remdispf=(${remfiles:#*/})
+    remdispd=(${(M)remfiles:#*/})
+    _tags files
+    while _tags; do
+      while _next_label files expl ${suf:-directory}; do
+        [[ -n $suf ]] && compadd "$@" "$expl[@]" -d remdispf $remdispf && ret=0
+        compadd ${suf:+-S/} "$@" "$expl[@]" -d remdispd \
+            ${remdispd%/} && ret=0
+      done
+      (( ret )) || return 0
+    done
   else
     compset -S '[^:]*'
     _wanted url-schemas expl 'URL schema' compadd -S '' - \
-        file:// http:// https:// svn:// svn+ssh://
+        file:// http:// https:// svn:// svn+ssh:// && ret=0
   fi
+  
+  return ret
 }
 
 (( $+functions[_svn_commands] )) ||

