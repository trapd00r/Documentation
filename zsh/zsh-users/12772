From zsh-users-return-12772-mason-zsh=primenet.com.au@sunsite.dk Thu Apr 10 09:31:44 2008
Return-Path: <zsh-users-return-12772-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 1233 invoked from network); 10 Apr 2008 09:31:42 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.4 (2008-01-01) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.3 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.4
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 10 Apr 2008 09:31:42 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 85122 invoked from network); 10 Apr 2008 09:31:30 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 10 Apr 2008 09:31:30 -0000
Received: (qmail 4884 invoked by alias); 10 Apr 2008 09:31:19 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 12772
Received: (qmail 4869 invoked from network); 10 Apr 2008 09:31:18 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 10 Apr 2008 09:31:18 -0000
Received: from cluster-d.mailcontrol.com (cluster-d.mailcontrol.com [217.69.20.190])
	by bifrost.dotsrc.org (Postfix) with ESMTP id D8B6C802265F
	for <zsh-users@sunsite.dk>; Thu, 10 Apr 2008 11:31:15 +0200 (CEST)
Received: from cameurexb01.EUROPE.ROOT.PRI ([62.189.241.200])
	by rly27d.srv.mailcontrol.com (MailControl) with ESMTP id m3A9V9sN010827
	for <zsh-users@sunsite.dk>; Thu, 10 Apr 2008 10:31:14 +0100
Received: from news01 ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.3959);
	 Thu, 10 Apr 2008 10:31:10 +0100
Date: Thu, 10 Apr 2008 10:31:10 +0100
From: Peter Stephenson <pws@csr.com>
To: zsh-users@sunsite.dk
Subject: Re: iterating through a hierarchy with a filter
Message-ID: <20080410103110.1e1e85cc@news01>
In-Reply-To: <DDABD6BC-F3D9-4277-86C1-776B24CB914F@gmail.com>
References: <8BAD0AA6-3B6F-4946-B636-6C16B56A944E@gmail.com>
	<200804100851.m3A8pk9S003521@news01.csr.com>
	<DDABD6BC-F3D9-4277-86C1-776B24CB914F@gmail.com>
Organization: CSR
X-Mailer: Claws Mail 3.3.1 (GTK+ 2.12.5; i386-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
X-OriginalArrivalTime: 10 Apr 2008 09:31:10.0722 (UTC) FILETIME=[9CB6EE20:01C89AED]
X-Scanned-By: MailControl A-08-00-05 (www.mailcontrol.com) on 10.68.0.137
X-Virus-Scanned: ClamAV 0.91.2/6693/Thu Apr 10 10:22:27 2008 on bifrost
X-Virus-Status: Clean

On Thu, 10 Apr 2008 02:03:21 -0700
Alexy Khrabrov <deliverable@gmail.com> wrote:
> On Apr 10, 2008, at 1:51 AM, Peter Stephenson wrote:
> >
> > for file1 in source/**/*.xml; do
> >  file2=dest/${${file1##source/}:r}.txt
> >  destdir=${file2:h}
> >  [[ -d $destdir ]] || mkdir -p $destdir
> >  filter <$file1 >$file2
> > done
> >
> > If that doesn't work even with a few small tweaks, you'll probably  
> > have to tell us why before we can advise better.
> 
> Well, my hierarchy is a million small files.  So I doubt globbing will  
> work -- should I try?  :)

You might get lucky, but it sounds like you need to do it the hard way.
You can use that code as the core, except you can move the directory
handling out of the way and end up with something like (again this is
untested):


handledir() {
  local sdir=$1 ddir=$2
  local dir file tail

  [[ -d $ddir ]] || mkdir -p $ddir

  for dir in $sdir/*(/N); do
     handledir $dir $ddir/${dir:t}
  done

  for file in $sdir/*.xml(N)); do
     filter <$file >$ddir/{$file:t}
  done
}

handledir sourcedir destdir


The only special zsh features are the globbing flags.  (N) forces
the expression to expand to nothing at all if no patterns matched.

-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070

