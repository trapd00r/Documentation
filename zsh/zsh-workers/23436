From zsh-workers-return-23436-mason-zsh=primenet.com.au@sunsite.dk Sun May 13 20:14:47 2007
Return-Path: <zsh-workers-return-23436-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 19760 invoked from network); 13 May 2007 20:14:45 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.0 (2007-05-01) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=AWL,BAYES_00 autolearn=no
	version=3.2.0
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 13 May 2007 20:14:45 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 23091 invoked from network); 13 May 2007 20:14:39 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 13 May 2007 20:14:39 -0000
Received: (qmail 26340 invoked by alias); 13 May 2007 20:14:36 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 23436
Received: (qmail 26330 invoked from network); 13 May 2007 20:14:36 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 13 May 2007 20:14:36 -0000
Received: (qmail 22810 invoked from network); 13 May 2007 20:14:36 -0000
Received: from mtaout03-winn.ispmail.ntl.com (81.103.221.49)
  by a.mx.sunsite.dk with SMTP; 13 May 2007 20:14:33 -0000
Received: from aamtaout01-winn.ispmail.ntl.com ([81.103.221.35])
          by mtaout03-winn.ispmail.ntl.com with ESMTP
          id <20070513201431.RJKS16175.mtaout03-winn.ispmail.ntl.com@aamtaout01-winn.ispmail.ntl.com>
          for <zsh-workers@sunsite.dk>; Sun, 13 May 2007 21:14:31 +0100
Received: from pwslaptop.csr.com ([81.107.45.67])
          by aamtaout01-winn.ispmail.ntl.com with SMTP
          id <20070513201431.ISNX219.aamtaout01-winn.ispmail.ntl.com@pwslaptop.csr.com>
          for <zsh-workers@sunsite.dk>; Sun, 13 May 2007 21:14:31 +0100
Date: Sun, 13 May 2007 21:12:52 +0100
From: Peter Stephenson <p.w.stephenson@ntlworld.com>
To: zsh-workers@sunsite.dk
Subject: Re: problems with 4.3.4 and Tru64
Message-Id: <20070513211252.4561b92b.p.w.stephenson@ntlworld.com>
In-Reply-To: <20070510123039.c36e16f2.pws@csr.com>
References: <Pine.OSF.4.64.0705101117330.479844@replicant.hut.fi>
	<200705100955.l4A9tTmQ001343@news01.csr.com>
	<Pine.OSF.4.64.0705101305200.479844@replicant.hut.fi>
	<Pine.OSF.4.64.0705101310130.479844@replicant.hut.fi>
	<20070510113032.3d50cd67.pws@csr.com>
	<Pine.OSF.4.64.0705101334180.479844@replicant.hut.fi>
	<20070510123039.c36e16f2.pws@csr.com>
X-Mailer: Sylpheed 2.3.1 (GTK+ 2.10.8; i386-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit

On Thu, 10 May 2007 12:30:39 +0100
Peter Stephenson <pws@csr.com> wrote:
> However, I think I've got somewhere with reproducing your original
> problem by using your locales:
> 
> LANG=C
> LC_COLLATE="C"
> LC_CTYPE=fi_FI.UTF-8
> LC_MONETARY="C"
> LC_NUMERIC="C"
> LC_TIME="C"
> LC_MESSAGES="C"
> LC_ALL=
> 
> This also fails to handle multibyte characters properly.
> (However, in my case the multibyte option is still set.)
> If I remove the LANG=C from that set, it starts working.  This
> is obviously a bug.

Unfortunately, this wasn't Timo's problem, but this fixes it anyway.

I'm assuming, at least, that setting one of the variables above to the
empty string should be equivalent to leaving it unset.  The rule for
setlocale() internally is that the empty string means "use the
environment variable", but that's meaninglessly self-referential here,
so I think the right thing to do is for the shell deliberately to let
the value of $LANG and (if appropriate) the LC_* categories show
through.

Index: Src/params.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/params.c,v
retrieving revision 1.124
diff -u -r1.124 params.c
--- Src/params.c	13 Apr 2007 11:54:17 -0000	1.124
+++ Src/params.c	13 May 2007 20:07:31 -0000
@@ -3414,10 +3414,21 @@
 {
     struct localename *ln;
 
+    /*
+     * Set the global locale to the value passed, but override
+     * this with any non-empty definitions for specific
+     * categories.
+     *
+     * We only use non-empty definitions because empty values aren't
+     * valid as locales; when passed to setlocale() they mean "use the
+     * environment variable", but if that's what we're setting the value
+     * from this is meaningless.  So just all $LANG to show through in
+     * that case.
+     */
     setlocale(LC_ALL, x ? x : "");
     queue_signals();
     for (ln = lc_names; ln->name; ln++)
-	if ((x = getsparam(ln->name)))
+	if ((x = getsparam(ln->name)) && *x)
 	    setlocale(ln->category, x);
     unqueue_signals();
 }
@@ -3427,10 +3438,18 @@
 lc_allsetfn(Param pm, char *x)
 {
     strsetfn(pm, x);
-    if (!x) {
-	queue_signals();
-	setlang(getsparam("LANG"));
-	unqueue_signals();
+    /*
+     * Treat an empty LC_ALL the same as an unset one,
+     * namely by using LANG as the default locale but overriding
+     * that with any LC_* that are set.
+     */
+    if (!x || !*x) {
+	x = getsparam("LANG");
+	if (x && *x) {
+	    queue_signals();
+	    setlang(x);
+	    unqueue_signals();
+	}
     }
     else
 	setlocale(LC_ALL, x);
@@ -3448,18 +3467,27 @@
 void
 lcsetfn(Param pm, char *x)
 {
+    char *x2;
     struct localename *ln;
 
     strsetfn(pm, x);
-    if (getsparam("LC_ALL"))
+    if ((x2 = getsparam("LC_ALL")) && *x)
 	return;
     queue_signals();
-    if (!x)
+    /* Treat empty LC_* the same as unset. */
+    if (!x || !*x)
 	x = getsparam("LANG");
 
-    for (ln = lc_names; ln->name; ln++)
-	if (!strcmp(ln->name, pm->node.nam))
-	    setlocale(ln->category, x ? x : "");
+    /*
+     * If we've got no non-empty string at this
+     * point (after checking $LANG, too),
+     * we shouldn't bother setting anything.
+     */
+    if (x && *x) {
+	for (ln = lc_names; ln->name; ln++)
+	    if (!strcmp(ln->name, pm->node.nam))
+		setlocale(ln->category, x);
+    }
     unqueue_signals();
 }
 #endif /* USE_LOCALE */

-- 
Peter Stephenson <p.w.stephenson@ntlworld.com>
Web page now at http://homepage.ntlworld.com/p.w.stephenson/

