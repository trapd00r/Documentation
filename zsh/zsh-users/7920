From zsh-users-return-7920-mason-zsh=primenet.com.au@sunsite.dk Tue Aug 24 15:46:36 2004
Return-Path: <zsh-users-return-7920-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 16214 invoked from network); 24 Aug 2004 15:46:31 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 24 Aug 2004 15:46:31 -0000
Received: (qmail 90824 invoked from network); 24 Aug 2004 15:46:17 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 24 Aug 2004 15:46:17 -0000
Received: (qmail 25820 invoked by alias); 24 Aug 2004 15:45:33 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 7920
Received: (qmail 25809 invoked from network); 24 Aug 2004 15:45:32 -0000
Received: from unknown (HELO a.mx.sunsite.dk) (130.225.247.88)
  by 130.225.247.90 with SMTP; 24 Aug 2004 15:45:32 -0000
Received: (qmail 88802 invoked from network); 24 Aug 2004 15:43:43 -0000
Received: from unknown (HELO moonbase.zanshin.com) (167.160.213.139)
  by a.mx.sunsite.dk with SMTP; 24 Aug 2004 15:43:41 -0000
Received: from toltec.zanshin.com (toltec.zanshin.com [64.84.47.166])
	by moonbase.zanshin.com (8.12.11/8.12.11) with ESMTP id i7OFhdPP005983
	for <zsh-users@sunsite.dk>; Tue, 24 Aug 2004 08:43:39 -0700
Date: Tue, 24 Aug 2004 08:43:39 -0700 (PDT)
From: Bart Schaefer <schaefer@brasslantern.com>
Reply-To: zsh-users@sunsite.dk
To: zsh-users@sunsite.dk
Subject: Re: Using zle outside zsh
In-Reply-To: <20040824093921.GA25290@DervishD>
Message-ID: <Pine.LNX.4.61.0408240747380.5806@toltec.zanshin.com>
References: <20040823155951.GA24279@DervishD> <Pine.LNX.4.61.0408231018430.5997@toltec.zanshin.com>
 <20040823194613.GA25072@DervishD> <Pine.LNX.4.61.0408231436340.3917@toltec.zanshin.com>
 <20040824093921.GA25290@DervishD>
MIME-Version: 1.0
Content-Type: MULTIPART/MIXED; BOUNDARY="1413522991-138028396-1093359063=:5806"
Content-ID: <Pine.LNX.4.61.0408240812410.5806@toltec.zanshin.com>
X-Spam-Checker-Version: SpamAssassin 2.63 on a.mx.sunsite.dk
X-Spam-Level: 
X-Spam-Status: No, hits=0.0 required=6.0 tests=none autolearn=no version=2.63
X-Spam-Hits: 0.0

  This message is in MIME format.  The first part should be readable text,
  while the remaining parts are likely unreadable without MIME-aware tools.

--1413522991-138028396-1093359063=:5806
Content-Type: TEXT/PLAIN; CHARSET=iso-8859-1
Content-Transfer-Encoding: 8BIT
Content-ID: <Pine.LNX.4.61.0408240812411.5806@toltec.zanshin.com>


On Tue, 24 Aug 2004, DervishD wrote:

>     Yes, my fault, but that doesn't solve the problem :( With that
> change the first read works but the second doesn't.

You didn't read/copy precisely enough, Raúl.

> # This worked as before since the line is exactly 'ftp> '.
> # Same for telnet
> zpty -r ftp response '(|*\n)ftp> '

zpty -r ftp response $'(|*\n)ftp> '

Note the dollar-sign.  Without that the \n is not converted to a newline.

Also, you do NOT want "zpty -b".  It makes the PTY non-blocking in *both*
directions, which confuses ftp into insanity.  It may even have exited by
the time you first try to write to it.

As for other reads hanging forever ... well, "ftp> " isn't the only prompt
that might be printed.  It may be asking for a username or a password, for
example, and "password: " won't match the pattern.  Try something like

zpty -r ftp response $'(|*\n)(ftp> |*[[:punct:]]: |Password:)'

Finally, vared is probably printing a carriage return and thereby erasing 
the last line of the "print -nr" output, which might fool you into 
thinking the read is hung.  So pick the last line out of $response and
pass that to vared as the prompt, like so:

pmpt=${response##$'*\n'}

while line=''; vared -e -p $pmpt line
do
  ...
  pmpt=${response##$'*\n'}
done
--1413522991-138028396-1093359063=:5806--

