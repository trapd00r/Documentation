From zsh-workers-return-23036-mason-zsh=primenet.com.au@sunsite.dk Fri Dec 08 18:49:29 2006
Return-Path: <zsh-workers-return-23036-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 4390 invoked from network); 8 Dec 2006 18:49:23 -0000
X-Spam-Checker-Version: SpamAssassin 3.1.7 (2006-10-05) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.4 required=5.0 tests=AWL,BAYES_00,
	FORGED_RCVD_HELO autolearn=ham version=3.1.7
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 8 Dec 2006 18:49:23 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 11357 invoked from network); 8 Dec 2006 18:49:17 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 8 Dec 2006 18:49:17 -0000
Received: (qmail 28728 invoked by alias); 8 Dec 2006 18:49:14 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 23036
Received: (qmail 28718 invoked from network); 8 Dec 2006 18:49:14 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 8 Dec 2006 18:49:14 -0000
Received: (qmail 11051 invoked from network); 8 Dec 2006 18:49:14 -0000
Received: from cluster-d.mailcontrol.com (217.69.20.190)
  by a.mx.sunsite.dk with SMTP; 8 Dec 2006 18:49:11 -0000
Received: from cameurexb01.EUROPE.ROOT.PRI ([62.189.241.200])
	by rly19d.srv.mailcontrol.com (MailControl) with ESMTP id kB8ImMuc016439
	for <zsh-workers@sunsite.dk>; Fri, 8 Dec 2006 18:48:51 GMT
Received: from news01.csr.com ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.1830);
	 Fri, 8 Dec 2006 18:48:28 +0000
Date: Fri, 8 Dec 2006 18:48:20 +0000
From: Peter Stephenson <pws@csr.com>
To: zsh-workers@sunsite.dk (Zsh hackers list)
Subject: Re: PATCH: $' completion, the story so far
Message-Id: <20061208184820.0758614e.pws@csr.com>
In-Reply-To: <200612032100.kB3L0gl2023398@pwslaptop.csr.com>
References: <200612032100.kB3L0gl2023398@pwslaptop.csr.com>
Organization: Cambridge Silicon Radio
X-Mailer: Sylpheed version 2.2.10 (GTK+ 2.10.4; i386-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
X-OriginalArrivalTime: 08 Dec 2006 18:48:28.0522 (UTC) FILETIME=[73328CA0:01C71AF9]
X-Scanned-By: MailControl A-07-06-80 (www.mailcontrol.com) on 10.68.0.129

Peter Stephenson <p.w.stephenson@ntlworld.com> wrote:
> Here's my attempt so far to make $' quoting work a little better in
> completion.
>...
> If you want to see what's still wrong, try
> 
> su -c "ls $'<file>
> 
> and you'll get a whole load of unnecessary backslashes when a word is
> inserted (for some reason listing alone works OK).

This fixes two real problems and a cosmetic one, the latter being that the
$ in the double quotes was quoted by the internal equivalent of
${(qqq)...}.  This is harmless because the backslash is stripped, but I
think leaving it without is preferable --- quotestring() usually only adds
backslashes when they're necessary.

There's still a problem with multiple uses of $'...':

su -c "ls $'onefile' $'...

doesn't complete properly.

Index: Src/utils.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/utils.c,v
retrieving revision 1.146
diff -u -r1.146 utils.c
--- Src/utils.c	3 Dec 2006 21:07:18 -0000	1.146
+++ Src/utils.c	8 Dec 2006 18:32:40 -0000
@@ -4292,9 +4292,17 @@
 		if (!*u)
 		    u--;
 		continue;
-	    }
-	    else if ((*u == String || *u == Qstring) &&
-		     (u[1] == Inpar || u[1] == Inbrack || u[1] == Inbrace)) {
+	    } else if ((*u == Qstring || *u == '$') && u[1] == '\'' &&
+		       instring == QT_DOUBLE) {
+		/*
+		 * We don't need to quote $'...' inside a double-quoted
+		 * string.  This is largely cosmetic; it looks neater
+		 * if we don't but it doesn't do any harm since the
+		 * \ is stripped.
+		 */
+		*v++ = *u++;
+	    } else if ((*u == String || *u == Qstring) &&
+		       (u[1] == Inpar || u[1] == Inbrack || u[1] == Inbrace)) {
 		char c = (u[1] == Inpar ? Outpar : (u[1] == Inbrace ?
 						    Outbrace : Outbrack));
 		char beg = *u;
Index: Src/Zle/compcore.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/compcore.c,v
retrieving revision 1.87
diff -u -r1.87 compcore.c
--- Src/Zle/compcore.c	3 Dec 2006 21:07:18 -0000	1.87
+++ Src/Zle/compcore.c	8 Dec 2006 18:32:42 -0000
@@ -1653,6 +1653,7 @@
 	    instring = QT_DOLLARS;
 	    nsptr++;
 	    tsptr++;
+	    swb++;
 	    break;
 	}
 
Index: Src/Zle/zle_tricky.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/zle_tricky.c,v
retrieving revision 1.80
diff -u -r1.80 zle_tricky.c
--- Src/Zle/zle_tricky.c	3 Dec 2006 21:07:18 -0000	1.80
+++ Src/Zle/zle_tricky.c	8 Dec 2006 18:32:42 -0000
@@ -1032,6 +1032,16 @@
 has_real_token(const char *s)
 {
     while (*s) {
+	/*
+	 * Special action required for $' strings, which
+	 * need to be treated like nulls.
+	 */
+	if ((*s == Qstring && s[1] == '\'') ||
+	    (*s == String && s[1] == Snull))
+	{
+	    s += 2;
+	    continue;
+	}
 	if (itok(*s) && !inull(*s))
 	    return 1;
 	s++;


To access the latest news from CSR copy this link into a web browser:  http://www.csr.com/email_sig.php

