From zsh-workers-return-28232-mason-zsh=primenet.com.au@zsh.org Mon Sep 06 04:12:08 2010
Return-Path: <zsh-workers-return-28232-mason-zsh=primenet.com.au@zsh.org>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 27433 invoked by alias); 6 Sep 2010 04:12:08 -0000
Mailing-List: contact zsh-workers-help@zsh.org; run by ezmlm
Precedence: bulk
X-No-Archive: yes
List-Id: Zsh Workers List <zsh-workers.zsh.org>
List-Post: <mailto:zsh-workers@zsh.org>
List-Help: <mailto:zsh-workers-help@zsh.org>
Delivered-To: mailing list zsh-workers@zsh.org
X-Seq: 28232
Received: (qmail 10655 invoked from network); 6 Sep 2010 04:12:06 -0000
X-Spam-Checker-Version: SpamAssassin 3.3.1 (2010-03-16) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-1.9 required=5.0 tests=BAYES_00,RCVD_IN_DNSWL_NONE
	autolearn=ham version=3.3.1
Received-SPF: none (ns1.primenet.com.au: domain at closedmail.com does not designate permitted sender hosts)
From: Bart Schaefer <schaefer@brasslantern.com>
Message-id: <100905211147.ZM10043@torch.brasslantern.com>
Date: Sun, 05 Sep 2010 21:11:47 -0700
In-reply-to: <20100831143337.GA1108@uni-due.de>
Comments: In reply to Philipp Hartwig <philipp.hartwig@uni-due.de>
 "Re: segfault on menu-select" (Aug 31,  4:33pm)
References: <87wrrv4yrg.fsf@ft.bewatermyfriend.org>
 <20100812165307.GA24998@ph>	<87r5i34v51.fsf@ft.bewatermyfriend.org>
	<20100812173356.GC24998@ph>	<100812160702.ZM20648@torch.brasslantern.com>
	<20100813080811.GB495@ph>	<100813085709.ZM22377@torch.brasslantern.com>
	<20100813214357.012f7f35@pws-pc>	<100815134326.ZM20936@torch.brasslantern.com>
	<100815153444.ZM21188@torch.brasslantern.com>
	<20100831143337.GA1108@uni-due.de>
X-Mailer: OpenZMail Classic (0.9.2 24April2005)
To: zsh-workers@zsh.org
Subject: Re: segfault on menu-select
MIME-version: 1.0
Content-type: text/plain; charset=us-ascii

On Aug 31,  4:33pm, Philipp Hartwig wrote:
} Subject: Re: segfault on menu-select
}
} > The difference seems to be whether the zsh/compctl module is loaded.  I
} > don't immediately know why zsh/compctl would be necessary for proper
} > execution of menu-select, but if I add
} > 
} > zmodload zsh/compctl
} > 
} > to the minimal zshrc, I am no longer able to force a crash.

Hmm, and hmm again.  (Yes, I'm hmm-ing at my own previous remarks.)

} I also do not experience any more crashes since adding
} 
} zmodload zsh/compctl
} 
} to my .zshrc. Unfortunately this breaks the menu-select feature in some 
} cases.

I've been fooling with this a bit, and it's not broken; the best I can
describe it is to say it's just not ready to start yet.

} [in a directory with files baz-foo and test-foo and compctl not loaded]
} 
} ph% vi foo<tab><tab><ctrl-o>
} 
} will work out nice and give me the desired menu-selection (or crash).  
} But if I [zmodload zsh/compctl as well], no menu-select will 
} take place anymore.

I can reproduce this.  However, menu-select will take place for me if I
simply add one more TAB:

torch% vi foo<tab><tab><tab><ctrl-o>

This comes down to the code passing through the "else" branch at lines
1013 - 1025 of Src/Zle/compcore.c -- with compctl not loaded, dat.lst
is 0 after runhookdef(COMPCTLMAKEHOOK, ...), but with compctl loaded
dat.list becomes nonzero if we have not made a third attempt to allow
compctl to perform default completion of -foo.

Now, what this has to do with the crash (not) happening after we have
passed (or not) through the compctl hooks, I still don't follow.

