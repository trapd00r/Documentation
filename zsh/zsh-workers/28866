From zsh-workers-return-28866-mason-zsh=primenet.com.au@zsh.org Sun Mar 06 20:26:53 2011
Return-Path: <zsh-workers-return-28866-mason-zsh=primenet.com.au@zsh.org>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 9296 invoked by alias); 6 Mar 2011 20:26:53 -0000
Mailing-List: contact zsh-workers-help@zsh.org; run by ezmlm
Precedence: bulk
X-No-Archive: yes
List-Id: Zsh Workers List <zsh-workers.zsh.org>
List-Post: <mailto:zsh-workers@zsh.org>
List-Help: <mailto:zsh-workers-help@zsh.org>
Delivered-To: mailing list zsh-workers@zsh.org
X-Seq: 28866
Received: (qmail 20272 invoked from network); 6 Mar 2011 20:26:50 -0000
X-Spam-Checker-Version: SpamAssassin 3.3.1 (2010-03-16) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-1.9 required=5.0 tests=BAYES_00,RCVD_IN_DNSWL_NONE
	autolearn=ham version=3.3.1
Received-SPF: pass (ns1.primenet.com.au: SPF record at ntlworld.com designates 81.103.221.49 as permitted sender)
Date: Sun, 6 Mar 2011 20:26:36 +0000
From: Peter Stephenson <p.w.stephenson@ntlworld.com>
To: "Zsh Hackers' List" <zsh-workers@zsh.org>
Subject: Re: sh compatibility issue
Message-ID: <20110306202636.2fdd00cd@pws-pc.ntlworld.com>
In-Reply-To: <20110304133634.GB35982@stack.nl>
References: <20110222200259.2aab2dcc@pws-pc.ntlworld.com>
	<20110304133634.GB35982@stack.nl>
X-Mailer: Claws Mail 3.7.8 (GTK+ 2.22.0; x86_64-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
X-Cloudmark-Analysis: v=1.1 cv=JvdXmxIgLJv2/GthKqHpGJEEHukvLcvELVXUanXFreg= c=1 sm=0 a=kj9zAlcOel0A:10 a=NLZqzBF-AAAA:8 a=2BY_8Kud6MAsINmxwOsA:9 a=8LK-LxCV2s_Nj1R9DvoA:7 a=TUTPwVw3FF0rVTIk00oczXaV5AcA:4 a=CjuIK1q_8ugA:10 a=_dQi-Dcv4p4A:10 a=9_fH3D9IokCyoHKj:21 a=0QrlU-Hk9OxtlsXi:21 a=HpAAvcLHHh0Zw7uRqdWCyQ==:117

On Fri, 4 Mar 2011 14:36:34 +0100
Jilles Tjoelker <jilles@stack.nl> wrote:
> Although 'command' is often implemented as some sort of precommand
> modifier, the POSIX specification says it is a regular builtin,
> therefore redirection errors are not fatal (and variable assignments do
> not persist). The specification also says that 'command' causes operand
> (syntax) errors to be non-fatal.

This should fix at least some such problems.

Index: Src/exec.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/exec.c,v
retrieving revision 1.191
diff -p -u -r1.191 exec.c
--- Src/exec.c	23 Feb 2011 09:47:06 -0000	1.191
+++ Src/exec.c	6 Mar 2011 20:25:15 -0000
@@ -2324,7 +2324,7 @@ execcmd(Estate state, int input, int out
     int nullexec = 0, assign = 0, forked = 0;
     int is_shfunc = 0, is_builtin = 0, is_exec = 0, use_defpath = 0;
     /* Various flags to the command. */
-    int cflags = 0, checked = 0, oautocont = -1;
+    int cflags = 0, orig_cflags = 0, checked = 0, oautocont = -1;
     LinkList redir;
     wordcode code;
     Wordcode beg = state->pc, varspc;
@@ -2416,6 +2416,7 @@ execcmd(Estate state, int input, int out
 		checked = !(cflags & BINF_BUILTIN);
 		break;
 	    }
+	    orig_cflags |= cflags;
 	    cflags &= ~BINF_BUILTIN & ~BINF_COMMAND;
 	    cflags |= hn->flags;
 	    if (!(hn->flags & BINF_PREFIX)) {
@@ -3298,11 +3299,13 @@ execcmd(Estate state, int input, int out
 
  done:
     if (isset(POSIXBUILTINS) &&
-	(cflags & (BINF_PSPECIAL|BINF_EXEC))) {
+	(cflags & (BINF_PSPECIAL|BINF_EXEC)) &&
+	!(orig_cflags & BINF_COMMAND)) {
 	/*
 	 * For POSIX-compatible behaviour with special
 	 * builtins (including exec which we don't usually
 	 * classify as a builtin) we treat all errors as fatal.
+	 * The "command" builtin is not special so resets this behaviour.
 	 */
 	if (redir_err || errflag) {
 	    if (!isset(INTERACTIVE)) {
Index: Test/A04redirect.ztst
===================================================================
RCS file: /cvsroot/zsh/zsh/Test/A04redirect.ztst,v
retrieving revision 1.17
diff -p -u -r1.17 A04redirect.ztst
--- Test/A04redirect.ztst	22 Feb 2011 20:09:20 -0000	1.17
+++ Test/A04redirect.ztst	6 Mar 2011 20:25:15 -0000
@@ -386,6 +386,13 @@
 ?zsh:2: no such file or directory: /nonexistent/nonexistent
 
   $ZTST_testdir/../Src/zsh -f -o POSIX_BUILTINS -c '
+  command set >/nonexistent/nonexistent
+  echo output'
+0:failed special builtin redir with command prefix, POSIX_BUILTINS
+>output
+?zsh:2: no such file or directory: /nonexistent/nonexistent
+
+  $ZTST_testdir/../Src/zsh -f -o POSIX_BUILTINS -c '
   echo >/nonexistent/nonexistent
   echo output'
 0:failed unspecial builtin redir, POSIX_BUILTINS

-- 
Peter Stephenson <p.w.stephenson@ntlworld.com>
Web page now at http://homepage.ntlworld.com/p.w.stephenson/

