From zsh-users-return-11873-mason-zsh=primenet.com.au@sunsite.dk Mon Sep 24 09:24:55 2007
Return-Path: <zsh-users-return-11873-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 29347 invoked from network); 24 Sep 2007 09:24:53 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.3 (2007-08-08) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.3
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 24 Sep 2007 09:24:53 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 79691 invoked from network); 24 Sep 2007 09:24:46 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 24 Sep 2007 09:24:46 -0000
Received: (qmail 18884 invoked by alias); 24 Sep 2007 09:24:38 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 11873
Received: (qmail 18865 invoked from network); 24 Sep 2007 09:24:38 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 24 Sep 2007 09:24:38 -0000
Received: (qmail 78637 invoked from network); 24 Sep 2007 09:24:38 -0000
Received: from cluster-g.mailcontrol.com (85.115.41.190)
  by a.mx.sunsite.dk with SMTP; 24 Sep 2007 09:24:34 -0000
Received: from cameurexb01.EUROPE.ROOT.PRI ([62.189.241.200])
	by rly12g.srv.mailcontrol.com (MailControl) with ESMTP id l8O9OSGr009431
	for <zsh-users@sunsite.dk>; Mon, 24 Sep 2007 10:24:29 +0100
Received: from news01.csr.com ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.1830);
	 Mon, 24 Sep 2007 10:24:27 +0100
Received: from news01.csr.com (localhost.localdomain [127.0.0.1])
	by news01.csr.com (8.14.1/8.13.4) with ESMTP id l8O9ORwU005106
	for <zsh-users@sunsite.dk>; Mon, 24 Sep 2007 10:24:27 +0100
Received: from csr.com (pws@localhost)
	by news01.csr.com (8.14.1/8.14.1/Submit) with ESMTP id l8O9OPNP005103
	for <zsh-users@sunsite.dk>; Mon, 24 Sep 2007 10:24:26 +0100
Message-Id: <200709240924.l8O9OPNP005103@news01.csr.com>
X-Authentication-Warning: news01.csr.com: pws owned process doing -bs
To: zsh-users@sunsite.dk
Subject: Re: _values and specifying -M to compadd
In-reply-to: <20070924050450.GA32335@lorien.comfychair.org>
References: <20070924050450.GA32335@lorien.comfychair.org>
Comments: In-reply-to Danek Duvall <duvall@comfychair.org>
   message dated "Sun, 23 Sep 2007 22:04:50 -0700."
Date: Mon, 24 Sep 2007 10:24:25 +0100
From: Peter Stephenson <pws@csr.com>
X-OriginalArrivalTime: 24 Sep 2007 09:24:28.0030 (UTC) FILETIME=[B47CC1E0:01C7FE8C]
Content-Type: text/plain
MIME-Version: 1.0
X-Scanned-By: MailControl A-07-08-10 (www.mailcontrol.com) on 10.71.0.122

Danek Duvall wrote:
> I've spent a couple of hours trying to figure out how to do this, but am
> stumped.  I'm working on completion for the Solaris command pfexec, one
> option of which takes an argument of a fixed set of tokens, separated by
> commas, where each token may optionally be prefixed by a "!".
> 
> I can do the simple
> 
>     _values -s , "descr" $tokens
> 
> where $tokens was set earlier to be ( $tokens \!$^tokens ), but that's
> cheap, and it doubles the list of tokens, which isn't very nice looking.
> I'd like it to just ignore a "!" when it's there, a la setopt's ignoring of
> "no", but I can't figure out how to make that work with _values, which
> doesn't seem to give an option to pass options (specifically -M) on to
> compadd.
> 
> Is there some other reasonably simple way of doing this, or will I have to
> invoke compadd directly?

_values is designed to be smart about the values of key/value pairs,
whereas you need something to be smart about the keys.  (_values is
also a bit of a mess because the internals are delegated to a builtin
"compvalues" which is only documented in the C source.)

Actually, using compadd directly isn't that hairy here.  I got this to work:

  local expl

  tokens=(apple banana cucumber date elephant)

  # Ignore existing values
  compset -P '*,'
  # Ignore a leading !, maybe backslash-quoted
  compset -P '\\#!'

  # Use , as a (removable) separator
  _wanted tokens expl 'desription for tokens' compadd -qS , -a tokens

The hairy bit is the pattern that removes a !.  Since you need to
quote that with extendedglob, you'd expect things like 'apple,!banana'
and apple,\!banana to be equivalent, but actually for the first you need
to remove ! and for the second you need to remove \!.  Previous
experience suggests investigation of this would lead to madness, so
I've just worked around it.

This ought to be enough to make a start.  It would obviously get more
complicated if you need key/value pairs as well, but from your
description it sounds like you don't.

-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070


.

