From zsh-users-return-11955-mason-zsh=primenet.com.au@sunsite.dk Mon Oct 08 03:28:26 2007
Return-Path: <zsh-users-return-11955-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 6895 invoked from network); 8 Oct 2007 03:28:18 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.3 (2007-08-08) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.3
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 8 Oct 2007 03:28:18 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 71462 invoked from network); 8 Oct 2007 03:28:12 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 8 Oct 2007 03:28:12 -0000
Received: (qmail 26932 invoked by alias); 8 Oct 2007 03:28:04 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 11955
Received: (qmail 26916 invoked from network); 8 Oct 2007 03:28:03 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 8 Oct 2007 03:28:03 -0000
Received: (qmail 70258 invoked from network); 8 Oct 2007 03:28:03 -0000
Received: from vms044pub.verizon.net (206.46.252.44)
  by a.mx.sunsite.dk with SMTP; 8 Oct 2007 03:27:57 -0000
Received: from torch.brasslantern.com ([71.116.76.59])
 by vms044.mailsrvcs.net (Sun Java System Messaging Server 6.2-6.01 (built Apr
 3 2006)) with ESMTPA id <0JPK00EO4PMIJ2H0@vms044.mailsrvcs.net> for
 zsh-users@sunsite.dk; Sun, 07 Oct 2007 22:27:56 -0500 (CDT)
Received: from torch.brasslantern.com (localhost.localdomain [127.0.0.1])
	by torch.brasslantern.com (8.13.1/8.13.1) with ESMTP id l983Rs51024272	for
 <zsh-users@sunsite.dk>; Sun, 07 Oct 2007 20:27:54 -0700
Received: (from schaefer@localhost)	by torch.brasslantern.com
 (8.13.1/8.13.1/Submit) id l983RrOW024271	for zsh-users@sunsite.dk; Sun,
 07 Oct 2007 20:27:53 -0700
Date: Sun, 07 Oct 2007 20:27:53 -0700
From: Bart Schaefer <schaefer@brasslantern.com>
Subject: Re: PROMPT escape sequences
In-reply-to: <20071007232744.18528.qmail@smasher.org>
To: zsh-users@sunsite.dk
Message-id: <071007202753.ZM24270@torch.brasslantern.com>
MIME-version: 1.0
X-Mailer: OpenZMail Classic (0.9.2 24April2005)
Content-type: text/plain; charset=us-ascii
References: <20071007103407.33577.qmail@smasher.org>
	<071007103242.ZM23816@torch.brasslantern.com>
	<20071007232744.18528.qmail@smasher.org>
Comments: In reply to Atom Smasher <atom@smasher.org>
 "Re: PROMPT escape sequences" (Oct  8, 12:27pm)

On Oct 8, 12:27pm, Atom Smasher wrote:
} 
} expand-or-complete () {
}      PREDISPLAY=${fg[cyan]}
}      zle .expand-or-complete
} }
} zle -N expand-or-complete
} 
} but it doesn't output any escape characters... just the text string 
} "^[[36m" as if there's an implied ${(V)fg[cyan]}.

Yes, that's the way PREDISPLAY works.

} what do i need to do to make that output a literal escape sequence?

Nothing.  You can't.

} why doesn't it work that way by default?

Because it would be whole lot more difficult for ZLE to keep track of
what the screen is supposed to look like if it had to track invisible
zero-width output.
 
} i also tried including "reset-prompt" within the redefined 
} "expand-or-complete", but didn't have any luck with that.

ZLE is still working very hard to re-print only exactly those parts
of the screen that have changed ... so it prints the left prompt,
and then emits a move-the-cursor sequence to jump to the end of the
line (or to the right prompt if you have one).  It only reprints the
characters that aren't part of the prompt if there are fewer of them
than the number of characters in the move-cursor sequence.

All of this optimized redraw stuff is to make the display fast enough
for a very slow TTY line, like a late-1980s dialup.  Maybe an easy 
way to "fix" this would be a switch to turn off all such optimization
and simply redraw everything all the time.

