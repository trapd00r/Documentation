From zsh-workers-return-21081-mason-zsh=primenet.com.au@sunsite.dk Fri Apr 01 19:35:22 2005
Return-Path: <zsh-workers-return-21081-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 139 invoked from network); 1 Apr 2005 19:35:21 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 1 Apr 2005 19:35:21 -0000
Received: (qmail 69481 invoked from network); 1 Apr 2005 19:35:16 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 1 Apr 2005 19:35:16 -0000
Received: (qmail 27628 invoked by alias); 1 Apr 2005 19:35:13 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 21081
Received: (qmail 27613 invoked from network); 1 Apr 2005 19:35:12 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 1 Apr 2005 19:35:12 -0000
Received: (qmail 69168 invoked from network); 1 Apr 2005 19:35:12 -0000
Received: from mail36.messagelabs.com (193.109.254.211)
  by a.mx.sunsite.dk with SMTP; 1 Apr 2005 19:35:05 -0000
X-VirusChecked: Checked
X-Env-Sender: okiddle@yahoo.co.uk
X-Msg-Ref: server-12.tower-36.messagelabs.com!1112384104!15654498!1
X-StarScan-Version: 5.4.11; banners=.,-,-
X-Originating-IP: [158.234.9.163]
Received: (qmail 2579 invoked from network); 1 Apr 2005 19:35:04 -0000
Received: from iris.logica.co.uk (158.234.9.163)
  by server-12.tower-36.messagelabs.com with SMTP; 1 Apr 2005 19:35:04 -0000
Received: from trentino.logica.co.uk ([158.234.142.59])
	by iris.logica.co.uk (8.12.3/8.12.3/Debian -4) with ESMTP id j31JZ4R9014290
	for <zsh-workers@sunsite.dk>; Fri, 1 Apr 2005 20:35:04 +0100
Received: from trentino.groupinfra.com (localhost [127.0.0.1])
	by trentino.logica.co.uk (Postfix) with ESMTP id D4E523837B
	for <zsh-workers@sunsite.dk>; Fri,  1 Apr 2005 21:34:43 +0200 (CEST)
From: Oliver Kiddle <okiddle@yahoo.co.uk>
To: Zsh workers <zsh-workers@sunsite.dk>
Subject: PATCH: complete services in _fuser
Date: Fri, 01 Apr 2005 21:34:43 +0200
Message-ID: <14744.1112384083@trentino.groupinfra.com>
X-Spam-Checker-Version: SpamAssassin 3.0.2 on a.mx.sunsite.dk
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=6.0 tests=BAYES_00 autolearn=ham 
	version=3.0.2
X-Spam-Hits: -2.6

The psmisc (Linux) version of fuser can take network services as a
parameter, showing processes with network connections open. This patch
makes _fuser handle that. You need to be root for it to work so unless
'-n tcp' is specified, it doesn't affect completion for non root users.

Oliver

Index: _fuser
===================================================================
RCS file: /cvsroot/zsh/zsh/Completion/Unix/Command/_fuser,v
retrieving revision 1.3
diff -u -r1.3 _fuser
--- _fuser	22 Mar 2005 20:05:36 -0000	1.3
+++ _fuser	1 Apr 2005 19:27:44 -0000
@@ -1,8 +1,32 @@
 #compdef fuser
 
 local -a args arg1
+typeset -A opt_args
 
 if _pick_variant -c $words[1] gnu=GNU unix -V; then
+
+  (( $+functions[_fuser_services] )) ||
+  _fuser_services() {
+    local expl suf ret=1
+
+    [[ $opt_args[-n] = ??p || $EUID = 0 ]] || return
+
+    if compset -P '*/'; then
+      _wanted protocols expl protocol compadd tcp udp
+    elif compset -P '*,*,'; then
+      compset -S '/*' || [[ -n $opt_args[-n] ]] || suf=( -qS / )
+      _ports $suf && ret=0
+    elif compset -P '*,'; then
+      compset -S ',*' || suf=( -S ,  -r "/ \t\n\-" )
+      _hosts $suf && ret=0
+    else
+      compset -S ',*' || suf=( -S ${${opt_args[-n]/?*/,}:-/} -r "/, \t\n\-" )
+      _ports $suf && ret=0
+    fi
+      
+    return ret
+  }
+
   _arguments \
 	 '(-s)-a[show all files specified on the command line]' \
 	 {-c,-m}'[list all processes accessing files on the filesystem specified by name]' \
@@ -17,7 +41,8 @@
 	 '-V[display version information]' \
 	 '-4[search only for IPv4 sockets]' \
 	 '-6[search only for IPv6 sockets]' \
-	 ':name:_files'
+	 '*:name: _alternative "files:file:_files" "services:service:_fuser_services"'
+
 else
   case $OSTYPE in
     solaris2.9 )


______________________________________________________________________
This email has been scanned by the MessageLabs Email Security System.
For more information please visit http://www.messagelabs.com/email 
______________________________________________________________________

