From zsh-users-return-15459-mason-zsh=primenet.com.au@zsh.org Tue Oct 19 16:14:06 2010
Return-Path: <zsh-users-return-15459-mason-zsh=primenet.com.au@zsh.org>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 6789 invoked by alias); 19 Oct 2010 16:14:06 -0000
Mailing-List: contact zsh-users-help@zsh.org; run by ezmlm
Precedence: bulk
X-No-Archive: yes
List-Id: Zsh Users List <zsh-users.zsh.org>
List-Post: <mailto:zsh-users@zsh.org>
List-Help: <mailto:zsh-users-help@zsh.org>
Delivered-To: mailing list zsh-users@zsh.org
X-Seq: 15459
Received: (qmail 11228 invoked from network); 19 Oct 2010 16:14:04 -0000
X-Spam-Checker-Version: SpamAssassin 3.3.1 (2010-03-16) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=BAYES_00,RCVD_IN_DNSWL_LOW,
	SPF_HELO_PASS autolearn=ham version=3.3.1
Received-SPF: none (ns1.primenet.com.au: domain at csr.com does not designate permitted sender hosts)
Date: Tue, 19 Oct 2010 17:13:52 +0100
From: Peter Stephenson <Peter.Stephenson@csr.com>
To: zsh-users@zsh.org
Subject: Re: zle clear-screen, exit status
Message-ID: <20101019171352.6c20b461@pwslap01u.europe.root.pri>
In-Reply-To: <20101019153258.GD2149@one.monetra.com>
References: <20101019153258.GD2149@one.monetra.com>
Organization: Cambridge Silicon Radio
X-Mailer: Claws Mail 3.7.6 (GTK+ 2.18.9; i686-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
X-OriginalArrivalTime: 19 Oct 2010 16:13:56.0106 (UTC) FILETIME=[A14566A0:01CB6FA8]
X-Scanned-By: MailControl A-06-00-00 (www.mailcontrol.com) on 10.71.0.122

On Tue, 19 Oct 2010 11:32:58 -0400
Brian Lewis <brian@lorf.org> wrote:
> My prompt displays $?, the program exit status. When I hit Ctrl-L, I'd
> like $? to be set to 0 somehow before the prompt is redisplayed.
> 
> I can't figure out how to do it. It is as if $? is saved before my
> widget is called, and restored after.

Yes, that's how it works.  The status returned from widgets is for use by
ZLE; it is not related to the status of the sequence of commands you are
running on the command line, which doesn't care what sequence of
commands was executed to read in the command line.  Generally speaking,
functions only return the value to their immediate environment and that
propagates up as appropriate --- there's no automatic link between
return statuses of functions and the top level of execution, it depends
on context.

We take care to try to ensure that even stray statuses from hook
functions don't overwrite the status in the main command sequence, so
the zle-line-finish widget doesn't help you, either.

You'd need to trick the shell into thinking it was in the top-level
shell execution environment or executing code outside the usual widget
sandbox.  I can't offhand think of a way of doing that within zle.  Even
when executing an exit trap in a shell function the status is tidied up
afterwards.

-- 
Peter Stephenson <pws@csr.com>            Software Engineer
Tel: +44 (0)1223 692070                   Cambridge Silicon Radio Limited
Churchill House, Cambridge Business Park, Cowley Road, Cambridge, CB4 0WZ, UK


Member of the CSR plc group of companies. CSR plc registered in England and Wales, registered number 4187346, registered office Churchill House, Cambridge Business Park, Cowley Road, Cambridge, CB4 0WZ, United Kingdom

