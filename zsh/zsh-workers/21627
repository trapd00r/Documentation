From zsh-workers-return-21627-mason-zsh=primenet.com.au@sunsite.dk Mon Aug 15 18:07:57 2005
Return-Path: <zsh-workers-return-21627-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 29267 invoked from network); 15 Aug 2005 18:07:52 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 15 Aug 2005 18:07:52 -0000
Received: (qmail 11545 invoked from network); 15 Aug 2005 18:07:46 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 15 Aug 2005 18:07:46 -0000
Received: (qmail 19976 invoked by alias); 15 Aug 2005 18:07:44 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 21627
Received: (qmail 19966 invoked from network); 15 Aug 2005 18:07:44 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 15 Aug 2005 18:07:44 -0000
Received: (qmail 11249 invoked from network); 15 Aug 2005 18:07:44 -0000
Received: from flock1.newmail.ru (212.48.140.157)
  by a.mx.sunsite.dk with SMTP; 15 Aug 2005 18:07:40 -0000
Received: (qmail 3007 invoked from network); 15 Aug 2005 18:00:16 -0000
Received: from unknown (HELO ?10.0.0.53?) (arvidjaar@newmail.ru@83.237.61.42)
  by smtpd.newmail.ru with SMTP; 15 Aug 2005 18:00:16 -0000
From: Andrey Borzenkov <arvidjaar@newmail.ru>
To: zsh-workers@sunsite.dk
Subject: [PATCH] fix recursive ZLE from completion call
Date: Mon, 15 Aug 2005 22:07:27 +0400
User-Agent: KMail/1.8.2
MIME-Version: 1.0
Content-Type: multipart/signed;
  boundary="nextPart1378518.c2XWI3CVZm";
  protocol="application/pgp-signature";
  micalg=pgp-sha1
Content-Transfer-Encoding: 7bit
Message-Id: <200508152207.27813.arvidjaar@newmail.ru>
X-Spam-Checker-Version: SpamAssassin 3.0.4 (2005-06-05) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=BAYES_00 autolearn=ham 
	version=3.0.4

--nextPart1378518.c2XWI3CVZm
Content-Type: text/plain;
  charset="us-ascii"
Content-Transfer-Encoding: quoted-printable
Content-Disposition: inline

That is becoming ridiculous. Any chance to have single entry point (wrapper=
?)=20
for ZLE and completion functions?

Index: Src/Zle/compcore.c
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D
RCS file: /cvsroot/zsh/zsh/Src/Zle/compcore.c,v
retrieving revision 1.71
diff -u -p -r1.71 compcore.c
=2D-- Src/Zle/compcore.c  10 Aug 2005 10:56:41 -0000      1.71
+++ Src/Zle/compcore.c  15 Aug 2005 18:04:45 -0000
@@ -353,8 +353,18 @@ do_completion(UNUSED(Hookdef dummy), Com
        clearlist =3D 1;
        ret =3D 1;
        minfo.cur =3D NULL;
=2D       if (useline < 0)
+       if (useline < 0) {
+           /* unmetafy line before calling ZLE */
+           int remetafy =3D 0;
+
+           if (zlemetaline !=3D NULL) {
+               unmetafy_line();
+               remetafy =3D 1;
+           }
            ret =3D selfinsert(zlenoargs);
+           if (remetafy)
+               metafy_line();
+       }
        goto compend;
     }
     zsfree(lastprebr);
@@ -367,9 +377,18 @@ do_completion(UNUSED(Hookdef dummy), Com
        if (nmatches)
             do_ambig_menu();
        ret =3D !nmatches;
=2D    } else if (useline < 0)
+    } else if (useline < 0) {
+       /* unmetafy line before calling ZLE */
+       int remetafy =3D 0;
+
+       if (zlemetaline !=3D NULL) {
+           unmetafy_line();
+           remetafy =3D 1;
+       }
        ret =3D selfinsert(zlenoargs);
=2D    else if (!useline && uselist) {
+       if (remetafy)
+           metafy_line();
+    } else if (!useline && uselist) {
        /* All this and the guy only wants to see the list, sigh. */
        zlemetacs =3D 0;
        foredel(zlemetall);

--nextPart1378518.c2XWI3CVZm
Content-Type: application/pgp-signature

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.0 (GNU/Linux)

iD8DBQBDANnfR6LMutpd94wRAukjAJ9eaAqnitmmBxccG10YFmwl8C3k+wCgqaK8
/XhBa5oXzAb3qGZg5/KhJZA=
=XbI4
-----END PGP SIGNATURE-----

--nextPart1378518.c2XWI3CVZm--

