<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html>
<head>
  <meta name="generator" content=
  "HTML Tidy for Linux (vers 25 March 2009), see www.w3.org">
  <meta http-equiv="Content-Type" content=
  "text/html; charset=utf-8">

  <title>Git Magic - Chapitre&nbsp;8.&nbsp;Les secrets révélés</title>
  <link rel="stylesheet" href="default.css" type="text/css">
  <meta name="generator" content="DocBook XSL Stylesheets V1.75.2">
  <link rel="home" href="index.html" title="Git Magique">
  <link rel="up" href="index.html" title="Git Magique">
  <link rel="prev" href="ch07.html" title=
  "Chapitre&nbsp;7.&nbsp;La maîtrise de Git">
  <link rel="next" href="ch09.html" title=
  "Chapitre&nbsp;9.&nbsp;Appendix A: Les lacunes de Git">
</head>

<body bgcolor="white" text="black" link="#0000FF" vlink="#840084"
alink="#0000FF">
    <div class="toc">
      <ul>
<li><b>Git Magic</b></li>
        <li>
          <span class="preface"><a href=
          "index.html">Préface</a></span>

          <ul>
            <li><span class="section"><a href=
            "index.html#_merci">Merci&nbsp;!</a></span></li>

            <li><span class="section"><a href=
            "index.html#_licence">Licence</a></span></li>
          </ul>
        </li>

        <li>
          <span class="chapter"><a href="ch01.html">1.
          Introduction</a></span>

          <ul>
            <li><span class="section"><a href=
            "ch01.html#_le_travail_comme_un_jeu">Le travail comme
            un jeu</a></span></li>

            <li><span class="section"><a href=
            "ch01.html#_gestion_de_versions">Gestion de
            versions</a></span></li>

            <li><span class="section"><a href=
            "ch01.html#_gestion_distribu%C3%A9e">Gestion
            distribuée</a></span></li>

            <li><span class="section"><a href=
            "ch01.html#_une_superstition_idiote">Une superstition
            idiote</a></span></li>

            <li><span class="section"><a href=
            "ch01.html#_conflits_fusionnels">Conflits
            fusionnels</a></span></li>
          </ul>
        </li>

        <li>
          <span class="chapter"><a href="ch02.html">2. Astuces de
          base</a></span>

          <ul>
            <li><span class="section"><a href=
            "ch02.html#_enregistrer_l_%C3%A9tat_courant">Enregistrer
            l'état courant</a></span></li>

            <li><span class="section"><a href=
            "ch02.html#_ajouter_supprimer_renommer">Ajouter,
            supprimer, renommer</a></span></li>

            <li><span class="section"><a href=
            "ch02.html#_annuler_reprendre_avanc%C3%A9">Annuler/Reprendre
            avancé</a></span></li>

            <li><span class="section"><a href=
            "ch02.html#_reprise_revert">Reprise
            (revert)</a></span></li>

            <li><span class="section"><a href=
            "ch02.html#_g%C3%A9n%C3%A9ration_du_journal_des_modifications_changelog">
            Génération du journal des modifications
            (changelog)</a></span></li>

            <li><span class="section"><a href=
            "ch02.html#_t%C3%A9l%C3%A9charger_des_fichiers">Télécharger
            des fichiers</a></span></li>

            <li><span class="section"><a href=
            "ch02.html#_le_dernier_cri">Le dernier
            cri</a></span></li>

            <li><span class="section"><a href=
            "ch02.html#_publication_instantan%C3%A9e">Publication
            instantanée</a></span></li>

            <li><span class="section"><a href=
            "ch02.html#_qu_8217_ai_je_fait">Qu’ai-je
            fait&nbsp;?</a></span></li>

            <li><span class="section"><a href=
            "ch02.html#_exercice">Exercice</a></span></li>
          </ul>
        </li>

        <li>
          <span class="chapter"><a href="ch03.html">3. Clonons
          gaiement</a></span>

          <ul>
            <li><span class="section"><a href=
            "ch03.html#_synchronisation_entre_machines">Synchronisation
            entre machines</a></span></li>

            <li><span class="section"><a href=
            "ch03.html#_gestion_classique_des_sources">Gestion
            classique des sources</a></span></li>

            <li><span class="section"><a href=
            "ch03.html#_d%C3%A9p%C3%B4ts_nus">Dépôts
            nus</a></span></li>

            <li><span class="section"><a href=
            "ch03.html#_envoi_vs_rapatriement_push_vs_pull">Envoi
            vs rapatriement (push vs pull)</a></span></li>

            <li><span class="section"><a href=
            "ch03.html#_forker_un_projet">Forker un
            projet</a></span></li>

            <li><span class="section"><a href=
            "ch03.html#_syst%C3%A8me_ultime_de_sauvegarde">Système
            ultime de sauvegarde</a></span></li>

            <li><span class="section"><a href=
            "ch03.html#_le_multi_t%C3%A2che_%C3%A0_la_vitesse_de_la_lumi%C3%A8re">
            Le multi-tâche à la vitesse de la
            lumière</a></span></li>

            <li><span class="section"><a href=
            "ch03.html#_gu%C3%A9rilla_de_la_gestion_de_versions">Guérilla
            de la gestion de versions</a></span></li>

            <li><span class="section"><a href=
            "ch03.html#_mercurial">Mercurial</a></span></li>

            <li><span class="section"><a href=
            "ch03.html#_bazaar">Bazaar</a></span></li>

            <li><span class="section"><a href=
            "ch03.html#_pourquoi_j_8217_utilise_git">Pourquoi
            j’utilise Git</a></span></li>
          </ul>
        </li>

        <li>
          <span class="chapter"><a href="ch04.html">4. La
          sorcellerie des branches</a></span>

          <ul>
            <li><span class="section"><a href=
            "ch04.html#_la_touche_du_chef">La touche du
            chef</a></span></li>

            <li><span class="section"><a href=
            "ch04.html#_travail_temporaire">Travail
            temporaire</a></span></li>

            <li><span class="section"><a href=
            "ch04.html#_corrections_rapides">Corrections
            rapides</a></span></li>

            <li><span class="section"><a href=
            "ch04.html#_fusionner">Fusionner</a></span></li>

            <li><span class="section"><a href=
            "ch04.html#_workflow_sans_interruption">Workflow sans
            interruption</a></span></li>

            <li><span class="section"><a href=
            "ch04.html#_r%C3%A9organiser_le_foutoir">Réorganiser le
            foutoir</a></span></li>

            <li><span class="section"><a href=
            "ch04.html#_gestion_des_branches">Gestion des
            branches</a></span></li>

            <li><span class="section"><a href=
            "ch04.html#_les_branches_temporaires">Les branches
            temporaires</a></span></li>

            <li><span class="section"><a href=
            "ch04.html#_travailler_comme_il_vous_chante">Travailler
            comme il vous chante</a></span></li>
          </ul>
        </li>

        <li>
          <span class="chapter"><a href="ch05.html">5. Les leçons
          de l’histoire</a></span>

          <ul>
            <li><span class="section"><a href=
            "ch05.html#_je_me_corrige_8230">Je me
            corrige…</a></span></li>

            <li><span class="section"><a href=
            "ch05.html#_8230_et_bien_plus">… et bien
            plus</a></span></li>

            <li><span class="section"><a href=
            "ch05.html#_les_changements_locaux_en_dernier">Les
            changements locaux en dernier</a></span></li>

            <li><span class="section"><a href=
            "ch05.html#_r%C3%A9%C3%A9criture_de_l_8217_histoire">Réécriture
            de l’histoire</a></span></li>

            <li><span class="section"><a href=
            "ch05.html#_faire_l_8217_histoire">Faire
            l’histoire</a></span></li>

            <li><span class="section"><a href=
            "ch05.html#_qu_8217_est_ce_qui_a_tout_cass%C3%A9">Qu’est-ce
            qui a tout cassé&nbsp;?</a></span></li>

            <li><span class="section"><a href=
            "ch05.html#_qui_a_tout_cass%C3%A9">Qui a tout
            cassé&nbsp;?</a></span></li>

            <li><span class="section"><a href=
            "ch05.html#_exp%C3%A9rience_personnelle">Expérience
            personnelle</a></span></li>
          </ul>
        </li>

        <li>
          <span class="chapter"><a href="ch06.html">6. Git
          multijoueur</a></span>

          <ul>
            <li><span class="section"><a href=
            "ch06.html#_qui_suis_je">Qui
            suis-je&nbsp;?</a></span></li>

            <li><span class="section"><a href=
            "ch06.html#_git_via_ssh_et_http">Git via SSH et
            HTTP</a></span></li>

            <li><span class="section"><a href=
            "ch06.html#_git_via_n_8217_importe_quoi">Git via
            n’importe quoi</a></span></li>

            <li><span class="section"><a href=
            "ch06.html#_les_patches_la_monnaie_d_%C3%A9change_globale">
            Les patches&nbsp;: la monnaie d'échange
            globale</a></span></li>

            <li><span class="section"><a href=
            "ch06.html#_le_num%C3%A9ro_de_votre_correspondant_a_chang%C3%A9">
            Le numéro de votre correspondant a
            changé</a></span></li>

            <li><span class="section"><a href=
            "ch06.html#_les_branches_distantes">Les branches
            distantes</a></span></li>

            <li><span class="section"><a href=
            "ch06.html#_d%C3%A9p%C3%B4ts_distants_multiples">Dépôts
            distants multiples</a></span></li>

            <li><span class="section"><a href=
            "ch06.html#_mes_pr%C3%A9f%C3%A9rences">Mes
            préférences</a></span></li>
          </ul>
        </li>

        <li>
          <span class="chapter"><a href="ch07.html">7. La maîtrise
          de Git</a></span>

          <ul>
            <li><span class="section"><a href=
            "ch07.html#_publication_de_sources">Publication de
            sources</a></span></li>

            <li><span class="section"><a href=
            "ch07.html#_g%C3%A9rer_le_changement">Gérer le
            changement</a></span></li>

            <li><span class="section"><a href=
            "ch07.html#_mon_commit_est_trop_gros">Mon commit est
            trop gros&nbsp;!</a></span></li>

            <li><span class="section"><a href=
            "ch07.html#_l_8217_index_l_8217_aire_d_8217_assemblage">
            L’index&nbsp;: l’aire d’assemblage</a></span></li>

            <li><span class="section"><a href=
            "ch07.html#_ne_perdez_pas_la_t%C3%AAte">Ne perdez pas
            la tête</a></span></li>

            <li><span class="section"><a href=
            "ch07.html#_chasseur_de_t%C3%AAte">Chasseur de
            tête</a></span></li>

            <li><span class="section"><a href=
            "ch07.html#_construire_au_dessus_de_git">Construire
            au-dessus de Git</a></span></li>

            <li><span class="section"><a href=
            "ch07.html#_audacieuses_acrobaties">Audacieuses
            acrobaties</a></span></li>

            <li><span class="section"><a href=
            "ch07.html#_se_pr%C3%A9munir_des_commits_erron%C3%A9s">Se
            prémunir des commits erronés</a></span></li>
          </ul>
        </li>

        <li>
          <span class="chapter"><a href="ch08.html">8. Les secrets
          révélés</a></span>

          <ul>
            <li><span class="section"><a href=
            "ch08.html#_l_8217_invisibilit%C3%A9">L’invisibilité</a></span></li>

            <li><span class="section"><a href=
            "ch08.html#_l_8217_int%C3%A9grit%C3%A9">L’intégrité</a></span></li>

            <li><span class="section"><a href=
            "ch08.html#_l_8217_intelligence">L’intelligence</a></span></li>

            <li><span class="section"><a href=
            "ch08.html#_l_8217_indexation">L’indexation</a></span></li>

            <li><span class="section"><a href=
            "ch08.html#_les_origines_de_git">Les origines de
            Git</a></span></li>

            <li><span class="section"><a href=
            "ch08.html#_la_base_d_8217_objets">La base
            d’objets</a></span></li>

            <li><span class="section"><a href=
            "ch08.html#_les_blobs">Les blobs</a></span></li>

            <li><span class="section"><a href=
            "ch08.html#_les_arbres_literal_trees_literal">Les
            arbres (<code class=
            "literal">trees</code>)</a></span></li>

            <li><span class="section"><a href=
            "ch08.html#_les_commits">Les commits</a></span></li>

            <li><span class="section"><a href=
            "ch08.html#_indiscernable_de_la_magie">Indiscernable de
            la magie</a></span></li>
          </ul>
        </li>

        <li>
          <span class="chapter"><a href="ch09.html">9. Appendix A:
          Les lacunes de Git</a></span>

          <ul>
            <li><span class="section"><a href=
            "ch09.html#_les_faiblesses_de_sha1">Les faiblesses de
            SHA1</a></span></li>

            <li><span class="section"><a href=
            "ch09.html#_microsoft_windows">Microsoft
            Windows</a></span></li>

            <li><span class="section"><a href=
            "ch09.html#_des_fichiers_sans_relation">Des fichiers
            sans relation</a></span></li>

            <li><span class="section"><a href=
            "ch09.html#_qui_modifie_quoi">Qui modifie
            quoi&nbsp;?</a></span></li>

            <li><span class="section"><a href=
            "ch09.html#_l_8217_historique_d_8217_un_fichier">L’historique
            d’un fichier</a></span></li>

            <li><span class="section"><a href=
            "ch09.html#_le_clone_initial">Le clone
            initial</a></span></li>

            <li><span class="section"><a href=
            "ch09.html#_les_projets_versatiles">Les projets
            versatiles</a></span></li>

            <li><span class="section"><a href=
            "ch09.html#_compteur_global">Compteur
            global</a></span></li>

            <li><span class="section"><a href=
            "ch09.html#_les_dossiers_vides">Les dossiers
            vides</a></span></li>

            <li><span class="section"><a href=
            "ch09.html#_le_premier_commit">Le premier
            commit</a></span></li>

            <li><span class="section"><a href=
            "ch09.html#_bizarreries_de_l_8217_interface">Bizarreries
            de l’interface</a></span></li>
          </ul>
        </li>

        <li><span class="chapter"><a href="ch10.html">10. Appendix
        B: Traduire ce guide</a></span></li>
      </ul>
    </div>
<div class="content">
  <div class="chapter" title=
  "Chapitre&nbsp;8.&nbsp;Les secrets révélés">
    <div class="titlepage">
      <div>
        <div>
          <h2 class="title"><a name=
          "_les_secrets_r%C3%A9v%C3%A9l%C3%A9s"></a>Chapitre&nbsp;8.&nbsp;Les
          secrets révélés</h2>
        </div>
      </div>
    </div>

    <p>Nous allons jeter un œil sous le capot pour comprendre
    comment Git réalise ses miracles. Je passerai sous silence la
    plupart des détails. Pour des explications plus détaillées,
    référez-vous au <a class="ulink" href=
    "http://www.kernel.org/pub/software/scm/git/docs/user-manual.html"
    target="_top">manuel utilisateur</a>.</p>

    <div class="section" title="L’invisibilité">
      <div class="titlepage">
        <div>
          <div>
            <h2 class="title"><a name=
            "_l_8217_invisibilit%C3%A9"></a>L’invisibilité</h2>
          </div>
        </div>
      </div>

      <p>Comment fait Git pour être si discret&nbsp;? Mis à part
      lorsque vous faites des commits et des fusions, vous pouvez
      travailler comme si la gestion de versions n’existait pas. Et
      c’est lorsque vous en avez besoin que vous êtes content de
      voir que Git veillait sur vous tout le temps.</p>

      <p>D’autres systèmes de gestion de versions vous mettent
      constamment aux prises avec de la paperasserie et de la
      bureaucratie. Les fichiers sont en lecture seule jusqu'à
      l’obtention depuis un serveur central du droit d'édition de
      tel ou tel fichier. Les commandes les plus basiques voient
      leurs performances s'écrouler au fur et à mesure que le
      nombre d’utilisateurs augmente. Le travail s’arrête dès lors
      que le réseau ou le serveur central est en panne.</p>

      <p>À l’inverse, Git conserve tout l’historique de votre
      projet dans le sous-dossier <code class="literal">.git</code>
      de votre dossier de travail. C’est votre propre copie de
      l’historique et vous pouvez donc rester déconnecté tant que
      vous ne voulez pas communiquer avec les autres. Vous
      conservez un contrôle total sur le sort de vos fichiers
      puisque Git peut aisément les recréer à tout moment à partir
      de l’un des états enregistrés dans <code class=
      "literal">.git</code>.</p>
    </div>

    <div class="section" title="L’intégrité">
      <div class="titlepage">
        <div>
          <div>
            <h2 class="title"><a name=
            "_l_8217_int%C3%A9grit%C3%A9"></a>L’intégrité</h2>
          </div>
        </div>
      </div>

      <p>La plupart des gens associent la cryptographie à la
      conservation du secret des informations mais l’un de ses buts
      tout aussi important est de conserver l’intégrité de ces
      informations. Un usage approprié des fonctions de hachage
      cryptographiques (celles qui calculent l’empreinte d’un
      document) permet d’empêcher la corruption accidentelle ou
      malicieuse des données.</p>

      <p>Une empreinte SHA1 peut être vue comme un nombre de 160
      bits identifiant de manière unique n’importe quelle suite
      d’octets que vous rencontrerez dans votre vie. On peut même
      aller plus loin&nbsp;: c’est vrai pour toutes les suites
      d’octets que les humains utiliseront sur plusieurs
      générations.</p>

      <p>Comme une empreinte SHA1 est elle-même une suite d’octets,
      nous pouvons calculer l’empreinte d’une suite de caractères
      contenant d’autres empreintes. Cette simple observation est
      étonnamment utile (cherchez par exemple <span class=
      "emphasis"><em>hash chain</em></span>). Nous verrons plus
      tard comment Git utilise cela pour garantir efficacement
      l’intégrité des données.</p>

      <p>En bref, Git conserve vos données dans le sous-dossier
      <code class="literal">.git/objects</code> mais à la place des
      noms de fichiers normaux, vous n’y trouverez que des ID. En
      utilisant ces ID comme noms de fichiers et grâce à quelques
      astucieux fichiers de verrouillage et d’horodatage, Git
      transforme un simple système de fichiers en une base de
      données efficace et robuste.</p>
    </div>

    <div class="section" title="L’intelligence">
      <div class="titlepage">
        <div>
          <div>
            <h2 class="title"><a name=
            "_l_8217_intelligence"></a>L’intelligence</h2>
          </div>
        </div>
      </div>

      <p>Comment fait Git pour savoir que vous avez renommé un
      fichier même si vous ne lui avez pas dit explicitement&nbsp;?
      Bien sûr, vous pouvez utiliser <span class=
      "strong"><strong>git mv</strong></span> mais c’est exactement
      la même chose que de faire <span class="strong"><strong>git
      rm</strong></span> suivi par <span class="strong"><strong>git
      add</strong></span>.</p>

      <p>Git a des heuristiques pour débusquer les changements de
      noms et les copies entre les versions successives. En fait,
      il peut même détecter les bouts de code qui ont été déplacés
      ou copiés d’un fichier à un autre ! Bien que ne couvrant pas
      tous les cas, cela marche déjà très bien et cette
      fonctionnalité est encore en cours d’amélioration. Si cela
      échoue pour vous, essayez les options activant des méthodes
      de détection de copie plus coûteuses et envisager de faire
      une mise à jour.</p>
    </div>

    <div class="section" title="L’indexation">
      <div class="titlepage">
        <div>
          <div>
            <h2 class="title"><a name=
            "_l_8217_indexation"></a>L’indexation</h2>
          </div>
        </div>
      </div>

      <p>Pour chaque fichier suivi, Git mémorise des informations,
      telles que sa taille et ses dates de création et de dernières
      modifications, dans un fichier appelé <span class=
      "emphasis"><em>index</em></span>. Pour déterminer si un
      fichier a changé, Git compare son état courant avec ce qu’il
      a mémorisé dans l’index. Si cela correspond alors Git n’a pas
      besoin de relire le fichier.</p>

      <p>Puisque les appels à <span class=
      "emphasis"><em>stat</em></span> sont considérablement plus
      rapides que la lecture des fichiers, si vous n’avez modifié
      que quelques fichiers, Git peut déterminer son état en très
      peu de temps.</p>

      <p>Nous avons dit plus tôt que l’index était une aire
      d’assemblage. Comment se peut-il qu’un simple fichier contant
      quelques informations sur les fichiers soit une aire
      d’assemblage&nbsp;? Parce que la commande add ajoute les
      fichiers à la base de données de Git et met à jour l’index
      avec leurs informations alors que la commande commit, sans
      option, crée une nouvelle version basée uniquement sur cet
      index et les fichiers déjà inclus dans la base de
      données.</p>
    </div>

    <div class="section" title="Les origines de Git">
      <div class="titlepage">
        <div>
          <div>
            <h2 class="title"><a name=
            "_les_origines_de_git"></a>Les origines de Git</h2>
          </div>
        </div>
      </div>

      <p>Ce <a class="ulink" href=
      "http://lkml.org/lkml/2005/4/6/121" target="_top">message de
      la Mailing List du noyau Linux</a> décrit l’enchaînement des
      évènements ayant mené à Git. L’ensemble de l’enfilade est un
      site archéologique fascinant pour les historiens de Git.</p>
    </div>

    <div class="section" title="La base d’objets">
      <div class="titlepage">
        <div>
          <div>
            <h2 class="title"><a name=
            "_la_base_d_8217_objets"></a>La base d’objets</h2>
          </div>
        </div>
      </div>

      <p>Chacune des versions de vos données est conservée dans la
      base d’objets (<span class="emphasis"><em>object
      database</em></span>) qui réside dans le sous-dossier
      <code class="literal">.git/objects</code>&nbsp;; le reste du
      contenu du dossier <code class="literal">.git</code>
      représente moins de données&nbsp;: l’index, le nom des
      branches, les tags, les options de configuration, les logs,
      l’emplacement actuel de HEAD, et ainsi de suite. La base
      d’objets est simple mais élégante et constitue la source de
      la puissance de Git.</p>

      <p>Chaque fichier dans <code class=
      "literal">.git/objects</code> est un objet. Il y a trois
      sortes d’objets qui nous concerne&nbsp;: les <code class=
      "literal">blobs</code>, les arbres (<code class=
      "literal">trees</code>) et les <code class=
      "literal">commits</code>.</p>
    </div>

    <div class="section" title="Les blobs">
      <div class="titlepage">
        <div>
          <div>
            <h2 class="title"><a name="_les_blobs"></a>Les
            blobs</h2>
          </div>
        </div>
      </div>

      <p>Tout d’abord, faisons un peu de magie. Choisissez un nom
      de fichier… n’importe quel nom de fichier&nbsp;! Puis dans un
      dossier vide, faites (en remplaçant <code class=
      "literal">VOTRE_NOM_DE_FICHIER</code> par le nom que vous
      avez choisi)&nbsp;:</p>
      <pre class="literallayout">
$ echo joli &gt; VOTRE_NOM_DE_FICHIER
$ git init
$ git add .
$ find .git/objects -type f
</pre>

      <p>Vous verrez <code class=
      "literal">.git/objects/06/80f15d4cb13a09f600a25b84eae36506167970</code>.</p>

      <p>Comment puis-je le savoir sans connaître le nom de fichier
      que vous avez choisi&nbsp;? Tout simplement parce que
      l’empreinte SHA1 de&nbsp;:</p>
      <pre class="literallayout">
"blob" SP "5" NUL "joli" LF
</pre>

      <p>est 0680f15d4cb13a09f600a25b84eae36506167970. Où SP est un
      espace, NUL est l’octet de valeur nulle et LF est un passage
      à la ligne. Vous pouvez vérifier cela en tapant&nbsp;:</p>
      <pre class="literallayout">
$ printf "blob 5\000joli\n" | sha1sum
</pre>

      <p>Git utilise un classement par contenu&nbsp;: les fichiers
      ne sont pas stockés selon leur nom mais selon l’empreinte des
      données qu’ils contiennent, dans un fichier que nous appelons
      un objet <span class="emphasis"><em>blob</em></span>. Nous
      pouvons considérer l’empreinte comme un ID unique du contenu
      d’un fichier. Donc nous pouvons retrouver un fichier par son
      contenu. La chaîne initiale <code class="literal">blob
      5</code> est simplement un entête indiquant le type de
      l’objet et sa longueur en octets&nbsp;; cela simplifie le
      classement interne.</p>

      <p>Je peux donc aisément prédire ce que vous voyez. Le nom du
      fichier ne compte pas&nbsp;: pour construire l’objet blob,
      seules comptent les données stockées dans le fichier.</p>

      <p>Peut-être vous demandez-vous ce qui se produit pour des
      fichiers ayant le même contenu. Essayez en créant des copies
      de votre premier fichier, avec des noms quelconques. Le
      contenu de <code class="literal">.git/objects</code> reste le
      même quel que soit le nombre de copies que vous avez
      ajoutées. Git ne stocke le contenu qu’une seule fois.</p>

      <p>À propos, les fichiers dans <code class=
      "literal">.git/objects</code> sont compressés par zlib et,
      par conséquent, vous ne pouvez pas en consulter le contenu
      directement. Passez-les au travers du filtre <a class="ulink"
      href="http://www.zlib.net/zpipe.c" target="_top">zpipe -d</a>
      ou tapez&nbsp;:</p>
      <pre class="literallayout">
$ git cat-file -p 0680f15d4cb13a09f600a25b84eae36506167970
</pre>

      <p>qui affiche proprement l’objet choisi.</p>
    </div>

    <div class="section" title="Les arbres (trees)">
      <div class="titlepage">
        <div>
          <div>
            <h2 class="title"><a name=
            "_les_arbres_literal_trees_literal"></a>Les arbres
            (<code class="literal">trees</code>)</h2>
          </div>
        </div>
      </div>

      <p>Mais que deviennent les noms des fichiers&nbsp;? Ils
      doivent bien être stockés quelque part à un moment. Git se
      préoccupe des noms de fichiers lors d’un commit&nbsp;:</p>
      <pre class="literallayout">
$ git commit  # Tapez un message
$ find .git/objects -type f
</pre>

      <p>Vous devriez voir maintenant trois objets. Mais là, je ne
      peux plus prédire le nom des deux nouveaux fichiers
      puisqu’ils dépendent en partie du nom de fichier que vous
      avez choisi. Nous continuerons en supposant que vous avez
      choisi «rose». Si ce n’est pas le cas, vous pouvez réécrire
      l’histoire pour que ce soit le cas&nbsp;:</p>
      <pre class="literallayout">
$ git filter-branch --tree-filter 'mv VOTRE_NOM_DE_FICHIER rose'
$ find .git/objects -type f
</pre>

      <p>Le fichier <code class=
      "literal">.git/objects/9a/6a950c3b14eb1a3fb540a2749514a1cb81e206</code>
      devrait maintenant apparaître puisque c’est l’empreinte SHA1
      du contenu suivant&nbsp;:</p>
      <pre class="literallayout">
"tree" SP "32" NUL "100644 rose" NUL 0x9a6a950c3b14eb1a3fb540a2749514a1cb81e206
</pre>

      <p>Vérifiez que ce contenu est le bon en tapant&nbsp;:</p>
      <pre class="literallayout">
$ echo 9a6a950c3b14eb1a3fb540a2749514a1cb81e206 | git cat-file --batch
</pre>

      <p>Avec zpipe, il est plus simple de vérifier
      l’empreinte&nbsp;:</p>
      <pre class="literallayout">
$ zpipe -d &lt; .git/objects/9a/6a950c3b14eb1a3fb540a2749514a1cb81e206 | sha1sum
</pre>

      <p>La vérification de l’empreinte est plus difficile via
      cat-file puisque cette commande n’affiche pas que le contenu
      brut du fichier après décompression.</p>

      <p>Cette fichier est un objet arbre (<span class=
      "emphasis"><em>tree</em></span>)&nbsp;: une liste de tuples
      constitués d’un type, d’un nom de fichier et d’une empreinte.
      Dans notre exemple, le type est 100644 qui indique que
      <code class="literal">rose</code> est un fichier normal et
      l’empreinte est celle de l’objet de type blob contenant le
      contenu de <code class="literal">rose</code>. Les autres
      types possibles pour un fichier sont exécutable, lien
      symbolique ou dossier. Dans ce dernier cas, l’empreinte
      représente un autre objet de type arbre.</p>

      <p>Si vous faites appel à la commande filter-branch, vous
      verrez apparaître de vieux objets dont vous n’avez pas
      besoin. Même s’ils disparaîtront automatiquement une fois
      expirée la période de rétention, nous allons les effacer dès
      maintenant pour rendre notre petit exemple plus facile à
      suivre&nbsp;:</p>
      <pre class="literallayout">
$ rm -r .git/refs/original
$ git reflog expire --expire=now --all
$ git prune
</pre>

      <p>Sur de vrais projets, vous devriez éviter de telles
      commandes puisqu’elles détruisent les sauvegardes. Si vous
      voulez un dossier propre, il est conseillé de faire un tout
      nouveau clone. Faites aussi attention si vous manipulez
      directement le contenu de <code class=
      "literal">.git</code>&nbsp;: que se passera-t-il si une
      commande Git s’effectue au même moment ou si le courant est
      soudainement coupé&nbsp;?</p>

      <p>De manière générale, les refs devraient toujours être
      effacées via <span class="strong"><strong>git update-ref
      -d</strong></span> même si on considère comme sans risque la
      suppression manuelle de <code class=
      "literal">refs/original</code>.</p>
    </div>

    <div class="section" title="Les commits">
      <div class="titlepage">
        <div>
          <div>
            <h2 class="title"><a name="_les_commits"></a>Les
            commits</h2>
          </div>
        </div>
      </div>

      <p>Nous avons expliqué 2 des 3 types d’objets. Le troisième
      est l’objet <span class="emphasis"><em>commit</em></span>.
      Son contenu dépend du message de commit ainsi que de la date
      et l’heure auxquelles il a été créé. Pour que vous obteniez
      la même chose qu’ici, nous devons bidouiller un
      peu&nbsp;:</p>
      <pre class="literallayout">
$ git commit --amend -m Shakespeare  # Changement de message de commit
$ git filter-branch --env-filter 'export
    GIT_AUTHOR_DATE="Fri 13 Feb 2009 15:31:30 -0800"
    GIT_AUTHOR_NAME="Alice"
    GIT_AUTHOR_EMAIL="alice@example.com"
    GIT_COMMITTER_DATE="Fri, 13 Feb 2009 15:31:30 -0800"
    GIT_COMMITTER_NAME="Bob"
    GIT_COMMITTER_EMAIL="bob@example.com"'  # Trucage de la date, l'heure et l'auteur.
$ find .git/objects -type f
</pre>

      <p>Le fichier <code class=
      "literal">.git/objects/ae/9d1241b2b6eea90529149a065f6bc444365c2a</code>
      devrait maintenant exister puisque c’est l’empreinte SHA1 du
      contenu suivant&nbsp;:</p>
      <pre class="literallayout">
"commit 158" NUL
"tree 9a6a950c3b14eb1a3fb540a2749514a1cb81e206" LF
"author Alice &lt;alice@example.com&gt; 1234567890 -0800" LF
"committer Bob &lt;bob@example.com&gt; 1234567890 -0800" LF
LF
"Shakespeare" LF
</pre>

      <p>Comme précédemment, vous pouvez utiliser zpipe ou cat-file
      pour vérifier par vous-même.</p>

      <p>C’est le premier commit, ce qui explique pourquoi il n’y a
      pas de commit parent. Mais les commits suivants contiendront
      toujours au moins une ligne identifiant un commit parent.</p>
    </div>

    <div class="section" title="Indiscernable de la magie">
      <div class="titlepage">
        <div>
          <div>
            <h2 class="title"><a name=
            "_indiscernable_de_la_magie"></a>Indiscernable de la
            magie</h2>
          </div>
        </div>
      </div>

      <p>Les secrets de Git semblent trop simples. On imagine qu’il
      suffit de mélanger quelques scripts shell et d’y ajouter une
      pincée de code C pour mitonner un tel système en quelques
      heures&nbsp;: un assemblage d’opérations basiques sur les
      fichiers et de calcul d’empreintes SHA1 garni de quelques
      fichiers verrou et d’appels à fsync pour la robustesse. En
      fait, nous venons précisément de décrire les premières
      versions de Git. Malgré tout, mis à part quelques techniques
      astucieuses de compression pour gagner de la place et
      d’indexation pour gagner du temps, nous savons maintenant
      comment Git transforme adroitement un système de fichiers en
      une base de données parfaitement adaptée à de la gestion de
      versions.</p>

      <p>Par exemple, si un fichier quelconque de la base d’objets
      vient à être corrompu par une erreur disque alors son
      empreinte ne correspond plus et nous sommes alertés du
      problème. En calculant l’empreinte des empreintes d’autres
      objets, nous maintenons l’intégrité à tous les niveaux. Les
      commits sont atomiques puisque ils ne peuvent jamais
      mémoriser des modifications partiellement stockées&nbsp;:
      nous ne pouvons calculer l’empreinte d’un commit et le
      stocker dans la base d’objets qu’après y avoir déjà stocké
      tous les arbres, blobs et parents relatifs à ce commit. La
      base d’objets est immunisée contre les interruptions
      inattendues telles que les coupures de courant.</p>

      <p>Nous faisons même échouer les tentatives d’attaque les
      plus sournoises. Supposez que quelqu’un tente de modifier
      discrètement le contenu d’un fichier dans l’une des anciennes
      versions du projet. Pour rendre cohérent le contenu de la
      base d’objets, il lui faut changer l’empreinte de l’objet
      blob correspondant puisque elle doit maintenant représenter
      une chaîne d’octets différente. Cela signifie qu’il doit
      aussi changer l’empreinte de tous les arbres référençant ce
      blob et donc changer l’empreinte de tous les commits
      impliquant ces arbres ainsi que de tous les descendants de
      ces commits. Cela implique que l’empreinte du HEAD officiel
      diffère de celle du HEAD d’un dépôt corrompu. En remontant la
      suite d’empreintes erronées nous pouvons localiser avec
      précision le fichier corrompu ainsi que le premier commit où
      il l’a été.</p>

      <p>En résumé, tant que nous sommes sûrs des 20 octets
      représentant le dernier commit, il est impossible d’altérer
      un dépôt Git.</p>

      <p>Qu’en est-il des fameuses fonctionnalités de Git&nbsp;?
      Des branchements&nbsp;? Des fusions&nbsp;? Des tags&nbsp;? De
      simples détails. La tête courante est conservée dans le
      fichier <code class="literal">.git/HEAD</code> qui contient
      l’empreinte d’un objet commit. Cette empreinte sera tenue à
      jour durant un commit ainsi que durant de nombreuses autres
      commandes. Les branches fonctionnent de manière
      similaire&nbsp;: ce sont des fichiers dans <code class=
      "literal">.git/refs/heads</code>. Et les tags aussi&nbsp;:
      ils sont dans <code class="literal">.git/refs/tags</code>
      mais ils sont mis à jour par un ensemble différent de
      commandes.</p>
    </div>
  </div><script type="text/javascript" src="find_selflink.js">
</script><script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
  document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
  </script><script type="text/javascript">
var pageTracker = _gat._getTracker("UA-1901330-2");
  pageTracker._initData();
  pageTracker._trackPageview();
  </script>
</div>
</div><div class="footer"><a href="/~blynn/">Ben Lynn</a></div>
</body>
</html>
