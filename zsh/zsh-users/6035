From zsh-users-return-6035-mason-zsh=primenet.com.au@sunsite.dk Wed Apr 16 09:41:46 2003
Return-Path: <zsh-users-return-6035-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 1145 invoked from network); 16 Apr 2003 09:41:45 -0000
Received: from sunsite.dk (130.225.247.90)
  by ns1.primenet.com.au with SMTP; 16 Apr 2003 09:41:45 -0000
Received: (qmail 29342 invoked by alias); 16 Apr 2003 09:40:04 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 6035
Received: (qmail 29329 invoked from network); 16 Apr 2003 09:40:03 -0000
Received: from localhost (HELO sunsite.dk) (127.0.0.1)
  by localhost with SMTP; 16 Apr 2003 09:40:03 -0000
X-MessageWall-Score: 0 (sunsite.dk)
Received: from [212.125.75.4] by sunsite.dk (MessageWall 1.0.8) with SMTP; 16 Apr 2003 9:40:3 -0000
Received: (qmail 20817 invoked from network); 16 Apr 2003 09:38:00 -0000
Received: from iris.logica.co.uk (158.234.9.163)
  by server-6.tower-1.messagelabs.com with SMTP; 16 Apr 2003 09:38:00 -0000
Received: from gmcs3.logica.co.uk ([158.234.142.61])
	by iris.logica.co.uk (8.9.3/8.9.3/Debian 8.9.3-21) with ESMTP id KAA08230;
	Wed, 16 Apr 2003 10:37:59 +0100
X-Authentication-Warning: iris.logica.co.uk: Host [158.234.142.61] claimed to be gmcs3.logica.co.uk
Received: from gmcs3.logica.co.uk (localhost [127.0.0.1])
	by gmcs3.logica.co.uk (8.11.6/8.11.6/SuSE Linux 0.5) with ESMTP id h3G9bkb02737;
	Wed, 16 Apr 2003 11:37:46 +0200
cc: zsh-users@sunsite.dk
X-VirusChecked: Checked
In-reply-to: <1049917313.20317.24.camel@ixion.colorado.edu> 
From: Oliver Kiddle <okiddle@yahoo.co.uk>
References: <1049917313.20317.24.camel@ixion.colorado.edu>
To: The Matt <thompsma@colorado.edu>
Subject: Re: Pax completion? 
Date: Wed, 16 Apr 2003 11:37:46 +0200
Message-ID: <2735.1050485866@gmcs3.logica.co.uk>

On 9 Apr, The Matt wrote:
> 
> Folks, I was wondering if anyone out there has made completion bits for
> pax, the portable archiver?  I'm not a hacker, so once I looked at the
> _cpio and _tar functions, I was kinda scared to build my own.  (The bash
> completion project also doesn't have the pax so I can't try to copy
> theirs.)

Don't let the complexity of _tar or _cpio worry you. tar's options are
particulary complicated (-C is especially messy to handle) and the
worst part is handling completion of files inside an archive. It
shouldn't be hard to write basic pax completion that does most of what
you want.

> Barring anyone actually having one, how would I go about associating pax
> with at least the file types I use it for (*.pax, .tar, .tar.gz, .cpio,

  _pax() { _files -g '*.(tar|pax|cpio|tar.gz)' }
  compdef _pax pax

would do the job. Or in zsh 4.1, you can do:

  compdef "_files -g '*.(tar|pax|cpio|tar.gz)'" pax

> &c.).  Would something like:
> 
> compctl -g '*.(cpio|tar|pax) pax -f
> 

The final `-f' wouldn't do what you think but with slight changes that
would roughly work. I'd advise using compdef instead though.

To write a decent pax completion, I'd suggest starting by getting the
options together using _arguments. As a start, you might have:

_arguments -s \
  '(-a -w)-r[extract from archive]' \
  '(-a -r)-w[write to archive]' \
  '(-r -w)-a[append files to end of archive]' \
  '-b+[specify block size]:block size' \
  '-x+[specify output archive format]:archive format:(cpio bcpio sv4cpio sv4crc tar ustar)'

For the -f option, it would be something like:
  '-f+[specifiy archive file]:archive file:_files -g "*.(pax|tar|cpio)"'

> work?  And is there a similar way for pax -zf to expand for .pax and

Getting it to detect a -z option for gzip is not trivial however. You
could check for -z manually in $words (which is what _tar does) but it
is more reliable to use _argument's opt_args association which is set
to the options which have been specified on the line.

The following works by appending (|.gz) to the glob if it finds the -z
option.

  '-f+[specifiy archive file]:archive file:_files -g "*.(pax|tar|cpio)${opt_args[(I)-z]\:+(|.gz)}"'

> .tar.gz files?  Or should I buckle down and try to bring together the
> _cpio and _tar* into one _pax?

You'd find it easier starting from scratch. _zip is probably a simpler
example of this sort of stuff - _tar is one of the oldest functions.
And if you run into problems, you can always ask here.

Oliver

