From zsh-workers-return-17235-mason-zsh=primenet.com.au@sunsite.dk Sun May 26 21:59:00 2002
Return-Path: <zsh-workers-return-17235-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 4755 invoked from network); 26 May 2002 21:59:00 -0000
Received: from sunsite.dk (130.225.247.90)
  by ns1.primenet.com.au with SMTP; 26 May 2002 21:59:00 -0000
Received: (qmail 22324 invoked by alias); 26 May 2002 21:58:50 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 17235
Received: (qmail 22310 invoked from network); 26 May 2002 21:58:49 -0000
Date: Sun, 26 May 2002 17:58:40 -0400
From: Clint Adams <clint@zsh.org>
To: Peter Stephenson <pws@csr.com>
Cc: Zsh hackers list <zsh-workers@sunsite.dk>
Subject: Re: PATCH: strftime builtin
Message-ID: <20020526215840.GA15122@dman.com>
References: <20020430185259.GA2825@dman.com> <21763.1020245894@csr.com>
Mime-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <21763.1020245894@csr.com>
User-Agent: Mutt/1.3.28i
X-Virus-Scanned: by amavisd-milter (http://amavis.org/)

> You should probably use zsh's own function ztrftime (in utils.c), which
> calls strftime if that's available, else does some of the simpler formats,
> and makes a couple of extra formats available.  If that doesn't seem

Module renamed to datetime, using ztrftime.

Index: Src/Modules/datetime.c
===================================================================
RCS file: Src/Modules/datetime.c
diff -N Src/Modules/datetime.c
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ Src/Modules/datetime.c	26 May 2002 21:32:00 -0000
@@ -0,0 +1,99 @@
+/*
+ * datetime.c - parameter interface to langinfo via curses
+ *
+ * This file is part of zsh, the Z shell.
+ *
+ * Copyright (c) 2002 Peter Stephenson, Clint Adams
+ * All rights reserved.
+ *
+ * Permission is hereby granted, without written agreement and without
+ * license or royalty fees, to use, copy, modify, and distribute this
+ * software and to distribute modified versions of this software for any
+ * purpose, provided that the above copyright notice and the following
+ * two paragraphs appear in all copies of this software.
+ *
+ * In no event shall Peter Stephenson, Clint Adams or the Zsh Development Group
+ * be liable to any party for direct, indirect, special, incidental, or
+ * consequential damages arising out of the use of this software and its
+ * documentation, even if Peter Stephenson, Clint Adams and the Zsh
+ * Development Group have been advised of the possibility of such damage.
+ *
+ * Peter Stephenson, Clint Adams and the Zsh Development Group specifically
+ * disclaim any warranties, including, but not limited to, the implied
+ * warranties of merchantability and fitness for a particular purpose.
+ * The software provided hereunder is on an "as is" basis, and Peter
+ * Stephenson, Clint Adams and the Zsh Development Group have no obligation
+ * to provide maintenance, support, updates, enhancements, or modifications.
+ *
+ */
+
+#include "datetime.mdh"
+#include "datetime.pro"
+#include <time.h>
+
+static char datetime_nam[] = "datetime";
+
+static int
+bin_strftime(char *nam, char **argv, char *ops, int func)
+{
+    int ret = 0, bufsize, x;
+    char *endptr = NULL, *buffer = NULL;
+    time_t secs;
+    struct tm *t;
+    int size;
+
+    secs = (time_t)strtoul(argv[1], &endptr, 10);
+    if (secs == ULONG_MAX) {
+	zwarnnam(nam, "%s: %e", argv[1], errno);
+	return 1;
+    } else if (*endptr != '\0') {
+	zwarnnam(nam, "%s: invalid decimal number", argv[1], 0);
+	return 1;
+    }
+
+    t = localtime(&secs);
+    bufsize = strlen(argv[0]) * 2;
+
+    for (x=1;x<4;x++) {
+	buffer = zrealloc(buffer, bufsize * x);
+        size = ztrftime(buffer, bufsize * x, argv[0], t);
+	if (size) x = 4;
+    }
+
+    printf("%s\n", buffer);
+    
+    return 0;
+}
+
+static struct builtin bintab[] = {
+    BUILTIN("strftime",    0, bin_strftime,    2,   2, 0, NULL, NULL),
+};
+
+/**/
+int
+setup_(Module m)
+{
+    return 0;
+}
+
+/**/
+int
+boot_(Module m)
+{
+    return !addbuiltins(m->nam, bintab, sizeof(bintab)/sizeof(*bintab));
+}
+
+/**/
+int
+cleanup_(Module m)
+{
+    deletebuiltins(m->nam, bintab, sizeof(bintab)/sizeof(*bintab));
+    return 0;
+}
+
+/**/
+int
+finish_(Module m)
+{
+    return 0;
+}
Index: Src/Modules/datetime.mdd
===================================================================
RCS file: Src/Modules/datetime.mdd
diff -N Src/Modules/datetime.mdd
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ Src/Modules/datetime.mdd	26 May 2002 21:32:00 -0000
@@ -0,0 +1,8 @@
+name=zsh/datetime
+
+link=either
+load=no
+
+autobins="strftime"
+
+objects="datetime.o"

