From zsh-workers-return-7163-mason-zsh=primenet.com.au@sunsite.auc.dk Thu Jul 15 16:21:14 1999
Return-Path: <zsh-workers-return-7163-mason-zsh=primenet.com.au@sunsite.auc.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 29728 invoked from network); 15 Jul 1999 16:21:13 -0000
Received: from sunsite.auc.dk (130.225.51.30)
  by ns1.primenet.com.au with SMTP; 15 Jul 1999 16:21:13 -0000
Received: (qmail 24324 invoked by alias); 15 Jul 1999 16:21:03 -0000
Mailing-List: contact zsh-workers-help@sunsite.auc.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.auc.dk
X-Seq: 7163
Received: (qmail 24316 invoked from network); 15 Jul 1999 16:21:00 -0000
Date: Fri, 16 Jul 1999 02:20:52 +1000
From: Geoff Wing <gcw@pobox.com>
To: zsh-workers@sunsite.auc.dk
Subject: Bad optimisations: (Was: Test version zsh-3.1.6-test-1)
Message-ID: <19990716022052.A29693@primenet.com.au>
Mime-Version: 1.0
Content-Type: text/plain; charset=us-ascii
X-Mailer: Mutt 0.95.6i
In-Reply-To: <199907131130.NAA30286@beta.informatik.hu-berlin.de>
Organization: PrimeNet Computer Consultancy

Sven Wischnowsky <wischnow@informatik.hu-berlin.de> wrote in zsh-users:
:Under DU 4.0 with gcc-2.8.1 I get a SEGV in a piece of completely
:correct C-code in bin_read(). I can work around this by using the
:patch below -- which, of course, is completely silly.
:Dunno if this should be included, but the SEGV is deadly: it fails on
:e.g. the read in compinit.

-    if (*args && **args == '?')
-	args++;
-    /* default result parameter */
-    reply = *args ? *args++ : ops['A'] ? "reply" : "REPLY";
+    if (*args && **args == '?') {
+    	args++;
+	/* default result parameter */
+	reply = *args ? *args++ : ops['A'] ? "reply" : "REPLY";
+	/* (If we put this reply=... after the `if' gcc-2.8.1 under
+	   Digital Unix 4.0 generates incorrect code.) */
+    } else
+	reply = *args ? *args++ : ops['A'] ? "reply" : "REPLY";
+

What about just expanding it slightly (with appropriate comments of course)
instead of duplicating it.
e.g.

    if (*args && **args == '?')
        args++;
    /* default result parameter */
    if (*args)
        reply = *args++;
    else
        reply = ops['A'] ? "reply" : "REPLY";

Regards,
-- 
Geoff Wing : <gcw@pobox.com>     Work URL: http://www.primenet.com.au/
Rxvt Stuff : <gcw@rxvt.org>      Ego URL : http://pobox.com/~gcw/
Zsh Stuff  : <gcw@zsh.org>       Phone   : (Australia) 0413 431 874

