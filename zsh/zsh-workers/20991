From zsh-workers-return-20991-mason-zsh=primenet.com.au@sunsite.dk Thu Mar 17 05:36:23 2005
Return-Path: <zsh-workers-return-20991-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 21274 invoked from network); 17 Mar 2005 05:36:21 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 17 Mar 2005 05:36:21 -0000
Received: (qmail 54266 invoked from network); 17 Mar 2005 05:36:06 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 17 Mar 2005 05:36:06 -0000
Received: (qmail 11186 invoked by alias); 17 Mar 2005 05:36:04 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 20991
Received: (qmail 11170 invoked from network); 17 Mar 2005 05:36:03 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 17 Mar 2005 05:36:03 -0000
Received: (qmail 53998 invoked from network); 17 Mar 2005 05:36:03 -0000
Received: from vms048pub.verizon.net (206.46.252.48)
  by a.mx.sunsite.dk with SMTP; 17 Mar 2005 05:36:00 -0000
Received: from candle.brasslantern.com ([4.11.1.68])
 by vms048.mailsrvcs.net (Sun Java System Messaging Server 6.2 HotFix 0.04
 (built Dec 24 2004)) with ESMTPA id <0IDH001LTE7XDF90@vms048.mailsrvcs.net> for
 zsh-workers@sunsite.dk; Wed, 16 Mar 2005 23:35:59 -0600 (CST)
Received: from candle.brasslantern.com (IDENT:schaefer@localhost [127.0.0.1])
	by candle.brasslantern.com (8.12.11/8.12.11) with ESMTP id j2H5ZvgP029174	for
 <zsh-workers@sunsite.dk>; Wed, 16 Mar 2005 21:35:57 -0800
Received: (from schaefer@localhost)	by candle.brasslantern.com
 (8.12.11/8.12.11/Submit) id j2H5ZvcY029173	for zsh-workers@sunsite.dk; Wed,
 16 Mar 2005 21:35:57 -0800
Date: Thu, 17 Mar 2005 05:35:56 +0000
From: Bart Schaefer <schaefer@brasslantern.com>
Subject: Re: process substitution bug?
In-reply-to: <20050316204328.GH5825@solemn.turbinal.org>
To: zsh-workers@sunsite.dk
Message-id: <1050317053556.ZM29172@candle.brasslantern.com>
MIME-version: 1.0
X-Mailer: Z-Mail (5.0.0 30July97)
Content-type: text/plain; charset=us-ascii
References: <20050316204328.GH5825@solemn.turbinal.org>
Comments: In reply to Alexey Tourbin <at@altlinux.ru>
 "process substitution bug?" (Mar 16, 11:43pm)
X-Spam-Checker-Version: SpamAssassin 3.0.2 on a.mx.sunsite.dk
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=6.0 tests=BAYES_00 autolearn=ham 
	version=3.0.2
X-Spam-Hits: -2.6

On Mar 16, 11:43pm, Alexey Tourbin wrote:
}
} When I wrap some command into a function, process substitution
} no longer works:

This is not precisely a bug, it's a limitation of process substitution
and the shell file descriptor management model.

} $ =diff <(echo 1) <(echo 2)

In this case there's a single external command being run; the file
descriptors opened for the process substitutions remain open across
fork(), so diff can reference them via /proc/self/fd/.

} $ diff <(echo 1) <(echo 2)
} /usr/bin/diff: /proc/self/fd/11: No such file or directory
} /usr/bin/diff: /proc/self/fd/12: No such file or directory

Here, the diff function is being executed in the current shell.  The
file descriptors are opened for the shell function and all the shell
builtin commands, but (because they have numbers > 9) they are closed
when external commands are executed within the function.

Replace "diff" with a builtin such as "stat" (zmodload zsh/stat) and
you'll see that the process substitution is working.

It could be argued that descriptors opened by process substitution
should remain open across external command execution within functions;
they do, in e.g. bash.

