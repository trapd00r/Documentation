From zsh-users-return-13965-mason-zsh=primenet.com.au@sunsite.dk Wed Mar 25 08:19:34 2009
Return-Path: <zsh-users-return-13965-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 8356 invoked from network); 25 Mar 2009 08:19:29 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=BAYES_00 autolearn=ham
	version=3.2.5
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 25 Mar 2009 08:19:29 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 36569 invoked from network); 25 Mar 2009 08:19:16 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 25 Mar 2009 08:19:16 -0000
Received: (qmail 25120 invoked by alias); 25 Mar 2009 08:18:54 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 13965
Received: (qmail 25109 invoked from network); 25 Mar 2009 08:18:54 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 25 Mar 2009 08:18:54 -0000
Received: from smtp.benizi.com (www5.pairlite.com [64.130.10.15])
	by bifrost.dotsrc.org (Postfix) with ESMTP id A020880590EB
	for <zsh-users@sunsite.dk>; Wed, 25 Mar 2009 09:18:48 +0100 (CET)
Received: from localhost (localhost [127.0.0.1])
	by smtp.benizi.com (Postfix) with ESMTPSA id 20E5B1851D;
	Wed, 25 Mar 2009 04:18:52 -0400 (EDT)
Date: Wed, 25 Mar 2009 04:18:51 -0400 (EDT)
From: "Benjamin R. Haskell" <zsh@benizi.com>
To: Zsh Users <zsh-users@sunsite.dk>
Subject: Re: freebsd problems with carriage return
In-Reply-To: <20090324213624.93603.qmail@smasher.org>
Message-ID: <alpine.LNX.2.00.0903250227080.3609@averatec>
References: <20090324101411.66890.qmail@smasher.org> <chaz20090324114727.GA5144@seebyte.com> <20090324213624.93603.qmail@smasher.org>
User-Agent: Alpine 2.00 (LNX 1169 2008-08-27)
MIME-Version: 1.0
Content-Type: TEXT/PLAIN; charset=US-ASCII
X-Virus-Scanned: ClamAV 0.92.1/9164/Wed Mar 25 05:02:31 2009 on bifrost
X-Virus-Status: Clean

On Wed, 25 Mar 2009, Atom Smasher wrote:

> On Tue, 24 Mar 2009, Stephane Chazelas wrote:
> 
> > [...]
> >
> > rsync --progress /from /to | sed -n l
> >
> > (or od -c)
> >
> > to see what rsync actually outputs.
> ================
> 
> or this:
> 
> <<<<<<<<
> 
> % rsync --progress -h --bwlimit=5 ./foo_in ./foo_out > test
> 
> % cat -vet test
> foo_in$
>       32.77K   0%    0.00kB/s    0:00:00^M      65.54K   0%    5.00kB/s
> 0:49:49^M      98.30K   0%    5.00kB/s    0:49:42^M     131.07K   0% 5.00kB/s
> 0:49:36^M     163.84K   1%    5.00kB/s    0:49:29^M 196.61K   1%    5.00kB/s
> 0:49:22^M     229.38K   1%    5.00kB/s 0:49:16^M     262.14K   1%    5.00kB/s
> 0:49:09^M     294.91K   1% 5.00kB/s    0:49:03^M     327.68K   2%    5.00kB/s
> 0:48:56^M 360.45K   2%    5.00kB/s    0:48:50^M     393.22K   2%    5.00kB/s
> 0:48:43^M     425.98K   2%    5.00kB/s    0:48:36^M     458.75K   3% 5.00kB/s
> 0:48:30^M     491.52K   3%    5.00kB/s    0:48:24^M
> 	<<snip>
> 
> <<<<<<<<
> 
> all of rsync's output of interest is stdout. it's mostly a bunch of progress
> updates, separated by carriage returns.
> 

I think it's a difference in how FreeBSD and Linux handle some 
tty/job-control settings.  (Though it's not terribly surprising to me... 
one of those "I'm going to behave differently when you pipe me" things.)  
I assume your ultimate goal isn't to prepend 'foo' to each of those lines.  
What are you trying to do?

On FreeBSD for me, the status updates are visible when not piped (either 
displayed to terminal, or redirected to a file).  But, rsync --progress 
from to | cat -v only shows the final status.

I noticed in the rsync code (progress.c) that it declines to print the 
partial status lines (the ones that end with '\r' so that they can be 
overwritten) depending on the outcome of:

 210         tc_pgrp = tcgetpgrp(STDOUT_FILENO);
 211         if (tc_pgrp != pgrp && tc_pgrp != -1)
 212                 return;


I'm probably only noticing this because I just read:
"The TTY demystified"
http://www.linusakesson.net/programming/tty/index.php

Maybe something in 'stty' will affect the outcome of the above call (but 
you'd have to ask someone who knows way more about it than I do).  There 
are at least a handful of differences in the various settings between 
FreeBSD and Linux for the systems I'm using right now.

Best,
Ben

