From zsh-users-return-5956-mason-zsh=primenet.com.au@sunsite.dk Sun Mar 02 22:09:13 2003
Return-Path: <zsh-users-return-5956-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 9399 invoked from network); 2 Mar 2003 22:09:12 -0000
Received: from sunsite.dk (130.225.247.90)
  by ns1.primenet.com.au with SMTP; 2 Mar 2003 22:09:12 -0000
Received: (qmail 17882 invoked by alias); 2 Mar 2003 22:08:51 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 5956
Received: (qmail 17875 invoked from network); 2 Mar 2003 22:08:51 -0000
Received: from localhost (HELO sunsite.dk) (127.0.0.1)
  by localhost with SMTP; 2 Mar 2003 22:08:51 -0000
X-MessageWall-Score: 0 (sunsite.dk)
Received: from [212.87.0.242] by sunsite.dk (MessageWall 1.0.8) with SMTP; 2 Mar 2003 22:8:51 -0000
Received: from mike by Amber.lab.icm.edu.pl with local (Exim 3.36 #1 (Debian))
	id 18pbdb-0002ar-00
	for <zsh-users@sunsite.dk>; Sun, 02 Mar 2003 23:08:51 +0100
Date: Sun, 2 Mar 2003 23:08:51 +0100
From: =?iso-8859-2?Q?Micha=B3?= Politowski <mpol@charybda.icm.edu.pl>
To: Zsh users list <zsh-users@sunsite.dk>
Subject: Various problems with locale--floats interaction
Message-ID: <20030302220851.GA9927@Amber.lab.icm.edu.pl>
Mail-Followup-To: Zsh users list <zsh-users@sunsite.dk>
Mime-Version: 1.0
Content-Type: multipart/signed; micalg=pgp-sha1;
	protocol="application/pgp-signature"; boundary="5vNYLRcllDrimb99"
Content-Disposition: inline
X-PGP: 1024D/8C6E2929; AC30 1FC4 4C4B 8834 38D8  21DA 7EB7 7AAB 8C6E 2929; 2002-03-02 -- 2004-03-01
User-Agent: Mutt/1.5.3i


--5vNYLRcllDrimb99
Content-Type: text/plain; charset=iso-8859-2
Content-Disposition: inline
Content-Transfer-Encoding: quoted-printable

Some info on my configuration (I use Debian):
Package: zsh
Version: 4.0.6-27

Package: zsh-beta
Version: 4.1.0-dev-7+cvs20030217-1


 The first problem.
While trying to understand other things I encountered this:
Amber% export LANG=3Dpl_PL
Amber% zsh             =20
Amber% echo $[12.12/12]=20
1.01
Amber% <Ctrl-D pressed here>
Amber% zsh
Amber% echo $[12.12/12]
1,01

Comma is the locale-correct decimal separator for pl_PL.
ltrace pointed me to the usage of setlocale in zzlex in math.c:
prev_locale argument to
	setlocale(LC_NUMERIC, prev_locale);
gets clobbered (differently each time); man 3 setlocale says:

       A  successful  call to setlocale() returns an opaque string that
       corresponds to the locale set.  This string may be allocated in stat=
ic storage.

so I think this is probably the problem.


 The second problem.
With LANG=3Dpl_PL
Amber% zsh-beta -f
Amber% echo $[12.12/12]
1,01.
Amber% echo $[12./12] =20
1.

So the output contains an unnecessary dot at the end.
NB: I know that the changelog gives a reason for the dot:

        * 16423: Src/params.c: Don't let convfloat output a number
        looking like an integer; append a `.' if necessary.  Otherwise
        the wrong type of arithmetic will be used on numbers stored in
        scalars.

but...


 ...the third (and main) problem.
It will all be wrong anyway with floats-in-scalars in a localized environme=
nt.
foo=3D$((12.12/12)) means foo=3D1,01 in pl_PL
which means $((foo)) equiv $((1,01)) equiv $((01)) equiv 1

One solution would be locale independent arithmetic expansion,
but then echo $((12.12/12)) would print unlocalized 1.01

Another simple solution is to require typeset -F foo; ((foo=3D12.12/12))
for repeatable results, and ignore the problem of scalars.

Are there any more complicated but workable solutions?

--=20
Micha=B3 Politowski -- mpol@charybda.icm.edu.pl
Warning: this is a memetically modified message

--5vNYLRcllDrimb99
Content-Type: application/pgp-signature
Content-Disposition: inline

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.2.1 (GNU/Linux)

iD8DBQE+YoDzfrd6q4xuKSkRAhQsAKCgmnnW4De0UkQdgFjwARIrOoq8VQCfaopk
p+ObBk6P+cQHOeOUeZ1Rhdk=
=lQBt
-----END PGP SIGNATURE-----

--5vNYLRcllDrimb99--

