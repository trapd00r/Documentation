From zsh-workers-return-26285-mason-zsh=primenet.com.au@sunsite.dk Sun Jan 11 14:19:16 2009
Return-Path: <zsh-workers-return-26285-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 15620 invoked from network); 11 Jan 2009 14:19:02 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 11 Jan 2009 14:19:02 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 70408 invoked from network); 11 Jan 2009 14:18:53 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 11 Jan 2009 14:18:53 -0000
Received: (qmail 22294 invoked by alias); 11 Jan 2009 14:18:47 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 26285
Received: (qmail 22276 invoked from network); 11 Jan 2009 14:18:46 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 11 Jan 2009 14:18:46 -0000
Received: from mtaout03-winn.ispmail.ntl.com (mtaout03-winn.ispmail.ntl.com [81.103.221.49])
	by bifrost.dotsrc.org (Postfix) with ESMTP id D683980271F0
	for <zsh-workers@sunsite.dk>; Sun, 11 Jan 2009 15:18:40 +0100 (CET)
Received: from aamtaout02-winn.ispmail.ntl.com ([81.103.221.35])
          by mtaout03-winn.ispmail.ntl.com
          (InterMail vM.7.08.04.00 201-2186-134-20080326) with ESMTP
          id <20090111141836.IXGE7670.mtaout03-winn.ispmail.ntl.com@aamtaout02-winn.ispmail.ntl.com>
          for <zsh-workers@sunsite.dk>; Sun, 11 Jan 2009 14:18:36 +0000
Received: from pws-pc ([81.107.45.176]) by aamtaout02-winn.ispmail.ntl.com
          (InterMail vG.2.02.00.01 201-2161-120-102-20060912) with ESMTP
          id <20090111141836.TCHE21638.aamtaout02-winn.ispmail.ntl.com@pws-pc>
          for <zsh-workers@sunsite.dk>; Sun, 11 Jan 2009 14:18:36 +0000
Date: Sun, 11 Jan 2009 14:18:33 +0000
From: Peter Stephenson <p.w.stephenson@ntlworld.com>
To: zsh-workers@sunsite.dk
Subject: Re: Test hang in Y01
Message-ID: <20090111141833.16aff555@pws-pc>
In-Reply-To: <20090111054506.GA15893@primenet.com.au>
References: <20a807210901100744w2f8c2c21h32da38cf2bc461ad@mail.gmail.com>
	<20090110214801.29ac6394@pws-pc>
	<20090111054506.GA15893@primenet.com.au>
X-Mailer: Claws Mail 3.6.1 (GTK+ 2.14.5; x86_64-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
X-Cloudmark-Analysis: v=1.0 c=1 a=NLZqzBF-AAAA:8 a=YNtcEbPv1rARWw3D-DwA:9 a=b7tnBosMM6eAoCNBCXIA:7 a=U420i4c3gMY4v9p6wONhmoYuphQA:4 a=LY0hPdMaydYA:10
X-Virus-Scanned: ClamAV 0.92.1/8850/Sun Jan 11 00:20:01 2009 on bifrost
X-Virus-Status: Clean

On Sun, 11 Jan 2009 16:45:06 +1100
Geoff Wing <gcw@zsh.org> wrote:
> On Saturday 2009-01-10 21:48 +0000, Peter Stephenson output:
> :On Sat, 10 Jan 2009 10:44:49 -0500
> :"Vin Shelton" <acs@alumni.princeton.edu> wrote:
> :> With an up-to-date archive, I'm getting a hang in test Y01.
> :Haven't seen this with committed code, but I did get a hang in the
> :middle of changing it at one point.  Could you try "make clean" first?
> 
> Does it for me too.  My nightly build/test cron job first picked it up
> 12 hours ago so it only due to something in the last day or so.  It hangs
> with continuous CPU use.
> 
> #0  0xbbafba77 in read () from /usr/lib/libc.so.12
> #1  0xbbad0082 in bin_zpty (nam=0x80f96d0 "zpty", args=0xbfbe7784, ops=0xbfbe77f0, func=0) at zpty.c:573

There must be something screwy about the exit condition for the loop in
ptyread() such that read() is repeatedly being called but not returning
in such a way that the loop exits.  I did change this a few months ago,
noticed the condition was horrible, and tried to fix it up a bit without
being entirely sure what it was trying to do (you may have heard that
before...)

If "prog" is non-NULL at that point (which I can't see offhand), we are
more aggressive about continuing, but maybe need to trap some more
errors.  For example, if ret is -1 there may be (thinking about it,
almost certainly are) some values of errno where we need to exit the
loop.  Consequently it would probably be useful to find out what errno
was and if prog was non-NULL.

This is all guesswork.  I would put small amounts of money on this being
an existing race that's just shown up rather than a fundamentally new
bug that's just been introduced.

> BTW, the ChangeLog line for 26272 has some stuff elided.

Thanks, I've fixed this.

-- 
Peter Stephenson <p.w.stephenson@ntlworld.com>
Web page now at http://homepage.ntlworld.com/p.w.stephenson/

