From zsh-workers-return-13197-mason-zsh=primenet.com.au@sunsite.auc.dk Mon Nov 27 11:21:37 2000
Return-Path: <zsh-workers-return-13197-mason-zsh=primenet.com.au@sunsite.auc.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 19949 invoked from network); 27 Nov 2000 11:21:35 -0000
Received: from sunsite.dk (HELO sunsite.auc.dk) (130.225.51.30)
  by ns1.primenet.com.au with SMTP; 27 Nov 2000 11:21:35 -0000
Received: (qmail 26596 invoked by alias); 27 Nov 2000 11:21:26 -0000
Mailing-List: contact zsh-workers-help@sunsite.auc.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.auc.dk
X-Seq: 13197
Received: (qmail 26589 invoked from network); 27 Nov 2000 11:21:25 -0000
Date: Mon, 27 Nov 2000 11:20:43 +0000
From: Peter Stephenson <pws@csr.com>
Subject: Re: PATCH: Module configuration changes
In-reply-to: "Your message of Sun, 26 Nov 2000 19:55:03 GMT."
 <E1407sP-00066Q-00.2000-11-26-19-54-18@mail3.svr.pol.co.uk>
To: zsh-workers@sunsite.auc.dk (Zsh hackers list)
Message-id: <0G4O005EVKUIGU@la-la.cambridgesiliconradio.com>
Content-transfer-encoding: 7BIT

> Here is the first stage in an improvement in the way modules are
> configured.

Tweaks based on configuring here on Solaris (dynamic) and cygwin (static)
with separate source and build directories, some auto=no modules, and one
cygwin-only module.  Otherwise things look OK.

Index: configure.in
===================================================================
RCS file: /cvsroot/zsh/zsh/configure.in,v
retrieving revision 1.33
diff -u -r1.33 configure.in
--- configure.in	2000/11/26 20:01:01	1.33
+++ configure.in	2000/11/27 11:17:18
@@ -1710,13 +1710,15 @@
 echo "creating ${CONFIG_MODULES}"
 userlist=" "
 if test -f config.modules; then
-  userlist=`sed -e '/^#/d' -e '/auto=y/d' -e 's/ .*/ /' -e 's/^name=/ /' \
-        ${CONFIG_MODULES}`
+  userlist="`sed -e '/^#/d' -e '/auto=y/d' -e 's/ .*/ /' -e 's/^name=/ /' \
+        ${CONFIG_MODULES}`"
   mv ${CONFIG_MODULES} ${CONFIG_MODULES}.old
 fi
-(cd ${srcdir}
-echo "# Edit this file to change the way modules are loaded."
+(echo "# Edit this file to change the way modules are loaded."
 echo "# The format is strict; do not break lines or add extra spaces."
+echo "# Run \`make prep' if you change anything here after compiling"
+echo "# (there is no need if you change this just after the first time"
+echo "# you run \`configure')."
 echo "#"
 echo "# Values of \`link' are \`static', \`dynamic' or \`no' to compile the"
 echo "# module into the shell, link it in at run time, or not use it at all."
@@ -1736,17 +1738,17 @@
 echo "#"
 echo "# You should not change the values for the pseudo-module zsh/main,"
 echo "# which is the main shell."
-for modfile in */*.mdd */*/*.mdd; do
+for modfile in `cd ${srcdir}; echo */*.mdd */*/*.mdd`; do
   name=
   link=
   load=
-  . $modfile
-  if test x$name != x -a x$link != x; then
-    case $userlist in
+  . ${srcdir}/$modfile
+  if test x$name != x -a x"$link" != x; then
+    case "$userlist" in
     *" $name "*) # not autogenerated, keep original
                 grep "^name=$name " ${CONFIG_MODULES}.old
 		;;
-    *) case $link in
+    *) case "$link" in
 	  *\ *) eval 'link=`'$link'`'
 	       ;;
        esac
@@ -1756,7 +1758,7 @@
 	 *) load=" load=no"
 	    ;;
        esac
-       case $link in
+       case "$link" in
 	 static) echo "name=$name modfile=$modfile link=static auto=yes${load}"
 	         ;;
 	 dynamic) if test $dynamic != no; then
@@ -1764,7 +1766,7 @@
  auto=yes${load}"
 		  else
 		    echo "name=$name modfile=$modfile link=no\
- auto=no load=no"
+ auto=yes load=no"
 		  fi
 		  ;;
 	 either) if test $dynamic != no; then

-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
Cambridge Silicon Radio, Unit 300, Science Park, Milton Road,
Cambridge, CB4 0XL, UK                          Tel: +44 (0)1223 392070

