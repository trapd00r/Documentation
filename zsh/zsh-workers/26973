From zsh-workers-return-26973-mason-zsh=primenet.com.au@sunsite.dk Tue May 19 15:28:11 2009
Return-Path: <zsh-workers-return-26973-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 3224 invoked from network); 19 May 2009 15:28:08 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.4 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received: from new-brage.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.254.104)
  by ns1.primenet.com.au with SMTP; 19 May 2009 15:28:08 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 35859 invoked from network); 19 May 2009 15:27:58 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 19 May 2009 15:27:58 -0000
Received: (qmail 13406 invoked by alias); 19 May 2009 15:27:50 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 26973
Received: (qmail 13386 invoked from network); 19 May 2009 15:27:49 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 19 May 2009 15:27:49 -0000
Received: from cluster-g.mailcontrol.com (cluster-g.mailcontrol.com [208.87.233.190])
	by bifrost.dotsrc.org (Postfix) with ESMTPS id BA1C28027106
	for <zsh-workers@sunsite.dk>; Tue, 19 May 2009 17:27:45 +0200 (CEST)
Received: from cameurexb01.EUROPE.ROOT.PRI ([193.128.72.68])
	by rly22g.srv.mailcontrol.com (MailControl) with ESMTP id n4JFR57W003721
	for <zsh-workers@sunsite.dk>; Tue, 19 May 2009 16:27:40 +0100
Received: from news01.csr.com ([10.99.50.25]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.3959);
	 Tue, 19 May 2009 16:26:39 +0100
Received: from news01.csr.com (localhost.localdomain [127.0.0.1])
	by news01.csr.com (8.14.2/8.13.4) with ESMTP id n4JFQdUP006632
	for <zsh-workers@sunsite.dk>; Tue, 19 May 2009 16:26:39 +0100
Received: from csr.com (pws@localhost)
	by news01.csr.com (8.14.2/8.14.2/Submit) with ESMTP id n4JFQd15006628
	for <zsh-workers@sunsite.dk>; Tue, 19 May 2009 16:26:39 +0100
X-Authentication-Warning: news01.csr.com: pws owned process doing -bs
To: zsh-workers@sunsite.dk (Zsh hackers list)
Subject: PATCH: zmathfuncdef
X-Mailer: MH-E 8.0.3; nmh 1.3; GNU Emacs 22.1.1
Date: Tue, 19 May 2009 16:26:39 +0100
Message-ID: <6627.1242746799@csr.com>
From: Peter Stephenson <pws@csr.com>
X-OriginalArrivalTime: 19 May 2009 15:26:39.0428 (UTC) FILETIME=[34803040:01C9D896]
X-Scanned-By: MailControl A-06-00-00 (www.mailcontrol.com) on 10.71.0.132
X-Virus-Scanned: ClamAV 0.94.2/9372/Tue May 19 16:28:03 2009 on bifrost
X-Virus-Status: Clean

This makes zmathfuncdef (i) silently replace existing functions, which
is much more standard and useful than requiring you to delete them first
(ii) with no arguments, output the current definitions in a form
suitable for inputting.

Index: Doc/Zsh/contrib.yo
===================================================================
RCS file: /cvsroot/zsh/zsh/Doc/Zsh/contrib.yo,v
retrieving revision 1.99
diff -u -r1.99 contrib.yo
--- Doc/Zsh/contrib.yo	6 Apr 2009 19:19:10 -0000	1.99
+++ Doc/Zsh/contrib.yo	19 May 2009 15:24:52 -0000
@@ -2371,7 +2371,7 @@
 See the comments in the function for a few extra tips.
 )
 findex(zmathfuncdef)
-item(tt(zmathfuncdef) var(mathfunc) [ var(body) ])(
+item(tt(zmathfuncdef) [ var(mathfunc) [ var(body) ] ])(
 A convenient front end to tt(functions -M).
 
 With two arguments, define a mathematical function named var(mathfunc)
@@ -2383,10 +2383,15 @@
 strictly adhered to for the function to calculate the correct number
 of arguments.  The implementation is held in a shell function named
 tt(zsh_math_func_)var(mathfunc); usually the user will not need
-to refer to the shell function directly.
+to refer to the shell function directly.  Any existing function
+of the same name is silently replaced.
 
 With one argument, remove the mathematical function var(mathfunc)
 as well as the shell function implementation.
+
+With no arguments, list all var(mathfunc) functions in a form
+suitable for restoring the definition.
+The functions have not necessarily been defined by tt(zmathfuncdef).
 )
 enditem()
 
Index: Functions/Misc/zmathfuncdef
===================================================================
RCS file: /cvsroot/zsh/zsh/Functions/Misc/zmathfuncdef,v
retrieving revision 1.3
diff -u -r1.3 zmathfuncdef
--- Functions/Misc/zmathfuncdef	2 Jun 2006 13:34:59 -0000	1.3
+++ Functions/Misc/zmathfuncdef	19 May 2009 15:24:52 -0000
@@ -5,18 +5,34 @@
 
 emulate -L zsh
 setopt extendedglob
+local -a match mbegin mend line
+local func
 
-if (( $# < 1 || $# > 2 )); then
-  print "Usage: $0 name [body]" >&2
+if (( $# > 2 )); then
+  print "Usage: $0 [name [body]]" >&2
   return 1
 fi
 
+zmodload -i zsh/parameter || return 1
+
+if (( $# == 0 )); then
+  functions -M | while read -A line; do
+    func=${functions[$line[6]]}
+    if [[ $func = (#b)[[:space:]]#\(\([[:space:]]#(*[^[:space:]])[[:space:]]#\)\) ]]; then
+      print "zmathfuncdef $line[3] ${(qq)match[1]}"
+    fi
+  done
+  return 0
+fi
+
 local mname=$1
 local fname="zsh_math_func_$1"
 
 if (( $# == 1 )); then
   functions +M $mname && unfunction $fname
   return 0
+elif [[ -n $functions[$fname] ]]; then
+  functions +M $mname
 fi
 
 integer iarg=0 ioptarg


-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070

