From zsh-users-return-13698-mason-zsh=primenet.com.au@sunsite.dk Sun Jan 11 19:08:38 2009
Return-Path: <zsh-users-return-13698-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 20448 invoked from network); 11 Jan 2009 19:08:35 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 11 Jan 2009 19:08:35 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 51343 invoked from network); 11 Jan 2009 19:08:27 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 11 Jan 2009 19:08:27 -0000
Received: (qmail 4252 invoked by alias); 11 Jan 2009 19:08:11 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 13698
Received: (qmail 4236 invoked from network); 11 Jan 2009 19:08:10 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 11 Jan 2009 19:08:10 -0000
Received: from vms173001pub.verizon.net (vms173001pub.verizon.net [206.46.173.1])
	by bifrost.dotsrc.org (Postfix) with ESMTP id C2C3E8028ACA
	for <zsh-users@sunsite.dk>; Sun, 11 Jan 2009 20:07:51 +0100 (CET)
Received: from torch.brasslantern.com ([96.238.220.215])
 by vms173001.mailsrvcs.net
 (Sun Java System Messaging Server 6.2-6.01 (built Apr  3 2006))
 with ESMTPA id <0KDB003GCMH2WNC0@vms173001.mailsrvcs.net> for
 zsh-users@sunsite.dk; Sun, 11 Jan 2009 13:07:51 -0600 (CST)
Received: from torch.brasslantern.com (localhost.localdomain [127.0.0.1])
	by torch.brasslantern.com (8.13.1/8.13.1) with ESMTP id n0BJ7m72012351	for
 <zsh-users@sunsite.dk>; Sun, 11 Jan 2009 11:07:49 -0800
Received: (from schaefer@localhost)	by torch.brasslantern.com
 (8.13.1/8.13.1/Submit) id n0BJ7m7e012350	for zsh-users@sunsite.dk; Sun,
 11 Jan 2009 11:07:48 -0800
Date: Sun, 11 Jan 2009 11:07:48 -0800
From: Bart Schaefer <schaefer@brasslantern.com>
Subject: Re: some way to inherit kill ring in su'd shell?
In-reply-to: <m3tz857mkm.fsf@klanderman.net>
To: Zsh users <zsh-users@sunsite.dk>
Message-id: <090111110748.ZM12349@torch.brasslantern.com>
MIME-version: 1.0
X-Mailer: OpenZMail Classic (0.9.2 24April2005)
Content-type: text/plain; charset=us-ascii
References: <18789.30656.261463.382208@gargle.gargle.HOWL>
	<20090110095231.GA61601@redoubt.spodhuis.org>	<m33afq97gg.fsf@klanderman.net>
	<20090111025418.GA7272@redoubt.spodhuis.org>	<m3tz857mkm.fsf@klanderman.net>
Comments: In reply to Greg Klanderman <gak@klanderman.net>
 "Re: some way to inherit kill ring in su'd shell?" (Jan 11, 12:57pm)
X-Virus-Scanned: ClamAV 0.92.1/8851/Sun Jan 11 15:41:56 2009 on bifrost
X-Virus-Status: Clean

On Jan 11, 12:57pm, Greg Klanderman wrote:
}
} From within zle, it looks like you can do something like
} 
}   zle copy-region-as-kill <string>
} 
} to populate the cut buffer/kill ring.
} 
} But then you have to do that from a user-defined widget again.

Use the zle-line-init widget.

It's hard to export the kill ring because of limitations on the format
of environment variables; they have to be plain strings and there has
to be some character that will work as a delimiter between elements if
you want to treat them as arrays.  Since just about anything could be
in the killring, there's not much you can do in the way of a delimiters.

So some variant of Phil's idea:

zle-line-init() {
  if [[ $KILLRINGPID != $$ && -f $KILLRINGFILE ]]
  then source $KILLRINGFILE
  fi
  export KILLRINGPID=$$ KILLRINGFILE=$HOME/.zsh-killring-$$
  typeset -p CUTBUFFER killring >! $KILLRINGFILE
}
zle -N zle-line-init

Of course this gets you the killring at the time zle starts up, not
after you've been editing the "su" command line itself.  For that you
would have to override either accept-line or the various kill widgets.
If you really want to pass the killring to a root shell, you'll also
need a secure location for the KILLRINGFILE to live.

