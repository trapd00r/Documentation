From zsh-users-return-11671-mason-zsh=primenet.com.au@sunsite.dk Wed Jul 25 16:11:21 2007
Return-Path: <zsh-users-return-11671-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 2332 invoked from network); 25 Jul 2007 16:11:20 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.1 (2007-05-02) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.1
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 25 Jul 2007 16:11:20 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 29064 invoked from network); 25 Jul 2007 16:11:14 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 25 Jul 2007 16:11:13 -0000
Received: (qmail 19600 invoked by alias); 25 Jul 2007 16:11:00 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 11671
Received: (qmail 19590 invoked from network); 25 Jul 2007 16:10:59 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 25 Jul 2007 16:10:59 -0000
Received: (qmail 27551 invoked from network); 25 Jul 2007 16:10:59 -0000
Received: from cluster-d.mailcontrol.com (217.69.20.190)
  by a.mx.sunsite.dk with SMTP; 25 Jul 2007 16:10:56 -0000
Received: from cameurexb01.EUROPE.ROOT.PRI ([62.189.241.200])
	by rly04d.srv.mailcontrol.com (MailControl) with ESMTP id l6PG9U9K018718
	for <zsh-users@sunsite.dk>; Wed, 25 Jul 2007 17:10:53 +0100
Received: from news01.csr.com ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.1830);
	 Wed, 25 Jul 2007 17:10:45 +0100
Received: from news01.csr.com (localhost.localdomain [127.0.0.1])
	by news01.csr.com (8.13.8/8.13.4) with ESMTP id l6PGAjEH024855
	for <zsh-users@sunsite.dk>; Wed, 25 Jul 2007 17:10:45 +0100
Received: from csr.com (pws@localhost)
	by news01.csr.com (8.13.8/8.13.8/Submit) with ESMTP id l6PGAjhH024852
	for <zsh-users@sunsite.dk>; Wed, 25 Jul 2007 17:10:45 +0100
Message-Id: <200707251610.l6PGAjhH024852@news01.csr.com>
X-Authentication-Warning: news01.csr.com: pws owned process doing -bs
To: zsh-users@sunsite.dk
Subject: Re: Using CVS Completion Functions 
In-reply-to: <20070725135652.GA3921@cetus30.cs.utk.edu> 
References: <20070725135652.GA3921@cetus30.cs.utk.edu>
Comments: In-reply-to Chris Johnson <cjohnson@cs.utk.edu>
   message dated "Wed, 25 Jul 2007 09:56:52 -0400."
Date: Wed, 25 Jul 2007 17:10:45 +0100
From: Peter Stephenson <pws@csr.com>
X-OriginalArrivalTime: 25 Jul 2007 16:10:45.0566 (UTC) FILETIME=[5B6ECDE0:01C7CED6]
Content-Type: text/plain
MIME-Version: 1.0
X-Scanned-By: MailControl A-07-08-00 (www.mailcontrol.com) on 10.68.0.114

Chris Johnson wrote:
> Hi.  A few weeks ago I posted about trying to get a subset of cvs
> completion for a script of mine.  This was the solution I came up with,
> based on Peter's suggestion:
> 
>    _cvs_changed_files() {
>      autoload +X _cvs
>      _cvs_files_modified "$@" || _cvs_files "$@"
>    }
>    compdef _cvs_changed_files cvsvimdiff
> 
> This seemed to work for a while, but occasionally I get this error when
> I try to complete:
> 
>    $ cvsvimdiff my_fi<TAB>_cvs_changed_files:2: command not found:
>    _cvs_files_modified
>    _cvs_changed_files:2: command not found: _cvs_files
> 
> Reading up on autoload, it seems that I should be autoloading not _cvs,
> but _cvs_files_modified and _cvs_files.

_cvs_files_modfied and _cvs_files are within the _cvs function, so you
have to load *and run* _cvs to acquire them, which I missed before.  This
version of _cvs redefines _cvs to the real completion function when it
runs.  Unfortunately, running it has the obvious effect of calling
normal _cvs completion.  There is a truly horrible hack...

autoload +X _cvs
functions[_cvs]=${functions[_cvs]%$'\n'*}
_cvs

This removes the last line of the initial _cvs function, which happens
to be the one that calls the redefined function.  As the function is
still redefined, future cvs completion will still work fine.

Defining multiple functions in the same body is convenient but
annoyingly limited... there's the additional problem of whether or not
you want to override any existing definition, as witness all the tests
like (( $+functions[_cvs_path_prefixes] )).  It would be nice to have
some mechanism like library files which told the shell to search for
undefined functions in there.  That would take some effort to parse
properly.

-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070


.

