From zsh-workers-return-26031-mason-zsh=primenet.com.au@sunsite.dk Wed Nov 12 13:50:42 2008
Return-Path: <zsh-workers-return-26031-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 17485 invoked from network); 12 Nov 2008 13:50:38 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 12 Nov 2008 13:50:38 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 78717 invoked from network); 12 Nov 2008 13:50:32 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 12 Nov 2008 13:50:32 -0000
Received: (qmail 2464 invoked by alias); 12 Nov 2008 13:50:29 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 26031
Received: (qmail 2448 invoked from network); 12 Nov 2008 13:50:28 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 12 Nov 2008 13:50:28 -0000
Received: from n7a.bullet.ukl.yahoo.com (n7a.bullet.ukl.yahoo.com [217.146.183.155])
	by bifrost.dotsrc.org (Postfix) with SMTP id 543F580308BE
	for <zsh-workers@sunsite.dk>; Wed, 12 Nov 2008 14:50:24 +0100 (CET)
Received: from [217.146.182.180] by n7.bullet.ukl.yahoo.com with NNFMP; 12 Nov 2008 13:50:24 -0000
Received: from [87.248.110.136] by t6.bullet.ukl.yahoo.com with NNFMP; 12 Nov 2008 13:50:24 -0000
Received: from [127.0.0.1] by omp225.mail.ukl.yahoo.com with NNFMP; 12 Nov 2008 13:50:24 -0000
X-Yahoo-Newman-Id: 132679.6935.bm@omp225.mail.ukl.yahoo.com
Received: (qmail 53380 invoked from network); 12 Nov 2008 13:50:24 -0000
DomainKey-Signature: a=rsa-sha1; q=dns; c=nofws;
  s=s1024; d=yahoo.co.uk;
  h=Received:X-YMail-OSG:X-Yahoo-Newman-Property:Received:From:To:Subject:Date:Message-ID;
  b=WiuX2qpEWU+jfcRkp9qLJempKJVtds2qUvSfgOujF+8JSDhl8A9h9RbLSFTwbHdisFMBS/vvRMLPEP/JCg06+CZfjua+xy2tq7s8/7Trqp3Xn9+oHB9CHkFN99aWDI5SDKnxH9BcWliuVLPrb/eRvewsN8Ko+BqYfU7opcTWbBM=  ;
Received: from unknown (HELO thecus) (okiddle@89.60.202.67 with plain)
  by smtp104.mail.ukl.yahoo.com with SMTP; 12 Nov 2008 13:50:24 -0000
X-YMail-OSG: mGb5W40VM1lGTt4.ZcCsaMfKPnrYVpE92emmQjow.2mNyJY7_whBxmYL9LOosH.yc7Z9cxaeX6M.LkkeXmGlOatjyoNidnljjIefLLZ0akMPnnjAKiK4253jnJ17nQiryRNpXRop7mLwdQ3y6oJ1DqsJe2IuxE.DXH1ol1I-
X-Yahoo-Newman-Property: ymail-3
Received: from localhost ([127.0.0.1] helo=thecus)
	by thecus with esmtp (Exim 4.63)
	(envelope-from <okiddle@yahoo.co.uk>)
	id 1L0G6w-0008ND-SM
	for zsh-workers@sunsite.dk; Wed, 12 Nov 2008 14:50:22 +0100
From: Oliver Kiddle <okiddle@yahoo.co.uk>
To: Zsh workers <zsh-workers@sunsite.dk>
Subject: inconsistency of invalid identifier error messages
Date: Wed, 12 Nov 2008 14:50:22 +0100
Message-ID: <32190.1226497822@thecus>
X-Virus-Scanned: ClamAV 0.92.1/8622/Wed Nov 12 12:59:01 2008 on bifrost
X-Virus-Status: Clean

The following seems somewhat inconsistent. Compare the error messages
and note the difference in whether the error is printed before or after
the edits.

vared -c a-b
vared -c ''
vared -- -a
vared -- -
read a-b
unset a-b
unset 'a[b'

I think unset should be producing an error in both cases.  It's fair
that it quitely succeeds if you unset an already unset parameter but an
invalid parameter name is different.

Any preference on what error message to standardise on. We currently
have:
not an identifier: -
not an identifier: `-a'
invalid parameter name: a-b
a[b: invalid parameter name

Also, any views on whether errors should be printed before or after or
whether it is correct that read consumes the input regardless while vared
immediately prints the error message? Bash and Ksh have the opposite
behaviour in this regard.

The patch below makes the first two (vared) cases consistent with the
third one. Any thoughts on how to best fix the last vared case (editing
$-) and what to do about unset? With this patch, I'm also assuming that
the first error condition should have been calling unqueue_signals().

Oliver

Index: Src/Zle/zle_main.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/zle_main.c,v
retrieving revision 1.120
diff -u -r1.120 zle_main.c
--- Src/Zle/zle_main.c	12 Nov 2008 12:59:07 -0000	1.120
+++ Src/Zle/zle_main.c	12 Nov 2008 13:17:55 -0000
@@ -1492,11 +1492,11 @@
 	unqueue_signals();
 	zwarnnam(name, "no such variable: %s", args[0]);
 	return 1;
+    } else if (*s || s == args[0]) {
+	unqueue_signals();
+	zwarnnam(name, "not an identifier: %s", args[0]);
+	return 1;
     } else if (v) {
-	if (*s) {
-	    zwarnnam(name, "not an identifier: `%s'", args[0]);
-	    return 1;
-	}
 	if (v->isarr) {
 	    /* Array: check for separators and quote them. */
 	    char **arr = getarrvalue(v), **aptr, **tmparr, **tptr;
@@ -1549,10 +1549,6 @@
 	    s = ztrdup(getstrvalue(v));
 	}
 	unqueue_signals();
-    } else if (*s) {
-	unqueue_signals();
-	zwarnnam(name, "invalid parameter name: %s", args[0]);
-	return 1;
     } else {
 	unqueue_signals();
 	s = ztrdup(s);

