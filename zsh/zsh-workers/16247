From zsh-workers-return-16247-mason-zsh=primenet.com.au@sunsite.dk Wed Nov 14 14:32:40 2001
Return-Path: <zsh-workers-return-16247-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 23257 invoked from network); 14 Nov 2001 14:32:39 -0000
Received: from ns2.primenet.com.au (HELO primenet.com.au) (?MRja46Ab9zPjJLMxmN3hkiuxjbPyCS4J?@203.24.36.3)
  by ns1.primenet.com.au with SMTP; 14 Nov 2001 14:32:39 -0000
Received: (qmail 5091 invoked from network); 14 Nov 2001 14:32:37 -0000
Received: from sunsite.dk (130.225.247.90)
  by proxy.melb.primenet.com.au with SMTP; 14 Nov 2001 14:32:37 -0000
Received: (qmail 22563 invoked by alias); 14 Nov 2001 14:32:27 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 16247
Received: (qmail 22537 invoked from network); 14 Nov 2001 14:32:26 -0000
From: Borsenkow Andrej <Andrej.Borsenkow@mow.siemens.ru>
To: "'Oliver Kiddle'" <okiddle@yahoo.co.uk>
Cc: "'ZSH Workers Mailing List'" <zsh-workers@sunsite.dk>
Subject: PATCH: RE: Mandrake urpmi suite completion
Date: Wed, 14 Nov 2001 17:32:15 +0300
Message-ID: <000201c16d19$27f25f10$21c9ca95@mow.siemens.ru>
MIME-Version: 1.0
Content-Type: multipart/mixed;
	boundary="----=_NextPart_000_0003_01C16D32.4D3F9710"
X-Priority: 3 (Normal)
X-MSMail-Priority: Normal
X-Mailer: Microsoft Outlook, Build 10.0.3311
x-mimeole: Produced By Microsoft MimeOLE V6.00.2600.0000
In-Reply-To: <3BE6772C.AD3447B6@yahoo.co.uk>
Importance: Normal

This is a multi-part message in MIME format.

------=_NextPart_000_0003_01C16D32.4D3F9710
Content-Type: text/plain;
	charset="us-ascii"
Content-Transfer-Encoding: 7bit

> >             "(--help)--auto-select[select the pakages to update]" \
> 
> You've got a typo here:                          ^^^
>

fixed.
 

> 
> Do you mean _urls there?
>

Yes, fixed.
 
> >         else
> >             compadd -- file:// http:// ftp:// removable_
> 
> An _wanted with description would be nice here (and similarly further
> above).
> 

Added. Also modified to handle new urpmi-2.0+ removable format.

-andrej

Patch attached, I commit when I get article number back.


------=_NextPart_000_0003_01C16D32.4D3F9710
Content-Type: application/octet-stream;
	name="zsh-urpmi.diff"
Content-Transfer-Encoding: quoted-printable
Content-Disposition: attachment;
	filename="zsh-urpmi.diff"

Index: Completion/Mandrake/Command/_urpmi=0A=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=0A=
RCS file: _urpmi=0A=
diff -N _urpmi=0A=
--- /dev/null	Thu May 24 22:33:05 2001=0A=
+++ _urpmi	Wed Nov 14 06:26:42 2001=0A=
@@ -0,0 +1,111 @@=0A=
+#compdef urpmi urpmi.addmedia urpmi.removemedia urpmi.update=0A=
+local state context line=0A=
+typeset -A opt_args=0A=
+=0A=
+_urpmi_cache_policy() {=0A=
+    [[ -e "$1" && -e /var/lib/urpmi/depslist.ordered && \=0A=
+	"$1" -nt /var/lib/urpmi/depslist.ordered ]] && return 1=0A=
+    return 0=0A=
+}=0A=
+    =0A=
+case "$service" in=0A=
+    urpmi.addmedia )=0A=
+	_arguments -A '-*' \=0A=
+	    "-update[mark as update media]" \=0A=
+	    ":name of media: " \=0A=
+	    ":media URL:->media_url" \=0A=
+	    ": :(with)" \=0A=
+	    ":relative path to hdlist file: " \=0A=
+	 && return 0=0A=
+    ;;=0A=
+    urpmi.removemedia )=0A=
+	_arguments -A '-*' \=0A=
+	    "(:)-a[select all media]" \=0A=
+	    "(-a)"{,\*}": :->urpmi_media" \=0A=
+	 && return 0=0A=
+    ;;=0A=
+    urpmi.update )=0A=
+	_arguments -A '-*' \=0A=
+	    "(:)-a[select all non-removable media]" \=0A=
+	    "-c[clean /var/cache/urpmi/headers on exit]" \=0A=
+	    "*-f[force rebuild of hdlist or base files (if repeated)]" \=0A=
+	    "(-a)"{,\*}": :->urpmi_media" \=0A=
+	 && return 0=0A=
+    ;;=0A=
+    urpmi )=0A=
+	_arguments -A '-*' \=0A=
+	    "(: -)--help[print usage information]" \=0A=
+	    "(--help)--update[use only update media]" \=0A=
+	    "(--help)--allow-medium-change[allow change of removable media]" =
\=0A=
+	    "(--help)--auto[do not ask any questions]" \=0A=
+	    "(--help)--auto-select[select the packages to update]" \=0A=
+	    "(--help)--force[preceed even when some packages do not exist]" =
\=0A=
+	    "(--help)--best-output[automatically select text or X interface]" =
\=0A=
+	    "(--help)-a[select all packages matching command line]" \=0A=
+	    "(--help -m -M)-m[choose minimum closure of requires (default)]" =
\=0A=
+	    "(--help -m -M)-M[choose maximum closure of requires]" \=0A=
+	    "(--help)-c[choose complete method for resolving requires]" \=0A=
+	    "(--help)-p[allow search in provides]" \=0A=
+	    "(--help -q -v)-q[be quiet]" \=0A=
+	    "(--help -q -v)-v[verbose mode]" \=0A=
+	    "(--help)"{,\*}": :->urpmi_rpms" \=0A=
+	&& return 0=0A=
+    ;;=0A=
+esac=0A=
+=0A=
+case "$state" in=0A=
+    media_url )=0A=
+	if compset -P file://; then=0A=
+	    _files -W / -/ && return 0=0A=
+	elif compset -P 'removable_cdrom(|_?)://'; then=0A=
+	    _files -/ && return 0=0A=
+	elif compset -P removable_; then=0A=
+	    local -a devices=0A=
+	    locale dev foo=0A=
+	    while read dev foo; do=0A=
+		[[ "$dev" !=3D none ]] && devices=3D($devices ${dev#/dev/})=0A=
+	    done < /etc/fstab=0A=
+	    if [[ "$(rpm -q urpmi)" =3D=3D urpmi-1.* ]]; then=0A=
+		_wanted urpmi_device expl 'device for removable media' \=0A=
+		   compadd -s _ -S "" -a devices && return 0=0A=
+	    else=0A=
+		_wanted urpmi_device expl 'device for removable media' \=0A=
+		   compadd -s :// -S "" -a devices && return 0=0A=
+	    fi=0A=
+	elif [[ -prefix '(ftp|http)://' ]]; then=0A=
+	    _urls && return 0=0A=
+	else=0A=
+	    _wanted urpmi_media_type expl 'type of media' \=0A=
+		compadd -- file:// http:// ftp:// removable_=0A=
+	fi=0A=
+    ;;=0A=
+    urpmi_media )=0A=
+	local source media brace ret=3D1=0A=
+	while read source media brace; do=0A=
+	    [[ "$brace" !=3D "{" ]] && continue=0A=
+	    _wanted urpmi_media expl 'available media' \=0A=
+		compadd -- "$source"=0A=
+	    ret=3D0=0A=
+	done < /etc/urpmi/urpmi.cfg=0A=
+	return "$ret"=0A=
+    ;;=0A=
+    urpmi_rpms )=0A=
+	local pkg foo expl=0A=
+	local -a pkgs=0A=
+	if [[ -r /var/lib/urpmi/depslist.ordered ]]; then=0A=
+	    if _cache_invalid _urpmi_rpms || ! _retrieve_cache _urpmi_rpms; =
then=0A=
+		while read pkg foo; do=0A=
+		    [[ "$pkg" =3D=3D (#b)(*)-[^-]##-[^-]## ]] && {=0A=
+			pkgs[$#pkgs+1]=3D("$match[1]")=0A=
+		    }=0A=
+		done < /var/lib/urpmi/depslist.ordered=0A=
+		_store_cache _urpmi_rpms pkgs=0A=
+	    fi=0A=
+	    _wanted urpmi_rpms expl 'RPM to install' \=0A=
+		compadd -a pkgs && return 0=0A=
+	fi=0A=
+    ;;=0A=
+esac=0A=
+=0A=
+return 1=0A=
+=0A=

------=_NextPart_000_0003_01C16D32.4D3F9710--

