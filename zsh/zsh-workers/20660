From zsh-workers-return-20660-mason-zsh=primenet.com.au@sunsite.dk Mon Jan 10 09:49:26 2005
Return-Path: <zsh-workers-return-20660-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 27018 invoked from network); 10 Jan 2005 09:49:25 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 10 Jan 2005 09:49:25 -0000
Received: (qmail 43579 invoked from network); 10 Jan 2005 09:49:19 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 10 Jan 2005 09:49:19 -0000
Received: (qmail 7164 invoked by alias); 10 Jan 2005 09:49:04 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 20660
Received: (qmail 7146 invoked from network); 10 Jan 2005 09:49:02 -0000
Received: from unknown (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 10 Jan 2005 09:49:02 -0000
Received: (qmail 41175 invoked from network); 10 Jan 2005 09:48:03 -0000
Received: from smtp-out3.blueyonder.co.uk (195.188.213.6)
  by a.mx.sunsite.dk with SMTP; 10 Jan 2005 09:48:00 -0000
Received: from sc ([82.41.210.43]) by smtp-out3.blueyonder.co.uk with Microsoft SMTPSVC(5.0.2195.6713);
	 Mon, 10 Jan 2005 09:48:32 +0000
Date: Mon, 10 Jan 2005 09:49:18 +0000
From: Stephane Chazelas <Stephane_Chazelas@yahoo.fr>
To: Zsh hackers list <zsh-workers@sunsite.dk>
Subject: Re: multios and unnecessary processes
Message-ID: <20050110094918.GA4432@sc>
Mail-Followup-To: Zsh hackers list <zsh-workers@sunsite.dk>
References: <20050109164753.GA4246@sc> <1050109203218.ZM22780@candle.brasslantern.com>
Mime-Version: 1.0
Content-Type: text/plain; charset=iso-8859-15
Content-Disposition: inline
Content-Transfer-Encoding: 8bit
In-Reply-To: <1050109203218.ZM22780@candle.brasslantern.com>
User-Agent: Mutt/1.5.6i
X-OriginalArrivalTime: 10 Jan 2005 09:48:32.0181 (UTC) FILETIME=[8B8D7650:01C4F6F9]
X-Spam-Checker-Version: SpamAssassin 2.63 on a.mx.sunsite.dk
X-Spam-Level: *
X-Spam-Status: No, hits=1.5 required=6.0 tests=RCVD_IN_SORBS autolearn=no 
	version=2.63
X-Spam-Hits: 1.5

On Sun, Jan 09, 2005 at 08:32:18PM +0000, Bart Schaefer wrote:
> On Jan 9,  4:47pm, Stephane Chazelas wrote:
> } Subject: multios and unnecessary processes
> }
> } zsh -c 'lsof -ag $$ -d0-2,10-15 >&2 >&- >&2'
> } 
> } and 
> } 
> } zsh -c 'lsof -ag $$ -d0-2,10-15 >&2'
> } 
> } To work the same.
> 
> Interesting.  For me, they *do* work the same *if* the command is run
> from the shell prompt rather than from "zsh -c".  In fact, I can only
> reproduce your results if I use a non-interactive shell.  If I put those
> two commands in files and execute the files with "zsh -if" I get (in
> both cases):
> 
> OMMAND   PID  PGRP     USER   FD   TYPE DEVICE SIZE   NODE NAME
> zsh     22683 22683 schaefer    0u   CHR  136,8          10 /dev/pts/8
> zsh     22683 22683 schaefer    1u   CHR  136,8          10 /dev/pts/8
> zsh     22683 22683 schaefer    2u   CHR  136,8          10 /dev/pts/8
> zsh     22683 22683 schaefer   10r   REG    3,1   36 159782 /tmp/lsof1
> zsh     22683 22683 schaefer   11u   CHR  136,8          10 /dev/pts/8
> 
> But if I leave off the -i I get the extra pipe descriptors in the first
> case.  I don't know offhand why multios would behave differently when
> the shell is interactive.
[...]

That's because of the -g option to lsof (process group $$, and
lsof is run in a different process group in interactive mode),
but you get the same behavior in interactive shells (you need to
give other options to lsof)

> } I came accross this while trying to make some code independant
> } of the multios setting (hence the >&- to cancel the teed
> } redirection).
> 
> I'm a little puzzled by that statement, because in your second example
> there is no teed redirection.  It's only the doubled >&2 that creates
> a teed redirection in the first place.
> 
> The right way to write multios-independent code is to wrap things in
> curly braces, e.g.:  { lsof -ag $$ -d0-2,10-15 >&2 } >&2

That was for:

{ cmd 2>&1 >&- >&3 3>&- | cmd2 3>&-; } 3>&-

(which can be written cmd 2> >(cmd2) on some systems)

Thanks for the

{ { cmd 2>&1 >&3 3>&-; } | cmd2 3>&-; } 3>&-

~$ zsh -c '{ { lsof -ag $$ -d 0-2,10-15 2>&1 >&3 3>&-; } | tr a b 3>&-; } 3>&1'
COMMAND  PID PGID     USER   FD   TYPE DEVICE SIZE  NODE NAME
tr      4506 4506 chazelas    0u  FIFO    0,7      10296 pipe
tr      4506 4506 chazelas    1u   CHR  136,1          3 /dev/pts/1
tr      4506 4506 chazelas    2u   CHR  136,1          3 /dev/pts/1
zsh     4507 4506 chazelas    0u   CHR  136,1          3 /dev/pts/1
zsh     4507 4506 chazelas    1w  FIFO    0,7      10296 pipe
zsh     4507 4506 chazelas    2u   CHR  136,1          3 /dev/pts/1
zsh     4507 4506 chazelas   10u   CHR  136,1          3 /dev/pts/1
zsh     4507 4506 chazelas   11r   CHR    1,3       2892 /dev/null
lsof    4508 4506 chazelas    0u   CHR  136,1          3 /dev/pts/1
lsof    4508 4506 chazelas    1u   CHR  136,1          3 /dev/pts/1
lsof    4508 4506 chazelas    2w  FIFO    0,7      10296 pipe

But that's still one more process compared to:

~$ zsh -o nomultios -c '{ lsof -ag $$ -d 0-2,10-15 2>&1 >&3 3>&- | tr a b 3>&-; } 3>&1'
COMMAND  PID PGID     USER   FD   TYPE DEVICE SIZE  NODE NAME
tr      4564 4564 chazelas    0u  FIFO    0,7      10603 pipe
tr      4564 4564 chazelas    1u   CHR  136,1          3 /dev/pts/1
tr      4564 4564 chazelas    2u   CHR  136,1          3 /dev/pts/1
lsof    4565 4564 chazelas    0u   CHR  136,1          3 /dev/pts/1
lsof    4565 4564 chazelas    1u   CHR  136,1          3 /dev/pts/1
lsof    4565 4564 chazelas    2w  FIFO    0,7      10603 pipe


-- 
Stéphane

