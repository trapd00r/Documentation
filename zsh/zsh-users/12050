From zsh-users-return-12050-mason-zsh=primenet.com.au@sunsite.dk Fri Oct 19 06:12:18 2007
Return-Path: <zsh-users-return-12050-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 29589 invoked from network); 19 Oct 2007 06:12:08 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.3 (2007-08-08) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=BAYES_00 autolearn=ham
	version=3.2.3
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 19 Oct 2007 06:12:08 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 49921 invoked from network); 19 Oct 2007 06:12:02 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 19 Oct 2007 06:12:02 -0000
Received: (qmail 23422 invoked by alias); 19 Oct 2007 06:11:54 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 12050
Received: (qmail 23405 invoked from network); 19 Oct 2007 06:11:53 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 19 Oct 2007 06:11:53 -0000
Received: (qmail 48638 invoked from network); 19 Oct 2007 06:11:53 -0000
Received: from wx-out-0506.google.com (66.249.82.225)
  by a.mx.sunsite.dk with SMTP; 19 Oct 2007 06:11:47 -0000
Received: by wx-out-0506.google.com with SMTP id h27so365679wxd
        for <zsh-users@sunsite.dk>; Thu, 18 Oct 2007 23:11:46 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=beta;
        h=domainkey-signature:received:received:received:date:from:to:cc:subject:message-id:references:mime-version:content-type:content-disposition:in-reply-to:x-editor:user-agent;
        bh=OfZnCQUZthwudkbaJ0zWLJjfHGhjgVTaBYQpMNsEL60=;
        b=LYnVq7Psw0SvdC1w3cBk4VdEfFL4OHgJy3lvk3QIuGajf0hiOZXSTB2XACp9BcDonmJJlGpQTKK345yaOQMk6xNrxwYIjjqpOIbLdF09th6kJ4z7vyzD4vLaYuBSJHsaPDWkBKCqdxnUa5TNyB5dwUzRWFZD+xYOc/XNAdiJI8g=
DomainKey-Signature: a=rsa-sha1; c=nofws;
        d=gmail.com; s=beta;
        h=received:date:from:to:cc:subject:message-id:references:mime-version:content-type:content-disposition:in-reply-to:x-editor:user-agent;
        b=rygojDo5OnthVdHjh15iyIDXpIGeA6pDpaIswyKjJ7Ahl73oiKxcThDmI8tmMHLyNHV7C859zU+uF6JYgbFXCrd5L8fsqufLHmECz8aSkDDjLhEuyvGdRiXOXbxplcOvtoz9BtakTyLdoOyY4ZRQDex4avjNpU1Fe8tVnbxkho8=
Received: by 10.150.96.10 with SMTP id t10mr300225ybb.1192774306341;
        Thu, 18 Oct 2007 23:11:46 -0700 (PDT)
Received: from mastermind ( [76.99.60.158])
        by mx.google.com with ESMTPS id 67sm2469680wra.2007.10.18.23.11.43
        (version=TLSv1/SSLv3 cipher=OTHER);
        Thu, 18 Oct 2007 23:11:44 -0700 (PDT)
Received: by mastermind (sSMTP sendmail emulation); Fri, 19 Oct 2007 02:12:00 -0400
Date: Fri, 19 Oct 2007 02:12:00 -0400
From: Matthew Wozniski <godlygeek@gmail.com>
To: zsh-users@sunsite.dk
Cc: Atom Smasher <atom@smasher.org>
Subject: Re: missing Parameter Expansion Flag?
Message-ID: <20071019061200.GG13054@mastermind>
References: <20071018235322.98130.qmail@smasher.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20071018235322.98130.qmail@smasher.org>
X-Editor: Vim-7.1.56
User-Agent: Mutt/1.5.15+20070412 (2007-04-11)

On Fri, Oct 19, 2007 at 12:53:21PM +1300, Atom Smasher wrote:
> *but* i don't see how to count the string so that it just counts the 
> printing characters (xxxyyy). i want to count it so the count returns 6, 
> which is how many printable characters are in the string. intuitively, i 
> would think there should be a parameter expansion flag to do that, but i 
> can't find it. is there another (good*) way? should there be a flag for 
> that?

There can't be a flag for that because zsh doesn't know what
characters are and are not printing, it just outputs them to the
terminal.  The actual codes supported are terminal-dependent.  For
a list of control sequences supported by xterm, see the list at
http://www.xfree86.org/current/ctlseqs.html .  A list of control
sequences recognized by screen can be found in `man screen', in the
'The Virtual Terminal' section.  Quick googling should find you
a similar list for rxvt.  While all of those lists have some
similarities ("\e[{3,4}{0..7}m" being one of them), they also all have
their differences, and a comprehensive list would be a larger project
than terminfo or termcap.  The fact that many of those commands can
take a variable number of arguments make it even harder.  If zsh could
do that, though, we wouldn't need %{...%} in our prompt strings.

That being said...

> let's say i set a string to print "xxxyyy" with the "xxx" in the default 
> color and the "yyy" in red:
> 	foo="xxx${fg[red]}yyy"
>
> which results in:
> 	print ${foo}
> 	xxxyyy
>
> 	print ${(V)foo}
> 	xxx^[[31myyy

Why not wrap your stuff in the prompt expansion stuff?

mastermind% autoload -U colors; colors
mastermind% foo="xx%{${fg[red]}%}yy%{${fg[blue]}%}zz%{$reset_color%}"
mastermind% echo ${(V)foo}
xx%{^[[31m%}yy%{^[[34m%}zz%{^[[00m%}
mastermind% echo ${(VS)foo//\%\{*\%\}}
xxyyzz
mastermind% echo $#foo
33
mastermind% echo ${#${(S)foo//\%\{*\%\}}}
6
mastermind% echo ${(%)foo}
xxyyzz   <- *colored*
mastermind% echo ${(S)foo//\%\{*\%\}}
xxyyzz   <- *not colored*

That is, if you wrap unprintable sequences in %{..%}, you can still
print out the string without the delimiters using ${(%)var} ( (%)
causes %-escapes in the resulting string to be expanded, and %{ and %}
expand to nothing. )  Then, you can also get the size of the string by
expanding it to remove ( ${var//foo}, replace foo with nothing) the %{
up til %} (non-greedy matching with (S).  So, the short answer is that
zsh has no way of keeping track of what was printable, and the long
answer is that it's not impossible to keep track of yourself, as long
as you are only using escape sequences that you know will not be
shown and mark them up accordingly ahead of time.

~Matt

