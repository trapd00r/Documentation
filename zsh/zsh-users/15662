From zsh-users-return-15662-mason-zsh=primenet.com.au@zsh.org Tue Dec 21 08:46:10 2010
Return-Path: <zsh-users-return-15662-mason-zsh=primenet.com.au@zsh.org>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 18956 invoked by alias); 21 Dec 2010 08:46:10 -0000
Mailing-List: contact zsh-users-help@zsh.org; run by ezmlm
Precedence: bulk
X-No-Archive: yes
List-Id: Zsh Users List <zsh-users.zsh.org>
List-Post: <mailto:zsh-users@zsh.org>
List-Help: <mailto:zsh-users-help@zsh.org>
Delivered-To: mailing list zsh-users@zsh.org
X-Seq: 15662
Received: (qmail 13172 invoked from network); 21 Dec 2010 08:46:09 -0000
X-Spam-Checker-Version: SpamAssassin 3.3.1 (2010-03-16) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-1.9 required=5.0 tests=BAYES_00,RCVD_IN_DNSWL_NONE
	autolearn=ham version=3.3.1
Received-SPF: none (ns1.primenet.com.au: domain at closedmail.com does not designate permitted sender hosts)
From: Bart Schaefer <schaefer@brasslantern.com>
Message-id: <101221004549.ZM6697@torch.brasslantern.com>
Date: Tue, 21 Dec 2010 00:45:49 -0800
In-reply-to: <AANLkTi=E8zH92uHVMcS_Jk-eSt08y4iu75FGcz9gkbkO@mail.gmail.com>
Comments: In reply to Le Wang <l26wang@gmail.com>
 "using array slice as lvalue" (Dec 21,  3:42pm)
References: <AANLkTi=E8zH92uHVMcS_Jk-eSt08y4iu75FGcz9gkbkO@mail.gmail.com>
X-Mailer: OpenZMail Classic (0.9.2 24April2005)
To: zsh-users@zsh.org
Subject: Re: using array slice as lvalue
MIME-version: 1.0
Content-type: text/plain; charset=us-ascii

On Dec 21,  3:42pm, Le Wang wrote:
}
} arr=(a b c)
} arr[2,-1]=(z)
} typeset arr # arr=(a z b c)

I would have to say that is a bug.  [1,-1] is handled as a special case,
but it appears assignment botches other negative indices unless both
the start and the end are negative.

Rather amazing that this has never come up before (and of course it
can't help but appear immediately after a release is announced).

Potential patch -- fixes this case and still passes "make check" but
may break some other obscure corner:

Index: Src/params.c
--- zsh-forge/current/Src/params.c	2010-11-19 09:49:19.000000000 -0800
+++ Src/params.c	2010-12-21 00:40:29.000000000 -0800
@@ -2442,8 +2442,6 @@
 		v->start--;
 	    v->end--;
 	}
-	if (v->end < v->start)
-	    v->end = v->start;
 	q = old = v->pm->gsu.a->getfn(v->pm);
 	n = arrlen(old);
 	if (v->start < 0) {
@@ -2456,6 +2454,8 @@
 	    if (v->end < 0)
 		v->end = 0;
 	}
+	if (v->end < v->start)
+	    v->end = v->start;
 
 	ll = v->start + arrlen(val);
 	if (v->end <= n)

