From zsh-workers-return-23658-mason-zsh=primenet.com.au@sunsite.dk Thu Jul 05 18:21:05 2007
Return-Path: <zsh-workers-return-23658-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 19659 invoked from network); 5 Jul 2007 18:20:59 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.1 (2007-05-02) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.1
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 5 Jul 2007 18:20:59 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 84194 invoked from network); 5 Jul 2007 18:20:54 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 5 Jul 2007 18:20:54 -0000
Received: (qmail 490 invoked by alias); 5 Jul 2007 18:20:51 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 23658
Received: (qmail 481 invoked from network); 5 Jul 2007 18:20:51 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 5 Jul 2007 18:20:51 -0000
Received: (qmail 83863 invoked from network); 5 Jul 2007 18:20:51 -0000
Received: from cluster-g.mailcontrol.com (85.115.41.190)
  by a.mx.sunsite.dk with SMTP; 5 Jul 2007 18:20:43 -0000
Received: from rly11g.srv.mailcontrol.com (localhost.localdomain [127.0.0.1])
	by rly11g.srv.mailcontrol.com (MailControl) with ESMTP id l65IKfbN020943
	(version=TLSv1/SSLv3 cipher=DHE-RSA-AES256-SHA bits=256 verify=NO)
	for <zsh-workers@sunsite.dk>; Thu, 5 Jul 2007 19:20:41 +0100
Received: from submission.mailcontrol.com (submission.mailcontrol.com [86.111.216.190])
	by rly11g.srv.mailcontrol.com (MailControl) id l65IKAOk017584
	for zsh-workers@sunsite.dk; Thu, 5 Jul 2007 19:20:10 +0100
Received: from cameurexb01.EUROPE.ROOT.PRI ([62.189.241.200])
	by rly11g-eth0.srv.mailcontrol.com (envelope-sender Peter.Stephenson@csr.com) (MIMEDefang) with ESMTP id l65IK9Js017541; Thu, 05 Jul 2007 19:20:10 +0100 (BST)
Received: from news01.csr.com ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.1830);
	 Thu, 5 Jul 2007 19:20:08 +0100
Date: Thu, 5 Jul 2007 19:20:08 +0100
From: Peter Stephenson <pws@csr.com>
To: Damien Wyart <damien.wyart@free.fr>
Cc: zsh-workers@sunsite.dk
Subject: Re: Errors with ssh and rsync completion in zsh-beta (Debian
 unstable)
Message-ID: <20070705192008.6c79668e@news01.csr.com>
In-Reply-To: <20070705162157.GA3988@localhost.localdomain>
References: <20070705162157.GA3988@localhost.localdomain>
Organization: CSR
X-Mailer: Claws Mail 2.9.1 (GTK+ 2.10.12; i386-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
X-OriginalArrivalTime: 05 Jul 2007 18:20:08.0823 (UTC) FILETIME=[1E6ED070:01C7BF31]
X-Scanned-By: MailControl A-07-07-05 (www.mailcontrol.com) on 10.71.1.121

On Thu, 5 Jul 2007 18:21:57 +0200
Damien Wyart <damien.wyart@free.fr> wrote:
> I get error messages when completing in ssh or rsync commands :
> 
> ,----
> | dwyart@dalpdw2:~$ ssh dw
> | _combination:86: bad floating point constant
> | _combination:86: bad math expression: operator expected at `root'
> | dwyart@dalpdw2:~$ ssh dw@b
> | _combination:76: bad math expression: operator expected at `root'
> | _combination:86: bad floating point constant
> | dwyart@dalpdw2:~$ rsync -av dw@b
> | _combination:76: bad math expression: operator expected at `root'
> `----

Thanks for spotting this.  Here's what's happened.  _combination takes
arguments that may indicate with a suffix :<num> that the num'th match
should be used.  However, it's sloppy about testing for the suffix, and if
the suffix isn't present it uses the full expression.  This was the name of
an array variable ("hosts" in one of the cases).  In previous versions of
the shell, evaluating an array in math context substituted 0 so this went
unnoticed (it still wasn't the right thing to do, obviously).  However,
we've now fixed the syntax so that an array evaluated in math context does
what (I would think) you always expected it would.

The fix is to test for a number properly in _combination.

Index: Completion/Base/Utility/_combination
===================================================================
RCS file: /cvsroot/zsh/zsh/Completion/Base/Utility/_combination,v
retrieving revision 1.1
diff -u -r1.1 _combination
--- Completion/Base/Utility/_combination	2 Apr 2001 11:10:08 -0000	1.1
+++ Completion/Base/Utility/_combination	5 Jul 2007 18:17:00 -0000
@@ -72,13 +72,21 @@
 while [[ "$1" = *=* ]]; do
   tmp="${1%%\=*}"
   key="${tmp%:*}"
-  num="${${tmp##*:}:-1}"
+  if [[ $1 = *:* ]]; then
+    num=${tmp##*:}
+  else
+    num=1
+  fi
   pats[$keys[(in:num:)$key]]="${1#*\=}"
   shift
 done
 
 key="${1%:*}"
-num="${${1##*:}:-1}"
+if [[ $1 = *:* ]]; then
+  num=${1##*:}
+else
+  num=1
+fi
 shift
 
 if zstyle -a ":completion:${curcontext}:$tag" "$style" tmp; then


-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070


To access the latest news from CSR copy this link into a web browser:  http://www.csr.com/email_sig.php

To get further information regarding CSR, please visit our Investor Relations page at http://ir.csr.com/csr/about/overview

