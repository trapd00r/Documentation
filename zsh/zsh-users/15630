From zsh-users-return-15630-mason-zsh=primenet.com.au@zsh.org Tue Dec 07 04:48:04 2010
Return-Path: <zsh-users-return-15630-mason-zsh=primenet.com.au@zsh.org>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 23917 invoked by alias); 7 Dec 2010 04:48:04 -0000
Mailing-List: contact zsh-users-help@zsh.org; run by ezmlm
Precedence: bulk
X-No-Archive: yes
List-Id: Zsh Users List <zsh-users.zsh.org>
List-Post: <mailto:zsh-users@zsh.org>
List-Help: <mailto:zsh-users-help@zsh.org>
Delivered-To: mailing list zsh-users@zsh.org
X-Seq: 15630
Received: (qmail 17767 invoked from network); 7 Dec 2010 04:48:02 -0000
X-Spam-Checker-Version: SpamAssassin 3.3.1 (2010-03-16) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-1.9 required=5.0 tests=BAYES_00,RCVD_IN_DNSWL_NONE
	autolearn=ham version=3.3.1
Received-SPF: none (ns1.primenet.com.au: domain at closedmail.com does not designate permitted sender hosts)
From: Bart Schaefer <schaefer@brasslantern.com>
Message-id: <101206204748.ZM2889@torch.brasslantern.com>
Date: Mon, 06 Dec 2010 20:47:48 -0800
In-reply-to: <20101206190255.4B3CA1ED691A@scythe.noid.net>
Comments: In reply to zsh@noid.net
 "multiline ZLE w/ bash-like single line .zsh_history...?" (Dec  6, 11:02am)
References: <20101206190255.4B3CA1ED691A@scythe.noid.net>
X-Mailer: OpenZMail Classic (0.9.2 24April2005)
To: zsh-users@zsh.org
Subject: Re: multiline ZLE w/ bash-like single line .zsh_history...?
MIME-version: 1.0
Content-type: text/plain; charset=us-ascii

On Dec 6, 11:02am, zsh@noid.net wrote:
}
} I like the multiline capability of ZLE, but when history lines are
} appended to the .zsh_history file, I would like for multiline commands
} to be morphed into a single line (similar to what bash does).

In a sufficiently new zsh, there is a zshaddhistory hook function
(like precmd, chpwd, etc.).  You can manipulate the history any way
you like; e.g., the following saves each line of the multiline as a
single line in the history:

    zshaddhistory() { print -sr "${(z)1%%$'\n'}"; return 1 }

(And I finally get another chance to point out to PWS why it's a good
thing that (z) converts newlines into semicolons ... but it also
reveals a bug in the handling of here-documents ... moving that over
to zsh-workers.)  [Bash appears to ignore here-documents entirely?]

As was discussed in a lengthy thread earlier this year, the full multi-
line command "lingers" in the interactive history for one cycle even
if zshaddhistory returns nonzero.

} Is there a way to get zsh to be bash-like when it writes to the
} history file...?  I'm willing to lose the multiline niceness for old
} commands in new shells.

There is not a way to get the interactive history and the history file
to behave differently from one another, except by using more than one
history file (the "fc -p" example for zshaddhistory in the manual).
You could, for example, do

    zshaddhistory() {
      fc -p ${HISTFILE}_bash_format $HISTSIZE $SAVEHIST
      print -sr "${(z)1%%$'\n'}"
      return 0
    }

which would still save in zsh native format in $HISTFILE, but keep a
bash-format copy in a parallel file.

