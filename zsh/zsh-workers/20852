From zsh-workers-return-20852-mason-zsh=primenet.com.au@sunsite.dk Wed Feb 23 11:12:13 2005
Return-Path: <zsh-workers-return-20852-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 16846 invoked from network); 23 Feb 2005 11:12:13 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 23 Feb 2005 11:12:13 -0000
Received: (qmail 28035 invoked from network); 23 Feb 2005 11:12:07 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 23 Feb 2005 11:12:07 -0000
Received: (qmail 3901 invoked by alias); 23 Feb 2005 11:12:01 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 20852
Received: (qmail 3887 invoked from network); 23 Feb 2005 11:12:01 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 23 Feb 2005 11:12:01 -0000
Received: (qmail 27727 invoked from network); 23 Feb 2005 11:12:01 -0000
Received: from morda.newmail.ru (HELO flock1.newmail.ru) (212.48.140.150)
  by a.mx.sunsite.dk with SMTP; 23 Feb 2005 11:11:54 -0000
Received: (qmail 20359 invoked from network); 23 Feb 2005 10:56:52 -0000
Received: from unknown (HELO ?10.0.0.1?) (arvidjaar@newmail.ru@83.237.106.71)
  by smtpd.newmail.ru with SMTP; 23 Feb 2005 10:56:52 -0000
From: Andrey Borzenkov <arvidjaar@newmail.ru>
To: zsh-workers@sunsite.dk
Subject: Re: [PATCH] fix mulibyte input/mbstate_t problem
Date: Wed, 23 Feb 2005 14:11:52 +0300
User-Agent: KMail/1.7.2
References: <200502230020.18269.arvidjaar@newmail.ru> <200502231051.j1NApMb3026282@news01.csr.com>
In-Reply-To: <200502231051.j1NApMb3026282@news01.csr.com>
MIME-Version: 1.0
Content-Type: text/plain;
  charset="utf-8"
Content-Transfer-Encoding: 7bit
Content-Disposition: inline
Message-Id: <200502231411.52678.arvidjaar@newmail.ru>
X-Spam-Checker-Version: SpamAssassin 3.0.2 on a.mx.sunsite.dk
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=6.0 tests=BAYES_00 autolearn=ham 
	version=3.0.2
X-Spam-Hits: -2.6

On Wednesday 23 February 2005 13:51, Peter Stephenson wrote:
> We do probably need to reset the shift state each time zleread() is
> called to get a complete line, however, so the static in getrestchar()
> probably needs to be a global somewhere.
>

Yes, I intend make getrestchar to accept mbstate as parameter at some point.

> Presumably also leaving the mbrtowc in stringaszleline separate, as it
> is at the moment, is also the right thing to do.
>
> > Editing Russian is funny; "echo xxxx" outputs correct text but during
> > line editing display is wrong (it counts every UTF-8 as 2 screen
> > characters).
>
> If it works otherwise, e.g. the cursor moves over the right number of
> characters (but not screen columns), I guess that's something in
> zle_refresh.c.  We're not using wcwidth, yet, but it doesn't sound like
> that's the problem since it should assume a single column per character.
>

I am rewriting it to use wide char. the problem was that cursor position was 
assumed equal to string position which was wrong for multibyte characters. 
Having refresh to deal consistently with wide chars simplifies everthing a 
lot.

it still does not wcwidth, currently everything is assumed to be exactly 1 
char.

