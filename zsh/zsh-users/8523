From zsh-users-return-8523-mason-zsh=primenet.com.au@sunsite.dk Fri Feb 18 15:28:19 2005
Return-Path: <zsh-users-return-8523-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 469 invoked from network); 18 Feb 2005 15:28:18 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 18 Feb 2005 15:28:18 -0000
Received: (qmail 67233 invoked from network); 18 Feb 2005 15:28:12 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 18 Feb 2005 15:28:12 -0000
Received: (qmail 6670 invoked by alias); 18 Feb 2005 15:28:03 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 8523
Received: (qmail 6654 invoked from network); 18 Feb 2005 15:28:01 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 18 Feb 2005 15:28:01 -0000
Received: (qmail 66120 invoked from network); 18 Feb 2005 15:28:01 -0000
Received: from ms-smtp-04.texas.rr.com (24.93.47.43)
  by a.mx.sunsite.dk with SMTP; 18 Feb 2005 15:27:51 -0000
Received: from amdxp.kalama.no-ip.org (cpe-66-68-88-186.austin.res.rr.com [66.68.88.186])
	by ms-smtp-04.texas.rr.com (8.12.10/8.12.7) with ESMTP id j1IFRiU5010999;
	Fri, 18 Feb 2005 09:27:45 -0600 (CST)
Received: from [10.0.1.100] (cpe-66-68-88-186.austin.res.rr.com [66.68.88.186])
	by amdxp.kalama.no-ip.org (Postfix) with ESMTP id AF29340D;
	Fri, 18 Feb 2005 08:22:29 -0600 (CST)
In-Reply-To: <625fad5460dfb26c51c4ddd080945bf5@h8.dion.ne.jp>
References: <bb57a9a834f9731d92eac69b1260728e@kalama.no-ip.org> <625fad5460dfb26c51c4ddd080945bf5@h8.dion.ne.jp>
Mime-Version: 1.0 (Apple Message framework v619.2)
Content-Type: text/plain; charset=US-ASCII; format=flowed
Message-Id: <acec59dc93c90ed9cf5a49508a872da2@kalama.no-ip.org>
Content-Transfer-Encoding: 7bit
Cc: zsh-users@sunsite.dk
Reply-To: zsh-users@sunsite.dk
From: lists <lists@kalama.no-ip.org>
Subject: Re: Darwin _defaults completion bug
Date: Fri, 18 Feb 2005 08:22:31 -0600
To: Motoi Washida <a66@h8.dion.ne.jp>
X-Mailer: Apple Mail (2.619.2)
X-Virus-Scanned: Symantec AntiVirus Scan Engine
X-Spam-Checker-Version: SpamAssassin 3.0.2 on a.mx.sunsite.dk
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=6.0 tests=AWL,BAYES_00 autolearn=ham 
	version=3.0.2
X-Spam-Hits: -2.5

Hi Motoi,
	That works great.  Thanks again for your contributions to the OS X zsh 
community!

-Ryan
On Feb 18, 2005, at 12:55 AM, Motoi Washida wrote:

> Hi Ryan,
>
>> 	I think I've found a small bug with your _defaults completion (which 
>> I use all the time).  If I type 'defaults read -g' then hit the Tab 
>> key, I see a list of possible completions which are quoted *and* 
>> escaped with a backslash.
> (...snip...)
>> ...et cetera, et cetera.  The command doesn't work in the escaped + 
>> quoted form.  If just the quotes are used, the command works.  I've 
>> looked at _defaults but haven't been able to figure out where the 
>> escapes are being inserted.  If you get a chance, could you take a 
>> look?
> Thanks! This occurred because the completion did not handle quoted key 
> name "defaults read" prints. Here is a patch to remove quotes.
>
> --
> Motoi Washida
>
> Index: Completion/Darwin/Command/_defaults
> ===================================================================
> RCS file: /cvsroot/zsh/zsh/Completion/Darwin/Command/_defaults,v
> retrieving revision 1.2
> diff -d -u -r1.2 _defaults
> --- Completion/Darwin/Command/_defaults	17 Jan 2005 09:39:21 -0000	1.2
> +++ Completion/Darwin/Command/_defaults	18 Feb 2005 06:24:58 -0000
> @@ -14,9 +14,10 @@
>  }
>
>  _defaults_keys(){
> -  local ks="$(_call_program keys defaults read "$words[2]" 
> 2>/dev/null | sed '/^    [[:alpha:]"]/ { s/^    //; s/ = .*$//; p;}; 
> d')"
> +  local ks
> +  ks=(${${${${(M)${(f)"$(defaults read "$words[2]" 2>/dev/null)"}:#   
>  [^ ]*=*}#    }%% = *}:Q})
>    local expl
> -  _wanted keys expl 'key' compadd ${(f)ks}
> +  _wanted keys expl 'key' compadd "$ks[@]"
>  }
>
>  _defaults(){
>

