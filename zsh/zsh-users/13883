From zsh-users-return-13883-mason-zsh=primenet.com.au@sunsite.dk Thu Mar 05 16:54:56 2009
Return-Path: <zsh-users-return-13883-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 5574 invoked from network); 5 Mar 2009 16:54:44 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-1.7 required=5.0 tests=AWL,BAYES_00,MISSING_HEADERS
	autolearn=no version=3.2.5
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 5 Mar 2009 16:54:44 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 62546 invoked from network); 5 Mar 2009 16:54:32 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 5 Mar 2009 16:54:32 -0000
Received: (qmail 16118 invoked by alias); 5 Mar 2009 16:54:16 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 13883
Received: (qmail 16102 invoked from network); 5 Mar 2009 16:54:15 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 5 Mar 2009 16:54:15 -0000
Received: from cluster-g.mailcontrol.com (cluster-g.mailcontrol.com [208.87.233.190])
	by bifrost.dotsrc.org (Postfix) with ESMTPS id EA6CB80307F8
	for <zsh-users@sunsite.dk>; Thu,  5 Mar 2009 17:54:12 +0100 (CET)
Received: from cameurexb01.EUROPE.ROOT.PRI ([193.128.72.68])
	by rly30g.srv.mailcontrol.com (MailControl) with ESMTP id n25Gs8Nj015366
	for <zsh-users@sunsite.dk>; Thu, 5 Mar 2009 16:54:09 GMT
Received: from news01 ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.3959);
	 Thu, 5 Mar 2009 16:54:00 +0000
Date: Thu, 5 Mar 2009 16:54:00 +0000
From: Peter Stephenson <pws@csr.com>
Cc: zsh-users@sunsite.dk
Subject: Re: expansion of environment variables
Message-ID: <20090305165400.3fd18bc6@news01>
In-Reply-To: <090305081548.ZM4603@torch.brasslantern.com>
References: <d5baa8100903050235ofd66039jf2c29b58684bc8d8@mail.gmail.com>
	<090305081548.ZM4603@torch.brasslantern.com>
Organization: CSR
X-Mailer: Claws Mail 3.5.0 (GTK+ 2.12.8; i386-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
X-OriginalArrivalTime: 05 Mar 2009 16:54:00.0919 (UTC) FILETIME=[FBB0FE70:01C99DB2]
X-Scanned-By: MailControl A_08_51_00 (www.mailcontrol.com) on 10.71.0.140
X-Virus-Scanned: ClamAV 0.92.1/9074/Thu Mar  5 16:21:02 2009 on bifrost
X-Virus-Status: Clean

On Thu, 05 Mar 2009 08:15:48 -0800
Bart Schaefer <schaefer@brasslantern.com> wrote:

(re

% touch stuff.txt
% foo=stuff
% echo $foo.<TAB>

etc.)

> Worse, if I enable the new completion system with 'compinit' then the
> variable doesn't expand but the completion doesn't work.  I mention
> this because with the new completion system enabled, the 'suffix'
> zstyle is supposed to control exactly what Ruud is asking about, and
> the default is to have the "old" behavior that he wants.
>  
> For benefit of zsh-workers, with compinit this is yet another problem
> in _path_files.  At line 479 (latest CVS) it correctly assigns the
> expanded list of files to the tmp2 array (having originally gotten
> them from "compadd -D tmp1" at line 466), but then when building the
> exppaths array at lines 484 or 486, it uses ${tpre}${tsuf} which have
> never been expanded.

That's too late---it's failed at that point.  See the comment above that
section.  We're in the code that triggers where compfiles (the builtin that
handles the globbing) didn't produce any matches so $#tmp1 is empty.  I
think it's just attempting to expand what it thinks is a plain string chunk
of path, so that things like $foo/<TAB> work.

> I'm also not sure how line 484 can ever be reached, since at 479
> "${(@)tmp2:h}" is always going to strip off any trailing slash.

I don't know about this...

> It
> seems a bit strange to compare an entire array to a single pattern
> at line 483 as well, but I guess it works since the last element of
> the array should be representative of any single element.

...but I think this is related to the fact that we don't have any glob
matches, just a chunk of path that may want something doing to it.

It looks to me like this is a basic problem that's hard to fix: you'd need
an eval'd version of the prefix and suffix to do the globbing on, and then
you'd need to be able to put the expanded bits of it back the way they were
at the end.  In general the only way of doing this would be to expand and
save each variable reference, command expansion, numeric expansion, etc.,
separately.

I suspect, by the way, that the original query was about the old builtin
completion, not the function system.

-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070

