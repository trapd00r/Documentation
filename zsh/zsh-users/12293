From zsh-users-return-12293-mason-zsh=primenet.com.au@sunsite.dk Wed Dec 05 10:04:22 2007
Return-Path: <zsh-users-return-12293-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 25036 invoked from network); 5 Dec 2007 10:04:14 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.3 (2007-08-08) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.3
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 5 Dec 2007 10:04:14 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 96942 invoked from network); 5 Dec 2007 10:04:06 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 5 Dec 2007 10:04:06 -0000
Received: (qmail 6097 invoked by alias); 5 Dec 2007 10:03:48 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 12293
Received: (qmail 6082 invoked from network); 5 Dec 2007 10:03:47 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 5 Dec 2007 10:03:47 -0000
Received: (qmail 95551 invoked from network); 5 Dec 2007 10:03:47 -0000
Received: from cluster-d.mailcontrol.com (217.69.20.190)
  by a.mx.sunsite.dk with SMTP; 5 Dec 2007 10:03:41 -0000
Received: from cameurexb01.EUROPE.ROOT.PRI ([62.189.241.200])
	by rly25d.srv.mailcontrol.com (MailControl) with ESMTP id lB5A3buh021998
	for <zsh-users@sunsite.dk>; Wed, 5 Dec 2007 10:03:40 GMT
Received: from news01 ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.1830);
	 Wed, 5 Dec 2007 10:03:36 +0000
Date: Wed, 5 Dec 2007 10:03:36 +0000
From: Peter Stephenson <pws@csr.com>
To: zsh-users@sunsite.dk
Subject: Re: getopts / OPTIND / shift : inconsistent behavior
Message-ID: <20071205100336.2ddf860a@news01>
In-Reply-To: <200712051608.26752.ps@pacesie.name>
References: <200712051608.26752.ps@pacesie.name>
Organization: CSR
X-Mailer: Claws Mail 3.0.2 (GTK+ 2.10.14; i386-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: quoted-printable
X-OriginalArrivalTime: 05 Dec 2007 10:03:36.0891 (UTC) FILETIME=[1A4280B0:01C83726]
X-Scanned-By: MailControl A-06-00-00 (www.mailcontrol.com) on 10.68.0.135

On Wed, 5 Dec 2007 16:08:26 +1100
"=E8=AC=9D=E6=AD=A5=E9=81=99 Sie, Bu Yau" <ps@pacesie.name> wrote:
> Hi,
>=20
> With zsh 4.3.4 the OPTIND incremental bebavior is inconsistent for option=
s=20
> with argument and without argument. For option with argument, OPTIND poin=
ts=20
> to next argument, while for option without argument it points to current=
=20
> argument.
>=20
> func() {
> getopts a:b optvar
> shift $(( OPTIND -1 ))
> echo "$OPTIND, $1"
> }
>=20
> func -a x y z
> output: 3, y
>=20
> func -b x y z
> output: 1, -b
>=20
> Is this a bug? There is no consistent way to do "shift" as such.

You can make it consistent by making sure you've got to the end of the
option list before looking at the arguments:

func () {
        while getopts a:b optvar; do :; done
        shift $(( OPTIND -1 ))
        echo "$OPTIND, $1"
}

This is the way you'd normally use it:  you don't know how many options
there are, if any, until getopts returns 1.

However, it's still a bit fishy.  The internal option index handling logic
has always been a bit curious; I've lost count of the number of bugs we've
had in it.

--=20
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070

