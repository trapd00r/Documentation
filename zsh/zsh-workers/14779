From zsh-workers-return-14779-mason-zsh=primenet.com.au@sunsite.dk Wed Jun 06 20:46:39 2001
Return-Path: <zsh-workers-return-14779-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 20132 invoked from network); 6 Jun 2001 20:46:38 -0000
Received: from sunsite.dk (130.225.51.30)
  by ns1.primenet.com.au with SMTP; 6 Jun 2001 20:46:38 -0000
Received: (qmail 4816 invoked by alias); 6 Jun 2001 20:46:20 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 14779
Received: (qmail 4803 invoked from network); 6 Jun 2001 20:46:20 -0000
Message-ID: <3B1E9726.1090202@mail.ru>
Date: Thu, 07 Jun 2001 00:48:38 +0400
From: Andrej Borsenkow <arvidjaar@mail.ru>
Reply-To: Andrej.Borsenkow@mow.siemens.ru
User-Agent: Mozilla/5.0 (X11; U; Linux 2.4.5-3mdk i686; en-US; rv:0.9) Gecko/20010605
X-Accept-Language: en
MIME-Version: 1.0
To: Chmouel Boudjnah <chmouel@mandrakesoft.com>
CC: cooker@linux-mandrake.com,
	ZSH Workers Mailing List <zsh-workers@sunsite.dk>
Subject: Re: [Cooker] /bin/login from util-linux-2.11c-2mdk  breaks zsh ctty hadling
References: <3B0BF59E.6030408@mow.siemens.ru>	<m3n183su14.fsf@giants.mandrakesoft.com> <3B110A3F.4020802@mail.ru> <m3zoblcz1w.fsf@giants.mandrakesoft.com>
Content-Type: text/plain; charset=us-ascii; format=flowed
Content-Transfer-Encoding: 7bit

Chmouel Boudjnah wrote:

 > Andrej Borsenkow <arvidjaar@mail.ru> writes:
 >
 >
 >>O.K., I have found why it happens. Here goes.
 >>
 >
 > ok fixed in latest util-linux of cooker..
 >
 >

No, sorry. It now tries to open /dev/tty but in wrong place - in parent,
not in child.

(ttypts/2)% rpm -q util-linux
util-linux-2.11d-1mdk
1166  read(0, "b", 1)                   = 1
1166  read(0, "o", 1)                   = 1
1166  read(0, "r", 1)                   = 1
1166  read(0, "\n", 1)                  = 1
1166  execve("/bin/login", ["/bin/login", "--", "bor"], [/* 8 vars */]) = 0
...
1166  setsid()                          = -1 EPERM (Operation not permitted)
1166  open("/dev/tty3", O_RDWR|O_NONBLOCK|O_LARGEFILE) = 3
        ^^^^^^^^^^^^^^^^ useless here because ...
...
1166  fork()                            = 2397
2397  setsid()                          = 2397
        ^^^^^^^^ ... Oops!
2397  rt_sigaction(SIGHUP, {SIG_DFL}, {SIG_IGN}, 8) = 0
2397  rt_sigaction(SIGINT, {SIG_DFL}, {SIG_IGN}, 8) = 0
2397  msgget(501, 0x2|02)               = 0
2397  chdir("/home/bor")                = 0
2397  execve("/bin/zsh", ["-zsh"], [/* 6 vars */]) = 0


The same applies - setsid() in child resets ctty.

-andrej


