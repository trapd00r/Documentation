From zsh-users-return-14732-mason-zsh=primenet.com.au@zsh.org Fri Jan 22 20:35:48 2010
Return-Path: <zsh-users-return-14732-mason-zsh=primenet.com.au@zsh.org>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 15929 invoked by alias); 22 Jan 2010 20:35:48 -0000
Mailing-List: contact zsh-users-help@zsh.org; run by ezmlm
Precedence: bulk
X-No-Archive: yes
List-Id: Zsh Users List <zsh-users.zsh.org>
List-Post: <mailto:zsh-users@zsh.org>
List-Help: <mailto:zsh-users-help@zsh.org>
Delivered-To: mailing list zsh-users@zsh.org
X-Seq: 14732
Received: (qmail 18084 invoked from network); 22 Jan 2010 20:35:45 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received-SPF: pass (ns1.primenet.com.au: SPF record at ntlworld.com designates 81.103.221.47 as permitted sender)
Date: Fri, 22 Jan 2010 20:35:36 +0000
From: Peter Stephenson <p.w.stephenson@ntlworld.com>
To: zsh-users@zsh.org
Subject: Re: Completion of mixed-style paths still doesn't work under Cygwin
 with 4.3.10-dev-1
Message-ID: <20100122203536.566182a2@pws-pc>
In-Reply-To: <20100113102554.6a2a5fee@news01>
References: <E1NUJk8-0007ma-Tg@smtp.tt-solutions.com>
	<20100112180813.17a3c910@news01>
	<E1NUnip-0004ww-QB@smtp.tt-solutions.com>
	<20100113102554.6a2a5fee@news01>
X-Mailer: Claws Mail 3.7.4 (GTK+ 2.16.6; x86_64-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
X-Cloudmark-Analysis: v=1.1 cv=W3tOLUehizD4qj6VhtReFuw5MKb8d+XqjIxlDsIazEA= c=1 sm=0 a=U0owGppL8fEA:10 a=4UtWO5riAAAA:8 a=TQOtqVQjAAAA:8 a=NLZqzBF-AAAA:8 a=sDQXhAvmxR7CPRYIF2cA:9 a=r4lavTcVDZv9_h7eRawA:7 a=cScB76K46obsyORVSsWxcAzZlgUA:4 a=Shd8Sdw-9eQA:10 a=0j81fFen44IA:10 a=_dQi-Dcv4p4A:10 a=HpAAvcLHHh0Zw7uRqdWCyQ==:117

On Wed, 13 Jan 2010 10:25:54 +0000
Peter Stephenson <pws@csr.com> wrote:
> On Tue, 12 Jan 2010 21:52:10 +0100
> Vadim Zeitlin <vz-zsh@zeitlins.org> wrote:
>> [completing after c:/ doesn't work sometimes]
>
>> I built zsh using "--enable-pcre --enable-multibyte" under Cygwin 1.7.1.
>> Should I have used different configure options? Or maybe it's 1.7-specific?

It does appear to be a new feature which is easy enough to work around.
It looks like "c:" is no longer regarded as a directory while "c:/"
still is (try it with [[ -d c: ]] if you want to play along at home).
This may be part of the attempt to make Windows special characters less
special.

I've now escaped back to Linux: here's a patch that seemed to work,
except I've only just realised that I'd better limit the slash-appending
to single-letter drives---someone may know better---so that isn't
tested.  We stick the "/" back for the purpose of testing the directory,
but only for that purpose (the completion system will get a bit confused
if we append directories willy nilly).

I presume this still works in earlier versions of Cygwin.

Index: Src/Zle/computil.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/computil.c,v
retrieving revision 1.117
diff -u -r1.117 computil.c
--- Src/Zle/computil.c	21 Nov 2009 06:51:14 -0000	1.117
+++ Src/Zle/computil.c	22 Jan 2010 20:32:48 -0000
@@ -4050,19 +4050,44 @@
     for (node = firstnode(names); node; incnode(node)) {
 	l = strlen(p = (char *) getdata(node));
 	if (l + sl < PATH_MAX2) {
+#ifdef __CYGWIN__
+	    char *testbuf;
+#define TESTBUF testbuf
+#else
+#define TESTBUF buf
+#endif
 	    strcpy(buf, p);
 	    strcpy(buf + l, suf);
 #ifdef __CYGWIN__
-	    /*
-	     * If accept-exact is not set, accept this only if
-	     * it looks like a special file such as a drive.
-	     * We still test if it exists.
-	     */
-	    if (accept_off &&
-		(strchr(buf, '/') || buf[strlen(buf)-1] != ':'))
-		continue;
+	    if (accept_off) {
+		int sl = strlen(buf);
+		/*
+		 * If accept-exact is not set, accept this only if
+		 * it looks like a special file such as a drive.
+		 * We still test if it exists.
+		 */
+		if (!sl || strchr(buf, '/') || buf[sl-1] != ':')
+		    continue;
+		if (sl == 2) {
+		    /*
+		     * Recent versions of Cygwin only recognise "c:/",
+		     * but not "c:", as special directories.  So
+		     * we have to append the slash for the purpose of
+		     * the test.
+		     */
+		    testbuf = zhalloc(sl + 2);
+		    strcpy(testbuf, buf);
+		    testbuf[sl] = '/';
+		    testbuf[sl+1] = '\0';
+		} else {
+		    /* Don't do this with stuff like PRN: */
+		    testbuf = buf;
+		}
+	    } else {
+		testbuf = buf;
+	    }
 #endif
-	    if (!ztat(buf, &st, 0)) {
+	    if (!ztat(TESTBUF, &st, 0)) {
 		/*
 		 * File exists; if accept-exact contained non-boolean
 		 * values it must match those, too.



-- 
Peter Stephenson <p.w.stephenson@ntlworld.com>
Web page now at http://homepage.ntlworld.com/p.w.stephenson/

