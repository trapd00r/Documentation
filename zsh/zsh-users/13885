From zsh-users-return-13885-mason-zsh=primenet.com.au@sunsite.dk Thu Mar 05 17:22:10 2009
Return-Path: <zsh-users-return-13885-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 25083 invoked from network); 5 Mar 2009 17:22:07 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 5 Mar 2009 17:22:07 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 73538 invoked from network); 5 Mar 2009 17:21:57 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 5 Mar 2009 17:21:57 -0000
Received: (qmail 29550 invoked by alias); 5 Mar 2009 17:21:40 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 13885
Received: (qmail 29541 invoked from network); 5 Mar 2009 17:21:40 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 5 Mar 2009 17:21:40 -0000
Received: from vms173007pub.verizon.net (vms173007pub.verizon.net [206.46.173.7])
	by bifrost.dotsrc.org (Postfix) with ESMTP id B6A1B80307F7
	for <zsh-users@sunsite.dk>; Thu,  5 Mar 2009 18:21:36 +0100 (CET)
Received: from torch.brasslantern.com ([173.67.122.60])
 by vms173007.mailsrvcs.net
 (Sun Java(tm) System Messaging Server 6.3-7.04 (built Sep 26 2008; 32bit))
 with ESMTPA id <0KG100C4BMVRMMRW@vms173007.mailsrvcs.net> for
 zsh-users@sunsite.dk; Thu, 05 Mar 2009 11:21:33 -0600 (CST)
Received: from torch.brasslantern.com (localhost.localdomain [127.0.0.1])
	by torch.brasslantern.com (8.13.1/8.13.1) with ESMTP id n25HLQcj004729	for
 <zsh-users@sunsite.dk>; Thu, 05 Mar 2009 09:21:27 -0800
Received: (from schaefer@localhost)	by torch.brasslantern.com
 (8.13.1/8.13.1/Submit) id n25HLQbT004728	for zsh-users@sunsite.dk; Thu,
 05 Mar 2009 09:21:26 -0800
From: Bart Schaefer <schaefer@brasslantern.com>
Message-id: <090305092126.ZM4727@torch.brasslantern.com>
Date: Thu, 05 Mar 2009 09:21:26 -0800
In-reply-to: <20090305165400.3fd18bc6@news01>
Comments: In reply to Peter Stephenson <pws@csr.com>
 "Re: expansion of environment variables" (Mar  5,  4:54pm)
References: <d5baa8100903050235ofd66039jf2c29b58684bc8d8@mail.gmail.com>
	<090305081548.ZM4603@torch.brasslantern.com>	<20090305165400.3fd18bc6@news01>
X-Mailer: OpenZMail Classic (0.9.2 24April2005)
To: zsh-users@sunsite.dk
Subject: Re: expansion of environment variables
MIME-version: 1.0
Content-type: text/plain; charset=us-ascii
X-Virus-Scanned: ClamAV 0.92.1/9074/Thu Mar  5 16:21:02 2009 on bifrost
X-Virus-Status: Clean

On Mar 5,  4:54pm, Peter Stephenson wrote:
}
} > For benefit of zsh-workers, with compinit this is yet another problem
} > in _path_files.  At line 479 (latest CVS) it correctly assigns the
} > expanded list of files to the tmp2 array (having originally gotten
} > them from "compadd -D tmp1" at line 466), but then when building the
} > exppaths array at lines 484 or 486, it uses ${tpre}${tsuf} which have
} > never been expanded.
} 
} That's too late---it's failed at that point.  See the comment above that
} section.  We're in the code that triggers where compfiles (the builtin that
} handles the globbing) didn't produce any matches so $#tmp1 is empty.

Hmm, I misread something, but I think you did as well.

The call to "compfiles -p" at line 418 is what fills in tmp1.  It DOES
find matching files, because at line 466 we save tmp1 in tmp2 and at
that point tmp1 is the expanded list.  Then at 467 we call compadd -D
passing only the tails of what was expanded in commpfiles, and compadd
empties tmp1 again.

So I suspect this is more of the same foolishness that forced us to add
$Uopt a bit ago, but manifesting in a different way.  Or maybe we need
to pass some prefix options to compadd at that point?

} I suspect, by the way, that the original query was about the old builtin
} completion, not the function system.

Yes, I know.  I meant to say "the expand-word and complete-word builtin
widgets" in the first paragraph of my first reply, but thinko'd.

