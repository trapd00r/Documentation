From zsh-workers-return-20708-mason-zsh=primenet.com.au@sunsite.dk Thu Jan 13 15:15:23 2005
Return-Path: <zsh-workers-return-20708-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 5158 invoked from network); 13 Jan 2005 15:15:20 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 13 Jan 2005 15:15:20 -0000
Received: (qmail 74851 invoked from network); 13 Jan 2005 15:15:03 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 13 Jan 2005 15:15:03 -0000
Received: (qmail 6742 invoked by alias); 13 Jan 2005 15:14:59 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 20708
Received: (qmail 6718 invoked from network); 13 Jan 2005 15:14:58 -0000
Received: from unknown (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 13 Jan 2005 15:14:58 -0000
Received: (qmail 74136 invoked from network); 13 Jan 2005 15:13:59 -0000
Received: from mailhost1.csr.com (HELO MAILSWEEPER01.csr.com) (81.105.217.43)
  by a.mx.sunsite.dk with SMTP; 13 Jan 2005 15:13:56 -0000
Received: from exchange03.csr.com (unverified [10.100.137.60]) by MAILSWEEPER01.csr.com
 (Content Technologies SMTPRS 4.3.12) with ESMTP id <T6e790ad5e40a6c8d012dc@MAILSWEEPER01.csr.com> for <zsh-workers@sunsite.dk>;
 Thu, 13 Jan 2005 15:12:35 +0000
Received: from news01.csr.com ([10.103.143.38]) by exchange03.csr.com with Microsoft SMTPSVC(5.0.2195.6713);
	 Thu, 13 Jan 2005 15:16:12 +0000
Received: from news01.csr.com (localhost.localdomain [127.0.0.1])
	by news01.csr.com (8.13.1/8.12.11) with ESMTP id j0DFDsYY032169
	for <zsh-workers@sunsite.dk>; Thu, 13 Jan 2005 15:13:54 GMT
Received: from csr.com (pws@localhost)
	by news01.csr.com (8.13.1/8.13.1/Submit) with ESMTP id j0DFDs8H032165
	for <zsh-workers@sunsite.dk>; Thu, 13 Jan 2005 15:13:54 GMT
Message-Id: <200501131513.j0DFDs8H032165@news01.csr.com>
X-Authentication-Warning: news01.csr.com: pws owned process doing -bs
To: zsh-workers@sunsite.dk (Zsh hackers list)
Subject: PATCH: replace-string enhancement
Date: Thu, 13 Jan 2005 15:13:53 +0000
From: Peter Stephenson <pws@csr.com>
X-OriginalArrivalTime: 13 Jan 2005 15:16:12.0356 (UTC) FILETIME=[D12B5840:01C4F982]
X-Spam-Checker-Version: SpamAssassin 2.63 on a.mx.sunsite.dk
X-Spam-Level: 
X-Spam-Status: No, hits=0.0 required=6.0 tests=none autolearn=no version=2.63
X-Spam-Hits: 0.0

This allows the replace-string widget to offer you the previous strings
used for editing.  This is off by default.  There's a style to turn
it on, plus you can use numeric arguments.  (I changed my mind about the
default at the last minute.)

I had a brief go at trying to maintain a separate history for the
strings, but it seems to be rather tricky since replace-string works by
manipulating the current history line.  Hence the usual assumptions
about adding new lines are invalid.  So I haven't changed it.

Index: Functions/Zle/replace-string
===================================================================
RCS file: /cvsroot/zsh/zsh/Functions/Zle/replace-string,v
retrieving revision 1.1
diff -u -r1.1 replace-string
--- Functions/Zle/replace-string	3 Feb 2003 11:06:03 -0000	1.1
+++ Functions/Zle/replace-string	13 Jan 2005 15:10:43 -0000
@@ -4,14 +4,21 @@
 autoload read-from-minibuffer
 
 local p1="Replace: " p2="   with: "
-local src rep REPLY MATCH MBEGIN MEND curwidget=$WIDGET
+local REPLY MATCH MBEGIN MEND curwidget=$WIDGET previous
 local -a match mbegin mend
 
-read-from-minibuffer $p1 || return 1
-src=$REPLY
+if (( ${+NUMERIC} )); then
+  (( $NUMERIC > 0 )) && previous=1
+else
+  zstyle -t ":zle:$WIDGET" edit-previous && previous=1
+fi
+
+read-from-minibuffer $p1 ${previous:+$_replace_string_src} || return 1
+_replace_string_src=$REPLY
 
-read-from-minibuffer "$p1$src$p2" || return 1
-rep=$REPLY
+read-from-minibuffer "$p1$_replace_string_src$p2" \
+  ${previous:+$_replace_string_rep} || return 1
+_replace_string_rep=$REPLY
 
 if [[ $curwidget = *pattern* ]]; then
     local rep2
@@ -20,6 +27,7 @@
     # while preceded by an odd number of backslashes is inactive,
     # with one backslash being stripped.  A similar logic applies
     # to \digit.
+    local rep=$_replace_string_rep
     while [[ $rep = (#b)([^\\]#)(\\\\)#(\\|)(\&|\\<->|\\\{<->\})(*) ]]; do
 	if [[ -n $match[3] ]]; then
 	    # Expression is quoted, strip quotes
@@ -37,9 +45,9 @@
 	rep=${match[5]}
     done
     rep2+=$rep
-    LBUFFER=${LBUFFER//(#bm)$~src/${(e)rep2}}
-    RBUFFER=${RBUFFER//(#bm)$~src/${(e)rep2}}
+    LBUFFER=${LBUFFER//(#bm)$~_replace_string_src/${(e)rep2}}
+    RBUFFER=${RBUFFER//(#bm)$~_replace_string_src/${(e)rep2}}
 else
-    LBUFFER=${LBUFFER//$src/$rep}
-    RBUFFER=${RBUFFER//$src/$rep}
+    LBUFFER=${LBUFFER//$_replace_string_src/$_replace_string_rep}
+    RBUFFER=${RBUFFER//$_replace_string_src/$_replace_string_rep}
 fi
Index: Doc/Zsh/contrib.yo
===================================================================
RCS file: /cvsroot/zsh/zsh/Doc/Zsh/contrib.yo,v
retrieving revision 1.38
diff -u -r1.38 contrib.yo
--- Doc/Zsh/contrib.yo	9 Dec 2004 14:44:46 -0000	1.38
+++ Doc/Zsh/contrib.yo	13 Jan 2005 15:10:44 -0000
@@ -814,6 +814,13 @@
 `tt(\{)var(N)tt(})' may be used to protect the digit from following
 digits.
 
+By default the previous source or replacement string will not be offered
+for editing.  However, this feature can be activated by setting the style
+tt(edit-previous) in the context tt(:zle:)var(widget) (for example,
+tt(:zle:replace-string)) to tt(true).  In addition, a positive
+numeric argument forces the previous values to be offered, a negative or
+zero argument forces them not to be.
+
 For example, starting from the line:
 
 example(print This line contains fan and fond)

-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070


**********************************************************************
This email and any files transmitted with it are confidential and
intended solely for the use of the individual or entity to whom they
are addressed. If you have received this email in error please notify
the system manager.

This footnote also confirms that this email message has been swept by
MIMEsweeper for the presence of computer viruses.

www.mimesweeper.com
**********************************************************************

