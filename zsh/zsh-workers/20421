From zsh-workers-return-20421-mason-zsh=primenet.com.au@sunsite.dk Thu Sep 30 07:59:54 2004
Return-Path: <zsh-workers-return-20421-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 28557 invoked from network); 30 Sep 2004 07:59:53 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 30 Sep 2004 07:59:53 -0000
Received: (qmail 66347 invoked from network); 30 Sep 2004 07:59:47 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 30 Sep 2004 07:59:47 -0000
Received: (qmail 7317 invoked by alias); 30 Sep 2004 07:59:35 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 20421
Received: (qmail 7302 invoked from network); 30 Sep 2004 07:59:34 -0000
Received: from unknown (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 30 Sep 2004 07:59:34 -0000
Received: (qmail 65801 invoked from network); 30 Sep 2004 07:58:35 -0000
Received: from dsl3-63-249-88-2.cruzio.com (HELO binome.blorf.net) (63.249.88.2)
  by a.mx.sunsite.dk with SMTP; 30 Sep 2004 07:58:34 -0000
Received: by binome.blorf.net (Postfix, from userid 1000)
	id F0FB46AD; Thu, 30 Sep 2004 00:58:32 -0700 (PDT)
Date: Thu, 30 Sep 2004 00:58:32 -0700
From: Wayne Davison <wayned@users.sourceforge.net>
To: zsh-workers@sunsite.dk
Subject: Re: histroy file being truncated (konsole with multiple shells context)
Message-ID: <20040930075832.GA9664@blorf.net>
References: <1088937610.4949.41.camel@marvin.localdomain> <20040929230327.GC7866@blorf.net> <Pine.LNX.4.61.0409292125140.3955@toltec.zanshin.com>
Mime-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <Pine.LNX.4.61.0409292125140.3955@toltec.zanshin.com>
User-Agent: Mutt/1.5.6+20040722i
X-Spam-Checker-Version: SpamAssassin 2.63 on a.mx.sunsite.dk
X-Spam-Level: 
X-Spam-Status: No, hits=0.0 required=6.0 tests=none autolearn=no version=2.63
X-Spam-Hits: 0.0

On Wed, Sep 29, 2004 at 09:39:24PM -0700, Bart Schaefer wrote:
> On Wed, 29 Sep 2004, Wayne Davison wrote:
> > Updating a .new file and then moving it into place would be a safer
> > way to ensure that the history file never gets truncated.
> 
> On the other hand, in that case the changes get lost entirely, which
> might be just as confusing.

I meant that the rewrite would use the .new file after the original
history file got the appended history lines written onto the end of it.
Thus, for people who use one of the history-appending options, they
wouldn't see any loss of history unless the shell didn't even have time
to append its history.  How the shell would work if no history appending
is enabled is an interesting question -- I tend to think that since only
one shell's history "wins", that it doesn't matter if the shell's
history gets lost due to another shell overwriting its file or if it
gets lost due to not having enough time to finish its history update
(assuming that multiple zshs are all shutting down at the same time).

> So a signal in the middle of that rewrite would still be an issue,
> even if we change the exit-time behavior.

Yes, but that's a manageable case since only one zsh is in the middle of
rewriting the file instead of all "N" zsh's that received a kill signal
frantically trying to rewrite the history file before they get killed by
a follow-up signal.

So, I think the change in signal handling to avoid a cleanup rewrite of
the history file on reception of a death signal is probably the best
first step to pursue.  After that, the decision to use a .new file or
not would probably not make much of a difference in actual practice.

..wayne..

