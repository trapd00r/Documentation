From zsh-workers-return-20208-mason-zsh=primenet.com.au@sunsite.dk Wed Jul 28 01:49:27 2004
Return-Path: <zsh-workers-return-20208-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 19572 invoked from network); 28 Jul 2004 01:49:26 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 28 Jul 2004 01:49:26 -0000
Received: (qmail 54411 invoked from network); 28 Jul 2004 01:49:19 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 28 Jul 2004 01:49:19 -0000
Received: (qmail 13036 invoked by alias); 28 Jul 2004 01:49:08 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 20208
Received: (qmail 13026 invoked from network); 28 Jul 2004 01:49:08 -0000
Received: from unknown (HELO a.mx.sunsite.dk) (130.225.247.88)
  by 130.225.247.90 with SMTP; 28 Jul 2004 01:49:08 -0000
Received: (qmail 72821 invoked from network); 27 Jul 2004 21:45:00 -0000
Received: from unknown (HELO mailsweeperjp.CSR.COM) (202.214.225.228)
  by a.mx.sunsite.dk with SMTP; 27 Jul 2004 21:44:58 -0000
Received: from exchangejp.csr.com (unverified) by mailsweeperjp.CSR.COM
 (Content Technologies SMTPRS 4.3.1) with ESMTP id <T6b0acd095dc0a8790141c@mailsweeperjp.CSR.COM>;
 Tue, 27 Jul 2004 02:18:30 +0900
Received: from EXCHANGE02.csr.com ([192.168.137.45]) by exchangejp.csr.com with Microsoft SMTPSVC(5.0.2195.6713);
	 Mon, 26 Jul 2004 18:16:24 +0100
Received: from news01.csr.com ([192.168.143.38]) by EXCHANGE02.csr.com with Microsoft SMTPSVC(5.0.2195.6713);
	 Mon, 26 Jul 2004 18:16:20 +0100
Received: from news01.csr.com (localhost.localdomain [127.0.0.1])
	by news01.csr.com (8.12.11/8.12.11) with ESMTP id i6QHEV8C012598;
	Mon, 26 Jul 2004 18:14:31 +0100
Received: from csr.com (pws@localhost)
	by news01.csr.com (8.12.11/8.12.11/Submit) with ESMTP id i6QHEUKu012595;
	Mon, 26 Jul 2004 18:14:30 +0100
Message-Id: <200407261714.i6QHEUKu012595@news01.csr.com>
X-Authentication-Warning: news01.csr.com: pws owned process doing -bs
To: Clint Adams <schizo@debian.org>
cc: zsh-workers@sunsite.dk, Martin Godisch <martin@godisch.de>,
        201685-forwarded@bugs.debian.org
Subject: Re: Bug#201685: zsh: bug in prompt expansion 
In-reply-to: "Clint Adams"'s message of "Fri, 23 Jul 2004 13:33:22 EDT."
             <20040723173322.GA9988@scowler.net> 
Date: Mon, 26 Jul 2004 18:14:29 +0100
From: Peter Stephenson <pws@csr.com>
X-OriginalArrivalTime: 26 Jul 2004 17:16:20.0981 (UTC) FILETIME=[4534FA50:01C47334]
X-Spam-Checker-Version: SpamAssassin 2.63 on a.mx.sunsite.dk
X-Spam-Level: 
X-Spam-Status: No, hits=-1.5 required=6.0 tests=BAYES_01 autolearn=no 
	version=2.63
X-Spam-Hits: -1.5

Clint Adams wrote:
> I don't remember if this was discussed before.
> 
> On Thu, Jul 17, 2003 at 11:33:11AM +0200, Martin Godisch wrote:
> > 
> > After PROMPT='%~%1(C./.) ' the full prompt should be `/ ' in the root
> > directory, because the absolute path `/' does not have at least one element
> .

This would fix this.

Index: Doc/Zsh/prompt.yo
===================================================================
RCS file: /cvsroot/zsh/zsh/Doc/Zsh/prompt.yo,v
retrieving revision 1.6
diff -u -r1.6 prompt.yo
--- Doc/Zsh/prompt.yo	2 Nov 2001 12:35:32 -0000	1.6
+++ Doc/Zsh/prompt.yo	26 Jul 2004 17:12:13 -0000
@@ -217,11 +217,13 @@
 sitem(tt(?))(True if the exit status of the last command was var(n).)
 sitem(tt(_))(True if at least var(n) shell constructs were started.)
 sxitem(tt(C))
-sitem(tt(/))(True if the current absolute path has at least var(n) elements.)
+sitem(tt(/))(True if the current absolute path has at least var(n) elements
+relative to the root directory, hence tt(/) is counted as 0 elements.)
 sxitem(tt(c))
 sxitem(tt(.))
 sitem(tt(~))(True if the current path, with prefix replacement, has at
-least var(n) elements.)
+least var(n) elements relative to the root directory, hence tt(/) is
+counted as 0 elements.)
 sitem(tt(D))(True if the month is equal to var(n) (January = 0).)
 sitem(tt(d))(True if the day of the month is equal to var(n).)
 sitem(tt(g))(True if the effective gid of the current process is var(n).)
Index: Src/prompt.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/prompt.c,v
retrieving revision 1.19
diff -u -r1.19 prompt.c
--- Src/prompt.c	22 Jun 2004 13:10:02 -0000	1.19
+++ Src/prompt.c	26 Jul 2004 17:12:14 -0000
@@ -244,9 +244,12 @@
 		    if ((nd = finddir(ss))) {
 			arg--;
 			ss += strlen(nd->dir);
-		    }
+		    } /*FALLTHROUGH*/
 		case '/':
 		case 'C':
+		    /* `/' gives 0, `/any' gives 1, etc. */
+		    if (*ss++ == '/' && *ss)
+			arg--;
 		    for (; *ss; ss++)
 			if (*ss == '/')
 			    arg--;

-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR Ltd., Science Park, Milton Road,
Cambridge, CB4 0WH, UK                          Tel: +44 (0)1223 692070


**********************************************************************
The information transmitted is intended only for the person or
entity to which it is addressed and may contain confidential 
and/or privileged material. 
Any review, retransmission, dissemination or other use of, or
taking of any action in reliance upon, this information by 
persons or entities other than the intended recipient is 
prohibited. 
If you received this in error, please contact the sender and 
delete the material from any computer.
**********************************************************************

