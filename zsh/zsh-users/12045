From zsh-users-return-12045-mason-zsh=primenet.com.au@sunsite.dk Thu Oct 18 14:00:24 2007
Return-Path: <zsh-users-return-12045-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 21335 invoked from network); 18 Oct 2007 14:00:16 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.3 (2007-08-08) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.3
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 18 Oct 2007 14:00:16 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 67808 invoked from network); 18 Oct 2007 14:00:10 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 18 Oct 2007 14:00:10 -0000
Received: (qmail 10153 invoked by alias); 18 Oct 2007 13:59:57 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 12045
Received: (qmail 10134 invoked from network); 18 Oct 2007 13:59:57 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 18 Oct 2007 13:59:57 -0000
Received: (qmail 66368 invoked from network); 18 Oct 2007 13:59:57 -0000
Received: from cluster-g.mailcontrol.com (85.115.41.190)
  by a.mx.sunsite.dk with SMTP; 18 Oct 2007 13:59:50 -0000
Received: from cameurexb01.EUROPE.ROOT.PRI ([62.189.241.200])
	by rly13g.srv.mailcontrol.com (MailControl) with ESMTP id l9IDwIJa010665
	for <zsh-users@sunsite.dk>; Thu, 18 Oct 2007 14:59:45 +0100
Received: from news01.csr.com ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.1830);
	 Thu, 18 Oct 2007 14:59:23 +0100
Received: from news01.csr.com (localhost.localdomain [127.0.0.1])
	by news01.csr.com (8.14.1/8.13.4) with ESMTP id l9IDxN96006152
	for <zsh-users@sunsite.dk>; Thu, 18 Oct 2007 14:59:23 +0100
Received: from csr.com (pws@localhost)
	by news01.csr.com (8.14.1/8.14.1/Submit) with ESMTP id l9IDxNLL006149
	for <zsh-users@sunsite.dk>; Thu, 18 Oct 2007 14:59:23 +0100
Message-Id: <200710181359.l9IDxNLL006149@news01.csr.com>
X-Authentication-Warning: news01.csr.com: pws owned process doing -bs
To: zsh-users@sunsite.dk
Subject: Re: trick: up-to-the-minute time in prompt
In-reply-to: <20071018114641.12315.qmail@smasher.org>
References: <20071018114641.12315.qmail@smasher.org>
Comments: In-reply-to Atom Smasher <atom@smasher.org>
   message dated "Fri, 19 Oct 2007 00:46:38 +1300."
Date: Thu, 18 Oct 2007 14:59:23 +0100
From: Peter Stephenson <pws@csr.com>
X-OriginalArrivalTime: 18 Oct 2007 13:59:23.0575 (UTC) FILETIME=[16832C70:01C8118F]
X-Scanned-By: MailControl A-07-08-10 (www.mailcontrol.com) on 10.71.0.123

Atom Smasher wrote:
> here's a neat trick i just figured out... have the time that's displayed
> in your prompt update itself!

Here's a version that uses sched; you need 4.3.4 with the fix to sched
that makes it run from within zle if the shell is idle when the period
expires.  Its advantage is it's completely non-invasive, not clashing
with anything else (except a function of the same name, obviously).  If
you have time escapes in your prompt you can just run it once and the
times will then update, otherwise you need the uptime/psvar etc. trickery.

schedprompt() {
  emulate -L zsh
  zmodload -i zsh/sched

  # Remove existing event, so that multiple calls to
  # "schedprompt" work OK.  (You could put one in precmd to push
  # the timer 30 seconds into the future, for example.)
  integer i=${"${(@)zsh_scheduled_events#*:*:}"[(I)schedprompt]}
  (( i )) && sched -$i

  # Test that zle is running before calling the widget (recommended
  # to avoid error messages).
  # Otherwise it updates on entry to zle, so there's no loss.
  zle && zle reset-prompt

  # This ensures we're not too far off the start of the minute
  sched +30 schedprompt
}

-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070

