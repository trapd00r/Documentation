From zsh-users-return-14955-mason-zsh=primenet.com.au@zsh.org Mon Mar 22 15:07:18 2010
Return-Path: <zsh-users-return-14955-mason-zsh=primenet.com.au@zsh.org>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 26427 invoked by alias); 22 Mar 2010 15:07:18 -0000
Mailing-List: contact zsh-users-help@zsh.org; run by ezmlm
Precedence: bulk
X-No-Archive: yes
List-Id: Zsh Users List <zsh-users.zsh.org>
List-Post: <mailto:zsh-users@zsh.org>
List-Help: <mailto:zsh-users-help@zsh.org>
Delivered-To: mailing list zsh-users@zsh.org
X-Seq: 14955
Received: (qmail 4016 invoked from network); 22 Mar 2010 15:07:17 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received-SPF: none (ns1.primenet.com.au: domain at closedmail.com does not designate permitted sender hosts)
From: Bart Schaefer <schaefer@brasslantern.com>
Message-id: <100322080712.ZM21793@torch.brasslantern.com>
Date: Mon, 22 Mar 2010 08:07:11 -0700
In-reply-to: <20100322084226.GA26739@fermat.math.technion.ac.il>
Comments: In reply to "Nadav Har'El" <nyh@math.technion.ac.il>
 "Re: Append cancelled commands to history" (Mar 22, 10:42am)
References: <c16a574a0809181450t61a5b5ddq2e80797fde37636e@mail.gmail.com>
	<20080919162045.GA22435@ruderich.org>
	<20090706151644.6BF508027106@bifrost.dotsrc.org>
	<20090706154309.GA15663@fermat.math.technion.ac.il>
	<20090706155337.GB15663@fermat.math.technion.ac.il>
	<20100315164237.GA23224@fermat.math.technion.ac.il>
	<100320105027.ZM20067@torch.brasslantern.com>
	<20100322084226.GA26739@fermat.math.technion.ac.il>
X-Mailer: OpenZMail Classic (0.9.2 24April2005)
To: zsh-users@zsh.org
Subject: Re: Append cancelled commands to history
MIME-version: 1.0
Content-type: text/plain; charset=us-ascii

On Mar 22, 10:42am, Nadav Har'El wrote:
> Subject: Re: Append cancelled commands to history
>
> But the problem I have now is that when I now go up in the history, the
> last command I see is
> 
> 	for i in *
> 	do
> 
> which is what standard zsh saved - without the last partial line - and when I
> go up another command in history I see
> 
> 	for i in *
> 	do
> 	echo
> 
> which is what my code saved. I wished there was a way not to save that
> shorter version, with only the accepted lines.

Something like this may work:

typeset -g INTBUFFER
autoload -U add-zsh-hook

trapint_history() {
   if [[ -n "$INTBUFFER" ]]
   then
      print -s -r -- "$INTBUFFER"
      INTBUFFER=
      return 1
   fi
   return 0
}

TRAPINT() {
   zle && [[ $HISTNO -eq $HISTCMD ]] && INTBUFFER="$PREBUFFER$BUFFER"
   return $1
}

add-zsh-hook zshaddhistory trapint_history

-- 

