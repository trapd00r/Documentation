From zsh-workers-return-22470-mason-zsh=primenet.com.au@sunsite.dk Mon May 29 15:56:18 2006
Return-Path: <zsh-workers-return-22470-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 9502 invoked from network); 29 May 2006 15:56:15 -0000
X-Spam-Checker-Version: SpamAssassin 3.1.2 (2006-05-25) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=BAYES_00,FORGED_RCVD_HELO 
	autolearn=ham version=3.1.2
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 29 May 2006 15:56:15 -0000
Received: (qmail 55670 invoked from network); 29 May 2006 15:56:09 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 29 May 2006 15:56:09 -0000
Received: (qmail 13416 invoked by alias); 29 May 2006 15:56:06 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 22470
Received: (qmail 13406 invoked from network); 29 May 2006 15:56:06 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 29 May 2006 15:56:06 -0000
Received: (qmail 55415 invoked from network); 29 May 2006 15:56:06 -0000
Received: from mta07-winn.ispmail.ntl.com (HELO mtaout01-winn.ispmail.ntl.com) (81.103.221.47)
  by a.mx.sunsite.dk with SMTP; 29 May 2006 15:56:03 -0000
Received: from aamtaout02-winn.ispmail.ntl.com ([81.103.221.35])
          by mtaout01-winn.ispmail.ntl.com with ESMTP
          id <20060529155602.ZAEX29343.mtaout01-winn.ispmail.ntl.com@aamtaout02-winn.ispmail.ntl.com>;
          Mon, 29 May 2006 16:56:02 +0100
Received: from pwslaptop.csr.com ([81.107.47.162])
          by aamtaout02-winn.ispmail.ntl.com with ESMTP
          id <20060529155602.GMNY24467.aamtaout02-winn.ispmail.ntl.com@pwslaptop.csr.com>;
          Mon, 29 May 2006 16:56:02 +0100
Received: from pwslaptop.csr.com (pwslaptop.csr.com [127.0.0.1])
	by pwslaptop.csr.com (8.13.6/8.13.4) with ESMTP id k4TFtrXT014838;
	Mon, 29 May 2006 16:55:54 +0100
Message-Id: <200605291555.k4TFtrXT014838@pwslaptop.csr.com>
From: Peter Stephenson <p.w.stephenson@ntlworld.com>
To: "Johann 'Myrkraverk' Oskarsson" <johann@myrkraverk.com>,
        zsh-workers@sunsite.dk (Zsh hackers list)
Subject: Re: configure: error: ERROR MACROS NOT FOUND: please report to developers [PATCH] 
In-Reply-To: Message from "Johann 'Myrkraverk' Oskarsson" <johann@myrkraverk.com> 
   of "Sun, 28 May 2006 21:05:23 -0000." <m31wudg8rw.fsf@jin.myrkraverk.com> 
Date: Mon, 29 May 2006 16:55:53 +0100

"Johann 'Myrkraverk' Oskarsson" wrote:
> Peter Stephenson <p.w.stephenson@ntlworld.com> writes:
> 
> > The following covers both cases, but may be too general:
> >
> > '#[ 	]*define[ 	][ 	]*E[0-9A-Z]*[ 	]*(_HURD_ERRNO )?\(?[_A
> -Z0-9]'
> >
> 
> I haven't tried compiling 4.3 (yet) but that RE seems to work on Zeta.

(I've moved this to zsh-workers.)

The generality problem should be fixed if we keep the header with the most
matches.

> P.S. The sources on http://zsh.sunsite.dk/Arc/cvs.html are *way* too
> old, afaik -- from 2006/06/15.

This is probably to do with the changes at Sourceforge.  I'm not sure
whose keeping the Sunsite stuff up to date at the moment.

Index: configure.ac
===================================================================
RCS file: /cvsroot/zsh/zsh/configure.ac,v
retrieving revision 1.51
diff -u -r1.51 configure.ac
--- configure.ac	2 Mar 2006 17:56:49 -0000	1.51
+++ configure.ac	29 May 2006 15:53:08 -0000
@@ -1312,16 +1312,25 @@
 $AWK '{ if ($1 ~ /err/) files[[$1]] = $1 }
   END { for (var in files) print var }'`"
 rm -f nametmp.c
-for ERRNO_H in $errfile_list /dev/null
+lnerrs=0
+for ERRNO_TRY_H in $errfile_list /dev/null
 do
   dnl Try to make sure it doesn't get confused by files that don't
   dnl have real error definitions in.  Count definitions to make sure.
-  nerrs=`test -f $ERRNO_H && \
-  $EGREP '#[ 	]*define[ 	][ 	]*E[0-9A-Z]*[ 	]*(_HURD_ERRNO \()?[0-9]+\)?' $ERRNO_H | \
+  dnl Definitions of error numbers have become more and more general, so
+  dnl pick the file with the most matches, which must be at least 7.
+  dnl Careful with cut and paste in the pattern: the square brackets
+  dnl must contain a space and a tab.
+  nerrs=`test -f $ERRNO_TRY_H && \
+  $EGREP '#[ 	]*define[ 	][ 	]*E[0-9A-Z]*[ 	]*(_HURD_ERRNO )?\(?[_A-Z0-9]' $ERRNO_TRY_H | \
   wc -l | sed 's/[ 	]//g'`
-  test "x$nerrs" != x && test "$nerrs" -ge 7 && break
+  if test "x$nerrs" != x && test "$nerrs" -ge 7 && test "$nerrs" -gt "$lnerrs"
+  then
+    lnerrs=$nerrs
+    ERRNO_H=$ERRNO_TRY_H
+  fi
 done
-if test x$ERRNO_H = x"/dev/null"; then
+if test x$ERRNO_H = x; then
   AC_MSG_ERROR(ERROR MACROS NOT FOUND:  please report to developers)
 fi
 zsh_cv_path_errno_h=$ERRNO_H

-- 
Peter Stephenson <p.w.stephenson@ntlworld.com>
Web page now at http://homepage.ntlworld.com/p.w.stephenson/

