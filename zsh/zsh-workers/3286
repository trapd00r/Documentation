From zsh-workers-request@euclid.skiles.gatech.edu Mon Jun 23 10:57:12 1997
Return-Path: <zsh-workers-request@euclid.skiles.gatech.edu>
Delivered-To: mason@primenet.com.au
Received: (qmail 24512 invoked from network); 23 Jun 1997 10:57:11 -0000
Received: from euclid.skiles.gatech.edu (list@130.207.146.50)
  by ns1.primenet.com.au with SMTP; 23 Jun 1997 10:57:11 -0000
Received: (from list@localhost) by euclid.skiles.gatech.edu (8.7.3/8.7.3) id GAA04188; Mon, 23 Jun 1997 06:48:11 -0400 (EDT)
Resent-Date: Mon, 23 Jun 1997 06:48:11 -0400 (EDT)
Date: Mon, 23 Jun 97 19:51:35 JST
Message-Id: <9706231051.AA04925@oz.fantasy.otsl.oki.co.jp>
To: hzoli@ny.frontiercomm.net, zsh-workers@math.gatech.edu
Subject: Re: zsh-3.0.3: another problem in Src/jobs.c
From: suzuki@otsl.oki.co.jp (SUZUKI Hisao)
Organization: Oki Technosystems Laboratory, Inc., Nagoya, Japan
Resent-Message-ID: <"_EO4J1.0.N11.hHbhp"@euclid>
Resent-From: zsh-workers@math.gatech.edu
X-Mailing-List: <zsh-workers@math.gatech.edu> archive/latest/3286
X-Loop: zsh-workers@math.gatech.edu
Precedence: list
Resent-Sender: zsh-workers-request@math.gatech.edu

K"os"on"om szepen, Zoltan ur es zsh-workers!

Thank you for releasing the debugged zsh so promptly.  I got
zsh-3.0.4.tar.gz just now.  I see it works almost finely and
Src/jobs.c has changed in lines ca 157 from

	if (shout && !ttyfrozen && !jn->stty_in_env)
	     gettyinfo(&shttyinfo);
to
	if (shout && !ttyfrozen && !jn->stty_in_env &&
	    job == thisjob && !somestopped)
	    gettyinfo(&shttyinfo);

Yes, it is substantially the same patch as that of my message
<9706192332.AA00517@oz.fantasy.otsl.oki.co.jp> sent you on June
20 (or June 19 in GMT).  You have made a right choice at last
for the present implementation for the time being! (I knock on
wood here :-)

However, I am afraid I must say something still goes wrong.  Try
this:
	% emacs -nw &
	% fg
	[type ^X^C to terminate the emacs]
	% stty

	[Note: this is not artificial.  When you forget to set
	 DISPLAY, you will be put in the same situation.]

As you see, the tty setting remains sane as long as you suspend
or continue the emacs job.  Once you terminate the job, the tty
setting goes bad.

If solely my patch of June 20 had applied, then this is not
happend when you _once_ suspend the "fg"ed emacs job before
terminate it.  Now that you also changed Src/jobs.c from

	if (jn->stty_in_env && !jn->ty) {
	    jn->ty = (struct ttyinfo *) zalloc(sizeof(struct ttyinfo));
to
	if (shout && job == thisjob) {
	    if (!jn->ty)
		jn->ty = (struct ttyinfo *) zalloc(sizeof(struct ttyinfo));

in lines 140-142, the problem was revealed.  In zsh-3.0.4, it
happens whether you have once suspended the job or not.

--
Hisao Suzuki <suzuki@otsl.oki.co.jp>

