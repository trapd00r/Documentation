From zsh-workers-return-22578-mason-zsh=primenet.com.au@sunsite.dk Wed Aug 02 17:13:10 2006
Return-Path: <zsh-workers-return-22578-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 21326 invoked from network); 2 Aug 2006 17:13:06 -0000
X-Spam-Checker-Version: SpamAssassin 3.1.4 (2006-07-25) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.4 required=5.0 tests=AWL,BAYES_00,
	FORGED_RCVD_HELO autolearn=ham version=3.1.4
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 2 Aug 2006 17:13:06 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 13427 invoked from network); 2 Aug 2006 17:12:59 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 2 Aug 2006 17:12:59 -0000
Received: (qmail 6561 invoked by alias); 2 Aug 2006 17:12:55 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 22578
Received: (qmail 6550 invoked from network); 2 Aug 2006 17:12:53 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 2 Aug 2006 17:12:53 -0000
Received: (qmail 13140 invoked from network); 2 Aug 2006 17:12:53 -0000
Received: from cluster-d.mailcontrol.com (217.69.20.190)
  by a.mx.sunsite.dk with SMTP; 2 Aug 2006 17:12:51 -0000
Received: from cameurexb01.EUROPE.ROOT.PRI ([62.189.241.200])
	by rly14d.srv.mailcontrol.com (MailControl) with ESMTP id k72HCm21021373
	for <zsh-workers@sunsite.dk>; Wed, 2 Aug 2006 18:12:48 +0100
Received: from news01.csr.com ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.1830);
	 Wed, 2 Aug 2006 18:12:47 +0100
Received: from news01.csr.com (localhost.localdomain [127.0.0.1])
	by news01.csr.com (8.13.4/8.13.4) with ESMTP id k72HCmYl029127
	for <zsh-workers@sunsite.dk>; Wed, 2 Aug 2006 18:12:48 +0100
Received: from csr.com (pws@localhost)
	by news01.csr.com (8.13.4/8.13.4/Submit) with ESMTP id k72HCldt029122
	for <zsh-workers@sunsite.dk>; Wed, 2 Aug 2006 18:12:48 +0100
Message-Id: <200608021712.k72HCldt029122@news01.csr.com>
X-Authentication-Warning: news01.csr.com: pws owned process doing -bs
To: zsh-workers@sunsite.dk (Zsh hackers list)
Subject: Re: PATCH: multibyte odds and ends 
In-reply-to: <060801195507.ZM16505@torch.brasslantern.com> 
References: <200608012044.k71KifcO007951@pwslaptop.csr.com> <060801195507.ZM16505@torch.brasslantern.com>
Date: Wed, 02 Aug 2006 18:12:47 +0100
From: Peter Stephenson <pws@csr.com>
X-OriginalArrivalTime: 02 Aug 2006 17:12:47.0790 (UTC) FILETIME=[E0945CE0:01C6B656]
Content-Type: text/plain
MIME-Version: 1.0
X-Scanned-By: MailControl A-07-04-01 (www.mailcontrol.com) on 10.68.0.124

Bart Schaefer wrote:
> On Aug 1,  9:44pm, Peter Stephenson wrote:
> } Does anybody have any preferences?  Does anybody ever redefine HISTCHARS?
> 
> I've been redefining HISTCHARS/histchars to replace ^ with = for longer
> than I've been using zsh (dating from using csh way back when some tty
> terminals did not have | and the Bourne shell interpreted ^ as a pipe).
> 
> I'd be fine with restricting HISTCHARS to ASCII, or even to non-alpha-
> numeric ASCII.

I presume this is the only response I'm likely to get.

The shell will now issue a warning and refuse to set histchars/HISTCHARS
if either contains non-ASCII characters.  I thought about an error, but
the most likely place to set HISTCHARS is in .zshrc, and aborting all
processing if setting the variable fails is not likely to be the right
thing to do.

It also fixes a hard-to-find bug with metafication.

By the way, I've no intention of removing HISTCHARS so the note that
it's "deprecated" isn't really true, particularly since upper case is
the natural form for scalars in zsh.

Index: README
===================================================================
RCS file: /cvsroot/zsh/zsh/README,v
retrieving revision 1.34
diff -u -r1.34 README
--- README	10 Jul 2006 13:08:22 -0000	1.34
+++ README	2 Aug 2006 17:05:51 -0000
@@ -81,6 +81,11 @@
 on some fairly common PC configurations.  This change is only likely to
 affect some highly specialised uses of the shell.
 
+The variables HISTCHARS and histchars now reject any attempt to
+set non-ASCII characters for history or comments.  Multibyte characters
+have never worked and the most consistent change was to restrict the
+set to portable characters only.
+
 Documentation
 -------------
 
Index: Doc/Zsh/params.yo
===================================================================
RCS file: /cvsroot/zsh/zsh/Doc/Zsh/params.yo,v
retrieving revision 1.32
diff -u -r1.32 params.yo
--- Doc/Zsh/params.yo	2 Aug 2006 09:59:23 -0000	1.32
+++ Doc/Zsh/params.yo	2 Aug 2006 17:05:51 -0000
@@ -803,6 +803,10 @@
 expansion (default `tt(!)').  The second character signals the
 start of a quick history substitution (default `tt(^)').  The third
 character is the comment character (default `tt(#)').
+
+The characters must be in the ASCII character set; any attempt to set
+tt(histchars) to characters with a locale-dependent meaning will be
+rejected with an error message.
 )
 vindex(HISTCHARS)
 item(tt(HISTCHARS) <S> <Z>)(
Index: Src/params.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/params.c,v
retrieving revision 1.117
diff -u -r1.117 params.c
--- Src/params.c	10 Jul 2006 13:08:23 -0000	1.117
+++ Src/params.c	2 Aug 2006 17:05:52 -0000
@@ -3548,10 +3548,21 @@
 histcharssetfn(UNUSED(Param pm), char *x)
 {
     if (x) {
-	bangchar = x[0];
-	hatchar = (bangchar) ? x[1] : '\0';
-	hashchar = (hatchar) ? x[2] : '\0';
-	zsfree(x);
+	int len, i;
+
+	unmetafy(x, &len);
+	if (len > 3)
+	    len = 3;
+	for (i = 0; i < len; i++) {
+	    if (!isascii(STOUC(x[i]))) {
+		zwarn("HISTCHARS can only contain ASCII characters");
+		return;
+	    }
+	}
+	bangchar = len ? STOUC(x[0]) : '\0';
+	hatchar =  len > 1 ? STOUC(x[1]) : '\0';
+	hashchar = len > 2 ? STOUC(x[2]) : '\0';
+	free(x);
     } else {
 	bangchar = '!';
 	hashchar = '#';

-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070


To access the latest news from CSR copy this link into a web browser:  http://www.csr.com/email_sig.php

