From zsh-users-return-14002-mason-zsh=primenet.com.au@sunsite.dk Tue Apr 07 10:26:53 2009
Return-Path: <zsh-users-return-14002-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 26037 invoked from network); 7 Apr 2009 10:26:48 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 7 Apr 2009 10:26:48 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 56726 invoked from network); 7 Apr 2009 10:26:33 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 7 Apr 2009 10:26:33 -0000
Received: (qmail 2775 invoked by alias); 7 Apr 2009 10:26:16 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 14002
Received: (qmail 2762 invoked from network); 7 Apr 2009 10:26:15 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 7 Apr 2009 10:26:15 -0000
Received: from atom.smasher.org (atom.smasher.org [69.55.237.145])
	by bifrost.dotsrc.org (Postfix) with SMTP id AA0CE82D4B6A
	for <zsh-users@sunsite.dk>; Tue,  7 Apr 2009 12:26:01 +0200 (CEST)
Received: (qmail 62534 invoked by uid 1000); 7 Apr 2009 10:25:59 -0000
Message-ID: <20090407102559.62531.qmail@smasher.org>
cc: zsh-users@sunsite.dk
Content-Type: TEXT/PLAIN; charset=US-ASCII; format=flowed
Date: Tue, 7 Apr 2009 22:25:54 +1200 (NZST)
From: Atom Smasher <atom@smasher.org>
In-Reply-To: <20090407005850.34922.qmail@smasher.org>
MIME-Version: 1.0
OpenPGP: id=0xB88D52E4D9F57808; algo=1 (RSA); size=4096; url=http://atom.smasher.org/pgp.txt
References: <20090406082744.28853.qmail@smasher.org> <20090406100300.5c377728@news01>
 <20090407005850.34922.qmail@smasher.org>
Subject: Re: killed by signal
To: Peter Stephenson <pws@csr.com>
X-POM: The Moon is Waxing Gibbous (95% of Full)
X-Hashcash: 1:20:0904071025:pws@csr.com::E8oQJ/eAX/zNh92v:001BBR
X-Hashcash: 1:20:0904071025:zsh-users@sunsite.dk::HVLYWwCBjTjf79vT:0000000000000
	0000000000000000000000003z4o
X-Virus-Scanned: ClamAV 0.92.1/9210/Tue Apr  7 05:34:45 2009 on bifrost
X-Virus-Status: Clean

On Tue, 7 Apr 2009, Atom Smasher wrote:

> but if a command is suspended (TSTP; 20 on linux, 18 on freebsd) precmd 
> will see a return status <128, which could be a "legal" value for a 
> command to return indicating a particular failure. i'd like precmd to 
> distinguish between a command that returns 18 or 20 (freebsd or linux, 
> respectively), and a command that is suspended with ^Z.
>
> specific example... on freebsd i can get a return status of 18 either by 
> suspending a job with ^Z, or running:
> 	zip -MM foo.zip no-such-file
>  so the question is: how can the shell (can the shell?) tell that one of 
> those was suspended with a signal (^Z, TSTP), and zip which is 
> indicating a specific failure (zip: "File not found").
=========================

here's a hack.... after a command is suspended, $? is updated but 
$pipestatus isn't. so if
 	[[ ${?} != ${${=pipestatus}[-1]} ]]
  then the preceding command must have been suspended.

but it doesn't work all the time: if a command returns with an exit status 
equal to a suspend signal (which is probably rare), and the next command 
is suspended with that signal, that would result in a false negative; 
failing to detect that a command was suspended... but most of the time it 
should work, and i don't think it's possible to get a false positive.

if anyone has a better way to do it...


-- 
         ...atom

  ________________________
  http://atom.smasher.org/
  762A 3B98 A3C3 96C9 C6B7 582A B88D 52E4 D9F5 7808
  -------------------------------------------------

 	"I spent 33 years in the Marines. Most of my time being a
 	 high-class muscle man for Big business, for Wall Street and
 	 the bankers. In short, I was a racketeer for capitalism. I
 	 helped purify Nicaragua for the international banking house
 	 of Brown Brothers in 1909-1912. I helped make Mexico and
 	 especially Tampico safe for American oil interests in 1914.
 	 I brought light to the Dominican Republic for American sugar
 	 interests in 1916. I helped make Haiti and Cuba a decent
 	 place for the National City Bank boys to collect revenue in.
 	 I helped in the rape of half a dozen Central American
 	 republics for the benefit of Wall Street"
 		-- Smedley D. Butler, (1881-1940)
 		Major Gen U.S. Marines
 		at the time of his death the most
 		decorated U.S. Marine in history

