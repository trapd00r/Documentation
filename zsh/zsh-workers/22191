From zsh-workers-return-22191-mason-zsh=primenet.com.au@sunsite.dk Fri Feb 03 22:41:22 2006
Return-Path: <zsh-workers-return-22191-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 969 invoked from network); 3 Feb 2006 22:41:19 -0000
X-Spam-Checker-Version: SpamAssassin 3.1.0 (2005-09-13) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=AWL,BAYES_00,
	FORGED_RCVD_HELO autolearn=ham version=3.1.0
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 3 Feb 2006 22:41:19 -0000
Received: (qmail 16472 invoked from network); 3 Feb 2006 22:41:13 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 3 Feb 2006 22:41:13 -0000
Received: (qmail 18865 invoked by alias); 3 Feb 2006 22:41:11 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 22191
Received: (qmail 18846 invoked from network); 3 Feb 2006 22:41:10 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 3 Feb 2006 22:41:10 -0000
Received: (qmail 16140 invoked from network); 3 Feb 2006 22:41:10 -0000
Received: from mta08-winn.ispmail.ntl.com (81.103.221.48)
  by a.mx.sunsite.dk with SMTP; 3 Feb 2006 22:41:09 -0000
Received: from aamta10-winn.ispmail.ntl.com ([81.103.221.35])
          by mta08-winn.ispmail.ntl.com with ESMTP
          id <20060203224108.DHPS8724.mta08-winn.ispmail.ntl.com@aamta10-winn.ispmail.ntl.com>
          for <zsh-workers@sunsite.dk>; Fri, 3 Feb 2006 22:41:08 +0000
Received: from pwslaptop.csr.com ([81.105.238.64])
          by aamta10-winn.ispmail.ntl.com with ESMTP
          id <20060203224108.DAMM21315.aamta10-winn.ispmail.ntl.com@pwslaptop.csr.com>
          for <zsh-workers@sunsite.dk>; Fri, 3 Feb 2006 22:41:08 +0000
Received: from pwslaptop.csr.com (pwslaptop.csr.com [127.0.0.1])
	by pwslaptop.csr.com (8.13.4/8.13.4) with ESMTP id k13MenxJ007531
	for <zsh-workers@sunsite.dk>; Fri, 3 Feb 2006 22:40:49 GMT
Received: from pwslaptop.csr.com (pws@localhost)
	by pwslaptop.csr.com (8.13.4/8.13.4/Submit) with ESMTP id k13MekZj007527
	for <zsh-workers@sunsite.dk>; Fri, 3 Feb 2006 22:40:48 GMT
Message-Id: <200602032240.k13MekZj007527@pwslaptop.csr.com>
X-Authentication-Warning: pwslaptop.csr.com: pws owned process doing -bs
From: Peter Stephenson <p.w.stephenson@ntlworld.com>
To: Zsh hackers list <zsh-workers@sunsite.dk>
Subject: Re: PATCH: _hosts 
In-Reply-To: Message from Danek Duvall <duvall@comfychair.org> 
   of "Fri, 03 Feb 2006 11:45:01 PST." <20060203194501.GC23141@lorien.comfychair.org> 
Date: Fri, 03 Feb 2006 22:40:45 +0000

Danek Duvall wrote:
> Might want to strip out IPv6 addresses as well:
> 
>   -e '/^[0-9a-f]\{0,4\}:/d'
> 
> And I'm not sure I see what the "/p" is doing there, other than doubling
> each entry.  Would
> 
>     ${${${(u)${(f)"$(<~/.ssh/known_hosts)"}%%[ ,]*}:#(#s)[0-9]##.[0-9]##.[0-9
> ]##.[0-9]##(#e)}:#(#s)[0-9a-f:]##(#e)}
> 
> be any better (if more arcane)?

It matches the rest of the completion system...

The /p was because I started with perl -ne before I decided that sed was
more portable.

> _users calls
> 
>     zstyle -a ":completion:${curcontext}:" users users
> 
> compared to _hosts, which calls
> 
>     zstyle -a ":completion:${curcontext}:hosts" hosts hosts
> 
> Is there some reason that _hosts uses the hosts tag, but _users doesn't use
> the users tag?

I think it must be an oversight, given that the manual specifically
mentions the existence of a users tag (as well as a users style).

I agree it's also inconsistent that you can't skip the userdirs
completion.  There could probably be better caching of user names if
default completion is used (and, really, _hosts ought to use the cache
system, though the disadvantage is it has to be explicitly enabled).

I'll commit the following...

Index: Completion/Unix/Type/_hosts
===================================================================
RCS file: /cvsroot/zsh/zsh/Completion/Unix/Type/_hosts,v
retrieving revision 1.6
diff -u -r1.6 _hosts
--- Completion/Unix/Type/_hosts	3 Feb 2006 16:32:15 -0000	1.6
+++ Completion/Unix/Type/_hosts	3 Feb 2006 22:34:33 -0000
@@ -23,7 +23,7 @@
     fi
 
     if [[ -r ~/.ssh/known_hosts ]]; then
-      _cache_hosts+=( $(sed -e '/^[0-9]*\.[0-9]*\.[0-9]*\.[0-9]/d' -e 's/[ ,].*//p' ~/.ssh/known_hosts) )
+      _cache_hosts+=(${${${(u)${(f)"$(<~/.ssh/known_hosts)"}%%[ ,]*}:#(#s)[0-9]##.[0-9]##.[0-9]##.[0-9]##(#e)}:#(#s)[0-9a-f:]##(#e)})
     fi
   fi
 
Index: Completion/Unix/Type/_users
===================================================================
RCS file: /cvsroot/zsh/zsh/Completion/Unix/Type/_users,v
retrieving revision 1.5
diff -u -r1.5 _users
--- Completion/Unix/Type/_users	8 Jun 2005 12:45:36 -0000	1.5
+++ Completion/Unix/Type/_users	3 Feb 2006 22:34:33 -0000
@@ -2,7 +2,9 @@
 
 local expl users
 
-zstyle -a ":completion:${curcontext}:" users users &&
-    _wanted users expl user compadd "$@" -a - users && return 0
+if zstyle -a ":completion:${curcontext}:users" users users; then
+    _wanted users expl user compadd "$@" -a - users
+    return 0
+fi
 
 _wanted users expl user compadd "$@" -k - userdirs

-- 
Peter Stephenson <p.w.stephenson@ntlworld.com>
Web page still at http://www.pwstephenson.fsnet.co.uk/

