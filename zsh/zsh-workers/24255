From zsh-workers-return-24255-mason-zsh=primenet.com.au@sunsite.dk Fri Dec 14 15:05:55 2007
Return-Path: <zsh-workers-return-24255-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 16553 invoked from network); 14 Dec 2007 15:05:46 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.3 (2007-08-08) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.3
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 14 Dec 2007 15:05:46 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 29645 invoked from network); 14 Dec 2007 15:05:37 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 14 Dec 2007 15:05:37 -0000
Received: (qmail 4753 invoked by alias); 14 Dec 2007 15:05:31 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 24255
Received: (qmail 4735 invoked from network); 14 Dec 2007 15:05:30 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 14 Dec 2007 15:05:31 -0000
Received: from virusfilter.dotsrc.org (bifrost [127.0.0.1])
	by spamfilter.dotsrc.org (Postfix) with ESMTP id 983248058F54
	for <zsh-workers@sunsite.dk>; Fri, 14 Dec 2007 16:02:42 +0100 (CET)
Received: from cluster-g.mailcontrol.com (cluster-g.mailcontrol.com [85.115.41.190])
	by bifrost.dotsrc.org (Postfix) with ESMTP
	for <zsh-workers@sunsite.dk>; Fri, 14 Dec 2007 16:02:42 +0100 (CET)
Received: from rly11g.srv.mailcontrol.com (localhost.localdomain [127.0.0.1])
	by rly11g.srv.mailcontrol.com (MailControl) with ESMTP id lBEF5BdZ006979
	for <zsh-workers@sunsite.dk>; Fri, 14 Dec 2007 15:05:22 GMT
Received: from submission.mailcontrol.com (submission.mailcontrol.com [86.111.216.190])
	by rly11g.srv.mailcontrol.com (MailControl) id lBEF4kgn005157
	for zsh-workers@sunsite.dk; Fri, 14 Dec 2007 15:04:46 GMT
Received: from cameurexb01.EUROPE.ROOT.PRI ([62.189.241.200])
	by rly11g-eth0.srv.mailcontrol.com (envelope-sender Peter.Stephenson@csr.com) (MIMEDefang) with ESMTP id lBEF4Mt5003205; Fri, 14 Dec 2007 15:04:44 +0000 (GMT)
Received: from news01.csr.com ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.1830);
	 Fri, 14 Dec 2007 15:04:31 +0000
Received: from news01.csr.com (localhost.localdomain [127.0.0.1])
	by news01.csr.com (8.14.1/8.13.4) with ESMTP id lBEF4V4j016380;
	Fri, 14 Dec 2007 15:04:31 GMT
Received: from csr.com (pws@localhost)
	by news01.csr.com (8.14.1/8.14.1/Submit) with ESMTP id lBEF4U2c016377;
	Fri, 14 Dec 2007 15:04:30 GMT
Message-Id: <200712141504.lBEF4U2c016377@news01.csr.com>
X-Authentication-Warning: news01.csr.com: pws owned process doing -bs
To: Pea <zsh@raveland.org>
Cc: zsh-workers@sunsite.dk (Zsh hackers list)
Subject: Re: 4.3.4-dev-4 and 4.2.6-dev-2 available
In-reply-to: <20071214151926.5beb4d28@portable.raveland.priv>
References: <22582.1197372038@csr.com> <20071213160915.4bcabae3@raveland.org> <20071213181050.55477e48@news01> <20071214104523.32bf017b@portable.raveland.priv> <200712141023.lBEANLI5001150@news01.csr.com> <20071214133035.2cf97761@portable.raveland.priv> <20071214130402.758beeb2@news01> <20071214151926.5beb4d28@portable.raveland.priv>
Comments: In-reply-to Pea <zsh@raveland.org>
   message dated "Fri, 14 Dec 2007 15:19:26 +0100."
Date: Fri, 14 Dec 2007 15:04:30 +0000
From: Peter Stephenson <pws@csr.com>
X-OriginalArrivalTime: 14 Dec 2007 15:04:31.0114 (UTC) FILETIME=[A1220EA0:01C83E62]
X-Scanned-By: MailControl A-06-00-00 (www.mailcontrol.com) on 10.71.1.121
X-Virus-Scanned: ClamAV using ClamSMTP

Pea wrote:
> > Thanks for investigating.  OK, so that has to come out for openbsd.
> > I hope the following patch does the trick:  it's a bit complicated in
> > order to ensure we get the definition before any system header files.
> 
> Thank you for your patch. It works like a charm !
> But if you don't to complicate your code, i can do a patch only for
> OpenBSD (just to remove the line #define _XOPEN_SOURCE_EXTENDED 1) (i
> am the maintainer of zsh port). Just tell me..

I'm perfectly happy to have it in the main shell; by our standards this
isn't even particularly complicated.

> I test on my two machines (@i386 and @amd64): compilation OK. But now,
> one regression test fail:
> 
> ./A03quoting.ztst: starting.
> Test ./A03quoting.ztst failed: bad status 1, expected 0 from:
>   print '<\u0041>'
>   printf '%s\n' $'<\u0042>'
>   print '<\u0043>'
>   printf '%s\n' $'<\u0044>'
> Error output:
> (eval):1: cannot do charset conversion
> Was testing: \u in both print and printf
> ./A03quoting.ztst: test failed.

Urk...  that means it hasn't found a suitable library for character set
conversion.  This isn't necessarily wrong if you actually don't have
those facilities.  The two main possibilities are

- environment supports ISO 10646 (plus wchar_t plus wctomb()).
- iconv is present (plus NLS).

See the code around line 4851 of Src/utils.c; you should be able to work
out which preprocessor tests are failing.

It's possible HAVE_WCHAR_H isn't defined if you don't have <wchar.h>
(I'm suggesting this because of the previous difficulties over finding
wchar_t).  It's possible then that wctomb() is actually somewhere else
and we don't need wchar.h at all.  Otherwise, we may have to make do
with what we've got, which compiles and is basically functioning.

-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070

