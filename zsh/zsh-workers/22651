From zsh-workers-return-22651-mason-zsh=primenet.com.au@sunsite.dk Sun Aug 20 22:18:54 2006
Return-Path: <zsh-workers-return-22651-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 1164 invoked from network); 20 Aug 2006 22:18:52 -0000
X-Spam-Checker-Version: SpamAssassin 3.1.4 (2006-07-25) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=AWL,BAYES_00,
	FORGED_RCVD_HELO autolearn=ham version=3.1.4
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 20 Aug 2006 22:18:52 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 6701 invoked from network); 20 Aug 2006 22:18:46 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 20 Aug 2006 22:18:46 -0000
Received: (qmail 18854 invoked by alias); 20 Aug 2006 22:18:42 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 22651
Received: (qmail 18844 invoked from network); 20 Aug 2006 22:18:41 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 20 Aug 2006 22:18:41 -0000
Received: (qmail 6347 invoked from network); 20 Aug 2006 22:18:41 -0000
Received: from mtaout02-winn.ispmail.ntl.com (81.103.221.48)
  by a.mx.sunsite.dk with SMTP; 20 Aug 2006 22:18:39 -0000
Received: from aamtaout02-winn.ispmail.ntl.com ([81.103.221.35])
          by mtaout02-winn.ispmail.ntl.com with ESMTP
          id <20060820221838.IOJU27023.mtaout02-winn.ispmail.ntl.com@aamtaout02-winn.ispmail.ntl.com>;
          Sun, 20 Aug 2006 23:18:38 +0100
Received: from pwslaptop.csr.com ([81.107.41.155])
          by aamtaout02-winn.ispmail.ntl.com with SMTP
          id <20060820221838.LMAY23938.aamtaout02-winn.ispmail.ntl.com@pwslaptop.csr.com>;
          Sun, 20 Aug 2006 23:18:38 +0100
Date: Sun, 20 Aug 2006 23:18:38 +0100
From: Peter Stephenson <p.w.stephenson@ntlworld.com>
To: zsh-workers@sunsite.dk, Roman Cheplyaka <roman.cheplyaka@gmail.com>
Subject: Re: completion bug in UTF-8 locale
Message-Id: <20060820231838.02e89c47.p.w.stephenson@ntlworld.com>
In-Reply-To: <20060820200808.GA4049@localdomain>
References: <20060820071833.GA3850@localdomain>
	<20060820180151.6b23348c.p.w.stephenson@ntlworld.com>
	<20060820200808.GA4049@localdomain>
X-Mailer: Sylpheed version 2.2.6 (GTK+ 2.8.20; i386-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

On Sun, 20 Aug 2006 23:08:08 +0300
Roman Cheplyaka <roman.cheplyaka@gmail.com> wrote:
> I've made some more tests. It seems to break at certain letters.. Try for
> example directory named "Ñ†" (w/o quotes). 

Aha.  That needs one of the bytes to be encoded as a "Meta" byte (it
overlaps with zsh's range of internal tokens).

That's still broken in the patches I made for listing multibyte
characters quite recently; the following should fix it.  This means it's
not surprising it's buggy in 4.3.2.

Would you be able to try it with the code currently in CVS?  Otherwise
I'll probably make a pre-4.3.3 test version shortly.

In the following patch I've assumed that any null-terminated string must
be metafied.  That's the usual rule, but nothing would surprise me about
the completion code.

Index: Src/Zle/complist.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/complist.c,v
retrieving revision 1.94
diff -u -r1.94 complist.c
--- Src/Zle/complist.c	17 Aug 2006 09:34:12 -0000	1.94
+++ Src/Zle/complist.c	20 Aug 2006 22:17:13 -0000
@@ -621,7 +621,11 @@
 	if (ml == mlend - 1 && (cc % columns) == columns - 1)
 	    return 0;
 
-	putc(*p, shout);
+	if (*p == Meta) {
+	    p++;
+	    putc(*p ^ 32, shout);
+	} else
+	    putc(*p, shout);
 	if ((beg = !(cc % columns)))
 	    ml++;
 	if (mscroll && !(cc % columns) &&
@@ -1137,8 +1141,14 @@
 		    dopr = 0;
 		    continue;
 		}
-		while (len--)
-		    putc(*p++, shout);
+		while (len--) {
+		    if (*p == Meta) {
+			len--;
+			p++;
+			putc(*p++ ^ 32, shout);
+		    } else
+			putc(*p++, shout);
+		}
 		if ((beg = !(cc % columns)) && !stat) {
 		    ml++;
                     fputs(" \010", shout);
Index: Src/Zle/zle_tricky.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/zle_tricky.c,v
retrieving revision 1.74
diff -u -r1.74 zle_tricky.c
--- Src/Zle/zle_tricky.c	20 Aug 2006 18:07:49 -0000	1.74
+++ Src/Zle/zle_tricky.c	20 Aug 2006 22:17:15 -0000
@@ -2123,9 +2123,15 @@
 			tcout(TCUNDERLINEEND);
 		    break;
 		case '{':
-		    for (p++; *p && (*p != '%' || p[1] != '}'); p++)
-			if (dopr)
+		    for (p++; *p && (*p != '%' || p[1] != '}'); p++) {
+			if (*p == Meta) {
+			    p++;
+			    if (dopr) 
+				putc(*p ^ 32, shout);
+			}
+			else if (dopr)
 			    putc(*p, shout);
+		    }
 		    if (*p)
 			p++;
 		    else
@@ -2164,8 +2170,14 @@
 		convchar_t cchar;
 		int clen = MB_METACHARLENCONV(p, &cchar);
 		if (dopr) {
-		    while (clen--)
-			putc(*p++, shout);
+		    while (clen--) {
+			if (*p == Meta) {
+			    p++;
+			    clen--;
+			    putc(*p++ ^ 32, shout);
+			} else
+			    putc(*p++, shout);
+		    }
 		} else
 		    p += clen;
 		cc += WCWIDTH(cchar);

-- 
Peter Stephenson <p.w.stephenson@ntlworld.com>
Web page now at http://homepage.ntlworld.com/p.w.stephenson/

