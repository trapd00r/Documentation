From zsh-workers-return-25931-mason-zsh=primenet.com.au@sunsite.dk Fri Oct 24 13:47:10 2008
Return-Path: <zsh-workers-return-25931-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 19529 invoked from network); 24 Oct 2008 13:47:06 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.3 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 24 Oct 2008 13:47:06 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 24951 invoked from network); 24 Oct 2008 13:46:46 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 24 Oct 2008 13:46:46 -0000
Received: (qmail 240 invoked by alias); 24 Oct 2008 13:46:38 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 25931
Received: (qmail 176 invoked from network); 24 Oct 2008 13:46:34 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 24 Oct 2008 13:46:34 -0000
Received: from cluster-g.mailcontrol.com (cluster-g.mailcontrol.com [208.87.233.190])
	by bifrost.dotsrc.org (Postfix) with ESMTPS id ADD9280524C5
	for <zsh-workers@sunsite.dk>; Fri, 24 Oct 2008 15:46:29 +0200 (CEST)
Received: from cameurexb01.EUROPE.ROOT.PRI ([193.128.72.68])
	by rly16g.srv.mailcontrol.com (MailControl) with ESMTP id m9ODkJOo026741
	for <zsh-workers@sunsite.dk>; Fri, 24 Oct 2008 14:46:20 +0100
Received: from news01 ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.3959);
	 Fri, 24 Oct 2008 14:46:19 +0100
Date: Fri, 24 Oct 2008 14:46:14 +0100
From: Peter Stephenson <pws@csr.com>
To: zsh-workers@sunsite.dk (Zsh hackers list)
Subject: Re: PATCH: prompt memory handling is screwy
Message-ID: <20081024144614.2add8990@news01>
In-Reply-To: <19776.1224843888@csr.com>
References: <19776.1224843888@csr.com>
Organization: CSR
X-Mailer: Claws Mail 3.5.0 (GTK+ 2.12.8; i386-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
X-OriginalArrivalTime: 24 Oct 2008 13:46:19.0247 (UTC) FILETIME=[E4AF37F0:01C935DE]
X-Scanned-By: MailControl A-08-50-15 (www.mailcontrol.com) on 10.71.0.126
X-Virus-Scanned: ClamAV 0.92.1/8484/Fri Oct 24 15:33:12 2008 on bifrost
X-Virus-Status: Clean

On Fri, 24 Oct 2008 11:24:48 +0100
Peter Stephenson <pws@csr.com> wrote:
> Some idiot added a new feature recently that let the prompt code
> be called recursively.  Currently the prompt code isn't written to
> be called recursively, but luckily that's a fairly straightforward
> change, if boring to rename all the variables.

Here's a test.  This is actually more hairy even than the fix:  since I'm
testing directory handling I need to output directories and remove the
bits of the path that vary.  Hence if it fails it may well be the test, not
the shell.  This was giving segmentation violations before the patch.

Index: Test/D01prompt.ztst
===================================================================
RCS file: /cvsroot/zsh/zsh/Test/D01prompt.ztst,v
retrieving revision 1.4
diff -u -r1.4 D01prompt.ztst
--- Test/D01prompt.ztst	26 Sep 2008 09:11:30 -0000	1.4
+++ Test/D01prompt.ztst	24 Oct 2008 13:33:06 -0000
@@ -147,3 +147,57 @@
 >~[scuzzy]/rubbish
 >~mydir/foo
 ?(eval):33: no directory expansion: ~[scuzzy]
+
+  (
+  zsh_directory_name() {
+  emulate -L zsh
+  setopt extendedglob
+  local -a match mbegin mend
+  if [[ $1 = n ]]; then
+      if [[ $2 = *:l ]]; then
+	  reply=(${2%%:l}/very_long_directory_name)
+	  return 0
+      else
+	  return 1
+      fi
+  else
+      if [[ $2 = (#b)(*)/very_long_directory_name ]]; then
+	reply=(${match[1]}:l ${#2})
+	return 0
+      else
+	return 1
+      fi
+  fi
+  }
+  parent=$PWD
+  dir=$parent/very_long_directory_name
+  mkdir $dir
+  cd $dir
+  fn() {
+     PS4='+%N:%i> '
+     setopt localoptions xtrace
+     # The following is the key to the test.
+     # It invokes zsh_directory_name which does PS4 output stuff
+     # while we're doing prompt handling for the parameter
+     # substitution.  This checks recursion works OK.
+     local d=${(%):-%~}
+     print ${d//$parent/\<parent\>}
+  }
+  fn 2>stderr
+  # post process error to remove variable contents
+  while read line; do
+    # tricky: reply is set to include directory length which is variable
+    [[ $line = *reply* ]] && continue
+    print ${line//$parent/\<parent\>}
+  done <stderr >&2
+  )
+0:Recursive use of prompts
+>~[<parent>:l]
+?+zsh_directory_name:1> emulate -L zsh
+?+zsh_directory_name:2> setopt extendedglob
+?+zsh_directory_name:3> local -a match mbegin mend
+?+zsh_directory_name:4> [[ d == n ]]
+?+zsh_directory_name:12> [[ <parent>/very_long_directory_name == (#b)(*)/very_long_directory_name ]]
+?+zsh_directory_name:14> return 0
+?+fn:7> local 'd=~[<parent>:l]'
+?+fn:8> print '~[<parent>:l]'

-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070

