From zsh-users-return-12127-mason-zsh=primenet.com.au@sunsite.dk Fri Oct 26 14:18:47 2007
Return-Path: <zsh-users-return-12127-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 10996 invoked from network); 26 Oct 2007 14:18:37 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.3 (2007-08-08) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.3
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 26 Oct 2007 14:18:37 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 69749 invoked from network); 26 Oct 2007 14:18:31 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 26 Oct 2007 14:18:31 -0000
Received: (qmail 18697 invoked by alias); 26 Oct 2007 14:18:22 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 12127
Received: (qmail 18677 invoked from network); 26 Oct 2007 14:18:21 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 26 Oct 2007 14:18:21 -0000
Received: (qmail 68486 invoked from network); 26 Oct 2007 14:18:21 -0000
Received: from smtpout0151.sc1.he.tucows.com (HELO n064.sc1.he.tucows.com) (64.97.136.151)
  by a.mx.sunsite.dk with SMTP; 26 Oct 2007 14:18:15 -0000
Received: from sc.homeunix.net (82.26.174.233) by n064.sc1.he.tucows.com (7.2.069.1)
        id 47030C3D001B6732; Fri, 26 Oct 2007 14:17:56 +0000
Received: from chazelas by sc.homeunix.net with local (Exim 4.68)
	(envelope-from <stephane_chazelas@yahoo.fr>)
	id 1IlQ0U-0003tj-5v; Fri, 26 Oct 2007 15:17:50 +0100
Date: Fri, 26 Oct 2007 15:17:50 +0100
From: Stephane Chazelas <Stephane_Chazelas@yahoo.fr>
To: Peter Stephenson <pws@csr.com>, Zsh Users List <zsh-users@sunsite.dk>
Subject: Re: fc in non-interactive shells and vared
Message-ID: <20071026141749.GC5475@sc.homeunix.net>
Mail-Followup-To: Peter Stephenson <pws@csr.com>,
	Zsh Users List <zsh-users@sunsite.dk>
References: <20071026131442.GA5475@sc.homeunix.net> <200710261327.l9QDRd9b003931@news01.csr.com> <20071026134352.GB5475@sc.homeunix.net>
MIME-Version: 1.0
Content-Type: multipart/mixed; boundary="TB36FDmn/VVEgNH/"
Content-Disposition: inline
Content-Transfer-Encoding: 8bit
In-Reply-To: <20071026134352.GB5475@sc.homeunix.net>
User-Agent: Mutt/1.5.16 (2007-09-19)


--TB36FDmn/VVEgNH/
Content-Type: text/plain; charset=iso-8859-15
Content-Disposition: inline
Content-Transfer-Encoding: 8bit

On Fri, Oct 26, 2007 at 02:43:52PM +0100, Stephane Chazelas wrote:
[...]
> > zle-line-init() { stty onlret; }
> > zle -N zle-line-init
> [...]
> 
> I realised it wouldn't work anyway, I had misinterpreted what
> onlret was doing. I just found another work around, I do
> something like:
> 
>   accept-and-bye() {
>     print -r -- "$BUFFER"
>     stat +link -A pid /proc/self
>     trap - TERM
>     kill $pid
>   }
>   zle -N accept-and-bye
>   bindkey '\r' accept-and-bye
>   bindkey '\n' accept-and-bye
>   a=
>   search=$(vared -p "Search: " -eh a)
> 
> The /proc/self above makes it Linux specific though (exit
> doesn't work: NL is still displayed).
> 
> I'll do more experiments by running zsh -c so that I can use $$.
[...]

I could combine both solutions, it now works perfectly thanks to
your help.

I used:

search=$(
  histfile=$histfile zsh -ic '
  bindkey -e
  send-break() {
    print "<BREAK>"
    kill -HUP $$
  }
  accept-line() {
    print -r -- "$BUFFER"
    print -rs -- "$BUFFER"
    fc -P
    kill -HUP $$
  }
  zle -N accept-line
  zle -N send-break
  fc -p -a "$histfile" 100
  a=; vared -p "Search: " -eh a'
)

I found that HUP worked best. TERM doesn't do anything and USR1
nukes the terminal for some reason (?!).

See script attached.

Next step is to add completion (based on the output of mairix
-d).

-- 
Stéphane

--TB36FDmn/VVEgNH/
Content-Type: text/plain; charset=iso-8859-15
Content-Disposition: attachment; filename=mutt-mairix

#! /bin/sh -
# require a POSIX sh, on those systems where the POSIX sh is not in /bin
# (like Solaris), you may need to adapt the shebang line above
# (/usr/xpg4/bin/sh on Solaris). You also need a terminfo aware "tput",
# ncurses one (the default on most systems) will do.

# wrapper around mairix, the mail indexing/searching utility for mutt.
# in your ~/.muttrc:
# macro generic S "<enter-command>set my_cmd = \`mutt-mairix\`<return><enter-command>push \$my_cmd<return>"
# we're not using <shell-escape> because we want to prompt the user in
# mutt's prompt area and still have mutt's index visible.

mairix_base=~/local/Mail/.mairix
histfile=$mairix_base/cmdhist

# mairix result folder in mutt folder syntax:
mfolder=+.mairix/mfolder

set -f

# restore stdin/stdout to the terminal, fd 3 goes to mutt's backticks.
exec < /dev/tty 3>&1 > /dev/tty

# save tty settings before modifying them
saved_tty_settings=$(stty -g)

trap '
    printf "\r"; tput ed; tput rc
    printf "<refresh>" >&3
    stty "$saved_tty_settings"
    exit
' INT TERM

# retrieve the size of the screen.
set $(stty size)

# save cursor position:
tput sc

# go to last line of the screen
tput cup "$1" 0

# Clear and write prompt.
tput ed

cmd="<refresh>"

search=$(
  histfile=$histfile zsh -ic '
  bindkey -e
  send-break() {
    print "<BREAK>"
    kill -HUP $$
  }
  accept-line() {
    print -r -- "$BUFFER"
    print -rs -- "$BUFFER"
    fc -P
    kill -HUP $$
  }
  zle -N accept-line
  zle -N send-break
  fc -p -a "$histfile" 100
  a=; vared -p "Search: " -eh a'
)

if [ "$?" -ne 138 ]; then
  case $search in
    ("<BREAK>") ;;
    ("")
      # rebuild the index
      mairix -F > /dev/null &
      ;;
    (+*)
      # append mode
      mairix -a ${search#+} > /dev/null &
      cmd="<refresh><change-folder-readonly>$mfolder<return>"
      ;;
    (*)
      mairix $search > /dev/null &
      cmd="<refresh><change-folder-readonly>$mfolder<return>"
      ;;
  esac
fi

# clear our mess
printf '\r'; tput ed

# restore cursor position
tput rc

# and tty settings
stty "$saved_tty_settings"

printf %s "$cmd" >&3

--TB36FDmn/VVEgNH/--

