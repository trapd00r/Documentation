From zsh-users-return-11399-mason-zsh=primenet.com.au@sunsite.dk Sun Apr 15 20:59:40 2007
Return-Path: <zsh-users-return-11399-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 24868 invoked from network); 15 Apr 2007 20:59:38 -0000
X-Spam-Checker-Version: SpamAssassin 3.1.8 (2007-02-13) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=BAYES_00,FORGED_RCVD_HELO
	autolearn=ham version=3.1.8
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 15 Apr 2007 20:59:38 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 37459 invoked from network); 15 Apr 2007 20:59:32 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 15 Apr 2007 20:59:32 -0000
Received: (qmail 19447 invoked by alias); 15 Apr 2007 20:59:18 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 11399
Received: (qmail 19435 invoked from network); 15 Apr 2007 20:59:15 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 15 Apr 2007 20:59:15 -0000
Received: (qmail 36004 invoked from network); 15 Apr 2007 20:59:15 -0000
Received: from wr-out-0506.google.com (64.233.184.234)
  by a.mx.sunsite.dk with SMTP; 15 Apr 2007 20:59:12 -0000
Received: by wr-out-0506.google.com with SMTP id i28so1314454wra
        for <zsh-users@sunsite.dk>; Sun, 15 Apr 2007 13:59:11 -0700 (PDT)
DKIM-Signature: a=rsa-sha1; c=relaxed/relaxed;
        d=gmail.com; s=beta;
        h=domainkey-signature:received:received:message-id:date:from:to:subject:cc:in-reply-to:mime-version:content-type:content-transfer-encoding:content-disposition:references;
        b=hGf9QDzjXKKKE1aoBXrdc2Nmv69sAvxsTUrIUibnNWRVz2VvUGxegzUD0/zQkX1Gng5BmxIDVaVV+QnoVQ0gnwfyfxe2aSUYoppHssR935/KW8foysWa6JpBYNyP+Ufa0dcTLf/ZTEnu4BVxFZM/T9YCE0QVB9zVYpnyK4QaHfI=
DomainKey-Signature: a=rsa-sha1; c=nofws;
        d=gmail.com; s=beta;
        h=received:message-id:date:from:to:subject:cc:in-reply-to:mime-version:content-type:content-transfer-encoding:content-disposition:references;
        b=f5/f0XZmjPk3t2wfq1ZjjOZOe3d8Crif7xRwI8bZXcA3C8Sn9Z8hy1+Vu8mDsg4o5vIhaVv1WD+2Q4vHniaZ0+pwnH3LaH2SAQhPB4a0w3ot9cRFtdKltNLy5kVyx8297kKY3GL7PYxeQjkpkXriAt1hy77eBtMrN3oU9/w+F+E=
Received: by 10.114.78.1 with SMTP id a1mr586274wab.1176670750909;
        Sun, 15 Apr 2007 13:59:10 -0700 (PDT)
Received: by 10.115.108.15 with HTTP; Sun, 15 Apr 2007 13:59:10 -0700 (PDT)
Message-ID: <fb3648c60704151359u6d209925y3f99ead6dc75d2a1@mail.gmail.com>
Date: Sun, 15 Apr 2007 15:59:10 -0500
From: fREW <frioux@gmail.com>
To: "Peter Stephenson" <p.w.stephenson@ntlworld.com>
Subject: Re: Problems with vi-goto-mark and vi-set-mark
Cc: "Zsh users list" <zsh-users@sunsite.dk>
In-Reply-To: <200704151953.l3FJrjRg003045@pwslaptop.csr.com>
MIME-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1; format=flowed
Content-Transfer-Encoding: 7bit
Content-Disposition: inline
References: <f.rosencrantz@gmail.com>
	 <dc507f4a0704150949p39a6fd4bleb56f7d7c00cd1e9@mail.gmail.com>
	 <200704151953.l3FJrjRg003045@pwslaptop.csr.com>

On 4/15/07, Peter Stephenson <p.w.stephenson@ntlworld.com> wrote:
> "Felix Rosencrantz" wrote:
> > I've recently been trying to use viins/vicmd mode.  I've hit a small
> > problem with the vi-set-mark and vi-goto-mark, they seem to be broken
> > in the latest version of zsh.  Though it looks like it was working in
> > 4.2.5.
>
> Yes, I don't use vi mode so don't notice this sort of thing.  We could
> do with someone writing interactive tests for zle commands.  We could
> also do with someone to look after vi mode.  We could do with people
> doing a lot of things.
>
> The change is that getchar() used not to set the last character, which
> was done at a higher level, but the replacements which support multibyte
> do (even if multibyte mode isn't compiled in).  This means the character
> read is always treated as if it was the same as the last character.
>
> I think the following fixes it, but I'm not sure what the feature is in
> vi-goto-mark that has the special behaviour if the last character is
> repeated.  If you know and can test it, please do.
>
> Index: Src/Zle/zle.h
> ===================================================================
> RCS file: /cvsroot/zsh/zsh/Src/Zle/zle.h,v
> retrieving revision 1.34
> diff -u -r1.34 zle.h
> --- Src/Zle/zle.h       3 Dec 2006 21:07:18 -0000       1.34
> +++ Src/Zle/zle.h       15 Apr 2007 19:22:16 -0000
> @@ -72,6 +72,7 @@
>  #define ZC_toupper towupper
>
>  #define LASTFULLCHAR   lastchar_wide
> +#define LASTFULLCHAR_T  ZLE_INT_T
>
>  #else  /* Not MULTIBYTE_SUPPORT: old single-byte code */
>
> @@ -130,6 +131,7 @@
>  #define ZC_toupper tuupper
>
>  #define LASTFULLCHAR   lastchar
> +#define LASTFULLCHAR_T int
>
>  #endif
>
> Index: Src/Zle/zle_move.c
> ===================================================================
> RCS file: /cvsroot/zsh/zsh/Src/Zle/zle_move.c,v
> retrieving revision 1.8
> diff -u -r1.8 zle_move.c
> --- Src/Zle/zle_move.c  1 Nov 2005 02:50:29 -0000       1.8
> +++ Src/Zle/zle_move.c  15 Apr 2007 19:22:16 -0000
> @@ -484,9 +484,10 @@
>  vigotomark(UNUSED(char **args))
>  {
>      ZLE_INT_T ch;
> +    LASTFULLCHAR_T lfc = LASTFULLCHAR;
>
>      ch = getfullchar(0);
> -    if (ch == LASTFULLCHAR)
> +    if (ch == lfc)
>         ch = 26;
>      else {
>         if (ch < ZWC('a') || ch > ZWC('z'))
>
> --
> Peter Stephenson <p.w.stephenson@ntlworld.com>
> Web page now at http://homepage.ntlworld.com/p.w.stephenson/
>

Do you have any examples of how one could make zle unit tests?  I
would gladly do it depending on how much time I end up having this
summer.

-fREW

