From zsh-workers-return-13226-mason-zsh=primenet.com.au@sunsite.auc.dk Mon Dec 04 19:13:25 2000
Return-Path: <zsh-workers-return-13226-mason-zsh=primenet.com.au@sunsite.auc.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 13418 invoked from network); 4 Dec 2000 19:13:24 -0000
Received: from sunsite.dk (HELO sunsite.auc.dk) (130.225.51.30)
  by ns1.primenet.com.au with SMTP; 4 Dec 2000 19:13:24 -0000
Received: (qmail 21029 invoked by alias); 4 Dec 2000 19:13:12 -0000
Mailing-List: contact zsh-workers-help@sunsite.auc.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.auc.dk
X-Seq: 13226
Received: (qmail 21022 invoked from network); 4 Dec 2000 19:13:10 -0000
Date: Mon, 04 Dec 2000 19:12:42 +0000
From: Peter Stephenson <pws@csr.com>
Subject: Re: PATCH: function install
In-reply-to: "Your message of Mon, 04 Dec 2000 10:47:36 GMT."
 <0G510002YHZB9B@la-la.cambridgesiliconradio.com>
To: zsh-workers@sunsite.auc.dk (Zsh hackers list)
Message-id: <0G5200H255D5QL@la-la.cambridgesiliconradio.com>
Content-transfer-encoding: 7BIT

I nearly wrote:
> Yow!  I have seen the SUBDIRS!

This should fix it, with the change that Completion is now installed as a
subdirectory under ..../functions.  I've even tested it this time.
The first hunk is tangentially related paranoia; the second got missed out
the first time round.

Index: configure.in
===================================================================
RCS file: /cvsroot/zsh/zsh/configure.in,v
retrieving revision 1.35
diff -u -r1.35 configure.in
--- configure.in	2000/11/30 18:36:21	1.35
+++ configure.in	2000/12/04 19:07:26
@@ -1744,7 +1744,7 @@
                 grep "^name=$name " ${CONFIG_MODULES}.old
 		;;
     *) case "$link" in
-	  *\ *) eval 'link=`'$link'`'
+	  *\ *) eval "link=\`$link\`"
 	       ;;
        esac
        case "${load}" in
Index: Config/defs.mk.in
===================================================================
RCS file: /cvsroot/zsh/zsh/Config/defs.mk.in,v
retrieving revision 1.3
diff -u -r1.3 defs.mk.in
--- Config/defs.mk.in	2000/11/26 20:01:02	1.3
+++ Config/defs.mk.in	2000/12/04 19:07:26
@@ -74,7 +74,6 @@
 INSTALL_DATA    = @INSTALL_DATA@
 
 # variables used in determining what to install
-FUNCTIONS_INSTALL = @FUNCTIONS_INSTALL@
 FUNCTIONS_SUBDIRS = @FUNCTIONS_SUBDIRS@
 
 # flags passed to recursive makes in subdirectories
Index: Config/installfns.sh
===================================================================
RCS file: /cvsroot/zsh/zsh/Config/installfns.sh,v
retrieving revision 1.3
diff -u -r1.3 installfns.sh
--- Config/installfns.sh	2000/12/04 12:02:31	1.3
+++ Config/installfns.sh	2000/12/04 19:07:26
@@ -14,8 +14,7 @@
 for file in $allfuncs; do
   if test -f $sdir_top/$file; then
     if test x$FUNCTIONS_SUBDIRS != x -a x$FUNCTIONS_SUBDIRS != xno; then
-      subdir="`echo $file | sed -e 's%/[^/]*$%%' \
-		-e s%^Functions/%% -e s%^Completion/%%`"
+      subdir="`echo $file | sed -e 's%/[^/]*$%%' -e 's%^Functions/%%'`"
       instdir="$fndir/$subdir"
     else
       instdir="$fndir"
Index: Config/uninstallfns.sh
===================================================================
RCS file: /cvsroot/zsh/zsh/Config/uninstallfns.sh,v
retrieving revision 1.2
diff -u -r1.2 uninstallfns.sh
--- Config/uninstallfns.sh	2000/11/30 18:36:23	1.2
+++ Config/uninstallfns.sh	2000/12/04 19:07:26
@@ -24,7 +24,7 @@
      for file in $allfuncs; do
        if test -f $sdir_top/$file; then
 	 if test x$FUNCTIONS_SUBDIRS != x -a x$FUNCTIONS_SUBDIRS != xno; then
-	   file=`echo $file | sed -e 's%%^Completion/%' -e 's%%^Functions%'`
+	   file=`echo $file | sed -e 's%%^Functions/%'`
 	   rm -f $fndir/$file;
 	 else
 	   bfile="`echo $file | sed -e 's%^.*/%%'`"
Index: Src/zsh.mdd
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/zsh.mdd,v
retrieving revision 1.5
diff -u -r1.5 zsh.mdd
--- Src/zsh.mdd	2000/11/30 18:36:23	1.5
+++ Src/zsh.mdd	2000/12/04 19:07:27
@@ -45,10 +45,13 @@
 	  echo '#define FPATH_DIR "'$(fndir)'"' >> zshpaths.h.tmp; \
 	  if test x$(FUNCTIONS_SUBDIRS) != x -a \
 	  x$(FUNCTIONS_SUBDIRS) != xno; then \
-	    fpath_tmp="`for f in $$FUNCTIONS_INSTALL; do \
-	      echo $$f | sed s%/.*%%; \
-	    done | sort | uniq`"; \
-	    fpath_tmp="`echo $$fpath_tmp | sed 's/ /\", \"/g'`"; \
+	    fpath_tmp="`grep ' functions=.' \
+	    $(dir_top)/config.modules | sed -e '/^#/d' -e '/ link=no/d' \
+	    -e 's/^.* functions=//'`"; \
+	    fpath_tmp=`for f in $$fpath_tmp; do \
+	      echo $$f | sed -e 's%^Functions/%%' -e 's%/[^/]*$$%%'; \
+	    done | sort | uniq`; \
+	    fpath_tmp=`echo $$fpath_tmp | sed 's/ /\", \"/g'`; \
 	    echo "#define FPATH_SUBDIRS { \"$$fpath_tmp\" }" \
 	    >>zshpaths.h.tmp; \
 	  fi; \

-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
Cambridge Silicon Radio, Unit 300, Science Park, Milton Road,
Cambridge, CB4 0XL, UK                          Tel: +44 (0)1223 392070

