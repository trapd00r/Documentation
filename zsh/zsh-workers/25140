From zsh-workers-return-25140-mason-zsh=primenet.com.au@sunsite.dk Mon Jun 09 21:39:51 2008
Return-Path: <zsh-workers-return-25140-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 5326 invoked from network); 9 Jun 2008 21:39:48 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.4 (2008-01-01) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.4
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 9 Jun 2008 21:39:48 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 71609 invoked from network); 9 Jun 2008 21:38:46 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 9 Jun 2008 21:38:46 -0000
Received: (qmail 18243 invoked by alias); 9 Jun 2008 21:38:22 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 25140
Received: (qmail 18208 invoked from network); 9 Jun 2008 21:38:20 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 9 Jun 2008 21:38:20 -0000
Received: from vms173005pub.verizon.net (vms173005pub.verizon.net [206.46.173.5])
	by bifrost.dotsrc.org (Postfix) with ESMTP id D32BF8028AC3
	for <zsh-workers@sunsite.dk>; Mon,  9 Jun 2008 23:38:15 +0200 (CEST)
Received: from torch.brasslantern.com ([71.121.11.8])
 by vms173005.mailsrvcs.net
 (Sun Java System Messaging Server 6.2-6.01 (built Apr  3 2006))
 with ESMTPA id <0K2400HRK0T8O0RU@vms173005.mailsrvcs.net> for
 zsh-workers@sunsite.dk; Sat, 07 Jun 2008 15:27:10 -0500 (CDT)
Received: from torch.brasslantern.com (localhost.localdomain [127.0.0.1])
	by torch.brasslantern.com (8.13.1/8.13.1) with ESMTP id m57KXhTs003359; Sat,
 07 Jun 2008 13:33:44 -0700
Received: (from schaefer@localhost)	by torch.brasslantern.com
 (8.13.1/8.13.1/Submit) id m57KXgDD003358; Sat, 07 Jun 2008 13:33:42 -0700
Date: Sat, 07 Jun 2008 13:33:42 -0700
From: Bart Schaefer <schaefer@brasslantern.com>
Subject: Re: Problem with zkbd
In-reply-to: <2d460de70806071303k4ed3bf76t20a4e7ff4135eb84@mail.gmail.com>
To: "Richard Hartmann" <richih.mailinglist@gmail.com>
Cc: zsh-workers@sunsite.dk
Message-id: <080607133342.ZM3357@torch.brasslantern.com>
MIME-version: 1.0
X-Mailer: OpenZMail Classic (0.9.2 24April2005)
Content-type: text/plain; charset=us-ascii
References: <20080526214815.3f5dc00a@ate.itt.uni-stuttgart.de>
	<20080526220401.34c1061d@ate.itt.uni-stuttgart.de>
	<080526140618.ZM8949@torch.brasslantern.com>
	<2d460de70806071303k4ed3bf76t20a4e7ff4135eb84@mail.gmail.com>
Comments: In reply to "Richard Hartmann" <richih.mailinglist@gmail.com>
 "Re: Problem with zkbd" (Jun  7, 10:03pm)
X-Virus-Scanned: ClamAV 0.92.1/7415/Mon Jun  9 20:07:23 2008 on bifrost
X-Virus-Status: Clean

On Jun 7, 10:03pm, Richard Hartmann wrote:
}
} > bash: cannot create temp file for here document: Permission denied
} 
} May I suggest changing the error message to be more verbose?

I think the reason it's not more verbose already is, given the way the
code is structured, it might be an error opening, writing, or closing
the file, and we don't know which.

However, we can probably fudge it in the same way bash seems to have.  In
fact, we should emit the error a bit sooner to prevent other possible
errors from changing errno.

Index: Src/exec.c
--- ../zsh-forge/current/Src/exec.c	2008-05-11 13:01:14.000000000 -0700
+++ Src/exec.c	2008-06-07 13:32:40.000000000 -0700
@@ -2736,10 +2736,11 @@
 		else
 		    fil = getherestr(fn);
 		if (fil == -1) {
+		    if (errno && errno != EINTR)
+			zwarn("can't create temp file for here document: %e",
+			      errno);
 		    closemnodes(mfds);
 		    fixfds(save);
-		    if (errno && errno != EINTR)
-			zwarn("%e", errno);
 		    execerr();
 		}
 		addfd(forked, save, mfds, fn->fd1, fil, 0, fn->varid);

