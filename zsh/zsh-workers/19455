From zsh-workers-return-19455-mason-zsh=primenet.com.au@sunsite.dk Fri Feb 20 10:40:45 2004
Return-Path: <zsh-workers-return-19455-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 12510 invoked from network); 20 Feb 2004 10:40:44 -0000
Received: from sunsite.dk (130.225.247.90)
  by ns1.primenet.com.au with SMTP; 20 Feb 2004 10:40:44 -0000
Received: (qmail 4871 invoked by alias); 20 Feb 2004 10:40:30 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 19455
Received: (qmail 4837 invoked from network); 20 Feb 2004 10:40:29 -0000
Received: from localhost (HELO sunsite.dk) (127.0.0.1)
  by localhost with SMTP; 20 Feb 2004 10:40:29 -0000
X-MessageWall-Score: 0 (sunsite.dk)
Received: from [193.109.254.211] by sunsite.dk (MessageWall 1.0.8) with SMTP; 20 Feb 2004 10:40:28 -0000
X-VirusChecked: Checked
X-Env-Sender: okiddle@yahoo.co.uk
X-Msg-Ref: server-5.tower-36.messagelabs.com!1077273627!4046817
X-StarScan-Version: 5.2.5; banners=-,-,-
X-Originating-IP: [158.234.9.163]
Received: (qmail 30987 invoked from network); 20 Feb 2004 10:40:27 -0000
Received: from iris.logica.co.uk (158.234.9.163)
  by server-5.tower-36.messagelabs.com with SMTP; 20 Feb 2004 10:40:27 -0000
Received: from trentino.logica.co.uk ([158.234.142.61])
	by iris.logica.co.uk (8.12.3/8.12.3/Debian -4) with ESMTP id i1KAeRkb011932
	for <zsh-workers@sunsite.dk>; Fri, 20 Feb 2004 10:40:27 GMT
Received: from trentino.logica.co.uk (localhost [127.0.0.1])
	by trentino.logica.co.uk (Postfix) with ESMTP id EFC0C79250F6
	for <zsh-workers@sunsite.dk>; Fri, 20 Feb 2004 11:39:42 +0100 (CET)
X-VirusChecked: Checked
X-StarScan-Version: 5.1.13; banners=.,-,-
From: Oliver Kiddle <okiddle@yahoo.co.uk>
To: Zsh workers <zsh-workers@sunsite.dk>
Subject: PATCH: complete nfs mounts in _mount
Date: Fri, 20 Feb 2004 11:39:42 +0100
Message-ID: <3470.1077273582@trentino.logica.co.uk>

Mount completion now completes hostnames with devices and uses showmount
to find out exported filesystems on the remote host.

Index: Completion/Unix/Command/_mount
===================================================================
RCS file: /cvsroot/zsh/zsh/Completion/Unix/Command/_mount,v
retrieving revision 1.17
diff -u -r1.17 _mount
--- Completion/Unix/Command/_mount	16 Dec 2003 16:23:12 -0000	1.17
+++ Completion/Unix/Command/_mount	20 Feb 2004 10:28:38 -0000
@@ -750,6 +750,17 @@
 devordir)
   local dev_tmp mp_tmp mline
 
+  if compset -P '*:'; then
+    _wanted exports expl 'exported path' compadd \
+	${${(f)"$(path+=( {/usr,}/sbin(N) ) _call_program exports \
+	showmount -e ${IPREFIX%:} 2>/dev/null)"}[2,-1]%% *} && ret=0
+    return ret
+  fi
+  if compset -S ':*'; then
+    _hosts -S '' && ret=0
+    return ret
+  fi
+
   case "$OSTYPE" in
   freebsd*)
     while read mline; do 
@@ -767,6 +778,7 @@
     done < /etc/fstab
 
     _alternative \
+      'hosts:host:_hosts -S :' \
       'devices:device:compadd -a dev_tmp' \
       'directories:mount point:compadd -a mp_tmp' && ret=0
     ;;
@@ -774,7 +786,9 @@
     if (( ${${(s.,.)opt_args[-o]}[(I)loop(|=*)]} )) ; then
       _wanted device-files expl 'loop device file' _files && ret=0
     else
-      _wanted files expl 'device or mount point' _files -g "*(-%,-/)" && ret=0
+      _alternative \
+        'hosts:host:_hosts -S :' \
+        'files:device or mount point:_files -g "*(-%b,-/)"' && ret=0
     fi
     ;;
   esac

