From zsh-workers-return-21194-mason-zsh=primenet.com.au@sunsite.dk Tue Apr 26 03:49:39 2005
Return-Path: <zsh-workers-return-21194-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 24010 invoked from network); 26 Apr 2005 03:49:38 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 26 Apr 2005 03:49:38 -0000
Received: (qmail 78130 invoked from network); 26 Apr 2005 03:49:31 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 26 Apr 2005 03:49:31 -0000
Received: (qmail 5023 invoked by alias); 26 Apr 2005 03:49:28 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 21194
Received: (qmail 5009 invoked from network); 26 Apr 2005 03:49:27 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 26 Apr 2005 03:49:27 -0000
Received: (qmail 77856 invoked from network); 26 Apr 2005 03:49:27 -0000
Received: from vms048pub.verizon.net (206.46.252.48)
  by a.mx.sunsite.dk with SMTP; 26 Apr 2005 03:49:21 -0000
Received: from candle.brasslantern.com ([4.11.1.68])
 by vms048.mailsrvcs.net (Sun Java System Messaging Server 6.2 HotFix 0.04
 (built Dec 24 2004)) with ESMTPA id <0IFJ00A89BY65I9E@vms048.mailsrvcs.net> for
 zsh-workers@sunsite.dk; Mon, 25 Apr 2005 22:49:20 -0500 (CDT)
Received: from candle.brasslantern.com (IDENT:schaefer@localhost [127.0.0.1])
	by candle.brasslantern.com (8.12.11/8.12.11) with ESMTP id j3Q3nHCJ026794;
 Mon, 25 Apr 2005 20:49:17 -0700
Received: (from schaefer@localhost)	by candle.brasslantern.com
 (8.12.11/8.12.11/Submit) id j3Q3nHbp026793; Mon, 25 Apr 2005 20:49:17 -0700
Date: Tue, 26 Apr 2005 03:49:16 +0000
From: Bart Schaefer <schaefer@brasslantern.com>
Subject: Re: [mpol@charybda.icm.edu.pl: Bug#306346: zsh: replacement seems
 broken in prompt]
In-reply-to: <20050426013716.GA3958@scowler.net>
To: zsh-workers@sunsite.dk
Cc: 306346-forwarded@bugs.debian.org
Message-id: <1050426034916.ZM26792@candle.brasslantern.com>
MIME-version: 1.0
X-Mailer: Z-Mail (5.0.0 30July97)
Content-type: text/plain; charset=us-ascii
References: <20050426013716.GA3958@scowler.net>
Comments: In reply to Clint Adams <schizo@debian.org>
 "[mpol@charybda.icm.edu.pl: Bug#306346: zsh: replacement seems broken in
 prompt]" (Apr 25,  9:37pm)
X-Spam-Checker-Version: SpamAssassin 3.0.2 on a.mx.sunsite.dk
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=6.0 tests=AWL,BAYES_00 autolearn=ham 
	version=3.0.2
X-Spam-Hits: -2.6

On Apr 25,  9:37pm, Clint Adams wrote:
} Subject: [mpol@charybda.icm.edu.pl: Bug#306346: zsh: replacement seems bro
}
} This is with 21170.
} 
} ----- Forwarded message from Michal Politowski <mpol@charybda.icm.edu.pl> -----
} 
} ${${foo}/?*/replacement} puts replacement in the prompt even when foo is empty

Hrm.  This seems to be strictly a promptsubst thing, because

schaefer<505> echo ${${foo}/?*/replacement}

schaefer<506> RPS1='${${foo}/?*/replacement}'
schaefer<507> setopt promptsubst                       ${${foo}/?*/replacement}
schaefer<508>                                                       replacement

Ah, here's an easier way to reproduce it:

schaefer<510> echo "${${foo}/?*/replacement}"
replacement

So it's a quoting thing.

According to GDB, both before and after 21170 the inner ${foo} is
resulting in "\233\0" (which is a Nularg).  After 21170, however, the
comparison against ?* matches this as one character.

The problem is here at line 2344:

2344                        if (pattrylen(p, t, s + l - t, umlen, ioff)) {

And it seems that this is the answer to the question in pattern.c:

    /* inherited from domatch, but why, exactly? */
    if (*string == Nularg)
	string++;

This is precisely the case we're encountering here; it changes the value
of unmetalen within pattryrefs() in a way that we're not changing it
when precomputing it in igetmatch().

What I don't know, though, is whether the Nularg test should be copied
into both igetmatch() and down to by the ztrsub() call in pattryrefs(),
or whether it should simply be

    /* inherited from domatch, but why, exactly? */
    if (*string == Nularg)
	string++, unmetalen--;

