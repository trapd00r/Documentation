From zsh-workers-return-28544-mason-zsh=primenet.com.au@zsh.org Mon Dec 20 21:29:35 2010
Return-Path: <zsh-workers-return-28544-mason-zsh=primenet.com.au@zsh.org>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 14904 invoked by alias); 20 Dec 2010 21:29:35 -0000
Mailing-List: contact zsh-workers-help@zsh.org; run by ezmlm
Precedence: bulk
X-No-Archive: yes
List-Id: Zsh Workers List <zsh-workers.zsh.org>
List-Post: <mailto:zsh-workers@zsh.org>
List-Help: <mailto:zsh-workers-help@zsh.org>
Delivered-To: mailing list zsh-workers@zsh.org
X-Seq: 28544
Received: (qmail 23066 invoked from network); 20 Dec 2010 21:29:33 -0000
X-Spam-Checker-Version: SpamAssassin 3.3.1 (2010-03-16) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-1.9 required=5.0 tests=BAYES_00 autolearn=ham
	version=3.3.1
Received-SPF: pass (ns1.primenet.com.au: SPF record at ntlworld.com designates 81.103.221.56 as permitted sender)
Date: Mon, 20 Dec 2010 21:01:21 +0000
From: Peter Stephenson <p.w.stephenson@ntlworld.com>
To: zsh-workers@zsh.org (Zsh hackers list)
Subject: Re: make oddity
Message-ID: <20101220210121.0fe2dc5e@pws-pc.ntlworld.com>
In-Reply-To: <22105.1292865347@csr.com>
References: <22105.1292865347@csr.com>
X-Mailer: Claws Mail 3.7.8 (GTK+ 2.22.0; x86_64-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
X-Cloudmark-Analysis: v=1.1 cv=JvdXmxIgLJv2/GthKqHpGJEEHukvLcvELVXUanXFreg= c=1 sm=0 a=kj9zAlcOel0A:10 a=4UtWO5riAAAA:8 a=NLZqzBF-AAAA:8 a=6kSiwmdtyAZoTNaNU2wA:9 a=xvmLtP1j_mGlg2q2S_cA:7 a=Vt5csuUPmUGYxnfm5DJU9VLvFsoA:4 a=CjuIK1q_8ugA:10 a=Shd8Sdw-9eQA:10 a=_dQi-Dcv4p4A:10 a=HpAAvcLHHh0Zw7uRqdWCyQ==:117

On Mon, 20 Dec 2010 17:15:47 +0000
Peter Stephenson <pws@csr.com> wrote:
> I had to work around a problem with make in releasing 4.3.11: in
> previous releases 'make' from a clean directory performed the equivalent
> of 'make prep' in the Src directory, this time it didn't.  I assume that
> there's some dependency missing (the standard answer) and that the
> timestamps of two files have somehow got out of order so some assumption
> isn't valid any more.
> 
> Here's the change I committed to work around it (with a later change to
> fix a minor unintentional slip with the phony files that it's not worth
> updating the release for).  As it works well enough in practice I'm not
> going to waste time on it, but maybe somebody can see more quickly than
> I can why this step should have happened automatically in everything up to
> 4.3.10-test-3 but doesn't in the 4.3.11 release without the change.

Inevitably I did waste time on it.

I can't for the life of me see how "prep" in Makemod ever got executed
other than by an explicit "make prep".  Surely it should be done when
the timestamp for the module file gets made?

Index: Src/Makefile.in
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Makefile.in,v
retrieving revision 1.18
diff -p -u -r1.18 Makefile.in
--- Src/Makefile.in	20 Dec 2010 16:51:25 -0000	1.18
+++ Src/Makefile.in	20 Dec 2010 20:56:10 -0000
@@ -221,9 +221,6 @@ mostlyclean-modules clean-modules distcl
 
 install.modules uninstall.modules \
 modobjs modules headers proto $(MAIN_OBJS) zsh.export: Makemod
-	@if [ ! -f Builtins/Makefile.in ]; then \
-	   $(MAKE) prep; \
-	fi
 	@$(MAKE) -f Makemod $(MAKEDEFS) $@
 .PHONY: install.modules uninstall.modules headers proto
 
Index: Src/Makemod.in.in
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Makemod.in.in,v
retrieving revision 1.7
diff -p -u -r1.7 Makemod.in.in
--- Src/Makemod.in.in	1 Feb 2008 11:31:38 -0000	1.7
+++ Src/Makemod.in.in	20 Dec 2010 20:56:10 -0000
@@ -116,8 +116,9 @@ prep:
 	done
 .PHONY: prep
 
-headers prep: $(dir_src)/modules.stamp
+headers: $(dir_src)/modules.stamp
 $(dir_src)/modules.stamp: $(MDDS)
+	$(MAKE) -f $(makefile) $(MAKEDEFS) prep
 	echo 'timestamp for *.mdd files' > $@
 .PHONY: headers
 
-- 
Peter Stephenson <p.w.stephenson@ntlworld.com>
Web page now at http://homepage.ntlworld.com/p.w.stephenson/

