From zsh-workers-return-15002-mason-zsh=primenet.com.au@sunsite.dk Wed Jun 20 17:54:44 2001
Return-Path: <zsh-workers-return-15002-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 26603 invoked from network); 20 Jun 2001 17:54:43 -0000
Received: from sunsite.dk (130.225.51.30)
  by ns1.primenet.com.au with SMTP; 20 Jun 2001 17:54:43 -0000
Received: (qmail 20454 invoked by alias); 20 Jun 2001 17:54:05 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 15002
Received: (qmail 20427 invoked from network); 20 Jun 2001 17:54:04 -0000
From: "Bart Schaefer" <schaefer@candle.brasslantern.com>
Message-Id: <1010620175037.ZM8761@candle.brasslantern.com>
Date: Wed, 20 Jun 2001 17:50:37 +0000
X-Mailer: Z-Mail (5.0.0 30July97)
To: zsh-workers@sunsite.dk
Subject: PATCH: Handling of interrupt in completion widgets
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii

If _complete_help or _complete_debug is interrupted, they leave the shell
in a bad state.  This patch uses traps to restore state properly.

diff -x CVS -ru ../zsh-forge/current/Completion/Base/Widget/_complete_debug Completion/Base/Widget/_complete_debug
--- ../zsh-forge/current/Completion/Base/Widget/_complete_debug	Tue May 29 08:44:07 2001
+++ Completion/Base/Widget/_complete_debug	Wed Jun 13 09:12:43 2001
@@ -7,7 +7,7 @@
 local w="${(qq)words}"
 
 exec 3>&-	# Too bad if somebody else is using it ...
-[[ -t 2 ]] && exec 3>&2 2>| $tmp
+[[ -t 2 ]] && { exec 3>&2 2>| $tmp ; trap 'exec 2>&3 3>&-' EXIT INT }
 
 setopt xtrace
 _main_complete
@@ -19,7 +19,6 @@
     _message -r "Trace output left in $tmp (up-history to view)"
     [[ $compstate[nmatches] -le 1 && $compstate[list] != *force* ]] &&
         compstate[list]='list force messages'
-    exec 2>&3 3>&-
 }
 
 return ret
diff -x CVS -ru ../zsh-forge/current/Completion/Base/Widget/_complete_help Completion/Base/Widget/_complete_help
--- ../zsh-forge/current/Completion/Base/Widget/_complete_help	Tue May 29 08:44:07 2001
+++ Completion/Base/Widget/_complete_help	Wed Jun 13 09:11:06 2001
@@ -35,10 +35,12 @@
       builtin zstyle "$@"
     fi
   }
+  trap 'unfunction compadd zstyle' EXIT INT
 
   _main_complete
 
   unfunction compadd zstyle
+  trap - EXIT INT
 
   for i in "${(@ok)help_funcs}"; do
     text="${text}

-- 
Bart Schaefer                                 Brass Lantern Enterprises
http://www.well.com/user/barts              http://www.brasslantern.com

Zsh: http://www.zsh.org | PHPerl Project: http://phperl.sourceforge.net   

