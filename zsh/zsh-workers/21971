From zsh-workers-return-21971-mason-zsh=primenet.com.au@sunsite.dk Tue Nov 01 22:29:54 2005
Return-Path: <zsh-workers-return-21971-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 17677 invoked from network); 1 Nov 2005 22:29:47 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 1 Nov 2005 22:29:47 -0000
Received: (qmail 97241 invoked from network); 1 Nov 2005 22:29:38 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 1 Nov 2005 22:29:38 -0000
Received: (qmail 12244 invoked by alias); 1 Nov 2005 22:29:35 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 21971
Received: (qmail 12234 invoked from network); 1 Nov 2005 22:29:35 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 1 Nov 2005 22:29:35 -0000
Received: (qmail 97002 invoked from network); 1 Nov 2005 22:29:35 -0000
Received: from mta08-winn.ispmail.ntl.com (81.103.221.48)
  by a.mx.sunsite.dk with SMTP; 1 Nov 2005 22:29:33 -0000
Received: from aamta10-winn.ispmail.ntl.com ([81.103.221.35])
          by mta08-winn.ispmail.ntl.com with ESMTP
          id <20051101222932.IOPE17804.mta08-winn.ispmail.ntl.com@aamta10-winn.ispmail.ntl.com>
          for <zsh-workers@sunsite.dk>; Tue, 1 Nov 2005 22:29:32 +0000
Received: from pwslaptop.csr.com ([81.105.238.64])
          by aamta10-winn.ispmail.ntl.com with ESMTP
          id <20051101222931.DPIO26459.aamta10-winn.ispmail.ntl.com@pwslaptop.csr.com>
          for <zsh-workers@sunsite.dk>; Tue, 1 Nov 2005 22:29:31 +0000
Received: from pwslaptop.csr.com (pwslaptop.csr.com [127.0.0.1])
	by pwslaptop.csr.com (8.13.4/8.13.4) with ESMTP id jA1MT7Q0012759
	for <zsh-workers@sunsite.dk>; Tue, 1 Nov 2005 22:29:07 GMT
Received: from pwslaptop.csr.com (pws@localhost)
	by pwslaptop.csr.com (8.13.4/8.13.4/Submit) with ESMTP id jA1MT5gU012756
	for <zsh-workers@sunsite.dk>; Tue, 1 Nov 2005 22:29:07 GMT
Message-Id: <200511012229.jA1MT5gU012756@pwslaptop.csr.com>
X-Authentication-Warning: pwslaptop.csr.com: pws owned process doing -bs
From: Peter Stephenson <p.w.stephenson@ntlworld.com>
To: zsh-workers@sunsite.dk (Zsh hackers list)
Subject: PATCH: pfxlen()
Date: Tue, 01 Nov 2005 22:29:05 +0000
X-Spam-Checker-Version: SpamAssassin 3.0.4 (2005-06-05) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=BAYES_00 autolearn=ham 
	version=3.0.4

This should fix pfxlen(), which is used in a few places in zle to find
common prefixes, so that it doesn't stop in the middle of a multibyte
character.  It's actually quite hard to exercise the function, so it's
not particularly well tested.

As it's likely to stay using multibyte characters while wpfxlen() uses
wide characters, I've removed Andrey's comments about merging the two.

Index: Src/Zle/zle_refresh.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/zle_refresh.c,v
retrieving revision 1.40
diff -u -r1.40 zle_refresh.c
--- Src/Zle/zle_refresh.c	1 Nov 2005 04:02:02 -0000	1.40
+++ Src/Zle/zle_refresh.c	1 Nov 2005 22:27:08 -0000
@@ -934,7 +934,6 @@
 #define tc_upcurs(X)	(void) tcmultout(TCUP, TCMULTUP, (X))
 #define tc_leftcurs(X)	(void) tcmultout(TCLEFT, TCMULTLEFT, (X))
 
-/* TODO remove it when pfxlen is fixed */
 static int
 wpfxlen(REFRESH_STRING s, REFRESH_STRING t)
 {
@@ -1143,7 +1142,6 @@
 		   makes it cheaper to delete intermediate characters
 		   eg. oldline: hifoobar \ hopefully cheaper here to delete two
 		   newline: foobar	 / characters, then we have six matches */
-		/* TODO replace wpfxlen back with pfxlen when the latter is fixed */
 		if (tccan(TCDEL)) {
 		    for (i = 1; *(ol + i); i++)
 			if (tcdelcost(i) < wpfxlen(ol + i, nl)) {
Index: Src/Zle/zle_tricky.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/zle_tricky.c,v
retrieving revision 1.59
diff -u -r1.59 zle_tricky.c
--- Src/Zle/zle_tricky.c	1 Nov 2005 03:26:56 -0000	1.59
+++ Src/Zle/zle_tricky.c	1 Nov 2005 22:27:09 -0000
@@ -1899,7 +1899,12 @@
     return runhookdef(COMPLETEHOOK, (void *) &dat);
 }
 
-/* Return the length of the common prefix of s and t. */
+/*
+ * Return the length of the common prefix of s and t.
+ * s and t are both metafied; the length returned is a raw byte count
+ * into both strings, excluding any common bytes that form less than
+ * a complete wide character.
+ */
 
 /**/
 mod_export int
@@ -1907,9 +1912,46 @@
 {
     int i = 0;
 
+#ifdef MULTIBYTE_SUPPORT
+    wchar_t wc;
+    mbstate_t ps;
+    int ret, lasti = 0;
+    char inc;
+
+    memset(&ps, 0, sizeof(mbstate_t));
+    while (*s) {
+	if (*s == Meta) {
+	    if (*t != Meta || t[1] != s[1])
+		break;
+	    inc = s[1] ^ 32;
+	    i += 2;
+	    s += 2;
+	    t += 2;
+	} else {
+	    if (*s != *t)
+		break;
+	    inc = *s;
+	    i++;
+	    s++;
+	    t++;
+	}
+
+	ret = mbrtowc(&wc, &inc, 1, &ps);
+	if (ret == -1) {
+	    /* error */
+	    break;
+	} else if (ret >= 0) {
+	    /* successfully found complete character, record position */
+	    lasti = i;
+	}
+	/* Otherwise, not found a complete character: keep trying. */
+    }
+    return lasti;
+#else
     while (*s && *s == *t)
 	s++, t++, i++;
     return i;
+#endif
 }
 
 /* Return the length of the common suffix of s and t. */

-- 
Peter Stephenson <p.w.stephenson@ntlworld.com>
Web page still at http://www.pwstephenson.fsnet.co.uk/

