From zsh-users-return-13966-mason-zsh=primenet.com.au@sunsite.dk Wed Mar 25 11:03:35 2009
Return-Path: <zsh-users-return-13966-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 11421 invoked from network); 25 Mar 2009 11:03:22 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 25 Mar 2009 11:03:22 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 83794 invoked from network); 25 Mar 2009 11:03:08 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 25 Mar 2009 11:03:08 -0000
Received: (qmail 8190 invoked by alias); 25 Mar 2009 11:02:50 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 13966
Received: (qmail 8176 invoked from network); 25 Mar 2009 11:02:49 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 25 Mar 2009 11:02:49 -0000
Received: from n22.bullet.mail.ukl.yahoo.com (n22.bullet.mail.ukl.yahoo.com [87.248.110.139])
	by bifrost.dotsrc.org (Postfix) with SMTP id 18EDB80EA0C1
	for <zsh-users@sunsite.dk>; Wed, 25 Mar 2009 12:02:45 +0100 (CET)
Received: from [217.146.182.178] by n22.bullet.mail.ukl.yahoo.com with NNFMP; 25 Mar 2009 11:02:36 -0000
Received: from [87.248.110.116] by t4.bullet.ukl.yahoo.com with NNFMP; 25 Mar 2009 11:02:36 -0000
Received: from [127.0.0.1] by omp221.mail.ukl.yahoo.com with NNFMP; 25 Mar 2009 11:02:33 -0000
X-Yahoo-Newman-Id: 616154.75210.bm@omp221.mail.ukl.yahoo.com
Received: (qmail 29078 invoked from network); 25 Mar 2009 11:02:36 -0000
DomainKey-Signature: a=rsa-sha1; q=dns; c=nofws;
  s=s1024; d=yahoo.fr;
  h=Received:X-YMail-OSG:X-Yahoo-Newman-Property:Date:From:To:Cc:Subject:Message-ID:Mail-Followup-To:References:MIME-Version:Content-Type:Content-Disposition:In-Reply-To:User-Agent;
  b=rFXgh67kv2neUxNXflzQd8RKcoT1YGSl15VhcNwzx5fh/Z8g1WBQBDC2WhUOlOBIIvDgFAHlkVUunmOqBdtrdQtqZfArXYkqAGQCOKPWETm1YNlXAw9h7WQ1YsbUaroz17NUCz7mtqb/izGhoKAiWTyynpC8CrC174HVEUmY07U=  ;
Received: from unknown (HELO seebyte.com) (stephane_chazelas@78.105.235.196 with login)
  by smtp123.mail.ukl.yahoo.com with SMTP; 25 Mar 2009 11:02:36 -0000
X-YMail-OSG: .1_gcmgVM1nHJqbKIFIvbNLXksTHA6CPBoMhDlYxBcIOQatBYBQgqvfZDmxMzjeOIDglfsDL5JIEoRIBOs1NSColOubdAki1f1ENh0Q_fedbs5aL6PKruz2KrbKXRebTpJzMpfxJb6nBx8l_ODPhDs3iMHZpQ_Q6msBfBHI9SidLx9PBI7P_2yKY0jAS.AM7AzHNMyX4JXbOUmxHLngo1xNXOup0EOk-
X-Yahoo-Newman-Property: ymail-3
Date: Wed, 25 Mar 2009 11:02:34 +0000
From: Stephane Chazelas <stephane_chazelas@yahoo.fr>
To: Atom Smasher <atom@smasher.org>
Cc: zsh-users@sunsite.dk
Subject: Re: freebsd problems with carriage return
Message-ID: <chaz20090325110234.GA5054@seebyte.com>
Mail-Followup-To: Atom Smasher <atom@smasher.org>, zsh-users@sunsite.dk
References: <20090324101411.66890.qmail@smasher.org> <chaz20090324114727.GA5144@seebyte.com> <20090324213624.93603.qmail@smasher.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20090324213624.93603.qmail@smasher.org>
User-Agent: Mutt/1.5.16 (2007-09-19)
X-Virus-Scanned: ClamAV 0.92.1/9164/Wed Mar 25 05:02:31 2009 on bifrost
X-Virus-Status: Clean

2009-03-25 10:36:21 +1300, Atom Smasher:
> On Tue, 24 Mar 2009, Stephane Chazelas wrote:
>
>> 2009-03-24 23:14:09 +1300, Atom Smasher:
>>> on linux this works as expected:
>>>
>>>      rsync --progress /from /to | while read -d "`print '\r'`" n
>>
>> See $'\r' instead of "`print '\r'`"
>>
>>>      do
>>>          print "  foo: $n"
>>
>> should be print -r, print without -r expands the \ sequences.
>>
>> You should probably use IFS= read -r instead of read as well.
> =================
>
> huh?
>
> here are screen-shots of what it's doing on linux, which is what i expect 
> and desire:
> 	http://smasher.org/tmp/snapshot149.png
> 	http://smasher.org/tmp/snapshot150.png
>
> here's a screen-shot of modifying IFS, which i almost thought would work, 

Sorry for the confusion, this was a remark on your code. I was
not suggesting that it was a fix for your problem.

read without -r processes the backslashes in its input
specially, so you generally need to pass it especially in
scripts.

Same, if you don't remove the white space characters from IFS,
read strips the leading and trailing ones.

$ print '  \\a \rb' | read -d $'\r' a; print -r "$a" | cat -vte
a$
$ print '  \\a \rb' | IFS= read -rd $'\r' a; print -r "$a" | cat -vte
  \a $

[...]
>> rsync --progress /from /to | sed -n l
>>
>> (or od -c)
>>
>> to see what rsync actually outputs.
> ================
>
> or this:
>
> <<<<<<<<
>
> % rsync --progress -h --bwlimit=5 ./foo_in ./foo_out > test
>
> % cat -vet test
> foo_in$
>       32.77K   0%    0.00kB/s    0:00:00^M      65.54K   0%    5.00kB/s 
> 0:49:49^M      98.30K   0%    5.00kB/s    0:49:42^M     131.07K   0% 
> 5.00kB/s    0:49:36^M     163.84K   1%    5.00kB/s    0:49:29^M 196.61K   
> 1%    5.00kB/s    0:49:22^M     229.38K   1%    5.00kB/s 0:49:16^M     
> 262.14K   1%    5.00kB/s    0:49:09^M     294.91K   1% 5.00kB/s    
> 0:49:03^M     327.68K   2%    5.00kB/s    0:48:56^M 360.45K   2%    
> 5.00kB/s    0:48:50^M     393.22K   2%    5.00kB/s 0:48:43^M     425.98K   
> 2%    5.00kB/s    0:48:36^M     458.75K   3% 5.00kB/s    0:48:30^M     
> 491.52K   3%    5.00kB/s    0:48:24^M
> 	<<snip>
>
> <<<<<<<<
>
> all of rsync's output of interest is stdout. it's mostly a bunch of 
> progress updates, separated by carriage returns.
>
[...]

But here, stdout is a regular file, not a pipe. Do you get the
same if you do rsync --progress -h --bwlimit=5 ./foo_in ./foo_out | cat -vet

Also, you could use ktrace/truss/strace or the equivalent on
your system to see if rsync is actually outputing those progress
lines.

-- 
Stephane

