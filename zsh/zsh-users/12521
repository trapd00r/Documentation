From zsh-users-return-12521-mason-zsh=primenet.com.au@sunsite.dk Thu Jan 31 16:09:59 2008
Return-Path: <zsh-users-return-12521-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 17825 invoked from network); 31 Jan 2008 16:09:57 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.4 (2008-01-01) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=BAYES_00 autolearn=ham
	version=3.2.4
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 31 Jan 2008 16:09:57 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 90030 invoked from network); 31 Jan 2008 16:09:46 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 31 Jan 2008 16:09:46 -0000
Received: (qmail 17264 invoked by alias); 31 Jan 2008 16:09:36 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 12521
Received: (qmail 17247 invoked from network); 31 Jan 2008 16:09:35 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 31 Jan 2008 16:09:35 -0000
Received: from ppsw-5.csi.cam.ac.uk (ppsw-5.csi.cam.ac.uk [131.111.8.135])
	by bifrost.dotsrc.org (Postfix) with ESMTP id 1F1A28029406
	for <zsh-users@sunsite.dk>; Thu, 31 Jan 2008 17:09:31 +0100 (CET)
X-Cam-SpamDetails: Not scanned
X-Cam-AntiVirus: No virus found
X-Cam-ScannerInfo: http://www.cam.ac.uk/cs/email/scanner/
Received: from jonwin.eng.cam.ac.uk ([129.169.125.203]:46250)
	by ppsw-5.csi.cam.ac.uk (smtp.hermes.cam.ac.uk [131.111.8.155]:465)
	with esmtpsa (PLAIN:cjk32) (TLSv1:DHE-RSA-AES256-SHA:256)
	id 1JKbyj-000654-HS (Exim 4.67)
	(return-path <cjk32@cam.ac.uk>); Thu, 31 Jan 2008 16:09:29 +0000
Message-ID: <47A1F2B9.5060202@cam.ac.uk>
Date: Thu, 31 Jan 2008 16:09:29 +0000
From: Christopher Key <cjk32@cam.ac.uk>
User-Agent: Thunderbird 1.5.0.8 (X11/20060911)
MIME-Version: 1.0
To: Peter Stephenson <pws@csr.com>
CC:  zsh-users@sunsite.dk
Subject: Re: Patch for completion with svn 1.5.0
References: <47A07DB2.7080604@cam.ac.uk> <20080130151133.285c6450@news01> <20080131124004.3af4a9f3@news01> <47A1D280.7020004@cam.ac.uk> <200801311405.m0VE5jLc019951@news01.csr.com>
In-Reply-To: <200801311405.m0VE5jLc019951@news01.csr.com>
Content-Type: multipart/mixed;
 boundary="------------060508050301020707010709"
X-Virus-Scanned: ClamAV 0.91.2/5624/Thu Jan 31 15:27:49 2008 on bifrost
X-Virus-Status: Clean

This is a multi-part message in MIME format.
--------------060508050301020707010709
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 7bit

Peter Stephenson wrote:
> Christopher Key wrote:
>   
>> I thought I'd tested this with the old version of svn, but hadn't
>> actually managed to (the command being called by the completion logic
>> was still version 1.5).  The ?: in the pattern is a perl thing to tell
>> it not store the result of the match grouped by the brackets, but would
>> appear not apply to shell scripting.  Instead, "arg" should be replaced
>> simply with "(arg|ARG)".  I've attached a patch for this.  There are a
>> few other oddities with svn 1.5 too, I'll have a look and see if I can
>> deal with any of them.
>>     
>
> Thanks, I had to restore a space...
>
>   
>>          args=(
>> -          ${=${${${(M)${(f)"$(LC_ALL=C _call_program options svnadmin help $
>> cmd)"##*Valid options:}:#*:*}%% #:*}/ arg/:arg:}/(#b)-([[:alpha:]]) \[--([a-z
>> -]##)\](:arg:)#/(--$match[2])-$match[1]$match[3] (-$match[1])--$match[2]$matc
>> h[3]}
>> +          ${=${${${(M)${(f)"$(LC_ALL=C _call_program options svnadmin help $
>> cmd)"##*Valid options:}:#*:*}%% #:*}/ (arg|ARG)/:arg:}/(#b)-([[:alpha:]]) \[-
>>     
>                             ^ here, before the colon.
>   
>> -([a-z-]##)\](:arg:)#/(--$match[2])-$match[1]$match[3] (-$match[1])--$match[2
>> ]$match[3]}
>>          )
>>     
>
> for "svnadmin help help" to work.  This was 1.4.4.  I got it simply by
> copying from the svn help equivalent.  I don't know if this is correct
> for other versions.  I don't really understand why, either, but it seems
> to make everything happy.
>
>   
I was just having a play at getting svnadmin help help to work, and had
come up with a different solution.  The innermost pattern substitution
look for "Valid options:" in the output from "svnadmin help $cmd", and
strips that out. The next substition removes any items *not* containing
":", whereas this should correctly remove anything not containing " :",
as it does for "svn help $cmd".

Now, when you run


#svnadmin help help
help (?, h): usage: svnadmin help [SUBCOMMAND...]

Describe the usage of this program or its subcommands.


the output doesn't contain the magic "Valid options", but neither does
any of it contain " :", so nothing gets passed to the substitution
looking for command line options.  This doesn't seem quite the correct
way to solve the problem though.  A better way seems to me to be to
refine the innermost substitution to removed everything up to and
including "Valid options:", or everything if "Valid options:" isn't
contained in the string.  The reason being that we're only interested in
trying to parse content following this phrase, and if it doesn't appear,
then it's not worth parsing anything.

The attached patch should achieve this, although I've only had about 2h
worth of experience with shell pattern substitutions, so it may not be
the best way!

Regards,

Chris

--------------060508050301020707010709
Content-Type: text/x-patch;
 name="zsh-4.3.4-svn15_1.patch"
Content-Transfer-Encoding: 7bit
Content-Disposition: inline;
 filename="zsh-4.3.4-svn15_1.patch"

--- Completion/Unix/Command/_subversion~	2007-03-19 13:02:49.000000000 +0000
+++ Completion/Unix/Command/_subversion	2008-01-31 15:59:48.000000000 +0000
@@ -30,7 +30,7 @@
 
         usage=${${(M)${(f)"$(LC_ALL=C _call_program options svn help $cmd)"}:#usage:*}#usage:*$cmd] }
         args=(
-          ${=${${${(M)${(f)"$(LC_ALL=C _call_program options svn help $cmd)"##*Valid options:}:#* :*}%% #:*}/ arg/:arg:}/(#b)-([[:alpha:]]) \[--([a-z-]##)\](:arg:)#/(--$match[2])-$match[1]$match[3] (-$match[1])--$match[2]$match[3]}
+          ${=${${${(M)${(f)"$(LC_ALL=C _call_program options svn help $cmd)"#(*Valid options:|(#e))}:#* :*}%% #:*}/ (arg|ARG)/:arg:}/(#b)-([[:alpha:]]) \[--([a-z-]##)\](:arg:)#/(--$match[2])-$match[1]$match[3] (-$match[1])--$match[2]$match[3]}
         )
 
         case $cmd in;
@@ -142,7 +142,7 @@
 
         usage=${${(M)${(f)"$(LC_ALL=C _call_program options svnadmin help $cmd)"}:#$cmd: usage:*}#$cmd: usage: svnadmin $cmd }
         args=(
-          ${=${${${(M)${(f)"$(LC_ALL=C _call_program options svnadmin help $cmd)"##*Valid options:}:#*:*}%% #:*}/ arg/:arg:}/(#b)-([[:alpha:]]) \[--([a-z-]##)\](:arg:)#/(--$match[2])-$match[1]$match[3] (-$match[1])--$match[2]$match[3]}
+          ${=${${${(M)${(f)"$(LC_ALL=C _call_program options svnadmin help $cmd)"#(*Valid options:|(#e))}:#* :*}%% #:*}/ (arg|ARG)/:arg:}/(#b)-([[:alpha:]]) \[--([a-z-]##)\](:arg:)#/(--$match[2])-$match[1]$match[3] (-$match[1])--$match[2]$match[3]}
         )
         if [[ $_svnadmin_subcmd_usage == *REPOS_PATH* ]]; then
           args+=( ":path:_files -/" )

--------------060508050301020707010709--

