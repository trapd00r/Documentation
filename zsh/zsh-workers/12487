From zsh-workers-return-12487-mason-zsh=primenet.com.au@sunsite.auc.dk Wed Aug 02 14:13:05 2000
Return-Path: <zsh-workers-return-12487-mason-zsh=primenet.com.au@sunsite.auc.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 22351 invoked from network); 2 Aug 2000 14:12:56 -0000
Received: from sunsite.auc.dk (130.225.51.30)
  by ns1.primenet.com.au with SMTP; 2 Aug 2000 14:12:56 -0000
Received: (qmail 22968 invoked by alias); 2 Aug 2000 14:12:25 -0000
Mailing-List: contact zsh-workers-help@sunsite.auc.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.auc.dk
X-Seq: 12487
Received: (qmail 22961 invoked from network); 2 Aug 2000 14:12:22 -0000
X-Envelope-Sender-Is: Andrej.Borsenkow@mow.siemens.ru (at relayer david.siemens.de)
From: "Andrej Borsenkow" <Andrej.Borsenkow@mow.siemens.ru>
To: "ZSH workers mailing list" <zsh-workers@sunsite.auc.dk>
Subject: PATCH: dynamic loading on Cygwin
Date: Wed, 2 Aug 2000 18:12:17 +0400
Message-ID: <000601bffc8b$aa1faec0$21c9ca95@mow.siemens.ru>
MIME-Version: 1.0
Content-Type: multipart/mixed;
	boundary="----=_NextPart_000_0007_01BFFCAD.31314EC0"
X-Priority: 3 (Normal)
X-MSMail-Priority: Normal
X-Mailer: Microsoft Outlook IMO, Build 9.0.2416 (9.0.2911.0)
Importance: Normal
X-MimeOLE: Produced By Microsoft MimeOLE V5.50.4133.2400

This is a multi-part message in MIME format.

------=_NextPart_000_0007_01BFFCAD.31314EC0
Content-Type: text/plain;
	charset="koi8-r"
Content-Transfer-Encoding: 7bit

This was easier as I expected. Patch is pretty small and main change is in
mkmakemod.sh.

Changes:

- configure values are hardcoded, like for AIX. They are based on my
experience :-)

- mod_export is defined as ``__attribute__((__dllexport__))'' to make such
objects automatically exported.

- imported objects generally need ``__attribute__((__dllimport__))''. Because
it is not possible to take address of such objects in static context, and it
is often used for imported functions, I added two declarators:
mod_import_function and mod_import_variable. mod_import_function is empty and
mod_import_variable is normally defined as aboce on Cygwin. They appear only
in epro files; mkproto.awk generates them appropriate declarator  from
mod_export.

- if module depends on another module, it has to be linked with it's DLL. So,
the major change was in mkmakemod.sh to generate dependencies and proper link
commands. Actually, this contains the majority of Cygwin dependencies.

- this installs libzsh.dll into bindir. No fancy installation, because it
currently fails as long as Zsh runs anyway

- I had to put code from main() into init.c to avoid mod_export'ing everything
that is needed. So, main() now is really dummy.

- libzsh is linked against $(LIBS); this should not be a problem (I hope) as
any other module does it already.

- there were a couple of missing mod_export's

I'm using this version on both Unix and Cygwin; on Cygwin the failed tests
are:

- special files (there is no on Cygwin)
- process substitution (no FIFO or /dev/fd support)
- cd with chase_links; this looks like a bug in current Cygwin version (it was
O.K. before)
- all tests that use zpty. This is next on TODO list :-)

I could not test it on Unix that needs extra libzsh.so (I do not have it).

As mentioned, on Cygwin you need at least binutils-20000722-1. Version,
distributed in June, 2000, has problems with dllwrap; and older versions
porbably cannot link directly with DLL. I tested it with Cygwin-1.1.3-1
(prerelease).

cheers

-andrej

Have a nice DOS!
B >>

------=_NextPart_000_0007_01BFFCAD.31314EC0
Content-Type: application/octet-stream;
	name="zsh-cygwin.diff"
Content-Transfer-Encoding: quoted-printable
Content-Disposition: attachment;
	filename="zsh-cygwin.diff"

Index: configure.in=0A=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=0A=
RCS file: /cvsroot/zsh/zsh/configure.in,v=0A=
retrieving revision 1.16=0A=
diff -u -r1.16 configure.in=0A=
--- configure.in	2000/08/02 13:54:17	1.16=0A=
+++ configure.in	2000/08/02 14:07:39=0A=
@@ -1467,6 +1467,18 @@=0A=
   zsh_cv_sys_dynamic_strip_exe=3D"${zsh_cv_sys_dynamic_strip_exe=3Dyes}"=0A=
   zsh_cv_sys_dynamic_strip_lib=3D"${zsh_cv_sys_dynamic_strip_lib=3Dyes}"=0A=
   zsh_cv_sys_dynamic_broken=3D"${zsh_cv_sys_dynamic_broken=3Dno}"=0A=
+elif test "x$ac_cv_cygwin" =3D xyes; then=0A=
+  DL_EXT=3D"${DL_EXT=3Ddll}"=0A=
+  DLLD=3D"${DLLD=3Ddllwrap}"=0A=
+  zsh_cv_func_dlsym_needs_underscore=3Dno=0A=
+  DLLDFLAGS=3D${DLLDFLAGS=3D}=0A=
+  EXTRA_LDFLAGS=3D${EXTRA_LDFLAGS=3D}=0A=
+  zsh_cv_sys_dynamic_clash_ok=3D"${zsh_cv_sys_dynamic_clash_ok=3Dno}"=0A=
+  =
zsh_cv_sys_dynamic_rtld_global=3D"${zsh_cv_sys_dynamic_rtld_global=3Dyes}=
"=0A=
+  zsh_cv_sys_dynamic_execsyms=3D"${zsh_cv_sys_dynamic_execsyms=3Dno}"=0A=
+  zsh_cv_sys_dynamic_strip_exe=3D"${zsh_cv_sys_dynamic_strip_exe=3Dyes}"=0A=
+  zsh_cv_sys_dynamic_strip_lib=3D"${zsh_cv_sys_dynamic_strip_lib=3Dyes}"=0A=
+  zsh_cv_sys_dynamic_broken=3D"${zsh_cv_sys_dynamic_broken=3Dno}"=0A=
 elif test "x$dynamic" =3D xyes; then=0A=
   AC_CACHE_CHECK(if your system use ELF binaries,=0A=
    zsh_cv_sys_elf,=0A=
@@ -1653,6 +1665,16 @@=0A=
   SHORTBOOTNAMES=3Dno=0A=
 fi=0A=
 AC_SUBST(SHORTBOOTNAMES)=0A=
+=0A=
+if test "x$ac_cv_cygwin" =3D xyes; then=0A=
+  INSTLIB=3D"install.cygwin-lib"=0A=
+  UNINSTLIB=3D"uninstall.cygwin-lib"=0A=
+else=0A=
+  INSTLIB=3D"install.bin-\$(L)"=0A=
+  UNINSTLIB=3D"uninstall.bin-\$(L)"=0A=
+fi=0A=
+AC_SUBST(INSTLIB)dnl=0A=
+AC_SUBST(UNINSTLIB)dnl=0A=
 =0A=
 AC_DEFINE_UNQUOTED(DL_EXT, "$DL_EXT")dnl=0A=
 AC_SUBST(D)dnl=0A=
Index: Etc/MACHINES=0A=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=0A=
RCS file: /cvsroot/zsh/zsh/Etc/MACHINES,v=0A=
retrieving revision 1.5=0A=
diff -u -r1.5 MACHINES=0A=
--- Etc/MACHINES	2000/05/30 09:14:17	1.5=0A=
+++ Etc/MACHINES	2000/08/02 14:07:40=0A=
@@ -30,13 +30,18 @@=0A=
 	be on a file system mounted as binary (the mount command shows=0A=
 	`binmode').=0A=
 =0A=
-	Dynamic loading does not work (this is automatically detected),=0A=
-	though libraries not compiled by default will work (see the file=0A=
-	INSTALL for how to add these to the base executable).  In=0A=
+	Dynamic loading works as of cygwin-1.1.3 and binutils-20000722-1.=0A=
+	It was not tested for earlier versions. This does not imply=0A=
+	that every module will work. New completion and in=0A=
 	particular zsh/zftp and zsh/mathfunc are known to work.=0A=
 =0A=
 	Some of the tests in the Test subdirectory are known to fail:=0A=
 	this is because the UNIX environment is not completely implemented.=0A=
+=0A=
+	Cygwin allows mount without existing mount point (e.g.=0A=
+	"mount //server/path /usr/src" where /usr/src does not exist).=0A=
+	Path completion will fail inside these mounts; make sure that=0A=
+	every mount point really exists.=0A=
 =0A=
 Data General: DG/UX 5.4R3.10 MU01 (various AViiONs)=0A=
 	Should build `out-of-the-box'.=0A=
Index: Src/Makefile.in=0A=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=0A=
RCS file: /cvsroot/zsh/zsh/Src/Makefile.in,v=0A=
retrieving revision 1.4=0A=
diff -u -r1.4 Makefile.in=0A=
--- Src/Makefile.in	2000/06/04 04:06:57	1.4=0A=
+++ Src/Makefile.in	2000/08/02 14:07:41=0A=
@@ -58,6 +58,8 @@=0A=
 =0A=
 MAIN_OBJS =3D main.o=0A=
 =0A=
+L =3D @L@=0A=
+=0A=
 LSTMP =3D=0A=
 LLIST =3D=0A=
 NSTMP =3D stamp-modobjs=0A=
@@ -65,6 +67,8 @@=0A=
 =0A=
 LIBZSH =3D libzsh-$(VERSION).$(DL_EXT)=0A=
 NIBZSH =3D=0A=
+INSTLIB =3D @INSTLIB@=0A=
+UNINSTLIB =3D @UNINSTLIB@=0A=
 =0A=
 ZSH_EXPORT =3D $(EXPOPT)zsh.export=0A=
 ZSH_NXPORT =3D=0A=
@@ -80,7 +84,7 @@=0A=
 =0A=
 $(LIBZSH): $(LIBOBJS) $(NSTMP)=0A=
 	rm -f $@=0A=
-	$(DLLINK) $(LIBOBJS) $(NLIST)=0A=
+	$(DLLINK) $(LIBOBJS) $(NLIST) $(LIBS)=0A=
 =0A=
 stamp-modobjs: modobjs=0A=
 	@if cmp -s stamp-modobjs.tmp stamp-modobjs; then \=0A=
@@ -176,7 +180,7 @@=0A=
 .PHONY: install.bin uninstall.bin=0A=
 =0A=
 # install binary, creating install directory if necessary=0A=
-install.bin-here: zsh$(EXEEXT) install.bin-@L@=0A=
+install.bin-here: zsh$(EXEEXT) $(INSTLIB)=0A=
 	$(sdir_top)/mkinstalldirs $(DESTDIR)$(bindir)=0A=
 	$(INSTALL_PROGRAM) $(STRIPFLAGS) zsh$(EXEEXT) =
$(DESTDIR)$(bindir)/$(tzsh)-$(VERSION)$(EXEEXT)=0A=
 	if test -f $(DESTDIR)$(bindir)/$(tzsh)$(EXEEXT); then \=0A=
@@ -192,17 +196,21 @@=0A=
 install.bin-L: $(LIBZSH)=0A=
 	$(sdir_top)/mkinstalldirs $(DESTDIR)$(libdir)/$(tzsh)=0A=
 	$(INSTALL_PROGRAM) $(LIBZSH) $(DESTDIR)$(libdir)/$(tzsh)/$(LIBZSH)=0A=
-.PHONY: install.bin-N install.bin-L=0A=
+install.cygwin-lib: $(LIBZSH)=0A=
+	$(INSTALL_PROGRAM) $(LIBZSH) $(DESTDIR)$(bindir)/$(LIBZSH)=0A=
+.PHONY: install.bin-N install.bin-L install.cygwin-lib=0A=
 =0A=
 # uninstall binary=0A=
-uninstall.bin-here: uninstall.bin-@L@=0A=
+uninstall.bin-here: $(UNINSTLIB)=0A=
 	rm -f $(DESTDIR)$(bindir)/$(tzsh)-$(VERSION) =
$(DESTDIR)$(bindir)/$(tzsh)$(EXEEXT)=0A=
 .PHONY: uninstall.bin-here uninstall.bin-@L@=0A=
 =0A=
 uninstall.bin-N:=0A=
 uninstall.bin-L:=0A=
 	rm -f $(DESTDIR)$(libdir)/$(tzsh)/$(LIBZSH)=0A=
-.PHONY: uninstall.bin-N uninstall.bin-L=0A=
+uninstall.cygwin-lib:=0A=
+	rm -f $(DESTDIR)$(bindir)/$(LIBZSH)=0A=
+.PHONY: uninstall.bin-N uninstall.bin-L uninstall.cygwin-lib=0A=
 =0A=
 # =3D=3D=3D=3D=3D=3D=3D=3D=3D=3D DEPENDENCIES FOR CLEANUP =
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=0A=
 =0A=
Index: Src/init.c=0A=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=0A=
RCS file: /cvsroot/zsh/zsh/Src/init.c,v=0A=
retrieving revision 1.9=0A=
diff -u -r1.9 init.c=0A=
--- Src/init.c	2000/07/30 19:18:13	1.9=0A=
+++ Src/init.c	2000/08/02 14:07:44=0A=
@@ -1123,3 +1123,97 @@=0A=
 	    NULL, 0);=0A=
     return 1;=0A=
 }=0A=
+=0A=
+/*=0A=
+ * This is real main entry point. This has to be mod_export'ed=0A=
+ * so zsh.exe can found it on Cygwin=0A=
+ */=0A=
+=0A=
+/**/=0A=
+mod_export int=0A=
+zsh_main(int argc, char **argv)=0A=
+{=0A=
+    char **t;=0A=
+    int t0;=0A=
+#ifdef USE_LOCALE=0A=
+    setlocale(LC_ALL, "");=0A=
+#endif=0A=
+=0A=
+    init_hackzero(argv, environ);=0A=
+=0A=
+    /*=0A=
+     * Provisionally set up the type table to allow metafication.=0A=
+     * This will be done properly when we have decided if we are=0A=
+     * interactive=0A=
+     */=0A=
+    typtab['\0'] |=3D IMETA;=0A=
+    typtab[STOUC(Meta)  ] |=3D IMETA;=0A=
+    typtab[STOUC(Marker)] |=3D IMETA;=0A=
+    for (t0 =3D (int)STOUC(Pound); t0 <=3D (int)STOUC(Nularg); t0++)=0A=
+	typtab[t0] |=3D ITOK | IMETA;=0A=
+=0A=
+    for (t =3D argv; *t; *t =3D metafy(*t, -1, META_ALLOC), t++);=0A=
+=0A=
+    zsh_name =3D argv[0];=0A=
+    do {=0A=
+      char *arg0 =3D zsh_name;=0A=
+      if (!(zsh_name =3D strrchr(arg0, '/')))=0A=
+	  zsh_name =3D arg0;=0A=
+      else=0A=
+	  zsh_name++;=0A=
+      if (*zsh_name =3D=3D '-')=0A=
+	  zsh_name++;=0A=
+      if (strcmp(zsh_name, "su") =3D=3D 0) {=0A=
+	  char *sh =3D zgetenv("SHELL");=0A=
+	  if (sh && *sh && arg0 !=3D sh)=0A=
+	      zsh_name =3D sh;=0A=
+	  else=0A=
+	      break;=0A=
+      } else=0A=
+	  break;=0A=
+    } while (zsh_name);=0A=
+=0A=
+    fdtable_size =3D OPEN_MAX;=0A=
+    fdtable =3D zcalloc(fdtable_size);=0A=
+=0A=
+    createoptiontable();=0A=
+    emulate(zsh_name, 1);   /* initialises most options */=0A=
+    opts[LOGINSHELL] =3D (**argv =3D=3D '-');=0A=
+    opts[MONITOR] =3D 1;   /* may be unset in init_io() */=0A=
+    opts[PRIVILEGED] =3D (getuid() !=3D geteuid() || getgid() !=3D =
getegid());=0A=
+    opts[USEZLE] =3D 1;   /* may be unset in init_io() */=0A=
+    parseargs(argv);   /* sets INTERACTIVE, SHINSTDIN and SINGLECOMMAND =
*/=0A=
+=0A=
+    SHTTY =3D -1;=0A=
+    init_io();=0A=
+    setupvals();=0A=
+    init_signals();=0A=
+    init_bltinmods();=0A=
+    run_init_scripts();=0A=
+    init_misc();=0A=
+=0A=
+    for (;;) {=0A=
+	do=0A=
+	    loop(1,0);=0A=
+	while (tok !=3D ENDINPUT && (tok !=3D LEXERR || isset(SHINSTDIN)));=0A=
+	if (tok =3D=3D LEXERR) {=0A=
+	    stopmsg =3D 1;=0A=
+	    zexit(lastval, 0);=0A=
+	}=0A=
+	if (!(isset(IGNOREEOF) && interact)) {=0A=
+#if 0=0A=
+	    if (interact)=0A=
+		fputs(islogin ? "logout\n" : "exit\n", shout);=0A=
+#endif=0A=
+	    zexit(lastval, 0);=0A=
+	    continue;=0A=
+	}=0A=
+	noexitct++;=0A=
+	if (noexitct >=3D 10) {=0A=
+	    stopmsg =3D 1;=0A=
+	    zexit(lastval, 0);=0A=
+	}=0A=
+	zerrnam("zsh", (!islogin) ? "use 'exit' to exit."=0A=
+		: "use 'logout' to logout.", NULL, 0);=0A=
+    }=0A=
+}=0A=
Index: Src/main.c=0A=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=0A=
RCS file: /cvsroot/zsh/zsh/Src/main.c,v=0A=
retrieving revision 1.2=0A=
diff -u -r1.2 main.c=0A=
--- Src/main.c	2000/06/08 09:59:00	1.2=0A=
+++ Src/main.c	2000/08/02 14:07:44=0A=
@@ -34,87 +34,5 @@=0A=
 int=0A=
 main(int argc, char **argv)=0A=
 {=0A=
-    char **t;=0A=
-    int t0;=0A=
-#ifdef USE_LOCALE=0A=
-    setlocale(LC_ALL, "");=0A=
-#endif=0A=
-=0A=
-    init_hackzero(argv, environ);=0A=
-=0A=
-    /*=0A=
-     * Provisionally set up the type table to allow metafication.=0A=
-     * This will be done properly when we have decided if we are=0A=
-     * interactive=0A=
-     */=0A=
-    typtab['\0'] |=3D IMETA;=0A=
-    typtab[STOUC(Meta)  ] |=3D IMETA;=0A=
-    typtab[STOUC(Marker)] |=3D IMETA;=0A=
-    for (t0 =3D (int)STOUC(Pound); t0 <=3D (int)STOUC(Nularg); t0++)=0A=
-	typtab[t0] |=3D ITOK | IMETA;=0A=
-=0A=
-    for (t =3D argv; *t; *t =3D metafy(*t, -1, META_ALLOC), t++);=0A=
-=0A=
-    zsh_name =3D argv[0];=0A=
-    do {=0A=
-      char *arg0 =3D zsh_name;=0A=
-      if (!(zsh_name =3D strrchr(arg0, '/')))=0A=
-	  zsh_name =3D arg0;=0A=
-      else=0A=
-	  zsh_name++;=0A=
-      if (*zsh_name =3D=3D '-')=0A=
-	  zsh_name++;=0A=
-      if (strcmp(zsh_name, "su") =3D=3D 0) {=0A=
-	  char *sh =3D zgetenv("SHELL");=0A=
-	  if (sh && *sh && arg0 !=3D sh)=0A=
-	      zsh_name =3D sh;=0A=
-	  else=0A=
-	      break;=0A=
-      } else=0A=
-	  break;=0A=
-    } while (zsh_name);=0A=
-=0A=
-    fdtable_size =3D OPEN_MAX;=0A=
-    fdtable =3D zcalloc(fdtable_size);=0A=
-=0A=
-    createoptiontable();=0A=
-    emulate(zsh_name, 1);   /* initialises most options */=0A=
-    opts[LOGINSHELL] =3D (**argv =3D=3D '-');=0A=
-    opts[MONITOR] =3D 1;   /* may be unset in init_io() */=0A=
-    opts[PRIVILEGED] =3D (getuid() !=3D geteuid() || getgid() !=3D =
getegid());=0A=
-    opts[USEZLE] =3D 1;   /* may be unset in init_io() */=0A=
-    parseargs(argv);   /* sets INTERACTIVE, SHINSTDIN and SINGLECOMMAND =
*/=0A=
-=0A=
-    SHTTY =3D -1;=0A=
-    init_io();=0A=
-    setupvals();=0A=
-    init_signals();=0A=
-    init_bltinmods();=0A=
-    run_init_scripts();=0A=
-    init_misc();=0A=
-=0A=
-    for (;;) {=0A=
-	do=0A=
-	    loop(1,0);=0A=
-	while (tok !=3D ENDINPUT && (tok !=3D LEXERR || isset(SHINSTDIN)));=0A=
-	if (tok =3D=3D LEXERR) {=0A=
-	    stopmsg =3D 1;=0A=
-	    zexit(lastval, 0);=0A=
-	}=0A=
-	if (!(isset(IGNOREEOF) && interact)) {=0A=
-#if 0=0A=
-	    if (interact)=0A=
-		fputs(islogin ? "logout\n" : "exit\n", shout);=0A=
-#endif=0A=
-	    zexit(lastval, 0);=0A=
-	    continue;=0A=
-	}=0A=
-	noexitct++;=0A=
-	if (noexitct >=3D 10) {=0A=
-	    stopmsg =3D 1;=0A=
-	    zexit(lastval, 0);=0A=
-	}=0A=
-	zerrnam("zsh", (!islogin) ? "use 'exit' to exit."=0A=
-		: "use 'logout' to logout.", NULL, 0);=0A=
-    }=0A=
+    return (zsh_main(argc, argv));=0A=
 }=0A=
Index: Src/makepro.awk=0A=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=0A=
RCS file: /cvsroot/zsh/zsh/Src/makepro.awk,v=0A=
retrieving revision 1.1.1.9=0A=
diff -u -r1.1.1.9 makepro.awk=0A=
--- Src/makepro.awk	1999/12/16 14:26:32	1.1.1.9=0A=
+++ Src/makepro.awk	2000/08/02 14:07:45=0A=
@@ -117,6 +117,10 @@=0A=
 	dcl =3D dtype " " dcltor ";"=0A=
 	if(locality ~ /E/)=0A=
 	    dcl =3D "extern " dcl=0A=
+	if(isfunc)=0A=
+	    gsub(/ mod_export /, " mod_import_function ", dcl)=0A=
+	else=0A=
+	    gsub(/ mod_export /, " mod_import_variable ", dcl)=0A=
 	gsub(/@[+-]/, "", dcl)=0A=
 	gsub(/ +/, " ", dcl)=0A=
 	while(match(dcl, /[^_0-9A-Za-z] ./) || match(dcl, /. [^_0-9A-Za-z]/))=0A=
Index: Src/mkmakemod.sh=0A=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=0A=
RCS file: /cvsroot/zsh/zsh/Src/mkmakemod.sh,v=0A=
retrieving revision 1.1.1.12=0A=
diff -u -r1.1.1.12 mkmakemod.sh=0A=
--- Src/mkmakemod.sh	2000/01/06 16:19:25	1.1.1.12=0A=
+++ Src/mkmakemod.sh	2000/08/02 14:07:47=0A=
@@ -73,6 +73,15 @@=0A=
     s,\(.\)/$,\1,=0A=
 '=0A=
 =0A=
+CYGWIN=3Dno=0A=
+if uname -s > /dev/null 2>&1; then=0A=
+    case `uname -s` in=0A=
+	CYGWIN* )=0A=
+	    CYGWIN=3Dyes=0A=
+	;;=0A=
+    esac=0A=
+fi=0A=
+=0A=
 # decide which stages to process=0A=
 first_stage=3Dtrue=0A=
 second_stage=3Dtrue=0A=
@@ -173,6 +182,8 @@=0A=
     remote_mdhs=3D=0A=
     other_exports=3D=0A=
     remote_exports=3D=0A=
+    other_modules=3D=0A=
+    remote_modules=3D=0A=
     for mddname in $here_mddnames; do=0A=
 =0A=
 	unset name moddeps nozshdep alwayslink hasexport=0A=
@@ -187,18 +198,37 @@=0A=
 =0A=
 	dobjects=3D`echo $objects '' | sed 's,\.o ,..o ,g'`=0A=
 	modhdeps=3D=0A=
+	mododeps=3D=0A=
 	exportdeps=3D=0A=
 	imports=3D=0A=
 	q_moddeps=3D=0A=
+	dllname=3D=0A=
 	for dep in $moddeps; do=0A=
 	    q_dep=3D`echo $dep | sed 's,Q,Qq,g;s,_,Qu,g;s,/,Qs,g'`=0A=
 	    q_moddeps=3D"$q_moddeps $q_dep"=0A=
 	    eval "depfile=3D\$modfile_$q_dep"=0A=
 	    eval `echo $depfile | sed =
's,/\([^/]*\)\.mdd$,;depbase=3D\1,;s,^,loc=3D,'`=0A=
+	    case "$binmod" in=0A=
+		*" $dep "* )=0A=
+		    dep=3Dzsh/main=0A=
+		;;=0A=
+	    esac=0A=
+=0A=
 	    case $the_subdir in=0A=
 		$loc)=0A=
 		    mdh=3D"${depbase}.mdh"=0A=
 		    export=3D"${depbase}.export"=0A=
+		    case "$dep" in=0A=
+			zsh/main )=0A=
+			    mdll=3D"\$(dir_top)/Src/libzsh-\$(VERSION).\$(DL_EXT) "=0A=
+			;;=0A=
+			zsh/$mddname )=0A=
+			    mdll=3D=0A=
+			;;=0A=
+			* )=0A=
+			    mdll=3D"${depbase}.\$(DL_EXT) "=0A=
+			;;=0A=
+		    esac=0A=
 		    ;;=0A=
 		$loc/*)=0A=
 		    mdh=3D"\$(dir_top)/$loc/${depbase}.mdh"=0A=
@@ -211,6 +241,21 @@=0A=
 			*" $export "*) ;;=0A=
 			*) other_exports=3D"$other_exports $export" ;;=0A=
 		    esac=0A=
+		    case "$dep" in=0A=
+			zsh/main )=0A=
+			    mdll=3D"\$(dir_top)/Src/libzsh-\$(VERSION).\$(DL_EXT) "=0A=
+			;;=0A=
+			zsh/$mddname )=0A=
+			    mdll=3D=0A=
+			;;=0A=
+			* )=0A=
+			    mdll=3D"\$(dir_top)/$loc/${depbase}.\$(DL_EXT) "=0A=
+			;;=0A=
+		    esac=0A=
+		    case "$other_modules " in=0A=
+			*" $mdll "*) ;;=0A=
+			*) other_modules=3D"$other_modules $mdll" ;;=0A=
+		    esac=0A=
 		    ;;=0A=
 		*)=0A=
 		    mdh=3D"\$(dir_top)/$loc/${depbase}.mdh"=0A=
@@ -223,12 +268,40 @@=0A=
 			*" $export "*) ;;=0A=
 			*) remote_exports=3D"$remote_exports $export" ;;=0A=
 		    esac=0A=
+		    case "$dep" in=0A=
+			zsh/main )=0A=
+			    mdll=3D"\$(dir_top)/Src/libzsh-\$(VERSION).\$(DL_EXT) "=0A=
+			;;=0A=
+			zsh/$mddname )=0A=
+			    mdll=3D=0A=
+			;;=0A=
+			* )=0A=
+			    mdll=3D"\$(dir_top)/$loc/${depbase}.\$(DL_EXT) "=0A=
+			;;=0A=
+		    esac=0A=
+		    case "$remote_modules " in=0A=
+			*" $mdll "*) ;;=0A=
+			*) remote_modules=3D"$remote_modules $mdll" ;;=0A=
+		    esac=0A=
 		    ;;=0A=
 	    esac=0A=
 	    modhdeps=3D"$modhdeps $mdh"=0A=
 	    exportdeps=3D"$exportdeps $export"=0A=
 	    imports=3D"$imports \$(IMPOPT)$export"=0A=
+	    if test $CYGWIN =3D yes -a -n "$mdll"; then=0A=
+		case "$mododeps" in=0A=
+		    *" $mdll "* )=0A=
+			:=0A=
+		    ;;=0A=
+		    * )=0A=
+			mododeps=3D"$mododeps $mdll"=0A=
+		    ;;=0A=
+		esac=0A=
+	    fi=0A=
 	done=0A=
+	if test $CYGWIN =3D yes; then=0A=
+		dllname=3D"--dllname $q_name"=0A=
+	fi=0A=
 =0A=
 	echo "##### =3D=3D=3D=3D=3D DEPENDENCIES GENERATED FROM ${mddname}.mdd =
=3D=3D=3D=3D=3D #####"=0A=
 	echo=0A=
@@ -239,6 +312,8 @@=0A=
 	echo "INCS_${mddname} =3D \$(EPRO_${mddname}) $otherincs"=0A=
 	echo "EXPIMP_${mddname} =3D $imports \$(EXPOPT)$mddname.export"=0A=
 	echo "NXPIMP_${mddname} =3D"=0A=
+	echo "DEPMODS_${mddname} =3D $mododeps"=0A=
+	echo "DLLNAME_${mddname} =3D $dllname"=0A=
 	echo=0A=
 	echo "proto.${mddname}: \$(EPRO_${mddname})"=0A=
 	echo "\$(SYMS_${mddname}): \$(PROTODEPS)"=0A=
@@ -263,9 +338,9 @@=0A=
 	    echo "uninstall.modules.${mddname}:"=0A=
 	    echo "	rm -f \$(DESTDIR)\$(MODDIR)/${name}.\$(DL_EXT)"=0A=
 	    echo=0A=
-	    echo "${mddname}.\$(DL_EXT): \$(MODDOBJS_${mddname}) =
${mddname}.export $exportdeps"=0A=
+	    echo "${mddname}.\$(DL_EXT): \$(MODDOBJS_${mddname}) =
${mddname}.export $exportdeps \$(DEPMODS_${mddname})"=0A=
 	    echo '	rm -f $@'=0A=
-	    echo "	\$(DLLINK) \$(@E@XPIMP_$mddname) \$(@E@NTRYOPT) =
\$(MODDOBJS_${mddname}) \$(LIBS)"=0A=
+	    echo "	\$(DLLINK) \$(@E@XPIMP_$mddname) \$(@E@NTRYOPT) =
\$(DLLNAME_${mddname}) \$(MODDOBJS_${mddname}) \$(DEPMODS_${mddname}) =
\$(LIBS) "=0A=
 	    echo=0A=
 	fi=0A=
 	echo "${mddname}.mdhi: ${mddname}.mdhs \$(INCS_${mddname})"=0A=
@@ -293,16 +368,30 @@=0A=
 	echo "	    echo '#define have_${q_name}_module'; \\"=0A=
 	echo "	    echo; \\"=0A=
 	echo "	    echo '# ifndef IMPORTING_MODULE_${q_name}'; \\"=0A=
-	echo "	    if test @SHORTBOOTNAMES@ =3D yes; then \\"=0A=
-	echo "		echo '#  ifndef MODULE'; \\"=0A=
-	echo "	    fi; \\"=0A=
-	echo "	    echo '#   define boot_ boot_${q_name}'; \\"=0A=
-	echo "	    echo '#   define cleanup_ cleanup_${q_name}'; \\"=0A=
-	echo "	    echo '#   define setup_ setup_${q_name}'; \\"=0A=
-	echo "	    echo '#   define finish_ finish_${q_name}'; \\"=0A=
-	echo "	    if test @SHORTBOOTNAMES@ =3D yes; then \\"=0A=
-	echo "		echo '#  endif /* !MODULE */'; \\"=0A=
-	echo "	    fi; \\"=0A=
+	if test $CYGWIN =3D yes; then=0A=
+	    echo "	    echo '#  ifdef MODULE'; \\"=0A=
+	    echo "	    echo '#   define boot_ __attribute__((__dllexport__)) =
boot_${q_name}'; \\"=0A=
+	    echo "	    echo '#   define cleanup_ =
__attribute__((__dllexport__)) cleanup_${q_name}'; \\"=0A=
+	    echo "	    echo '#   define setup_ __attribute__((__dllexport__)) =
setup_${q_name}'; \\"=0A=
+	    echo "	    echo '#   define finish_ __attribute__((__dllexport__)) =
finish_${q_name}'; \\"=0A=
+	    echo "	    echo '#  else /* MODULE */'; \\"=0A=
+	    echo "	    echo '#   define boot_ boot_${q_name}'; \\"=0A=
+	    echo "	    echo '#   define cleanup_ cleanup_${q_name}'; \\"=0A=
+	    echo "	    echo '#   define setup_ setup_${q_name}'; \\"=0A=
+	    echo "	    echo '#   define finish_ finish_${q_name}'; \\"=0A=
+	    echo "	    echo '#  endif /* MODULE */'; \\"=0A=
+	else=0A=
+	    echo "	    if test @SHORTBOOTNAMES@ =3D yes; then \\"=0A=
+	    echo "		echo '#  ifndef MODULE'; \\"=0A=
+	    echo "	    fi; \\"=0A=
+	    echo "	    echo '#   define boot_ boot_${q_name}'; \\"=0A=
+	    echo "	    echo '#   define cleanup_ cleanup_${q_name}'; \\"=0A=
+	    echo "	    echo '#   define setup_ setup_${q_name}'; \\"=0A=
+	    echo "	    echo '#   define finish_ finish_${q_name}'; \\"=0A=
+	    echo "	    if test @SHORTBOOTNAMES@ =3D yes; then \\"=0A=
+	    echo "		echo '#  endif /* !MODULE */'; \\"=0A=
+	    echo "	    fi; \\"=0A=
+	fi=0A=
 	echo "	    echo '# endif /* !IMPORTING_MODULE_${q_name} */'; \\"=0A=
 	echo "	    echo; \\"=0A=
 	if test -n "$moddeps"; then (=0A=
@@ -327,9 +416,21 @@=0A=
 	    echo "	    echo; \\"=0A=
 	fi=0A=
 	if test -n "$proto"; then=0A=
+	    if test "$CYGWIN" =3D yes; then=0A=
+		echo "	    echo '# ifndef IMPORTING_MODULE_${q_name} '; \\"=0A=
+		echo "	    echo '#  undef mod_import_variable'; \\"=0A=
+		echo "	    echo '#  define mod_import_variable'; \\"=0A=
+		echo "	    echo '# endif /* IMPORTING_MODULE_${q_name} */'; \\"=0A=
+	    fi=0A=
 	    echo "	    for epro in \$(EPRO_${mddname}); do \\"=0A=
 	    echo "		echo '# include \"'\$\$epro'\"'; \\"=0A=
 	    echo "	    done; \\"=0A=
+	    if test "$CYGWIN" =3D yes; then=0A=
+		echo "	    echo '# ifndef IMPORTING_MODULE_${q_name} '; \\"=0A=
+		echo "	    echo '#  undef mod_import_variable'; \\"=0A=
+		echo "	    echo '#  define mod_import_variable =
__attribute__((__dllimport__))'; \\"=0A=
+		echo "	    echo '# endif /* IMPORTING_MODULE_${q_name} */'; \\"=0A=
+	    fi=0A=
 	    echo "	    echo; \\"=0A=
 	fi=0A=
 	echo "	    echo '#endif /* !have_${q_name}_module */'; \\"=0A=
@@ -343,7 +444,7 @@=0A=
 =0A=
     done=0A=
 =0A=
-    if test -n "$remote_mdhs$other_mdhs$remote_exports$other_exports"; =
then=0A=
+    if test -n =
"$remote_mdhs$other_mdhs$remote_exports$other_exports$remote_modules$othe=
r_modules"; then=0A=
 	echo "##### =3D=3D=3D=3D=3D DEPENDENCIES FOR REMOTE MODULES =
=3D=3D=3D=3D=3D #####"=0A=
 	echo=0A=
 	for mdh in $remote_mdhs; do=0A=
@@ -365,6 +466,18 @@=0A=
 	    echo "${other_exports}:" | sed 's,^ ,,'=0A=
 	    echo "	false # should only happen with make -n"=0A=
 	    echo=0A=
+	fi=0A=
+	if test "$CYGWIN" =3D yes; then=0A=
+	    for mdll in $remote_modules; do=0A=
+		echo "$mdll: FORCE"=0A=
+		echo "	@cd @%@ && \$(MAKE) \$(MAKEDEFS) @%@$mdll"=0A=
+		echo=0A=
+	    done | sed 's,^\(.*\)@%@\(.*\)@%@\(.*\)/\([^/]*\)$,\1\3\2\4,'=0A=
+	    if test -n "$other_modules"; then=0A=
+		echo "${other_modules}:" | sed 's,^ ,,'=0A=
+		echo "	false # should only happen with make -n"=0A=
+		echo=0A=
+	    fi=0A=
 	fi=0A=
     fi=0A=
 =0A=
Index: Src/parse.c=0A=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=0A=
RCS file: /cvsroot/zsh/zsh/Src/parse.c,v=0A=
retrieving revision 1.12=0A=
diff -u -r1.12 parse.c=0A=
--- Src/parse.c	2000/07/21 07:50:08	1.12=0A=
+++ Src/parse.c	2000/08/02 14:07:50=0A=
@@ -3070,7 +3070,8 @@=0A=
 {=0A=
 }=0A=
 =0A=
-void=0A=
+/**/=0A=
+mod_export void=0A=
 closedumps(void)=0A=
 {=0A=
 }=0A=
Index: Src/zsh.h=0A=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=0A=
RCS file: /cvsroot/zsh/zsh/Src/zsh.h,v=0A=
retrieving revision 1.17=0A=
diff -u -r1.17 zsh.h=0A=
--- Src/zsh.h	2000/07/30 17:03:53	1.17=0A=
+++ Src/zsh.h	2000/08/02 14:07:51=0A=
@@ -1681,7 +1681,15 @@=0A=
 /* Pseudo-keyword to mark exportedness */=0A=
 /***************************************/=0A=
 =0A=
+#ifdef __CYGWIN__=0A=
+#define mod_export __attribute__((__dllexport__))=0A=
+#define mod_import_variable __attribute__((__dllimport__))=0A=
+#define mod_import_function=0A=
+#else=0A=
 #define mod_export=0A=
+#define mod_import_variable=0A=
+#define mod_import_function=0A=
+#endif=0A=
 =0A=
 /***************************************/=0A=
 /* Hooks in core.                      */=0A=
Index: Src/Zle/zle_utils.c=0A=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=0A=
RCS file: /cvsroot/zsh/zsh/Src/Zle/zle_utils.c,v=0A=
retrieving revision 1.4=0A=
diff -u -r1.4 zle_utils.c=0A=
--- Src/Zle/zle_utils.c	2000/07/04 15:04:17	1.4=0A=
+++ Src/Zle/zle_utils.c	2000/08/02 14:07:53=0A=
@@ -379,7 +379,7 @@=0A=
  * The message must be metafied.                              */=0A=
 =0A=
 /**/=0A=
-void=0A=
+void mod_export=0A=
 showmsg(char const *msg)=0A=
 {=0A=
     char const *p;=0A=

------=_NextPart_000_0007_01BFFCAD.31314EC0--

