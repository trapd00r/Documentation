From zsh-workers-return-19656-mason-zsh=primenet.com.au@sunsite.dk Thu Mar 18 11:54:33 2004
Return-Path: <zsh-workers-return-19656-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 14301 invoked from network); 18 Mar 2004 11:54:32 -0000
Received: from sunsite.dk (130.225.247.90)
  by ns1.primenet.com.au with SMTP; 18 Mar 2004 11:54:32 -0000
Received: (qmail 18497 invoked by alias); 18 Mar 2004 11:54:25 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 19656
Received: (qmail 18462 invoked from network); 18 Mar 2004 11:54:24 -0000
Received: from localhost (HELO sunsite.dk) (127.0.0.1)
  by localhost with SMTP; 18 Mar 2004 11:54:24 -0000
X-MessageWall-Score: 0 (sunsite.dk)
Received: from [62.189.58.19] by sunsite.dk (MessageWall 1.0.8) with SMTP; 18 Mar 2004 11:54:24 -0000
Received: from MAILSWEEPER01.csr.com (mailhost1.csr.com [62.189.183.235])
	by lhuumrelay3.lnd.ops.eu.uu.net (8.11.0/8.11.0) with ESMTP id i2IBsOv21650
	for <zsh-workers@sunsite.dk>; Thu, 18 Mar 2004 11:54:24 GMT
Received: from EXCHANGE02.csr.com (unverified [192.168.137.45]) by MAILSWEEPER01.csr.com
 (Content Technologies SMTPRS 4.3.12) with ESMTP id <T686a3ade38c0a88d015d4@MAILSWEEPER01.csr.com> for <zsh-workers@sunsite.dk>;
 Thu, 18 Mar 2004 11:54:01 +0000
Received: from csr.com ([192.168.144.127]) by EXCHANGE02.csr.com with Microsoft SMTPSVC(5.0.2195.6713);
	 Thu, 18 Mar 2004 11:56:41 +0000
To: zw <zsh-workers@sunsite.dk>
Subject: Re: memory leaks report 
In-reply-to: "Felix Rosencrantz"'s message of "Tue, 09 Mar 2004 23:46:09 PST."
             <20040310074609.94301.qmail@web10406.mail.yahoo.com> 
Date: Thu, 18 Mar 2004 11:54:23 +0000
Message-ID: <7554.1079610863@csr.com>
From: Peter Stephenson <pws@csr.com>
X-OriginalArrivalTime: 18 Mar 2004 11:56:41.0406 (UTC) FILETIME=[139695E0:01C40CE0]

Felix Rosencrantz wrote:
> Here are the latest memory leaks found by valgrind from around March 6th.
> Most were all found before, but I didn't provide much context....  So here's
> a little more.  If there is a a simple way to force the tests to execute a
> separate shell per testcase, it would make it easier to link up the leaks to
> the test case.

You can set ZTST_verbose=2 in the environment to give more context
for the tests, so you can see when reports appear.  A separate shell
for each test is harder (and slower).

> Test E01options:
> Valgrind reports an error summary after every zsh subprocess exits.  Running
> the
> E01options test, there are 42 error summaries.  This leak is first reported=
>  in
> the 32nd error summary.  It looks like there are 48 tests.
> 493 bytes in 1 blocks are definitely lost in loss record 16 of 21
>    at  malloc (vg_replace_malloc.c:153)
>    by  zalloc (mem.c:490)
>    by  mkenvstr (params.c:3423)
>    by  addenv (params.c:3386)
>    by  restore_params (exec.c:2590)

Well, well, well, who would have thought it, a bug in the parameter
code.  I think it's the following, which looks like it should logically
be there in save_params to match the chunk in restore_params which is
causing the leak.

Index: Src/exec.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/exec.c,v
retrieving revision 1.57
diff -u -r1.57 exec.c
--- Src/exec.c	13 Nov 2003 14:34:38 -0000	1.57
+++ Src/exec.c	18 Mar 2004 11:43:38 -0000
@@ -2519,6 +2519,10 @@
     while (wc_code(ac = *pc) == WC_ASSIGN) {
 	s = ecrawstr(state->prog, pc + 1, NULL);
 	if ((pm = (Param) paramtab->getnode(paramtab, s))) {
+	    if (pm->env) {
+		delenv(pm->env);
+		pm->env = NULL;
+	    }
 	    if (!(pm->flags & PM_SPECIAL)) {
 		paramtab->removenode(paramtab, s);
 	    } else if (!(pm->flags & PM_READONLY) &&

-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR Ltd., Science Park, Milton Road,
Cambridge, CB4 0WH, UK                          Tel: +44 (0)1223 692070


**********************************************************************
This email and any files transmitted with it are confidential and
intended solely for the use of the individual or entity to whom they
are addressed. If you have received this email in error please notify
the system manager.

This footnote also confirms that this email message has been swept by
MIMEsweeper for the presence of computer viruses.

www.mimesweeper.com
**********************************************************************

