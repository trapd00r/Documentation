From zsh-workers-return-22903-mason-zsh=primenet.com.au@sunsite.dk Tue Oct 24 16:15:23 2006
Return-Path: <zsh-workers-return-22903-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 7270 invoked from network); 24 Oct 2006 16:15:18 -0000
X-Spam-Checker-Version: SpamAssassin 3.1.7 (2006-10-05) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=BAYES_00,FORGED_RCVD_HELO 
	autolearn=ham version=3.1.7
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 24 Oct 2006 16:15:18 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 5867 invoked from network); 24 Oct 2006 16:15:12 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 24 Oct 2006 16:15:12 -0000
Received: (qmail 13549 invoked by alias); 24 Oct 2006 16:15:09 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 22903
Received: (qmail 13539 invoked from network); 24 Oct 2006 16:15:08 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 24 Oct 2006 16:15:08 -0000
Received: (qmail 5342 invoked from network); 24 Oct 2006 16:15:08 -0000
Received: from tetsuo.karasik.eu.org (193.88.77.78)
  by a.mx.sunsite.dk with SMTP; 24 Oct 2006 16:15:06 -0000
Received: by tetsuo.karasik.eu.org (Postfix, from userid 1003)
	id 28CF539CA02; Tue, 24 Oct 2006 18:15:06 +0200 (CEST)
Date: Tue, 24 Oct 2006 18:15:06 +0200
From: Dmitry Karasik <dmitry@karasik.eu.org>
To: zsh-workers@sunsite.dk
Subject: Re: bug: can't write history file
Message-ID: <20061024161506.GA24956@tetsuo.karasik.eu.org>
Reply-To: dmitry@karasik.eu.org
References: <20061024141740.GA18951@tetsuo.karasik.eu.org> <20061024152718.GD17113@blorf.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=koi8-r
Content-Disposition: inline
In-Reply-To: <20061024152718.GD17113@blorf.net>
User-Agent: Mutt/1.4.2.2i
X-Operating-System: FreeBSD 6.1-PRERELEASE

On Tue, Oct 24, 2006 at 08:27:18AM -0700, Wayne Davison wrote:
> On Tue, Oct 24, 2006 at 04:17:40PM +0200, Dmitry Karasik wrote:
> > I found that it is savehistfile() to blame, because it apparently is
> > called with writeflags=0, which bypasses all append/rewrite logic
> 
> This is as it should be, because that code is re-writing the history
> file to trim it.  As long as you use HIST_APPEND or SHARE_HISTORY, the
> history from a root session should be added to the file -- just the
> rewrite at the end will be skipped.

That is possibly true, however before changing the code I did play with
HIST_APPEND and SHARE_HISTORY and I cannot confirm that setting these option
will work.  To support this, as far as I can see in the code,
"isset(APPENDHISTORY)" or "isset(SHAREHISTORY)" are only checked when
"writeflags & HFILE_USE_OPTIONS", which is actually never true in the second
call. 

> That line is the same in 4.2, so I presume what has changed is the
> default options (how it reaches this code).  In that case it's
> plausible that this should always have had that flag. 

I'm not sure what caused this problem not to appear in the previous versions,
but if you insist that this is the configuration problem, I'd like to ask you
to send me a minimalistic .zshenv that will not trigger the error and will save
the history correctly both under root and non-root. 

-- 
Sincerely,
	Dmitry Karasik


