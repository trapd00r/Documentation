From zsh-workers-return-22656-mason-zsh=primenet.com.au@sunsite.dk Mon Aug 21 21:01:37 2006
Return-Path: <zsh-workers-return-22656-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 26779 invoked from network); 21 Aug 2006 21:01:32 -0000
X-Spam-Checker-Version: SpamAssassin 3.1.4 (2006-07-25) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=AWL,BAYES_00,
	FORGED_RCVD_HELO autolearn=ham version=3.1.4
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 21 Aug 2006 21:01:32 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 66377 invoked from network); 21 Aug 2006 21:01:26 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 21 Aug 2006 21:01:26 -0000
Received: (qmail 8211 invoked by alias); 21 Aug 2006 21:01:19 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 22656
Received: (qmail 8200 invoked from network); 21 Aug 2006 21:01:17 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 21 Aug 2006 21:01:17 -0000
Received: (qmail 66010 invoked from network); 21 Aug 2006 21:01:17 -0000
Received: from mtaout03-winn.ispmail.ntl.com (81.103.221.49)
  by a.mx.sunsite.dk with SMTP; 21 Aug 2006 21:01:15 -0000
Received: from aamtaout03-winn.ispmail.ntl.com ([81.103.221.35])
          by mtaout03-winn.ispmail.ntl.com with ESMTP
          id <20060821210113.UNBD1865.mtaout03-winn.ispmail.ntl.com@aamtaout03-winn.ispmail.ntl.com>
          for <zsh-workers@sunsite.dk>; Mon, 21 Aug 2006 22:01:13 +0100
Received: from pwslaptop.csr.com ([81.107.41.155])
          by aamtaout03-winn.ispmail.ntl.com with ESMTP
          id <20060821210113.GVKD11710.aamtaout03-winn.ispmail.ntl.com@pwslaptop.csr.com>
          for <zsh-workers@sunsite.dk>; Mon, 21 Aug 2006 22:01:13 +0100
Received: from pwslaptop.csr.com (pwslaptop.csr.com [127.0.0.1])
	by pwslaptop.csr.com (8.13.7/8.13.7) with ESMTP id k7LL16ng022435
	for <zsh-workers@sunsite.dk>; Mon, 21 Aug 2006 22:01:13 +0100
Message-Id: <200608212101.k7LL16ng022435@pwslaptop.csr.com>
From: Peter Stephenson <p.w.stephenson@ntlworld.com>
To: zsh-workers@sunsite.dk (Zsh hackers list)
Subject: PATCH: setopt monitor in non-interactive shell
Date: Mon, 21 Aug 2006 22:01:06 +0100

There's a bug report on sourceforge:

>[ 1413647 ] using eval in monitor mode doesn't work!
>Submitted By:
>Thomas Eriksson - arne 	Date Submitted:
>2006-01-24 04:21
>Summary: (?)
>using eval in monitor mode doesn't work!
>I have tested the following code with zsh 4.2.6 on
>Ubuntu Breezy:
>
>Consider this trivial code
>
>#!/bin/zsh
>set -m
>eval /bin/echo foo bar
>## EOF
>
>Interpreting it with zsh will make zsh "hang" at the
>eval command, instead of executing echo!
>
>This does not seem to affect builtins.
>
>I have tried this on recent versions of 'bash' and
>'pdksh' with no problem.

The hang happens, because the shell hasn't properly set up its process
group because the usual interactive handling wasn't done; enabling the
monitor option made it think it could set the process group.  This
caused the child forked for /bin/echo (it's not specific to eval) to be
suspended in a way the parent shell wasn't prepared to handle.  Or
something.

The monitor option in zsh is tied to being in an interactive shell.  I
think the only answer, however unpleasing it may seem, is to make some
attempt but give up without trying to reinitialise the shell which is
the only way it's actually going to work in a case like this.

The code that makes "some attempt" is the same as that which tries to
set up the monitor option in the first place:  chances are the monitor
option wasn't set because this failed last time round, so I'm not sure
how useful this is.

I don't really know much about terminal handling.  If anyone else thinks
they can fix it properly please do so.

Index: Src/options.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/options.c,v
retrieving revision 1.30
diff -u -r1.30 options.c
--- Src/options.c	25 Jul 2006 18:10:38 -0000	1.30
+++ Src/options.c	21 Aug 2006 20:59:26 -0000
@@ -687,7 +687,16 @@
 	setuid(getuid());
 	setgid(getgid());
 #endif /* HAVE_SETUID */
-#ifndef JOB_CONTROL
+#ifdef JOB_CONTROL
+    } else if (!force && optno == MONITOR) {
+	if (opts[optno] == value)
+	    return 0;
+	if (interact && (SHTTY != -1)) {
+	    origpgrp = GETPGRP();
+	    acquire_pgrp();
+	} else
+	    return -1;
+#else
     } else if(optno == MONITOR && value) {
 	    return -1;
 #endif /* not JOB_CONTROL */

-- 
Peter Stephenson <p.w.stephenson@ntlworld.com>
Web page now at http://homepage.ntlworld.com/p.w.stephenson/

