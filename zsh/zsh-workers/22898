From zsh-workers-return-22898-mason-zsh=primenet.com.au@sunsite.dk Tue Oct 24 00:39:10 2006
Return-Path: <zsh-workers-return-22898-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 14240 invoked from network); 24 Oct 2006 00:39:07 -0000
X-Spam-Checker-Version: SpamAssassin 3.1.7 (2006-10-05) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.4 required=5.0 tests=AWL,BAYES_00,
	FORGED_RCVD_HELO autolearn=ham version=3.1.7
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 24 Oct 2006 00:39:07 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 11563 invoked from network); 24 Oct 2006 00:39:01 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 24 Oct 2006 00:39:01 -0000
Received: (qmail 1632 invoked by alias); 24 Oct 2006 00:38:58 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 22898
Received: (qmail 1623 invoked from network); 24 Oct 2006 00:38:57 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 24 Oct 2006 00:38:57 -0000
Received: (qmail 11268 invoked from network); 24 Oct 2006 00:38:57 -0000
Received: from vinc17.net8.nerim.net (HELO prunille.vinc17.org) (62.212.121.106)
  by a.mx.sunsite.dk with SMTP; 24 Oct 2006 00:38:55 -0000
Received: by prunille.vinc17.org (Postfix, from userid 501)
	id C6EFBDB2E5F; Tue, 24 Oct 2006 02:38:51 +0200 (CEST)
Date: Tue, 24 Oct 2006 02:38:51 +0200
From: Vincent Lefevre <vincent@vinc17.org>
To: zsh-workers@sunsite.dk
Subject: zsh outputs "4m" lines in eterm-color
Message-ID: <20061024003851.GR21217@prunille.vinc17.org>
Mail-Followup-To: zsh-workers@sunsite.dk
MIME-Version: 1.0
Content-Type: text/plain; charset=iso-8859-1
Content-Disposition: inline
Content-Transfer-Encoding: 8bit
X-Mailer-Info: http://www.vinc17.org/mutt/
User-Agent: Mutt/1.5.13-vl-r13495 (2006-10-09)

Under Mac OS X, zsh seems to have a compatibility problem with the
Emacs terminal (and TERM=eterm-color, which is the default value).
When I type:

  emacs -eval '(progn (set-buffer (apply ''make-term "zsh" "zsh" nil ''("-f"))) (term-mode) (term-char-mode) (switch-to-buffer "*zsh*"))'

I get a "4m" line before the prompt:

prunille% echo foo
foo
4m
prunille%

There's no such problem with bash.

The problem can be reproduced in the following way:

prunille% /usr/bin/tput rmul; echo foo
4mfoo
4m
prunille%

I wonder if this is due to the fact that zsh is linked to the ncurses
in /usr/lib instead of /opt/local/lib (the problem cannot be reproduced
with /opt/local/bin/tput); "otool -L =zsh" gives:

/opt/local/bin/zsh:
        /opt/local/lib/libiconv.2.dylib (compatibility version 7.0.0, current version 7.0.0)
        /usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 88.1.7)
        /usr/lib/libncurses.5.4.dylib (compatibility version 5.4.0, current version 5.4.0)

However the zsh configuration is:

zsh configuration
-----------------
zsh version               : 4.3.2
host operating system     : powerpc-apple-darwin8.8.0
source code location      : .
compiler                  : /usr/bin/gcc-4.0
preprocessor flags        : -I/opt/local/include
executable compiler flags : -I/opt/local/include
module compiler flags     : -I/opt/local/include -fno-common
executable linker flags   : -L/opt/local/lib  
module linker flags       : -L/opt/local/lib  -bundle -flat_namespace -undefined suppress
library flags             : -liconv -ldl -ltermcap -lm -liconv -lc
installation basename     : zsh
binary install path       : /opt/local/bin
man page install path     : /opt/local/share/man
info install path         : /opt/local/share/info
functions install path    : /opt/local/share/zsh/4.3.2/functions
See config.modules for installed modules and functions.

So, I don't understand why zsh is linked against the wrong libncurses.
Same problem with the --with-curses-terminfo configure option.

Note that there's no problem with other software, like tin:

/opt/local/bin/tin:
        /opt/local/lib/libpcre.0.dylib (compatibility version 1.0.0, current version 1.1.0)
        /opt/local/lib/libncurses.5.dylib (compatibility version 5.0.0, current version 5.0.0)
        /opt/local/lib/libidn.11.dylib (compatibility version 17.0.0, current version 17.17.0)
        /opt/local/lib/libiconv.2.dylib (compatibility version 7.0.0, current version 7.0.0)
        /opt/local/lib/libintl.8.dylib (compatibility version 9.0.0, current version 9.0.0)
        /usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 88.1.7)

-- 
Vincent Lefèvre <vincent@vinc17.org> - Web: <http://www.vinc17.org/>
100% accessible validated (X)HTML - Blog: <http://www.vinc17.org/blog/>
Work: CR INRIA - computer arithmetic / Arenaire project (LIP, ENS-Lyon)

