From A.Main@dcs.warwick.ac.uk Sat Mar 30 17:24:12 1996
Received: from euclid.skiles.gatech.edu (list@euclid.skiles.gatech.edu [130.207.146.50]) by melb.werple.net.au (8.7.5/8.7.3) with ESMTP id RAA28362 for <mason@werple.mira.net.au>; Sat, 30 Mar 1996 17:24:10 +1000 (EST)
Received: (from list@localhost) by euclid.skiles.gatech.edu (8.7.3/8.7.3) id CAA12959; Sat, 30 Mar 1996 02:14:46 -0500 (EST)
Resent-Date: Sat, 30 Mar 1996 02:14:46 -0500 (EST)
From: Zefram <A.Main@dcs.warwick.ac.uk>
Message-Id: <17785.199603300713@stone.dcs.warwick.ac.uk>
Subject: Re: what is hackzero?
To: coleman@math.gatech.edu (Richard J. Coleman)
Date: Sat, 30 Mar 1996 07:13:46 +0000 (GMT)
Cc: zsh-workers@math.gatech.edu
In-Reply-To: <199603300645.BAA07659@redwood.skiles.gatech.edu> from "Richard J. Coleman" at Mar 30, 96 01:45:36 am
X-Loop: zefram@dcs.warwick.ac.uk
X-Stardate: [-31]7276.50
X-US-Congress: Moronic fuckers
MIME-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
Resent-Message-ID: <"fKP7Y.0.PA3.czDNn"@euclid>
Resent-From: zsh-workers@math.gatech.edu
X-Mailing-List: <zsh-workers@math.gatech.edu> archive/latest/873
X-Loop: zsh-workers@math.gatech.edu
Precedence: list
Resent-Sender: zsh-workers-request@math.gatech.edu
Content-Length: 1314
Status: OR

>Does anyone know what the global variable hackzero
>is for?  Offhand I can't figure out what bin_fg is
>doing with it.

% grep hackzero *
builtin.c:	    strcpy(hackzero, *argv);
globals.h:EXTERN char *hackzero;
init.c:    hackzero = argzero = *argv;

Looks like the shell can write into its argv[0].  Here's the code:

/**/
int
bin_fg(char *name, char **argv, char *ops, int func)
{
    int job, lng, firstjob = -1, retval = 0;

    if (ops['Z']) {
	if (*argv)
	    strcpy(hackzero, *argv);
	return 0;
    }

Okay, "jobs -Z foo" can set the shell's argv[0].  This works (try it),
and is undocumented.  It's a bit dangerous, as exceeding the length of
the actual argv[0] is easy and causes undefined behaviour.  It does in
fact cause trouble on some Unices if the length differs at all.

Note that argzero can't be used in place of hackzero, because it's only
a copy of argv[0].  And as argzero is what $0 refers to, $0 is
unaffected by the jobs -Z thing.

I think it's actually a potentially useful feature, as it allows a
long-running zsh script to change its name, in the manner of some
daemons.  (Actually, it should be just about possible to implement
init(8) in zsh... frightening, isn't it?)

Does someone here know enough about modifying argv to advise how this
could be modified to work better?

-zefram


