From zsh-workers-request@math.gatech.edu Sat Jan 09 15:27:55 1999
Return-Path: <zsh-workers-request@math.gatech.edu>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 1009 invoked from network); 9 Jan 1999 15:27:53 -0000
Received: from math.gatech.edu (list@130.207.146.50)
  by ns1.primenet.com.au with SMTP; 9 Jan 1999 15:27:53 -0000
Received: (from list@localhost)
	by math.gatech.edu (8.9.1/8.9.1) id KAA05931;
	Sat, 9 Jan 1999 10:24:54 -0500 (EST)
Resent-Date: Sat, 9 Jan 1999 10:24:54 -0500 (EST)
Message-Id: <199901091437.OAA09811@Indigo.thoth.u-net.com>
From: opk@thoth.u-net.com (Oliver Kiddle)
Date: Sat, 9 Jan 1999 14:37:01 +0000
X-Mailer: Mail User's Shell (7.2.6 beta(3) 11/17/96)
To: zsh-workers@math.gatech.edu
Subject: PATCH: Small fix for dynamic loading on IRIX 5.3
Resent-Message-ID: <"F1P-63.0.cS1.6Jtbs"@math>
Resent-From: zsh-workers@math.gatech.edu
X-Mailing-List: <zsh-workers@math.gatech.edu> archive/latest/4887
X-Loop: zsh-workers@math.gatech.edu
Precedence: list
Resent-Sender: zsh-workers-request@math.gatech.edu

When trying to compile zsh (either 3.1.5 or 3.1.5-pws-4) with dynamic
loading enabled on IRIX 5.3, I found that the dynamic code was not
being compiled despite the fact that it has worked well with previous
versions. I traced this down to the following line in configure:

checking if static/shared library linking is broken... yes
config.log showed the problem as:

configure:4642: checking if static/shared library linking is broken
cfe: Error: conftest1.c, line 5: Too many initial values for 'symlist1'
                (void *)0
                ^
Anyway, the problem is the section of code in aczsh.m4 for conftest1.c:
        extern char **environ;
        void *symlist1[] = {
                (void *)&environ,
                (void *)0
        };

The '[]' is being lost by autoconf so that the line of code in the
configure script appears as just:
        void *symlist1 = {
and SGI's compiler doesn't like this. With the correct conftest1/2
files compiled, the test would pass.

If I'm not mistaken, this is because autoconf sets [ and ] to be the m4
quoting characters. The fix is to use [[]]. I have attached a small
patch which fixes this (although you'll probably find it easier to redo
the change manually).

Oliver Kiddle

*** aczsh.m4	Fri Dec 18 08:48:01 1998
--- aczsh.m4	Sat Jan  9 14:22:32 1999
***************
*** 45,51 ****
  fi
  echo '
  	extern char **environ;
! 	void *symlist1[] = {
  		(void *)&environ,
  		(void *)0
  	};
--- 45,51 ----
  fi
  echo '
  	extern char **environ;
! 	void *symlist1[[]] = {
  		(void *)&environ,
  		(void *)0
  	};

