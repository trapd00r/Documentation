From zsh-users-return-14157-mason-zsh=primenet.com.au@sunsite.dk Thu May 21 16:23:35 2009
Return-Path: <zsh-users-return-14157-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 14011 invoked from network); 21 May 2009 16:23:22 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received: from new-brage.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.254.104)
  by ns1.primenet.com.au with SMTP; 21 May 2009 16:23:22 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 79060 invoked from network); 21 May 2009 16:23:04 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 21 May 2009 16:23:04 -0000
Received: (qmail 1018 invoked by alias); 21 May 2009 16:22:41 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 14157
Received: (qmail 1001 invoked from network); 21 May 2009 16:22:40 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 21 May 2009 16:22:40 -0000
Received: from vms173007pub.verizon.net (vms173007pub.verizon.net [206.46.173.7])
	by bifrost.dotsrc.org (Postfix) with ESMTP id 0557E8027106
	for <zsh-users@sunsite.dk>; Thu, 21 May 2009 18:22:25 +0200 (CEST)
Received: from torch.brasslantern.com ([96.249.201.13])
 by vms173007.mailsrvcs.net
 (Sun Java(tm) System Messaging Server 6.3-7.04 (built Sep 26 2008; 32bit))
 with ESMTPA id <0KK0003Z15GW8EC6@vms173007.mailsrvcs.net> for
 zsh-users@sunsite.dk; Thu, 21 May 2009 11:22:14 -0500 (CDT)
Received: from torch.brasslantern.com (localhost.localdomain [127.0.0.1])
	by torch.brasslantern.com (8.13.1/8.13.1) with ESMTP id n4LGM7b5014223	for
 <zsh-users@sunsite.dk>; Thu, 21 May 2009 09:22:08 -0700
Received: (from schaefer@localhost)	by torch.brasslantern.com
 (8.13.1/8.13.1/Submit) id n4LGM730014222	for zsh-users@sunsite.dk; Thu,
 21 May 2009 09:22:07 -0700
From: Bart Schaefer <schaefer@brasslantern.com>
Message-id: <090521092207.ZM14221@torch.brasslantern.com>
Date: Thu, 21 May 2009 09:22:07 -0700
In-reply-to: <20090521074103.GN27141@prunille.vinc17.org>
Comments: In reply to Vincent Lefevre <vincent@vinc17.org>
 "Re: prompt and ssh" (May 21,  9:41am)
References: <e7db6e960905190954j7be72739p6b521bca8e90fe7f@mail.gmail.com>
	<20090519200217.35368.qmail@smasher.org>
	<20090521074103.GN27141@prunille.vinc17.org>
X-Mailer: OpenZMail Classic (0.9.2 24April2005)
To: zsh-users@sunsite.dk
Subject: Re: prompt and ssh
MIME-version: 1.0
Content-type: text/plain; charset=us-ascii
X-Virus-Scanned: ClamAV 0.94.2/9377/Thu May 21 04:57:18 2009 on bifrost
X-Virus-Status: Clean

On May 21,  9:41am, Vincent Lefevre wrote:
} Subject: Re: prompt and ssh
}
} On 2009-05-20 08:02:16 +1200, Atom Smasher wrote:
} > you can test for SSH_CONNECTION, SSH_CLIENT, or SSH_TTY on the far side. 
} > i would recommend SSH_CONNECTION.
} 
} But this will not work well if you use "screen".

Depending on the platform you're on ...

if grep -q $SSH_CONNECTION[(w)1]\:$SSH_CONNECTION[(w)2] =(netstat -na)
then
    print Using SSH_CONNECTION: $SSH_CONNECTION
else
    print Invalid SSH_CONNECTION
fi

This "fails" only if you disconnect from screen but leave ssh connected.

Figuring out what the correct values should be and passing them to the
in-screen shell is another matter.  The suggestion of a wrapper for
screen that writes a file, combined with checking the file contents in
the precmd or preexec hooks, might do it.  E.g.:

    screen() {
	typeset -pm SSH_\* > ~/.screen_SSH
	screen "$@"
    }
    screen_ssh_precmd() {
	source ~/.screen_SSH
    }
    precmd_functions+=(screen_ssh_precmd)

That is probably a bit too simple -- you could check the file mod time
to avoid sourcing it unnecessarily, and it'd probably be wise check that
you own the file and no one else can write to it or to the directory
it's in, etc.

