From zsh-workers-return-19408-mason-zsh=primenet.com.au@sunsite.dk Sun Feb 08 21:01:52 2004
Return-Path: <zsh-workers-return-19408-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 8125 invoked from network); 8 Feb 2004 21:01:52 -0000
Received: from sunsite.dk (130.225.247.90)
  by ns1.primenet.com.au with SMTP; 8 Feb 2004 21:01:52 -0000
Received: (qmail 28571 invoked by alias); 8 Feb 2004 21:01:45 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 19408
Received: (qmail 28511 invoked from network); 8 Feb 2004 21:01:45 -0000
Received: from localhost (HELO sunsite.dk) (127.0.0.1)
  by localhost with SMTP; 8 Feb 2004 21:01:45 -0000
X-MessageWall-Score: 0 (sunsite.dk)
Received: from [195.92.195.173] by sunsite.dk (MessageWall 1.0.8) with SMTP; 8 Feb 2004 21:1:45 -0000
Received: from modem-80.green-mandarin.dialup.pol.co.uk ([62.137.23.80] helo=pwstephenson.fsnet.co.uk)
	by cmailg3.svr.pol.co.uk with esmtp (Exim 4.14)
	id 1Apw3k-0003Qb-1A
	for zsh-workers@sunsite.dk; Sun, 08 Feb 2004 21:01:44 +0000
Received: by pwstephenson.fsnet.co.uk (Postfix, from userid 501)
	id 6DD41865B; Sun,  8 Feb 2004 16:02:19 -0500 (EST)
Received: from pwstephenson.fsnet.co.uk (localhost [127.0.0.1])
	by pwstephenson.fsnet.co.uk (Postfix) with ESMTP id 56C13865A
	for <zsh-workers@sunsite.dk>; Sun,  8 Feb 2004 21:02:19 +0000 (GMT)
To: zsh-workers@sunsite.dk (Zsh hackers list)
Subject: PATCH: ulimit -aH
Date: Sun, 08 Feb 2004 21:02:18 +0000
From: Peter Stephenson <pws@pwstephenson.fsnet.co.uk>
Message-Id: <20040208210219.6DD41865B@pwstephenson.fsnet.co.uk>

`ulimit -aH' gives an error message.  This is presumably an oversight.

Index: Src/Builtins/rlimits.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Builtins/rlimits.c,v
retrieving revision 1.9
diff -u -r1.9 rlimits.c
--- Src/Builtins/rlimits.c	3 Apr 2003 09:55:49 -0000	1.9
+++ Src/Builtins/rlimits.c	8 Feb 2004 20:49:55 -0000
@@ -462,7 +462,7 @@
 static int
 bin_ulimit(char *name, char **argv, Options ops, int func)
 {
-    int res, resmask = 0, hard = 0, soft = 0, nres = 0;
+    int res, resmask = 0, hard = 0, soft = 0, nres = 0, all = 0;
     char *options;
 
     do {
@@ -486,11 +486,12 @@
 		    soft = 1;
 		    continue;
 		case 'a':
-		    if (*argv || options[1] || resmask) {
-			zwarnnam(name, "no arguments required after -a",
+		    if (resmask) {
+			zwarnnam(name, "no limits allowed with -a",
 				 NULL, 0);
 			return 1;
 		    }
+		    all = 1;
 		    resmask = (1 << RLIM_NLIMITS) - 1;
 		    nres = RLIM_NLIMITS;
 		    continue;
@@ -547,6 +548,11 @@
 		    resmask |= 1 << res;
 		    nres++;
 		}
+		if (all && res != -1) {
+		    zwarnnam(name, "no limits allowed with -a",
+			     NULL, 0);
+		    return 1;
+		}
 	    }
 	}
 	if (!*argv || **argv == '-') {
@@ -560,6 +566,10 @@
 	    nres++;
 	    continue;
 	}
+	if (all) {
+	    zwarnnam(name, "no arguments allowed after -a", NULL, 0);
+	    return 1;
+	}
 	if (res < 0)
 	    res = RLIMIT_FSIZE;
 	if (strcmp(*argv, "unlimited")) {


-- 
Peter Stephenson <pws@pwstephenson.fsnet.co.uk>
Work: pws@csr.com
Web: http://www.pwstephenson.fsnet.co.uk

