From zsh-users-return-13972-mason-zsh=primenet.com.au@sunsite.dk Thu Mar 26 09:46:17 2009
Return-Path: <zsh-users-return-13972-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 7716 invoked from network); 26 Mar 2009 09:46:14 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 26 Mar 2009 09:46:14 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 77498 invoked from network); 26 Mar 2009 09:45:58 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 26 Mar 2009 09:45:58 -0000
Received: (qmail 23176 invoked by alias); 26 Mar 2009 09:45:38 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 13972
Received: (qmail 23160 invoked from network); 26 Mar 2009 09:45:37 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 26 Mar 2009 09:45:37 -0000
Received: from n20.bullet.mail.ukl.yahoo.com (n20.bullet.mail.ukl.yahoo.com [87.248.110.137])
	by bifrost.dotsrc.org (Postfix) with SMTP id 440CB80EA0C1
	for <zsh-users@sunsite.dk>; Thu, 26 Mar 2009 10:45:23 +0100 (CET)
Received: from [217.12.4.214] by n20.bullet.mail.ukl.yahoo.com with NNFMP; 26 Mar 2009 09:45:22 -0000
Received: from [87.248.110.117] by t1.bullet.ukl.yahoo.com with NNFMP; 26 Mar 2009 09:45:22 -0000
Received: from [127.0.0.1] by omp222.mail.ukl.yahoo.com with NNFMP; 26 Mar 2009 09:45:17 -0000
X-Yahoo-Newman-Id: 627555.81611.bm@omp222.mail.ukl.yahoo.com
Received: (qmail 71322 invoked from network); 26 Mar 2009 09:45:22 -0000
DomainKey-Signature: a=rsa-sha1; q=dns; c=nofws;
  s=s1024; d=yahoo.fr;
  h=Received:X-YMail-OSG:X-Yahoo-Newman-Property:Date:From:To:Cc:Subject:Message-ID:Mail-Followup-To:References:MIME-Version:Content-Type:Content-Disposition:In-Reply-To:User-Agent;
  b=arL3VQt3gSqGdLTylDzaDuzh7Iu7kFdf/epVXJRN0WefKNkluR6kHT2Tm3C8PU/Q2xu2kxUOSeEn/F3YUUlt+QOyTXtTfdbDDYiljV7OlsboiyJc+wCrnMSIo1Q2xDzAXgHXr1Z93+NCv0auFipEmBK31kyROHuDIgTrQwWDA/E=  ;
Received: from unknown (HELO seebyte.com) (stephane_chazelas@78.105.235.196 with login)
  by smtp123.mail.ukl.yahoo.com with SMTP; 26 Mar 2009 09:45:22 -0000
X-YMail-OSG: _d6gOdEVM1nbVROTDVnMGeCTtB31D4x05bWKOmqCjzY_eSvgnkkOGSMnDYEr.0EMl8TRh6jnfnPgTOPvTJUlEhczJg7YZI4qbpXX9yJZcrBW4brM_seUgMZW5Go0GzC0Gs0iXGUDLfd1WpP0z93_6LZn4v3kNJ8Ku_Bkror.F6mtmJHK6H2mpenF4BXjV7JMUTFsEURUCyliP2el4P4WkIzop.euHPA-
X-Yahoo-Newman-Property: ymail-3
Date: Thu, 26 Mar 2009 09:45:20 +0000
From: Stephane Chazelas <stephane_chazelas@yahoo.fr>
To: Atom Smasher <atom@smasher.org>
Cc: Zsh Users <zsh-users@sunsite.dk>
Subject: Re: freebsd problems with carriage return
Message-ID: <chaz20090326094520.GA4852@seebyte.com>
Mail-Followup-To: Atom Smasher <atom@smasher.org>,
	Zsh Users <zsh-users@sunsite.dk>
References: <20090324101411.66890.qmail@smasher.org> <chaz20090324114727.GA5144@seebyte.com> <20090324213624.93603.qmail@smasher.org> <alpine.LNX.2.00.0903250227080.3609@averatec> <chaz20090325122302.GB5054@seebyte.com> <20090326081003.68165.qmail@smasher.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20090326081003.68165.qmail@smasher.org>
User-Agent: Mutt/1.5.16 (2007-09-19)
X-Virus-Scanned: ClamAV 0.92.1/9169/Thu Mar 26 05:13:48 2009 on bifrost
X-Virus-Status: Clean

2009-03-26 21:09:58 +1300, Atom Smasher:
[...]
> hhmmm... it may be related to a pipe (but it works as expected on linux, 
> with a pipe or redirect)... so maybe i can use a redirect as if it's a 
> pipe...
> 	http://smasher.org/tmp/snapshot154.png
[...]

Sorry, my previous email was a bit convoluted as I was writing
it while investigating. The last part of the email explained the
reason for the problem. On FreeBSD, tcgetpgrp() on a pipe
returns the id of the process group that is meant to receive a
SIGIO on that pipe (or 0 if nobody registered for SIGIO) while
rsync() expects it to return -1 (as it should according to POSIX
and its man page).

The effect of that is that as tcgetpgrp() return 0 instead of
-1, rsync things stdout is a terminal and as 0 is not the
progress group id of the process, it thinks it is running in
background so does *not* output its progress.

>
> the top half of that split screen is `tr` converting carriage returns into 
> newlines, and reading stdin from a fifo. the bottom half is rsync, with 
> stdout redirected into the fifo. it's working as desired and expected, even 
> on freebsd.
>
> what seems to me like just a slight variation of that, once again works on 
> linux and fails on freebsd:
> 	tr '\r' '\n' < <( rsync --progress --bwlimit=5 foo_in foo_out )
>  or:
> 	rsync --progress --bwlimit=5 foo_in foo_out > >( tr '\r' '\n' )
>
> my understanding of zsh; process substitution should operate as a fifo. so 
> i really don't get why it works as desired in the screen-shot, but not with 
> process substitution.
[...]

Same thing, it's all pipes, so falls into that case.

Cheers,
Stephane


