From zsh-workers-return-14822-mason-zsh=primenet.com.au@sunsite.dk Sat Jun 09 08:52:48 2001
Return-Path: <zsh-workers-return-14822-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 10051 invoked from network); 9 Jun 2001 08:52:46 -0000
Received: from sunsite.dk (130.225.51.30)
  by ns1.primenet.com.au with SMTP; 9 Jun 2001 08:52:46 -0000
Received: (qmail 1301 invoked by alias); 9 Jun 2001 08:52:25 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 14822
Received: (qmail 1290 invoked from network); 9 Jun 2001 08:52:24 -0000
X-Envelope-Sender-Is: Andrej.Borsenkow@mow.siemens.ru (at relayer david.siemens.de)
From: "Andrej Borsenkow" <Andrej.Borsenkow@mow.siemens.ru>
To: <zsh-workers@sunsite.dk>
Cc: <tjaalton@cc.hut.fi>, <tsm@cs.brown.edu>
Subject: RE: AIX-problem: the main module won't link statically
Date: Sat, 9 Jun 2001 12:52:29 +0400
Message-ID: <001d01c0f0c1$83ed8670$21c9ca95@mow.siemens.ru>
MIME-Version: 1.0
Content-Type: text/plain;
	charset="us-ascii"
Content-Transfer-Encoding: 7bit
X-Priority: 3 (Normal)
X-MSMail-Priority: Normal
X-Mailer: Microsoft Outlook IMO, Build 9.0.2416 (9.0.2911.0)
X-MimeOLE: Produced By Microsoft MimeOLE V5.50.4522.1200
In-Reply-To: <3B20DFF2.8C52CB74@u.genie.co.uk>
Importance: Normal

> Andrej Borsenkow wrote:
> >
> > My guess is that AIX 4.3 has dl* functions and hence AIXDYNAMIC
> is not used.
> > But something goes wrong with dlopen() & Co.
>
> That sounds quite plausible. I expect that it has retained the old calls
> though so it might be a good idea to make it use AIXDYNAMIC on AIX even
> if the dl* functions are found. What might be worth trying is to use a
> contrived config.cache which indicates that the dl* functions are not
> there.
>

Something like this? We already fiddle way too much with cache variables.

To Timo, Timothy - could you test it? If you are not building off CVS you
have to patch configure.in. Stock 4.0.1 won't work with autoconf-2.50; CVS
version will.

-andrej

Index: zshconfig.ac
===================================================================
RCS file: /cvsroot/zsh/zsh/zshconfig.ac,v
retrieving revision 1.5
diff -u -r1.5 zshconfig.ac
--- zshconfig.ac        2001/06/08 18:34:53     1.5
+++ zshconfig.ac        2001/06/09 08:47:50
@@ -1497,28 +1497,29 @@
 MOD_IMPORT_FUNCTION=
 aixdynamic=no
 hpuxdynamic=no
-if test "$ac_cv_func_dlopen"  != yes ||
-   test "$ac_cv_func_dlsym"   != yes ||
-   test "$ac_cv_func_dlerror" != yes; then
-  if test "$ac_cv_func_load"      != yes ||
-     test "$ac_cv_func_unload"    != yes ||
-     test "$ac_cv_func_loadbind"  != yes ||
-     test "$ac_cv_func_loadquery" != yes; then
-    if test "$ac_cv_func_shl_load" != yes ||
-       test "$ac_cv_func_shl_unload" != yes ||
-       test "$ac_cv_func_shl_findsym" != yes; then
-      dynamic=no
-    elif test "x$dynamic" = xyes; then
-      hpuxdynamic=yes
-      DL_EXT="${DL_EXT=sl}"
-      dnl autoheader won't allow us to define anything which isn't
-      dnl going into a header, and we can't undefine anything, so
-      dnl just define this anyway and rely on the later tests to
-      dnl define DYNAMIC or not.
-      AC_DEFINE(HPUXDYNAMIC)dnl
-    fi
-  elif test "x$dynamic" = xyes; then
+if test "$ac_cv_func_load"      = yes &&
+   test "$ac_cv_func_unload"    = yes &&
+   test "$ac_cv_func_loadbind"  = yes &&
+   test "$ac_cv_func_loadquery" = yes; then
+  dnl Force AIXDYNAMIC even on newer versions that have dl family
+  if test "x$dynamic" = xyes; then
     aixdynamic=yes
+  fi
+elif test "$ac_cv_func_dlopen"  != yes ||
+     test "$ac_cv_func_dlsym"   != yes ||
+     test "$ac_cv_func_dlerror" != yes; then
+  if test "$ac_cv_func_shl_load" != yes ||
+     test "$ac_cv_func_shl_unload" != yes ||
+     test "$ac_cv_func_shl_findsym" != yes; then
+    dynamic=no
+  elif test "x$dynamic" = xyes; then
+    hpuxdynamic=yes
+    DL_EXT="${DL_EXT=sl}"
+    dnl autoheader won't allow us to define anything which isn't
+    dnl going into a header, and we can't undefine anything, so
+    dnl just define this anyway and rely on the later tests to
+    dnl define DYNAMIC or not.
+    AC_DEFINE(HPUXDYNAMIC)dnl
   fi
 fi


