From zsh-workers-return-10465-mason-zsh=primenet.com.au@sunsite.auc.dk Tue Apr 04 12:54:40 2000
Return-Path: <zsh-workers-return-10465-mason-zsh=primenet.com.au@sunsite.auc.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 1678 invoked from network); 4 Apr 2000 12:54:39 -0000
Received: from sunsite.auc.dk (130.225.51.30)
  by ns1.primenet.com.au with SMTP; 4 Apr 2000 12:54:39 -0000
Received: (qmail 9444 invoked by alias); 4 Apr 2000 12:54:28 -0000
Mailing-List: contact zsh-workers-help@sunsite.auc.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.auc.dk
X-Seq: 10465
Received: (qmail 9437 invoked from network); 4 Apr 2000 12:54:27 -0000
Date: Tue, 4 Apr 2000 14:54:22 +0200 (MET DST)
Message-Id: <200004041254.OAA09834@beta.informatik.hu-berlin.de>
From: Sven Wischnowsky <wischnow@informatik.hu-berlin.de>
To: zsh-workers@sunsite.auc.dk
In-reply-to: Alexandre Duret-Lutz's message of 04 Apr 2000 12:24:31 +0200
Subject: PATCH: Re: _arguments questions


Alexandre Duret-Lutz wrote:

> ...
> 
> I have some troubles with nested `_arguments'...
> 
>   _foo () { 
>     _arguments -c -d -e
>   }
> 
>   _test () {
>     _arguments -a -b '-c:*::blah: _foo'
>   }
> 
> The wanted behaviour is that any arguments given after the first `-c' shall
> complete to `-c', `-d', or `-e'.  Unfortunately:
> 
>   phobos% compdef _test test
>   phobos% test -c -<TAB>
>   -a   -b
> 
> Strange. Tracing trough the code, I found that the call to `_arguments' in
> `_foo' returned 1 because `compargument -i' ensures that CURRENT > 1.

It has to do that because it has to parse a whole command line -- and
skip the command.

> Indeed, if I add a dummy option after the first `-c' it completes right :
> 
>   phobos% test -c -dummy -<TAB>
>   -c   -d   -e
> 
> Then, I can try to add this dummy word automatically :
> 
>   _bar () {
>     words=(dummy $words)
>     (( ++CURRENT ))
>     _foo
>   }
> 
>   _test () {
>     _arguments -a -b '-c:*::blah: _bar'
>   }
> 
> But the behaviour is now
> 
>   phobos% test -c -<TAB>
>   -a   -b   -c   -d   -e
> 
> with unwanted `-a' and `-b'. 

This is a bug. Result of 9621. Fixed by the patch below.

> ...
> 
> So questions are
>  1) is there a simplier way to nest `_arguments' ?

I don't see any. Sorry. Adding more syntactic sugar to the
_argument specs to support this doesn't seem worth it unless we put 
it into the <action>. Then it's quite simple (making _arguments
insert the dummy, probably using the option name for it).

Should we?


Bye
 Sven

Index: Src/Zle/computil.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/computil.c,v
retrieving revision 1.3
diff -u -r1.3 computil.c
--- Src/Zle/computil.c	2000/04/03 15:27:15	1.3
+++ Src/Zle/computil.c	2000/04/04 12:47:54
@@ -1427,7 +1427,8 @@
 	if ((ca_laststate.opt || (ca_laststate.doff && ca_laststate.def) ||
 	     (ca_laststate.def &&
 	      (ca_laststate.def->type == CAA_OPT ||
-	       ca_laststate.def->type >= CAA_RARGS))) &&
+	       (ca_laststate.def->type >= CAA_RARGS &&
+		ca_laststate.def->num < 0)))) &&
 	    (!ca_laststate.def || ca_laststate.def->type < CAA_RARGS ||
 	     (ca_laststate.def->type == CAA_RARGS ?
 	      (ca_laststate.curpos == ca_laststate.argbeg + 1) :

--
Sven Wischnowsky                         wischnow@informatik.hu-berlin.de

