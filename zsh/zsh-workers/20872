From zsh-workers-return-20872-mason-zsh=primenet.com.au@sunsite.dk Sat Feb 26 07:34:52 2005
Return-Path: <zsh-workers-return-20872-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 4820 invoked from network); 26 Feb 2005 07:34:51 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 26 Feb 2005 07:34:51 -0000
Received: (qmail 57438 invoked from network); 26 Feb 2005 07:34:45 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 26 Feb 2005 07:34:45 -0000
Received: (qmail 23222 invoked by alias); 26 Feb 2005 07:34:40 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 20872
Received: (qmail 23211 invoked from network); 26 Feb 2005 07:34:39 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 26 Feb 2005 07:34:39 -0000
Received: (qmail 57129 invoked from network); 26 Feb 2005 07:34:39 -0000
Received: from morda.newmail.ru (HELO flock1.newmail.ru) (212.48.140.150)
  by a.mx.sunsite.dk with SMTP; 26 Feb 2005 07:34:35 -0000
Received: (qmail 31172 invoked from network); 26 Feb 2005 07:19:18 -0000
Received: from unknown (HELO ?10.0.0.1?) (arvidjaar@newmail.ru@83.237.208.139)
  by smtpd.newmail.ru with SMTP; 26 Feb 2005 07:19:18 -0000
From: Andrey Borzenkov <arvidjaar@newmail.ru>
To: zsh-workers@sunsite.dk
Subject: Re: Crash in latest CVS
Date: Sat, 26 Feb 2005 10:34:24 +0300
User-Agent: KMail/1.7.2
References: <m3psyoknn7.fsf@zion.rcn.com>
In-Reply-To: <m3psyoknn7.fsf@zion.rcn.com>
MIME-Version: 1.0
Content-Type: Multipart/Mixed;
  boundary="Boundary-00=_BaCICDmAUIXiPF3"
Message-Id: <200502261034.25431.arvidjaar@newmail.ru>
X-Spam-Checker-Version: SpamAssassin 3.0.2 on a.mx.sunsite.dk
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=6.0 tests=AWL,BAYES_00 autolearn=ham 
	version=3.0.2
X-Spam-Hits: -2.6

--Boundary-00=_BaCICDmAUIXiPF3
Content-Type: text/plain;
  charset="iso-8859-1"
Content-Transfer-Encoding: 7bit
Content-Disposition: inline

On Saturday 26 February 2005 06:26, Vin Shelton wrote:
> In the latest CVS sources, the following sequence will crash the
> shell:
>
> ls /usr/local/bin/<TAB>
> zsh: do you wish to see all 522 possibilities (261 lines)? n
>
> Now it doesn't matter what I answer; zsh goes away.  Apparently, no
> core file is produced.  It also appears that yesterday's build did not
> crash.
>

fixed in attached patch. colour gcc really makes wonder :)

-andrey

--Boundary-00=_BaCICDmAUIXiPF3
Content-Type: text/x-diff;
  charset="iso-8859-1";
  name="zs_vs_zc.diff"
Content-Transfer-Encoding: 7bit
Content-Disposition: attachment;
	filename="zs_vs_zc.diff"

Index: Src/Zle/zle_utils.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/zle_utils.c,v
retrieving revision 1.23
diff -u -p -r1.23 zle_utils.c
--- Src/Zle/zle_utils.c	25 Feb 2005 15:10:01 -0000	1.23
+++ Src/Zle/zle_utils.c	26 Feb 2005 07:32:40 -0000
@@ -578,10 +578,10 @@ getzlequery(int yesno)
     if (yesno) {
 	if (c == ZWC('\t'))
 	    c = ZWC('y');
-	else if (ZS_icntrl(c) || c == ZLEEOF)
+	else if (ZC_icntrl(c) || c == ZLEEOF)
 	    c = ZWC('n');
 	else
-	    c = ZS_tolower(c);
+	    c = ZC_tolower(c);
     }
     /* echo response and return */
     if (c != ZWC('\n'))
Index: Src/Zle/zle_vi.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/zle_vi.c,v
retrieving revision 1.8
diff -u -p -r1.8 zle_vi.c
--- Src/Zle/zle_vi.c	25 Feb 2005 15:10:01 -0000	1.8
+++ Src/Zle/zle_vi.c	26 Feb 2005 07:32:40 -0000
@@ -571,9 +571,9 @@ vioperswapcase(UNUSED(char **args))
 	/* swap the case of all letters within range */
 	while (zlecs < c2) {
 	    if (islower(zleline[zlecs]))
-		zleline[zlecs] = ZS_toupper(zleline[zlecs]);
+		zleline[zlecs] = ZC_toupper(zleline[zlecs]);
 	    else if (isupper(zleline[zlecs]))
-		zleline[zlecs] = ZS_tolower(zleline[zlecs]);
+		zleline[zlecs] = ZC_tolower(zleline[zlecs]);
 	    zlecs++;
 	}
 	/* go back to the first line of the range */
@@ -811,9 +811,9 @@ viswapcase(UNUSED(char **args))
     eol = findeol();
     while (zlecs < eol && n--) {
 	if (islower(zleline[zlecs]))
-	    zleline[zlecs] = ZS_toupper(zleline[zlecs]);
+	    zleline[zlecs] = ZC_toupper(zleline[zlecs]);
 	else if (isupper(zleline[zlecs]))
-	    zleline[zlecs] = ZS_tolower(zleline[zlecs]);
+	    zleline[zlecs] = ZC_tolower(zleline[zlecs]);
 	zlecs++;
     }
     if (zlecs && zlecs == eol)
@@ -858,7 +858,8 @@ visetbuffer(UNUSED(char **args))
 	zmod.flags |= MOD_VIAPP;
     else
 	zmod.flags &= ~MOD_VIAPP;
-    zmod.vibuf = ZS_tolower(ch);
+    /* FIXME how portable is it for multibyte encoding? */
+    zmod.vibuf = ZC_tolower(ch);
     if (ch >= ZWC('1') && ch <= ZWC('9'))
 	zmod.vibuf += - (int)ZWC('1') + 26;
     else
Index: Src/Zle/zle_word.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/zle_word.c,v
retrieving revision 1.4
diff -u -p -r1.4 zle_word.c
--- Src/Zle/zle_word.c	25 Feb 2005 15:10:01 -0000	1.4
+++ Src/Zle/zle_word.c	26 Feb 2005 07:32:40 -0000
@@ -359,7 +359,7 @@ upcaseword(UNUSED(char **args))
 	while (zlecs != zlell && !iword(zleline[zlecs]))
 	    zlecs++;
 	while (zlecs != zlell && iword(zleline[zlecs])) {
-	    zleline[zlecs] = ZS_toupper(zleline[zlecs]);
+	    zleline[zlecs] = ZC_toupper(zleline[zlecs]);
 	    zlecs++;
 	}
     }
@@ -381,7 +381,7 @@ downcaseword(UNUSED(char **args))
 	while (zlecs != zlell && !iword(zleline[zlecs]))
 	    zlecs++;
 	while (zlecs != zlell && iword(zleline[zlecs])) {
-	    zleline[zlecs] = ZS_tolower(zleline[zlecs]);
+	    zleline[zlecs] = ZC_tolower(zleline[zlecs]);
 	    zlecs++;
 	}
     }
@@ -406,8 +406,8 @@ capitalizeword(UNUSED(char **args))
 	while (zlecs != zlell && iword(zleline[zlecs]) && !isalpha(zleline[zlecs]))
 	    zlecs++;
 	while (zlecs != zlell && iword(zleline[zlecs])) {
-	    zleline[zlecs] = (first) ? ZS_toupper(zleline[zlecs]) :
-		ZS_tolower(zleline[zlecs]);
+	    zleline[zlecs] = (first) ? ZC_toupper(zleline[zlecs]) :
+		ZC_tolower(zleline[zlecs]);
 	    first = 0;
 	    zlecs++;
 	}

--Boundary-00=_BaCICDmAUIXiPF3--

