From zsh-users-return-6398-mason-zsh=primenet.com.au@sunsite.dk Mon Jul 14 19:26:16 2003
Return-Path: <zsh-users-return-6398-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 13666 invoked from network); 14 Jul 2003 19:26:15 -0000
Received: from sunsite.dk (130.225.247.90)
  by ns1.primenet.com.au with SMTP; 14 Jul 2003 19:26:15 -0000
Received: (qmail 26522 invoked by alias); 14 Jul 2003 19:25:43 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 6398
Received: (qmail 26508 invoked from network); 14 Jul 2003 19:25:43 -0000
Received: from localhost (HELO sunsite.dk) (127.0.0.1)
  by localhost with SMTP; 14 Jul 2003 19:25:43 -0000
X-MessageWall-Score: 0 (sunsite.dk)
Received: from [4.64.233.9] by sunsite.dk (MessageWall 1.0.8) with SMTP; 14 Jul 2003 19:25:42 -0000
Received: (from schaefer@localhost)
	by candle.brasslantern.com (8.11.6/8.11.6) id h6EJPfW06621
	for zsh-users@sunsite.dk; Mon, 14 Jul 2003 12:25:41 -0700
From: Bart Schaefer <schaefer@brasslantern.com>
Message-Id: <1030714192541.ZM6620@candle.brasslantern.com>
Date: Mon, 14 Jul 2003 19:25:41 +0000
In-Reply-To: <20030714173555.GA4352@mithrandir.aperiodic.net>
Comments: In reply to Phil!Gregory <phil_g@pobox.com>
        "$? being clobbered?" (Jul 14,  1:35pm)
References: <20030714173555.GA4352@mithrandir.aperiodic.net>
X-Mailer: Z-Mail (5.0.0 30July97)
To: zsh-users@sunsite.dk
Subject: Re: $? being clobbered?
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii

On Jul 14,  1:35pm, Phil!Gregory wrote:
} Subject: $? being clobbered?
}
} I'm having a problem with zsh, and am not sure if it's a bug or a
} feature.  If I have a program executed in my prompt, its return status
} clobbers the value of $?, which isn't really what I want.

There's code in the precmd handler to preserve and restore $? but nothing
similar is done during prompt expansion.

Is there some reason to execute the command every time the prompt is
printed?  That is, does the command change from one prompt to the next?
If not, I suggest:

    unsetopt promptsubst
    PROMPT="%{$(echoti cub 80)%}> "	# Note double quotes

Otherwise I suggest using precmd:

    unsetopt promptsubst
    PROMPT='> '
    function precmd {
      echoti cub 80
    }

I feel compelled to remark that moving 80 columns left seems an odd way of
achieving 'setopt promptcr'.

