From zsh-workers-return-22593-mason-zsh=primenet.com.au@sunsite.dk Wed Aug 09 15:20:39 2006
Return-Path: <zsh-workers-return-22593-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 23997 invoked from network); 9 Aug 2006 15:20:36 -0000
X-Spam-Checker-Version: SpamAssassin 3.1.4 (2006-07-25) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.4 required=5.0 tests=AWL,BAYES_00,
	FORGED_RCVD_HELO autolearn=ham version=3.1.4
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 9 Aug 2006 15:20:36 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 90951 invoked from network); 9 Aug 2006 15:20:29 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 9 Aug 2006 15:20:29 -0000
Received: (qmail 29935 invoked by alias); 9 Aug 2006 15:20:26 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 22593
Received: (qmail 29925 invoked from network); 9 Aug 2006 15:20:25 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 9 Aug 2006 15:20:25 -0000
Received: (qmail 90637 invoked from network); 9 Aug 2006 15:20:25 -0000
Received: from cluster-d.mailcontrol.com (217.69.20.190)
  by a.mx.sunsite.dk with SMTP; 9 Aug 2006 15:20:23 -0000
Received: from cameurexb01.EUROPE.ROOT.PRI ([62.189.241.200])
	by rly38d.srv.mailcontrol.com (MailControl) with ESMTP id k79FIrlt012477
	for <zsh-workers@sunsite.dk>; Wed, 9 Aug 2006 16:20:20 +0100
Received: from news01.csr.com ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.1830);
	 Wed, 9 Aug 2006 16:17:09 +0100
Received: from news01.csr.com (localhost.localdomain [127.0.0.1])
	by news01.csr.com (8.13.4/8.13.4) with ESMTP id k79FH6ct010087
	for <zsh-workers@sunsite.dk>; Wed, 9 Aug 2006 16:17:06 +0100
Received: from csr.com (pws@localhost)
	by news01.csr.com (8.13.4/8.13.4/Submit) with ESMTP id k79FH6G4010084
	for <zsh-workers@sunsite.dk>; Wed, 9 Aug 2006 16:17:06 +0100
Message-Id: <200608091517.k79FH6G4010084@news01.csr.com>
X-Authentication-Warning: news01.csr.com: pws owned process doing -bs
To: zsh-workers@sunsite.dk (Zsh hackers list)
Subject: PATCH: non-existent files in MIME handler
Date: Wed, 09 Aug 2006 16:17:05 +0100
From: Peter Stephenson <pws@csr.com>
X-OriginalArrivalTime: 09 Aug 2006 15:17:09.0796 (UTC) FILETIME=[E21ABE40:01C6BBC6]
Content-Type: text/plain
MIME-Version: 1.0
X-Scanned-By: MailControl A-07-04-01 (www.mailcontrol.com) on 10.68.0.148

I have the numbers 1 to 8 registered as suffixes that use the MIME
handler, in order to show manual pages.  Then I needed to run
"evolution-2.4" (except that didn't work anyway, but that's another
story).

The fix here is reasonably straightforward and configurable, I think,
although there may be arguments about suitable a default.

It also fixes the bug that the status of commands passed through by the
similar execute-as-is mechanism was lost, since the handler always
returned 0.

Index: Doc/Zsh/contrib.yo
===================================================================
RCS file: /cvsroot/zsh/zsh/Doc/Zsh/contrib.yo,v
retrieving revision 1.59
diff -u -r1.59 contrib.yo
--- Doc/Zsh/contrib.yo	28 Jul 2006 09:52:35 -0000	1.59
+++ Doc/Zsh/contrib.yo	9 Aug 2006 15:11:18 -0000
@@ -1432,6 +1432,15 @@
 Defines flags to go with a handler; the context is as for the
 tt(handler) style, and the format is as for the flags in tt(mailcap).
 )
+item(tt(handle-nonexistent))(
+By default, arguments that don't correspond to files are not passed
+to the MIME handler in order to prevent it from intercepting commands found
+in the path that happen to have suffixes.  This style may be set to
+an array of extended glob patterns for arguments that will be passed to the
+handler even if they don't exist.  If it is not explicitly set it
+defaults to tt([[:alpha:]]:/*) which allows URLs to be passed to the MIME
+handler even though they don't exist in that format in the file system.
+)
 item(tt(handler))(
 Specifies a handler for a suffix; the suffix is given by the context as
 tt(:mime:.)var(suffix)tt(:), and the format of the handler is exactly
Index: Functions/MIME/zsh-mime-handler
===================================================================
RCS file: /cvsroot/zsh/zsh/Functions/MIME/zsh-mime-handler,v
retrieving revision 1.8
diff -u -r1.8 zsh-mime-handler
--- Functions/MIME/zsh-mime-handler	11 Apr 2006 18:49:05 -0000	1.8
+++ Functions/MIME/zsh-mime-handler	9 Aug 2006 15:11:18 -0000
@@ -48,7 +48,7 @@
 context=":mime:.${suffix}:"
 
 local handler flags no_sh no_bg
-local -a exec_asis
+local -a exec_asis hand_nonex
 
 # Set to a list of patterns which are ignored and executed as they are,
 # despite being called for interpretation by the mime handler.
@@ -56,6 +56,11 @@
 # they are, even if they have a suffix.
 zstyle -a $context execute-as-is exec_asis || exec_asis=('*(*)' '*(/)')
 
+# Set to a list of patterns for which the handler will be used even
+# if the file doesn't exist on the disk.
+zstyle -a $context handle-nonexistent hand_nonex ||
+  hand_nonex=('[[:alpha:]]#:/*')
+
 local pattern
 local -a files
 
@@ -74,10 +79,24 @@
   files=(${dirpref}${~pattern})
   if [[ -n ${files[(r)$1]} ]]; then
     "$@"
-    return 0
+    return
   fi
 done
 
+if [[ ! -e $1 ]]; then
+  local nonex_ok
+  for pattern in $hand_nonex; do
+    if [[ $1 = ${~pattern} ]]; then
+      nonex_ok=1
+      break
+    fi
+  done
+  if [[ -z $nonex_ok ]]; then
+    "$@"
+    return
+  fi
+fi
+
 zstyle -s $context handler handler ||
   handler="${zsh_mime_handlers[$suffix]}"
 zstyle -s $context flags flags ||

-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070


To access the latest news from CSR copy this link into a web browser:  http://www.csr.com/email_sig.php

