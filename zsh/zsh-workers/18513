From zsh-workers-return-18513-mason-zsh=primenet.com.au@sunsite.dk Fri May 09 10:50:48 2003
Return-Path: <zsh-workers-return-18513-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 1601 invoked from network); 9 May 2003 10:50:47 -0000
Received: from sunsite.dk (130.225.247.90)
  by ns1.primenet.com.au with SMTP; 9 May 2003 10:50:47 -0000
Received: (qmail 8538 invoked by alias); 9 May 2003 10:50:34 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 18513
Received: (qmail 8529 invoked from network); 9 May 2003 10:50:33 -0000
Received: from localhost (HELO sunsite.dk) (127.0.0.1)
  by localhost with SMTP; 9 May 2003 10:50:33 -0000
X-MessageWall-Score: 0 (sunsite.dk)
Received: from [130.209.240.35] by sunsite.dk (MessageWall 1.0.8) with SMTP; 9 May 2003 10:50:33 -0000
Received: from brava
	([130.209.243.215] helo=brava.dcs.gla.ac.uk.dcs.gla.ac.uk ident=root)
	by iona.dcs.gla.ac.uk with esmtp (Exim 3.36 #3)
	id 19E5SS-0000Mt-00
	for zsh-workers@sunsite.dk; Fri, 09 May 2003 11:50:32 +0100
Received: from localhost by brava.dcs.gla.ac.uk.dcs.gla.ac.uk (8.11.2/Dumb)
	id h49AoWD28613; Fri, 9 May 2003 11:50:32 +0100
Date: Fri, 9 May 2003 11:50:32 +0100 (BST)
From: Jonathan Paisley <jp-www@dcs.gla.ac.uk>
X-X-Sender: jp@brava
To: zsh-workers@sunsite.dk
Subject: PATCH: segfault bug in menu selection
Message-ID: <Pine.LNX.4.54.999.0305091144080.27949@brava>
MIME-Version: 1.0
Content-Type: TEXT/PLAIN; charset=US-ASCII

Hi,

This is a repost of a bug report I sent in January 2003. I have a
temporary workaround which is included below as a patch against zsh-4.0.6
(although I seem to remember that it applied fairly easily to the CVS
version then).

I'm not subscribed to the list; please include my address in any replies.

The original message (also quoted below):

	http://www.zsh.org/cgi-bin/mla/redirect?WORKERNUMBER=18128

The patch:

--- /tmp/zsh-4.0.6/Src/Zle/complist.c	Fri Aug  9 14:30:30 2002
+++ zsh-4.0.6/Src/Zle/complist.c	Thu Jan 23 11:31:41 2003
@@ -395,6 +395,7 @@
 static int mlprinted;
 static char *mstatus, *mlistp;
 static Cmatch **mtab, **mmtabp;
+static int mtab_been_reallocated;
 static Cmgroup *mgtab, *mgtabp;
 static struct listcols mcolors;

@@ -1573,6 +1574,8 @@
     if (mnew) {
 	int i;

+    	mtab_been_reallocated = 1;
+
 	i = columns * listdat.nlines;
 	free(mtab);
 	mtab = (Cmatch **) zalloc(i * sizeof(Cmatch **));
@@ -1647,6 +1650,7 @@
     Cmatch **p;
     Cmgroup *pg;
     Thingy cmd;
+    int     do_last_key = 0;
     Menustack u = NULL;
     int i = 0, acc = 0, wishcol = 0, setwish = 0, oe = onlyexpl, wasnext = 0;
     int space, lbeg = 0, step = 1, wrap, pl = nlnct, broken = 0, first = 1;
@@ -1689,6 +1693,7 @@
     mlines = 999999;
     mlbeg = 0;
     for (;;) {
+    	mtab_been_reallocated = 0;
 	if (mline < 0) {
 	    int x, y;
 	    Cmatch **p = mtab;
@@ -1778,7 +1783,16 @@

     getk:

-	if (!(cmd = getkeycmd()) || cmd == Th(z_sendbreak)) {
+    	if (!do_last_key) {
+	    cmd = getkeycmd();
+	    if (mtab_been_reallocated) {
+		do_last_key = 1;
+		continue;
+	    }
+    	}
+	do_last_key = 0;
+
+	if (!cmd || cmd == Th(z_sendbreak)) {
 	    zbeep();
 	    break;
 	} else if (nolist && cmd != Th(z_undo)) {


---------- Forwarded message ----------
From: jp-www
To: zsh-workers
Date: Sat, 18 Jan 2003 21:47:59 +0000 (GMT)
Subject: segfault bug in menu selection + diagnosis

Hi,

I'm new to zsh and have been playing with the nice completion stuff. I've
found a segfaulting bug which appears to be reproducable. This was against
zsh-4.0.6, but I've also confirmed it with the HEAD branch in CVS (18/1/03
21:20).

Steps to reproduce:

1. Start a new shell which uses new-style completion and the following
styles:

 zstyle ':completion:*:kill:*' menu yes select
 zstyle ':completion:*:kill:*' force-list always

These aren't actually necessary -- if you press tab enough times to
get the menu select to appear it happens too.

2. Type 'kill '
3. Press tab to get menu selection of processes (so a single process ID
appears on the command line and the first process in the list is
highlighted)
4. Resize your terminal to make it a bit wider, causing a SIGWINCH
5. Press the UP arrow
6. Segmentation fault should occur

If it doesn't happen straight away, try starting afresh and moving around
a little bit with the arrows before resizing.

This was on an i386 RedHat 8.0 system. The info below pertains to
zsh-4.0.6.

Backtrace indicates that the crash occurs in domenuselect() in
complist.c:2272, in a call to dosingle(**p), while deferencing p twice.
The memory it pointed to has been freed, and doing

  print (char*) p

in gdb shows a string (in this case):

  "=01;31:(jobs)*.Z=01;31:(jobs)*.gz=01;"...

So I suppose the memory has been reused for some strings that
have been later allocated.


I don't know enough about the structure of the source code to fix the
problem, but I think it's happening because the zrefresh() that's
called as a result of handling the SIGWINCH (the signal is delivered
during the domenuselect call to getkeycmd() at line 1781) eventually
causes complistmatches() to be called, thus freeing the 'mtab' global
array unexpectedly (at least to domenuselect()), so 'p' is invalid.

Thanks. I hope I've provided enough information to resolve the issue.



