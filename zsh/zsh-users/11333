From zsh-users-return-11333-mason-zsh=primenet.com.au@sunsite.dk Sun Mar 25 12:49:47 2007
Return-Path: <zsh-users-return-11333-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 17104 invoked from network); 25 Mar 2007 12:49:43 -0000
X-Spam-Checker-Version: SpamAssassin 3.1.8 (2007-02-13) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=BAYES_00,FORGED_RCVD_HELO
	autolearn=ham version=3.1.8
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 25 Mar 2007 12:49:43 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 11493 invoked from network); 25 Mar 2007 12:49:35 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 25 Mar 2007 12:49:35 -0000
Received: (qmail 6137 invoked by alias); 25 Mar 2007 12:49:27 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 11333
Received: (qmail 6126 invoked from network); 25 Mar 2007 12:49:27 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 25 Mar 2007 12:49:27 -0000
Received: (qmail 10153 invoked from network); 25 Mar 2007 12:49:27 -0000
Received: from mtaout03-winn.ispmail.ntl.com (81.103.221.49)
  by a.mx.sunsite.dk with SMTP; 25 Mar 2007 12:49:20 -0000
Received: from aamtaout04-winn.ispmail.ntl.com ([81.103.221.35])
          by mtaout03-winn.ispmail.ntl.com with ESMTP
          id <20070325124919.GTCO1468.mtaout03-winn.ispmail.ntl.com@aamtaout04-winn.ispmail.ntl.com>
          for <zsh-users@sunsite.dk>; Sun, 25 Mar 2007 13:49:19 +0100
Received: from pwslaptop.csr.com ([81.107.47.85])
          by aamtaout04-winn.ispmail.ntl.com with ESMTP
          id <20070325124919.UDWU29112.aamtaout04-winn.ispmail.ntl.com@pwslaptop.csr.com>
          for <zsh-users@sunsite.dk>; Sun, 25 Mar 2007 13:49:19 +0100
Received: from pwslaptop.csr.com (pwslaptop.csr.com [127.0.0.1])
	by pwslaptop.csr.com (8.13.8/8.13.7) with ESMTP id l2PCmCOJ005524
	for <zsh-users@sunsite.dk>; Sun, 25 Mar 2007 13:48:14 +0100
Message-Id: <200703251248.l2PCmCOJ005524@pwslaptop.csr.com>
From: Peter Stephenson <p.w.stephenson@ntlworld.com>
To: zsh-users@sunsite.dk
Subject: Re: users-hosts combination failing 
In-Reply-To: Message from Chris Johnson <cjohnson@cs.utk.edu> 
   of "Sat, 24 Mar 2007 11:09:02 -0400." <20070324150902.GA24489@cetus30.cs.utk.edu> 
Date: Sun, 25 Mar 2007 13:48:12 +0100

Chris Johnson wrote:
> Chris Johnson sent me the following 0.8K:
> 
> > Hi.  I've got one machine running zsh 4.2.5 with following completion
> > styles defined:
> > 
> >    zstyle '*:my-accounts' users user1 user2
> >    zstyle '*:my-accounts' hosts machine1 machine2 machine3
> >    zstyle '*:my-accounts' users-hosts user3@machine4 user4@machine5
> > 
> > If I type user3 and hit tab, machine4 is completed.  However, on another
> > machine with the exact same configurtion and zsh 4.2.6, I get all
> > machine* offered as possible completions.  I know I should probably
> > update to a newer zsh, but is this problem known about and can anyone
> > offer a solution?
> 
> Hmm...  No responses yet.  Is there anyway I can I provide more
> information?

I've finally caught up with the problem, and it's still present.

_ssh_hosts was altered so that it unconditionally searches the list of
hosts in the configuration file.  The documentation of the users-hosts
style is quite clear that it shouldn't if there was a match there:

users-hosts
     The values of this style should be of the form `USER@HOST' or
     `USER:HOST'. It is used for commands that need pairs of user- and
     hostnames.  These commands will complete usernames from this style
     (only), and will restrict subsequent hostname completion to hosts
     paired with that user in one of the values of the style.

So the behaviour is wrong.  This patch makes _ssh_hosts return if
users-hosts matches.

There may be cases where this gives less than optimum behaviour,
but I don't think so:  at this point we're only completing the host
part so we've already got the user name to test.

Index: Completion/Unix/Command/_ssh
===================================================================
RCS file: /cvsroot/zsh/zsh/Completion/Unix/Command/_ssh,v
retrieving revision 1.31
diff -u -r1.31 _ssh
--- Completion/Unix/Command/_ssh	14 Nov 2006 17:16:40 -0000	1.31
+++ Completion/Unix/Command/_ssh	25 Mar 2007 12:48:49 -0000
@@ -326,11 +326,12 @@
   local config
   integer ind
 
+  # If users-hosts matches, we shouldn't complete anything else.
   if [[ "$IPREFIX" == *@ ]]; then
-    _combination -s '[:@]' my-accounts users-hosts "users=${IPREFIX/@}" hosts "$@"
+    _combination -s '[:@]' my-accounts users-hosts "users=${IPREFIX/@}" hosts "$@" && return
   else
     _combination -s '[:@]' my-accounts users-hosts \
-      ${opt_args[-l]:+"users=${opt_args[-l]:q}"} hosts "$@"
+      ${opt_args[-l]:+"users=${opt_args[-l]:q}"} hosts "$@" && return
   fi
   if (( ind = ${words[(I)-F]} )); then
     config=${~words[ind+1]}


-- 
Peter Stephenson <p.w.stephenson@ntlworld.com>
Web page now at http://homepage.ntlworld.com/p.w.stephenson/

