From zsh-workers-return-23567-mason-zsh=primenet.com.au@sunsite.dk Mon Jun 18 18:25:00 2007
Return-Path: <zsh-workers-return-23567-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 17452 invoked from network); 18 Jun 2007 18:24:57 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.1 (2007-05-02) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.1
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 18 Jun 2007 18:24:57 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 53234 invoked from network); 18 Jun 2007 18:24:51 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 18 Jun 2007 18:24:51 -0000
Received: (qmail 22285 invoked by alias); 18 Jun 2007 18:24:48 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 23567
Received: (qmail 22276 invoked from network); 18 Jun 2007 18:24:47 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 18 Jun 2007 18:24:47 -0000
Received: (qmail 52941 invoked from network); 18 Jun 2007 18:24:47 -0000
Received: from cluster-d.mailcontrol.com (217.69.20.190)
  by a.mx.sunsite.dk with SMTP; 18 Jun 2007 18:24:42 -0000
Received: from cameurexb01.EUROPE.ROOT.PRI ([62.189.241.200])
	by rly33d.srv.mailcontrol.com (MailControl) with ESMTP id l5IIOFve008750
	for <zsh-workers@sunsite.dk>; Mon, 18 Jun 2007 19:24:28 +0100
Received: from news01.csr.com ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.1830);
	 Mon, 18 Jun 2007 19:24:19 +0100
Date: Mon, 18 Jun 2007 19:24:19 +0100
From: Peter Stephenson <pws@csr.com>
To: zsh-workers@sunsite.dk
Subject: Re: how to customize _all_matches use?
Message-ID: <20070618192419.3ccc924b@news01.csr.com>
In-Reply-To: <200706161906.l5GJ63Rq014600@rly16c.srv.mailcontrol.com>
References: <200706161725.l5GHPwPm004038@pwslaptop.csr.com>
	<200706161906.l5GJ63Rq014600@rly16c.srv.mailcontrol.com>
Organization: CSR
X-Mailer: Claws Mail 2.9.1 (GTK+ 2.10.8; i386-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
X-OriginalArrivalTime: 18 Jun 2007 18:24:19.0376 (UTC) FILETIME=[E2C06B00:01C7B1D5]
X-Scanned-By: MailControl A-07-07-10 (www.mailcontrol.com) on 10.68.0.143

On Sat, 16 Jun 2007 21:05:42 +0200
Vadim Zeitlin <vz-zsh@zeitlins.org> wrote:
> I wonder if _complete_help can somehow be used to show the
> context for another completer?

Here's an implementation of _complete_help or _complete_debug for the
_generic completer.  After you've created a (non-completion) widget you
just need to type the key sequence for that, then the key sequence for the
generic widget, so it's a lot more useful than my first attempt.  Even so,
it takes more lines to describe than to implement.

Index: Doc/Zsh/compsys.yo
===================================================================
RCS file: /cvsroot/zsh/zsh/Doc/Zsh/compsys.yo,v
retrieving revision 1.201
diff -u -r1.201 compsys.yo
--- Doc/Zsh/compsys.yo	16 Jun 2007 17:53:56 -0000	1.201
+++ Doc/Zsh/compsys.yo	18 Jun 2007 18:18:54 -0000
@@ -3179,6 +3179,42 @@
 information available from the completion functions called, which in turn
 is determined by the user's own styles and other settings.
 )
+findex(_complete_help_generic)
+item(tt(_complete_help_generic))(
+Unlike other commands listed here, this must be created as a normal ZLE
+widget rather than a completion widget (i.e. with tt(zle -N)).  It
+is used for generating help with a widget bound to the tt(_generic)
+widget that is described above.
+
+If this widget is created using the name of the function, as it is by
+default, then when executed it will read a key sequence.  This is expected
+to be bound to a call to a completion function that uses the tt(_generic)
+widget.  That widget will be executed, and information provided in
+the same format that the tt(_complete_help) widget displays for
+contextual completion.
+
+If the widget's name contains tt(debug), for example if it is created
+as `tt(zle -N _complete_debug_generic _complete_help_generic)', it
+will read and execute the keystring for a generic widget as before,
+but then generate debugging information as done by tt(_complete_debug)
+for contextual completion.
+
+If the widget's name contains tt(noread), it will not read a keystring
+but instead arrange that the next use of a generic widget run in
+the same shell will have the effect as described above.
+
+The widget works by setting the shell parameter
+tt(ZSH_TRACE_GENERIC_WIDGET) which is read by tt(_generic).  Unsetting
+the parameter cancels any pending effect of the tt(noread) form.
+
+For example, after executing the following:
+
+example(zle -N _complete_debug_generic _complete_help_generic
+bindkey '^x:' _complete_debug_generic)
+
+typing `tt(C-x :)' followed by the key sequence for a generic widget
+will cause trace output for that widget to be saved to a file.
+)
 findex(_complete_tag (^Xt))
 item(tt(_complete_tag (^Xt)))(
 This widget completes symbol tags created by the tt(etags) or tt(ctags)
Index: Completion/Base/Utility/_complete_help_generic
===================================================================
RCS file: Completion/Base/Utility/_complete_help_generic
diff -N Completion/Base/Utility/_complete_help_generic
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ Completion/Base/Utility/_complete_help_generic	18 Jun 2007 18:18:54 -0000
@@ -0,0 +1,17 @@
+#autoload
+
+# Note this is a normal ZLE widget, not a completion widget.
+# A completion widget can't call another widget, while a normal
+# widget can.
+
+[[ $WIDGET = *noread* ]] || local ZSH_TRACE_GENERIC_WIDGET
+
+if [[ $WIDGET = *debug* ]]; then
+  ZSH_TRACE_GENERIC_WIDGET=_complete_debug
+else
+  ZSH_TRACE_GENERIC_WIDGET=_complete_help
+fi
+
+if [[ $WIDGET != *noread* ]]; then
+  zle read-command && zle $REPLY -w
+fi
Index: Completion/Base/Widget/_complete_debug
===================================================================
RCS file: /cvsroot/zsh/zsh/Completion/Base/Widget/_complete_debug,v
retrieving revision 1.5
diff -u -r1.5 _complete_debug
--- Completion/Base/Widget/_complete_debug	22 May 2005 15:46:36 -0000	1.5
+++ Completion/Base/Widget/_complete_debug	18 Jun 2007 18:18:54 -0000
@@ -11,7 +11,7 @@
 
 setopt xtrace
 : $ZSH_NAME $ZSH_VERSION
-_main_complete
+${1:-_main_complete}
 integer ret=$?
 unsetopt xtrace
 
Index: Completion/Base/Widget/_complete_help
===================================================================
RCS file: /cvsroot/zsh/zsh/Completion/Base/Widget/_complete_help,v
retrieving revision 1.5
diff -u -r1.5 _complete_help
--- Completion/Base/Widget/_complete_help	8 Jul 2002 08:59:40 -0000	1.5
+++ Completion/Base/Widget/_complete_help	18 Jun 2007 18:18:54 -0000
@@ -37,7 +37,7 @@
   }
   trap 'unfunction compadd zstyle' EXIT INT
 
-  _main_complete
+  ${1:-_main_complete}
 
   unfunction compadd zstyle
   trap - EXIT INT
Index: Completion/Base/Widget/_generic
===================================================================
RCS file: /cvsroot/zsh/zsh/Completion/Base/Widget/_generic,v
retrieving revision 1.3
diff -u -r1.3 _generic
--- Completion/Base/Widget/_generic	24 Apr 2005 18:38:01 -0000	1.3
+++ Completion/Base/Widget/_generic	18 Jun 2007 18:18:54 -0000
@@ -1,5 +1,12 @@
 #autoload
 
+if [[ -n $ZSH_TRACE_GENERIC_WIDGET ]]; then
+  local widget=$ZSH_TRACE_GENERIC_WIDGET
+  unset ZSH_TRACE_GENERIC_WIDGET
+  $widget _generic
+  return
+fi
+
 local curcontext="${curcontext:-}"
 
 if [[ -z "$curcontext" ]]; then


-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070


To access the latest news from CSR copy this link into a web browser:  http://www.csr.com/email_sig.php

To get further information regarding CSR, please visit our Investor Relations page at http://ir.csr.com/csr/about/overview

