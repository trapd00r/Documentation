From zsh-workers-return-23144-mason-zsh=primenet.com.au@sunsite.dk Fri Feb 02 22:45:53 2007
Return-Path: <zsh-workers-return-23144-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 28870 invoked from network); 2 Feb 2007 22:45:48 -0000
X-Spam-Checker-Version: SpamAssassin 3.1.7 (2006-10-05) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=BAYES_00,FORGED_RCVD_HELO 
	autolearn=ham version=3.1.7
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 2 Feb 2007 22:45:48 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 79015 invoked from network); 2 Feb 2007 22:45:42 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 2 Feb 2007 22:45:42 -0000
Received: (qmail 13194 invoked by alias); 2 Feb 2007 22:45:40 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 23144
Received: (qmail 13184 invoked from network); 2 Feb 2007 22:45:39 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 2 Feb 2007 22:45:39 -0000
Received: (qmail 78763 invoked from network); 2 Feb 2007 22:45:39 -0000
Received: from smtp.hrz.tu-freiberg.de (HELO smtp.tu-freiberg.de) (139.20.64.64)
  by a.mx.sunsite.dk with SMTP; 2 Feb 2007 22:45:33 -0000
Received: from localhost (localhost [127.0.0.1])
	by smtp.tu-freiberg.de (Postfix) with ESMTP id A69A68D678
	for <zsh-workers@sunsite.dk>; Fri,  2 Feb 2007 23:45:31 +0100 (CET)
X-Virus-Scanned: amavisd-new at tu-freiberg.de
Received: from smtp.tu-freiberg.de ([127.0.0.1])
	by localhost (smtp.tu-freiberg.de [127.0.0.1]) (amavisd-new, port 10024)
	with ESMTP id fnYUigXBx78k for <zsh-workers@sunsite.dk>;
	Fri,  2 Feb 2007 23:45:28 +0100 (CET)
Received: from pollux.tribut.de (h-165-47.stunet.tu-freiberg.de [139.20.165.47])
	by smtp.tu-freiberg.de (Postfix) with ESMTP id 6DC288D677
	for <zsh-workers@sunsite.dk>; Fri,  2 Feb 2007 23:45:28 +0100 (CET)
Received: from pollux.tribut.de (pollux.tribut.de [127.0.0.1])
	by pollux.tribut.de (Postfix) with ESMTP id 6D9155E803A
	for <zsh-workers@sunsite.dk>; Fri,  2 Feb 2007 23:45:29 +0100 (CET)
From: Felix Eckhofer <felix@tribut.de>
To: zsh-workers@sunsite.dk
Subject: PATCH: NULL-Pointer dereference in complist.c
Date: Fri, 2 Feb 2007 23:45:11 +0100
User-Agent: KMail/1.9.6
MIME-Version: 1.0
Content-Type: multipart/signed;
  boundary="nextPart1321070.0mduCDTZWW";
  protocol="application/pgp-signature";
  micalg=pgp-sha1
Content-Transfer-Encoding: 7bit
Message-Id: <200702022345.29023.felix@tribut.de>

--nextPart1321070.0mduCDTZWW
Content-Type: multipart/mixed;
  boundary="Boundary-01=_477wF17sozgAMqT"
Content-Transfer-Encoding: 7bit
Content-Disposition: inline

--Boundary-01=_477wF17sozgAMqT
Content-Type: text/plain;
  charset="us-ascii"
Content-Transfer-Encoding: quoted-printable
Content-Disposition: inline

Hi everyone.

Just recently I started to enjoy the wonders of zsh and it is definitely=20
the best shell I have used so far. Thanks for a great piece of=20
software!

However, I was quickly able to reproduce a segfault on my machine=20
(Ubuntu 6.10, zsh 4.3.2-13ubuntu1, x86_64). It happens, because at=20
complist.c:1848 s =3D=3D NULL. I wasn't able to understand completely what=
=20
happens but the attached patch works for me and seems reasonable.

Unfortunately, CVS seems down for the moment so I couldn't check whether=20
this is already fixed in HEAD. If it is, ignore me :)

Steps to reproduce:
  1) Open the menu completion in interactive mode.
  2) Press backspace.

I've also attached the backtrace. Let me know if you need any further=20
information.


best regards,
felix
=2D-=20
felix_eckhofer  *  [fli4l-/eis-team]  *  ICQ#_59008162

"Ein Betriebssystem sie zu knechten, sie alle zu finden,
 ins Dunkle zu treiben und ewig zu binden..."

--Boundary-01=_477wF17sozgAMqT
Content-Type: text/x-diff;
  charset="us-ascii";
  name="zsh_nullpointer_msearchpop.patch"
Content-Transfer-Encoding: quoted-printable
Content-Disposition: inline;
	filename="zsh_nullpointer_msearchpop.patch"

=2D-- zsh-4.2.6/Src/Zle/complist.c	2005-04-25 12:20:00.000000000 +0200
+++ zsh-4.2.6-patched/Src/Zle/complist.c	2007-02-02 23:06:36.000000000 +0100
@@ -1845,6 +1845,9 @@
 {
     Menusearch s =3D msearchstack;
=20
+    if (!s)
+        return NULL;
+
     if (s->prev)
         msearchstack =3D s->prev;
=20

--Boundary-01=_477wF17sozgAMqT
Content-Type: text/x-log;
  charset="us-ascii";
  name="gdb.log"
Content-Transfer-Encoding: quoted-printable
Content-Disposition: attachment;
	filename="gdb.log"

GNU gdb 6.4.90-debian
Copyright (C) 2006 Free Software Foundation, Inc.
GDB is free software, covered by the GNU General Public License, and you are
welcome to change it and/or distribute copies of it under certain condition=
s.
Type "show copying" to see the conditions.
There is absolutely no warranty for GDB.  Type "show warranty" for details.
This GDB was configured as "x86_64-linux-gnu"...Using host libthread_db lib=
rary "/lib/libthread_db.so.1".

(gdb) run
Starting program: /usr/local/bin/zsh=20

Program received signal SIGSEGV, Segmentation fault.
0x00002b5fcaed3658 in msearchpop (backp=3D0x7fffe0c27938) at complist.c:1848
1848	    if (s->prev)
(gdb)=20
(gdb) bt
#0  0x00002b5fcaed3658 in msearchpop (backp=3D0x7fffe0c27938) at complist.c=
:1848
#1  0x00002b5fcaed749d in domenuselect (dummy=3D0x2b5fcadc1968, dat=3D0x7ff=
fe0c27b00) at complist.c:2832
#2  0x000000000045d873 in runhookdef (h=3D0x2b5fcadc1968, d=3D0x7fffe0c27b0=
0) at module.c:1859
#3  0x00002b5fcaca5a9a in after_complete (dummy=3D0x2b5fcab8cc98, dat=3D0x7=
fffe0c27ba0) at compcore.c:496
#4  0x000000000045d8dd in runhookdef (h=3D0x2b5fcab8cc98, d=3D0x7fffe0c27ba=
0) at module.c:1865
#5  0x00002b5fcaa73f38 in docomplete (lst=3D0) at zle_tricky.c:824
#6  0x00002b5fcaa72616 in expandorcomplete (args=3D0x2b5fcab8d0e0) at zle_t=
ricky.c:288
#7  0x00002b5fcaa721dd in completecall (args=3D0x2b5fcab8d0e0) at zle_trick=
y.c:182
#8  0x00002b5fcaa64a2c in execzlefunc (func=3D0x2b5fcab89d58, args=3D0x2b5f=
cab8d0e0) at zle_main.c:933
#9  0x00002b5fcaa63f92 in zlecore () at zle_main.c:709
#10 0x00002b5fcaa646bc in zleread (lp=3D0x5c0e30, rp=3D0x5c0d68, flags=3D3,=
 context=3D0) at zle_main.c:863
#11 0x0000000000443a18 in inputline () at input.c:278
#12 0x00000000004438a5 in ingetc () at input.c:214
#13 0x00000000004398b5 in ihgetc () at hist.c:241
#14 0x000000000044d016 in gettok () at lex.c:631
#15 0x000000000044c776 in yylex () at lex.c:347
#16 0x000000000046a30f in parse_event () at parse.c:449
#17 0x00000000004406c5 in loop (toplevel=3D1, justonce=3D0) at init.c:128
#18 0x00000000004433f7 in zsh_main (argc=3D1, argv=3D0x7fffe0c282b8) at ini=
t.c:1280
#19 0x000000000040d0f3 in main (argc=3D1, argv=3D0x7fffe0c282b8) at ./main.=
c:93
(gdb) bt full
#0  0x00002b5fcaed3658 in msearchpop (backp=3D0x7fffe0c27938) at complist.c=
:1848
	s =3D (Menusearch) 0x0
#1  0x00002b5fcaed749d in domenuselect (dummy=3D0x2b5fcadc1968, dat=3D0x7ff=
fe0c27b00) at complist.c:2832
	back =3D 0
	np =3D (Cmatch **) 0x7fffe0c279b0
	p =3D (Cmatch **) 0x62db60
	pg =3D (Cmgroup *) 0x62c3a0
	cmd =3D (Thingy) 0x2b5fcab89790
	do_last_key =3D 0
	u =3D (Menustack) 0x0
	i =3D 1
	acc =3D 0
	wishcol =3D 0
	setwish =3D 0
	oe =3D 0
	wasnext =3D 0
	space =3D 39
	lbeg =3D 0
	step =3D 1
	wrap =3D -524125712
	pl =3D 1
	broken =3D 0
	first =3D 0
	nolist =3D 0
	mode =3D 2
	modecs =3D 14
	modell =3D 14
	modelen =3D 10
	s =3D 0x62f4f0 "search-forward"
	status =3D "isearch: \000=E9=C9_+\000\000\016\000\000\000\000\000\000\000=
=F0=FF=FF=FF=FF=FF=FF=FF\016\000\000\000\000\000\000\000 =B5b", '\0' <repea=
ts 22 times>, "\200p=CA_+\000\000\000X_\000\000\000\000\000=F0z=C2=E0=FF\17=
7\000\000eX=CA=CA_+\000\000\000\000\000\000\000\000\000\000=C0q^\000\000\00=
0\000\000\001\000\000\000\002\000\000\000\002\000\000\000\002\000\000"
	modeline =3D 0x2b5fca7081c0 "cd chrono-zsh/"
	fdat =3D (Chdata) 0x7fffe0c27b00
	lastsearch =3D 0x0
#2  0x000000000045d873 in runhookdef (h=3D0x2b5fcadc1968, d=3D0x7fffe0c27b0=
0) at module.c:1859
	p =3D (LinkNode) 0x5dfbd0
	r =3D 11103
#3  0x00002b5fcaca5a9a in after_complete (dummy=3D0x2b5fcab8cc98, dat=3D0x7=
fffe0c27ba0) at compcore.c:496
	cdat =3D {matches =3D 0x63ea30, num =3D 11, nmesg =3D 0, cur =3D 0x0}
	ret =3D 11103
#4  0x000000000045d8dd in runhookdef (h=3D0x2b5fcab8cc98, d=3D0x7fffe0c27ba=
0) at module.c:1865
No locals.
#5  0x00002b5fcaa73f38 in docomplete (lst=3D0) at zle_tricky.c:824
	s =3D 0x6190e0 ' ' <repeats 14 times>
	ol =3D 0x0
	olst =3D 4
	chl =3D 0
	ne =3D 0
	ocs =3D 3
	ret =3D 0
	dat =3D {0, 0}
	active =3D 1
#6  0x00002b5fcaa72616 in expandorcomplete (args=3D0x2b5fcab8d0e0) at zle_t=
ricky.c:288
	ret =3D 11103
#7  0x00002b5fcaa721dd in completecall (args=3D0x2b5fcab8d0e0) at zle_trick=
y.c:182
No locals.
#8  0x00002b5fcaa64a2c in execzlefunc (func=3D0x2b5fcab89d58, args=3D0x2b5f=
cab8d0e0) at zle_main.c:933
	atcurhist =3D 1
	wflags =3D 134
	r =3D 0
	ret =3D 0
	w =3D (Widget) 0x5f53e0
#9  0x00002b5fcaa63f92 in zlecore () at zle_main.c:709
No locals.
#10 0x00002b5fcaa646bc in zleread (lp=3D0x5c0e30, rp=3D0x5c0d68, flags=3D3,=
 context=3D0) at zle_main.c:863
	s =3D (unsigned char *) 0x0
	old_errno =3D 0
	tmout =3D 0
	initthingy =3D (Thingy) 0x0
#11 0x0000000000443a18 in inputline () at input.c:278
	flags =3D 3
	ingetcline =3D 0x0
	ingetcpmptl =3D (char **) 0x5c0e30
	ingetcpmptr =3D (char **) 0x5c0d68
	context =3D 0
#12 0x00000000004438a5 in ingetc () at input.c:214
	lastc =3D 0
#13 0x00000000004398b5 in ihgetc () at hist.c:241
	c =3D 0
#14 0x000000000044d016 in gettok () at lex.c:631
	c =3D 0
	d =3D 0
	peekfd =3D -1
	peek =3D 0
#15 0x000000000044c776 in yylex () at lex.c:347
No locals.
#16 0x000000000046a30f in parse_event () at parse.c:449
No locals.
#17 0x00000000004406c5 in loop (toplevel=3D1, justonce=3D0) at init.c:128
	prog =3D (Eprog) 0x5d9490
#18 0x00000000004433f7 in zsh_main (argc=3D1, argv=3D0x7fffe0c282b8) at ini=
t.c:1280
	t =3D (char **) 0x7fffe0c282c0
	t0 =3D 156
#19 0x000000000040d0f3 in main (argc=3D1, argv=3D0x7fffe0c282b8) at ./main.=
c:93
No locals.
(gdb) quit
The program is running.  Exit anyway? (y or n)=20
--Boundary-01=_477wF17sozgAMqT--

--nextPart1321070.0mduCDTZWW
Content-Type: application/pgp-signature

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.3 (GNU/Linux)

iD8DBQBFw78I6iGZQSR3yvgRAkf0AJ9A1V0ZRXdeACs7vOb386ziXr0zpQCeM/7+
fluhuxZm3vDdH5HCy8OglcU=
=Pf3t
-----END PGP SIGNATURE-----

--nextPart1321070.0mduCDTZWW--

