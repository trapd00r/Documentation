From zsh-workers-return-17166-mason-zsh=primenet.com.au@sunsite.dk Wed May 15 20:34:07 2002
Return-Path: <zsh-workers-return-17166-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 26380 invoked from network); 15 May 2002 20:34:06 -0000
Received: from sunsite.dk (130.225.247.90)
  by ns1.primenet.com.au with SMTP; 15 May 2002 20:34:06 -0000
Received: (qmail 3613 invoked by alias); 15 May 2002 20:33:50 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 17166
Received: (qmail 3583 invoked from network); 15 May 2002 20:33:44 -0000
To: zsh-workers@sunsite.auc.dk (Zsh hackers list)
Subject: PATCH: zftp
Date: Wed, 15 May 2002 21:33:41 +0100
From: Peter Stephenson <pws@pwstephenson.fsnet.co.uk>
Message-Id: <20020515203346.115961C0AD@pwstephenson.fsnet.co.uk>

Since I haven't posted a network patch today, here's a fix for closing a
zftp connection.  I only noticed this on Linux; Solaris was obviously
more forgiving about freed memory.

Index: Src/Modules/zftp.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Modules/zftp.c,v
retrieving revision 1.26
diff -u -r1.26 zftp.c
--- Src/Modules/zftp.c	25 Apr 2002 14:06:47 -0000	1.26
+++ Src/Modules/zftp.c	15 May 2002 20:31:56 -0000
@@ -2678,14 +2678,15 @@
 	zfsendcmd("QUIT\r\n");
     }
     if (zfsess->cin) {
-	fclose(zfsess->cin);
 	/*
 	 * We fdopen'd the TCP control fd; since we can't fdclose it,
 	 * we need to perform a full fclose, which invalidates the
-	 * TCP fd.
+	 * TCP fd.  We need to do this before closing the FILE, since
+	 * it's not usable afterwards.
 	 */
 	if (fileno(zfsess->cin) == zfsess->control->fd)
 	    zfsess->control->fd = -1;
+	fclose(zfsess->cin);
 	zfsess->cin = NULL;
     }
     if (zfsess->control) {

-- 
Peter Stephenson <pws@pwstephenson.fsnet.co.uk>
Work: pws@csr.com
Web: http://www.pwstephenson.fsnet.co.uk

