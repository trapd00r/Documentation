From zsh-workers-return-22597-mason-zsh=primenet.com.au@sunsite.dk Thu Aug 10 16:23:21 2006
Return-Path: <zsh-workers-return-22597-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 16277 invoked from network); 10 Aug 2006 16:23:18 -0000
X-Spam-Checker-Version: SpamAssassin 3.1.4 (2006-07-25) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.4 required=5.0 tests=AWL,BAYES_00,
	FORGED_RCVD_HELO autolearn=ham version=3.1.4
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 10 Aug 2006 16:23:18 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 55725 invoked from network); 10 Aug 2006 16:23:09 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 10 Aug 2006 16:23:09 -0000
Received: (qmail 26439 invoked by alias); 10 Aug 2006 16:23:07 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 22597
Received: (qmail 26429 invoked from network); 10 Aug 2006 16:23:06 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 10 Aug 2006 16:23:06 -0000
Received: (qmail 55451 invoked from network); 10 Aug 2006 16:23:06 -0000
Received: from cluster-c.mailcontrol.com (168.143.177.190)
  by a.mx.sunsite.dk with SMTP; 10 Aug 2006 16:23:05 -0000
Received: from cameurexb01.EUROPE.ROOT.PRI ([62.189.241.200])
	by rly20c.srv.mailcontrol.com (MailControl) with ESMTP id k7AGKHDg032435
	for <zsh-workers@sunsite.dk>; Thu, 10 Aug 2006 17:23:00 +0100
Received: from news01.csr.com ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.1830);
	 Thu, 10 Aug 2006 17:22:55 +0100
Received: from news01.csr.com (localhost.localdomain [127.0.0.1])
	by news01.csr.com (8.13.4/8.13.4) with ESMTP id k7AGMtCT027184
	for <zsh-workers@sunsite.dk>; Thu, 10 Aug 2006 17:22:55 +0100
Received: from csr.com (pws@localhost)
	by news01.csr.com (8.13.4/8.13.4/Submit) with ESMTP id k7AGMtNn027181
	for <zsh-workers@sunsite.dk>; Thu, 10 Aug 2006 17:22:55 +0100
Message-Id: <200608101622.k7AGMtNn027181@news01.csr.com>
X-Authentication-Warning: news01.csr.com: pws owned process doing -bs
To: zsh-workers@sunsite.dk
Subject: Re: PATCH: complist with long display lines 
In-reply-to: <20060809230445.6eb66ce0.p.w.stephenson@ntlworld.com> 
References: <200608071540.k77FeWcL020899@news01.csr.com> <060807101946.ZM19622@torch.brasslantern.com> <20060809230445.6eb66ce0.p.w.stephenson@ntlworld.com>
Comments: In-reply-to Peter Stephenson <p.w.stephenson@ntlworld.com>
   message dated "Wed, 09 Aug 2006 23:04:45 +0100."
Date: Thu, 10 Aug 2006 17:22:54 +0100
From: Peter Stephenson <pws@csr.com>
X-OriginalArrivalTime: 10 Aug 2006 16:22:55.0719 (UTC) FILETIME=[3C788F70:01C6BC99]
Content-Type: text/plain
MIME-Version: 1.0
X-Scanned-By: MailControl A-07-04-01 (www.mailcontrol.com) on 10.67.0.130

Peter Stephenson wrote:
> The same mistake seems to appear somewhere else, I think, and with some
> trepidation I've changed an occurrence in printfmt() in zle_tricky.c;
> you'll see that it does subtract the 1 further up in the bit where it's
> found a newline.

This appears to be wrong both here and the corresponding change in
complist.c, functions printfmt() and compprintfmt() respectively.  This
turned up when I was using the file-list zstyle with a description which
(including the file name at the end) just happened to hit the right hand
edge of the screen.  In this case, unlike the others, you get a new line at
the end of the display; I'm guessing this makes the difference.  (However,
obviously it isn't the calculation I'm modifying that produces the extra
newline, so I don't know where that comes from.)  The two changes affect
the non-complist and complist display of the same output.

This is different from the other cases because... er... oh look!  There's
Superman!  Over there!

Luckily, changing these doesn't undo the main point of the fix.  Phew.
I've subjected this to the combinations of tests I know about and they all
seem to work.

Index: Src/Zle/complist.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/complist.c,v
retrieving revision 1.88
diff -u -r1.88 complist.c
--- Src/Zle/complist.c	9 Aug 2006 22:08:38 -0000	1.88
+++ Src/Zle/complist.c	10 Aug 2006 16:15:47 -0000
@@ -1055,8 +1055,12 @@
     if (stat && n)
 	mfirstl = -1;
 
-    mlprinted = l + (cc ? ((cc-1) / columns) : 0);
-    return mlprinted;	    
+    /*
+     * *Not* subtracting 1 from cc at this point appears to be
+     * correct.  C.f. printfmt in zle_tricky.c.
+     */
+    mlprinted = l + (cc / columns);
+    return mlprinted;
 }
 
 /* This is like zputs(), but allows scrolling. */
Index: Src/Zle/zle_tricky.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/zle_tricky.c,v
retrieving revision 1.71
diff -u -r1.71 zle_tricky.c
--- Src/Zle/zle_tricky.c	9 Aug 2006 22:08:39 -0000	1.71
+++ Src/Zle/zle_tricky.c	10 Aug 2006 16:15:49 -0000
@@ -2175,7 +2174,12 @@
 		putc(' ', shout);
 	}
     }
-    return l + ((cc-1) / columns);
+    /*
+     * Experiments suggest that at this point not subtracting 1 from
+     * cc is correct, i.e. if just misses wrapping we still add 1.
+     * (Why?)
+     */
+    return l + (cc / columns);
 }
 
 /* This is used to print expansions. */

-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070


To access the latest news from CSR copy this link into a web browser:  http://www.csr.com/email_sig.php

