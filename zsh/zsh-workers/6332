From zsh-workers-return-6332-mason-zsh=primenet.com.au@sunsite.auc.dk Sat May 22 16:11:25 1999
Return-Path: <zsh-workers-return-6332-mason-zsh=primenet.com.au@sunsite.auc.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 16941 invoked from network); 22 May 1999 16:11:23 -0000
Received: from sunsite.auc.dk (130.225.51.30)
  by ns1.primenet.com.au with SMTP; 22 May 1999 16:11:23 -0000
Received: (qmail 6150 invoked by alias); 22 May 1999 16:11:14 -0000
Mailing-List: contact zsh-workers-help@sunsite.auc.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.auc.dk
X-Seq: 6332
Received: (qmail 6143 invoked from network); 22 May 1999 16:11:13 -0000
Message-Id: <9905221525.AA30851@ibmth.df.unipi.it>
To: zsh-workers@sunsite.auc.dk (Zsh hackers list)
Subject: PATCH: pws-19: associative array interface to files
Date: Sat, 22 May 1999 17:25:22 +0200
From: Peter Stephenson <pws@ibmth.df.unipi.it>

This is why I was looking at the parameter module so closely:  it's an
associative array interface to files, just so that Bart can do `vared
mapfile[foo]' to edit the file foo.  All the finnicky parameter details are
simply copied from parameter.c, which is why Sven is in the copyright as
co-author.  See the manual page for more details of how to use this (the
interface is open to possible criticism).

I implemented I/O in what should be an efficient way by using mmap() if
available (and provided all the other bits I need for my way of doing
things, munmap(), msync(), ftruncate(), <sys/mman.h> are there, too): note
that so far I've only tried this on AIX, whose memory management is a bit
sui generis, so it's possible the mmap() stuff is going to fail on other
systems.  However, I hope that in convering AIX I've covered pretty much
what the OS writers can throw at it.  You can #undef USE_MMAP to compile if
you need to to try it out.

Unfortunately, zsh's internal memory management is anything but efficient.
For example, if you vared a file this way, the file is read twice: once for
use by the editor, then again when vared retrieves the modified struct pm
to write to it; there's currently no way mapfile can know that the value
it's making is not going to be used, nor can it know when it will be called
next, so there's no way of caching the value.  Also, the file can
potentially be copied any number of times by the handling in paramsubst(),
though in general we can't really do a lot about this.  I have a number of
remarks and questions on parameter and related memory and efficiency
issues, which I'll post separately (not today).

A separate issue is the zmodload interface: I'd quite like it to change
things so that you can pass arguments to the module you're loading to
configure it, so that for example you can call the variable something other
than mapfile.  That's only a half-way street anyway, since you can't use
multiple file mapping variables which would need some other interface to
the module to arrange, probably beyond the scope of zmodload.  But it might
be useful anyway, although it's not that important.  Does anybody use
zmodload with multiple library arguments?  It could be made to require a
flag.

begin 644 mapfile.dif.gz
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
/Y]=7D][_`Y7OZLLF-P``
`
end
-- 
Peter Stephenson <pws@ibmth.df.unipi.it>       Tel: +39 050 844536
WWW:  http://www.ifh.de/~pws/
Dipartimento di Fisica, Via Buonarroti 2, 56127 Pisa, Italy

