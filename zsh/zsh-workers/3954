From zsh-workers-request@math.gatech.edu Fri May 08 12:10:42 1998
Return-Path: <zsh-workers-request@math.gatech.edu>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 787 invoked from network); 8 May 1998 12:10:40 -0000
Received: from math.gatech.edu (list@130.207.146.50)
  by ns1.primenet.com.au with SMTP; 8 May 1998 12:10:40 -0000
Received: (from list@localhost)
	by math.gatech.edu (8.8.5/8.8.5) id IAA15409;
	Fri, 8 May 1998 08:01:50 -0400 (EDT)
Resent-Date: Fri, 8 May 1998 08:01:50 -0400 (EDT)
From: pws@ibmth.df.unipi.it
Message-Id: <9805081159.AA29730@ibmth.df.unipi.it>
To: zsh-workers@math.gatech.edu
Subject: PATCH: more dynamic loading on AIX
In-Reply-To: "hzoli@cs.elte.hu"'s message of "Wed, 06 May 98 01:46:14 EST."
             <199805060646.BAA02655@hzoli.home> 
Date: Fri, 08 May 98 13:59:52 +0100
Resent-Message-ID: <"hI3f42.0.fm3.kGlKr"@math>
Resent-From: zsh-workers@math.gatech.edu
X-Mailing-List: <zsh-workers@math.gatech.edu> archive/latest/3954
X-Loop: zsh-workers@math.gatech.edu
Precedence: list
Resent-Sender: zsh-workers-request@math.gatech.edu

hzoli@cs.elte.hu wrote:
> The patch below implements dynamic loading on AIX.

This is a good thing to have.  I tried it, and encountered the
following problems

1) module.c was trying to include <link.h>.  This doesn't exist here
under AIX 3.2, nor does it seem to be there on a 4.1 system at the
other end of Europe.  If it's sometimes necessary, it should probably
be tested for in configure.

2) AIXDYNAMIC was missing from config.h.in and so didn't appear in
config.h.  I am correct that config.h.in needs to be updated by hand,
not by autoconf?

3) I made comp1 and zle builtin, mainly as an act of cowardice after
my experience with IRIX, but even so loading compctl or deltochar
causes a core dump.  As far as I can see, it seems to be happening
when trying to call init_module(), which is special for the AIX
version.  Recompiling with compctl also builtin seems to work.
On the other hand, the remaining libraries (stat, file, ...) work fine
dynamically.  Any ideas?

Here's the simplest possible patch for the first two.

*** Src/module.c.aix	Fri May  8 11:53:19 1998
--- Src/module.c	Fri May  8 11:53:38 1998
***************
*** 204,210 ****
  #else
  # include <sys/types.h>
  # include <nlist.h>
- # include <link.h>
  #endif
  #ifndef HAVE_DLCLOSE
  # define dlclose(X) ((X), 0)
--- 204,209 ----
*** config.h.in.aix	Fri May  8 11:53:11 1998
--- config.h.in	Fri May  8 11:53:21 1998
***************
*** 256,261 ****
--- 256,264 ----
  /* Define to 1 if you want to use dynamically loaded modules */
  #undef DYNAMIC
  
+ /* Define to 1 if you want to use dynamically loaded modules on AIX */
+ #undef AIXDYNAMIC
+ 
  /* Define if you have the cap_init function.  */
  #undef HAVE_CAP_INIT
  
-- 
Peter Stephenson <pws@ibmth.df.unipi.it>       Tel: +39 50 844536
WWW:  http://www.ifh.de/~pws/
Gruppo Teorico, Dipartimento di Fisica
Piazza Torricelli 2, 56100 Pisa, Italy

