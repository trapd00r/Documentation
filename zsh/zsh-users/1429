From zsh-workers-request@math.gatech.edu Thu Mar 26 18:13:22 1998
Return-Path: <zsh-workers-request@math.gatech.edu>
Delivered-To: mason@primenet.com.au
Received: (qmail 3245 invoked from network); 26 Mar 1998 18:13:21 -0000
Received: from math.gatech.edu (list@130.207.146.50)
  by ns1.primenet.com.au with SMTP; 26 Mar 1998 18:13:21 -0000
Received: (from list@localhost)
	by math.gatech.edu (8.8.5/8.8.5) id NAA13558;
	Thu, 26 Mar 1998 13:08:53 -0500 (EST)
Resent-Date: Thu, 26 Mar 1998 13:05:03 -0500 (EST)
From: Andrew Main <zefram@tao.co.uk>
Message-Id: <199803261804.SAA15968@taos.demon.co.uk>
Subject: Re: clobber, diff, and any other suggestions...
To: sweth@astaroth.nit.gwu.edu (Sweth Chandramouli)
Date: Thu, 26 Mar 1998 18:04:15 +0000 (GMT)
Cc: zsh-users@math.gatech.edu
In-Reply-To: <19980326120453.15435@astaroth.nit.gwu.edu> from "Sweth Chandramouli" at Mar 26, 98 12:04:53 pm
X-Loop: zefram@tao.co.uk
X-Headers: in preparation
X-Mailer: ELM [version 2.4 PL25]
MIME-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
Resent-Message-ID: <"nhVux2.0.cI3.EZf6r"@math>
Resent-From: zsh-users@math.gatech.edu
X-Mailing-List: <zsh-users@math.gatech.edu> archive/latest/1429
X-Loop: zsh-users@math.gatech.edu
X-Loop: zsh-workers@math.gatech.edu
Precedence: list
Resent-Sender: zsh-workers-request@math.gatech.edu

Sweth Chandramouli wrote:
>	the first little block of script is, obviously, to create zero-length 
>files (or zero out existing files), because the current settings on zsh on my 
>machine don't let >> create a file, only append, and don't let > clobber a file, 
>only create.  i could swear that the last zsh install i used had the oppostie 
>behavior for both, and that the option to set it was clobber/noclobber, but 
>doing a search on noclobber in the man page returns nothing, while searching for 
>clobber only returns HIST_ALLOW_CLOBBER.  so first, what is that switch?

It is (NO_)CLOBBER, and it is in the man page.  The default is for
CLOBBER to be on; something in your setup must be turning it off.

>                                                                          is 
>there some one-time only version of > and >> to toggle that behavior

>! and >>!

>	the second block should first make a list of every directory under the 
>one in which the script is run, and then check for lines beginning with 
>'Message-ID', 'Message-Id', or 'References' in all files in those directories, 

	find . -type f -print0 | xargs -0 ./process_files

(if you have GNU tools -- otherwise change "-print0" to "-print" and drop
"-0").  This is much more efficient and scalable than anything you can
do in zsh builtins.  The process_files script should be something like

	#!/usr/local/bin/zsh -f
	for f; do
		sed -n '/^$/q
			/^References:/{
				s/^[^:]*: *//
				s/  *$//
				s/  */ /g
				p
			}' $f
		sed -n '/^$/q
			/^Message-I[dD]:/{
				s/^[^:]*: *//
				s/  *$//
				p
			}' $f >&3
	done 3>> messages | tr ' ' '\012' >> referenced

Or you can do all that in Perl for greater efficiency -- those forks
don't come cheap, you know.  When all that has finished, you'll have
files containing unsorted message-IDs.  Run

	comm -13 <(sort messages) <(sort -u referenced)

to get a list of unique message-IDs of messages that are referenced but
not available.

zsh's clever features aren't really helpful on large scale jobs like this,
but its flexible plumbing does come in handy.

-zefram

