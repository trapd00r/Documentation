From zsh-users-return-11779-mason-zsh=primenet.com.au@sunsite.dk Fri Aug 17 16:04:25 2007
Return-Path: <zsh-users-return-11779-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 12249 invoked from network); 17 Aug 2007 16:04:20 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.1 (2007-05-02) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=BAYES_00 autolearn=ham
	version=3.2.1
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 17 Aug 2007 16:04:20 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 27718 invoked from network); 17 Aug 2007 16:04:13 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 17 Aug 2007 16:04:13 -0000
Received: (qmail 11429 invoked by alias); 17 Aug 2007 16:04:01 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 11779
Received: (qmail 8081 invoked from network); 17 Aug 2007 15:56:37 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 17 Aug 2007 15:56:37 -0000
Received: (qmail 14586 invoked from network); 17 Aug 2007 15:56:36 -0000
Received: from amsterdam.lcs.mit.edu (18.26.4.9)
  by a.mx.sunsite.dk with SMTP; 17 Aug 2007 15:56:30 -0000
Received: from amsterdam.lcs.mit.edu (localhost.lcs.mit.edu [127.0.0.1])
	by amsterdam.lcs.mit.edu (8.13.3/8.13.3) with ESMTP id l7HFuRhP086835;
	Fri, 17 Aug 2007 11:56:27 -0400 (EDT)
	(envelope-from kaminsky+zsh@amsterdam.lcs.mit.edu)
Received: (from kaminsky@localhost)
	by amsterdam.lcs.mit.edu (8.13.3/8.13.3/Submit) id l7HFuRim086834;
	Fri, 17 Aug 2007 11:56:27 -0400 (EDT)
	(envelope-from kaminsky+zsh@amsterdam.lcs.mit.edu)
Date: Fri, 17 Aug 2007 11:56:27 -0400
From: Michael Kaminsky <kaminsky+zsh@pdos.csail.mit.edu>
To: zsh-users@sunsite.dk
Subject: zero elapsed time in history with certain preexec functions
Message-ID: <20070817155627.GA85697@amsterdam.lcs.mit.edu>
Mime-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
User-Agent: Mutt/1.4.2.1i

I use zsh's preexec function to set the title of my terminal, similar to
many of the examples posted online.  After defining preexec, however, I
noticed that zsh wasn't recording the duration of commands anymore.
After much experimentation, I believe I've come up some simple examples
to illustrate this behavior:

  $ zsh --version
  zsh 4.3.4 (i686-pc-linux-gnu)
  $ setopt|grep hist   
  extendedhistory
  histignoredups
  histignorespace
  histnostore
  $ unfunction preexec
  $ sleep 2 
  $ fc -ldD |tail -1
  12004  11:16  0:02  sleep 2 

(so far, so good)

  $ function preexec { echo $ZSH_VERSION } 
  $ sleep 2
  4.3.4
  $ fc -ldD |tail -1                      
  4.3.4                                      
  12014  11:18  0:02  sleep 2

(still good, but...)

  $ function preexec { echo $ZSH_VERSION[1] }
  4.3.4
  $ sleep 2
  4
  $ fc -ldD |tail -1                         
  4                                          
  12016  11:20  0:00  sleep 2

It appears that subscripting a variable (or indexing into a zsh array)
inside of the preexec function causes zsh not to record the elapsed
time/duration of the command.  There may be other actions that trigger
this behavior.  Another quick example:

  $ function preexec() { echo $1 }
  $ sleep 2
  sleep 2
  $ fc -ldD |tail -1
  fc -ldD |tail -1
  12040  11:25  0:02  sleep 2

(but...)

  $ function preexec() { echo ${(z)1} }
  function preexec() { echo ${(z)1} }
  $ sleep 2
  sleep 2
  $ fc -ldD |tail -1
  fc -ldD | tail -1
  12044  11:27  0:00  sleep 2


Any ideas?

Michael

