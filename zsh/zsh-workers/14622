From zsh-workers-return-14622-mason-zsh=primenet.com.au@sunsite.dk Thu May 31 17:22:47 2001
Return-Path: <zsh-workers-return-14622-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 13684 invoked from network); 31 May 2001 17:22:46 -0000
Received: from sunsite.dk (130.225.51.30)
  by ns1.primenet.com.au with SMTP; 31 May 2001 17:22:46 -0000
Received: (qmail 27437 invoked by alias); 31 May 2001 17:22:39 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 14622
Received: (qmail 27405 invoked from network); 31 May 2001 17:22:29 -0000
From: "Bart Schaefer" <schaefer@candle.brasslantern.com>
Message-Id: <1010531172048.ZM18548@candle.brasslantern.com>
Date: Thu, 31 May 2001 17:20:48 +0000
In-Reply-To: <1010531154643.ZM18373@candle.brasslantern.com>
Comments: In reply to "Bart Schaefer" <schaefer@candle.brasslantern.com>
        "Re: _man igores global matchers" (May 31,  3:46pm)
References: <000301c0e9d6$19e4ebc0$21c9ca95@mow.siemens.ru> 
	<1010531154643.ZM18373@candle.brasslantern.com>
X-Mailer: Z-Mail (5.0.0 30July97)
To: "Andrej Borsenkow" <Andrej.Borsenkow@mow.siemens.ru>,
        <zsh-workers@sunsite.dk>
Subject: Re: _man igores global matchers
MIME-Version: 1.0
Content-Type: multipart/mixed;
	boundary="PART-BOUNDARY=.11010531172048.ZM18548.brasslantern.com"

--
--PART-BOUNDARY=.11010531172048.ZM18548.brasslantern.com
Content-Type: text/plain; charset=us-ascii

I wrote:
}
} This patch drops the filtering on man page name and instead slurps up all
} the file basenames into the `rep' array, then passes that and the global
} matcher spec to compadd to let it sort out the mess.  If you have several
} matchers this can get pretty slow, so it ought at least to cache `rep'
} somewhere during the loop over the matchers; as it stands this is mostly
} a proof of concept.

Here's a better variation, which actually does cache the results for one
pass around the matcher loop.  It's quite a bit faster than with the
patch from 14621, but still slower than the existing _man.

The diff is bigger than the file, because of re-indentation, so I've just
attached the entire file.

-- 
Bart Schaefer                                 Brass Lantern Enterprises
http://www.well.com/user/barts              http://www.brasslantern.com

Zsh: http://www.zsh.org | PHPerl Project: http://phperl.sourceforge.net   

--PART-BOUNDARY=.11010531172048.ZM18548.brasslantern.com
Content-Description: Text
Content-Type: text/plain ; name="_man" ; charset=us-ascii
Content-Disposition: attachment ; filename="_man"
X-Zm-Content-Name: _man

#compdef man apropos whatis

local rep expl mrd

if [[ $service == man ]] && (( $words[(I)-l] + $words[(I)--local-file] )); then
  _files || return 0
fi

if (( ! $#manpath )); then
  local mp
  mp=($(manpath 2>/dev/null))
  [[ "$mp" == *:* ]] && mp=( ${(s.:.)mp} )
  manpath=( $mp )

  (( $#manpath )) || manpath=( ${(s.:.)$(manpath 2>/dev/null)} ) ||
    manpath=( /usr/man(-/) /(opt|usr)/(dt|share|X11R6|local)/(cat|)man(-/) )
fi

if (( _matcher_num < 2 )); then

  # `sman' is the SGML manual directory for Solaris 7.
  # 1M is system administrator commands on SVR4

  mrd=(${^manpath/\%L/${LANG:-En_US.ASCII}}/mandb(N))
  if [[ $words[2] = (<->*|1M|l|n) ]]; then
    rep=(
    $manpath/(sman|man|cat)${words[2]}/*.*(:t) )
    (($#mrd)) && rep[$#rep+1]=($(awk "\$2 == \"$words[2]\" {print \$1}" $mrd))
  else
    rep=( $manpath/(sman|man|cat)*/*.*(:t) )
    (($#mrd)) && rep[$#rep+1]=($(awk '{print $1}' $mrd))
  fi

  # Remove any compression suffix, then remove the minimum possible string
  # beginning with .<->: that handles problem cases like files called
  # `POSIX.1.5'.
  rep=(${${rep%%.(bz2|z|gz|Z)}%.<->*})

  mrd=( ${(q)rep} )
  eval "_man_cached() { rep=( $mrd ) }"

else

  _man_cached

fi

(( $#rep )) && 
  _wanted manuals expl 'manual page' compadd -M "$_matcher" -a rep

--PART-BOUNDARY=.11010531172048.ZM18548.brasslantern.com--

