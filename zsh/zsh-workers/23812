From zsh-workers-return-23812-mason-zsh=primenet.com.au@sunsite.dk Fri Aug 31 09:03:14 2007
Return-Path: <zsh-workers-return-23812-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 17468 invoked from network); 31 Aug 2007 09:03:12 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.3 (2007-08-08) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.3
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 31 Aug 2007 09:03:12 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 63426 invoked from network); 31 Aug 2007 09:03:06 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 31 Aug 2007 09:03:06 -0000
Received: (qmail 26180 invoked by alias); 31 Aug 2007 09:03:04 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 23812
Received: (qmail 26171 invoked from network); 31 Aug 2007 09:03:03 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 31 Aug 2007 09:03:03 -0000
Received: (qmail 63107 invoked from network); 31 Aug 2007 09:03:03 -0000
Received: from cluster-d.mailcontrol.com (217.69.20.190)
  by a.mx.sunsite.dk with SMTP; 31 Aug 2007 09:03:00 -0000
Received: from cameurexb01.EUROPE.ROOT.PRI ([62.189.241.200])
	by rly51d.srv.mailcontrol.com (MailControl) with ESMTP id l7V92Mx2013584
	for <zsh-workers@sunsite.dk>; Fri, 31 Aug 2007 10:02:59 +0100
Received: from news01.csr.com ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.1830);
	 Fri, 31 Aug 2007 09:59:06 +0100
Date: Fri, 31 Aug 2007 09:59:05 +0100
From: Peter Stephenson <pws@csr.com>
To: zsh-workers@sunsite.dk
Subject: Re: coredump on ( command & )
Message-ID: <20070831095905.14ed2f90@news01.csr.com>
In-Reply-To: <20070831050639.GA1981@primenet.com.au>
References: <20070831050639.GA1981@primenet.com.au>
Organization: CSR
X-Mailer: Claws Mail 2.9.1 (GTK+ 2.10.13; i386-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
X-OriginalArrivalTime: 31 Aug 2007 08:59:06.0008 (UTC) FILETIME=[2F60A180:01C7EBAD]
X-Scanned-By: MailControl A-07-08-00 (www.mailcontrol.com) on 10.68.0.161

On Fri, 31 Aug 2007 15:06:39 +1000
Geoff Wing <gcw@zsh.org> wrote:
> Heyla,
> the following command is checking something invalid:
> 
> % ( echo & )
>  jobs.c:1254: No valid job in waitjobs.
> 
> [1]    4693 segmentation fault (core dumped)  (; echo &; )

I'm glad someone noticed... this is the new code to fix up multios that
exist in a subshell.  When we put a command into the background inside the
subshell there's no job control.  Or something like that.  So we just need
an extra test round the special case, leaving the standard code untouched.

Index: Src/exec.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/exec.c,v
retrieving revision 1.122
diff -u -r1.122 exec.c
--- Src/exec.c	31 Jul 2007 14:24:26 -0000	1.122
+++ Src/exec.c	31 Aug 2007 08:56:42 -0000
@@ -2910,7 +2910,8 @@
 	    if (fdtable[i] != FDT_UNUSED)
 		close(i);
 	closem(FDT_UNUSED);
-	waitjobs();
+	if (thisjob != -1)
+	    waitjobs();
 	_exit(lastval);
     }
     fixfds(save);



.

