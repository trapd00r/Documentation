From zsh-workers-return-20173-mason-zsh=primenet.com.au@sunsite.dk Sat Jul 17 19:21:33 2004
Return-Path: <zsh-workers-return-20173-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 22189 invoked from network); 17 Jul 2004 19:21:32 -0000
Received: from unknown (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 17 Jul 2004 19:21:32 -0000
Received: (qmail 91937 invoked from network); 17 Jul 2004 19:21:26 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 17 Jul 2004 19:21:26 -0000
Received: (qmail 26481 invoked by alias); 17 Jul 2004 19:21:14 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 20173
Received: (qmail 26471 invoked from network); 17 Jul 2004 19:21:14 -0000
Received: from unknown (HELO a.mx.sunsite.dk) (130.225.247.88)
  by 130.225.247.90 with SMTP; 17 Jul 2004 19:21:14 -0000
Received: (qmail 91309 invoked from network); 17 Jul 2004 19:19:52 -0000
Received: from cmailm1.svr.pol.co.uk (195.92.193.18)
  by a.mx.sunsite.dk with SMTP; 17 Jul 2004 19:19:49 -0000
Received: from modem-173.high-hat.dialup.pol.co.uk ([62.137.27.173] helo=pwstephenson.fsnet.co.uk)
	by cmailm1.svr.pol.co.uk with esmtp (Exim 4.14)
	id 1Bluip-0001At-IL; Sat, 17 Jul 2004 20:19:48 +0100
Received: by pwstephenson.fsnet.co.uk (Postfix, from userid 501)
	id B7643865D; Sat, 17 Jul 2004 15:20:21 -0400 (EDT)
Received: from pwstephenson.fsnet.co.uk (localhost [127.0.0.1])
	by pwstephenson.fsnet.co.uk (Postfix) with ESMTP
	id A4A7B8654; Sat, 17 Jul 2004 20:20:21 +0100 (BST)
To: zsh-workers@sunsite.dk
Cc: 251378@bugs.debian.org, 259768-forwarded@bugs.debian.org,
	259768-submitter@bugs.debian.org, mdz@debian.org
Subject: PATCH: Re: Bug#251378: zsh: segfaults when globing includes too many files 
In-reply-to: "Clint Adams"'s message of "Fri, 16 Jul 2004 13:56:20 EDT."
             <20040716175620.GA22143@scowler.net> 
Date: Sat, 17 Jul 2004 20:20:20 +0100
From: Peter Stephenson <pws@pwstephenson.fsnet.co.uk>
Message-Id: <20040717192021.B7643865D@pwstephenson.fsnet.co.uk>
X-Spam-Checker-Version: SpamAssassin 2.63 on a.mx.sunsite.dk
X-Spam-Level: *
X-Spam-Status: No, hits=1.5 required=6.0 tests=RCVD_IN_SORBS autolearn=no 
	version=2.63
X-Spam-Hits: 1.5

This seems to fix it.  It was actually fairly obvious, since there was
only one case of reallocationg a heap where fheap wasn't set to NULL.
However, the script focussed my mind wonderfully.

Index: Src/mem.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/mem.c,v
retrieving revision 1.11
diff -u -r1.11 mem.c
--- Src/mem.c	2 Jun 2004 22:14:26 -0000	1.11
+++ Src/mem.c	17 Jul 2004 19:18:10 -0000
@@ -491,6 +491,7 @@
 	     */
 	    size_t n = (new + sizeof(*h) + HEAPSIZE);
 	    n -= n % HEAPSIZE;
+	    fheap = NULL;
 
 #ifdef USE_MMAP
 	    {

-- 
Peter Stephenson <pws@pwstephenson.fsnet.co.uk>
Work: pws@csr.com
Web: http://www.pwstephenson.fsnet.co.uk

