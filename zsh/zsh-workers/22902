From zsh-workers-return-22902-mason-zsh=primenet.com.au@sunsite.dk Tue Oct 24 16:01:03 2006
Return-Path: <zsh-workers-return-22902-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 11574 invoked from network); 24 Oct 2006 16:00:59 -0000
X-Spam-Checker-Version: SpamAssassin 3.1.7 (2006-10-05) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.4 required=5.0 tests=AWL,BAYES_00,
	FORGED_RCVD_HELO autolearn=ham version=3.1.7
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 24 Oct 2006 16:00:59 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 82301 invoked from network); 24 Oct 2006 16:00:53 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 24 Oct 2006 16:00:53 -0000
Received: (qmail 10811 invoked by alias); 24 Oct 2006 16:00:46 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 22902
Received: (qmail 10795 invoked from network); 24 Oct 2006 16:00:45 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 24 Oct 2006 16:00:45 -0000
Received: (qmail 81482 invoked from network); 24 Oct 2006 16:00:45 -0000
Received: from cluster-c.mailcontrol.com (168.143.177.190)
  by a.mx.sunsite.dk with SMTP; 24 Oct 2006 16:00:40 -0000
Received: from exchange03.csr.com (uuk202166.uk.customer.alter.net [62.189.241.194] (may be forged))
	by rly04c.srv.mailcontrol.com (MailControl) with ESMTP id k9OFvg1s027415
	for <zsh-workers@sunsite.dk>; Tue, 24 Oct 2006 17:00:08 +0100
Received: from cameurexb01.EUROPE.ROOT.PRI ([10.100.137.61]) by exchange03.csr.com with Microsoft SMTPSVC(5.0.2195.6713);
	 Tue, 24 Oct 2006 16:47:44 +0100
Received: from news01.csr.com ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.1830);
	 Tue, 24 Oct 2006 16:38:03 +0100
Received: from news01.csr.com (localhost.localdomain [127.0.0.1])
	by news01.csr.com (8.13.7/8.13.4) with ESMTP id k9OFc0PI005986
	for <zsh-workers@sunsite.dk>; Tue, 24 Oct 2006 16:38:01 +0100
Received: from csr.com (pws@localhost)
	by news01.csr.com (8.13.7/8.13.7/Submit) with ESMTP id k9OFbg5Z005976
	for <zsh-workers@sunsite.dk>; Tue, 24 Oct 2006 16:38:00 +0100
Message-Id: <200610241538.k9OFbg5Z005976@news01.csr.com>
X-Authentication-Warning: news01.csr.com: pws owned process doing -bs
To: zsh-workers@sunsite.dk
Subject: Re: bug: can't write history file 
In-reply-to: <20061024141740.GA18951@tetsuo.karasik.eu.org> 
References: <20061024141740.GA18951@tetsuo.karasik.eu.org>
Comments: In-reply-to Dmitry Karasik <dmitry@karasik.eu.org>
   message dated "Tue, 24 Oct 2006 16:17:40 +0200."
Date: Tue, 24 Oct 2006 16:37:42 +0100
From: Peter Stephenson <pws@csr.com>
X-OriginalArrivalTime: 24 Oct 2006 15:38:03.0102 (UTC) FILETIME=[64870FE0:01C6F782]
Content-Type: text/plain
MIME-Version: 1.0
X-Scanned-By: MailControl A-07-06-60 (www.mailcontrol.com) on 10.67.0.114

Dmitry Karasik wrote:
> Hello,
> 
> After upgrading to 4.3.2, I've found that one of the features I love in zsh i
> s
> broken, namely the possibility to use the history file for both root and
> non-root sessions.  Now, after I logout from "sudo zsh", I get this:
> 
>    zsh: can't write history file /home/dk/.zsh-history
> 
> I found that it is savehistfile() to blame, because it apparently is called
> with writeflags=0, which bypasses all append/rewrite logic, falling back to
> saving the file by renaming it to .zsh-history.new, and (correctly) refusing 
> to
> overwrite .zsh-history because the euid is different. If I'm correct in
> this, the patch below fixes the problem:
> 
>...
> -               savehistfile(fn, err, 0);
> +               savehistfile(fn, err, writeflags & HFILE_APPEND);
>...

That line is the same in 4.2, so I presume what has changed is the
default options (how it reaches this code).  In that case it's
plausible that this should always have had that flag.  It would
be best if Wayne could comment about what he thinks did change,
but I'm not sure if he's around at the moment.

-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070


To access the latest news from CSR copy this link into a web browser:  http://www.csr.com/email_sig.php

