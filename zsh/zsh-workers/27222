From zsh-workers-return-27222-mason-zsh=primenet.com.au@sunsite.dk Tue Aug 18 10:34:04 2009
Return-Path: <zsh-workers-return-27222-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 13144 invoked from network); 18 Aug 2009 10:34:01 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.4 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received: from new-brage.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.254.104)
  by ns1.primenet.com.au with SMTP; 18 Aug 2009 10:34:01 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 92479 invoked from network); 18 Aug 2009 10:33:53 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 18 Aug 2009 10:33:53 -0000
Received: (qmail 23570 invoked by alias); 18 Aug 2009 10:33:46 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 27222
Received: (qmail 23553 invoked from network); 18 Aug 2009 10:33:45 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 18 Aug 2009 10:33:45 -0000
Received: from cluster-d.mailcontrol.com (cluster-d.mailcontrol.com [85.115.60.190])
	by bifrost.dotsrc.org (Postfix) with ESMTPS id 1A0EE8116309
	for <zsh-workers@sunsite.dk>; Tue, 18 Aug 2009 12:33:41 +0200 (CEST)
Received: from cameurexb01.EUROPE.ROOT.PRI ([193.128.72.68])
	by rly25d.srv.mailcontrol.com (MailControl) with ESMTP id n7IAXPve030404
	for <zsh-workers@sunsite.dk>; Tue, 18 Aug 2009 11:33:38 +0100
Received: from news01.csr.com ([10.99.50.25]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.3959);
	 Tue, 18 Aug 2009 11:33:31 +0100
Received: from news01.csr.com (localhost.localdomain [127.0.0.1])
	by news01.csr.com (8.14.2/8.13.4) with ESMTP id n7IAXPns019353
	for <zsh-workers@sunsite.dk>; Tue, 18 Aug 2009 11:33:26 +0100
Received: from csr.com (pws@localhost)
	by news01.csr.com (8.14.2/8.14.2/Submit) with ESMTP id n7IAXPt9019349
	for <zsh-workers@sunsite.dk>; Tue, 18 Aug 2009 11:33:25 +0100
X-Authentication-Warning: news01.csr.com: pws owned process doing -bs
To: zsh-workers@sunsite.dk (Zsh hackers list)
Subject: PATCH: first go at directory info in completion.
X-Mailer: MH-E 8.0.3; nmh 1.3; GNU Emacs 22.1.1
Date: Tue, 18 Aug 2009 11:33:25 +0100
Message-ID: <19348.1250591605@csr.com>
From: Peter Stephenson <pws@csr.com>
X-OriginalArrivalTime: 18 Aug 2009 10:33:31.0114 (UTC) FILETIME=[54A3B4A0:01CA1FEF]
Content-Type: text/plain
MIME-Version: 1.0
X-Scanned-By: MailControl A-06-00-00 (www.mailcontrol.com) on 10.68.0.135
X-Virus-Scanned: ClamAV 0.94.2/9707/Tue Aug 18 02:15:41 2009 on bifrost
X-Virus-Status: Clean

This is work in progress, which won't be committed, so I'm interested in
comments about tweaks (I am not interested in comments about wholesale
rewrites and upgrades of the
wouldn't-it-be-great-if-everything-were-much-much-better variety in this
thread; that's not going to happen).

The file-list style can now take a value dirinfo=<filename>.  If
<filename> exists in a directory, then completion lists show the
contents of <filename> together with the directory.  The style
dirinfo-format can be used to change the display:  %f is the base
filename of the directory, %d is the path to the directory (the bit
usually stripped in completion lists), %i is the contents of
<filename>.

The main problem at the moment seems to be that whenever you have a
directory with information the formatting of the entire completion list
becomes one-per-line.  Grouping would improve this.  However, I'm a bit
worried that this happens at too low a level to add a completion group
(i.e. a different compadd with a different -J or -V option) at this
point consistent with existing tags and labels, which is why I've
stopped at this point for now.

Index: Completion/Unix/Type/_list_files
===================================================================
RCS file: /cvsroot/zsh/zsh/Completion/Unix/Type/_list_files,v
retrieving revision 1.7
diff -u -r1.7 _list_files
--- Completion/Unix/Type/_list_files	3 Jun 2008 09:30:58 -0000	1.7
+++ Completion/Unix/Type/_list_files	18 Aug 2009 10:18:27 -0000
@@ -8,9 +8,9 @@
 # Sets array listfiles to the display strings and the array
 # listopts appropriately to be added to the compadd command line.
 
-local stat f elt what dir
+local stat f elt what dir dirfile dirformat
 local -a stylevals
-integer ok
+integer ok active
 
 listfiles=()
 listopts=()
@@ -33,19 +33,27 @@
     (*($what|all|true|1|yes)*=<->)
     # use long format if no more than the given number of matches
     (( ${(P)#1} <= ${elt##*=} )) && (( ok = 1 ))
-    break
     ;;
 
     (*($what|all|true|1|yes)[^=]#)
     # always use long format
     (( ok = 1 ))
-    break
+    ;;
+
+    (dirinfo=*)
+    dirfile=${~elt##dirinfo=}
+    (( ok )) || (( ok = 2 ))
     ;;
   esac
 done
 
 (( ok )) || return 1
 
+if [[ -n $dirfile ]]; then
+  zstyle -s ":completion:${curcontext}:" dirinfo-format dirformat ||
+  dirformat="%f [%i]"
+fi
+
 zmodload -F zsh/stat b:zstat 2>/dev/null || return 1
 
 dir=${2:+$2/}
@@ -56,14 +64,26 @@
     listfiles+=("$dir$f")
     continue
   fi
+  if [[ -n $dirfile && -f "$dir$f/$dirfile" ]]; then
+    zformat -f what "$dirformat" d:$dir f:$f i:"$(<$dir$f/$dirfile)"
+    listfiles+=("$what")
+    (( active++ ))
+  elif (( ok != 1 )); then
+    listfiles+=("$f")
+  else
+    # Borrowed from Functions/Example/zls
+    zstat -s -H stat -F "%b %e %H:%M" - "$dir$f" >/dev/null 2>&1
 
-  # Borrowed from Functions/Example/zls
-  zstat -s -H stat -F "%b %e %H:%M" - "$dir$f" >/dev/null 2>&1
-
-  listfiles+=("$stat[mode] ${(l:3:)stat[nlink]} ${(r:8:)stat[uid]} \
+    listfiles+=("$stat[mode] ${(l:3:)stat[nlink]} ${(r:8:)stat[uid]} \
  ${(r:8:)stat[gid]} ${(l:8:)stat[size]} $stat[mtime] $f")
+    (( active++ ))
+  fi
 done
 
+# Something to display either if we're using long format
+# or we're displaying directory information.
+(( active )) || return 1
+
 (( ${#listfiles} )) && listopts=(-d listfiles -l -o)
 
 return 0


'member of the CSR plc group of companies. CSR plc registered in England and Wales, registered number 4187346, registered office Churchill House, Cambridge Business Park, Cowley Road, Cambridge, CB4 0WZ, United Kingdom'

