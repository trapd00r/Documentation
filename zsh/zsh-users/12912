From zsh-users-return-12912-mason-zsh=primenet.com.au@sunsite.dk Fri Jun 13 11:33:38 2008
Return-Path: <zsh-users-return-12912-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 26109 invoked from network); 13 Jun 2008 11:33:34 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.4 (2008-01-01) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.4
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 13 Jun 2008 11:33:34 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 77799 invoked from network); 13 Jun 2008 11:33:24 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 13 Jun 2008 11:33:24 -0000
Received: (qmail 19260 invoked by alias); 13 Jun 2008 11:33:15 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 12912
Received: (qmail 19244 invoked from network); 13 Jun 2008 11:33:14 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 13 Jun 2008 11:33:14 -0000
Received: from mx.spodhuis.org (redoubt.spodhuis.org [193.202.115.177])
	by bifrost.dotsrc.org (Postfix) with ESMTPS id 4BB0680525B2
	for <zsh-users@sunsite.dk>; Fri, 13 Jun 2008 13:33:08 +0200 (CEST)
DomainKey-Signature: a=rsa-sha1; q=dns; c=nofws; s=d200803; d=spodhuis.org;
	h=Received:Date:From:To:Cc:Subject:Message-ID:Mail-Followup-To:References:MIME-Version:Content-Type:Content-Disposition:In-Reply-To;
	b=raDSyJdoP3CSPk5n0d1U+ewhKl2RVHv+pL53UuXk64AIeeXJAtnbB23o1sEGO2LPYiT7NPJTst5IObnAEHbxb+dWMV2vFiEH4YUXz4QhL/KFVgtCzAeaSuiKrLzeH7nwUK505XKwjxCx7v4hQN+k/X2H0M2mR7GfYY2TZLOVFsQ=;
Received: by smtp.spodhuis.org with local 
	id 1K77Wg-000AXu-EE; Fri, 13 Jun 2008 11:33:02 +0000
Date: Fri, 13 Jun 2008 04:33:02 -0700
From: Phil Pennock <zsh-workers+phil.pennock@spodhuis.org>
To: Tomasz Pala <gotar@polanet.pl>
Cc: zsh-users@sunsite.dk
Subject: Re: strace completion (Re: grouping/joining _values)
Message-ID: <20080613113302.GA40053@redoubt.spodhuis.org>
Mail-Followup-To: Tomasz Pala <gotar@polanet.pl>, zsh-users@sunsite.dk
References: <20080607193937.GA14443@pepin.polanet.pl> <20080613002731.GA11526@pepin.polanet.pl>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20080613002731.GA11526@pepin.polanet.pl>
X-Virus-Scanned: ClamAV 0.92.1/7462/Fri Jun 13 10:55:12 2008 on bifrost
X-Virus-Status: Clean

On 2008-06-13 at 02:27 +0200, Tomasz Pala wrote:
> I've found solution myself using _wanted and _describe. See attached
> file - it's almost complete strace completion. I think it's ready for
> inclusion into zsh repo.

System calls are OS-specific, as you noted in the TODO; getting the list
involves looking at /usr/include/sys/syscalls but I note that on Linux
that involves having to pull in #include's within that file.  I suspect
that of the Unices today, those which don't include a compiler are
likely to be some Linux variants, default MacOS installs (? not sure,
this one has it but I don't recall if that's because of post-install
work) and ... who knows what else?

Perhaps move the array to a default list, capture a specific set of
defaults in an OS-specific array which can be grabbed with an autoloaded
function if needed, then try to get the real list, the first time, with
cpp?  Unfortunately, SUSv3 only seems to specify that c99(1) exist, not
cpp(1) and I believe that "cpp -dN" is a GCC feature anyway.

Someone with more experience in providing completions may have better
advice, but perhaps:

if [[ -x =gcc ]]; then
  [[ ${#_sys_calls_generated} -eq 0 ]] && _sys_calls_generated=(
    ${${(M)${(@f)"$(gcc -E -dN /usr/include/sys/syscall.h)"}%SYS_*}#SYS_}
    )
  sys_calls=($_sys_calls_generated)
elif [[ $OSTYPE == linux-gnu ]]; then
  # ...
else
  sys_calls=()
fi

Are there any other useful strategies for extracting the real list of
syscalls at runtime, so that on systems which package up the same
version of zsh for N years the list doesn't grow stale?

-Phil

