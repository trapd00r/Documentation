From zsh-workers-return-20844-mason-zsh=primenet.com.au@sunsite.dk Tue Feb 22 18:18:33 2005
Return-Path: <zsh-workers-return-20844-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 12070 invoked from network); 22 Feb 2005 18:18:32 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 22 Feb 2005 18:18:32 -0000
Received: (qmail 15652 invoked from network); 22 Feb 2005 18:18:24 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 22 Feb 2005 18:18:24 -0000
Received: (qmail 16514 invoked by alias); 22 Feb 2005 18:18:19 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 20844
Received: (qmail 16501 invoked from network); 22 Feb 2005 18:18:18 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 22 Feb 2005 18:18:18 -0000
Received: (qmail 15319 invoked from network); 22 Feb 2005 18:18:18 -0000
Received: from mailhost1.csr.com (HELO MAILSWEEPER01.csr.com) (81.105.217.43)
  by a.mx.sunsite.dk with SMTP; 22 Feb 2005 18:18:13 -0000
Received: from exchange03.csr.com (unverified [10.100.137.60]) by MAILSWEEPER01.csr.com
 (Content Technologies SMTPRS 4.3.12) with ESMTP id <T6f47b1cd310a6c8d018f0@MAILSWEEPER01.csr.com> for <zsh-workers@sunsite.dk>;
 Tue, 22 Feb 2005 18:16:44 +0000
Received: from news01.csr.com ([10.103.143.38]) by exchange03.csr.com with Microsoft SMTPSVC(5.0.2195.6713);
	 Tue, 22 Feb 2005 18:19:06 +0000
Received: from news01.csr.com (localhost.localdomain [127.0.0.1])
	by news01.csr.com (8.13.1/8.12.11) with ESMTP id j1MIICv4015805
	for <zsh-workers@sunsite.dk>; Tue, 22 Feb 2005 18:18:12 GMT
Received: from csr.com (pws@localhost)
	by news01.csr.com (8.13.1/8.13.1/Submit) with ESMTP id j1MIICpk015801
	for <zsh-workers@sunsite.dk>; Tue, 22 Feb 2005 18:18:12 GMT
Message-Id: <200502221818.j1MIICpk015801@news01.csr.com>
X-Authentication-Warning: news01.csr.com: pws owned process doing -bs
To: zsh-workers@sunsite.dk
Subject: Re: Problem with named directories 
In-reply-to: <200502221803.j1MI3J3p015413@news01.csr.com> 
References: <7e0054ed1841058b16ca27361b02fe7c@ee.oulu.fi> <200502221803.j1MI3J3p015413@news01.csr.com>
Date: Tue, 22 Feb 2005 18:18:11 +0000
From: Peter Stephenson <pws@csr.com>
X-OriginalArrivalTime: 22 Feb 2005 18:19:06.0830 (UTC) FILETIME=[FEFD2EE0:01C5190A]
X-Spam-Checker-Version: SpamAssassin 3.0.2 on a.mx.sunsite.dk
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=6.0 tests=AWL,BAYES_00 autolearn=ham 
	version=3.0.2
X-Spam-Hits: -2.5

Peter Stephenson wrote:
> I think it might be better to prune the name of the directory when it is
> assigned.

On second thoughts, probably safer not to prune initial slashes, in case
// is special.

Index: ChangeLog
===================================================================
RCS file: /cvsroot/zsh/zsh/ChangeLog,v
retrieving revision 1.2528
diff -u -r1.2528 ChangeLog
--- ChangeLog	22 Feb 2005 13:12:35 -0000	1.2528
+++ ChangeLog	22 Feb 2005 18:13:31 -0000
@@ -1,5 +1,9 @@
 2005-02-22  Peter Stephenson  <pws@csr.com>
 
+	* 20843: Doc/Zsh/expn.yo, Src/utils.c: named directories always
+	have trailing slashes pruned.  Any related parameter remains
+	unmodified.
+
 	* Andrey Borzenkov: 20838 with minor tweaks: Src/system.h,
 	Src/Zle/zle.h, Src/Zle/zle_main.c, Src/Zle/zle_misc.c,
 	Src/Zle/zle_tricky.c, Src/Zle/zle_utils.c: fixes to
Index: Doc/Zsh/expn.yo
===================================================================
RCS file: /cvsroot/zsh/zsh/Doc/Zsh/expn.yo,v
retrieving revision 1.50
diff -u -r1.50 expn.yo
--- Doc/Zsh/expn.yo	10 Jan 2005 17:31:25 -0000	1.50
+++ Doc/Zsh/expn.yo	22 Feb 2005 18:13:31 -0000
@@ -1138,6 +1138,8 @@
 Named directories are typically home directories for users on the system.
 They may also be defined if the text after the `tt(~)' is the name
 of a string shell parameter whose value begins with a `tt(/)'.
+Note that trailing slashes will be removed from the path to the directory
+(though the original parameter is not modified).
 It is also possible to define directory names using the tt(-d) option to the
 tt(hash) builtin.
 
Index: Src/utils.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/utils.c,v
retrieving revision 1.72
diff -u -r1.72 utils.c
--- Src/utils.c	1 Feb 2005 10:53:18 -0000	1.72
+++ Src/utils.c	22 Feb 2005 18:13:32 -0000
@@ -525,6 +525,7 @@
 adduserdir(char *s, char *t, int flags, int always)
 {
     Nameddir nd;
+    char *eptr;
 
     /* We don't maintain a hash table in non-interactive shells. */
     if (!interact)
@@ -558,7 +559,18 @@
     /* add the name */
     nd = (Nameddir) zshcalloc(sizeof *nd);
     nd->flags = flags;
-    nd->dir = ztrdup(t);
+    eptr = t + strlen(t);
+    while (eptr > t && eptr[-1] == '/')
+	eptr--;
+    if (eptr == t) {
+	/*
+	 * Don't abbreviate multiple slashes at the start of a
+	 * named directory, since these are sometimes used for
+	 * special purposes.
+	 */
+	nd->dir = ztrdup(t);
+    } else
+	nd->dir = ztrduppfx(t, eptr - t);
     /* The variables PWD and OLDPWD are not to be displayed as ~PWD etc. */
     if (!strcmp(s, "PWD") || !strcmp(s, "OLDPWD"))
 	nd->flags |= ND_NOABBREV;

-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070


**********************************************************************
This email and any files transmitted with it are confidential and
intended solely for the use of the individual or entity to whom they
are addressed. If you have received this email in error please notify
the system manager.

**********************************************************************

