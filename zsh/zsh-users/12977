From zsh-users-return-12977-mason-zsh=primenet.com.au@sunsite.dk Wed Jun 18 11:30:01 2008
Return-Path: <zsh-users-return-12977-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 24171 invoked from network); 18 Jun 2008 11:29:59 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.4 (2008-01-01) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.4
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 18 Jun 2008 11:29:59 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 18928 invoked from network); 18 Jun 2008 11:29:43 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 18 Jun 2008 11:29:43 -0000
Received: (qmail 8303 invoked by alias); 18 Jun 2008 11:29:32 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 12977
Received: (qmail 8289 invoked from network); 18 Jun 2008 11:29:32 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 18 Jun 2008 11:29:32 -0000
Received: from mail.o2.co.uk (jabba.london.02.net [82.132.130.169])
	by bifrost.dotsrc.org (Postfix) with ESMTP id 5DD4E8084FA2
	for <zsh-users@sunsite.dk>; Wed, 18 Jun 2008 13:29:25 +0200 (CEST)
Received: from sc.homeunix.net (78.105.216.138) by mail.o2.co.uk (8.0.013.3) (authenticated as stephane.chazelas)
        id 4851DD9500F53A70; Wed, 18 Jun 2008 12:29:23 +0100
Received: from chazelas by sc.homeunix.net with local (Exim 4.69)
	(envelope-from <stephane_chazelas@yahoo.fr>)
	id 1K8vqs-00062Z-Qq; Wed, 18 Jun 2008 12:29:22 +0100
Date: Wed, 18 Jun 2008 12:29:22 +0100
From: Stephane Chazelas <Stephane_Chazelas@yahoo.fr>
To: Bart Schaefer <schaefer@brasslantern.com>, zsh-users@sunsite.dk
Subject: Re: strace completion (Re: grouping/joining _values)
Message-ID: <20080618112922.GY5016@sc.homeunix.net>
Mail-Followup-To: Bart Schaefer <schaefer@brasslantern.com>,
	zsh-users@sunsite.dk
References: <20080613113302.GA40053@redoubt.spodhuis.org> <20080613121226.GA18890@scru.org> <20080613131851.GA12764@redoubt.spodhuis.org> <20080613160458.GM5113@sc.homeunix.net> <20080613191905.GN5113@sc.homeunix.net> <20080613235914.GP5113@sc.homeunix.net> <20080614084949.GQ5113@sc.homeunix.net> <080614084154.ZM11958@torch.brasslantern.com> <20080615083712.GR5113@sc.homeunix.net> <20080615124959.GT5113@sc.homeunix.net>
MIME-Version: 1.0
Content-Type: text/plain; charset=iso-8859-15
Content-Disposition: inline
Content-Transfer-Encoding: 8bit
In-Reply-To: <20080615124959.GT5113@sc.homeunix.net>
User-Agent: Mutt/1.5.16 (2007-09-19)
X-Virus-Scanned: ClamAV 0.92.1/7498/Wed Jun 18 04:08:00 2008 on bifrost
X-Virus-Status: Clean

On Sun, Jun 15, 2008 at 01:49:59PM +0100, Stephane Chazelas wrote:
> On Sun, Jun 15, 2008 at 09:37:12AM +0100, Stephane Chazelas wrote:
> [...]
> > how disapointing. Could you please send me your binary of strace
> > so that I can try and understand how this can happen?
> > 
> > I was quite confident it would work as it worked on old RHEL
> > x86, new debian x86 and old Solaris sparc (with truss).
> [...]
> 
> You must be on x86_64? I observe the same on
> td152.testdrive.hp.com (debian)
> 
> Anyway, I also found that if it's built without optimisation or
> older gccs, it fails early because strcmp is then called and
> strace fails before it have a chance to compare the system
> call names.
[...]

I found a way to work around those problems.

Bart's problem was due (I think) to "prelink" (which
short-circuits dynamic name resolution) and can be worked around
by undoing the prelink with prelink -u. The second can be worked
around by replacing strcmp with rename (a syscall so something
that strace can trace), make sure the first renames don't fail
by touching the relevant files and then use strace to trace the
other renames and get the syscall from there.

Of course, it's probably still precarious. I've tested it on
Linux on i386, x86_64 and ia64, redhat and debian.

list_strace_syscalls() {
 tmp==(:)
 rm -f -- "$tmp"
 (umask 077 && exec mkdir -- "$tmp") || return
 (
   cd -P -- "$tmp" || return
   zmodload -i zsh/mapfile || return
   print -rn -- "${mapfile[/usr/bin/strace]//strcmp/rename}" > strace || return
   chmod +x strace
   PATH=$PATH:/usr/sbin:/sbin:/usr/local/sbin prelink -u strace 2> /dev/null
   touch time all none
   /usr/bin/strace -e rename ./strace -e xxx |&
   awk -F\" '/xxx/{print $4}' | sort -u
 )
 local ret="$?"
 rm -rf "$tmp"
 return "$ret"
}


-- 
Stéphane

