From zsh-workers-return-5999-mason-zsh=primenet.com.au@sunsite.auc.dk Thu Apr 01 19:11:04 1999
Return-Path: <zsh-workers-return-5999-mason-zsh=primenet.com.au@sunsite.auc.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 16794 invoked from network); 1 Apr 1999 19:11:03 -0000
Received: from sunsite.auc.dk (130.225.51.30)
  by ns1.primenet.com.au with SMTP; 1 Apr 1999 19:11:03 -0000
Received: (qmail 24925 invoked by alias); 1 Apr 1999 19:10:53 -0000
Mailing-List: contact zsh-workers-help@sunsite.auc.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.auc.dk
X-Seq: 5999
Received: (qmail 24916 invoked from network); 1 Apr 1999 19:10:52 -0000
Date: Thu, 1 Apr 1999 11:49:49 +0200 (MET DST)
Message-Id: <199904010949.LAA21969@beta.informatik.hu-berlin.de>
From: Sven Wischnowsky <wischnow@informatik.hu-berlin.de>
To: zsh-workers@sunsite.auc.dk
In-reply-to: Jim Graham's message of Wed, 31 Mar 1999 15:50:23 -0600
Subject: Re: no '/' after ~username in zsh-3.1.5-pws-14


Jim Graham wrote:

> Ok, I've upgraded to zsh-3.1.5-pws.14, and have noticed one problem
> that I can't seem to find anything in the man pages about...the
> examples there all say I should be seeing what I'm used to.  Based
> on that, I'm guessing that this might be a bug.  Then again, I've
> been wrong on such guesses before.  :-)
> 
> ...
> 
> Unfortunately, right now the '/' is missing after ~username, and I
> end up with
> 
> ...

It was a bug (and my fault, of course). Since, as far as I can see,
this will only happen with completion after `~' (and only when not
using the new completion system), the patch below implements the easy
solution for this.

Sorry!

Bye
 Sven

--- os/Zle/zle_tricky.c	Tue Mar 30 16:00:52 1999
+++ Src/Zle/zle_tricky.c	Thu Apr  1 10:02:44 1999
@@ -6926,14 +6926,20 @@
 	     * If it is, we append a slash.                                */
 	    struct stat buf;
 	    char *p;
+	    int t = 0;
 
-	    /* Build the path name. */
-	    p = (char *) zhalloc(strlen(prpre) + strlen(str) +
+	    if (m->ipre && m->ipre[0] == '~' && !m->ipre[1])
+		t = 1;
+	    else {
+		/* Build the path name. */
+		p = (char *) zhalloc(strlen(prpre) + strlen(str) +
 				 strlen(psuf) + 3);
-	    sprintf(p, "%s%s%s", (prpre && *prpre) ? prpre : "./", str, psuf);
+		sprintf(p, "%s%s%s", (prpre && *prpre) ? prpre : "./", str, psuf);
 
-	    /* And do the stat. */
-	    if (!(sr = ztat(p, &buf, 0)) && S_ISDIR(buf.st_mode)) {
+		/* And do the stat. */
+		t = (!(sr = ztat(p, &buf, 0)) && S_ISDIR(buf.st_mode));
+	    }
+	    if (t) {
 		/* It is a directory, so add the slash. */
 		havesuff = 1;
 		inststrlen("/", 1, 1);

--
Sven Wischnowsky                         wischnow@informatik.hu-berlin.de

