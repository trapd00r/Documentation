diff -x ltmain.sh -x 'Makefile*' -x 'configure*' -x 'aclocal*' -x 'config.*' -ru irssi-0.8.12/docs/signals.txt irssi-0.8.12-hax/docs/signals.txt
--- irssi-0.8.12/docs/signals.txt	2007-10-06 11:40:39.000000000 +0200
+++ irssi-0.8.12-hax/docs/signals.txt	2008-03-19 10:18:37.000000000 +0100
@@ -319,6 +319,7 @@
 
 gui-readline.c:
  "gui key pressed", int key
+ "gui line entered", char *command, SERVER_REC, WI_ITEM_REC
 
 gui-printtext.c:
  "beep"
diff -x ltmain.sh -x 'Makefile*' -x 'configure*' -x 'aclocal*' -x 'config.*' -ru irssi-0.8.12/src/fe-common/core/fe-help.c irssi-0.8.12-hax/src/fe-common/core/fe-help.c
--- irssi-0.8.12/src/fe-common/core/fe-help.c	2007-10-06 11:40:39.000000000 +0200
+++ irssi-0.8.12-hax/src/fe-common/core/fe-help.c	2008-03-19 20:44:57.000000000 +0100
@@ -255,8 +255,12 @@
 	char *cmd, *ptr;
 
 	cmd = g_strdup(data);
-	ptr = cmd+strlen(cmd);
-	while (ptr[-1] == ' ') ptr--; *ptr = '\0';
+	ptr = cmd + strlen(cmd);
+
+	while (ptr>cmd && ptr[-1] == ' ')
+		--ptr;
+
+	*ptr = '\0';
 
 	g_strdown(cmd);
 	show_help(cmd);
diff -x ltmain.sh -x 'Makefile*' -x 'configure*' -x 'aclocal*' -x 'config.*' -ru irssi-0.8.12/src/fe-text/gui-readline.c irssi-0.8.12-hax/src/fe-text/gui-readline.c
--- irssi-0.8.12/src/fe-text/gui-readline.c	2007-10-06 11:40:39.000000000 +0200
+++ irssi-0.8.12-hax/src/fe-text/gui-readline.c	2008-03-17 11:42:54.000000000 +0100
@@ -547,7 +547,7 @@
 	translate_output(str);
 
 	if (redir == NULL) {
-		signal_emit("send command", 3, str,
+		signal_emit("gui line entered", 3, str,
 			    active_win->active_server,
 			    active_win->active);
 	} else {
@@ -999,6 +999,11 @@
 	gui_entry_set_prompt(active_entry, entry);
 }
 
+static void sig_gui_line_entered(const char *line, SERVER_REC *server, void *item)
+{
+    signal_emit("send command", 3, line, server, item);
+}
+
 static void setup_changed(void)
 {
 	paste_detect_time = settings_get_time("paste_detect_time");
@@ -1181,6 +1186,7 @@
 	signal_add("window changed automatic", (SIGNAL_FUNC) sig_window_auto_changed);
 	signal_add("gui entry redirect", (SIGNAL_FUNC) sig_gui_entry_redirect);
 	signal_add("gui key pressed", (SIGNAL_FUNC) sig_gui_key_pressed);
+	signal_add("gui line entered", (SIGNAL_FUNC) sig_gui_line_entered);
 	signal_add("setup changed", (SIGNAL_FUNC) setup_changed);
 }
 
@@ -1252,5 +1258,6 @@
 	signal_remove("window changed automatic", (SIGNAL_FUNC) sig_window_auto_changed);
 	signal_remove("gui entry redirect", (SIGNAL_FUNC) sig_gui_entry_redirect);
 	signal_remove("gui key pressed", (SIGNAL_FUNC) sig_gui_key_pressed);
+	signal_remove("gui line entered", (SIGNAL_FUNC) sig_gui_line_entered);
 	signal_remove("setup changed", (SIGNAL_FUNC) setup_changed);
 }
diff -x ltmain.sh -x 'Makefile*' -x 'configure*' -x 'aclocal*' -x 'config.*' -ru irssi-0.8.12/src/perl/irssi-core.pl irssi-0.8.12-hax/src/perl/irssi-core.pl
--- irssi-0.8.12/src/perl/irssi-core.pl	2007-10-06 11:40:39.000000000 +0200
+++ irssi-0.8.12-hax/src/perl/irssi-core.pl	2008-03-19 12:22:43.000000000 +0100
@@ -18,33 +18,31 @@
 }
 
 sub eval_data {
-  my ($data, $id) = @_;
-  destroy("Irssi::Script::$id");
-
-  my $package = "Irssi::Script::$id";
-  my $eval = qq{package $package; %s sub handler { $data; }};
-  {
-      # hide our variables within this block
-      my ($filename, $package, $data);
-      eval $eval;
-  }
-  die $@ if $@;
-
-  my $ret;
-  eval { $ret = $package->handler; };
-  die $@ if $@;
-  return $ret;
+  my $ret = eval do {
+  	  my ($data, $id) = @_;
+  	  destroy("Irssi::Script::$id");
+  	  my $code = qq{package Irssi::Script::$id; %s $data};
+  	  #if (open my $fh, '>', "irssi-tmp-script-loaded") {
+  	  #	  print $fh $code;
+  	  #	  close $fh;
+  	  #}
+  	  $code
+  };
+  $@ and die $@;
+  $ret
 }
 
 sub eval_file {
   my ($filename, $id) = @_;
 
-  local *FH;
-  open FH, $filename or die "File not found: $filename";
-  local($/) = undef;
-  my $data = <FH>;
-  close FH;
-  local($/) = "\n";
+  open my $fh, '<', $filename or die "Can't open $filename: $!";
+  my $data = do {local $/; <$fh>};
+  close $fh;
+
+  $filename =~ s/(["\\])/\\$1/g;
+  $filename =~ s/\n/\\n/g;
+
+  $data = qq{\n#line 1 "$filename"\n$data};
 
   eval_data($data, $id);
 }
diff -x ltmain.sh -x 'Makefile*' -x 'configure*' -x 'aclocal*' -x 'config.*' -ru irssi-0.8.12/src/perl/perl-core.c irssi-0.8.12-hax/src/perl/perl-core.c
--- irssi-0.8.12/src/perl/perl-core.c	2007-10-06 11:40:39.000000000 +0200
+++ irssi-0.8.12-hax/src/perl/perl-core.c	2008-03-19 21:18:44.000000000 +0100
@@ -267,7 +267,7 @@
 	/* if there's a script with a same name, destroy it */
 	script = perl_script_find(name);
 	if (script != NULL)
-		perl_script_destroy(script);
+		perl_script_unload(script);
 
 	script = g_new0(PERL_SCRIPT_REC, 1);
 	script->name = name;
diff -x ltmain.sh -x 'Makefile*' -x 'configure*' -x 'aclocal*' -x 'config.*' -ru irssi-0.8.12/src/perl/perl-signals.c irssi-0.8.12-hax/src/perl/perl-signals.c
--- irssi-0.8.12/src/perl/perl-signals.c	2007-10-06 11:40:39.000000000 +0200
+++ irssi-0.8.12-hax/src/perl/perl-signals.c	2008-03-19 10:51:36.000000000 +0100
@@ -290,9 +290,9 @@
         perl_signal_destroy(rec);
 }
 
-#define sv_func_cmp(f1, f2, len) \
-	(f1 == f2 || (SvPOK(f1) && SvPOK(f2) && \
-		strcmp((char *) SvPV(f1, len), (char *) SvPV(f2, len)) == 0))
+#define sv_func_cmp(f1, f2) \
+	((f1) == (f2) || (SvPOK(f1) && SvPOK(f2) && \
+		strcmp(SvPV_nolen(f1), SvPV_nolen(f2)) == 0))
 
 static void perl_signal_remove_list(GSList **list, SV *func)
 {
@@ -301,7 +301,7 @@
 	for (tmp = *list; tmp != NULL; tmp = tmp->next) {
 		PERL_SIGNAL_REC *rec = tmp->data;
 
-		if (sv_func_cmp(rec->func, func, PL_na)) {
+		if (sv_func_cmp(rec->func, func)) {
 			perl_signal_remove_list_one(list, rec);
 			break;
 		}
