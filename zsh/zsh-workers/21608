From zsh-workers-return-21608-mason-zsh=primenet.com.au@sunsite.dk Sun Aug 14 15:56:18 2005
Return-Path: <zsh-workers-return-21608-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 18343 invoked from network); 14 Aug 2005 15:56:15 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 14 Aug 2005 15:56:15 -0000
Received: (qmail 55694 invoked from network); 14 Aug 2005 15:56:05 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 14 Aug 2005 15:56:05 -0000
Received: (qmail 21980 invoked by alias); 14 Aug 2005 15:56:02 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 21608
Received: (qmail 21970 invoked from network); 14 Aug 2005 15:56:02 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 14 Aug 2005 15:56:02 -0000
Received: (qmail 55378 invoked from network); 14 Aug 2005 15:56:02 -0000
Received: from flock1.newmail.ru (212.48.140.157)
  by a.mx.sunsite.dk with SMTP; 14 Aug 2005 15:55:58 -0000
Received: (qmail 12924 invoked from network); 14 Aug 2005 15:48:40 -0000
Received: from unknown (HELO ?10.0.0.53?) (arvidjaar@newmail.ru@83.237.195.82)
  by smtpd.newmail.ru with SMTP; 14 Aug 2005 15:48:40 -0000
From: Andrey Borzenkov <arvidjaar@newmail.ru>
To: zsh-workers@sunsite.dk
Subject: Re: PATCH: fix 4, was Re: unpatch: metafying zle line
Date: Sun, 14 Aug 2005 19:55:31 +0400
User-Agent: KMail/1.8.2
References: <200508121021.j7CAL18n012569@news01.csr.com>
In-Reply-To: <200508121021.j7CAL18n012569@news01.csr.com>
MIME-Version: 1.0
Content-Type: multipart/signed;
  boundary="nextPart1285963.OPpmKR1zCS";
  protocol="application/pgp-signature";
  micalg=pgp-sha1
Content-Transfer-Encoding: 7bit
Message-Id: <200508141955.43507.arvidjaar@newmail.ru>
X-Spam-Checker-Version: SpamAssassin 3.0.4 (2005-06-05) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=BAYES_00 autolearn=ham 
	version=3.0.4

--nextPart1285963.OPpmKR1zCS
Content-Type: text/plain;
  charset="utf-8"
Content-Transfer-Encoding: quoted-printable
Content-Disposition: inline

On Friday 12 August 2005 14:21, Peter Stephenson wrote:
> After this, completion is basically working with ZLE_UNICODE_SUPPORT
> defined when you stick to using single-byte characters.  It's almost
> time to allow that to be enabled by default, which will help picking up
> the remaining problems with multi-byte characters:  those are likely to
> be widespread, but probably in most cases fixable by local changes.
>


Hat off to you, Sir! It is worth more than pizza ...

Multibyte basically works (ru_RU.UTF-8, Mandrake^H^H^Hiva cooker, gcc 4.0.1=
,=20
glibc 2.3.5). I.e. basic line editing (movement char, word, emacs or vi=20
mode). Completion - i.e. listing etc.

Some random problems.

1. attempt to use a-a-m-c results in

{pts/2}% ll =D0=BA=D0=BA=D0=BA=D0=BA=D0=BA=D0=BA=D0=BA=D0=BA =D0=BA=D0=BA=
=D0=BA=D0=BA=D0=BA=D0=BA=D0=BA=D0=BA=D0=BA=D0=BA=D0=BA/home/bor/src/zsh/Src=
/Zle/compresult.c:690:=20
line not metafied
zsh: segmentation fault (core dumped)  pkg/bin/zsh
#0  0xb7bef892 in hasbrpsfx (m=3D0x8178a50, pre=3D0x0, suf=3D0x0)
    at /home/bor/src/zsh/Src/Zle/compresult.c:699
699             memcpy(oline, zlemetaline, zlemetall);
(gdb) bt
#0  0xb7bef892 in hasbrpsfx (m=3D0x8178a50, pre=3D0x0, suf=3D0x0)
    at /home/bor/src/zsh/Src/Zle/compresult.c:699
#1  0xb7bf1e67 in calclist (showall=3D1)
    at /home/bor/src/zsh/Src/Zle/compresult.c:1489
#2  0xb7f4e3a4 in complistmatches (dummy=3D0xb7bf6ab0, dat=3D0xbff669b0)
    at /home/bor/src/zsh/Src/Zle/complist.c:1608
#3  0x080961f4 in runhookdef (h=3D0xb7bf6ab0, d=3D0xbff669b0)
    at /home/bor/src/zsh/Src/module.c:1889
#4  0xb7bf4761 in list_matches (dummy=3D0xb7c2cec0, dummy2=3D0x0)
    at /home/bor/src/zsh/Src/Zle/compresult.c:2200
#5  0x080961f4 in runhookdef (h=3D0xb7c2cec0, d=3D0x0)
    at /home/bor/src/zsh/Src/module.c:1889
#6  0xb7c14a5e in zrefresh ()
    at /home/bor/src/zsh/Src/Zle/zle_refresh.c:752
#7  0xb7f5027c in domenuselect (dummy=3D0xb7bf6a74, dat=3D0xbff66fe0)
    at /home/bor/src/zsh/Src/Zle/complist.c:2153
#8  0x0809618f in runhookdef (h=3D0xb7bf6a74, d=3D0xbff66fe0)
    at /home/bor/src/zsh/Src/module.c:1883
#9  0xb7bdea62 in after_complete (dummy=3D0xb7c2cefc, dat=3D0xbff6706c)
    at /home/bor/src/zsh/Src/Zle/compcore.c:506
#10 0x080961f4 in runhookdef (h=3D0xb7c2cefc, d=3D0xbff6706c)
    at /home/bor/src/zsh/Src/module.c:1889
#11 0xb7c19e55 in docomplete (lst=3D0)
    at /home/bor/src/zsh/Src/Zle/zle_tricky.c:851
#12 0xb7c18544 in completeword (args=3D0xb7c2d13c)
    at /home/bor/src/zsh/Src/Zle/zle_tricky.c:232
#13 0xb7c18421 in completecall (args=3D0xb7c2d13c)
    at /home/bor/src/zsh/Src/Zle/zle_tricky.c:208
#14 0xb7c0b09f in execzlefunc (func=3D0xb7c2b050, args=3D0xb7c2d13c)
    at /home/bor/src/zsh/Src/Zle/zle_main.c:1063
#15 0xb7c0a62b in zlecore ()
    at /home/bor/src/zsh/Src/Zle/zle_main.c:838
#16 0xb7c0ad1b in zleread (lp=3D0x80e63e0, rp=3D0x0, flags=3D7, context=3D0)
    at /home/bor/src/zsh/Src/Zle/zle_main.c:992
#17 0x08080ac3 in inputline () at /home/bor/src/zsh/Src/input.c:278
#18 0x08080978 in ingetc () at /home/bor/src/zsh/Src/input.c:214
#19 0x0807775b in ihgetc () at /home/bor/src/zsh/Src/hist.c:240
#20 0x080880f4 in gettok () at /home/bor/src/zsh/Src/lex.c:628
#21 0x0808792c in yylex () at /home/bor/src/zsh/Src/lex.c:344
#22 0x080a1269 in parse_event () at /home/bor/src/zsh/Src/parse.c:451
#23 0x0807d8d6 in loop (toplevel=3D1, justonce=3D0)
    at /home/bor/src/zsh/Src/init.c:128
#24 0x080805ba in zsh_main (argc=3D1, argv=3D0xbff67614)
    at /home/bor/src/zsh/Src/init.c:1315
#25 0x08052652 in main (argc=3D1, argv=3D0xbff67614)
    at /home/bor/src/zsh/Src/main.c:93

apparently it correctly inserts first match but crashes at recursive=20
completion attempt.


2. Attempt to complete anything beyond U'd183' results in

{pts/2}% ll =D1=83BUG: substring ends in the middle of a metachar in=20
ztrsub()mpleting `files'
         ll =D1=83
{pts/2}% echo =D1=83 | xxd
0000000: d183 0a                                  ...

I do not know what is magic about it; all characters before are completed=20
normally. Probably it somehow clashes with META characters. The above is in=
=20
UTF-8, it is 0400 unicode plane, character in question is 0443.

3. emacs ^W sometimes removes too much not just a previous word in Russian=
=20
(where word delimiter in this case is space):

{pts/2}% ll    =D0=90=D0=90=D0=90=D0=90=D0=90=D0=90 =D0=91=D0=91=D0=91=D0=
=91=D0=91=D0=91=D0=91=D0=91 =D0=92=D0=92=D0=92=D0=92=D0=92=D0=92=D0=92=D0=
=92=D0=92^W
{pts/2}%=20

4. Undo (in emacs or vi) often puts cursor not at previous position but at=
=20
some random position. In the above example, if I have anyhing after cursor:

{pts/2}% ll =D0=90 =D0=91 =D0=92^W
                 ^cursor here
{pts/2}% ^_
         ^ cursor here
{pts/2}% ll =D0=90 =D0=91 =D0=92
            ^ cursor here

the position is really random, sometimes it is end of buffer sometimes more.

But yes, I think it makes sense enable UNICODE by default now. It seems to =
be=20
usable, at least for simple filename completion.

Thank you

=2Dandrey

--nextPart1285963.OPpmKR1zCS
Content-Type: application/pgp-signature

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.0 (GNU/Linux)

iD8DBQBC/2l/R6LMutpd94wRAoPlAJwK0c2lZU7cSkblDjtOMHgwa4NougCeNCOC
doNDAe7HmV+Zyh7v1i484n0=
=e/oI
-----END PGP SIGNATURE-----

--nextPart1285963.OPpmKR1zCS--

