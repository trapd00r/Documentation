From zsh-workers-return-26677-mason-zsh=primenet.com.au@sunsite.dk Tue Mar 03 17:43:59 2009
Return-Path: <zsh-workers-return-26677-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 20698 invoked from network); 3 Mar 2009 17:43:55 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.4 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 3 Mar 2009 17:43:55 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 68902 invoked from network); 3 Mar 2009 17:43:51 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 3 Mar 2009 17:43:51 -0000
Received: (qmail 20671 invoked by alias); 3 Mar 2009 17:43:46 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 26677
Received: (qmail 20656 invoked from network); 3 Mar 2009 17:43:46 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 3 Mar 2009 17:43:46 -0000
Received: from cluster-g.mailcontrol.com (cluster-g.mailcontrol.com [208.87.233.190])
	by bifrost.dotsrc.org (Postfix) with ESMTPS id F24E18058F82
	for <zsh-workers@sunsite.dk>; Tue,  3 Mar 2009 18:43:42 +0100 (CET)
Received: from cameurexb01.EUROPE.ROOT.PRI ([193.128.72.68])
	by rly30g.srv.mailcontrol.com (MailControl) with ESMTP id n23Hhcto010339
	for <zsh-workers@sunsite.dk>; Tue, 3 Mar 2009 17:43:39 GMT
Received: from news01.csr.com ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.3959);
	 Tue, 3 Mar 2009 17:43:37 +0000
Received: from news01.csr.com (localhost.localdomain [127.0.0.1])
	by news01.csr.com (8.14.2/8.13.4) with ESMTP id n23HhcLu027485
	for <zsh-workers@sunsite.dk>; Tue, 3 Mar 2009 17:43:38 GMT
Received: from csr.com (pws@localhost)
	by news01.csr.com (8.14.2/8.14.2/Submit) with ESMTP id n23HhckA027481
	for <zsh-workers@sunsite.dk>; Tue, 3 Mar 2009 17:43:38 GMT
X-Authentication-Warning: news01.csr.com: pws owned process doing -bs
To: zsh-workers@sunsite.dk (Zsh hackers list)
Subject: PATCH: caps strings
X-Mailer: MH-E 8.0.3; nmh 1.3; GNU Emacs 22.1.1
Date: Tue, 03 Mar 2009 17:43:38 +0000
Message-ID: <27480.1236102218@csr.com>
From: Peter Stephenson <pws@csr.com>
X-OriginalArrivalTime: 03 Mar 2009 17:43:38.0039 (UTC) FILETIME=[955DF470:01C99C27]
X-Scanned-By: MailControl A_08_51_00 (www.mailcontrol.com) on 10.71.0.140
X-Virus-Scanned: ClamAV 0.92.1/9065/Tue Mar  3 11:43:41 2009 on bifrost
X-Virus-Status: Clean

This should fix string arguments to functions in the caps module as
noticed by Mikael.  It looks like all the returned strings are output
directly by library calls so aren't affected.

Index: Src/Modules/cap.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Modules/cap.c,v
retrieving revision 1.7
diff -u -r1.7 cap.c
--- Src/Modules/cap.c	6 Jul 2007 21:52:40 -0000	1.7
+++ Src/Modules/cap.c	3 Mar 2009 17:39:34 -0000
@@ -38,6 +38,7 @@
     int ret = 0;
     cap_t caps;
     if(*argv) {
+	unmetafy(*argv, NULL);
 	caps = cap_from_text(*argv);
 	if(!caps) {
 	    zwarnnam(nam, "invalid capability string");
@@ -90,6 +91,7 @@
     cap_t caps;
     int ret = 0;
 
+    unmetafy(*argv, NULL);
     caps = cap_from_text(*argv++);
     if(!caps) {
 	zwarnnam(nam, "invalid capability string");
@@ -97,6 +99,7 @@
     }
 
     do {
+	unmetafy(*argv, NULL);
 	if(cap_set_file(*argv, caps)) {
 	    zwarnnam(nam, "%s: %e", *argv, errno);
 	    ret = 1;


-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070

