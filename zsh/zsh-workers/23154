From zsh-workers-return-23154-mason-zsh=primenet.com.au@sunsite.dk Wed Feb 07 11:45:00 2007
Return-Path: <zsh-workers-return-23154-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 24283 invoked from network); 7 Feb 2007 11:44:54 -0000
X-Spam-Checker-Version: SpamAssassin 3.1.7 (2006-10-05) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=BAYES_00,FORGED_RCVD_HELO 
	autolearn=ham version=3.1.7
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 7 Feb 2007 11:44:54 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 16231 invoked from network); 7 Feb 2007 11:44:47 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 7 Feb 2007 11:44:47 -0000
Received: (qmail 16710 invoked by alias); 7 Feb 2007 11:44:45 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 23154
Received: (qmail 16701 invoked from network); 7 Feb 2007 11:44:44 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 7 Feb 2007 11:44:44 -0000
Received: (qmail 15924 invoked from network); 7 Feb 2007 11:44:44 -0000
Received: from cluster-d.mailcontrol.com (217.69.20.190)
  by a.mx.sunsite.dk with SMTP; 7 Feb 2007 11:44:38 -0000
Received: from cameurexb01.EUROPE.ROOT.PRI ([62.189.241.200])
	by rly37d.srv.mailcontrol.com (MailControl) with ESMTP id l17Bgwif006165
	for <zsh-workers@sunsite.dk>; Wed, 7 Feb 2007 11:44:24 GMT
Received: from news01.csr.com ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.1830);
	 Wed, 7 Feb 2007 11:43:22 +0000
Received: from news01.csr.com (localhost.localdomain [127.0.0.1])
	by news01.csr.com (8.13.8/8.13.4) with ESMTP id l17BhJgX008066
	for <zsh-workers@sunsite.dk>; Wed, 7 Feb 2007 11:43:19 GMT
Received: from csr.com (pws@localhost)
	by news01.csr.com (8.13.8/8.13.8/Submit) with ESMTP id l17BhGDj008062
	for <zsh-workers@sunsite.dk>; Wed, 7 Feb 2007 11:43:19 GMT
Message-Id: <200702071143.l17BhGDj008062@news01.csr.com>
X-Authentication-Warning: news01.csr.com: pws owned process doing -bs
To: zsh-workers@sunsite.dk (Zsh hackers list)
Subject: PATCH: turn off baud rate compensation by default
Date: Wed, 07 Feb 2007 11:43:16 +0000
From: Peter Stephenson <pws@csr.com>
X-OriginalArrivalTime: 07 Feb 2007 11:43:22.0856 (UTC) FILETIME=[2BD58680:01C74AAD]
Content-Type: text/plain
MIME-Version: 1.0
X-Scanned-By: MailControl A-07-06-80 (www.mailcontrol.com) on 10.68.0.147

I was seeing odd delays in my xterm when updating long lines (but not
*that* long: about ten screen lines) which I eventually tracked down to
the baud rate compensation mechanism in zle.  Setting BAUD to 0 removed
this effect, but it seems to me that it's no longer appropriate to turn
this on by default:

- If it took me several minutes to find out where the delay was coming
from, it's going to puzzle a lot of people if they notice it.  That
would be OK if the benefits outweighed this.  However:
- It's initialised from the output baud rate set in the terminal driver.
On most modern systems that's got very little to do with the actual
rate at which the display is updated; it's a hangover from the days of
serial communications when your terminal was attached by RS232 rather
than a virtual terminal running in an ATI RADEON SeveralZillion (TM)
1024 squigabyte display card.
- If you *do* have a slow line, nowadays it's probably the Internet,
or some modem line between your PC and the shell server, not the
actual terminal line for which the baud rate is available to the shell.
- Hence on those occasions where it makes a useful difference, it's
almost always better to allow the user to set BAUD to an appropriate
value.

I won't check this in until you've had a chance to fault my logic.

Index: Doc/Zsh/params.yo
===================================================================
RCS file: /cvsroot/zsh/zsh/Doc/Zsh/params.yo,v
retrieving revision 1.35
diff -u -r1.35 params.yo
--- Doc/Zsh/params.yo	30 Oct 2006 10:37:17 -0000	1.35
+++ Doc/Zsh/params.yo	7 Feb 2007 11:30:48 -0000
@@ -744,17 +744,15 @@
 )
 vindex(BAUD)
 item(tt(BAUD))(
-The baud rate of the current connection.  Used by the line editor
-update mechanism to compensate for a slow terminal by delaying
-updates until necessary.  This may be profitably set to a lower value
-in some circumstances, e.g.
-for slow modems dialing into a communications server which is connected
-to a host via a fast link; in this case, this variable
-would be set by default to the speed of the fast link, and not
-the modem.
-This parameter should be set to the baud
-rate of the slowest part of the link for best performance. The compensation
-mechanism can be turned off by setting the variable to zero.
+The rate in bits per second at which data reaches the terminal.
+The line editor will use this value in order to compensate for a slow
+terminal by delaying updates to the display until necessary.  The default
+value is zero, which turns off the compensation mechanism.
+
+This may be profitably set in some circumstances, e.g.
+for slow modems dialing into a communications server, or on a slow wide
+area network.  This parameter should be set to the baud
+rate of the slowest part of the link for best performance.
 )
 vindex(cdpath)
 vindex(CDPATH)
Index: Src/params.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/params.c,v
retrieving revision 1.122
diff -u -r1.122 params.c
--- Src/params.c	6 Feb 2007 21:47:55 -0000	1.122
+++ Src/params.c	7 Feb 2007 11:30:51 -0000
@@ -641,7 +641,17 @@
     setiparam("KEYTIMEOUT", 40);
     setiparam("LISTMAX", 100);
 #ifdef HAVE_SELECT
-    setiparam("BAUD", getbaudrate(&shttyinfo));  /* get the output baudrate */
+    /*
+     * We used to get the output baud rate here.  However, that's
+     * pretty irrelevant to a terminal on an X display and can lead
+     * to unnecessary delays if it's wrong (which it probably is).
+     * Furthermore, even if the output is slow it's very likely
+     * to be because of WAN delays, not covered by the output
+     * baud rate.
+     * So allow the user to set it in the special cases where it's
+     * useful.
+     */
+    setiparam("BAUD", 0);
 #endif
     setsparam("TMPPREFIX", ztrdup(DEFAULT_TMPPREFIX));
     setsparam("TIMEFMT", ztrdup(DEFAULT_TIMEFMT));

-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070


To access the latest news from CSR copy this link into a web browser:  http://www.csr.com/email_sig.php

To get further information regarding CSR, please visit our Investor Relations page at http://ir.csr.com/csr/about/overview

