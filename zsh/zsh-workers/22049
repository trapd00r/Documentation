From zsh-workers-return-22049-mason-zsh=primenet.com.au@sunsite.dk Sat Dec 03 00:10:23 2005
Return-Path: <zsh-workers-return-22049-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 2440 invoked from network); 3 Dec 2005 00:10:17 -0000
X-Spam-Checker-Version: SpamAssassin 3.1.0 (2005-09-13) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=AWL,BAYES_00,
	FORGED_RCVD_HELO autolearn=ham version=3.1.0
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 3 Dec 2005 00:10:17 -0000
Received: (qmail 3645 invoked from network); 3 Dec 2005 00:10:08 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 3 Dec 2005 00:10:08 -0000
Received: (qmail 28705 invoked by alias); 3 Dec 2005 00:10:04 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 22049
Received: (qmail 28692 invoked from network); 3 Dec 2005 00:10:03 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 3 Dec 2005 00:10:03 -0000
Received: (qmail 3190 invoked from network); 3 Dec 2005 00:10:03 -0000
Received: from mta09-winn.ispmail.ntl.com (81.103.221.49)
  by a.mx.sunsite.dk with SMTP; 3 Dec 2005 00:10:01 -0000
Received: from aamta11-winn.ispmail.ntl.com ([81.103.221.35])
          by mta09-winn.ispmail.ntl.com with ESMTP
          id <20051203001001.CWUB8609.mta09-winn.ispmail.ntl.com@aamta11-winn.ispmail.ntl.com>
          for <zsh-workers@sunsite.dk>; Sat, 3 Dec 2005 00:10:01 +0000
Received: from pwslaptop.csr.com ([81.105.238.64])
          by aamta11-winn.ispmail.ntl.com with SMTP
          id <20051203001001.HIUG16192.aamta11-winn.ispmail.ntl.com@pwslaptop.csr.com>
          for <zsh-workers@sunsite.dk>; Sat, 3 Dec 2005 00:10:01 +0000
Date: Sat, 3 Dec 2005 00:09:49 +0000
From: Peter Stephenson <p.w.stephenson@ntlworld.com>
To: zsh-workers@sunsite.dk
Subject: Re: Bug in recursive function calls, source and exit
Message-Id: <20051203000949.4ddf2529.p.w.stephenson@ntlworld.com>
In-Reply-To: <20051202220921.GR8445@ay.vinc17.org>
References: <20051202220921.GR8445@ay.vinc17.org>
X-Mailer: Sylpheed version 0.9.12 (GTK+ 1.2.10; i386-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit

On Fri, 2 Dec 2005 23:09:21 +0100
Vincent Lefevre <vincent@vinc17.org> wrote:
> In a French mailing-list, I've just heard of a bug related to
> recursive function calls, source and exit; I don't think it has
> been reported yet.

Thanks for passing it on.  You can see the bug more simply with:

echo exit >file
zsh -fc 'fn() { . ./file; echo Didn\'\''t exit; }; fn'

The problem is that we don't exit immediately from functions to allow
EXIT traps to run (zsh has more handling for these than other shells),
instead we force the function to return immediately.  However, the code
for "." was resetting the flag to return from the function.

Index: Src/init.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/init.c,v
retrieving revision 1.60
diff -u -r1.60 init.c
--- Src/init.c	15 Nov 2005 08:44:21 -0000	1.60
+++ Src/init.c	3 Dec 2005 00:03:30 -0000
@@ -1085,7 +1085,8 @@
     loops = oloops;                  /* the # of nested loops we are in      */
     dosetopt(SHINSTDIN, oldshst, 1); /* SHINSTDIN option                     */
     errflag = 0;
-    retflag = 0;
+    if (!exit_pending)
+	retflag = 0;
     scriptname = old_scriptname;
     free(cmdstack);
     cmdstack = ocs;

-- 
Peter Stephenson <p.w.stephenson@ntlworld.com>
Web page still at http://www.pwstephenson.fsnet.co.uk/

