From zsh-users-return-12562-mason-zsh=primenet.com.au@sunsite.dk Wed Feb 13 19:02:11 2008
Return-Path: <zsh-users-return-12562-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 22721 invoked from network); 13 Feb 2008 19:02:09 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.4 (2008-01-01) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=BAYES_00 autolearn=ham
	version=3.2.4
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 13 Feb 2008 19:02:09 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 31053 invoked from network); 13 Feb 2008 19:01:42 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 13 Feb 2008 19:01:42 -0000
Received: (qmail 22684 invoked by alias); 13 Feb 2008 19:01:32 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 12562
Received: (qmail 22667 invoked from network); 13 Feb 2008 19:01:32 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 13 Feb 2008 19:01:32 -0000
Received: from flock1.newmail.ru (flock1.newmail.ru [82.204.219.207])
	by bifrost.dotsrc.org (Postfix) with SMTP id 1EE8780482A1
	for <zsh-users@sunsite.dk>; Wed, 13 Feb 2008 20:01:23 +0100 (CET)
Received: (qmail 29515 invoked from network); 13 Feb 2008 19:01:23 -0000
Received: from unknown (HELO cooker.net) (arvidjaar@newmail.ru@91.77.252.164)
  by smtpd.newmail.ru with SMTP; 13 Feb 2008 19:01:23 -0000
From: Andrey Borzenkov <arvidjaar@newmail.ru>
To: zsh-users@sunsite.dk
Subject: Re: Phil's prompt is not working when LANG is set to UTF-8
Date: Wed, 13 Feb 2008 22:01:21 +0300
User-Agent: KMail/1.9.6 (enterprise 0.20071123.740460)
References: <20080211033116.GD19613@phoenix.nasreddine.info> <20080211155200.0a8e9ecf@news01> <200802132133.35130.arvidjaar@newmail.ru>
In-Reply-To: <200802132133.35130.arvidjaar@newmail.ru>
MIME-Version: 1.0
Content-Type: multipart/signed;
  boundary="nextPart9945730.kkMp6KDU8v";
  protocol="application/pgp-signature";
  micalg=pgp-sha1
Content-Transfer-Encoding: 7bit
Message-Id: <200802132201.21702.arvidjaar@newmail.ru>
X-Virus-Scanned: ClamAV 0.91.2/5800/Wed Feb 13 18:52:20 2008 on bifrost
X-Virus-Status: Clean

--nextPart9945730.kkMp6KDU8v
Content-Type: text/plain;
  charset="utf-8"
Content-Transfer-Encoding: quoted-printable
Content-Disposition: inline

On Wednesday 13 February 2008, Andrey Borzenkov wrote:
> On Monday 11 February 2008, Peter Stephenson wrote:
> >=20
> > On Mon, 11 Feb 2008 16:07:09 +0100
> > antho.charles@gmail.com wrote:
> > > I didn't have this problem on Debian etch, but it appears when I
> > > upgraded to lenny. It's the same problem: if I set LANG to a non utf8
> > > encoding (fr_FR instead of fr_FR.UTF-8), RPROMPT is good, otherwise
> > > it's partially on another line and the cusor is after RPROMPT.
> > > (cf. http://tinyurl.com/3xjeqt)
> >=20
> > Sounds like it ought to be fairly reproducible, but it's not happening =
on
> > Fedora 8 (and it still sounds suspiciously like the shell is getting du=
ff
> > information about the environment, though that's certainly not the only
> > possibility).  I've tried adding multibyte characters to the command li=
ne
> > and complicating the RPROMPT and even adding multibyte characters to th=
at,
> > but it still works OK.
> >=20
> > Are there any particular things on the command line, forms of RPROMPT e=
tc.
> > etc. that show this up?  (We really need something that narrows this do=
wn.)
> >=20
>=20
> I can reproduce it on Mandriva cooker with locale en_US.UTF-8 or ru_RU.UT=
=46-8.=20
It=20
> does not matter whether there are UTF-8 characters on the screen (at leas=
t, I=20
am=20
> not sure whether there are - en_US.UTF-8 should not emit any non-ASCII st=
rings=20
> as far as I can tell).
>=20

Actually the problem seems to be that terminal description contains non-UTF=
=2D8=20
conform characters.

{pts/0}% infocmp | grep acsc
        acsc=3D``aaffggiijjkkllmmnnooppqqrrssttuuvvwwxxyyzz{{||}}~~,
{pts/0}% infocmp linux | grep acsc
        acsc=3D+\020\,
\021-\030.^Y0\333`\004a\261f\370g\361h\260i\316j\331k\277l\332m\300n\305o~p=
\304q\304r\304s_t\303u\264v\301w\302x\263y\363z\362
{\343|\330}\234~\376,

the first one is for dtterm, the second - for linux console.

The prompt is using q, l, m, j, k - at least some of them have high bit set.

So something gets confused computing prompt width. I am not really sure
how to fix it except teaching zsh about ACS mode. Is there any curses funct=
ion
that would return screen width of character string?


--nextPart9945730.kkMp6KDU8v
Content-Type: application/pgp-signature; name=signature.asc 
Content-Description: This is a digitally signed message part.

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.8 (GNU/Linux)

iEYEABECAAYFAkezPoEACgkQR6LMutpd94zfAACfQdalCMw3W0cpys2H/M5hsedv
8XEAoJWt0AgfOvXh+36fOe/r1PmMiCH0
=gPAU
-----END PGP SIGNATURE-----

--nextPart9945730.kkMp6KDU8v--

