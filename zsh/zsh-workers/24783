From zsh-workers-return-24783-mason-zsh=primenet.com.au@sunsite.dk Thu Apr 03 10:30:35 2008
Return-Path: <zsh-workers-return-24783-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 14013 invoked from network); 3 Apr 2008 10:30:24 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.4 (2008-01-01) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=BAYES_00 autolearn=ham
	version=3.2.4
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 3 Apr 2008 10:30:24 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 77400 invoked from network); 3 Apr 2008 10:30:20 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 3 Apr 2008 10:30:20 -0000
Received: (qmail 6917 invoked by alias); 3 Apr 2008 10:30:18 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 24783
Received: (qmail 6900 invoked from network); 3 Apr 2008 10:30:17 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 3 Apr 2008 10:30:17 -0000
Received: from n39.bullet.mail.ukl.yahoo.com (n39.bullet.mail.ukl.yahoo.com [87.248.110.172])
	by bifrost.dotsrc.org (Postfix) with SMTP id 26C1282DC37A
	for <zsh-workers@sunsite.dk>; Thu,  3 Apr 2008 12:30:13 +0200 (CEST)
Received: from [217.146.182.180] by n39.bullet.mail.ukl.yahoo.com with NNFMP; 03 Apr 2008 10:30:13 -0000
Received: from [87.248.110.118] by t6.bullet.ukl.yahoo.com with NNFMP; 03 Apr 2008 10:30:13 -0000
Received: from [127.0.0.1] by omp223.mail.ukl.yahoo.com with NNFMP; 03 Apr 2008 10:30:13 -0000
X-Yahoo-Newman-Id: 346243.36431.bm@omp223.mail.ukl.yahoo.com
Received: (qmail 61355 invoked from network); 3 Apr 2008 10:30:13 -0000
DomainKey-Signature: a=rsa-sha1; q=dns; c=nofws;
  s=s1024; d=yahoo.co.uk;
  h=Received:X-YMail-OSG:X-Yahoo-Newman-Property:Received:In-reply-to:From:References:To:Subject:Date:Message-ID;
  b=XvnH8jcE0frm67LI2r/w/3DoF1ni5aSN+YvfK563PZKi2gADAQ73VXYYYxMXgDSXzEpzhn7/thZ7psN73UFwbZKpLDMvmqdAGAGXkgeue7/CfStX1pSMGNhqkcV8W9Dw1JbKSVYWSh57INJKhCgpBp95Xf3mvHTmD09nLIW1ewc=  ;
Received: from unknown (HELO thecus) (okiddle@89.60.252.216 with plain)
  by smtp105.mail.ukl.yahoo.com with SMTP; 3 Apr 2008 10:30:13 -0000
X-YMail-OSG: 52E7UIAVM1nX7z9RikvilPolmvkLW2O3Qj7yu6G7nReDcAwJ5zxz1P6AVA5zcRVDGkWZFSwurQ--
X-Yahoo-Newman-Property: ymail-3
Received: from opk (helo=thecus)
	by thecus with local-esmtp (Exim 4.63)
	(envelope-from <okiddle@yahoo.co.uk>)
	id 1JhMhy-0002dM-FK
	for zsh-workers@sunsite.dk; Thu, 03 Apr 2008 12:30:14 +0200
In-reply-to: <8360.1207165155@pws-pc> 
From: Oliver Kiddle <okiddle@yahoo.co.uk>
References: <8360.1207165155@pws-pc>
To: zsh-workers@sunsite.dk (Zsh hackers list)
Subject: Re: PATCH: command line highlighting
Date: Thu, 03 Apr 2008 12:30:14 +0200
Message-ID: <10127.1207218614@thecus>
X-Virus-Scanned: ClamAV 0.91.2/6564/Thu Apr  3 11:44:56 2008 on bifrost
X-Virus-Status: Clean

Peter Stephenson wrote:
> Now 4.3.6 is out of the way, here's something I've been working on.  It
> highlights the normal command line (not a completion list) in three

Very cool. This is fantastic. The fish shell will be going belly up once
this evolves a bit.

> +special array parameter tt(region_highglight); see

There's a typo there.

Can the region and unprintable characters have a different highlight
style? zle_highlight is an array, right? Or is that for start/end escape
sequences.

> - arbitrary chunks of the line:  controlled by the (zle special) array
>   region_highlight.  This is limited to static uses at the moment;
>   highlighting doesn't track movement.

This is probably the part that will be expanded on if things like syntax
highlighting will be done in shell code (completion system like).

As a test, I wrote a very rudimentary bracket matching widget:
  local i
  zle self-insert
  for ((i=$CURSOR;i;i--)) {
    [[ $BUFFER[$i] = '(' ]] && break
  }
  region_highlight=("$((i-1)) $i/ bold")  
With a zle -M command at the end of this, zsh coredumps. Let me know if
you can't reproduce it. I observed it on Solaris 10.

I'm not sure where and how to implement the unhighlight. Ideally, I
would like to have the matching paren highlighted for 1 second which
is what nedit does. And how can it be sure to remove its highlight
and not a region from some other widget. In the same way as compadd
adds completion matches instead of us having a $comp_matches, maybe a
builtin would be easier. It might allow more flexibility: timeout options,
group/tag identifiers, etc.

I'm not too familiar with the way syntax highlighting is typically done
in text editors. Maybe command-lines are small enough that reparsing
the whole line each time makes sense but that might imply full redraws
which could be bad over slow ssh connections. If the parsing is only
done partially as changes are made, then we'll need a good few hooks and
a way to make highlights sticky: the same word in the buffer is
highlighted even as text is inserted before it.

This is going to make the whole concept of PS2 prompts instead of proper
multiline editing seem even more out of place.

Oliver

