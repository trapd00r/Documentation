From zsh-workers-request@euclid.skiles.gatech.edu Fri Jan 03 10:59:11 1997
Return-Path: <zsh-workers-request@euclid.skiles.gatech.edu>
Delivered-To: mason@primenet.com.au
Received: (qmail 10973 invoked from network); 3 Jan 1997 10:59:09 -0000
Received: from euclid.skiles.gatech.edu (list@130.207.146.50)
  by coral.primenet.com.au with SMTP; 3 Jan 1997 10:59:09 -0000
Received: (from list@localhost) by euclid.skiles.gatech.edu (8.7.3/8.7.3) id GAA17628; Fri, 3 Jan 1997 06:03:12 -0500 (EST)
Resent-Date: Fri, 3 Jan 1997 06:03:12 -0500 (EST)
From: Zefram <zefram@dcs.warwick.ac.uk>
Message-Id: <948.199701031104@stone.dcs.warwick.ac.uk>
Subject: recursive makes
To: zsh-workers@math.gatech.edu (Z Shell workers mailing list)
Date: Fri, 3 Jan 1997 11:04:08 +0000 (GMT)
X-Patch: 182
X-Loop: zefram@dcs.warwick.ac.uk
X-Stardate: [-31]8672.30
X-US-Congress: Moronic fuckers
Content-Type: text
Resent-Message-ID: <"quHSM1.0.KJ4.lTEpo"@euclid>
Resent-From: zsh-workers@math.gatech.edu
X-Mailing-List: <zsh-workers@math.gatech.edu> archive/latest/2712
X-Loop: zsh-workers@math.gatech.edu
Precedence: list
Resent-Sender: zsh-workers-request@math.gatech.edu

-----BEGIN PGP SIGNED MESSAGE-----

This patch makes the linked-in module object files be built with as few
recursive make invocations as possible.  (This method does one sed per
object, instead of the old two per module; in tests I find that such a
sed is about an order of magnitude cheaper than a null make.)

This change also allows for the possibility of a module with objects in
more than one directory, which the old code didn't handle correctly.

 -zefram

      *** Src/mkstamp.sh	1997/01/03 05:28:31	1.4
      --- Src/mkstamp.sh	1997/01/03 09:06:16
      ***************
      *** 18,23 ****
      --- 18,27 ----
        act="rm -f `pwd`/$STMP"
        trap "rm -f $STMP.tmp; exit 1" 1 2 15
        echo > $STMP.tmp
      + makelist=' //'
      + mlsed='s% \([^/][^/]*/[^/]*\)$% ./\1%
      +        s% \([^ ]*/[^ ]*\) \([^/]*\) \([^ ]*/.*\) \1/\([^ /]*\)$% \1 \2 \4 \3%
      +        s% // \(.*\)/\([^/]*\)$% \1 \2 //%'
        for mod in `cat $MODBINS`; do
            sed='/^ *'$mod' *:[^:>]*$/{
                     s/.*://
      ***************
      *** 38,48 ****
        	    exit 1
        	fi
            fi
      !     bdir=`echo $objs | sed 's, .*$,,;s,^,./,;s,/[^/]*$,,'`
      !     bobjs=`echo '' $objs | sed 's, [^ ]*/, ,g'`
            (cd $bdir && eval "$MAKE $MAKEDEFS EXTRA_BUILDACT=\"\$act\" \$bobjs") ||
        	{ rm -f $STMP.tmp; exit 1; }
      -     echo $objs >> $STMP.tmp
        done
        if cmp -s $STMP.tmp $STMP; then
            rm -f $STMP.tmp
      --- 42,67 ----
        	    exit 1
        	fi
            fi
      !     for obj in $objs; do
      ! 	makelist=`echo "$makelist $obj" | sed -e "$mlsed"`
      !     done
      !     echo $objs >> $STMP.tmp
      ! done
      ! set dummy $makelist
      ! shift
      ! while test :"$1" != ://; do
      !     bdir=$1
      !     shift
      !     bobjs=
      !     while :; do
      ! 	case "$1" in
      ! 	    */*) break ;;
      ! 	esac
      ! 	bobjs="$bobjs $1"
      ! 	shift
      !     done
            (cd $bdir && eval "$MAKE $MAKEDEFS EXTRA_BUILDACT=\"\$act\" \$bobjs") ||
        	{ rm -f $STMP.tmp; exit 1; }
        done
        if cmp -s $STMP.tmp $STMP; then
            rm -f $STMP.tmp

-----BEGIN PGP SIGNATURE-----
Version: 2.6.2

iQCVAwUBMszOnXD/+HJTpU/hAQFTDQP/SR/TM28wMd2b165yvhJzh/BG/yemyIwP
ruVokljCBDv1BzzVXUtI/tQBfz4KWmSFfzuoMdypWqQ2QbqKbbizgLJgTKM7fcX3
XnumF29VxrotJEk1cfh/ZXcrg5SiivhY4BTwl/9ZrINRUlm5veH3Gn+8zCMPf9JZ
ibKwCDC8Zvw=
=nauK
-----END PGP SIGNATURE-----

