From zsh-workers-return-23238-mason-zsh=primenet.com.au@sunsite.dk Tue Mar 27 10:42:55 2007
Return-Path: <zsh-workers-return-23238-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 19884 invoked from network); 27 Mar 2007 10:42:52 -0000
X-Spam-Checker-Version: SpamAssassin 3.1.8 (2007-02-13) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-1.8 required=5.0 tests=AWL,BAYES_00,FORGED_RCVD_HELO,
	MANY_EXCLAMATIONS,PLING_QUERY autolearn=no version=3.1.8
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 27 Mar 2007 10:42:52 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 97586 invoked from network); 27 Mar 2007 10:42:46 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 27 Mar 2007 10:42:46 -0000
Received: (qmail 8344 invoked by alias); 27 Mar 2007 10:42:43 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 23238
Received: (qmail 8334 invoked from network); 27 Mar 2007 10:42:42 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 27 Mar 2007 10:42:42 -0000
Received: (qmail 97282 invoked from network); 27 Mar 2007 10:42:42 -0000
Received: from cluster-c.mailcontrol.com (168.143.177.190)
  by a.mx.sunsite.dk with SMTP; 27 Mar 2007 10:42:39 -0000
Received: from cameurexb01.EUROPE.ROOT.PRI ([62.189.241.200])
	by rly05c.srv.mailcontrol.com (MailControl) with ESMTP id l2RAftJB027969
	for <zsh-workers@sunsite.dk>; Tue, 27 Mar 2007 11:42:33 +0100
Received: from news01.csr.com ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.1830);
	 Tue, 27 Mar 2007 11:42:06 +0100
Date: Tue, 27 Mar 2007 11:42:06 +0100
From: Peter Stephenson <pws@csr.com>
To: Zsh hackers list <zsh-workers@sunsite.dk>
Subject: Re: compinit in sourced file breaks bg command!?!
Message-Id: <20070327114206.c7e3494d.pws@csr.com>
In-Reply-To: <20070327093306.GA4885@sc.homeunix.net>
References: <20070327093306.GA4885@sc.homeunix.net>
Organization: Cambridge Silicon Radio
X-Mailer: Sylpheed version 2.2.10 (GTK+ 2.10.8; i386-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
X-OriginalArrivalTime: 27 Mar 2007 10:42:06.0850 (UTC) FILETIME=[90978620:01C7705C]
X-Scanned-By: MailControl A-07-06-90 (www.mailcontrol.com) on 10.67.0.115

Stephane Chazelas <Stephane_Chazelas@yahoo.fr> wrote:
> I've been experiencing an annoting behavior of bg recently.
> 
> $ cmd
> <CTRL-Z>
> $ bg
> 
> and  cmd is not made the "current job".

Thanks for spotting this, I would probably not have noticed...

zsh keeps a record of both the current and previous jobs, marked +
and - in job lists.  The logic that handles them is a little obscure,
but apparently it usually works so I haven't looked in any detail.

In this case there was another job in the job table, and that was being
made the current job.  Apparently this was coming from the compinit stuff,
although the details of how aren't important:  the point was that this
job was being marked as "done", but not being deleted from the table.
It turns out the job was also marked as not to be displayed to the user
("noprint"), and it seems that in that case we return from the job-printing
function without bothering to delete the job.

Fixing that logical error seems to make the problem go away.  Let me know
if it doesn't.

Index: Src/jobs.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/jobs.c,v
retrieving revision 1.54
diff -u -r1.54 jobs.c
--- Src/jobs.c	30 Jan 2007 19:03:46 -0000	1.54
+++ Src/jobs.c	27 Mar 2007 10:36:29 -0000
@@ -806,7 +806,10 @@
  * synch = 2 means called synchronously from jobs
  *
  * Returns 1 if some output was done.
-*/
+ *
+ * The function also deletes the job if it was done, even it
+ * is not printed.
+ */
 
 /**/
 int
@@ -818,8 +821,18 @@
     int doneprint = 0;
     FILE *fout = (synch == 2) ? stdout : shout;
 
-    if (jn->stat & STAT_NOPRINT)
+    if (jn->stat & STAT_NOPRINT) {
+	if (jn->stat & STAT_DONE) {
+	    deletejob(jn);
+	if (job == curjob) {
+	    curjob = prevjob;
+	    prevjob = job;
+	}
+	if (job == prevjob)
+	    setprevjob();
+	}
 	return 0;
+    }
 
     /*
      * Wow, what a hack.  Did I really write this? --- pws

-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070


To access the latest news from CSR copy this link into a web browser:  http://www.csr.com/email_sig.php

To get further information regarding CSR, please visit our Investor Relations page at http://ir.csr.com/csr/about/overview

