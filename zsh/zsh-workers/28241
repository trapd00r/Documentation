From zsh-workers-return-28241-mason-zsh=primenet.com.au@zsh.org Tue Sep 07 17:55:49 2010
Return-Path: <zsh-workers-return-28241-mason-zsh=primenet.com.au@zsh.org>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 15514 invoked by alias); 7 Sep 2010 17:55:49 -0000
Mailing-List: contact zsh-workers-help@zsh.org; run by ezmlm
Precedence: bulk
X-No-Archive: yes
List-Id: Zsh Workers List <zsh-workers.zsh.org>
List-Post: <mailto:zsh-workers@zsh.org>
List-Help: <mailto:zsh-workers-help@zsh.org>
Delivered-To: mailing list zsh-workers@zsh.org
X-Seq: 28241
Received: (qmail 17304 invoked from network); 7 Sep 2010 17:55:46 -0000
X-Spam-Checker-Version: SpamAssassin 3.3.1 (2010-03-16) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=BAYES_00,RCVD_IN_DNSWL_LOW,
	SPF_HELO_PASS autolearn=ham version=3.3.1
Received-SPF: none (ns1.primenet.com.au: domain at csr.com does not designate permitted sender hosts)
Date: Tue, 7 Sep 2010 18:55:39 +0100
From: Peter Stephenson <Peter.Stephenson@csr.com>
To: "Zsh Hackers' List" <zsh-workers@zsh.org>
Subject: Re: PATCH: documentation on keymap selection
Message-ID: <20100907185539.770b47aa@pwslap01u.europe.root.pri>
In-Reply-To: <100907095848.ZM12813@torch.brasslantern.com>
References: <20100903230610.34ecd51b@pws-pc>
	<20100905204050.0a87a151@pws-pc>
	<100907095848.ZM12813@torch.brasslantern.com>
Organization: Cambridge Silicon Radio
X-Mailer: Claws Mail 3.7.6 (GTK+ 2.18.9; i686-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
X-OriginalArrivalTime: 07 Sep 2010 17:55:39.0611 (UTC) FILETIME=[E1E4DAB0:01CB4EB5]
X-Scanned-By: MailControl A-06-00-00 (www.mailcontrol.com) on 10.71.0.131

On Tue, 07 Sep 2010 09:58:48 -0700
Bart Schaefer <schaefer@brasslantern.com> wrote:
> schaefer<501> bindkey -lL
> bindkey -N .safe
> bindkey -N command
> bindkey -N emacs
> bindkey -N isearch
> bindkey -N listscroll
> bindkey -A emacs main
> bindkey -N menuselect
> bindkey -N vicmd
> bindkey -N viins
> 
> Is it really correct to include "bindkey -N .safe" in that output?

Hmm, that's definitely a good point.

If we simply omit it the output is no longer printing all the keymaps, as
it used to.  Of course, bindkey -l does that, and you can argue bindkey -lL
needs to be useful, which is after all the aim of the previous change.
Given the new behaviour is incompatible with the old, and the old was a
lie, maybe that is the right thing to do.

Index: Doc/Zsh/zle.yo
===================================================================
RCS file: /cvsroot/zsh/zsh/Doc/Zsh/zle.yo,v
retrieving revision 1.87
diff -p -u -r1.87 zle.yo
--- Doc/Zsh/zle.yo	6 Sep 2010 08:50:05 -0000	1.87
+++ Doc/Zsh/zle.yo	7 Sep 2010 17:54:10 -0000
@@ -185,7 +185,10 @@ those keymaps.
 If the tt(-L) option is also used, list in the form of tt(bindkey)
 commands to create or link the keymaps.  `tt(bindkey -lL
 main)' shows which keymap is linked to `tt(main)', if any, and hence if
-the standard emacs or vi emulation is in effect.
+the standard emacs or vi emulation is in effect.  This option does
+not show the tt(.safe) keymap because it cannot be created in that
+fashion; however, neither is `tt(bindkey -lL .safe)' reported as an
+error, it simply outputs nothing.
 )
 item(tt(-d))(
 Delete all existing keymaps and reset to the default state.
Index: Src/Zle/zle_keymap.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/zle_keymap.c,v
retrieving revision 1.34
diff -p -u -r1.34 zle_keymap.c
--- Src/Zle/zle_keymap.c	5 Sep 2010 20:39:09 -0000	1.34
+++ Src/Zle/zle_keymap.c	7 Sep 2010 17:54:10 -0000
@@ -829,12 +829,18 @@ bin_bindkey_lsmaps(char *name, UNUSED(ch
 
 /**/
 static void
-scanlistmaps(HashNode hn, int list)
+scanlistmaps(HashNode hn, int list_verbose)
 {
     KeymapName n = (KeymapName) hn;
 
-    if (list) {
+    if (list_verbose) {
 	Keymap km = n->keymap;
+	/*
+	 * Don't list ".safe" as a bindkey command; we can't
+	 * actually create it that way.
+	 */
+	if (!strcmp(n->nam, ".safe"))
+	    return;
 	fputs("bindkey -", stdout);
 	if (km->primary && km->primary != n) {
 	    KeymapName pn = km->primary;

-- 
Peter Stephenson <pws@csr.com>            Software Engineer
Tel: +44 (0)1223 692070                   Cambridge Silicon Radio Limited
Churchill House, Cambridge Business Park, Cowley Road, Cambridge, CB4 0WZ, UK


Member of the CSR plc group of companies. CSR plc registered in England and Wales, registered number 4187346, registered office Churchill House, Cambridge Business Park, Cowley Road, Cambridge, CB4 0WZ, United Kingdom

