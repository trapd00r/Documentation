From zsh-workers-return-20643-mason-zsh=primenet.com.au@sunsite.dk Mon Jan 03 16:32:31 2005
Return-Path: <zsh-workers-return-20643-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 27336 invoked from network); 3 Jan 2005 16:32:31 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 3 Jan 2005 16:32:31 -0000
Received: (qmail 99348 invoked from network); 3 Jan 2005 16:32:25 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 3 Jan 2005 16:32:25 -0000
Received: (qmail 10811 invoked by alias); 3 Jan 2005 16:32:10 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 20643
Received: (qmail 10792 invoked from network); 3 Jan 2005 16:32:09 -0000
Received: from unknown (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 3 Jan 2005 16:32:09 -0000
Received: (qmail 98692 invoked from network); 3 Jan 2005 16:31:34 -0000
Received: from moonbase.zanshin.com (64.84.47.139)
  by a.mx.sunsite.dk with SMTP; 3 Jan 2005 16:31:30 -0000
Received: from toltec.zanshin.com (toltec.zanshin.com [64.84.47.166])
	by moonbase.zanshin.com (8.13.1/8.13.1) with ESMTP id j03GVTCO020165
	for <zsh-workers@sunsite.dk>; Mon, 3 Jan 2005 08:31:29 -0800
Date: Mon, 3 Jan 2005 08:31:29 -0800 (PST)
From: Bart Schaefer <schaefer@brasslantern.com>
Reply-To: zsh-workers@sunsite.dk
To: zsh-workers@sunsite.dk
Subject: Re: bug in insert-last-word?
In-Reply-To: <20041221233815.GA26200@lorien.comfychair.org>
Message-ID: <Pine.LNX.4.61.0501030759230.32450@toltec.zanshin.com>
References: <20041221233815.GA26200@lorien.comfychair.org>
MIME-Version: 1.0
Content-Type: TEXT/PLAIN; charset=US-ASCII
X-Spam-Checker-Version: SpamAssassin 2.63 on a.mx.sunsite.dk
X-Spam-Level: 
X-Spam-Status: No, hits=0.0 required=6.0 tests=none autolearn=no version=2.63
X-Spam-Hits: 0.0

On Tue, 21 Dec 2004, Danek Duvall wrote:

> % echo "blah
> dquote>^C
> 
> Now insert-last-word will repeatedly add '"blah' to the line, rather than
> cycling through previous lines.

This is somewhat strange.

Start as above, then also type

% { echo frob
cursh>^C

Now invoke insert-last-word repeatedly.  You get

% frob
% "blah
% "blahfrob
% "blah"blah
% "blah"blahfrob
% "blah"blah"blah
% "blah"blah"blahfrob

etc.  So I think it has something to do with the unclosed quote rather 
than with insert-last-word itself.

Sure enough, after some time with gdb, I find:

Breakpoint 1, insertlastword (args=0x8146754)
    at ../../../zsh-4.0/Src/Zle/zle_hist.c:457
457         if (lastinsert && lastlen &&
(gdb) p lastinsert
$4 = 0x817c010 "\"blah"
(gdb) p lastlen
$5 = 6

Note that the last insertion recorded was 6 characters, but in fact only 5 
characters were actually inserted on the line, because the phantom 6th 
character was a NUL byte.  This confuses the subsequent insertlastword()
call, so it doesn't delete the previous insertion and doesn't search up to
the next history line.

The trouble lies with this pair of assignments:

	s = he->text + he->words[2*n-2];
	t = he->text + he->words[2*n-1];

When the quote is unclosed, t - s == 6 when it should count 5.

> I'm seeing this in 4.2.0 and 4.2.1, not 4.0.6.

Not surprising, as 4.0.6 doesn't have the previous history cycling 
behavior at all.  That was a 4.1.something addition.

