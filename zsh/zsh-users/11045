From zsh-users-return-11045-mason-zsh=primenet.com.au@sunsite.dk Mon Nov 27 18:55:49 2006
Return-Path: <zsh-users-return-11045-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 737 invoked from network); 27 Nov 2006 18:55:44 -0000
X-Spam-Checker-Version: SpamAssassin 3.1.7 (2006-10-05) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.4 required=5.0 tests=AWL,BAYES_00,
	FORGED_RCVD_HELO autolearn=ham version=3.1.7
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 27 Nov 2006 18:55:44 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 83002 invoked from network); 27 Nov 2006 18:55:35 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 27 Nov 2006 18:55:35 -0000
Received: (qmail 15562 invoked by alias); 27 Nov 2006 18:55:23 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 11045
Received: (qmail 15551 invoked from network); 27 Nov 2006 18:55:22 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 27 Nov 2006 18:55:22 -0000
Received: (qmail 81366 invoked from network); 27 Nov 2006 18:55:22 -0000
Received: from wr-out-0506.google.com (64.233.184.237)
  by a.mx.sunsite.dk with SMTP; 27 Nov 2006 18:55:19 -0000
Received: by wr-out-0506.google.com with SMTP id i28so240445wra
        for <zsh-users@sunsite.dk>; Mon, 27 Nov 2006 10:55:14 -0800 (PST)
DomainKey-Signature: a=rsa-sha1; q=dns; c=nofws;
        s=beta; d=gmail.com;
        h=received:message-id:date:from:sender:to:subject:in-reply-to:mime-version:content-type:content-transfer-encoding:content-disposition:references:x-google-sender-auth;
        b=uG3Q01bLsrCDn8ssFO3NV5dItOqIxdHbNi1mlSZ5qv5xDRzyf5uuO04QUKxezF1UkzT7QUWVHzbRazBETDdzkIculOfVK+xIr9cruE4PJ0d4wZIQ2rRfa+6SZBusC6TEgMTc0PdYdiemvg2eO9o+Bf2+EtWSHOfTDM8tDCoSYwM=
Received: by 10.90.27.6 with SMTP id a6mr10438624aga.1164653713821;
        Mon, 27 Nov 2006 10:55:13 -0800 (PST)
Received: by 10.90.65.18 with HTTP; Mon, 27 Nov 2006 10:55:13 -0800 (PST)
Message-ID: <dbfc82860611271055h36f43238uf6209c82c76f14ef@mail.gmail.com>
Date: Mon, 27 Nov 2006 19:55:13 +0100
From: "Nikolai Weibull" <now@bitwi.se>
Sender: nikolai.weibull@gmail.com
To: "zsh-users@sunsite.dk" <zsh-users@sunsite.dk>
Subject: Re: What was the reason for history -D not reporting runtimes?
In-Reply-To: <dbfc82860611240516w403e14fes7ef5a8d29148512c@mail.gmail.com>
MIME-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1; format=flowed
Content-Transfer-Encoding: 7bit
Content-Disposition: inline
References: <dbfc82860611240516w403e14fes7ef5a8d29148512c@mail.gmail.com>
X-Google-Sender-Auth: 4d6a8b73aa844fc6

On 11/24/06, Nikolai Weibull <now@bitwi.se> wrote:
> I have a vague memory of asking this question earlier, but I couldn't
> find it in any of the archives and not in my own mail-archive either,
> so here it goes (again, probably):
>
> Why does history -D not report times correctly, only giving 0:00?

Ah, I found the culprit.  I use Bart's version of preexec for setting
the title inside screen.  It seems that using the z expansion flag in
cmd=${(z)1}) messes up the time-tracking code somehow.

This is what I have

_set_title () {
  [[ $LOCKTITLE == 1 ]] && return
  case $TERM in
    (screen*)
      print -nR $'\ek'${1[1,18]}$'\e\\' ;;
  esac
  return 0
}

precmd () {
  _set_title zsh
}

preexec () {
  local -a cmd

  cmd=(${(z)1})
  case $cmd[1] in
    (fg)
      if (( $#cmd == 1 )); then
        cmd=(builtin jobs -l %+)
      else
        cmd=(builtin jobs -l ${(Q)cmd[2]})
      fi ;;
    (r)
      cmd=($(builtin history -n -1))
      _set_title $cmd[1]:t
      return ;;
    (%*)
      cmd=(builtin jobs -l ${(Q)cmd[1]}) ;;
    (exec)
      shift cmd ;&
    (*)
      _set_title $cmd[1]:t
      return ;;
  esac

  local -A jt

  jt=(${(kv)jobtexts})

  $cmd >>(read num rest
          cmd=(${(z)${(e):-\$jt$num}})
          _set_title $cmd[1]:t) 2>/dev/null
}

I'm unable to determine why this breaks.  If I substitute ${=1} for
the expansion, it still breaks as soon as it gets to printing in
_set_title.

  nikolai

