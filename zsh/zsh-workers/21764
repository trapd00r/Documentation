From zsh-workers-return-21764-mason-zsh=primenet.com.au@sunsite.dk Mon Sep 26 18:37:26 2005
Return-Path: <zsh-workers-return-21764-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 9575 invoked from network); 26 Sep 2005 18:37:23 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 26 Sep 2005 18:37:23 -0000
Received: (qmail 7042 invoked from network); 26 Sep 2005 18:37:13 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 26 Sep 2005 18:37:13 -0000
Received: (qmail 27483 invoked by alias); 26 Sep 2005 18:37:09 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 21764
Received: (qmail 27474 invoked from network); 26 Sep 2005 18:37:08 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 26 Sep 2005 18:37:08 -0000
Received: (qmail 6675 invoked from network); 26 Sep 2005 18:37:08 -0000
Received: from mailhost1.csr.com (HELO MAILSWEEPER01.csr.com) (81.105.217.43)
  by a.mx.sunsite.dk with SMTP; 26 Sep 2005 18:37:07 -0000
Received: from exchange03.csr.com (unverified [10.100.137.60]) by 
    MAILSWEEPER01.csr.com (Content Technologies SMTPRS 4.3.12) with ESMTP id 
    <T73a056cb170a6c8d012dc@MAILSWEEPER01.csr.com> for 
    <zsh-workers@sunsite.dk>; Mon, 26 Sep 2005 19:34:41 +0100
Received: from news01 ([10.103.143.38]) by exchange03.csr.com with Microsoft 
    SMTPSVC (5.0.2195.6713); Mon, 26 Sep 2005 19:38:54 +0100
Date: Mon, 26 Sep 2005 19:37:03 +0100
From: Peter Stephenson <pws@csr.com>
To: zsh-workers@sunsite.dk
Subject: Re: Regression in UTF-8 support
Message-Id: <20050926193703.6cc92722.pws@csr.com>
In-Reply-To: <200509252005.41824.arvidjaar@newmail.ru>
References: <200509252005.41824.arvidjaar@newmail.ru>
Organization: Cambridge Silicon Radio
X-Mailer: Sylpheed version 0.9.12 (GTK+ 1.2.10; i386-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset="us-ascii"
Content-Transfer-Encoding: 7bit
X-OriginalArrivalTime: 26 Sep 2005 18:38:54.0430 (UTC) 
    FILETIME=[8C148FE0:01C5C2C9]
X-Spam-Checker-Version: SpamAssassin 3.0.4 (2005-06-05) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=AWL,BAYES_00 autolearn=ham 
	version=3.0.4

Andrey Borzenkov <arvidjaar@newmail.ru> wrote:
> I did not really need Russian filenames until recently; with quite
> unexpected results. The following is in UTF; please compare file listing
> with completion listing (ignore obvious formatting error):
>...
> so something mangles characters (d184 -> d183, d18b -> d183 etc), moreover, 
> parsing stops at this character (d183)

I think this improves matters, but whether it's the whole thing I don't
know.  It's a simple interface issue.  I'm now less convinced I should have
let stringaszleline() operate in place.

Index: Src/Zle/zle_hist.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/zle_hist.c,v
retrieving revision 1.27
diff -u -r1.27 zle_hist.c
--- Src/Zle/zle_hist.c	15 Aug 2005 10:01:50 -0000	1.27
+++ Src/Zle/zle_hist.c	26 Sep 2005 18:34:59 -0000
@@ -75,6 +75,8 @@
 static void
 zletext(Histent ent, struct zle_text *zt)
 {
+    char *duptext;
+
     if (ent->zle_text) {
 	zt->text = ent->zle_text;
 	zt->len = ent->zle_len;
@@ -82,8 +84,10 @@
 	return;
     }
 
-    zt->text = stringaszleline((unsigned char *)ent->text, 0,
+    duptext = ztrdup(ent->text);
+    zt->text = stringaszleline((unsigned char *)duptext, 0,
 			       &zt->len, NULL, NULL);
+    zsfree(duptext);
     zt->alloced = 1;
 }
 


-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070


**********************************************************************
This email and any files transmitted with it are confidential and
intended solely for the use of the individual or entity to whom they
are addressed. If you have received this email in error please notify
the system manager.

**********************************************************************

