From zsh-workers-return-20760-mason-zsh=primenet.com.au@sunsite.dk Mon Jan 31 11:38:28 2005
Return-Path: <zsh-workers-return-20760-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 5192 invoked from network); 31 Jan 2005 11:38:27 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 31 Jan 2005 11:38:27 -0000
Received: (qmail 89992 invoked from network); 31 Jan 2005 11:38:21 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 31 Jan 2005 11:38:21 -0000
Received: (qmail 22583 invoked by alias); 31 Jan 2005 11:38:16 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 20760
Received: (qmail 22574 invoked from network); 31 Jan 2005 11:38:15 -0000
Received: from unknown (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 31 Jan 2005 11:38:15 -0000
Received: (qmail 89299 invoked from network); 31 Jan 2005 11:37:35 -0000
Received: from mailhost1.csr.com (HELO MAILSWEEPER01.csr.com) (81.105.217.43)
  by a.mx.sunsite.dk with SMTP; 31 Jan 2005 11:37:29 -0000
Received: from exchange03.csr.com (unverified [10.100.137.60]) by MAILSWEEPER01.csr.com
 (Content Technologies SMTPRS 4.3.12) with ESMTP id <T6ed4f714c60a6c8d018c4@MAILSWEEPER01.csr.com>;
 Mon, 31 Jan 2005 11:36:05 +0000
Received: from news01.csr.com ([10.103.143.38]) by exchange03.csr.com with Microsoft SMTPSVC(5.0.2195.6713);
	 Mon, 31 Jan 2005 11:37:25 +0000
Received: from news01.csr.com (localhost.localdomain [127.0.0.1])
	by news01.csr.com (8.13.1/8.12.11) with ESMTP id j0VBbP2V027047;
	Mon, 31 Jan 2005 11:37:26 GMT
Received: from csr.com (pws@localhost)
	by news01.csr.com (8.13.1/8.13.1/Submit) with ESMTP id j0VBbMkl027043;
	Mon, 31 Jan 2005 11:37:23 GMT
Message-Id: <200501311137.j0VBbMkl027043@news01.csr.com>
X-Authentication-Warning: news01.csr.com: pws owned process doing -bs
To: "Peter A. Castro" <doctor@fruitbat.org>, zsh-workers@sunsite.dk
Subject: Re: Patch for 4.2.3 building on Cygwin 
In-reply-to: <Pine.LNX.4.58.0501241602420.16726@ming.fruitbat.org> 
References: <29767.1081186817@csr.com> <Pine.LNX.4.53.0404051424500.11532@gremlin.fruitbat.org> <Pine.LNX.4.58.0501241602420.16726@ming.fruitbat.org>
Date: Mon, 31 Jan 2005 11:37:21 +0000
From: Peter Stephenson <pws@csr.com>
X-OriginalArrivalTime: 31 Jan 2005 11:37:25.0675 (UTC) FILETIME=[3C7E47B0:01C50789]
X-Spam-Checker-Version: SpamAssassin 3.0.2 on a.mx.sunsite.dk
X-Spam-Level: 
X-Spam-Status: No, score=-2.4 required=6.0 tests=AWL,BAYES_00 autolearn=ham 
	version=3.0.2
X-Spam-Hits: -2.4

"Peter A. Castro" wrote:
> Cygwin updates against zsh-4.2.3.  See attached diffs:

Thanks, we've already made some rearranagements and included a FIFO
patch with the same effect, so the following is the change against the
head of the main line.

Did you really mean to remove the test

AC_CHECK_LIB(iconv, iconv)

for all systems other than Cygwin?  As far as I can see if iconv really
is a separate library it will find the header, compile in the code, and
then fail to link.  However, I may be missing something.

Index: configure.ac
===================================================================
RCS file: /cvsroot/zsh/zsh/configure.ac,v
retrieving revision 1.24
diff -u -r1.24 configure.ac
--- configure.ac	27 Jan 2005 12:01:10 -0000	1.24
+++ configure.ac	31 Jan 2005 11:08:56 -0000
@@ -529,7 +529,7 @@
 		 locale.h errno.h stdio.h stdlib.h unistd.h sys/capability.h \
 		 utmp.h utmpx.h sys/types.h pwd.h grp.h poll.h sys/mman.h \
 		 netinet/in_systm.h pcre.h langinfo.h wchar.h stddef.h \
-		 sys/stropts.h)
+		 sys/stropts.h iconv.h)
 if test $dynamic = yes; then
   AC_CHECK_HEADERS(dlfcn.h)
   AC_CHECK_HEADERS(dl.h)
@@ -727,11 +727,17 @@
 
 AC_CHECK_LIB(socket, socket)
 
-AC_CHECK_LIB(iconv, iconv)
+dnl AC_CHECK_LIB(iconv, iconv)
+
+if test "$host_os" = cygwin; then
+dnl cygwin iconv() is really libiconv()
+AC_CHECK_LIB(iconv, libiconv)
+fi
 
 if test x$enable_pcre = xyes; then
 dnl pcre-config should probably be employed here
-AC_SEARCH_LIBS(pcre_compile, pcre)
+dnl AC_SEARCH_LIBS(pcre_compile, pcre)
+  LIBS="`pcre-config --libs` $LIBS"
 fi
 
 dnl ---------------------
Index: Src/system.h
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/system.h,v
retrieving revision 1.26
diff -u -r1.26 system.h
--- Src/system.h	26 Jan 2005 18:37:31 -0000	1.26
+++ Src/system.h	31 Jan 2005 11:08:56 -0000
@@ -700,7 +700,7 @@
 #else
 # ifdef HAVE_LANGINFO_H
 #   include <langinfo.h>
-#   if defined(HAVE_ICONV) || defined(HAVE_LIBICONV)
+#   if defined(HAVE_ICONV_H) || defined(HAVE_ICONV) || defined(HAVE_LIBICONV)
 #     include <iconv.h>
 #   endif
 # endif
Index: Src/utils.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/utils.c,v
retrieving revision 1.71
diff -u -r1.71 utils.c
--- Src/utils.c	14 Jan 2005 13:05:22 -0000	1.71
+++ Src/utils.c	31 Jan 2005 11:08:57 -0000
@@ -3510,7 +3510,7 @@
     size_t count;
 #else
     unsigned int wval;
-# if defined(HAVE_NL_LANGINFO) && defined(CODESET) && (defined(HAVE_ICONV) || defined(HAVE_LIBICONV))
+# if defined(HAVE_NL_LANGINFO) && defined(CODESET) && (defined(HAVE_ICONV_H) || defined(HAVE_ICONV) || defined(HAVE_LIBICONV))
     iconv_t cd;
     char inbuf[4];
     size_t inbytes, outbytes;
@@ -3631,7 +3631,7 @@
 		    t += ucs4toutf8(t, wval);
 		    continue;
 		} else {
-#   if defined(HAVE_ICONV) || defined(HAVE_LIBICONV)
+#   if defined(HAVE_ICONV_H) || defined(HAVE_ICONV) || defined(HAVE_LIBICONV)
     	    	    inbytes = 4;
 		    outbytes = 6;
     	    	    inptr = inbuf;

-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070


**********************************************************************
This email and any files transmitted with it are confidential and
intended solely for the use of the individual or entity to whom they
are addressed. If you have received this email in error please notify
the system manager.

This footnote also confirms that this email message has been swept by
MIMEsweeper for the presence of computer viruses.

www.mimesweeper.com
**********************************************************************

