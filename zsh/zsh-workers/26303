From zsh-workers-return-26303-mason-zsh=primenet.com.au@sunsite.dk Tue Jan 13 15:57:18 2009
Return-Path: <zsh-workers-return-26303-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 14815 invoked from network); 13 Jan 2009 15:57:06 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.3 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 13 Jan 2009 15:57:06 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 97319 invoked from network); 13 Jan 2009 15:57:00 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 13 Jan 2009 15:57:00 -0000
Received: (qmail 7081 invoked by alias); 13 Jan 2009 15:56:55 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 26303
Received: (qmail 7072 invoked from network); 13 Jan 2009 15:56:54 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 13 Jan 2009 15:56:54 -0000
Received: from cluster-d.mailcontrol.com (cluster-d.mailcontrol.com [85.115.60.190])
	by bifrost.dotsrc.org (Postfix) with ESMTPS id A05B980271F0
	for <zsh-workers@sunsite.dk>; Tue, 13 Jan 2009 16:56:51 +0100 (CET)
Received: from cameurexb01.EUROPE.ROOT.PRI ([193.128.72.68])
	by rly10d.srv.mailcontrol.com (MailControl) with ESMTP id n0DFtcMI014583
	for <zsh-workers@sunsite.dk>; Tue, 13 Jan 2009 15:56:47 GMT
Received: from news01.csr.com ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.3959);
	 Tue, 13 Jan 2009 15:49:53 +0000
Received: from news01.csr.com (localhost.localdomain [127.0.0.1])
	by news01.csr.com (8.14.2/8.13.4) with ESMTP id n0DFnmCp007094
	for <zsh-workers@sunsite.dk>; Tue, 13 Jan 2009 15:49:48 GMT
Received: from csr.com (pws@localhost)
	by news01.csr.com (8.14.2/8.14.2/Submit) with ESMTP id n0DFnl0I007089
	for <zsh-workers@sunsite.dk>; Tue, 13 Jan 2009 15:49:48 GMT
X-Authentication-Warning: news01.csr.com: pws owned process doing -bs
To: zsh-workers@sunsite.dk (Zsh hackers list)
Subject: Minor text attribute display issue
X-Mailer: MH-E 8.0.3; nmh 1.3; GNU Emacs 22.1.1
Date: Tue, 13 Jan 2009 15:49:47 +0000
Message-ID: <7088.1231861787@csr.com>
From: Peter Stephenson <pws@csr.com>
X-OriginalArrivalTime: 13 Jan 2009 15:49:53.0346 (UTC) FILETIME=[934AB220:01C97596]
X-Scanned-By: MailControl A_08_51_00 (www.mailcontrol.com) on 10.68.0.120
X-Virus-Scanned: ClamAV 0.92.1/8860/Tue Jan 13 16:28:02 2009 on bifrost
X-Virus-Status: Clean

With recent versions of rxvt, I've noticed that if I have text
attributes set for the area of text I'm editing, and delete some of that
text, causing spaces to be produced at the end of the line by the
deletion (even if there were some spaces there before), then the final
space gets the attribute of the current text.  This appears to turn that
off cleanly.

Index: Src/Zle/zle_refresh.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/zle_refresh.c,v
retrieving revision 1.73
diff -u -r1.73 zle_refresh.c
--- Src/Zle/zle_refresh.c	18 Nov 2008 10:14:35 -0000	1.73
+++ Src/Zle/zle_refresh.c	13 Jan 2009 15:47:19 -0000
@@ -1973,8 +1973,18 @@
 		   eg. oldline: hifoobar \ hopefully cheaper here to delete two
 		   newline: foobar	 / characters, then we have six matches */
 		if (tccan(TCDEL)) {
+		    int first = 1;
 		    for (i = 1; ol[i].chr; i++)
 			if (tcdelcost(i) < wpfxlen(ol + i, nl)) {
+			    /*
+			     * Some terminals will output the current
+			     * attributes into cells added at the end by
+			     * deletions, so turn off text attributes.
+			     */
+			    if (first) {
+				clearattributes();
+				first = 0;
+			    }
 			    tc_delchars(i);
 			    ol += i;
 			    char_ins -= i;
@@ -1984,15 +1994,6 @@
 				char_ins--;
 			    }
 #endif
-			    /*
-			     * If the sequence we're deleting ended
-			     * by turning off an attribute, make sure
-			     * it stays turned off.  I don't think we
-			     * should need this.
-			     */
-			    if (ol[-1].atr & TXT_ATTR_OFF_MASK)
-				settextattributes(ol[-1].atr &
-						  TXT_ATTR_OFF_MASK);
 			    i = 0;
 			    break;
 			}


-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070

