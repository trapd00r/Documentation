From zsh-workers-return-12610-mason-zsh=primenet.com.au@sunsite.auc.dk Mon Aug 14 08:15:52 2000
Return-Path: <zsh-workers-return-12610-mason-zsh=primenet.com.au@sunsite.auc.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 4001 invoked from network); 14 Aug 2000 08:15:45 -0000
Received: from sunsite.auc.dk (130.225.51.30)
  by ns1.primenet.com.au with SMTP; 14 Aug 2000 08:15:45 -0000
Received: (qmail 122 invoked by alias); 14 Aug 2000 08:15:09 -0000
Mailing-List: contact zsh-workers-help@sunsite.auc.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.auc.dk
X-Seq: 12610
Received: (qmail 115 invoked from network); 14 Aug 2000 08:15:09 -0000
Date: Mon, 14 Aug 2000 10:15:07 +0200 (MET DST)
Message-Id: <200008140815.KAA03363@beta.informatik.hu-berlin.de>
From: Sven Wischnowsky <wischnow@informatik.hu-berlin.de>
To: zsh-workers@sunsite.auc.dk
Subject: PATCH: security tests


Some builtins in computil didn't check if they were called from a
completion function. Tsk tsk tsk.

Bye
 Sven

Index: Src/Zle/computil.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/computil.c,v
retrieving revision 1.41
diff -u -r1.41 computil.c
--- Src/Zle/computil.c	2000/08/08 12:11:42	1.41
+++ Src/Zle/computil.c	2000/08/14 08:14:10
@@ -2587,6 +2587,10 @@
     struct value vbuf;
     Value v;
 
+    if (incompfunc != 1) {
+	zwarnnam(nam, "can only be called from completion function", NULL, 0);
+	return 1;
+    }
     /* Anything to do? */
 
     if (!compqstack || !*compqstack)
@@ -3547,6 +3551,10 @@
 static int
 bin_compfiles(char *nam, char **args, char *ops, int func)
 {
+    if (incompfunc != 1) {
+	zwarnnam(nam, "can only be called from completion function", NULL, 0);
+	return 1;
+    }
     if (**args != '-') {
 	zwarnnam(nam, "missing option: %s", *args, 0);
 	return 1;
@@ -3640,6 +3648,10 @@
     Heap oldheap;
     char *n;
 
+    if (incompfunc != 1) {
+	zwarnnam(nam, "can only be called from completion function", NULL, 0);
+	return 1;
+    }
     SWITCHHEAPS(oldheap, compheap) {
 	while ((n = *args++)) {
 	    endcmgroup(NULL);

--
Sven Wischnowsky                         wischnow@informatik.hu-berlin.de

