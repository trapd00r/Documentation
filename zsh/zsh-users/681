From zsh-workers-request@euclid.skiles.gatech.edu Fri Feb 14 08:19:21 1997
Return-Path: <zsh-workers-request@euclid.skiles.gatech.edu>
Delivered-To: mason@primenet.com.au
Received: (qmail 500 invoked from network); 14 Feb 1997 08:19:16 -0000
Received: from euclid.skiles.gatech.edu (list@130.207.146.50)
  by coral.primenet.com.au with SMTP; 14 Feb 1997 08:19:16 -0000
Received: (from list@localhost) by euclid.skiles.gatech.edu (8.7.3/8.7.3) id DAA09318; Fri, 14 Feb 1997 03:13:03 -0500 (EST)
Resent-Date: Fri, 14 Feb 1997 03:00:31 -0500 (EST)
From: "Bart Schaefer" <schaefer@candle.brasslantern.com>
Message-Id: <970214000748.ZM24379@candle.brasslantern.com>
Date: Fri, 14 Feb 1997 00:07:48 -0800
In-Reply-To: Steve Reid <steve@edmweb.com>
        "Re: history sharing between ttys" (Feb 13,  5:26pm)
References: <Pine.LNX.3.95q.970213165531.4182A-100000@bluesmoke>
Reply-To: schaefer@nbn.com
X-Mailer: Z-Mail (4.0b.820 20aug96)
To: Steve Reid <steve@edmweb.com>, zsh-users@math.gatech.edu
Subject: Re: history sharing between ttys
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Resent-Message-ID: <"QUYKV3.0.MC2.Vk11p"@euclid>
Resent-From: zsh-users@math.gatech.edu
X-Mailing-List: <zsh-users@math.gatech.edu> archive/latest/681
X-Loop: zsh-users@math.gatech.edu
X-Loop: zsh-workers@math.gatech.edu
Precedence: list
Resent-Sender: zsh-workers-request@math.gatech.edu

On Feb 13,  5:26pm, Steve Reid wrote:
} Subject: Re: history sharing between ttys
}
} > [...] set it up so that you
} > can share history between multiple ttys.  So if I typed a command in one
} > window, I could retrieve and execute it from another window.  
} 
} Something like this? Last time I tried it (zsh 3.0.2) it didn't work
} correctly... I was told that it was because of a bug in the new history
} code.
} 
} precmd() {
} 	fc -AI ~$USER/.history;	# Append latest commands
} 	fc -R ~$USER/.history;	# Read changes from all zsh's
} }                                         

This appears to work fine in zsh 3.0.3-test4 (although I have applied a
couple of other patches, I don't think any of them would affect this).

However, the behavior is a little strange, because you immediately read
back not only everything the other shell wrote, but also everything you
just wrote, which causes the event numbers to jump by large increments at
every command.  The following seems to work a bit better; the event number
jumps only when some other zsh has actually written the file:

    precmd() {
	if [[ ~/.history -nt ~/.history-$HOST-$$ ]]
	then
	    fc -AI ~/.history
	    fc -R ~/.history
	else
	    fc -AI ~/.history
	fi
	<~/.history >| ~/.history-$HOST-$$
    }

} Ideally, it should be possible to append the command to the history
} file immediately after the command is entered.

Write a zsh 3.1 module that fronts for the `accept-line' ZLE action ...

} Other running zsh's
} should detect the change and read it, so the user doesn't have to hit
} enter every time they switch ttys.

That's almost doable:	TMOUT=10 ; trap precmd ALRM

-- 
Bart Schaefer                             Brass Lantern Enterprises
http://www.well.com/user/barts            http://www.nbn.com/people/lantern

