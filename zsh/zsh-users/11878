From zsh-users-return-11878-mason-zsh=primenet.com.au@sunsite.dk Tue Sep 25 11:09:42 2007
Return-Path: <zsh-users-return-11878-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 11954 invoked from network); 25 Sep 2007 11:09:32 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.3 (2007-08-08) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=BAYES_00 autolearn=ham
	version=3.2.3
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 25 Sep 2007 11:09:32 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 13569 invoked from network); 25 Sep 2007 11:09:25 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 25 Sep 2007 11:09:25 -0000
Received: (qmail 17156 invoked by alias); 25 Sep 2007 11:09:17 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 11878
Received: (qmail 17143 invoked from network); 25 Sep 2007 11:09:17 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 25 Sep 2007 11:09:17 -0000
Received: (qmail 12409 invoked from network); 25 Sep 2007 11:09:17 -0000
Received: from smtp.ctxuk.citrix.com (HELO SMTP.EU.CITRIX.COM) (62.200.22.115)
  by a.mx.sunsite.dk with SMTP; 25 Sep 2007 11:09:14 -0000
X-IronPort-AV: E=Sophos;i="4.20,295,1186372800"; 
   d="scan'208";a="11056950"
Received: from lonpexchmx01.citrite.net ([10.30.224.191])
  by LONPIPO01.EU.CITRIX.COM with ESMTP; 25 Sep 2007 07:09:13 -0400
Received: from lonpexch01.citrite.net ([10.30.224.136]) by lonpexchmx01.citrite.net with Microsoft SMTPSVC(6.0.3790.1830);
	 Tue, 25 Sep 2007 12:08:20 +0100
X-MimeOLE: Produced By Microsoft Exchange V6.5
Content-class: urn:content-classes:message
MIME-Version: 1.0
Content-Type: text/plain;
	charset="iso-8859-1"
Content-Transfer-Encoding: quoted-printable
Subject: RE: Variable expansion problem
Date: Tue, 25 Sep 2007 12:08:20 +0100
Message-ID: <DD74FBB8EE28D441903D56487861CD9D1F554D07@lonpexch01.citrite.net>
In-Reply-To: <200709250901.l8P91LYU017875@news01.csr.com>
X-MS-Has-Attach: 
X-MS-TNEF-Correlator: 
Thread-Topic: Variable expansion problem
Thread-Index: Acf/UpiR8x35BTw1TvizaZ9ioYS2BQACt+lA
References: <DD74FBB8EE28D441903D56487861CD9D1F554D01@lonpexch01.citrite.net> <200709250901.l8P91LYU017875@news01.csr.com>
From: "John Cooper" <john.cooper@eu.citrix.com>
To: "Peter Stephenson" <pws@csr.com>,
	<zsh-users@sunsite.dk>
Cc: "John Cooper" <john.cooper@eu.citrix.com>
X-OriginalArrivalTime: 25 Sep 2007 11:08:20.0502 (UTC) FILETIME=[61BE4360:01C7FF64]

Thanks for the reply, although it doesn't seem to be working for me. I =
did the following:

1. Put your code snippet into a file named _expand_literal_param in a =
directory on my FPATH.
2. Added _expand_literal_param to my list of completers (which doesn't =
have an entry for _expand); my list is now: zstyle ':completion:*' =
completer _expand_literal_param _complete _correct _approximate
3. Set the following variable: IDENT=3D"$PF\Citrix\Web =
Interface\5.0.0\sitemgr.exe -arg foo"
4. Typed $IDENT<TAB>, which expanded to:
C:\\Program\ Files\ \(x86\)\\Citrix\\Web\ Interface\\5.0.0\\sitemgr.exe\ =
-arg\ foo

(the space between the 2 args is still quoted.). I suspect I'm doing =
something wrong!

I don't really understand the code, and I'm not sure what you mean by =
"only kicks in if the entire word matches $<paramname>.", as there is no =
<paramname> in the code - did you mean it kicks in when the entire param =
name matches "$IDENT"? Btw, what is the "P" referring to in ${(P)+val}?


I managed to get the effect working by defining the following alias =
(backslashes were awkward so I used `cygpath' to convert to unix-style =
paths):
  PFu=3D$(cygpath -u $PF)
  alias sss=3D"\\\"$PFu/Citrix/Web Interface/5.0.0/sitemgr.exe\\\" -arg =
foo"

It seemed unwieldy to invoke it by typing the following (I use Emacs key =
mappings)
  sssMeta-X _expa<TAB>a<TAB><RET>

.. so I've added _expand_alias to my list of completers (just before =
_complete), so sss now expands as I'd like when I type sss<TAB>. This is =
OK but now if I type d<TAB> it expands my alias for "d" rather than =
completing all commands starting with "d".

I think what I really want is to be able to type
  Prompt> $SITEMGR -c <TAB>
.. and have it complete to:
  Prompt> $SITEMGR -c =
"WIDest=3D1:/Citrix/AccessPlatform,Config=3DLocal,XMLService=3Dbeanstalk:=
80"

=A0=A0=A0 --- John.=20

-----Original Message-----
From: Peter Stephenson [mailto:pws@csr.com]=20
Sent: 25 September 2007 10:01
To: zsh-users@sunsite.dk
Subject: Re: Variable expansion problem

"John Cooper" wrote:
> I'd like to have a mechanism such that I can type $FOO<TAB> and have
> it expand to the following which I can then manually edit further:

So you need a literal expansion mechanism for parameters; the usual
mechanism does all forms of expansion and quotes the result.  Of course
there are other possible ways of achieving the effect, such as aliases
and _expand_alias (after the recent fix), but this answers the question
directly.

Rather than fiddle with the _expand completer, which is already trying
too hard to be all things to all users, it's probably better to have a
different one (call it _expand_literal_param, or something):


#autoload

# Expand a parameter literally (no quotation).  Only activates if the =
entire
# word matches a parameter name.

local val=3D"$IPREFIX$PREFIX$SUFFIX$ISUFFIX" expl
[[ $val =3D \$[[:IDENT:]]## ]] || return 1

val=3D$val[2,-1]
(( ${(P)+val} )) || return 1

_wanted parameters expl "literal parameter expansion" compadd -UQ =
"${(P)val}"


Note I've deliberately limited this so it only kicks in if the entire
word matches $<paramname>.  Put that in a function and put
_expand_literal_param in your list of completers immediately before the
existing _expand.  My list became:

zstyle ':completion:*' completer _oldlist _expand_literal_param _expand =
\
  _complete _ignored _approximate

--=20
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070


.

