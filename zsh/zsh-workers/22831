From zsh-workers-return-22831-mason-zsh=primenet.com.au@sunsite.dk Sat Oct 07 07:59:11 2006
Return-Path: <zsh-workers-return-22831-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 3833 invoked from network); 7 Oct 2006 07:59:10 -0000
X-Spam-Checker-Version: SpamAssassin 3.1.6 (2006-10-03) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=AWL,BAYES_00,
	FORGED_RCVD_HELO autolearn=ham version=3.1.6
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 7 Oct 2006 07:59:10 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 26229 invoked from network); 7 Oct 2006 07:59:03 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 7 Oct 2006 07:59:03 -0000
Received: (qmail 365 invoked by alias); 7 Oct 2006 07:58:47 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 22831
Received: (qmail 347 invoked from network); 7 Oct 2006 07:58:47 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 7 Oct 2006 07:58:46 -0000
Received: (qmail 25177 invoked from network); 7 Oct 2006 07:58:46 -0000
Received: from flock1.newmail.ru (80.68.241.157)
  by a.mx.sunsite.dk with SMTP; 7 Oct 2006 07:58:45 -0000
Received: (qmail 3589 invoked from network); 7 Oct 2006 07:58:40 -0000
Received: from unknown (HELO cooker.local) (arvidjaar@newmail.ru@83.237.106.22)
  by smtpd.newmail.ru with SMTP; 7 Oct 2006 07:58:40 -0000
From: Andrey Borzenkov <arvidjaar@newmail.ru>
To: zsh-workers@sunsite.dk
Subject: Re: PATCH: Re: Broken completion with UTF-8 description
Date: Sat, 7 Oct 2006 11:58:38 +0400
User-Agent: KMail/1.9.4
References: <200609171853.57050.arvidjaar@newmail.ru> <200609212104.23198.arvidjaar@newmail.ru> <200609211722.k8LHMOQ5008776@news01.csr.com>
In-Reply-To: <200609211722.k8LHMOQ5008776@news01.csr.com>
Content-Type: text/plain;
  charset="utf-8"
Content-Transfer-Encoding: 7bit
Content-Disposition: inline
Message-Id: <200610071158.38918.arvidjaar@newmail.ru>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On Thursday 21 September 2006 21:22, Peter Stephenson wrote:
> > +#define INTERMATCH_GAP 2
>
> Ah, I see you've found another undocumented magic number used without
> any indication.  I found a few of those.

well, it was documented just not consistently used everywhere.

Index: Src/Zle/comp.h
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/comp.h,v
retrieving revision 1.15
diff -u -p -r1.15 comp.h
- --- Src/Zle/comp.h	7 Mar 2006 12:52:28 -0000	1.15
+++ Src/Zle/comp.h	7 Oct 2006 07:57:13 -0000
@@ -407,3 +407,7 @@ struct chdata {
     Cmatch cur;			/* current match or NULL */
 };
 
+/* The number of columns to leave empty between rows of matches. */
+
+#define CM_SPACE  2
+
Index: Src/Zle/compresult.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/compresult.c,v
retrieving revision 1.67
diff -u -p -r1.67 compresult.c
- --- Src/Zle/compresult.c	6 Oct 2006 16:48:42 -0000	1.67
+++ Src/Zle/compresult.c	7 Oct 2006 07:57:14 -0000
@@ -30,10 +30,6 @@
 #include "complete.mdh"
 #include "compresult.pro"
 
- -/* The number of columns to leave empty between rows of matches. */
- -
- -#define CM_SPACE  2
- -
 /* This counts how often the list of completions was invalidated.
  * Can be used to detect if we have a new list.  */
 
Index: Src/Zle/computil.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/computil.c,v
retrieving revision 1.98
diff -u -p -r1.98 computil.c
- --- Src/Zle/computil.c	5 Oct 2006 21:53:27 -0000	1.98
+++ Src/Zle/computil.c	7 Oct 2006 07:57:15 -0000
@@ -33,13 +33,6 @@
 
 /* Help for `_describe'. */
 
- -/*
- - * FIXME this should be defined globally. I have to find other places
- - * where it is used
- - * */
- -
- -#define INTERMATCH_GAP 2
- -
 typedef struct cdset *Cdset;
 typedef struct cdstr *Cdstr;
 typedef struct cdrun *Cdrun;
@@ -161,7 +154,7 @@ cd_group(int maxg)
                 for (str2 = (set2 == set1 ? str1->next : set2->strs);
                      str2; str2 = str2->next)
                     if (str2->desc && !strcmp(str1->desc, str2->desc)) {
- -                        width += INTERMATCH_GAP + str2->width;
+                        width += CM_SPACE + str2->width;
                         if (width > cd_state.maxmlen || num == maxg)
                             break;
                         if (width > cd_state.maxglen)
@@ -276,7 +269,7 @@ cd_prep()
 
         cd_state.gprew = 0;
         for (i = 0; i < cd_state.maxg; i++) {
- -            cd_state.gprew += wids[i] + INTERMATCH_GAP;
+            cd_state.gprew += wids[i] + CM_SPACE;
 	}
 
         if (cd_state.gprew > cd_state.maxmlen && cd_state.maxglen > 1)
@@ -631,7 +624,7 @@ cd_get(char **params)
 		 *     max prefix length (cd_state.pre) +
 		 *     max padding (cd_state.premaxw generously :) +
 		 *     separator length (cd_state.slen) +
- -		 *     inter matches gap (INTERMATCH_GAP) +
+		 *     inter matches gap (CM_SPACE) +
 		 *     max description length (cd_state.suf) +
 		 *     trailing \0
 		 */
@@ -648,7 +641,7 @@ cd_get(char **params)
                     *mp++ = ztrdup(str->match);
 		    strcpy(p, str->str);
 		    p += str->len;
- -                    memset(p, ' ', (l = (cd_state.premaxw - str->width + 
INTERMATCH_GAP)));
+                    memset(p, ' ', (l = (cd_state.premaxw - str->width + 
CM_SPACE)));
 		    p += l;
 		    strcpy(p, cd_state.sep);
 		    p += cd_state.slen;
@@ -750,7 +743,7 @@ cd_get(char **params)
                     }
 
                     strcpy(dbuf, cd_state.sep);
- -		    remw = columns - cd_state.gprew - cd_state.swidth - INTERMATCH_GAP;
+		    remw = columns - cd_state.gprew - cd_state.swidth - CM_SPACE;
 		    p = pp = dbuf + cd_state.slen;
 		    d = str->desc;
 		    w = MB_METASTRWIDTH(d);

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.5 (GNU/Linux)

iD8DBQFFJ14uR6LMutpd94wRAg2sAJ0UEGWlS8a71UgyyrvsLymk9bMdEwCeOsUD
HOonqPkgXe2cAo/JfTaxXNI=
=mk3C
-----END PGP SIGNATURE-----

