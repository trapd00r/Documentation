From zsh-users-return-14967-mason-zsh=primenet.com.au@zsh.org Wed Mar 24 16:20:37 2010
Return-Path: <zsh-users-return-14967-mason-zsh=primenet.com.au@zsh.org>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 2953 invoked by alias); 24 Mar 2010 16:20:37 -0000
Mailing-List: contact zsh-users-help@zsh.org; run by ezmlm
Precedence: bulk
X-No-Archive: yes
List-Id: Zsh Users List <zsh-users.zsh.org>
List-Post: <mailto:zsh-users@zsh.org>
List-Help: <mailto:zsh-users-help@zsh.org>
Delivered-To: mailing list zsh-users@zsh.org
X-Seq: 14967
Received: (qmail 643 invoked from network); 24 Mar 2010 16:20:36 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received-SPF: none (ns1.primenet.com.au: domain at closedmail.com does not designate permitted sender hosts)
From: Bart Schaefer <schaefer@brasslantern.com>
Message-id: <100324091951.ZM25340@torch.brasslantern.com>
Date: Wed, 24 Mar 2010 09:19:49 -0700
In-reply-to: <20100324102732.GA23038@fermat.math.technion.ac.il>
Comments: In reply to "Nadav Har'El" <nyh@math.technion.ac.il>
 "Re: Append cancelled commands to history" (Mar 24, 12:27pm)
References: <c16a574a0809181450t61a5b5ddq2e80797fde37636e@mail.gmail.com>
	<20080919162045.GA22435@ruderich.org>
	<20090706151644.6BF508027106@bifrost.dotsrc.org>
	<20090706154309.GA15663@fermat.math.technion.ac.il>
	<20090706155337.GB15663@fermat.math.technion.ac.il>
	<20100315164237.GA23224@fermat.math.technion.ac.il>
	<100320105027.ZM20067@torch.brasslantern.com>
	<20100322084226.GA26739@fermat.math.technion.ac.il>
	<100322080712.ZM21793@torch.brasslantern.com>
	<20100324102732.GA23038@fermat.math.technion.ac.il>
X-Mailer: OpenZMail Classic (0.9.2 24April2005)
To: zsh-users@zsh.org
Subject: Re: Append cancelled commands to history
MIME-version: 1.0
Content-type: text/plain; charset=us-ascii

On Mar 24, 12:27pm, Nadav Har'El wrote:
}
} Anyway, I tried what you wrote, and it didn't work because it appears the
} zshaddhistory hook does not get called when I interrupt the ZLE.

Ah.  That makes sense.  I was assuming it didn't work for me because
of the $PREBUFFER-is-empty problem (for which a patch has since been
posted on zsh-workers).

} So apparently, that interrupted multiline editing is *not* in the
} history, and never was. So where is it? Why do I see it when I go "up"
} for the first time? How do I prevent this?

Oh, of course.  Zsh *always* makes the immediately preceding accepted
input available for scrollback in the line editor, even if it was not
put into the history (because of HIST_IGNORE_ALL_DUPS, HIST_NO_STORE,
or HIST_IGNORE_SPACE, etc.).

There is no way to prevent this.

You could, however, stop using the interrupt signal and its trap, and
instead re-bind ctrl-C (or whatever your interrupt key is) to a zle
function that, whenever $PREBUFER is non-empty, does a no-op equivalent
of accept-line followed by a send-break.

    typeset -gi INTR_PRESSED=0

    finish_simulated_interrupt() {
      if (( INTR_PRESSED ))
      then
	INTR_PRESSED=0
	return 1
      else
	return 0
      fi
    }
    add-zsh-hook preexec finish_simulated_interrupt

    simulate-interrupt() {
      if [[ -n $PREBUFFER ]]
      then
	INTR_PRESSED=1
	zle -U $'\a'	# Replace with your send-break keystroke
	zle accept-line
      else
	zle send-break
      fi
    }
    zle -N simulate-interrupt

Rebinding keys to call simulate-interrupt instead of sending a real
terminal driver interrupt, is left as an exercise.

-- 

