From zsh-workers-return-26075-mason-zsh=primenet.com.au@sunsite.dk Thu Nov 20 16:53:23 2008
Return-Path: <zsh-workers-return-26075-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 9497 invoked from network); 20 Nov 2008 16:53:09 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.3 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 20 Nov 2008 16:53:09 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 87158 invoked from network); 20 Nov 2008 16:53:04 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 20 Nov 2008 16:53:04 -0000
Received: (qmail 25583 invoked by alias); 20 Nov 2008 16:52:58 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 26075
Received: (qmail 25568 invoked from network); 20 Nov 2008 16:52:57 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 20 Nov 2008 16:52:57 -0000
Received: from cluster-g.mailcontrol.com (cluster-g.mailcontrol.com [208.87.233.190])
	by bifrost.dotsrc.org (Postfix) with ESMTPS id CC18580525B4
	for <zsh-workers@sunsite.dk>; Thu, 20 Nov 2008 17:52:54 +0100 (CET)
Received: from cameurexb01.EUROPE.ROOT.PRI ([193.128.72.68])
	by rly21g.srv.mailcontrol.com (MailControl) with ESMTP id mAKGqk8N009981
	for <zsh-workers@sunsite.dk>; Thu, 20 Nov 2008 16:52:48 GMT
Received: from news01.csr.com ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.3959);
	 Thu, 20 Nov 2008 16:52:47 +0000
Received: from news01.csr.com (localhost.localdomain [127.0.0.1])
	by news01.csr.com (8.14.2/8.13.4) with ESMTP id mAKGqlio002866
	for <zsh-workers@sunsite.dk>; Thu, 20 Nov 2008 16:52:47 GMT
Received: from csr.com (pws@localhost)
	by news01.csr.com (8.14.2/8.14.2/Submit) with ESMTP id mAKGqlnv002862
	for <zsh-workers@sunsite.dk>; Thu, 20 Nov 2008 16:52:47 GMT
X-Authentication-Warning: news01.csr.com: pws owned process doing -bs
To: zsh-workers@sunsite.dk (Zsh hackers list)
Subject: PATCH: calendar: repeated events from ages ago
X-Mailer: MH-E 8.0.3; nmh 1.3; GNU Emacs 22.1.1
Date: Thu, 20 Nov 2008 16:52:47 +0000
Message-ID: <2861.1227199967@csr.com>
From: Peter Stephenson <pws@csr.com>
X-OriginalArrivalTime: 20 Nov 2008 16:52:47.0438 (UTC) FILETIME=[6A84EEE0:01C94B30]
X-Scanned-By: MailControl A_08_51_00 (www.mailcontrol.com) on 10.71.0.131
X-Virus-Scanned: ClamAV 0.92.1/8653/Thu Nov 20 10:04:07 2008 on bifrost
X-Virus-Status: Clean

Now that I've noticed this is lying around...

Repeated events in calendar entries (RPT keyword) are always updated
precisely once, not until they are in the future.  This fixes that, but
it does it the obvious way so if you're repeating events started a
really long time ago this will take a while.

Lightly tested but unlikely to be further tested until it fails horribly.

Index: Functions/Calendar/calendar_parse
===================================================================
RCS file: /cvsroot/zsh/zsh/Functions/Calendar/calendar_parse,v
retrieving revision 1.1
diff -u -r1.1 calendar_parse
--- Functions/Calendar/calendar_parse	29 Nov 2007 09:49:43 -0000	1.1
+++ Functions/Calendar/calendar_parse	20 Nov 2008 16:49:36 -0000
@@ -28,6 +28,7 @@
 
 local REPLY REPLY2
 local -a match mbegin mend
+integer now
 
 autoload -U calendar_scandate
 
@@ -70,6 +71,17 @@
       reply[rpttime]=$REPLY
       reply[rptstr]=${match[2]%%"$REPLY2"}
       reply[text2]="${match[1]}${REPLY2##[[:space:]]#}"
+      (( now = EPOCHSECONDS ))
+      while (( ${reply[rpttime]} < now )); do
+	# let's hope the original appointment wasn't in 44 B.C.
+	if calendar_scandate -a -R ${reply[rpttime]} ${reply[rptstr]}; then
+	  if (( REPLY <= ${reply[rpttime]} )); then
+	    # pathological case
+	    break;
+	  fi
+	  reply[rpttime]=$REPLY
+	fi
+      done
     else
       # Just remove the keyword for further parsing
       reply[text2]="${match[1]}${match[2]##[[:space:]]#}"


-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070

