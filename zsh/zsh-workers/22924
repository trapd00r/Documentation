From zsh-workers-return-22924-mason-zsh=primenet.com.au@sunsite.dk Mon Oct 30 14:07:12 2006
Return-Path: <zsh-workers-return-22924-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 20976 invoked from network); 30 Oct 2006 14:07:05 -0000
X-Spam-Checker-Version: SpamAssassin 3.1.7 (2006-10-05) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.3 required=5.0 tests=AWL,BAYES_00,
	DATE_IN_PAST_48_96,FORGED_RCVD_HELO autolearn=no version=3.1.7
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 30 Oct 2006 14:07:05 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 16700 invoked from network); 30 Oct 2006 14:06:59 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 30 Oct 2006 14:06:59 -0000
Received: (qmail 5964 invoked by alias); 30 Oct 2006 14:06:52 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 22924
Received: (qmail 5951 invoked from network); 30 Oct 2006 14:06:50 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 30 Oct 2006 14:06:50 -0000
Received: (qmail 15691 invoked from network); 30 Oct 2006 14:06:50 -0000
Received: from cluster-d.mailcontrol.com (217.69.20.190)
  by a.mx.sunsite.dk with SMTP; 30 Oct 2006 14:06:44 -0000
Received: from cameurexb01.EUROPE.ROOT.PRI ([62.189.241.200])
	by rly18d.srv.mailcontrol.com (MailControl) with ESMTP id k9UE6XCu000883
	for <zsh-workers@sunsite.dk>; Mon, 30 Oct 2006 14:06:34 GMT
Received: from news01.csr.com ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.1830);
	 Mon, 30 Oct 2006 14:06:32 +0000
Date: Fri, 27 Oct 2006 14:06:19 +0100
From: Peter Stephenson <pws@csr.com>
To: zsh <zsh-workers@sunsite.dk>
Subject: Re: segmentation fault in menu selection
Message-Id: <20061027140619.ad9642ee.pws@csr.com>
In-Reply-To: <8839f0c90610240754o24a76571ie5911d7ebfc2c950@mail.gmail.com>
References: <8839f0c90610240754o24a76571ie5911d7ebfc2c950@mail.gmail.com>
Organization: Cambridge Silicon Radio
X-Mailer: Sylpheed version 2.2.9 (GTK+ 2.8.20; i386-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
X-OriginalArrivalTime: 30 Oct 2006 14:06:32.0902 (UTC) FILETIME=[9A978660:01C6FC2C]
X-Scanned-By: MailControl A-07-06-70 (www.mailcontrol.com) on 10.68.0.128

Toma <tomushkin@gmail.com> wrote:
> I have some examples which causes zsh to receive a SIGSEGV, all
> related to the menu-select widget. I can reproduce them on zsh 4.3.1
> or newer, including the latest CVS (zsh 4.2.6 works fine).

Thanks for reporting these... as I was looking at a similar bug
I stopped by to look at these two.  They are yet another two different
varieties of the problem.  There may well be even more.

Index: Src/Zle/complist.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/complist.c,v
retrieving revision 1.96
diff -u -r1.96 complist.c
--- Src/Zle/complist.c	21 Sep 2006 16:36:53 -0000	1.96
+++ Src/Zle/complist.c	30 Oct 2006 14:03:18 -0000
@@ -2295,6 +2295,8 @@
     mlbeg = 0;
     molbeg = -42;
     for (;;) {
+	METACHECK();
+
     	mtab_been_reallocated = 0;
 	if (mline < 0) {
 	    int x, y;
Index: Src/Zle/compresult.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/compresult.c,v
retrieving revision 1.69
diff -u -r1.69 compresult.c
--- Src/Zle/compresult.c	30 Oct 2006 12:57:52 -0000	1.69
+++ Src/Zle/compresult.c	30 Oct 2006 14:03:18 -0000
@@ -1225,6 +1225,8 @@
 int
 reverse_menu(UNUSED(Hookdef dummy), UNUSED(void *dummy2))
 {
+    int was_meta;
+
     do {
 	if (minfo.cur == (minfo.group)->matches) {
 	    do {
@@ -1239,9 +1241,16 @@
 	     ((*minfo.cur)->flags & CMF_DUMMY) ||
 	     (((*minfo.cur)->flags & (CMF_NOLIST | CMF_MULT)) &&
 	      (!(*minfo.cur)->str || !*(*minfo.cur)->str)));
-    metafy_line();
+    /* May already be metafied if called from within a selection */
+    if (zlemetaline == NULL) {
+	metafy_line();
+	was_meta = 0;
+    }
+    else
+	was_meta = 1;
     do_single(*(minfo.cur));
-    unmetafy_line();
+    if (!was_meta)
+	unmetafy_line();
 
     return 0;
 }
Index: Src/Zle/zle_main.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/zle_main.c,v
retrieving revision 1.92
diff -u -r1.92 zle_main.c
--- Src/Zle/zle_main.c	23 Sep 2006 20:25:06 -0000	1.92
+++ Src/Zle/zle_main.c	30 Oct 2006 14:03:18 -0000
@@ -996,6 +996,7 @@
      * that explicitly.
      */
     while (!done && !errflag && !exit_pending) {
+	UNMETACHECK();
 
 	statusline = NULL;
 	vilinerange = 0;
Index: Src/Zle/zle_utils.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/zle_utils.c,v
retrieving revision 1.40
diff -u -r1.40 zle_utils.c
--- Src/Zle/zle_utils.c	16 Oct 2006 01:09:22 -0000	1.40
+++ Src/Zle/zle_utils.c	30 Oct 2006 14:03:19 -0000
@@ -943,25 +943,25 @@
 	remetafy = 0;
 
     mkundoent();
-    if(!nextchanges)
-	return;
-    setlastline();
-    if(curchange->next) {
-	freechanges(curchange->next);
-	curchange->next = NULL;
-	free(curchange->del);
-	free(curchange->ins);
-	curchange->del = curchange->ins = NULL;
-	curchange->dell = curchange->insl = 0;
-    }
-    nextchanges->prev = curchange->prev;
-    if(curchange->prev)
-	curchange->prev->next = nextchanges;
-    else
-	changes = nextchanges;
-    curchange->prev = endnextchanges;
-    endnextchanges->next = curchange;
-    nextchanges = endnextchanges = NULL;
+    if(nextchanges) {
+	setlastline();
+	if(curchange->next) {
+	    freechanges(curchange->next);
+	    curchange->next = NULL;
+	    free(curchange->del);
+	    free(curchange->ins);
+	    curchange->del = curchange->ins = NULL;
+	    curchange->dell = curchange->insl = 0;
+	}
+	nextchanges->prev = curchange->prev;
+	if(curchange->prev)
+	    curchange->prev->next = nextchanges;
+	else
+	    changes = nextchanges;
+	curchange->prev = endnextchanges;
+	endnextchanges->next = curchange;
+	nextchanges = endnextchanges = NULL;
+    }
 
     if (remetafy)
 	metafy_line();




-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070


To access the latest news from CSR copy this link into a web browser:  http://www.csr.com/email_sig.php

