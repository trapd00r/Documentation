From zsh-workers-return-23122-mason-zsh=primenet.com.au@sunsite.dk Mon Jan 22 17:07:43 2007
Return-Path: <zsh-workers-return-23122-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 10463 invoked from network); 22 Jan 2007 17:07:38 -0000
X-Spam-Checker-Version: SpamAssassin 3.1.7 (2006-10-05) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.4 required=5.0 tests=AWL,BAYES_00,
	FORGED_RCVD_HELO autolearn=ham version=3.1.7
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 22 Jan 2007 17:07:38 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 92114 invoked from network); 22 Jan 2007 17:07:32 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 22 Jan 2007 17:07:32 -0000
Received: (qmail 3807 invoked by alias); 22 Jan 2007 17:07:28 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 23122
Received: (qmail 3798 invoked from network); 22 Jan 2007 17:07:27 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 22 Jan 2007 17:07:27 -0000
Received: (qmail 91756 invoked from network); 22 Jan 2007 17:07:27 -0000
Received: from cluster-c.mailcontrol.com (168.143.177.190)
  by a.mx.sunsite.dk with SMTP; 22 Jan 2007 17:07:21 -0000
Received: from cameurexb01.EUROPE.ROOT.PRI ([62.189.241.200])
	by rly27c.srv.mailcontrol.com (MailControl) with ESMTP id l0MH2a8j012203
	for <zsh-workers@sunsite.dk>; Mon, 22 Jan 2007 17:07:13 GMT
Received: from news01.csr.com ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.1830);
	 Mon, 22 Jan 2007 17:03:04 +0000
Date: Mon, 22 Jan 2007 17:03:01 +0000
From: Peter Stephenson <pws@csr.com>
To: zsh-workers@sunsite.dk (Zsh hackers list)
Subject: Re: PATCH: sorting
Message-Id: <20070122170301.6f6a6419.pws@csr.com>
In-Reply-To: <200701212239.l0LMdbEE015773@pwslaptop.csr.com>
References: <200701212239.l0LMdbEE015773@pwslaptop.csr.com>
Organization: Cambridge Silicon Radio
X-Mailer: Sylpheed version 2.2.10 (GTK+ 2.10.4; i386-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
X-OriginalArrivalTime: 22 Jan 2007 17:03:04.0800 (UTC) FILETIME=[2E8DE600:01C73E47]
X-Scanned-By: MailControl A-07-06-80 (www.mailcontrol.com) on 10.67.0.137

Bad handling of embedded nulls where one of the nulls was really the end of
the string.  This depended on what data was off the end of the string, so
caused unpredictable errors.

Index: Src/sort.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/sort.c,v
retrieving revision 1.2
diff -u -r1.2 sort.c
--- Src/sort.c	22 Jan 2007 14:35:13 -0000	1.2
+++ Src/sort.c	22 Jan 2007 17:00:43 -0000
@@ -68,9 +68,17 @@
 	else
 	    len = be->len;
 
-	for (cmpa = as, cmpb = bs; *cmpa == *cmpb && len--; cmpa++, cmpb++)
-	    if (!*cmpa)
+	for (cmpa = as, cmpb = bs; *cmpa == *cmpb && len--; cmpa++, cmpb++) {
+	    if (!*cmpa) {
+		/*
+		 * If either string doesn't have a length, we've reached
+		 * the end.  This is covered in the test below.
+		 */
+		if (ae->len == -1 || be->len == -1)
+		    break;
 		laststarta = cmpa + 1;
+	    }
+	}
 	if (*cmpa == *cmpb && ae->len != be->len) {
 	    /*
 	     * Special case: one of the strings has finished, but
@@ -136,7 +144,7 @@
 #ifndef HAVE_STRCOLL
     else
 	cmp = strcmp(as, bs);
-#endif	
+#endif
 
     return sortdir * cmp;
 }
@@ -351,8 +359,7 @@
 	}
     }
     /*
-     * We need to restore sortdir so that calls to
-     * [n]strcmp work when 
+     * We probably don't need to restore the following, but it's pretty cheap.
      */
     oldsortdir = sortdir;
     oldsortnumeric = sortnumeric;



To access the latest news from CSR copy this link into a web browser:  http://www.csr.com/email_sig.php

To get further information regarding CSR, please visit our Investor Relations page at http://ir.csr.com/csr/about/overview

