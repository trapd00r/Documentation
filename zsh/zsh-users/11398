From zsh-users-return-11398-mason-zsh=primenet.com.au@sunsite.dk Sun Apr 15 19:38:17 2007
Return-Path: <zsh-users-return-11398-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 10546 invoked from network); 15 Apr 2007 19:38:15 -0000
X-Spam-Checker-Version: SpamAssassin 3.1.8 (2007-02-13) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=BAYES_00,FORGED_RCVD_HELO
	autolearn=ham version=3.1.8
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 15 Apr 2007 19:38:15 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 38819 invoked from network); 15 Apr 2007 19:38:09 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 15 Apr 2007 19:38:09 -0000
Received: (qmail 7177 invoked by alias); 15 Apr 2007 19:37:53 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 11398
Received: (qmail 7165 invoked from network); 15 Apr 2007 19:37:51 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 15 Apr 2007 19:37:51 -0000
Received: (qmail 37448 invoked from network); 15 Apr 2007 19:37:51 -0000
Received: from mtaout02-winn.ispmail.ntl.com (81.103.221.48)
  by a.mx.sunsite.dk with SMTP; 15 Apr 2007 19:37:48 -0000
Received: from aamtaout03-winn.ispmail.ntl.com ([81.103.221.35])
          by mtaout02-winn.ispmail.ntl.com with ESMTP
          id <20070415193759.PYPD19810.mtaout02-winn.ispmail.ntl.com@aamtaout03-winn.ispmail.ntl.com>
          for <zsh-users@sunsite.dk>; Sun, 15 Apr 2007 20:37:59 +0100
Received: from pwslaptop.csr.com ([81.107.41.251])
          by aamtaout03-winn.ispmail.ntl.com with ESMTP
          id <20070415193814.GGQQ26699.aamtaout03-winn.ispmail.ntl.com@pwslaptop.csr.com>
          for <zsh-users@sunsite.dk>; Sun, 15 Apr 2007 20:38:14 +0100
Received: from pwslaptop.csr.com (pwslaptop.csr.com [127.0.0.1])
	by pwslaptop.csr.com (8.13.8/8.13.7) with ESMTP id l3FJrjRg003045
	for <zsh-users@sunsite.dk>; Sun, 15 Apr 2007 20:53:47 +0100
Message-Id: <200704151953.l3FJrjRg003045@pwslaptop.csr.com>
From: Peter Stephenson <p.w.stephenson@ntlworld.com>
To: "Zsh users list" <zsh-users@sunsite.dk>
Subject: Re: Problems with vi-goto-mark and vi-set-mark 
In-Reply-To: Message from "Felix Rosencrantz" <f.rosencrantz@gmail.com> 
   of "Sun, 15 Apr 2007 09:49:15 PDT." <dc507f4a0704150949p39a6fd4bleb56f7d7c00cd1e9@mail.gmail.com> 
Date: Sun, 15 Apr 2007 20:53:45 +0100

"Felix Rosencrantz" wrote:
> I've recently been trying to use viins/vicmd mode.  I've hit a small
> problem with the vi-set-mark and vi-goto-mark, they seem to be broken
> in the latest version of zsh.  Though it looks like it was working in
> 4.2.5.

Yes, I don't use vi mode so don't notice this sort of thing.  We could
do with someone writing interactive tests for zle commands.  We could
also do with someone to look after vi mode.  We could do with people
doing a lot of things.

The change is that getchar() used not to set the last character, which
was done at a higher level, but the replacements which support multibyte
do (even if multibyte mode isn't compiled in).  This means the character
read is always treated as if it was the same as the last character.

I think the following fixes it, but I'm not sure what the feature is in
vi-goto-mark that has the special behaviour if the last character is
repeated.  If you know and can test it, please do.

Index: Src/Zle/zle.h
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/zle.h,v
retrieving revision 1.34
diff -u -r1.34 zle.h
--- Src/Zle/zle.h	3 Dec 2006 21:07:18 -0000	1.34
+++ Src/Zle/zle.h	15 Apr 2007 19:22:16 -0000
@@ -72,6 +72,7 @@
 #define ZC_toupper towupper
 
 #define LASTFULLCHAR	lastchar_wide
+#define LASTFULLCHAR_T  ZLE_INT_T
 
 #else  /* Not MULTIBYTE_SUPPORT: old single-byte code */
 
@@ -130,6 +131,7 @@
 #define ZC_toupper tuupper
 
 #define LASTFULLCHAR	lastchar
+#define LASTFULLCHAR_T	int
 
 #endif
 
Index: Src/Zle/zle_move.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/zle_move.c,v
retrieving revision 1.8
diff -u -r1.8 zle_move.c
--- Src/Zle/zle_move.c	1 Nov 2005 02:50:29 -0000	1.8
+++ Src/Zle/zle_move.c	15 Apr 2007 19:22:16 -0000
@@ -484,9 +484,10 @@
 vigotomark(UNUSED(char **args))
 {
     ZLE_INT_T ch;
+    LASTFULLCHAR_T lfc = LASTFULLCHAR;
 
     ch = getfullchar(0);
-    if (ch == LASTFULLCHAR)
+    if (ch == lfc)
 	ch = 26;
     else {
 	if (ch < ZWC('a') || ch > ZWC('z'))

-- 
Peter Stephenson <p.w.stephenson@ntlworld.com>
Web page now at http://homepage.ntlworld.com/p.w.stephenson/

