From zsh-workers-return-18938-mason-zsh=primenet.com.au@sunsite.dk Thu Aug 07 16:45:23 2003
Return-Path: <zsh-workers-return-18938-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 24242 invoked from network); 7 Aug 2003 16:45:23 -0000
Received: from sunsite.dk (130.225.247.90)
  by ns1.primenet.com.au with SMTP; 7 Aug 2003 16:45:23 -0000
Received: (qmail 1445 invoked by alias); 7 Aug 2003 16:45:15 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 18938
Received: (qmail 1433 invoked from network); 7 Aug 2003 16:45:15 -0000
Received: from localhost (HELO sunsite.dk) (127.0.0.1)
  by localhost with SMTP; 7 Aug 2003 16:45:15 -0000
X-MessageWall-Score: 0 (sunsite.dk)
Received: from [62.189.183.235] by sunsite.dk (MessageWall 1.0.8) with SMTP; 7 Aug 2003 16:45:14 -0000
Received: from EXCHANGE02.csr.com (unverified) by MAILSWEEPER01.cambridgesiliconradio.com
 (Content Technologies SMTPRS 4.3.10) with ESMTP id <T63e9eb3104c0a88d014c4@MAILSWEEPER01.cambridgesiliconradio.com> for <zsh-workers@sunsite.dk>;
 Thu, 7 Aug 2003 17:44:27 +0100
Received: from csr.com ([192.168.144.127]) by EXCHANGE02.csr.com with Microsoft SMTPSVC(5.0.2195.5329);
	 Thu, 7 Aug 2003 17:46:40 +0100
To: zsh-workers@sunsite.dk (Zsh hackers list)
Subject: PATCH: Cygwin compilation
Date: Thu, 07 Aug 2003 17:45:11 +0100
Message-ID: <24406.1060274711@csr.com>
From: Peter Stephenson <pws@csr.com>
X-OriginalArrivalTime: 07 Aug 2003 16:46:40.0291 (UTC) FILETIME=[7999BF30:01C35D03]

This fixes up some exported data symbols to stop dllwrap complaining
that it had to work it out for itself, although it got them right.

One case where the version of dllwrap I have (2.13.90) didn't get it
right is that when it linked modules against zsh.dll it somehow missed
the last function symbol in alphabetic order, in this case zwarnnam, and
thought it had to import that as a data symbol, with catastrophic
results.  I confirmed this by adding a dummy exported function
zz_plural_z_alpha, which fixed the problem.  Has anyone else encountered
this?  Maybe Christopher is lurking.

One exported data symbol I haven't fixed up is the carefully named
global variable `c' in zle_main.c.  Apparently this needs to be exported
so that complist.c can see it (in msearch(), not to be confused with a
zillion other uses of the variable name `c' in that file).  I haven't
fixed this because I'm desperately hoping for someone to tell me it's
not true.

Index: Src/lex.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/lex.c,v
retrieving revision 1.25
diff -u -r1.25 lex.c
--- Src/lex.c	17 Jul 2003 09:44:39 -0000	1.25
+++ Src/lex.c	7 Aug 2003 16:37:20 -0000
@@ -44,7 +44,7 @@
 /**/
 mod_export int tok;
 /**/
-int tokfd;
+mod_export int tokfd;
 
 /* lexical analyzer error flag */
  
Index: Src/math.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/math.c,v
retrieving revision 1.18
diff -u -r1.18 math.c
--- Src/math.c	10 Mar 2003 15:24:08 -0000	1.18
+++ Src/math.c	7 Aug 2003 16:37:20 -0000
@@ -40,7 +40,7 @@
 /* integer zero */
 
 /**/
-mnumber zero_mnumber;
+mod_export mnumber zero_mnumber;
 
 /* last input base we used */
 
Index: Src/Zle/compcore.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/compcore.c,v
retrieving revision 1.63
diff -u -r1.63 compcore.c
--- Src/Zle/compcore.c	4 Jul 2002 09:29:22 -0000	1.63
+++ Src/Zle/compcore.c	7 Aug 2003 16:37:20 -0000
@@ -277,7 +277,7 @@
 /* This holds the end-position of the last string inserted into the line. */
 
 /**/
-int lastend;
+mod_export int lastend;
 
 #define inststr(X) inststrlen((X),1,-1)
 
Index: Src/Zle/zle_main.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/zle_main.c,v
retrieving revision 1.34
diff -u -r1.34 zle_main.c
--- Src/Zle/zle_main.c	22 May 2003 09:48:29 -0000	1.34
+++ Src/Zle/zle_main.c	7 Aug 2003 16:37:20 -0000
@@ -107,9 +107,9 @@
 /* the status line, and its length */
 
 /**/
-char *statusline;
+mod_export char *statusline;
 /**/
-int statusll;
+mod_export int statusll;
 
 /* The current history line and cursor position for the top line *
  * on the buffer stack.                                          */


-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR Ltd., Science Park, Milton Road,
Cambridge, CB4 0WH, UK                          Tel: +44 (0)1223 692070


**********************************************************************
The information transmitted is intended only for the person or
entity to which it is addressed and may contain confidential 
and/or privileged material. 
Any review, retransmission, dissemination or other use of, or
taking of any action in reliance upon, this information by 
persons or entities other than the intended recipient is 
prohibited.  
If you received this in error, please contact the sender and 
delete the material from any computer.
**********************************************************************

