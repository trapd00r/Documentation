From zsh-workers-return-27712-mason-zsh=primenet.com.au@zsh.org Mon Feb 15 23:53:00 2010
Return-Path: <zsh-workers-return-27712-mason-zsh=primenet.com.au@zsh.org>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 18656 invoked by alias); 15 Feb 2010 23:53:00 -0000
Mailing-List: contact zsh-workers-help@zsh.org; run by ezmlm
Precedence: bulk
X-No-Archive: yes
List-Id: Zsh Workers List <zsh-workers.zsh.org>
List-Post: <mailto:zsh-workers@zsh.org>
List-Help: <mailto:zsh-workers-help@zsh.org>
Delivered-To: mailing list zsh-workers@zsh.org
X-Seq: 27712
Received: (qmail 19279 invoked from network); 15 Feb 2010 23:52:58 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00,SPF_HELO_PASS
	autolearn=ham version=3.2.5
Received-SPF: none (ns1.primenet.com.au: domain at bewatermyfriend.org does not designate permitted sender hosts)
From: Frank Terbeck <ft@bewatermyfriend.org>
To: zsh-workers@zsh.org
Cc: Seth House <seth@eseth.com>
Subject: PATCH: (2/3) vcs_info: hg bookmarks support
Date: Tue, 16 Feb 2010 00:52:14 +0100
Message-Id: <1266277935-18165-3-git-send-email-ft@bewatermyfriend.org>
X-Mailer: git-send-email 1.7.0
In-Reply-To: <1266277935-18165-1-git-send-email-ft@bewatermyfriend.org>
References: <1266277935-18165-1-git-send-email-ft@bewatermyfriend.org>
X-Df-Sender: 430444

From: Seth House <seth@eseth.com>

---
 Doc/Zsh/contrib.yo                               |    6 ++++--
 Functions/VCS_Info/Backends/VCS_INFO_get_data_hg |   19 +++++++++++++++----
 2 files changed, 19 insertions(+), 6 deletions(-)

diff --git a/Doc/Zsh/contrib.yo b/Doc/Zsh/contrib.yo
index 2c3fc39..6d8d93f 100644
--- a/Doc/Zsh/contrib.yo
+++ b/Doc/Zsh/contrib.yo
@@ -602,8 +602,9 @@ If set to true, vcs_info goes the extra mile to figure out the revision of
 a repository's work tree (currently for the tt(git) and tt(hg) backends,
 where this kind of information is not always vital). For tt(git), the
 hash value of the currently checked out commit is available via the tt(%i)
-expansion. With tt(hg), the local revision number is available via tt(%i)
-and the corresponding global hash is available via tt(%m).
+expansion. With tt(hg), the local revision number is available via tt(%i),
+the corresponding global hash is available via tt(%m), and bookmarks are
+available via tt(%k).
 If this style is set in the tt(hg) context, the backend supports the
 branchformat style.
 )
@@ -669,6 +670,7 @@ In tt(branchformat) these replacements are done:
 startsitem()
 sitem(tt(%b))(the branch name)
 sitem(tt(%r))(the current revision number or the var(hgrevformat) style for tt(hg))
+sitem(tt(%k))(any current bookmarks for tt(hg))
 endsitem()
 
 In tt(stgitformat) these replacements are done:
diff --git a/Functions/VCS_Info/Backends/VCS_INFO_get_data_hg b/Functions/VCS_Info/Backends/VCS_INFO_get_data_hg
index 6689015..7c854b2 100644
--- a/Functions/VCS_Info/Backends/VCS_INFO_get_data_hg
+++ b/Functions/VCS_Info/Backends/VCS_INFO_get_data_hg
@@ -4,7 +4,7 @@
 
 setopt localoptions NO_shwordsplit
 local file hgbranch hgbranch_name hgbase hglhash hgshash hglrev hgmisc \
-    r_branch hgchanges revformat
+    r_branch hgchanges revformat bookmarks r_bmhash r_bmname hgbm
 
 VCS_INFO_hg_get_mq_top_patch () {
     local patchdir=$1
@@ -32,6 +32,9 @@ fi
 
 hglhash=''
 hglrev=''
+hgbm=''
+bookmarks="${hgbase}/.hg/bookmarks"
+
 if zstyle -t ":vcs_info:${vcs}:${usercontext}:${rrn}" get-revision ; then
     # Calling the 'hg' program is quite a bit too slow for prompts.
     # If there's a way around that, I'd be interested.
@@ -41,7 +44,7 @@ if zstyle -t ":vcs_info:${vcs}:${usercontext}:${rrn}" get-revision ; then
             "check-for-changes" ; then
 
         HGRCPATH="/dev/null" ${vcs_comm[cmd]} id -i -n -b \
-        | read -r hglhash hglrev r_branch
+        | read -r hgshash hglrev r_branch
 
         # Are there uncommitted-changes?
         if [[ $hglrev[-1] == + ]] ; then
@@ -50,18 +53,26 @@ if zstyle -t ":vcs_info:${vcs}:${usercontext}:${rrn}" get-revision ; then
 
         # Remove uncommitted-changes marker, if any
         hglrev=${hglrev/+/}
-        hglhash=${hglhash/+/}
+        hgshash=${hgshash/+/}
     else
         HGRCPATH="/dev/null" ${vcs_comm[cmd]} \
         parents --template="{node} {node|short} {rev} {branches}\n" \
         | read -r hglhash hgshash hglrev r_branch
     fi
 
+    if [[ -r "${bookmarks}" ]] ; then
+        while read -r r_bmhash r_bmname ; do
+            if [[ $hglhash == $r_bmhash || $r_bmhash == $hgshash* ]] ; then
+                hgbm="$r_bmname;${hgbm}"
+            fi
+        done < ${bookmarks}
+    fi
+
     if [[ -n ${hglrev} ]] ; then
         zstyle -s ":vcs_info:${vcs}:${usercontext}:${rrn}" hgrevformat revformat || revformat="%r:%h"
         zformat -f hglrev "${revformat}" "r:${hglrev}" "h:${hglhash}"
         zstyle -s ":vcs_info:${vcs}:${usercontext}:${rrn}" branchformat hgbranch || hgbranch="%b:%r"
-        zformat -f hgbranch "${hgbranch}" "b:${hgbranch_name}" "r:${hglrev}"
+        zformat -f hgbranch "${hgbranch}" "b:${hgbranch_name}" "r:${hglrev}" "k:${hgbm}"
     fi
 else
     hgbranch="${hgbranch_name}"
-- 
1.7.0

