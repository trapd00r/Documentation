From zsh-workers-return-19784-mason-zsh=primenet.com.au@sunsite.dk Fri Apr 16 04:07:12 2004
Return-Path: <zsh-workers-return-19784-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 13511 invoked from network); 16 Apr 2004 04:07:11 -0000
Received: from sunsite.dk (130.225.247.90)
  by ns1.primenet.com.au with SMTP; 16 Apr 2004 04:07:11 -0000
Received: (qmail 681 invoked by alias); 16 Apr 2004 04:07:01 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 19784
Received: (qmail 671 invoked from network); 16 Apr 2004 04:07:01 -0000
Received: from localhost (HELO sunsite.dk) (127.0.0.1)
  by localhost with SMTP; 16 Apr 2004 04:07:01 -0000
X-MessageWall-Score: 0 (sunsite.dk)
Received: from [130.225.247.86] by sunsite.dk (MessageWall 1.0.8) with SMTP; 16 Apr 2004 4:7:0 -0000
Received: (qmail 26233 invoked from network); 16 Apr 2004 04:07:00 -0000
Received: from wbar3.sjo1-4-11-009-147.sjo1.dsl-verizon.net (HELO candle.brasslantern.com) (4.11.9.147)
  by a.mx.sunsite.dk with SMTP; 16 Apr 2004 04:06:57 -0000
Received: (from schaefer@localhost)
	by candle.brasslantern.com (8.11.6/8.11.6) id i3G46rb29737
	for zsh-workers@sunsite.dk; Thu, 15 Apr 2004 21:06:53 -0700
X-Authentication-Warning: candle.brasslantern.com: schaefer set sender to schaefer@closedmail.com using -f
From: Bart Schaefer <schaefer@brasslantern.com>
Message-Id: <1040416040653.ZM29736@candle.brasslantern.com>
Date: Fri, 16 Apr 2004 04:06:53 +0000
In-Reply-To: <11620.1082052793@csr.com>
Comments: In reply to Peter Stephenson <pws@csr.com>
        "Re: Crash of 4.2.0-dev-1" (Apr 15,  7:13pm)
References: <11620.1082052793@csr.com>
X-Mailer: Z-Mail (5.0.0 30July97)
To: zsh-workers@sunsite.dk
Subject: Re: Crash of 4.2.0-dev-1
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
X-Spam-Checker-Version: SpamAssassin 2.63 on a.mx.sunsite.dk
X-Spam-Level: ****
X-Spam-Status: No, hits=4.7 required=6.0 tests=RCVD_IN_DYNABLOCK,
	RCVD_IN_NJABL,RCVD_IN_NJABL_DIALUP,RCVD_IN_SORBS autolearn=no 
	version=2.63
X-Spam-Hits: 4.7

On Apr 15,  7:13pm, Peter Stephenson wrote:
> > 
> > 	zsh: kshtest: function not defined by file
> 
> This must be from the EF_RUN test in doshfunc, right?

I wasn't sure, but I just tried setting breakpoints on both places and
that's the one it hit.

> That means you see the message just after the outer kshtest is run,
> I think.

Right, except that there is no "inner" definition of kshtest in this
case -- there's an "inner" *call*:

zagzig% autoload +X -k kshtest
zagzig% functions kshtest
kshtest () {
        print "Running kshtest"
        unfunction kshtest
        kshtest "$@"
}
zagzig% kshtest
Running kshtest
zsh: kshtest: function not defined by file

> I believe (but haven't checked) we always duplicate a function to
> execute so that it's safe to unfunction while it's being executed.
> Could that be failing here?

Yes, that's what I think is happening.  It may be of interest to note
that the `kshtest "$@"' line either never executes, or does so without
producing any output or errors of any kind.  (I would have at least
expected it to say "command not found".)  There's no second call to
exec.c:loadautofn() which I at first suspected might be the reason for
the crash.  (The first call to loadautofn() is from `autoload -X'.)

Or at least the above is what happens when I run it in the debugger.
I suppose something different might be happening when not debugging.

Oliver's patch in 19767 doesn't seem to make any difference to this,
not that I expected it to.

