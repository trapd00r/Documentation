From zsh-workers-return-26758-mason-zsh=primenet.com.au@sunsite.dk Thu Mar 19 16:19:33 2009
Return-Path: <zsh-workers-return-26758-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 17028 invoked from network); 19 Mar 2009 16:19:30 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 19 Mar 2009 16:19:30 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 69150 invoked from network); 19 Mar 2009 16:19:26 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 19 Mar 2009 16:19:26 -0000
Received: (qmail 26791 invoked by alias); 19 Mar 2009 16:19:20 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 26758
Received: (qmail 26775 invoked from network); 19 Mar 2009 16:19:20 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 19 Mar 2009 16:19:20 -0000
Received: from vms173019pub.verizon.net (vms173019pub.verizon.net [206.46.173.19])
	by bifrost.dotsrc.org (Postfix) with ESMTP id CE0388058ADC
	for <zsh-workers@sunsite.dk>; Thu, 19 Mar 2009 17:19:05 +0100 (CET)
Received: from torch.brasslantern.com ([96.249.201.13])
 by vms173019.mailsrvcs.net
 (Sun Java(tm) System Messaging Server 6.3-7.04 (built Sep 26 2008; 32bit))
 with ESMTPA id <0KGR006QKHB557O5@vms173019.mailsrvcs.net> for
 zsh-workers@sunsite.dk; Thu, 19 Mar 2009 11:18:46 -0500 (CDT)
Received: from torch.brasslantern.com (localhost.localdomain [127.0.0.1])
	by torch.brasslantern.com (8.13.1/8.13.1) with ESMTP id n2JGIemw020726; Thu,
 19 Mar 2009 09:18:41 -0700
Received: (from schaefer@localhost)	by torch.brasslantern.com
 (8.13.1/8.13.1/Submit) id n2JGIemS020725; Thu, 19 Mar 2009 09:18:40 -0700
From: Bart Schaefer <schaefer@brasslantern.com>
Message-id: <090319091840.ZM20724@torch.brasslantern.com>
Date: Thu, 19 Mar 2009 09:18:40 -0700
In-reply-to: <237967ef0903190828k4b9f7edbyc85405b630c50d5d@mail.gmail.com>
Comments: In reply to Mikael Magnusson <mikachu@gmail.com>
 "Re: Bug#519535: history expansion: modifier completion missing" (Mar 19,
 4:28pm)
References: <20090313105555.GA19025@piper.oerlikon.madduck.net>
	<20090315062253.GB14010@scru.org>	<20090316181852.27e9420d@news01>
	<237967ef0903190828k4b9f7edbyc85405b630c50d5d@mail.gmail.com>
X-Mailer: OpenZMail Classic (0.9.2 24April2005)
To: Mikael Magnusson <mikachu@gmail.com>, zsh-workers@sunsite.dk
Subject: Re: Bug#519535: history expansion: modifier completion missing
MIME-version: 1.0
Content-type: text/plain; charset=us-ascii
X-Virus-Scanned: ClamAV 0.92.1/9140/Thu Mar 19 16:16:32 2009 on bifrost
X-Virus-Status: Clean

On Mar 19,  4:28pm, Mikael Magnusson wrote:
}
} Is it supposed to work here? $PWD:<tab> (it doesn't for me).

I don't think so, but that's probably just an omission.

} It does complete if you write $PWD(:<tab>

That's completing a glob qualifier, not a parameter modifier.  So in
pratice it would first expand $PWD and then attempt to glob it, which
works for $PWD but not for parameter values in general.

} but also in ${PWD(:<tab>

That should probably be considered a bug; it's still completing glob
qualifiers, but ${PWD isn't a valid glob pattern.

} but
} accepting one of the latter produces a syntax error:
} % echo ${PWD(:A)}
} zsh: bad substitution

Not surprising, as it is not valid sytax.

} Also, i get this:
} $PWD(:s-<tab>
} _history_modifiers:34: bad math expression: operand expected at `^-'

Hrm.  $delim[...] is being interpreted as an array reference when it
should be "$delim" followed by a character class pattern.


Index: Completion/Zsh/Type/_history_modifiers
===================================================================
diff -c -r1.1 _history_modifiers
--- _history_modifiers	13 Mar 2008 15:46:07 -0000	1.1
+++ _history_modifiers	19 Mar 2009 16:15:13 -0000
@@ -31,11 +31,11 @@
       fi
       delim=$PREFIX[1]
       compset -p 1
-      if ! compset "[^$delim]#$delim[^$delim]#$delim"; then
-	if compset "[^$delim]#$delim"; then
-	  _message original string
+      if ! compset -P "[^$delim]#$delim""[^$delim]#$delim"; then
+	if compset -P "[^$delim]#$delim"; then
+	  _message "replacement string"
 	else
-	  _message replacement string
+	  _message "original string"
 	fi
 	return
       fi

