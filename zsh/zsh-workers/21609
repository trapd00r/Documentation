From zsh-workers-return-21609-mason-zsh=primenet.com.au@sunsite.dk Sun Aug 14 21:49:40 2005
Return-Path: <zsh-workers-return-21609-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 5909 invoked from network); 14 Aug 2005 21:49:38 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 14 Aug 2005 21:49:38 -0000
Received: (qmail 8254 invoked from network); 14 Aug 2005 21:49:31 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 14 Aug 2005 21:49:31 -0000
Received: (qmail 29242 invoked by alias); 14 Aug 2005 21:49:28 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 21609
Received: (qmail 29232 invoked from network); 14 Aug 2005 21:49:27 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 14 Aug 2005 21:49:27 -0000
Received: (qmail 7825 invoked from network); 14 Aug 2005 21:49:27 -0000
Received: from dsl3-63-249-88-2.cruzio.com (HELO dot.blorf.net) (63.249.88.2)
  by a.mx.sunsite.dk with SMTP; 14 Aug 2005 21:49:22 -0000
Received: by dot.blorf.net (Postfix, from userid 1000)
	id 858013412; Sun, 14 Aug 2005 14:49:19 -0700 (PDT)
Date: Sun, 14 Aug 2005 14:49:19 -0700
From: Wayne Davison <wayned@users.sourceforge.net>
To: zsh-workers@sunsite.dk
Subject: broken readlink() call in glob.c
Message-ID: <20050814214919.GA15326@blorf.net>
Mime-Version: 1.0
Content-Type: multipart/mixed; boundary="3V7upXqbjpZ4EhLz"
Content-Disposition: inline
User-Agent: Mutt/1.5.9i
X-Spam-Checker-Version: SpamAssassin 3.0.4 (2005-06-05) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=AWL,BAYES_00 autolearn=ham 
	version=3.0.4


--3V7upXqbjpZ4EhLz
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline

Gcc 4 complained about a readlink() call in glob.c that had a NULL
buffer arg, so I checked the code, and it appears that the function
statfullpath() always returned 1 (missing file) for a symlink that
points nowhere.  This is due to the readlink() call with a zero-sized
buffer always returning -1 (on my system, at least).  The fix is to
supply a one-character buffer so that readlink() only returns a -1
when the file is totally missing or cannot be read.  Patch appended.

..wayne..

--3V7upXqbjpZ4EhLz
Content-Type: text/plain; charset=us-ascii
Content-Disposition: attachment; filename="glob.patch"

--- Src/glob.c	2 Aug 2005 09:23:41 -0000	1.43
+++ Src/glob.c	14 Aug 2005 21:40:58 -0000
@@ -259,8 +259,10 @@ statfullpath(const char *s, struct stat 
 	l = 0;
     }
     unmetafy(buf, NULL);
-    if (!st)
-	return access(buf, F_OK) && (!l || readlink(buf, NULL, 0));
+    if (!st) {
+	char lbuf[1];
+	return access(buf, F_OK) && (!l || readlink(buf, lbuf, 1) < 0);
+    }
     return l ? lstat(buf, st) : stat(buf, st);
 }
 

--3V7upXqbjpZ4EhLz--

