From zsh-workers-return-23808-mason-zsh=primenet.com.au@sunsite.dk Thu Aug 30 15:13:26 2007
Return-Path: <zsh-workers-return-23808-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 19415 invoked from network); 30 Aug 2007 15:13:18 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.3 (2007-08-08) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.3
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 30 Aug 2007 15:13:18 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 58466 invoked from network); 30 Aug 2007 15:13:12 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 30 Aug 2007 15:13:12 -0000
Received: (qmail 3491 invoked by alias); 30 Aug 2007 15:13:10 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 23808
Received: (qmail 3482 invoked from network); 30 Aug 2007 15:13:09 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 30 Aug 2007 15:13:09 -0000
Received: (qmail 58144 invoked from network); 30 Aug 2007 15:13:09 -0000
Received: from cluster-d.mailcontrol.com (217.69.20.190)
  by a.mx.sunsite.dk with SMTP; 30 Aug 2007 15:13:02 -0000
Received: from cameurexb01.EUROPE.ROOT.PRI ([62.189.241.200])
	by rly31d.srv.mailcontrol.com (MailControl) with ESMTP id l7UF9lU1017459
	for <zsh-workers@sunsite.dk>; Thu, 30 Aug 2007 16:12:57 +0100
Received: from news01.csr.com ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.1830);
	 Thu, 30 Aug 2007 16:12:28 +0100
Date: Thu, 30 Aug 2007 16:12:27 +0100
From: Peter Stephenson <pws@csr.com>
To: zsh-workers@sunsite.dk
Subject: Re: zsh 4.3.4 crashes in prompt-related code under Mac OS X
Message-ID: <20070830161227.5d66764a@news01.csr.com>
In-Reply-To: <20070830085711.GH27290@prunille.vinc17.org>
References: <20070830085711.GH27290@prunille.vinc17.org>
Organization: CSR
X-Mailer: Claws Mail 2.9.1 (GTK+ 2.10.13; i386-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
X-OriginalArrivalTime: 30 Aug 2007 15:12:28.0374 (UTC) FILETIME=[2DD0A760:01C7EB18]
X-Scanned-By: MailControl A-07-08-00 (www.mailcontrol.com) on 10.68.0.141

On Thu, 30 Aug 2007 10:57:11 +0200
Vincent Lefevre <vincent@vinc17.org> wrote:
> zsh 4.3.4 sometimes crashes in prompt-related code under Mac OS X.

Is it possible to get this with debugging code with line numbers?
(Generally speaking, without some fairly detailed debugging information
"sometimes crashes" reports tend to do little other than spread
despondency, although, to be fair, it's possible the desponency doesn't
spread further than me.)  If the crash is where it appears to be, I think
I'm eventually going to want to see the values of the arguments to
wcs_nicechar(), and the static variables buf, bufalloc and newalloc and the
automatic variable "s" inside wcs_nicechar().  (Or, obviously, a reliable way
of reproducing it.)

It may simply be a miscalculation of NICECHAR_MAX, in which case I've added
an extra debugging test.

Thanks
pws

Index: Src/utils.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/utils.c,v
retrieving revision 1.165
diff -u -r1.165 utils.c
--- Src/utils.c	20 Aug 2007 21:22:19 -0000	1.165
+++ Src/utils.c	30 Aug 2007 14:42:52 -0000
@@ -552,8 +552,12 @@
     if (swidep)
 	*swidep = s;
     for (mbptr = mbstr; ret; s++, mbptr++, ret--) {
+	DPUTS(s >= buf + NICECHAR_MAX,
+	      "BUG: buffer too small in wcs_nicechar");
 	if (imeta(*mbptr)) {
 	    *s++ = Meta;
+	    DPUTS(s >= buf + NICECHAR_MAX,
+		  "BUG: buffer too small for metafied char in wcs_nicechar");
 	    *s = *mbptr ^ 32;
 	} else {
 	    *s = *mbptr;


.

