From zsh-workers-request@euclid.skiles.gatech.edu  Tue Jan  9 06:16:27 1996
Received: from euclid.skiles.gatech.edu (euclid.skiles.gatech.edu [130.207.146.50]) by werple.net.au (8.7/8.7.1) with ESMTP id GAA02814 for <mason@werple.mira.net.au>; Tue, 9 Jan 1996 06:16:23 +1100 (EST)
Received: (from list@localhost) by euclid.skiles.gatech.edu (8.7.3/8.7.3) id NAA25426; Mon, 8 Jan 1996 13:56:23 -0500 (EST)
Resent-Date: Mon, 8 Jan 1996 13:56:23 -0500 (EST)
From: Zoltan Hidvegi <hzoli@cs.elte.hu>
Message-Id: <199601081856.TAA02907@bolyai.cs.elte.hu>
Subject: echotc and ncurses bugfix
To: zsh-workers@math.gatech.edu (zsh-workers)
Date: Mon, 8 Jan 1996 19:56:54 +0100 (MET)
Organization: Dept. of Comp. Sci., Eotvos University, Budapest, Hungary
Phone: (36 1)2669833 ext: 2667, home phone: (36 1) 2752368
X-Mailer: ELM [version 2.4 PL24 PGP3 *ALPHA*]
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
Resent-Message-ID: <"oooFS1.0.CD6.NZMym"@euclid>
Resent-From: zsh-workers@math.gatech.edu
X-Mailing-List: <zsh-workers@math.gatech.edu> archive/latest/725
X-Loop: zsh-workers@math.gatech.edu
Precedence: list
Resent-Sender: zsh-workers-request@math.gatech.edu

echotc does not work properly if zsh is linked with ncurses instead of
termcap.  The problem is that ncurses is a more clever program and tgetflag
returns -1 if the requested boolean capability does not exist.  zsh think it
means that this capability exists and is true.  The result:

% echotc k1
yes

(It should print the string sent by the F1 key).

The patch below fixes this bug.  If ncurses is used it print "no" if an
existing boolean capability is off (this is not possible with the termcap
termcap) library.

Cheers,

Zoltan

*** Src/builtin.c	1996/01/03 23:19:33	1.18
--- Src/builtin.c	1996/01/07 23:12:02
***************
*** 4250,4260 ****
  	printf("%d\n", num);
  	return 0;
      }
!     /* if the specified termcap is boolean, and set, say so */
!     if (tgetflag(s)) {
  	puts("yes");
  	return (0);
      }
      /* get a string-type capability */
      u = buf;
      t = tgetstr(s, &u);
--- 4250,4275 ----
  	printf("%d\n", num);
  	return 0;
      }
!     /* if the specified termcap is boolean, and set, say so  *
!      * ncurses can tell if an existing boolean capability is *
!      * off so in this case we print "no".                    */
! #ifndef NCURSES_VERSION
!     if (tgetflag(s) > 0) {
  	puts("yes");
  	return (0);
      }
+ #else
+     switch (tgetflag(s)) {
+     case -1:
+ 	break;
+     case 0:
+ 	puts("no");
+ 	return 0;
+     default:
+ 	puts("yes");
+ 	return 0;
+     }
+ #endif
      /* get a string-type capability */
      u = buf;
      t = tgetstr(s, &u);

