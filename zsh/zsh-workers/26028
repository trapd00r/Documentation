From zsh-workers-return-26028-mason-zsh=primenet.com.au@sunsite.dk Wed Nov 12 10:32:31 2008
Return-Path: <zsh-workers-return-26028-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 315 invoked from network); 12 Nov 2008 10:32:17 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 12 Nov 2008 10:32:17 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 20927 invoked from network); 12 Nov 2008 10:32:08 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 12 Nov 2008 10:32:08 -0000
Received: (qmail 3292 invoked by alias); 12 Nov 2008 10:32:02 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 26028
Received: (qmail 3282 invoked from network); 12 Nov 2008 10:32:02 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 12 Nov 2008 10:32:02 -0000
Received: from n4a.bullet.ukl.yahoo.com (n4a.bullet.ukl.yahoo.com [217.146.183.152])
	by bifrost.dotsrc.org (Postfix) with SMTP id D425B80308BE
	for <zsh-workers@sunsite.dk>; Wed, 12 Nov 2008 11:31:59 +0100 (CET)
Received: from [217.12.4.214] by n4.bullet.ukl.yahoo.com with NNFMP; 12 Nov 2008 10:31:59 -0000
Received: from [87.248.110.110] by t1.bullet.ukl.yahoo.com with NNFMP; 12 Nov 2008 10:31:59 -0000
Received: from [127.0.0.1] by omp215.mail.ukl.yahoo.com with NNFMP; 12 Nov 2008 10:31:58 -0000
X-Yahoo-Newman-Id: 919119.92907.bm@omp215.mail.ukl.yahoo.com
Received: (qmail 76169 invoked from network); 12 Nov 2008 10:31:59 -0000
DomainKey-Signature: a=rsa-sha1; q=dns; c=nofws;
  s=s1024; d=yahoo.co.uk;
  h=Received:X-YMail-OSG:X-Yahoo-Newman-Property:Received:From:To:Subject:Date:Message-ID;
  b=30GsK1/TTIlVVIc9mLHxqf3+Njpm98tICX9j7rEhhCTB8UMZUzXVXI80ir9OYozVILGBISoFOw534atGM/s9louCdP4ISfuoqA6AUe8jbjCZLZkhKxifenrcMNlh5KNGPFNYwjSZrn6ftZc0/+lK+kGQwD1JMn32Yg2VSIiDmZc=  ;
Received: from unknown (HELO thecus) (okiddle@89.60.202.67 with plain)
  by smtp130.mail.ukl.yahoo.com with SMTP; 12 Nov 2008 10:31:58 -0000
X-YMail-OSG: u3qLvygVM1lxNOMhcRQE79.9ZIt3jzg8HaSrVL8oMW9ShwPYUggwcpMHvP9CZSd8Rx6p66HXQ22fuw.q.._APs5ZoSIFTjJbJLdvEXl312QaUavkoDQGMm8rXTVcs55LbQNEgjgxC8NCGdXUKb8AOtJlsnX_M57ixzLkTSY-
X-Yahoo-Newman-Property: ymail-3
Received: from localhost ([127.0.0.1] helo=thecus)
	by thecus with esmtp (Exim 4.63)
	(envelope-from <okiddle@yahoo.co.uk>)
	id 1L0D0v-0008D0-KR
	for zsh-workers@sunsite.dk; Wed, 12 Nov 2008 11:31:57 +0100
From: Oliver Kiddle <okiddle@yahoo.co.uk>
To: Zsh workers <zsh-workers@sunsite.dk>
Subject: PATCH: fc resource leak
Date: Wed, 12 Nov 2008 11:31:57 +0100
Message-ID: <31557.1226485917@thecus>
X-Virus-Scanned: ClamAV 0.92.1/8620/Wed Nov 12 10:05:38 2008 on bifrost
X-Virus-Status: Clean

CID 128. In this case, a temporary file is not being closed when an
error condition occurs. Even though the file is deleted, it is still open.

Doing ls -l /proc/$$/fd on Linux makes it easy to see the open deleted
files. Running fc with the current event number prints a message to warn
about "current history line would recurse endlessly, aborted". Coverity
doesn't notice it but the same problem applies to two further error
messages down in the fclist() function.

Oliver

Index: Src/builtin.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/builtin.c,v
retrieving revision 1.217
diff -u -r1.217 builtin.c
--- Src/builtin.c	5 Nov 2008 13:02:09 -0000	1.217
+++ Src/builtin.c	12 Nov 2008 10:23:53 -0000
@@ -1480,6 +1480,7 @@
 		    unqueue_signals();
 		    zwarnnam("fc",
 		      "current history line would recurse endlessly, aborted");
+                    fclose(out);
 		    unlink(fil);
 		    return 1;
 		}
@@ -1619,6 +1620,8 @@
 	    zwarnnam("fc", "no such event: %s", buf);
 	} else
 	    zwarnnam("fc", "no events in that range");
+        if (f != stdout)
+	    fclose(f);
 	return 1;
     }
 


