From zsh-users-return-13169-mason-zsh=primenet.com.au@sunsite.dk Sat Aug 30 19:57:05 2008
Return-Path: <zsh-users-return-13169-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 23706 invoked from network); 30 Aug 2008 19:57:03 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.4 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 30 Aug 2008 19:57:03 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 62711 invoked from network); 30 Aug 2008 19:56:45 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 30 Aug 2008 19:56:45 -0000
Received: (qmail 23232 invoked by alias); 30 Aug 2008 19:56:13 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 13169
Received: (qmail 23214 invoked from network); 30 Aug 2008 19:56:12 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 30 Aug 2008 19:56:12 -0000
Received: from flock1.newmail.ru (flock1.newmail.ru [82.204.219.207])
	by bifrost.dotsrc.org (Postfix) with SMTP id 4E5D7801E2B4
	for <zsh-users@sunsite.dk>; Sat, 30 Aug 2008 21:56:08 +0200 (CEST)
Received: (qmail 5174 invoked from network); 30 Aug 2008 19:55:47 -0000
Received: from unknown (HELO cooker.net) (arvidjaar@newmail.ru@91.77.250.178)
  by smtpd.newmail.ru with SMTP; 30 Aug 2008 19:55:47 -0000
From: Andrey Borzenkov <arvidjaar@newmail.ru>
To: zsh-users@sunsite.dk,
 dqarras@yahoo.com
Subject: Re: Red Hat zsh bug report / ZDOTDIR w/ emulate
Date: Sat, 30 Aug 2008 23:55:40 +0400
User-Agent: KMail/1.9.10
References: <359178.34400.qm@web36802.mail.mud.yahoo.com>
In-Reply-To: <359178.34400.qm@web36802.mail.mud.yahoo.com>
MIME-Version: 1.0
Content-Type: multipart/signed;
  boundary="nextPart2943906.lOCRiruxa6";
  protocol="application/pgp-signature";
  micalg=pgp-sha1
Content-Transfer-Encoding: 7bit
Message-Id: <200808302355.45589.arvidjaar@newmail.ru>
X-Virus-Scanned: ClamAV 0.92.1/8120/Sat Aug 30 05:43:49 2008 on bifrost
X-Virus-Status: Clean

--nextPart2943906.lOCRiruxa6
Content-Type: text/plain;
  charset="iso-8859-1"
Content-Transfer-Encoding: quoted-printable
Content-Disposition: inline

On Saturday 30 August 2008, Daniel Qarras wrote:
>=20
> Hi,
>=20
> not sure if anyone has noticed but Red Hat has introduced a strange worka=
round into their zsh initscripts to workaround a corner case ZDOTDIR bug in=
 zsh:
>=20
> https://bugzilla.redhat.com/show_bug.cgi?id=3D430665#c19
> https://bugzilla.redhat.com/show_bug.cgi?id=3D430665#c25
> https://bugzilla.redhat.com/show_bug.cgi?id=3D430665#c27
>=20
> The comments above comment #19 are usual bickering about RH's zsh init sc=
ripts but it seems that those three comments illustrate that there's someth=
ing fishy with ZDOTDIR when using "emulate".
>=20

Yes, emulate is never reset contrary to manual. The patch below is the
most simple fix; one problem is it restores emulation mode if
LOCAL_OPTIONS is set, not when "emulate -L" is used as documentation
can be interpreted. OTOH documentation can be interpreted this way also.

Peter, is it OK to commit?

Index: Src/exec.c
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D
RCS file: /cvsroot/zsh/zsh/Src/exec.c,v
retrieving revision 1.142
diff -u -p -r1.142 exec.c
=2D-- Src/exec.c  25 Aug 2008 17:28:16 -0000      1.142
+++ Src/exec.c  30 Aug 2008 19:54:54 -0000
@@ -4184,7 +4184,7 @@ doshfunc(char *name, Eprog prog, LinkLis
     int oldzoptind, oldlastval, oldoptcind, oldnumpipestats, ret;
     int *oldpipestats =3D NULL;
     char saveopts[OPT_SIZE], *oldscriptname =3D scriptname, *fname =3D dup=
string(name);
=2D    int obreaks;
+    int obreaks, saveemulation ;
     struct funcstack fstack;
 #ifdef MAX_FUNCTION_DEPTH
     static int funcdepth;
@@ -4223,6 +4223,7 @@ doshfunc(char *name, Eprog prog, LinkLis
      * not currently set.  That's because if it gets set in the    *
      * function we need to restore the original options on exit.   */
     memcpy(saveopts, opts, sizeof(opts));
+    saveemulation =3D emulation;

     if (flags & PM_TAGGED)
        opts[XTRACE] =3D 1;
@@ -4315,6 +4316,7 @@ doshfunc(char *name, Eprog prog, LinkLis
        saveopts[PRIVILEGED] =3D opts[PRIVILEGED];
        saveopts[RESTRICTED] =3D opts[RESTRICTED];
        memcpy(opts, saveopts, sizeof(opts));
+       emulation =3D saveemulation;
     } else {
        /* just restore a couple. */
        opts[XTRACE] =3D saveopts[XTRACE];



--nextPart2943906.lOCRiruxa6
Content-Type: application/pgp-signature; name=signature.asc 
Content-Description: This is a digitally signed message part.

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.9 (GNU/Linux)

iEYEABECAAYFAki5pb0ACgkQR6LMutpd94wRuwCgiIBFC/V/5iKKvkRzTf9PONmW
1cMAnil1PKUiUp2lEAJ50d6s3EcCOfC3
=RX5Q
-----END PGP SIGNATURE-----

--nextPart2943906.lOCRiruxa6--

