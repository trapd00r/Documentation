From zsh-workers-return-26746-mason-zsh=primenet.com.au@sunsite.dk Tue Mar 17 09:58:10 2009
Return-Path: <zsh-workers-return-26746-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 16184 invoked from network); 17 Mar 2009 09:57:57 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.4 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 17 Mar 2009 09:57:57 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 45253 invoked from network); 17 Mar 2009 09:57:51 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 17 Mar 2009 09:57:51 -0000
Received: (qmail 20236 invoked by alias); 17 Mar 2009 09:57:45 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 26746
Received: (qmail 20226 invoked from network); 17 Mar 2009 09:57:44 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 17 Mar 2009 09:57:44 -0000
Received: from cluster-g.mailcontrol.com (cluster-g.mailcontrol.com [208.87.233.190])
	by bifrost.dotsrc.org (Postfix) with ESMTPS id B77B0801E289
	for <zsh-workers@sunsite.dk>; Tue, 17 Mar 2009 10:57:38 +0100 (CET)
Received: from cameurexb01.EUROPE.ROOT.PRI ([193.128.72.68])
	by rly23g.srv.mailcontrol.com (MailControl) with ESMTP id n2H9vQUM004452
	for <zsh-workers@sunsite.dk>; Tue, 17 Mar 2009 09:57:35 GMT
Received: from news01 ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.3959);
	 Tue, 17 Mar 2009 09:57:18 +0000
Date: Tue, 17 Mar 2009 09:57:17 +0000
From: Peter Stephenson <pws@csr.com>
To: zsh-workers@sunsite.dk
Subject: Re: Bug#519535: history expansion: modifier completion missing
Message-ID: <20090317095717.02bedf7e@news01>
In-Reply-To: <090316194434.ZM16487@torch.brasslantern.com>
References: <20090313105555.GA19025@piper.oerlikon.madduck.net>
	<20090315062253.GB14010@scru.org>
	<20090316181852.27e9420d@news01>
	<090316194434.ZM16487@torch.brasslantern.com>
Organization: CSR
X-Mailer: Claws Mail 3.5.0 (GTK+ 2.12.8; i386-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
X-OriginalArrivalTime: 17 Mar 2009 09:57:18.0268 (UTC) FILETIME=[C1E837C0:01C9A6E6]
X-Scanned-By: MailControl A_08_51_00 (www.mailcontrol.com) on 10.71.0.133
X-Virus-Scanned: ClamAV 0.92.1/9117/Tue Mar 17 04:58:08 2009 on bifrost
X-Virus-Status: Clean

On Mon, 16 Mar 2009 19:44:34 -0700
Bart Schaefer <schaefer@brasslantern.com> wrote:
> [-bugs.debian.org]
> 
> On Mar 16,  6:18pm, Peter Stephenson wrote:
> } 
> } I thought this was going to be harder than it turned out to be; as you can
> } see it's really quite simple, particularly since I already wrote modifer
> } completion and it would appear had the foresight to make it handle the
> } history case.
> 
> Nit-pick:  This doesn't handle the new :a/:A modifiers.

I've fixed that.

> Other nit-pick about :a itself -- get a load of this:
> 
> torch% echo foo
> torch% !!:a
> /usr/local/src/zsh/zsh-build/echo foo
> zsh: no such file or directory: /usr/local/src/zsh/zsh-build/echo
> 
> That's almost certainly not the intended behavior ... is it?

It depends what you mean by "intended": Michael did say the operation
didn't take account of whether the file existed (but I didn't document
this), and there was never any special behaviour for command words.  You
could make it work like "=", I suppose, but that's an extension.

> Replace :a
> with :h or :t there and you get "modifier failed" (which seems odd as
> well, but ...).

I think it's always done that, although that doesn't mean it's necessarily
useful.  Logically, it seems to me that for :h to fail is probably useful
(there's no directory part, so you won't get it) but for :t to fail is less
so, since you've already got a perfectly good non-directory part (even it
happens to be a directory, this isn't VMS).  So we could probably change
that without anyone complaining.

> I don't know how the generic quoting code plays in, but I suspect this
> is done this way *because* history expansion takes place so early.  If
> it looks like a history expansion and it got this far, then it must be
> a *failed* history expansion and needs to be quoted if it matches any
> other completion -- otherwise the history expansion will fail *again*
> after accept-line, and spoil the whole command.

That's quite possible.  The quote code is hair-raising enough (see utils.c
around line 4504) that it's quite hard to tell.  It's being called from
multiquote() within callcompfunc() in compcore.c, which is called for all
top-level completion widgets.  The commenting in that last function is
quite amusing in an infuriating sort of way: there are three, and all of
them are in blocks marked with "#if 0".

> } I think -z $compstate[quote] ensures we're not already doing something
> } clever inside nested quotes, which would mean the expression couldn't be a
> } history expansion.  I think.
> 
> History expansion occurs inside double quotes, though, so if the quote
> state is double-quote then ... er, um ... perhaps it's necessary to
> run compstate -q and examine $compstate[all_quotes] ...

Hmm... I deliberately didn't make the test too hairy, so it only completes
at the start of a word, but it looks like it's not too hard to fix the
simplest case of double quoting.

Index: Completion/Base/Core/_normal
===================================================================
RCS file: /cvsroot/zsh/zsh/Completion/Base/Core/_normal,v
retrieving revision 1.5
diff -u -r1.5 _normal
--- Completion/Base/Core/_normal	16 Mar 2009 18:29:39 -0000	1.5
+++ Completion/Base/Core/_normal	17 Mar 2009 09:42:27 -0000
@@ -13,7 +13,9 @@
 # $PREFIX has a quoted form of the !, so we can't test that
 # (it might the start of a real argument), but words has the
 # raw McCoy.
-if [[ -o BANG_HIST && $words[CURRENT] = \!*: && -z $compstate[quote] ]]; then
+if [[ -o BANG_HIST &&
+     ( ( $words[CURRENT] = \!*: && -z $compstate[quote] ) ||
+       ( $words[CURRENT] = \"\!*: && $compstate[all_quotes] = \" ) ) ]]; then
   # This looks like a real history expansion; in that case
   # we'd better put the !'s back the way pfalstad intended.
   PREFIX=${PREFIX//\\!/!}
Index: Completion/Zsh/Type/_history_modifiers
===================================================================
RCS file: /cvsroot/zsh/zsh/Completion/Zsh/Type/_history_modifiers,v
retrieving revision 1.2
diff -u -r1.2 _history_modifiers
--- Completion/Zsh/Type/_history_modifiers	23 Feb 2008 18:34:02 -0000	1.2
+++ Completion/Zsh/Type/_history_modifiers	17 Mar 2009 09:42:27 -0000
@@ -64,6 +64,8 @@
       )
     if (( ! global )); then
       list+=(
+	"a:absolute path"
+	"A:absolute path resolving symbolic links"
 	"g:globally apply s or &"
 	"h:head - strip trailing path element"
 	"t:tail - strip directories"



-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070

