From zsh-workers-return-23311-mason-zsh=primenet.com.au@sunsite.dk Mon Apr 23 16:08:15 2007
Return-Path: <zsh-workers-return-23311-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 16148 invoked from network); 23 Apr 2007 16:08:13 -0000
X-Spam-Checker-Version: SpamAssassin 3.1.8 (2007-02-13) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=BAYES_00,FORGED_RCVD_HELO
	autolearn=ham version=3.1.8
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 23 Apr 2007 16:08:13 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 11276 invoked from network); 23 Apr 2007 16:08:08 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 23 Apr 2007 16:08:08 -0000
Received: (qmail 9872 invoked by alias); 23 Apr 2007 16:08:04 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 23311
Received: (qmail 9858 invoked from network); 23 Apr 2007 16:08:03 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 23 Apr 2007 16:08:03 -0000
Received: (qmail 10911 invoked from network); 23 Apr 2007 16:08:03 -0000
Received: from ik-out-1112.google.com (66.249.90.180)
  by a.mx.sunsite.dk with SMTP; 23 Apr 2007 16:07:57 -0000
Received: by ik-out-1112.google.com with SMTP id c29so1814296ika
        for <zsh-workers@sunsite.dk>; Mon, 23 Apr 2007 09:07:56 -0700 (PDT)
DKIM-Signature: a=rsa-sha1; c=relaxed/relaxed;
        d=gmail.com; s=beta;
        h=domainkey-signature:received:received:message-id:date:from:to:subject:cc:in-reply-to:mime-version:content-type:content-transfer-encoding:content-disposition:references;
        b=Iv1jAs0Y0fU76iT3ad0ZvRaWCbi5TlaBmj4HVMA26BOK9EZpCtApRx0DLMj5a9JyU1NocUM2j7BLqRgsUqie3ib//T/K5QJS/L8nSjTR159rZCJrv0LhZrJFdL1wnui4q0mzEnLnNDltkS+lOVk1T9pJwmiQ5duYbazhkcXGdyg=
DomainKey-Signature: a=rsa-sha1; c=nofws;
        d=gmail.com; s=beta;
        h=received:message-id:date:from:to:subject:cc:in-reply-to:mime-version:content-type:content-transfer-encoding:content-disposition:references;
        b=kVbnq8lIOAFmPWN7etqgMUx8p+968FTmsGCBgTFk6FsXlx5DT4N5K87xGEOgJqntHWjE0jkNFVIIYcff+wbJyTGNcTmfU5nvZkU0omrOLaDZbXVaPlZQKlJnSWa656XutC+yKNH32Tc2qh+nfPGNCyt4xBVIRUEdtY3R5xPNFaI=
Received: by 10.78.138.6 with SMTP id l6mr1122100hud.1177344475931;
        Mon, 23 Apr 2007 09:07:55 -0700 (PDT)
Received: by 10.78.45.10 with HTTP; Mon, 23 Apr 2007 09:07:55 -0700 (PDT)
Message-ID: <237967ef0704230907x3054fbdah5e0baa4df5da73d9@mail.gmail.com>
Date: Mon, 23 Apr 2007 18:07:55 +0200
From: "Mikael Magnusson" <mikachu@gmail.com>
To: "Peter Stephenson" <pws@csr.com>
Subject: Re: zsh 4.3.4 released
Cc: "Zsh hackers list" <zsh-workers@sunsite.dk>
In-Reply-To: <200704231506.l3NF6Njx011759@news01.csr.com>
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 7bit
Content-Disposition: inline
References: <200704161647.l3GGl2FE027950@news01.csr.com>
	 <20070419120758.e9774528.pws@csr.com>
	 <237967ef0704201440g1c072ca8l451439d2ec8578bf@mail.gmail.com>
	 <20070423104151.1f5f368e.pws@csr.com>
	 <237967ef0704230550k41ddb13fy60deebd526ecc5ec@mail.gmail.com>
	 <200704231318.l3NDIONr006499@news01.csr.com>
	 <237967ef0704230722u7546461ehd6b3280df79352a0@mail.gmail.com>
	 <200704231506.l3NF6Njx011759@news01.csr.com>

On 23/04/07, Peter Stephenson <pws@csr.com> wrote:
> "Mikael Magnusson" wrote:
> > (gdb) print tindent
> > $12 = -2
>
> Thanks.  This is the problem; tindent should never be less than zero.
> I'm not sure why I'm not seeing it; it might suggest the structure with
> the function in it is already corrupt at the point where you run
> "which".
>
> The following patch should stop the crash (so it's probably worth
> having) and report at the point where it first becomes confused, though
> it doesn't address the underlying problem.

With latest cvs, it still crashes, but differently.

Program received signal SIGSEGV, Segmentation fault.
0xa7dc90cc in memcpy () from /lib/libc.so.6
(gdb) bt
#0  0xa7dc90cc in memcpy () from /lib/libc.so.6
#1  0x080d0e1b in taddstr (s=0x80e4c4a "esac") at text.c:81
#2  0x080d1e19 in gettext2 (state=0xaf8659c0) at text.c:594
#3  0x080d0f9e in getpermtext (prog=0x8115538, c=0x8116a64) at text.c:141
#4  0x08081057 in printshfuncnode (hn=0x8115560, printflags=32) at
hashtable.c:889
#5  0x080619f7 in bin_whence (nam=0xa7f362a0 "which", argv=0xaf865c50,
ops=0xaf865ca0, func=0)
    at builtin.c:3050
#6  0x080536bd in execbuiltin (args=0xa7f36278, bn=0x80e73a8) at builtin.c:438
#7  0x0807496c in execcmd (state=0xaf866080, input=0, output=0,
how=18, last1=2) at exec.c:2670
#8  0x08070cd1 in execpline2 (state=0xaf866080, pcode=195, how=18,
input=0, output=0, last1=0)
    at exec.c:1343
#9  0x0806fc28 in execpline (state=0xaf866080, slcode=4098, how=18,
last1=0) at exec.c:1129
#10 0x0806f355 in execlist (state=0xaf866080, dont_change_job=0,
exiting=0) at exec.c:935
#11 0x0806ef63 in execode (p=0xa7f36220, dont_change_job=0, exiting=0)
at exec.c:793
#12 0x0808996c in loop (toplevel=1, justonce=0) at init.c:180
#13 0x0808c470 in zsh_main (argc=2, argv=0xaf8661b4) at init.c:1347
#14 0x08052d12 in main (argc=2, argv=0xaf8661b4) at ./main.c:93
(gdb) frame 1
#1  0x080d0e1b in taddstr (s=0x80e4c4a "esac") at text.c:81
81		memcpy(tptr, s, sl);
(gdb) print tptr
$1 = 0x1ffffff <Address 0x1ffffff out of bounds>
(gdb) print s
$2 = 0x80e4c4a "esac"
(gdb) print sl
$3 = 4
(gdb) print tbuf
$4 = 0x0
(gdb) print tlim
$5 = 0x4000000 <Address 0x4000000 out of bounds>
(gdb) print tsiz
$6 = 67108864
(gdb) print tindent
$7 = 0
(gdb) print tnewlins
$8 = 1

Don't know if it would help but here's the zwc file too,
http://mikachu.ath.cx/dot-zshurxvt.zwc

-- 
Mikael Magnusson

