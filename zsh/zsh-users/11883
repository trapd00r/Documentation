From zsh-users-return-11883-mason-zsh=primenet.com.au@sunsite.dk Wed Sep 26 10:00:07 2007
Return-Path: <zsh-users-return-11883-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 4668 invoked from network); 26 Sep 2007 09:59:59 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.3 (2007-08-08) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.3
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 26 Sep 2007 09:59:59 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 3374 invoked from network); 26 Sep 2007 09:59:52 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 26 Sep 2007 09:59:52 -0000
Received: (qmail 5292 invoked by alias); 26 Sep 2007 09:59:45 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 11883
Received: (qmail 5273 invoked from network); 26 Sep 2007 09:59:44 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 26 Sep 2007 09:59:44 -0000
Received: (qmail 2152 invoked from network); 26 Sep 2007 09:59:44 -0000
Received: from cluster-d.mailcontrol.com (217.69.20.190)
  by a.mx.sunsite.dk with SMTP; 26 Sep 2007 09:59:38 -0000
Received: from cameurexb01.EUROPE.ROOT.PRI ([62.189.241.200])
	by rly26d.srv.mailcontrol.com (MailControl) with ESMTP id l8Q9xXLa027759
	for <zsh-users@sunsite.dk>; Wed, 26 Sep 2007 10:59:35 +0100
Received: from news01 ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.1830);
	 Wed, 26 Sep 2007 10:59:30 +0100
Date: Wed, 26 Sep 2007 10:59:30 +0100
From: Peter Stephenson <pws@csr.com>
To: zsh-users@sunsite.dk
Subject: Re: bug? - how to skip precmd
Message-ID: <20070926105930.291a9f47@news01>
In-Reply-To: <20070926092956.25800.qmail@smasher.org>
References: <20070926092956.25800.qmail@smasher.org>
Organization: CSR
X-Mailer: Claws Mail 3.0.0 (GTK+ 2.10.14; i386-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
X-OriginalArrivalTime: 26 Sep 2007 09:59:30.0496 (UTC) FILETIME=[EE7B1C00:01C80023]
X-Scanned-By: MailControl A-07-08-10 (www.mailcontrol.com) on 10.68.0.136

On Wed, 26 Sep 2007 21:29:52 +1200 (NZST)
Atom Smasher <atom@smasher.org> wrote:
> if i run a simple command followed by:
>  	&& return
>   or
>  	&& return n
> my precmd is ignored. that's just weird...

"return" at the top level causes the shell to leave and reenter the main
command loop, but without resetting the flag indicating the return is in
effect, which gets tested by the pre-command functions, which think they
need to return immediately.  (We treat "return" from the top level as
"exit" in a non-interactive shell to make functions work as scripts but we
deliberately don't do that in an interactive shell, so it's a rather
special case.)

Here's a minimal fix.

Index: Src/init.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/init.c,v
retrieving revision 1.77
diff -u -r1.77 init.c
--- Src/init.c	26 Jul 2007 08:58:09 -0000	1.77
+++ Src/init.c	26 Sep 2007 09:53:23 -0000
@@ -1343,9 +1343,11 @@
 	 */
 	maybeshrinkjobtab();
 
-	do
+	do {
+	    /* Reset return from top level which gets us back here */
+	    retflag = 0;
 	    loop(1,0);
-	while (tok != ENDINPUT && (tok != LEXERR || isset(SHINSTDIN)));
+	} while (tok != ENDINPUT && (tok != LEXERR || isset(SHINSTDIN)));
 	if (tok == LEXERR) {
 	    /* Make sure a parse error exits with non-zero status */
 	    if (!lastval)


-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070

