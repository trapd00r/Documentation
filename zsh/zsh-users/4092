From zsh-users-return-4092-mason-zsh=primenet.com.au@sunsite.dk Tue Aug 07 19:47:35 2001
Return-Path: <zsh-users-return-4092-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 1471 invoked from network); 7 Aug 2001 19:47:34 -0000
Received: from sunsite.dk (130.225.51.30)
  by ns1.primenet.com.au with SMTP; 7 Aug 2001 19:47:34 -0000
Received: (qmail 27101 invoked by alias); 7 Aug 2001 19:47:09 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 4092
Received: (qmail 27079 invoked from network); 7 Aug 2001 19:47:06 -0000
Date: Tue, 7 Aug 2001 12:46:34 -0700 (PDT)
From: Wayne Davison <wayned@users.sourceforge.net>
X-X-Sender:  <wayne@phong.blorf.net>
To: Vincent Lefevre <vincent@vinc17.org>
Cc: <zsh-users@sunsite.dk>
Subject: Re: [4.0.2 bug] commands not written to history
In-Reply-To: <4a9256987fvincent@vinc17.org>
Message-ID: <Pine.LNX.4.33L2.0108071235060.3311-200000@phong.blorf.net>
MIME-Version: 1.0
Content-Type: MULTIPART/MIXED; BOUNDARY="-1463796991-1988342638-997213594=:3311"

  This message is in MIME format.  The first part should be readable text,
  while the remaining parts are likely unreadable without MIME-aware tools.
  Send mail to mime@docserver.cac.washington.edu for more info.

---1463796991-1988342638-997213594=:3311
Content-Type: TEXT/PLAIN; charset=US-ASCII

On Fri, 29 Jun 2001, Vincent Lefevre wrote:
> It seems that cmd2 simply disappeared from the history; cmd2 probably
> was the last command I typed in the shell, then I logged out, and
> logged in again (thus, the xinit in the history just after cmd1).

I was finally able to reproduce a case where the shell failed to save
the very last command in the history.  It only occurs when the Zle
history is active and the shell gets a signal that causes it to die.
In these circumstances, the save-history code is subtracting 1 from
the maximum number of events that it will save (so that the last,
unfinished line is not written out), but since the code is really
rewriting the history file using an alternate history buffer, the
real result is that it loses the last line in the just-read data.

So, do you know if you were exiting the shell via some kind of signal
rather than typing something like "exit"?  If so, try the attached
patch and see if this fixes the problem.

..wayne..

---1463796991-1988342638-997213594=:3311
Content-Type: TEXT/PLAIN; charset=US-ASCII; name="hist.patch"
Content-Transfer-Encoding: BASE64
Content-ID: <Pine.LNX.4.33L2.0108071246340.3311@phong.blorf.net>
Content-Description: fix last-line lossage
Content-Disposition: attachment; filename="hist.patch"

SW5kZXg6IFNyYy9oaXN0LmMNCi0tLSBTcmMvaGlzdC5jCTIwMDEvMDYvMjgg
MTg6MTc6MTQJMS4zMA0KKysrIFNyYy9oaXN0LmMJMjAwMS8wOC8wNyAxOToz
Mjo1OQ0KQEAgLTIwMjgsMTAgKzIwMjgsMTMgQEANCiAJICAgIEhpc3RlbnQg
cmVtZW1iZXJfaGlzdF9yaW5nID0gaGlzdF9yaW5nOw0KIAkgICAgaW50IHJl
bWVtYmVyX2hpc3RsaW5lY3QgPSBoaXN0bGluZWN0Ow0KIAkgICAgaW50IHJl
bWVtYmVyX2N1cmhpc3QgPSBjdXJoaXN0Ow0KKwkgICAgaW50IHJlbWVtYmVy
X2hpc3RzaXogPSBoaXN0c2l6Ow0KKwkgICAgaW50IHJlbWVtYmVyX2hpc3Rh
Y3RpdmUgPSBoaXN0YWN0aXZlOw0KIA0KIAkgICAgaGlzdF9yaW5nID0gTlVM
TDsNCiAJICAgIGN1cmhpc3QgPSBoaXN0bGluZWN0ID0gMDsNCiAJICAgIGhp
c3RzaXogPSBzYXZlaGlzdDsNCisJICAgIGhpc3RhY3RpdmUgPSAwOw0KIAkg
ICAgY3JlYXRlaGlzdHRhYmxlKCk7IC8qIHNldHMgaGlzdHRhYiAqLw0KIA0K
IAkgICAgaGlzdF9pZ25vcmVfYWxsX2R1cHMgfD0gaXNzZXQoSElTVFNBVkVO
T0RVUFMpOw0KQEAgLTIwNDQsNiArMjA0Nyw4IEBADQogCSAgICBoaXN0bGlu
ZWN0ID0gcmVtZW1iZXJfaGlzdGxpbmVjdDsNCiAJICAgIGhpc3RfcmluZyA9
IHJlbWVtYmVyX2hpc3RfcmluZzsNCiAJICAgIGhpc3R0YWIgPSByZW1lbWJl
cl9oaXN0dGFiOw0KKwkgICAgaGlzdHNpeiA9IHJlbWVtYmVyX2hpc3RzaXo7
DQorCSAgICBoaXN0YWN0aXZlID0gcmVtZW1iZXJfaGlzdGFjdGl2ZTsNCiAJ
fQ0KICAgICB9IGVsc2UgaWYgKGVycikNCiAJemVycigiY2FuJ3Qgd3JpdGUg
aGlzdG9yeSBmaWxlICVzIiwgZm4sIDApOw0K
---1463796991-1988342638-997213594=:3311--

