From zsh-workers-return-22583-mason-zsh=primenet.com.au@sunsite.dk Fri Aug 04 02:27:27 2006
Return-Path: <zsh-workers-return-22583-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 25154 invoked from network); 4 Aug 2006 02:27:25 -0000
X-Spam-Checker-Version: SpamAssassin 3.1.4 (2006-07-25) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=AWL,BAYES_00,
	FORGED_RCVD_HELO,UNPARSEABLE_RELAY autolearn=ham version=3.1.4
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 4 Aug 2006 02:27:25 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 55971 invoked from network); 4 Aug 2006 02:27:19 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 4 Aug 2006 02:27:19 -0000
Received: (qmail 20676 invoked by alias); 4 Aug 2006 02:27:17 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 22583
Received: (qmail 20667 invoked from network); 4 Aug 2006 02:27:16 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 4 Aug 2006 02:27:16 -0000
Received: (qmail 55708 invoked from network); 4 Aug 2006 02:27:16 -0000
Received: from 69-12-150-177.dsl.static.sonic.net (HELO ripple.fruitbat.org) (69.12.150.177)
  by a.mx.sunsite.dk with SMTP; 4 Aug 2006 02:27:14 -0000
Received: (from daemon@localhost)
	by ripple.fruitbat.org (8.13.4/8.8.8/PAC-1.3) id k742QaXN003753
	for <zsh-workers@sunsite.dk>; Thu, 3 Aug 2006 19:26:36 -0700
Received: from ming.fruitbat.org(192.168.55.2) by ripple.fruitbat.org via smap (V2.1+anti-relay+anti-spam)
	id xma003724; Fri, 4 Aug 06 02:26:22 GMT
Received: from gremlin.fruitbat.org (IDENT:202@gremlin.fruitbat.org [192.168.55.4])
	by ming.fruitbat.org (8.12.10/8.10.2/PAC-1.6) with ESMTP id k742QM6V031859
	for <zsh-workers@sunsite.dk>; Thu, 3 Aug 2006 19:26:22 -0700
Date: Thu, 3 Aug 2006 19:26:22 -0700 (PDT)
From: "Peter A. Castro" <doctor@fruitbat.org>
To: zsh-workers@sunsite.dk
Subject: erand48 in mathfunc.c
Message-ID: <Pine.LNX.4.63.0608031913480.29840@gremlin.fruitbat.org>
MIME-Version: 1.0
Content-Type: TEXT/PLAIN; charset=US-ASCII; format=flowed

Greetings,
   I've finally had time to look into a problem under Cygwin concerning
the mathfunc module and rand48().  Up until now, these never worked under
Cygwin.  erand48() would always return "0.0" for the value, no matter
what seedbufptr contained, and thus Test/V03mathfunc.ztst would always
fail.
   It seems that some implementations of rand48() need the seed to be
initialized (ie: use seed48(s) before erand48(s)).  Or at least, the
implementation in newlib does.  In anycase, calling seed48(s) solves the
problem and allows erand48() to return real values.  I don't see the harm
in always calling it for seed initialization, so I've not ifdef'ed it.
   It would be interesting to know if other platforms either need this
initializion as well, or produce incorrect results if used.
   In anycase, see patch.  This is against 4.3.2.  I've not checked CVS
lately.

*** 4.3.2/zsh-4.3.2/Src/Modules/mathfunc.c	Tue Nov  1 02:20:24 2005
--- 4.3.2d/zsh-4.3.2/Src/Modules/mathfunc.c	Wed Aug  2 09:53:40 2006
***************
*** 534,539 ****
--- 534,541 ----
   		seedbufptr[0] = (unsigned short)rand();
   		seedbufptr[1] = (unsigned short)rand();
   		seedbufptr[2] = (unsigned short)rand();
+		/* some implementations of rand48 need initialization */
+		seed48(seedbufptr);
   	    }
   	    ret.type = MN_FLOAT;
   	    ret.u.d = erand48(seedbufptr);


-- 
Peter A. Castro <doctor@fruitbat.org> or <Peter.Castro@oracle.com>
 	"Cats are just autistic Dogs" -- Dr. Tony Attwood

