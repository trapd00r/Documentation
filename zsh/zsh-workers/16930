From zsh-workers-return-16930-mason-zsh=primenet.com.au@sunsite.dk Fri Mar 29 11:34:02 2002
Return-Path: <zsh-workers-return-16930-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 2454 invoked from network); 29 Mar 2002 11:34:01 -0000
Received: from sunsite.dk (130.225.247.90)
  by ns1.primenet.com.au with SMTP; 29 Mar 2002 11:34:01 -0000
Received: (qmail 20450 invoked by alias); 29 Mar 2002 11:33:55 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 16930
Received: (qmail 20438 invoked from network); 29 Mar 2002 11:33:54 -0000
To: zsh-workers@sunsite.dk
Subject: PATCH: "test -f $verybig" oversight
From: Alexandre Duret-Lutz <duret_g@lrde.epita.fr>
X-Home-Page: http://www.epita.fr/~duret_g/
Date: 29 Mar 2002 12:33:48 +0100
Lines: 74
User-Agent: Gnus/5.0808 (Gnus v5.8.8) Emacs/20.7
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Message-ID: <2002-03-29-12-33-48+21545+duret_g@epita.fr>
X-Attribution: adl
Sender: Alexandre Duret-Lutz <duret_g@lrde.epita.fr>

Hi,

At some point, the C02cond.ztst test does

  block=$(find /dev(|ices)/ -type b -print)

and then

  test -f $block

This is obviously an error in the test case.  

An interesting point is what then happens in getstat().  On my
host, $#block == 49263, that's a lot more than 4*PATH_MAX. Hence,
the following line

   stat(unmeta(s), &st);

causes "stat(NULL, &st)" to be called.  It's not clear wheter
this is safe or not.


Index: Test/C02cond.ztst
===================================================================
RCS file: /cvsroot/zsh/zsh/Test/C02cond.ztst,v
retrieving revision 1.11
diff -u -r1.11 C02cond.ztst
--- Test/C02cond.ztst	10 Oct 2001 16:02:25 -0000	1.11
+++ Test/C02cond.ztst	29 Mar 2002 11:22:22 -0000
@@ -52,7 +52,12 @@
   [[ -e zerolength && ! -e nonexistent ]]
 0:-e cond
 
-  [[ -f zerolength && ! -f cond && ! -f $char && ! -f $block && ! -f . ]]
+  if [[ -n $block ]]; then
+    [[ -f zerolength && ! -f cond && ! -f $char && ! -f $block[(f)1] && ! -f . ]]
+  else
+    print -u8 'Warning: Not testing [[ -f blockdevice ]] (no devices found)'
+    [[ -f zerolength && ! -f cond && ! -f $char && ! -f . ]]
+  fi
 0:-f cond
 
   [[ -g modish && ! -g zerolength ]]
Index: Src/cond.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/cond.c,v
retrieving revision 1.3
diff -u -r1.3 cond.c
--- Src/cond.c	15 Oct 2001 11:28:08 -0000	1.3
+++ Src/cond.c	29 Mar 2002 11:22:23 -0000
@@ -324,6 +324,8 @@
 static struct stat *
 getstat(char *s)
 {
+    char *us;
+
 /* /dev/fd/n refers to the open file descriptor n.  We always use fstat *
  * in this case since on Solaris /dev/fd/n is a device special file     */
     if (!strncmp(s, "/dev/fd/", 8)) {
@@ -332,7 +334,9 @@
         return &st;
     }
 
-    if (stat(unmeta(s), &st))
+    if (!(us = unmeta(s)))
+        return NULL;
+    if (stat(us, &st))
 	return NULL;
     return &st;
 }


-- 
Alexandre Duret-Lutz

