From zsh-workers-return-23807-mason-zsh=primenet.com.au@sunsite.dk Thu Aug 30 14:27:54 2007
Return-Path: <zsh-workers-return-23807-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 16731 invoked from network); 30 Aug 2007 14:27:44 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.3 (2007-08-08) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.3
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 30 Aug 2007 14:27:44 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 34175 invoked from network); 30 Aug 2007 14:27:37 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 30 Aug 2007 14:27:37 -0000
Received: (qmail 28779 invoked by alias); 30 Aug 2007 14:27:35 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 23807
Received: (qmail 28770 invoked from network); 30 Aug 2007 14:27:34 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 30 Aug 2007 14:27:34 -0000
Received: (qmail 33883 invoked from network); 30 Aug 2007 14:27:34 -0000
Received: from cluster-g.mailcontrol.com (85.115.41.190)
  by a.mx.sunsite.dk with SMTP; 30 Aug 2007 14:27:27 -0000
Received: from rly08g.srv.mailcontrol.com (localhost.localdomain [127.0.0.1])
	by rly08g.srv.mailcontrol.com (MailControl) with ESMTP id l7UERI7Q023662
	(version=TLSv1/SSLv3 cipher=DHE-RSA-AES256-SHA bits=256 verify=NO)
	for <zsh-workers@sunsite.dk>; Thu, 30 Aug 2007 15:27:22 +0100
Received: from submission.mailcontrol.com (submission.mailcontrol.com [86.111.216.190])
	by rly08g.srv.mailcontrol.com (MailControl) id l7UERG8M023605
	for zsh-workers@sunsite.dk; Thu, 30 Aug 2007 15:27:16 +0100
Received: from cameurexb01.EUROPE.ROOT.PRI ([62.189.241.200])
	by rly08g-eth0.srv.mailcontrol.com (envelope-sender Peter.Stephenson@csr.com) (MIMEDefang) with ESMTP id l7UENtsT011846; Thu, 30 Aug 2007 15:27:16 +0100 (BST)
Received: from news01.csr.com ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.1830);
	 Thu, 30 Aug 2007 15:26:41 +0100
Date: Thu, 30 Aug 2007 15:26:41 +0100
From: Peter Stephenson <pws@csr.com>
To: "Jun T." <takimoto-j@kba.biglobe.ne.jp>
Cc: zsh-workers@sunsite.dk
Subject: Re: coredump in "interactive mode" of "menu select"
Message-ID: <20070830152641.3f8f0295@news01.csr.com>
In-Reply-To: <a06001007c2fc6f05300f@kba.biglobe.ne.jp>
References: <a06001007c2fc6f05300f@kba.biglobe.ne.jp>
Organization: CSR
X-Mailer: Claws Mail 2.9.1 (GTK+ 2.10.13; i386-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
X-OriginalArrivalTime: 30 Aug 2007 14:26:41.0476 (UTC) FILETIME=[C8894840:01C7EB11]
X-Scanned-By: MailControl A-07-08-00 (www.mailcontrol.com) on 10.71.1.118

On Thu, 30 Aug 2007 22:10:49 +0900
"Jun T." <takimoto-j@kba.biglobe.ne.jp> wrote:
> zsh-4.3.4 (or the latest CVS) coredumps in the "interactive mode" of
> the "menu select"  completion.

Yes, that's fairly spectacular.  Thank you, you're analysis is entirely
correct.

Here's the simple quick fix---it's not doing any harm, but there are too
many metafy/unmetafy pairs and it looks like it's not that hard to simplify
the code, when I get round to it (or somebody else does, but that's wishful
thinking).

Index: Src/Zle/complist.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/complist.c,v
retrieving revision 1.105
diff -u -r1.105 complist.c
--- Src/Zle/complist.c	6 Jul 2007 21:52:40 -0000	1.105
+++ Src/Zle/complist.c	30 Aug 2007 14:22:31 -0000
@@ -2542,10 +2542,20 @@
                 strncpy(zlemetaline, origline, l);
                 zlemetacs = origcs;
 
+		/*
+		 * Horrible quick fix:
+		 * we shouldn't need to metafy and unmetafy
+		 * quite as much.  If we kept unmetafied through
+		 * here we could fix up setmstatus to use unmetafied
+		 * as well.  This is the only use of setmstatus which
+		 * restores the line so that should be doable.
+		 */
+		unmetafy_line();
                 if (cmd == Th(z_selfinsert))
                     selfinsert(zlenoargs);
                 else
                     selfinsertunmeta(zlenoargs);
+		metafy_line();
 
                 saveline = (char *) zhalloc(zlemetall);
                 memcpy(saveline, zlemetaline, zlemetall);
Index: Src/Zle/zle_misc.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/zle_misc.c,v
retrieving revision 1.42
diff -u -r1.42 zle_misc.c
--- Src/Zle/zle_misc.c	19 Apr 2007 14:16:23 -0000	1.42
+++ Src/Zle/zle_misc.c	30 Aug 2007 14:22:32 -0000
@@ -42,6 +42,8 @@
     int m = neg ? -zmult : zmult;    /* number of copies to insert */
     int count;
 
+    UNMETACHECK();
+
     iremovesuffix(c1, 0);
     invalidatelist();
 


.

