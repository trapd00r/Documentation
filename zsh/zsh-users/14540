From zsh-users-return-14540-mason-zsh=primenet.com.au@zsh.org Wed Nov 11 02:53:26 2009
Return-Path: <zsh-users-return-14540-mason-zsh=primenet.com.au@zsh.org>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 19413 invoked by alias); 11 Nov 2009 02:53:26 -0000
Mailing-List: contact zsh-users-help@zsh.org; run by ezmlm
Precedence: bulk
X-No-Archive: yes
List-Id: Zsh Users List <zsh-users.zsh.org>
List-Post: <mailto:zsh-users@zsh.org>
List-Help: <mailto:zsh-users-help@zsh.org>
Delivered-To: mailing list zsh-users@zsh.org
X-Seq: 14540
Received: (qmail 11399 invoked from network); 11 Nov 2009 02:53:23 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received-SPF: pass (ns1.primenet.com.au: SPF record at _spf.google.com designates 209.85.219.209 as permitted sender)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=gamma;
        h=domainkey-signature:mime-version:received:in-reply-to:references
         :date:message-id:subject:from:to:cc:content-type;
        bh=6VozBr1tJJVlno8hTivBThft+c06YCbceaB/hz282Lg=;
        b=A8zpnRqq8nfYtgX8PXD5FXLf4lDl3p/sJ7BN8cdSBDX9qaAzj/HJgJJpWs+BdwfrXL
         I8eXmulrmTjy1T3H/S5Q9Lwg2scYMIjhsgOkVoRQsqBHiFMgGEP6yP8JiKg+OZ44d0qD
         SsRIqn3/RlPC3cbIxB1lr/jL+XMT0hUNkSE7o=
DomainKey-Signature: a=rsa-sha1; c=nofws;
        d=gmail.com; s=gamma;
        h=mime-version:in-reply-to:references:date:message-id:subject:from:to
         :cc:content-type;
        b=F91u+w8UpIHW0a4/wuEeHw0Bk8ZR6nWo/+i9DvzdU8pIgtLMDYIy2+MW+TuI1Fl0mN
         0mhKfvGnblVfrB3UGf4OmBA9EBOYRoK27w2Px2fXM3vM2fvMvdzcIqSx3RwzUeyawMvo
         iwTaNUXc4172Q8ShfXu3WEdd6AjzvfxBNIxhc=
MIME-Version: 1.0
In-Reply-To: <10081257897632@webmail89.yandex.ru>
References: <10081257897632@webmail89.yandex.ru>
Date: Wed, 11 Nov 2009 03:22:14 +0100
Message-ID: <237967ef0911101822g5bfcf4fao25fc33ba0a2e8604@mail.gmail.com>
Subject: Re: the function to show a digit argument while it is being typed
From: Mikael Magnusson <mikachu@gmail.com>
To: Dmitry Bolshakov <bdimych@narod.ru>
Cc: zsh-users@zsh.org
Content-Type: text/plain; charset=UTF-8

2009/11/11 Dmitry Bolshakov <bdimych@narod.ru>:
> hi
>
> in bash a digit argument is showed when it is being typed
>
> i have writed small function which do the same
>
> #####
> function digit-argument-show-while-entering {
>        arg="${KEYS[2]}"
>        if [[ $arg == - ]]
>        then
>                zle .neg-argument
>        else
>                zle .digit-argument
>        fi
>        while true
>        do
>                PREDISPLAY="(arg: $arg) "
>                zle -R
>
>                read -k k1
>                if [[ $k1 == $'\C-g' ]]
>                then
>                        NUMERIC=1
>                        break
>                elif [[ $k1 != $'\e' ]]
>                then
>                        zle -U $k1
>                        break
>                fi
>
>                read -k k2
>                if [[ $k2 == <0-9> ]]
>                then
>                        arg=$arg$k2
>                        NUMERIC=$arg
>                else
>                        zle -U "$k1$k2"
>                        break
>                fi
>        done
>        PREDISPLAY=""
> }
> zle -N digit-argument digit-argument-show-while-entering
> zle -N neg-argument digit-argument-show-while-entering
> #####
>
> it is not well tested but seems to be working

You probably want to declare local variables so they don't overwrite
things in the main shell, ie "local arg k1 k2" in the beginning.

I have a similar function, it doesn't work well for negative arguments though:

function _digit_argument () {
  zle -M "$NUMERIC$KEYS[-1]"
  zle .digit-argument
}

The problem is $NUMERIC is -1 after pressing just -, so pressing -1
shows -11. After the first digit it shows things correctly though.
(I've tried the obvious thing of swapping the order of the lines and
showing just $NUMERIC, but it doesn't seem to be updated at that
point).

You can do zle .$WIDGET instead of your first if condition.

-- 
Mikael Magnusson

