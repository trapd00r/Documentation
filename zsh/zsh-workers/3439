From zsh-workers-request@euclid.skiles.gatech.edu Tue Aug 12 15:38:15 1997
Return-Path: <zsh-workers-request@euclid.skiles.gatech.edu>
Delivered-To: mason@primenet.com.au
Received: (qmail 18087 invoked from network); 12 Aug 1997 15:38:13 -0000
Received: from euclid.skiles.gatech.edu (list@130.207.146.50)
  by ns1.primenet.com.au with SMTP; 12 Aug 1997 15:38:13 -0000
Received: (from list@localhost)
	by euclid.skiles.gatech.edu (8.8.5/8.8.5) id LAA25426;
	Tue, 12 Aug 1997 11:32:31 -0400 (EDT)
Resent-Date: Tue, 12 Aug 1997 11:32:31 -0400 (EDT)
X-URL: http://ghidora.uwyo.edu/~harres
Date: Tue, 12 Aug 1997 09:31:58 -0600
From: "John M. Harres" <harres@UWYO.EDU>
Subject: Re: weird zsh startup behavior
In-reply-to: "Your message of Sun, 10 Aug 1997 00:30:09 PDT."
 <19970810003009.13551@molehill.org>
To: Todd Larason <jtl@molehill.org>
Cc: mason@primenet.com.au, zsh-workers@math.gatech.edu
Message-id: <199708121531.JAA05545@ghidora.uwyo.edu>
MIME-version: 1.0
X-Mailer: exmh version 2.0zeta 7/24/97
Content-type: multipart/signed; boundary="==_Exmh_-461436210P"; micalg=pgp-md5;
 protocol="application/pgp-signature"
Content-transfer-encoding: 7bit
Resent-Message-ID: <"iYjVb3.0.DD6.E88yp"@euclid>
Resent-From: zsh-workers@math.gatech.edu
X-Mailing-List: <zsh-workers@math.gatech.edu> archive/latest/3439
X-Loop: zsh-workers@math.gatech.edu
Precedence: list
Resent-Sender: zsh-workers-request@math.gatech.edu

--==_Exmh_-461436210P
Content-Type: text/plain; charset=us-ascii

On Sun 10 Aug 1997, Todd Larason wrote:

> On Sat, Aug 09, 1997 at 05:11:53AM +0000, Geoff Wing wrote:
> > John M. Harres <harres@UWYO.EDU> typed:
> > > Does anyone know under what circumstances zsh will change directory on
> > > startup?  I was in root under sh, ran zsh, and zappo, switched directories,
> > > and not to root's home directory.  Both home directories are automounted.

> I saw this on a similar setup - Solaris 2.4, home directories automounted,
> zsh 3.0 betas I think.  I no longer have access to this system, so I can't
> double check the details, but they're not terribly important.
> 
> The problem was an assumption made in zgetcwd(), which didn't hold with
> the automounted home dirs.  I don't seem to have the patch I made, and I'm
> going on foggy memory here I'm afraid.
> 
> Anything that caused a zgetcwd() would end up *changing* the current
> directory.
> 
> Looking at zgetcwd, I'm thinking that the false assumption was that only
> one mountpoint could have the same device number ("if (sbuf.st_dev == dev)
> goto match;" around lines 178-179 in 3.0.4:compat.c).  With sun's
> automounter, with multiple directories from the same device mounted into
> the same directory, this wasn't true.  I assume my fix was to check the
> inode too.

Trying to look into this further, I'm getting further confused.  zgetcwd() 
appears to do some checks, then opens '..' scanning for the directory we are 
(were since there's a chdir()) in.  If that is not found, it then scans '.', 
but since we did a chdir("..") after opendir(".."), the second opendir should 
be opening the same directory as the first.

The second directory scan does not have the inode check, as you mentioned, but 
if it's there, the two loops look like they should either both succeed or 
fail, thus the second adds nothing.

What is the second loop intended to do?

I also don't understand when the first loop would fail.  It simply looks for
the dev & ino that match "." in the dirent's for "..".  What conditions will is
that trying to catch?

Sorry for my lack of understanding.  It's my first dive into the zsh source.

John


--==_Exmh_-461436210P
Content-Type: application/pgp-signature

-----BEGIN PGP MESSAGE-----
Version: 2.6.2

iQB1AwUBM/CB7QxlFYvtP/ENAQErzAL/fiZWADRt5aF/g0nSY19ZVCbOndVay52S
xF5fQsX7rwBi5NAt4FftHwjfePPxANB744E8FpUhs1oJ5aEZMpKYLW34YN+Aaiab
2gOZMjbWLc3K9QtutZtYoU98tMSGFy3N
=4bZE
-----END PGP MESSAGE-----

--==_Exmh_-461436210P--

