From zsh-workers-return-20965-mason-zsh=primenet.com.au@sunsite.dk Fri Mar 11 09:43:56 2005
Return-Path: <zsh-workers-return-20965-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 17003 invoked from network); 11 Mar 2005 09:43:54 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 11 Mar 2005 09:43:54 -0000
Received: (qmail 59218 invoked from network); 11 Mar 2005 09:43:49 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 11 Mar 2005 09:43:49 -0000
Received: (qmail 16535 invoked by alias); 11 Mar 2005 09:43:46 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 20965
Received: (qmail 16520 invoked from network); 11 Mar 2005 09:43:45 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 11 Mar 2005 09:43:45 -0000
Received: (qmail 58926 invoked from network); 11 Mar 2005 09:43:42 -0000
Received: from master.altlinux.ru (62.118.250.235)
  by a.mx.sunsite.dk with SMTP; 11 Mar 2005 09:43:38 -0000
Received: from solemn.turbinal.org (localhost.localdomain [127.0.0.1])
	by master.altlinux.ru (Postfix) with ESMTP id B3A46E61FE
	for <zsh-workers@sunsite.dk>; Fri, 11 Mar 2005 12:43:35 +0300 (MSK)
Received: by solemn.turbinal.org (Postfix, from userid 500)
	id 2D95854051; Fri, 11 Mar 2005 12:40:28 +0300 (MSK)
Date: Fri, 11 Mar 2005 12:40:28 +0300
From: Alexey Tourbin <at@altlinux.ru>
To: zsh-workers@sunsite.dk
Subject: apt4rpm completion: _rpm_packages
Message-ID: <20050311094027.GB27647@solemn.turbinal.org>
Mail-Followup-To: zsh-workers@sunsite.dk
Mime-Version: 1.0
Content-Type: multipart/signed; micalg=pgp-sha1;
	protocol="application/pgp-signature"; boundary="s9fJI615cBHmzTOP"
Content-Disposition: inline
X-Spam-Checker-Version: SpamAssassin 3.0.2 on a.mx.sunsite.dk
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=6.0 tests=BAYES_00 autolearn=ham 
	version=3.0.2
X-Spam-Hits: -2.6


--s9fJI615cBHmzTOP
Content-Type: multipart/mixed; boundary="0eh6TmSyL6TZE2Uz"
Content-Disposition: inline


--0eh6TmSyL6TZE2Uz
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
Content-Transfer-Encoding: quoted-printable

Hello,

I would like to add apt4rpm support to _apt completion.

The first step is to introduce Completion/Redhat/Type/_rpm_packages
(attached) tailored after Completion/Debian/Type/_deb_packages.
Except massive s/deb/rpm/ substitutions, difference is as follows:

--- zsh-4.2.4/Completion/Redhat/Type/_rpm_packages-	2005-01-09 09:34:11 +03=
00
+++ zsh-4.2.4/Completion/Redhat/Type/_rpm_packages	2005-03-11 12:30:53 +0300
@@ -19,10 +19,9 @@ _rpm_packages_update_installed () {
   if ( [[ ${+_rpm_packages_cache_installed} -eq 0 ]] ||
       _cache_invalid RPMS_installed ) && ! _retrieve_cache RPMS_installed;
   then
-    _rpm_packages_cache_installed=3D()
-    dpkg --get-selections | while read package state ; do
-        [[ $state =3D (install|hold) ]] && _rpm_packages_cache_installed+=
=3D$package
-    done
+    _rpm_packages_cache_installed=3D(
+      ${(f)"$(rpm -qa --qf '%{NAME}\n')"}
+    )
     _store_cache RPMS_installed _rpm_packages_cache_installed
   fi
   cachevar=3D_rpm_packages_cache_installed
@@ -106,13 +105,23 @@ _rpm_packages () {
   _tags packages && compadd "$expl[@]" - "${(@P)cachevar}"
 }
=20
- _rpms_caching_policy () {
-    # rebuild if cache is more than a week old
-      oldp=3D( "$1"(mw+1) )
-        (( $#oldp )) && return 0
-
-	  [[ /var/cache/apt/pkgcache.bin -nt "$1" ||
-	     /var/lib/dpkg/available -nt "$1" ]]
-	  }
+_rpms_caching_policy () {
+  local cache_path=3D"$1" cache_id=3D"${_cache_ident:-${1##*/}}"
+ =20
+  # rebuild if cache is more than a week old
+  oldp=3D( "$cache_path"(mw+1) )
+  (( $#oldp )) && return 0
+
+  if [[ $cache_id =3D RPMS_installed ]]; then
+    pkg_indices=3D( /var/lib/rpm/{packages.rpm,Packages}(N) )
+  else
+    pkg_indices=3D( /var/lib/apt/lists/*list*(.N) )
+  fi
+
+  for pkg_index in $pkg_indices; do
+    [[ "$pkg_index" -nt "$cache_path" ]] && return 0
+  done
+  return 1
+}
=20
 _rpm_packages "$@"
End of patch

This has a few tricks:

1) _cache_ident variable (found in _retrieve_cache) is used to determine
which cache is being checked for invalidation;

2) for installed RPM packages, cache invalidation is checked against RPM
database;

3) for packages which are not installed, cache invalidation is checked
against APT source repository files.  This is different from original
check against /var/cache/apt/pkgcache.bin -- this file gets rebuilt on
every apt-cache invocation.

I also noticed that in recent zsh versions additional support for held
and deinstalled packages was added to _deb_packages, but since RPM has
no simple notion of held/deinstalled packages, those functions are left
intact for now.

Please comment.

--=20
Alexey Tourbin
ALT Linux Team

--0eh6TmSyL6TZE2Uz
Content-Type: text/plain; charset=us-ascii
Content-Disposition: attachment; filename=_rpm_packages
Content-Transfer-Encoding: quoted-printable

#autoload

# Usage: _rpm_packages expl... avail|installed|uninstalled

_rpm_packages_update_avail () {
  if ( [[ ${+_rpm_packages_cache_avail} -eq 0 ]] ||
      _cache_invalid RPMS_avail ) && ! _retrieve_cache RPMS_avail;
  then
    _rpm_packages_cache_avail=3D(
      ${(f)"$(apt-cache --generate pkgnames)"}
    )

    _store_cache RPMS_avail _rpm_packages_cache_avail
  fi
  cachevar=3D_rpm_packages_cache_avail
}

_rpm_packages_update_installed () {
  if ( [[ ${+_rpm_packages_cache_installed} -eq 0 ]] ||
      _cache_invalid RPMS_installed ) && ! _retrieve_cache RPMS_installed;
  then
    _rpm_packages_cache_installed=3D(
      ${(f)"$(rpm -qa --qf '%{NAME}\n')"}
    )
    _store_cache RPMS_installed _rpm_packages_cache_installed
  fi
  cachevar=3D_rpm_packages_cache_installed
}

_rpm_packages_update_held () {
  if ( [[ ${+_rpm_packages_cache_held} -eq 0 ]] ||
      _cache_invalid RPMS_held ) && ! _retrieve_cache RPMS_held;
  then
    _rpm_packages_cache_held=3D()
    dpkg --get-selections | while read package state ; do
        [[ $state =3D hold ]] && _rpm_packages_cache_held+=3D$package
    done
    _store_cache RPMS_held _rpm_packages_cache_held
  fi
  cachevar=3D_rpm_packages_cache_held
}

_rpm_packages_update_deinstalled () {
  if ( [[ ${+_rpm_packages_cache_deinstalled} -eq 0 ]] ||
      _cache_invalid RPMS_deinstalled ) && ! _retrieve_cache RPMS_deinstall=
ed;
  then
    _rpm_packages_cache_deinstalled=3D()
    dpkg --get-selections | while read package state ; do
        [[ $state =3D deinstall ]] && _rpm_packages_cache_deinstalled+=3D$p=
ackage
    done
    _store_cache RPMS_deinstalled _rpm_packages_cache_deinstalled
  fi
  cachevar=3D_rpm_packages_cache_deinstalled
}

_rpm_packages_update_xinstalled () {
  if ( [[ ${+_rpm_packages_cache_xinstalled} -eq 0 ]] ||
      _cache_invalid RPMS_xinstalled ) && ! _retrieve_cache RPMS_xinstalled;
  then
    _rpm_packages_cache_xinstalled=3D()
    dpkg --get-selections | while read package state ; do
        _rpm_packages_cache_xinstalled+=3D$package
    done
    _store_cache RPMS_xinstalled _rpm_packages_cache_xinstalled
  fi
  cachevar=3D_rpm_packages_cache_xinstalled
}

_rpm_packages_update_uninstalled () {
  _rpm_packages_update_avail
  _rpm_packages_update_installed
  if (( ! $+_rpm_packages_cache_uninstalled )); then
    _rpm_packages_cache_uninstalled=3D(
      ${_rpm_packages_cache_avail:#${(j:|:)~${_rpm_packages_cache_installed=
:q}}}
    )
  fi
  cachevar=3D_rpm_packages_cache_uninstalled
}

_rpm_packages () {
  local command=3D"$argv[$#]" expl cachevar pkgset update_policy

  zstyle -s ":completion:*:*:$service:*" cache-policy update_policy
  if [[ -z "$update_policy" ]]; then
    zstyle ":completion:*:*:$service:*" cache-policy _rpms_caching_policy
  fi

  [[ "$command" =3D (installed|deinstalled|xinstalled|held|uninstalled|avai=
l|available) ]] || {
    _message "unknown command: $command"
    return
  }

  zstyle -s ":completion:${curcontext}:" packageset pkgset

  [[ "$pkgset" =3D (installed|deinstalled|xinstalled|held|uninstalled|avail=
|available) ]] || {
    pkgset=3D"$command"
  }

  [[ "$pkgset" =3D "available" ]] && pkgset=3D"avail"

  expl=3D("${(@)argv[1,-2]}")

  _rpm_packages_update_$pkgset

  _tags packages && compadd "$expl[@]" - "${(@P)cachevar}"
}

_rpms_caching_policy () {
  local cache_path=3D"$1" cache_id=3D"${_cache_ident:-${1##*/}}"
 =20
  # rebuild if cache is more than a week old
  oldp=3D( "$cache_path"(mw+1) )
  (( $#oldp )) && return 0

  if [[ $cache_id =3D RPMS_installed ]]; then
    pkg_indices=3D( /var/lib/rpm/{packages.rpm,Packages}(N) )
  else
    pkg_indices=3D( /var/lib/apt/lists/*list*(.N) )
  fi

  for pkg_index in $pkg_indices; do
    [[ "$pkg_index" -nt "$cache_path" ]] && return 0
  done
  return 1
}

_rpm_packages "$@"

--0eh6TmSyL6TZE2Uz--

--s9fJI615cBHmzTOP
Content-Type: application/pgp-signature
Content-Disposition: inline

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.2.5 (GNU/Linux)

iD8DBQFCMWeLfBKgtDjnu0YRAsQkAKDNEX78oYSYdy3oMacYv8YXZ/LL9gCg3O/8
qXPi5BODA8xbrhoPW6/SXJc=
=wipr
-----END PGP SIGNATURE-----

--s9fJI615cBHmzTOP--

