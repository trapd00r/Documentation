From zsh-workers-return-9550-mason-zsh=primenet.com.au@sunsite.auc.dk Thu Feb 03 18:41:25 2000
Return-Path: <zsh-workers-return-9550-mason-zsh=primenet.com.au@sunsite.auc.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 20781 invoked from network); 3 Feb 2000 18:41:23 -0000
Received: from sunsite.auc.dk (130.225.51.30)
  by ns1.primenet.com.au with SMTP; 3 Feb 2000 18:41:23 -0000
Received: (qmail 5575 invoked by alias); 3 Feb 2000 18:41:14 -0000
Mailing-List: contact zsh-workers-help@sunsite.auc.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.auc.dk
X-Seq: 9550
Received: (qmail 5567 invoked from network); 3 Feb 2000 18:41:12 -0000
From: "Bart Schaefer" <schaefer@candle.brasslantern.com>
Message-Id: <1000203184102.ZM7939@candle.brasslantern.com>
Date: Thu, 3 Feb 2000 18:41:02 +0000
In-Reply-To: <20000201112129.A772@stealth.net>
Comments: In reply to Christophe Kalt <kalt@stealth.net>
        "LC_CTYPE weirdness" (Feb  1, 11:21am)
References: <20000201112129.A772@stealth.net>
X-Mailer: Z-Mail (5.0.0 30July97)
To: Christophe Kalt <kalt@stealth.net>, zsh-workers@sunsite.auc.dk
Subject: Re: LC_CTYPE weirdness
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii

Sorry for the delay in responding.

On Feb 1, 11:21am, Christophe Kalt wrote:
} Subject: LC_CTYPE weirdness
}
} i have a line "export LC_CTYPE=iso_8859_1" in one of my startup
} files, and it used to work fine.  I recently got a new laptop,
} and went on to install the same OS, but while reinstalling
} packages, i ended up upgrading zsh from 3.0.5 to 3.0.7.
} 
} anyhow, for some reason, LC_CTYPE doesn't seem to get
} exported, yet it is set (as a variable).

The problem is that all the LC_* parameters have the PM_UNSET flag set
when they are defined as a special parameter.  During typeset_single()
in builtin.c, at around line 2865, there's this test:

		if (!(pm->flags & PM_UNSET) && !pm->env)
		    pm->env = addenv(pname, value ? value : getsparam(pname));

So the variable won't be exported, because it appears to be unset.  Once
it has become set, then the PM_UNSET flag is gone from the new setting;
hence:

} splitting the line in two ("LC_CTYPE=iso_8859_1;export LC_CTYPE") fixes
} the problem.

This is obviously wrong, and it doesn't fail this way in 3.1.6, but I
have not yet had time to track down what the differences are.  PWS, if
you have some insight, it would be appreciated.

-- 
Bart Schaefer                                 Brass Lantern Enterprises
http://www.well.com/user/barts              http://www.brasslantern.com

