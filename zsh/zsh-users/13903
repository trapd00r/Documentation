From zsh-users-return-13903-mason-zsh=primenet.com.au@sunsite.dk Thu Mar 12 20:42:12 2009
Return-Path: <zsh-users-return-13903-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 5845 invoked from network); 12 Mar 2009 20:42:06 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 12 Mar 2009 20:42:06 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 57771 invoked from network); 12 Mar 2009 20:39:44 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 12 Mar 2009 20:39:44 -0000
Received: (qmail 20655 invoked by alias); 12 Mar 2009 20:39:23 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 13903
Received: (qmail 20638 invoked from network); 12 Mar 2009 20:39:23 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 12 Mar 2009 20:39:23 -0000
Received: from mtaout03-winn.ispmail.ntl.com (mtaout03-winn.ispmail.ntl.com [81.103.221.49])
	by bifrost.dotsrc.org (Postfix) with ESMTP id C237880307F8
	for <zsh-users@sunsite.dk>; Thu, 12 Mar 2009 21:39:13 +0100 (CET)
Received: from aamtaout03-winn.ispmail.ntl.com ([81.103.221.35])
          by mtaout03-winn.ispmail.ntl.com
          (InterMail vM.7.08.04.00 201-2186-134-20080326) with ESMTP
          id <20090312203912.CROR7670.mtaout03-winn.ispmail.ntl.com@aamtaout03-winn.ispmail.ntl.com>
          for <zsh-users@sunsite.dk>; Thu, 12 Mar 2009 20:39:12 +0000
Received: from pws-pc ([81.107.42.185]) by aamtaout03-winn.ispmail.ntl.com
          (InterMail vG.2.02.00.01 201-2161-120-102-20060912) with ESMTP
          id <20090312203912.XYAJ2093.aamtaout03-winn.ispmail.ntl.com@pws-pc>
          for <zsh-users@sunsite.dk>; Thu, 12 Mar 2009 20:39:12 +0000
Date: Thu, 12 Mar 2009 20:38:18 +0000
From: Peter Stephenson <p.w.stephenson@ntlworld.com>
To: zsh-users@sunsite.dk
Subject: Re: Bug in vi-mode search
Message-ID: <20090312203818.3eeee7a5@pws-pc>
In-Reply-To: <20090312165530.GA1834@lorien.comfychair.org>
References: <20090312165530.GA1834@lorien.comfychair.org>
X-Mailer: Claws Mail 3.7.0 (GTK+ 2.14.7; x86_64-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
X-Cloudmark-Analysis: v=1.0 c=1 a=PgGVwa0UAAAA:8 a=NLZqzBF-AAAA:8 a=APSTHtmnavMY0oKHUokA:9 a=uxDncSO70H2WjYF5QqkA:7 a=WVZFZ26pJDK6ViN49d3JW4aisP4A:4 a=LY0hPdMaydYA:10 a=TDGUi1Mx4R4A:10 a=_dQi-Dcv4p4A:10
X-Virus-Scanned: ClamAV 0.92.1/9101/Thu Mar 12 16:30:26 2009 on bifrost
X-Virus-Status: Clean

On Thu, 12 Mar 2009 09:55:30 -0700
Danek Duvall <duvall@comfychair.org> wrote:
>     When using vi keybindings (set -o vi) history search is initiated by
>     ESC-/. The searching appears to be broken:
> 
>     The initial history line returned is correct but subsequent entries (by
>     repeatedly pressing '/') returned don't have the search string in them
>     and appear to simply be sequential entries from the history file.

Yes, this looks like a simple screwup when changing the code.

I've also noticed I unintentionally removed the "_" that appears where
the next character is to be inserted.

See if this is better.

(Diff against the files in the Git repository Wayne set up while we wait
for CVS to recover, at which point it will be committed.)

--- ../zsh-git/zsh/Src/Zle/zle_hist.c	2009-03-12 20:34:56.000000000 +0000
+++ Src/Zle/zle_hist.c	2009-03-12 20:18:29.000000000 +0000
@@ -1742,7 +1742,7 @@
     selectkeymap("main", 1);
     while (sptr) {
 	sbuf[sptr] = '_';
-	sbuf[sptr] = '\0';
+	sbuf[sptr+1] = '\0';
 	zrefresh();
 	if (!(cmd = getkeycmd()) || cmd == Th(z_sendbreak)) {
 	    ret = 0;
@@ -1760,6 +1760,10 @@
 	    	cmd == Th(z_vicmdmode)) {
 	    sbuf[sptr] = ZWC('\0');
 	    visrchstr = ztrdup(sbuf+1);
+	    if (!strlen(visrchstr)) {
+	        zsfree(visrchstr);
+		visrchstr = ztrdup(vipenultsrchstr);
+	    }
 	    ret = 1;
 	    sptr = 0;
 	} else if(cmd == Th(z_backwarddeletechar) ||


-- 
Peter Stephenson <p.w.stephenson@ntlworld.com>
Web page now at http://homepage.ntlworld.com/p.w.stephenson/

