From zsh-workers-return-26985-mason-zsh=primenet.com.au@sunsite.dk Sat May 23 16:55:23 2009
Return-Path: <zsh-workers-return-26985-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 13716 invoked from network); 23 May 2009 16:55:11 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received: from new-brage.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.254.104)
  by ns1.primenet.com.au with SMTP; 23 May 2009 16:55:11 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 86342 invoked from network); 23 May 2009 16:55:07 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 23 May 2009 16:55:07 -0000
Received: (qmail 15101 invoked by alias); 23 May 2009 16:55:02 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 26985
Received: (qmail 15080 invoked from network); 23 May 2009 16:55:01 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 23 May 2009 16:55:01 -0000
Received: from vms173007pub.verizon.net (vms173007pub.verizon.net [206.46.173.7])
	by bifrost.dotsrc.org (Postfix) with ESMTP id 6026D8027106
	for <zsh-workers@sunsite.dk>; Sat, 23 May 2009 18:54:58 +0200 (CEST)
Received: from torch.brasslantern.com ([96.249.201.13])
 by vms173007.mailsrvcs.net
 (Sun Java(tm) System Messaging Server 6.3-7.04 (built Sep 26 2008; 32bit))
 with ESMTPA id <0KK300KFUWBAQ2S1@vms173007.mailsrvcs.net> for
 zsh-workers@sunsite.dk; Sat, 23 May 2009 11:54:47 -0500 (CDT)
Received: from torch.brasslantern.com (localhost.localdomain [127.0.0.1])
	by torch.brasslantern.com (8.13.1/8.13.1) with ESMTP id n4NGsjfn018446	for
 <zsh-workers@sunsite.dk>; Sat, 23 May 2009 09:54:46 -0700
Received: (from schaefer@localhost)	by torch.brasslantern.com
 (8.13.1/8.13.1/Submit) id n4NGsjIJ018445	for zsh-workers@sunsite.dk; Sat,
 23 May 2009 09:54:45 -0700
From: Bart Schaefer <schaefer@brasslantern.com>
Message-id: <090523095445.ZM18444@torch.brasslantern.com>
Date: Sat, 23 May 2009 09:54:43 -0700
In-reply-to: <slrnh1g2tk.2ud.joerg@alea.gnuu.de>
Comments: In reply to ( Text in unknown character set UTF-8 not shown )  Sommer
 <joerg@alea.gnuu.de>        "zsh prompt eates up my screen :)" (May 23,
 2:44pm)
References: <slrnh1g2tk.2ud.joerg@alea.gnuu.de>
X-Mailer: OpenZMail Classic (0.9.2 24April2005)
To: zsh-workers@sunsite.dk
Subject: Re: zsh prompt eates up my screen :)
MIME-version: 1.0
Content-type: text/plain; charset=us-ascii
X-Virus-Scanned: ClamAV 0.94.2/9383/Fri May 22 17:58:11 2009 on bifrost
X-Virus-Status: Clean

On May 23,  2:44pm, Joerg wrote:
}
} % zsh -f
} ibook% TRAPALRM() { PS1=${(l:$COLUMNS::xx:)}$'\nline 2%% '; zle reset-prompt; }
} ibook% TMOUT=2
} 
} At me (4.3.9), the line with the xs walks up into the first line of the
} screen and stays there. If I use fewer than $COLUMNS characters in the
} line, it works as expected. It looks like a length calculation is wrong.

The calculation is correct, what's wrong (and nearly impossible to get
right) is the assumption about what happens when a character is printed
to the rightmost column.

The prompt code is assuming [possibly based on bad terminfo description,
but maybe not] that when the rightmost "x" is printed, the terminal will
immediately wrap to the next line.  Therefore the $'\n' that follows is
assumed to create a blank line, so that "line 2% " is believed to appear
on a THIRD line.

What's happening instead is that the terminal silently swallows a newline
at that position, leaving zle with an inaccurate internal picture of the
screen state.

What makes this so difficult is that different terminals handle this in
different ways, and it's frequently not possible to tell from terminfo
exactly what is going to happen.

The "bart" prompt theme goes to some length to avoid ever printing to
the rightmost screen column for exactly this reason.

-- 

