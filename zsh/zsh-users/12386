From zsh-users-return-12386-mason-zsh=primenet.com.au@sunsite.dk Sat Jan 05 15:45:51 2008
Return-Path: <zsh-users-return-12386-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 5253 invoked from network); 5 Jan 2008 15:45:42 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.3 (2007-08-08) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.2 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.3
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 5 Jan 2008 15:45:42 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 49765 invoked from network); 5 Jan 2008 15:45:17 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 5 Jan 2008 15:45:17 -0000
Received: (qmail 25977 invoked by alias); 5 Jan 2008 15:45:06 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 12386
Received: (qmail 25963 invoked from network); 5 Jan 2008 15:45:06 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 5 Jan 2008 15:45:06 -0000
Received: from virusfilter.dotsrc.org (bifrost [127.0.0.1])
	by spamfilter.dotsrc.org (Postfix) with ESMTP id CB1A68058FF2
	for <zsh-users@sunsite.dk>; Sat,  5 Jan 2008 16:45:03 +0100 (CET)
Received: from smtp.tt-solutions.com (sunset.tt-solutions.com [82.238.156.189])
	by bifrost.dotsrc.org (Postfix) with ESMTP
	for <zsh-users@sunsite.dk>; Sat,  5 Jan 2008 16:45:02 +0100 (CET)
Received: from nightfall ([192.168.17.76])
	by smtp.tt-solutions.com with esmtp (Exim 4.63)
	(envelope-from <vz-zsh@zeitlins.org>)
	id 1JBBCn-0001ih-Ef
	for zsh-users@sunsite.dk; Sat, 05 Jan 2008 16:45:01 +0100
Date: Sat, 5 Jan 2008 16:45:01 +0100
From: Vadim Zeitlin <vz-zsh@zeitlins.org>
Subject: how to complete argument only if an option was specified?
To: zsh-users@sunsite.dk
MIME-Version: 1.0
Content-Type: TEXT/PLAIN; CHARSET=US-ASCII
Content-Disposition: INLINE
X-Mailer: Mahogany 0.67.0 'Constance', running under Windows Server 2003 (build 3790, Service Pack 1)
X-Virus-Scanned: ClamAV using ClamSMTP
Message-Id: <20080105154503.CB1A68058FF2@bifrost.dotsrc.org>

 Hello,

 I'm trying to write a completer for htpasswd command (both because it's
useful on its own and as an exercise before writing more complicated
completer for a custom command) but I'm unable to find a way to complete an
argument only if a specified option was given with _arguments. Here is my
current attempt:

#compdef htpasswd

local users
users() {
    compadd $expl[@] $(cut -d: -f1 $line[1])
}

local enc # encryption options (all mutually exclusive)
enc='-m -d -p -s'

_arguments -s \
    '(-D)-c[Create a new file]' \
    '-n[Don''t update file; display results on stdout]' \
    "($enc)-m[Force MD5 encryption of the password]" \
    "($enc)-d[Force CRYPT encryption of the password (default)]" \
    "($enc)-p[Do not encrypt the password (plaintext)]" \
    "($enc)-s[Force SHA encryption of the password]" \
    '(-c)-D[Delete the specified user]' \
    ':password file:_files' \
    ':name of the user:users' \
  - withoutpassword \
  - withpassword \
    '-b[Use the password from the command line rather than prompting for it]' \
    ':password for this user:' && return 0

Unfortunately (but not unexpectedly) it doesn't work and the password is
always completed. This is not a huge problem, of course, as I don't
complete it anyhow but it's annoying and I'd like to know how to deal with
this for my more complicated custom command completer anyhow. So is there
any way to complete password argument only if "-b" option had been given? I
suspect that it can't be done with just _arguments but I don't know what
would be the best/easiest way to do it otherwise.

 Thanks in advance for any hints (or complete solutions :-),
VZ

