From zsh-users-return-14541-mason-zsh=primenet.com.au@zsh.org Wed Nov 11 04:57:10 2009
Return-Path: <zsh-users-return-14541-mason-zsh=primenet.com.au@zsh.org>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 9259 invoked by alias); 11 Nov 2009 04:57:10 -0000
Mailing-List: contact zsh-users-help@zsh.org; run by ezmlm
Precedence: bulk
X-No-Archive: yes
List-Id: Zsh Users List <zsh-users.zsh.org>
List-Post: <mailto:zsh-users@zsh.org>
List-Help: <mailto:zsh-users-help@zsh.org>
Delivered-To: mailing list zsh-users@zsh.org
X-Seq: 14541
Received: (qmail 21595 invoked from network); 11 Nov 2009 04:57:08 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received-SPF: none (ns1.primenet.com.au: domain at closedmail.com does not designate permitted sender hosts)
From: Bart Schaefer <schaefer@brasslantern.com>
Message-id: <091110195643.ZM28644@torch.brasslantern.com>
Date: Tue, 10 Nov 2009 19:56:43 -0800
In-reply-to: <10081257897632@webmail89.yandex.ru>
Comments: In reply to Dmitry Bolshakov <bdimych@narod.ru>
 "the function to show a digit argument while it is being typed" (Nov 11,
 3:00am)
References: <10081257897632@webmail89.yandex.ru>
X-Mailer: OpenZMail Classic (0.9.2 24April2005)
To: zsh-users@zsh.org
Subject: Re: the function to show a digit argument while it is being typed
MIME-version: 1.0
Content-type: text/plain; charset=us-ascii

On Nov 11,  3:00am, Dmitry Bolshakov wrote:
} Subject: the function to show a digit argument while it is being typed
}
} in bash a digit argument is showed when it is being typed
} 
} i have writed small function which do the same

That's very nice, but it shouldn't need to be that complex.  ZLE will
make sure that your function is never called except when $KEYS[2] is a
digit, so you don't need to do your own loop to read more keys.

    function digit-argument-show {
      typeset -g __digit_arg
      if [[ $LASTWIDGET != *-argument ]]
      then
        __digit_arg=""
        PREDISPLAY=""
      fi
      __digit_arg+=$KEYS[2]
      PREDISPLAY="(arg: $__digit_arg) "
      zle -R
      zle .digit-argument
    }

    function neg-argument-show {
      typeset -g __digit_arg=-
      zle .neg-argument
    }

Aha, I see the problem with that ... you need to erase PREDISPLAY after
the last digit-argument has happened.  There's still a simpler way than
writing your own loop, namely by using zle read-command.

    function digit-argument-show {
      typeset -g __digit_arg
      if [[ $LASTWIDGET != (digit|neg)-argument ]]
      then
        __digit_arg=""
        PREDISPLAY=""
      fi
      __digit_arg+=$KEYS[2]
      PREDISPLAY="(arg: $__digit_arg) "
      zle -R
      zle .digit-argument
      local REPLY        # Not strictly necessary
      zle read-command   # Sets $REPLY and $KEYS
      if [[ $REPLY != digit-argument ]]
      then
        __digit_arg=""
        PREDISPLAY=""
      fi
      zle -U $KEYS
    }

