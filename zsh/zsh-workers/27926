From zsh-workers-return-27926-mason-zsh=primenet.com.au@zsh.org Mon Apr 26 22:52:30 2010
Return-Path: <zsh-workers-return-27926-mason-zsh=primenet.com.au@zsh.org>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 8054 invoked by alias); 26 Apr 2010 22:52:30 -0000
Mailing-List: contact zsh-workers-help@zsh.org; run by ezmlm
Precedence: bulk
X-No-Archive: yes
List-Id: Zsh Workers List <zsh-workers.zsh.org>
List-Post: <mailto:zsh-workers@zsh.org>
List-Help: <mailto:zsh-workers-help@zsh.org>
Delivered-To: mailing list zsh-workers@zsh.org
X-Seq: 27926
Received: (qmail 3216 invoked from network); 26 Apr 2010 22:52:16 -0000
X-Spam-Checker-Version: SpamAssassin 3.3.1 (2010-03-16) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-1.9 required=5.0 tests=BAYES_00 autolearn=ham
	version=3.3.1
Received-SPF: pass (ns1.primenet.com.au: SPF record at ntlworld.com designates 81.103.221.31 as permitted sender)
Date: Mon, 26 Apr 2010 23:38:40 +0100
From: Peter Stephenson <p.w.stephenson@ntlworld.com>
To: zsh-workers@zsh.org
Cc: 579209@bugs.debian.org
Subject: Re: zsh: insert-last-word problem after completion
Message-ID: <20100426233840.67d4934c@pws-pc>
In-Reply-To: <20100426154210.GD25015@prunille.vinc17.org>
References: <20100426105331.GC25015@prunille.vinc17.org>
	<20100426131139.6e7311a7@csr.com>
	<20100426154210.GD25015@prunille.vinc17.org>
X-Mailer: Claws Mail 3.7.5 (GTK+ 2.18.9; x86_64-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
X-Cloudmark-Analysis: v=1.1 cv=1ggfb5FlKZQUfF3vzm9UBYZ2uTfLsbs/8dSljwg5+mE= c=1 sm=0 a=VbsL5WT3bp8A:10 a=DogomfpGjd0A:10 a=kj9zAlcOel0A:10 a=YR4_K0clAAAA:8 a=NLZqzBF-AAAA:8 a=ng96z30XWXQXmv9rQS0A:9 a=pjaeqjhxgyBNJ32oNFwA:7 a=Ike6sbDYTN6gETN9KsWGNCmhiNUA:4 a=CjuIK1q_8ugA:10 a=8EUp7cGwtfYA:10 a=_dQi-Dcv4p4A:10 a=HpAAvcLHHh0Zw7uRqdWCyQ==:117

On Mon, 26 Apr 2010 17:42:10 +0200
Vincent Lefevre <vincent@vinc17.net> wrote:
> On 2010-04-26 13:11:39 +0100, Peter Stephenson wrote:
> > On Mon, 26 Apr 2010 12:53:31 +0200
> > Vincent Lefevre <vincent@vinc17.net> wrote:
> > > After a "zsh -f":
> > > 
> > > % alias my_echo=echo
> > > % false
> > > % true &
> > > % my_ech[TAB]
> > > 
> > > A succession of [ESC] . (bound to insert-last-word) gives:
> > > 
> > >   my_echo&
> > >   my_echo&&
> > >   my_echo&false
> 
> Actually I noticed the bug with the new completion system.

I've got there, too, eventually.

There are two ways to approach this: either have the "&" inserted as
now, with the space removed, which is the same as if the "&" was typed;
or fix the suffix when inserting the last word.  The drawback with the
former (which is what it's currently trying to do, but failing) is that
replacing the & with earlier words would leave the space before it
removed, and in most cases that won't be the right thing to do (you'd
get "my_echofalse" in this case).  So I think the latter is the right
answer---we know that what we're inserting always functions as a
complete word, hence fixing the space or whatever makes more sense even
if in the case of the first last word you happen not to need it.
This happens to be the simpler fix (though I have an implementation of
the other one, too).

By the way, as an alternative to smart-insert-last-word, what I do is
have the widget copy-earlier-word bound to ESC = so that I can get
earlier words from the line to which ESC . has taken me.

Index: Src/Zle/zle_hist.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/zle_hist.c,v
retrieving revision 1.64
diff -p -u -r1.64 zle_hist.c
--- Src/Zle/zle_hist.c	18 Mar 2010 16:03:20 -0000	1.64
+++ Src/Zle/zle_hist.c	26 Apr 2010 22:29:11 -0000
@@ -634,6 +634,7 @@ insertlastword(char **args)
 	}
     }
 
+    fixsuffix();
     metafy_line();
     if (lastinsert && lastlen &&
 	lastpos <= zlemetacs &&

-- 
Peter Stephenson <p.w.stephenson@ntlworld.com>
Web page now at http://homepage.ntlworld.com/p.w.stephenson/

