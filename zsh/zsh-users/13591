From zsh-users-return-13591-mason-zsh=primenet.com.au@sunsite.dk Thu Dec 11 17:34:29 2008
Return-Path: <zsh-users-return-13591-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 17071 invoked from network); 11 Dec 2008 17:34:26 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 11 Dec 2008 17:34:26 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 89825 invoked from network); 11 Dec 2008 17:34:14 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 11 Dec 2008 17:34:14 -0000
Received: (qmail 1973 invoked by alias); 11 Dec 2008 17:33:58 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 13591
Received: (qmail 1961 invoked from network); 11 Dec 2008 17:33:58 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 11 Dec 2008 17:33:58 -0000
Received: from wa-out-1112.google.com (wa-out-1112.google.com [209.85.146.181])
	by bifrost.dotsrc.org (Postfix) with ESMTP id 0986080524C3
	for <zsh-users@sunsite.dk>; Thu, 11 Dec 2008 18:33:49 +0100 (CET)
Received: by wa-out-1112.google.com with SMTP id n7so606820wag.29
        for <zsh-users@sunsite.dk>; Thu, 11 Dec 2008 09:33:48 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=gamma;
        h=domainkey-signature:received:received:message-id:date:from:to
         :subject:in-reply-to:mime-version:content-type
         :content-transfer-encoding:content-disposition:references;
        bh=xWKrdUTh/P0kbJ5b0Z7nLVDkIoyezJHueSQ6ACnQ2Ig=;
        b=dOUqX8C26rL0yflZz5mGC9IZ1+O6pj60+a0TecUl0ILww/klMjiUOotfcHTvrERDoP
         FqLHP9x3Oj5/BGqPJXiEN5I88ASVtsNGUbAPvjlVomfNIyyjtX22XK+903smSW5hnuhn
         HyPjzQqPtT3jnjTVUMchlc5qBnN2xQDGDDShk=
DomainKey-Signature: a=rsa-sha1; c=nofws;
        d=gmail.com; s=gamma;
        h=message-id:date:from:to:subject:in-reply-to:mime-version
         :content-type:content-transfer-encoding:content-disposition
         :references;
        b=PSSuqY6gM6PKHFdgezTG6UtQg58Dp6rDzfe24mEsOmalkys5DQV/xbKQWjf5+EugeX
         6lFISMk84KDKyHJerBU5o9i40qmSx8XY6o7WUYFPy4avx5spyIBysI8ZpkmsHRG4dINv
         5F5LGJM8rCYgBjLO76fPc8opD0nlJYs+d6afk=
Received: by 10.114.121.1 with SMTP id t1mr2006252wac.183.1229016828099;
        Thu, 11 Dec 2008 09:33:48 -0800 (PST)
Received: by 10.114.88.17 with HTTP; Thu, 11 Dec 2008 09:33:48 -0800 (PST)
Message-ID: <6cd6de210812110933i533eb92ei7f603673af235fa5@mail.gmail.com>
Date: Thu, 11 Dec 2008 12:33:48 -0500
From: "Rocky Bernstein" <rocky.bernstein@gmail.com>
To: "Zsh users list" <zsh-users@sunsite.dk>
Subject: Re: Testing if a file is a terminal?
In-Reply-To: <6cd6de210812090847i1d0d76b8wf107e5c8ea2f0f9e@mail.gmail.com>
MIME-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: quoted-printable
Content-Disposition: inline
References: <6cd6de210812090847i1d0d76b8wf107e5c8ea2f0f9e@mail.gmail.com>
X-Virus-Scanned: ClamAV 0.92.1/8746/Thu Dec 11 05:14:26 2008 on bifrost
X-Virus-Status: Clean

David Korn has weighed in on this with respect to ksh.

Here is code along he lines he has suggested (my formatting and other
small changes which may have introduced bugs):

#
# Return 1 if $1 is a tty else 0.
#
function _Dbg_is_tty {
    (( $# !=3D 1 )) && return 1
    [[ ! -r $1 ]] || [[ ! -w $1 ]] && return 1
    typeset -i fd
    typeset -i r=3D1
    # Code courtesy of David Korn:
    {
=09if exec {fd}< $1 ; then
=09    if [[ -t $fd  ]] ; then
=09=09r=3D0
=09=09exec {fd}<&-
=09    fi
=09fi;
    } 2> /dev/null

    return $r
}

An advantage to this is that it's portable across zsh and ksh and if
one removes the {fd} also bash.
(Chet may eventually add  {fd}.)

David Korn also writes:

The -t test checks for more than the major device number.  There might
be several devices that emulate a terminal, ptys, ttys, modems,
consoles. The -t test checks whether tcgetattr() can be called with
this file descriptor on the file.

A disadvantage: if a FIFO is passed, the -t test could have a slight
side effect. If you passed the name of a FIFO that hadn't previously
been opened,  the opening and closing it could have a side effect
since the open will cause the other end of the FIFO to unblock.
Therefore it might make sense to screen these out before the a -t
test.

As before, I welcome comments and thoughts on this and where zsh
differs from ksh with respect to the above code.

Thanks again.

On Tue, Dec 9, 2008 at 11:47 AM, Rocky Bernstein
<rocky.bernstein@gmail.com> wrote:
> First, many thanks to Peter and St=E9phane for the very informative
> answers on terminal redirection.
>
> Before allowing a terminal to be set, the zshdb debugger uses this test:
>
>    [[ -r "$1" && -w "$1" ]] && return 0 # Ok
>
> $1 is a string --  the device name (e.g. /dev/pts/1) -- not a file descri=
ptor.
>
> But is this really the best one can do? I suppose on could also add a
> test if the device is a character device but I just wonder if there
> isn't a better way.
>
> isatty()  works on a file descriptor, but we don't have that yet. I
> suppose one could try to open that and then test but then care needs
> to be made to use that opened file descriptor and not say close and
> reopen that.
>
> Any other thoughts or suggestions?
>
> Thanks again.
>

