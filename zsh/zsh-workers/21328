From zsh-workers-return-21328-mason-zsh=primenet.com.au@sunsite.dk Sun Jun 12 19:39:31 2005
Return-Path: <zsh-workers-return-21328-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 21401 invoked from network); 12 Jun 2005 19:39:30 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 12 Jun 2005 19:39:30 -0000
Received: (qmail 6706 invoked from network); 12 Jun 2005 19:39:25 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 12 Jun 2005 19:39:24 -0000
Received: (qmail 15438 invoked by alias); 12 Jun 2005 19:39:21 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 21328
Received: (qmail 15428 invoked from network); 12 Jun 2005 19:39:20 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 12 Jun 2005 19:39:20 -0000
Received: (qmail 6376 invoked from network); 12 Jun 2005 19:39:20 -0000
Received: from vms048pub.verizon.net (206.46.252.48)
  by a.mx.sunsite.dk with SMTP; 12 Jun 2005 19:39:16 -0000
Received: from candle.brasslantern.com ([4.11.1.68])
 by vms048.mailsrvcs.net (Sun Java System Messaging Server 6.2 HotFix 0.04
 (built Dec 24 2004)) with ESMTPA id <0IHZ006ZWL9EJ6WJ@vms048.mailsrvcs.net> for
 zsh-workers@sunsite.dk; Sun, 12 Jun 2005 14:39:15 -0500 (CDT)
Received: from candle.brasslantern.com (IDENT:schaefer@localhost [127.0.0.1])
	by candle.brasslantern.com (8.12.11/8.12.11) with ESMTP id j5CJdDRA004789	for
 <zsh-workers@sunsite.dk>; Sun, 12 Jun 2005 12:39:14 -0700
Received: (from schaefer@localhost)	by candle.brasslantern.com
 (8.12.11/8.12.11/Submit) id j5CJdDNK004788	for zsh-workers@sunsite.dk; Sun,
 12 Jun 2005 12:39:13 -0700
Date: Sun, 12 Jun 2005 19:39:13 +0000
From: Bart Schaefer <schaefer@brasslantern.com>
Subject: Re: precmd() affecting the "r" command output
In-reply-to: <20050612170529.GA10725@clipper.ens.fr>
To: zsh-workers@sunsite.dk
Message-id: <1050612193913.ZM4787@candle.brasslantern.com>
MIME-version: 1.0
X-Mailer: Z-Mail (5.0.0 30July97)
Content-type: text/plain; charset=us-ascii
References: <20050612170529.GA10725@clipper.ens.fr>
Comments: In reply to Josselin Noirel <noirel@clipper.ens.fr>
 "precmd() affecting the "r" command output" (Jun 12,  7:05pm)
X-Spam-Checker-Version: SpamAssassin 3.0.2 on a.mx.sunsite.dk
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=6.0 tests=BAYES_00 autolearn=ham 
	version=3.0.2
X-Spam-Hits: -2.6

On Jun 12,  7:05pm, Josselin Noirel wrote:
} Subject: precmd() affecting the "r" command output
}
} precmd() is supposed to be executed once before each prompt (according
} to the man page) but here it is executed one more time, when "r" is
} executed.

I'm surprised no one has ever noticed this before (it's been happening
this way for *years*), but I think this is what's needed:

Index: Src/init.c
===================================================================
RCS file: /extra/cvsroot/zsh/zsh-4.0/Src/init.c,v
retrieving revision 1.20
diff -c -r1.20 init.c
--- Src/init.c	14 Apr 2005 04:33:51 -0000	1.20
+++ Src/init.c	12 Jun 2005 19:34:24 -0000
@@ -112,7 +112,7 @@
 	hbegin(1);		/* init history mech        */
 	if (isset(SHINSTDIN)) {
 	    setblock_stdin();
-	    if (interact) {
+	    if (interact && toplevel) {
 	        int hstop = stophist;
 		stophist = 3;
 		preprompt();

