From zsh-workers-return-23190-mason-zsh=primenet.com.au@sunsite.dk Mon Feb 26 15:15:59 2007
Return-Path: <zsh-workers-return-23190-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 14359 invoked from network); 26 Feb 2007 15:15:54 -0000
X-Spam-Checker-Version: SpamAssassin 3.1.8 (2007-02-13) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=BAYES_00,FORGED_RCVD_HELO
	autolearn=ham version=3.1.8
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 26 Feb 2007 15:15:54 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 57040 invoked from network); 26 Feb 2007 15:15:49 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 26 Feb 2007 15:15:49 -0000
Received: (qmail 6435 invoked by alias); 26 Feb 2007 15:15:46 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 23190
Received: (qmail 6425 invoked from network); 26 Feb 2007 15:15:45 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 26 Feb 2007 15:15:45 -0000
Received: (qmail 56799 invoked from network); 26 Feb 2007 15:15:45 -0000
Received: from cluster-c.mailcontrol.com (168.143.177.190)
  by a.mx.sunsite.dk with SMTP; 26 Feb 2007 15:15:36 -0000
Received: from cameurexb01.EUROPE.ROOT.PRI ([62.189.241.200])
	by rly07c.srv.mailcontrol.com (MailControl) with ESMTP id l1QFENs5005200
	for <zsh-workers@sunsite.dk>; Mon, 26 Feb 2007 15:15:15 GMT
Received: from news01.csr.com ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.1830);
	 Mon, 26 Feb 2007 15:15:05 +0000
Received: from news01.csr.com (localhost.localdomain [127.0.0.1])
	by news01.csr.com (8.13.8/8.13.4) with ESMTP id l1QFEuG9006598
	for <zsh-workers@sunsite.dk>; Mon, 26 Feb 2007 15:14:56 GMT
Received: from csr.com (pws@localhost)
	by news01.csr.com (8.13.8/8.13.8/Submit) with ESMTP id l1QFErqW006595
	for <zsh-workers@sunsite.dk>; Mon, 26 Feb 2007 15:14:56 GMT
Message-Id: <200702261514.l1QFErqW006595@news01.csr.com>
X-Authentication-Warning: news01.csr.com: pws owned process doing -bs
To: zsh-workers@sunsite.dk (Zsh hackers list)
Subject: PATCH: tweak _net_interfaces
Date: Mon, 26 Feb 2007 15:14:53 +0000
From: Peter Stephenson <pws@csr.com>
X-OriginalArrivalTime: 26 Feb 2007 15:15:05.0284 (UTC) FILETIME=[E4EB7840:01C759B8]
Content-Type: text/plain
MIME-Version: 1.0
X-Scanned-By: MailControl A-07-06-90 (www.mailcontrol.com) on 10.67.0.117

On Linux we use the /proc filing system to find network interfaces.
However, that doesn't find everything, in particular tunnels, which
both ifconfig and ip can manipulate.

The following tries to be safe by using the output of ifconfig unless it
didn't return any results.

Index: Completion/Unix/Type/_net_interfaces
===================================================================
RCS file: /cvsroot/zsh/zsh/Completion/Unix/Type/_net_interfaces,v
retrieving revision 1.3
diff -u -r1.3 _net_interfaces
--- Completion/Unix/Type/_net_interfaces	11 May 2005 09:27:10 -0000	1.3
+++ Completion/Unix/Type/_net_interfaces	26 Feb 2007 15:13:10 -0000
@@ -14,8 +14,19 @@
   ;;
   darwin*|freebsd*|dragonfly*) intf=( $(ifconfig -l) ) ;;
   irix*) intf=( ${${${(f)"$(/usr/etc/netstat -i)"}%% *}[2,-1]} ) ;;
-  linux*) intf=( /proc/sys/net/ipv4/conf/*~*(all|default)(N:t) ) ;;
-  *) intf=( $(ifconfig -a|sed -n 's/^\([^ 	:]*\).*/\1/p') ) ;;
+
+  *)
+  # Make sure ifconfig is in the path.
+  local PATH=$PATH
+  PATH=/sbin:$PATH
+  intf=( $(ifconfig -a 2>/dev/null | sed -n 's/^\([^ 	:]*\).*/\1/p') )
+  if [[${#intf} -eq 0 &&  -d /proc/sys/net/ipv4/conf ]]; then
+    # On linux we used to use the following as the default.
+    # However, we now use ifconfig since it finds additional devices such
+    # as tunnels.  So only do this if that didn't work.
+    intf=( /proc/sys/net/ipv4/conf/*~*(all|default)(N:t) )
+  fi
+  ;;
 esac
 
 _wanted interfaces expl 'network interface' \

-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070


To access the latest news from CSR copy this link into a web browser:  http://www.csr.com/email_sig.php

To get further information regarding CSR, please visit our Investor Relations page at http://ir.csr.com/csr/about/overview

