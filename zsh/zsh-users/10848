From zsh-users-return-10848-mason-zsh=primenet.com.au@sunsite.dk Thu Oct 12 15:01:20 2006
Return-Path: <zsh-users-return-10848-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 12400 invoked from network); 12 Oct 2006 15:01:14 -0000
X-Spam-Checker-Version: SpamAssassin 3.1.6 (2006-10-03) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=AWL,BAYES_00,
	FORGED_RCVD_HELO autolearn=ham version=3.1.6
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 12 Oct 2006 15:01:14 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 60545 invoked from network); 12 Oct 2006 15:01:02 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 12 Oct 2006 15:01:02 -0000
Received: (qmail 1259 invoked by alias); 12 Oct 2006 15:00:49 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 10848
Received: (qmail 1250 invoked from network); 12 Oct 2006 15:00:48 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 12 Oct 2006 15:00:48 -0000
Received: (qmail 58848 invoked from network); 12 Oct 2006 15:00:48 -0000
Received: from vms048pub.verizon.net (206.46.252.48)
  by a.mx.sunsite.dk with SMTP; 12 Oct 2006 15:00:46 -0000
Received: from torch.brasslantern.com ([71.116.118.106])
 by vms048.mailsrvcs.net
 (Sun Java System Messaging Server 6.2-4.02 (built Sep  9 2005))
 with ESMTPA id <0J71000IL2Y3KY5C@vms048.mailsrvcs.net> for
 zsh-users@sunsite.dk; Thu, 12 Oct 2006 09:58:52 -0500 (CDT)
Received: from torch.brasslantern.com (localhost.localdomain [127.0.0.1])
	by torch.brasslantern.com (8.13.1/8.13.1) with ESMTP id k9CEwoXO019539	for
 <zsh-users@sunsite.dk>; Thu, 12 Oct 2006 07:58:51 -0700
Received: (from schaefer@localhost)	by torch.brasslantern.com
 (8.13.1/8.13.1/Submit) id k9CEwo7O019538	for zsh-users@sunsite.dk; Thu,
 12 Oct 2006 07:58:50 -0700
Date: Thu, 12 Oct 2006 07:58:50 -0700
From: Bart Schaefer <schaefer@brasslantern.com>
Subject: Re: logout from interactive subshell
In-reply-to: <87ac41c0eo.fsf@asfast.com>
To: zsh-users@sunsite.dk
Message-id: <061012075850.ZM19537@torch.brasslantern.com>
MIME-version: 1.0
X-Mailer: OpenZMail Classic (0.9.2 24April2005)
Content-type: text/plain; charset=us-ascii
References: <237967ef0610120210r1d3a8c57n8850a4872b846c77@mail.gmail.com>
	<F7507090F1A72B43A51444325DFBE43101391E41@MCHP7R6A.ww002.siemens.net>
	<87ac41c0eo.fsf@asfast.com>
Comments: In reply to Lloyd Zusman <ljz@asfast.com>
 "Re: logout from interactive subshell" (Oct 12,  6:07am)

On Oct 12,  6:07am, Lloyd Zusman wrote:
}
} "Com MN PG P E B Consultant 3"
} <mn-pg-p-e-b-consultant-3.com@siemens.com> writes:
} 
} >    # Now I want to exit
} >    exit
} >    exit
} >    logout
} 
} Put this into your ~/.zlogin:
} 
}   [[ ${SHLVL:-0} == 1 ]] && {
}     export LOGINPID=$$
}   }
} 
} Then, after your "# Now I want to exit" comment (above), do this:
} 
}   kill -9 $LOGINPID

Yowtch.  This is the right idea, but "kill -9" is way overboard; that
kills the process instantly without letting it do any cleanup (like
saving history), and effectively orphans the sub-shells, which you are
then counting on to exit on their own.

Much better would be to use "kill -HUP" which tells the shell process
its terminal connection has been closed (even though it hasn't, really).
Zsh will then send HUP signals to all its children [*] and exit mostly
in the same manner as if you'd typed "logout".

[*] Unless you have "setopt no_hup" in which case you'll need to do
this a slightly different way.

So here's a variation of Lloyd's suggestion:

----
# This goes in ~/.zprofile for login shells only:
export LOGINPID=$$

# This goes in ~/.zshrc for all interactive shells:
if [[ ${LOGINPID:-$$} != $$ ]]
then function logout { kill -HUP $LOGINPID; exit }
fi
----

Now if you want to stop all the shells, you type "logout", and otherwise
you type "exit".

If you have "setopt no_hup" and only want to kill shells, leaving other
processes running in the background, modify the ~/.zshrc part:

----
# This goes in ~/.zshrc for all interactive shells:
trap logout USR1

if [[ ${LOGINPID:-$$} != $$ ]]
then
  function logout { kill -USR1 $PPID; exit }
fi
----

That should cause a chain of USR1 signals to climb up to the ultimate
login shell, with each shell exiting after passing along the signal.
You can pick another trappable signal if USR1 is not appropriate.

