From zsh-users-return-12126-mason-zsh=primenet.com.au@sunsite.dk Fri Oct 26 13:44:40 2007
Return-Path: <zsh-users-return-12126-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 16716 invoked from network); 26 Oct 2007 13:44:31 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.3 (2007-08-08) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.3
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 26 Oct 2007 13:44:31 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 46560 invoked from network); 26 Oct 2007 13:44:25 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 26 Oct 2007 13:44:25 -0000
Received: (qmail 21007 invoked by alias); 26 Oct 2007 13:44:17 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 12126
Received: (qmail 20987 invoked from network); 26 Oct 2007 13:44:16 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 26 Oct 2007 13:44:16 -0000
Received: (qmail 45343 invoked from network); 26 Oct 2007 13:44:16 -0000
Received: from smtpout0190.sc1.he.tucows.com (HELO n082.sc1.he.tucows.com) (64.97.136.190)
  by a.mx.sunsite.dk with SMTP; 26 Oct 2007 13:44:10 -0000
Received: from sc.homeunix.net (82.26.174.233) by n082.sc1.he.tucows.com (7.2.069.1)
        id 47030A3E001B322E; Fri, 26 Oct 2007 13:43:58 +0000
Received: from chazelas by sc.homeunix.net with local (Exim 4.68)
	(envelope-from <stephane_chazelas@yahoo.fr>)
	id 1IlPTc-0003kZ-32; Fri, 26 Oct 2007 14:43:52 +0100
Date: Fri, 26 Oct 2007 14:43:52 +0100
From: Stephane Chazelas <Stephane_Chazelas@yahoo.fr>
To: Peter Stephenson <pws@csr.com>
Cc: Zsh Users List <zsh-users@sunsite.dk>
Subject: Re: fc in non-interactive shells and vared
Message-ID: <20071026134352.GB5475@sc.homeunix.net>
Mail-Followup-To: Peter Stephenson <pws@csr.com>,
	Zsh Users List <zsh-users@sunsite.dk>
References: <20071026131442.GA5475@sc.homeunix.net> <200710261327.l9QDRd9b003931@news01.csr.com>
MIME-Version: 1.0
Content-Type: text/plain; charset=iso-8859-15
Content-Disposition: inline
Content-Transfer-Encoding: 8bit
In-Reply-To: <200710261327.l9QDRd9b003931@news01.csr.com>
User-Agent: Mutt/1.5.16 (2007-09-19)

On Fri, Oct 26, 2007 at 02:27:39PM +0100, Peter Stephenson wrote:
> Stephane Chazelas wrote:
> >   - I could not use fc to load/save a history file as fc refuses
> >     to work in non-interactive shells. Instead, I have to create
> >     a history file manually, read it line by line and use print
> >     -s to build the history stack.
> > 
> >     Is there a better way around that?
> 
> You can force a script to be run in interactive mode by including "-i"
> in the options to the shell.  This may have side effects, however.

Ok, thanks Peter, I will try that.

> >   - When "vared" returns, zsh prints a NL character. As I'm on
> >     the last line of the screen, this causes the screen to
> >     scroll. Is there any way to avoid that? I tried to do a stty
> >     onlret, but that doesn't work as vared resets the termios
> >     settings.
> 
> I suspect this is coming from the trashzle() when ZLE exits.  This is
> quite well buried.
> 
> I'm too lazy to try it, but if you have a sufficiently recent zsh you
> could try something like
> 
> zle-line-init() { stty onlret; }
> zle -N zle-line-init
[...]

I realised it wouldn't work anyway, I had misinterpreted what
onlret was doing. I just found another work around, I do
something like:

  accept-and-bye() {
    print -r -- "$BUFFER"
    stat +link -A pid /proc/self
    trap - TERM
    kill $pid
  }
  zle -N accept-and-bye
  bindkey '\r' accept-and-bye
  bindkey '\n' accept-and-bye
  a=
  search=$(vared -p "Search: " -eh a)

The /proc/self above makes it Linux specific though (exit
doesn't work: NL is still displayed).

I'll do more experiments by running zsh -c so that I can use $$.

-- 
Stéphane

