From zsh-workers-return-23495-mason-zsh=primenet.com.au@sunsite.dk Wed May 30 10:31:48 2007
Return-Path: <zsh-workers-return-23495-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 13912 invoked from network); 30 May 2007 10:31:45 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.0 (2007-05-01) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=AWL,BAYES_00 autolearn=no
	version=3.2.0
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 30 May 2007 10:31:45 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 17783 invoked from network); 30 May 2007 10:31:39 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 30 May 2007 10:31:39 -0000
Received: (qmail 7236 invoked by alias); 30 May 2007 10:31:36 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 23495
Received: (qmail 7227 invoked from network); 30 May 2007 10:31:35 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 30 May 2007 10:31:35 -0000
Received: (qmail 17501 invoked from network); 30 May 2007 10:31:35 -0000
Received: from cluster-c.mailcontrol.com (168.143.177.190)
  by a.mx.sunsite.dk with SMTP; 30 May 2007 10:31:30 -0000
Received: from cameurexb01.EUROPE.ROOT.PRI ([62.189.241.200])
	by rly18c.srv.mailcontrol.com (MailControl) with ESMTP id l4UAVDt5015097
	for <zsh-workers@sunsite.dk>; Wed, 30 May 2007 11:31:23 +0100
Received: from news01.csr.com ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.1830);
	 Wed, 30 May 2007 11:29:34 +0100
Date: Wed, 30 May 2007 11:29:34 +0100
From: Peter Stephenson <pws@csr.com>
To: Peter Stephenson <pws@csr.com>
Cc: "zsh workers" <zsh-workers@sunsite.dk>
Subject: Re: Change in FIGNORE behavior
Message-ID: <20070530112934.3950357b@news01.csr.com>
In-Reply-To: <200705300945.l4U9jUbE009607@news01.csr.com>
References: <20a807210705291856qe306eeds250f4f9d5f4dd33f@mail.gmail.com>
	<200705300945.l4U9jUbE009607@news01.csr.com>
Organization: CSR
X-Mailer: Claws Mail 2.9.1 (GTK+ 2.10.8; i386-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
X-OriginalArrivalTime: 30 May 2007 10:29:34.0556 (UTC) FILETIME=[6AA091C0:01C7A2A5]
X-Scanned-By: MailControl A-07-07-05 (www.mailcontrol.com) on 10.67.0.128

On Wed, 30 May 2007 10:45:29 +0100
Peter Stephenson <pws@csr.com> wrote:
> > Even though FIGNORE is set, if there are no other matches,
> > completion should match the backup file, right?  That's the way the
> > shell used to behave.  I've done a little bisecting and it appears
> > this behavior changed sometime between 2007-05-15 and 007-05-23.
> 
> This is supposed to be handled by the _ignored completer;
> is some change causing that not to be set?  If not, maybe the output
> of _complete_debug would be helpful.

I've found what's causing it by using the default set of completers: it's
the effect of the change in (R) on this code in _ignored:

  zstyle -a ":completion:${curcontext}:" completer comp ||
    comp=( "${(@)_completers[1,_completer_num-1][(R)_ignored(|:*),-1]}" )

With

  _completers=(_complete _ignored)
  _completer_num=2

comp used to get set to _complete, now its empty.  It previously worked
because a failure to find _ignored(|:*) set the second start subscript to 0
which was interpreted as 1.  I presume the idea is we only want completers
starting from any previous occurence of _ignored, or the start.  This is a
bit too opaque for my liking anyway.  This expands that form where it
occurs in both _ignored and _prefix.

I'm glad somebody spotted this.

Index: Completion/Base/Completer/_ignored
===================================================================
RCS file: /cvsroot/zsh/zsh/Completion/Base/Completer/_ignored,v
retrieving revision 1.1
diff -u -r1.1 _ignored
--- Completion/Base/Completer/_ignored	2 Apr 2001 11:07:28 -0000	1.1
+++ Completion/Base/Completer/_ignored	30 May 2007 10:25:26 -0000
@@ -5,9 +5,13 @@
 [[ _matcher_num -gt 1 || $compstate[ignored] -eq 0 ]] && return 1
 
 local comp
+integer ind
 
-zstyle -a ":completion:${curcontext}:" completer comp ||
-  comp=( "${(@)_completers[1,_completer_num-1][(R)_ignored(|:*),-1]}" )
+if ! zstyle -a ":completion:${curcontext}:" completer comp; then
+  comp=( "${(@)_completers[1,_completer_num-1]}" )
+  ind=${comp[(I)_ignored(|:*)]}
+  (( ind )) && comp=("${(@)comp[ind,-1]}")
+fi
 
 local _comp_no_ignore=yes tmp expl \
       _completer _completer_num \
Index: Completion/Base/Completer/_prefix
===================================================================
RCS file: /cvsroot/zsh/zsh/Completion/Base/Completer/_prefix,v
retrieving revision 1.4
diff -u -r1.4 _prefix
--- Completion/Base/Completer/_prefix	5 Dec 2003 10:35:24 -0000	1.4
+++ Completion/Base/Completer/_prefix	30 May 2007 10:25:26 -0000
@@ -7,9 +7,13 @@
 local comp curcontext="$curcontext" tmp suf="$SUFFIX" \
       _completer \
       _matcher _c_matcher _matchers _matcher_num
+integer ind
 
-zstyle -a ":completion:${curcontext}:" completer comp ||
-  comp=( "${(@)_completers[1,_completer_num-1][(R)_prefix(|:*),-1]}" )
+if ! zstyle -a ":completion:${curcontext}:" completer comp; then
+  comp=( "${(@)_completers[1,_completer_num-1]}" )
+  ind=${comp[(I)_prefix(|:*)]}
+  (( ind )) && comp=("${(@)comp[ind,-1]}")
+fi
 
 if zstyle -t ":completion:${curcontext}:" add-space; then
   ISUFFIX=" $SUFFIX"


-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070


To access the latest news from CSR copy this link into a web browser:  http://www.csr.com/email_sig.php

To get further information regarding CSR, please visit our Investor Relations page at http://ir.csr.com/csr/about/overview

