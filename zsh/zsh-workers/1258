From A.Main@dcs.warwick.ac.uk Wed Jun  5 01:52:53 1996
Received: from euclid.skiles.gatech.edu (list@euclid.skiles.gatech.edu [130.207.146.50]) by melb.werple.net.au (8.7.5/8.7.3/2) with ESMTP id BAA26974 for <mason@werple.mira.net.au>; Wed, 5 Jun 1996 01:52:45 +1000 (EST)
Received: (from list@localhost) by euclid.skiles.gatech.edu (8.7.3/8.7.3) id LAA06965; Tue, 4 Jun 1996 11:42:06 -0400 (EDT)
Resent-Date: Tue, 4 Jun 1996 11:42:06 -0400 (EDT)
From: Zefram <A.Main@dcs.warwick.ac.uk>
Message-Id: <1943.199606041541@downwind.dcs.warwick.ac.uk>
Subject: "unset USERNAME" fix
To: zsh-workers@math.gatech.edu (Z Shell workers mailing list)
Date: Tue, 4 Jun 1996 16:41:25 +0100 (BST)
X-Patch: 102
X-Loop: zefram@dcs.warwick.ac.uk
X-Stardate: [-31]7608.26
X-US-Congress: Moronic fuckers
MIME-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
Resent-Message-ID: <"dW12p2.0.ii1.Db5jn"@euclid>
Resent-From: zsh-workers@math.gatech.edu
X-Mailing-List: <zsh-workers@math.gatech.edu> archive/latest/1258
X-Loop: zsh-workers@math.gatech.edu
Precedence: list
Resent-Sender: zsh-workers-request@math.gatech.edu
Content-Length: 2482
Status: OR

-----BEGIN PGP SIGNED MESSAGE-----

If one does "unset USERNAME", zsh dumps core.  This fixes it, at least
to the point where it no longer crashes.  (zsh's handling of special
parameters needs a serious overhaul.)  It is now possible to clear the
environment by doing "unset -m \*".

 -zefram

      Index: Src/params.c
      *** params.c	1996/05/30 14:18:48	1.5
      --- params.c	1996/06/04 13:17:18
      ***************
      *** 689,696 ****
            return s;
        }
        
      ! static char *nular[] =
      ! {"", NULL};
        
        /**/
        char **
      --- 689,695 ----
            return s;
        }
        
      ! static char *nular[] = {"", NULL};
        
        /**/
        char **
      ***************
      *** 1068,1076 ****
            case PM_SCALAR:
        	(pm->sets.cfn) (pm, NULL);
        	break;
      -     case PM_INTEGER:
      - 	(pm->sets.ifn) (pm, 0);
      - 	break;
            case PM_ARRAY:
        	(pm->sets.afn) (pm, NULL);
        	break;
      --- 1067,1072 ----
      ***************
      *** 1433,1439 ****
        #ifdef HAVE_SETUID
            struct passwd *pswd;
        
      !     if ((pswd = getpwnam(x)) && (pswd->pw_uid != cached_uid)) {
        	if(!setgid(pswd->pw_gid) && !setuid(pswd->pw_uid)) {
        	    zsfree(cached_username);
        	    cached_username = ztrdup(pswd->pw_name);
      --- 1429,1435 ----
        #ifdef HAVE_SETUID
            struct passwd *pswd;
        
      !     if (x && (pswd = getpwnam(x)) && (pswd->pw_uid != cached_uid)) {
        	if(!setgid(pswd->pw_gid) && !setuid(pswd->pw_uid)) {
        	    zsfree(cached_username);
        	    cached_username = ztrdup(pswd->pw_name);
      ***************
      *** 1640,1647 ****
        	hatchar = (bangchar) ? x[1] : '\0';
        	hashchar = (hatchar) ? x[2] : '\0';
        	zsfree(x);
      !     }
      !     else {
        	bangchar = '!';
        	hashchar = '#';
        	hatchar = '^';
      --- 1636,1642 ----
        	hatchar = (bangchar) ? x[1] : '\0';
        	hashchar = (hatchar) ? x[2] : '\0';
        	zsfree(x);
      !     } else {
        	bangchar = '!';
        	hashchar = '#';
        	hatchar = '^';

-----BEGIN PGP SIGNATURE-----
Version: 2.6.2

iQCVAwUBMbQ5aXD/+HJTpU/hAQHiugP9EmroqUq/gxc4O0WY09PgqnZEIJ3qySAu
vM4KB3bbpNt6oPsrZSv6/NlichmETjKkETQ3ekW3J8La/YSuBBtAZnBvvgLD/rB9
7u9FDyTXpKi2N59PJsM8RkjuX4tuGYCykiGNUOM0ywCRWge4vK2Z3t2HfQJU4W11
7VM/U060Xtw=
=iN6w
-----END PGP SIGNATURE-----


