From zsh-workers-return-25273-mason-zsh=primenet.com.au@sunsite.dk Wed Jul 09 03:48:48 2008
Return-Path: <zsh-workers-return-25273-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 12291 invoked from network); 9 Jul 2008 03:48:43 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 9 Jul 2008 03:48:43 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 74858 invoked from network); 9 Jul 2008 03:48:35 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 9 Jul 2008 03:48:35 -0000
Received: (qmail 26872 invoked by alias); 9 Jul 2008 03:48:30 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 25273
Received: (qmail 26857 invoked from network); 9 Jul 2008 03:48:29 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 9 Jul 2008 03:48:29 -0000
Received: from mx.spodhuis.org (redoubt.spodhuis.org [193.202.115.177])
	by bifrost.dotsrc.org (Postfix) with ESMTPS id 7037F80524FA
	for <zsh-workers@sunsite.dk>; Wed,  9 Jul 2008 05:48:23 +0200 (CEST)
DomainKey-Signature: a=rsa-sha1; q=dns; c=nofws; s=d200803; d=spodhuis.org;
	h=Received:Date:From:To:Subject:Message-ID:Mail-Followup-To:MIME-Version:Content-Type:Content-Disposition;
	b=qsEWuEzLG7EEqY3LKFI8iVCgWYLdzuiMk+Mp+QQq4kRC6nmyKExd1XLWk8PMTvo89be7dHzfL6m09vpVPd9H5XJC/jf4TV1EeFB1N5w1imXtt9WVF2ejjigRmeGuf3o/81J6R07UMlcDBQreaoZTCUXnvpIBY7Op9Si9JcNC1J4=;
Received: by smtp.spodhuis.org with local 
	id 1KGQfB-000Poq-Oz; Wed, 09 Jul 2008 03:48:17 +0000
Date: Tue, 8 Jul 2008 20:48:17 -0700
From: Phil Pennock <zsh-workers+phil.pennock@spodhuis.org>
To: zsh-workers@sunsite.dk
Subject: Breaking apart link dependencies
Message-ID: <20080709034817.GA27341@redoubt.spodhuis.org>
Mail-Followup-To: zsh-workers@sunsite.dk
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
X-Virus-Scanned: ClamAV 0.92.1/7669/Wed Jul  9 01:24:17 2008 on bifrost
X-Virus-Status: Clean

In zsh-workers 23617 I mentioned an intention to look into some link
dependency stuff before posting a patch.  Alas, that was right before I
started playing World of Warcraft and my code-hacking time disappeared
... somewhere; when I stopped playing a few months later, I never got
back to this.  So, I'm kicking this out as a patch manually filtered
from amongst other changes in code I haven't touched in over a year,
tested on FreeBSD/amd64 and MacOS 10.4.x.  That sounds scarier than it
is, once you see the size of the actual patch and how simple it is.

This is the first step to see if there's any linker breakage on other
platforms.  If it works decently, perhaps a later step is to move the
ncurses dependency to zle?

There are of course interesting tab dependencies in patches against
portable shell generating Makefiles, so caveat patcher.

Not tested against cygwin, but it should leave the linkage of
zsh/main.so unmolested.

Does zsh still support any systems that don't support chained libraries,
as mentioned by Andrey Borzenkov in post 23347?  Does zsh tend to just
statically compile on those platforms?  If not, is there a deterministic
configure.ac test available, or should we just list the platforms as
exceptions to resetting LIBS and CPPFLAGS by the XXX comment in the
patch?

-Phil

----------------------------8< cut here >8------------------------------
Index: configure.ac
===================================================================
RCS file: /home/cvsroot/zsh/configure.ac,v
retrieving revision 1.105
diff -p -u -r1.105 configure.ac
--- configure.ac	1 Jun 2008 16:39:09 -0000	1.105
+++ configure.ac	9 Jul 2008 03:03:36 -0000
@@ -544,6 +544,7 @@ AC_HEADER_STAT
 AC_HEADER_SYS_WAIT
 
 oldcflags="$CFLAGS"
+pre_pcre_cppflags="$CPPFLAGS"
 if test x$enable_pcre = xyes; then
 AC_CHECK_PROG([PCRECONF], pcre-config, pcre-config)
 dnl Typically (meaning on this single RedHat 9 box in front of me)
@@ -792,6 +793,7 @@ if test "x$ac_found_iconv" = "xyes"; the
     [Define as const if the declaration of iconv() needs const.])
 fi
 
+pre_pcre_libs="$LIBS"
 if test x$enable_pcre = xyes; then
 dnl pcre-config should probably be employed here
 dnl AC_SEARCH_LIBS(pcre_compile, pcre)
@@ -1133,6 +1135,12 @@ AC_CHECK_FUNCS(strftime strptime mktime 
 	       regcomp regexec regerror regfree)
 AC_FUNC_STRCOLL
 
+dnl The only stuff which needs PCRE includes is the pcre module.
+dnl On ELF systems (at least) only that module needs to be linked against pcre.
+dnl XXX Need to figure out where this isn't safe
+LIBS="$pre_pcre_libs"
+CPPFLAGS="$pre_pcre_cppflags"
+
 if test x$enable_cap = xyes; then
   AC_CHECK_FUNCS(cap_get_proc)
 fi
Index: Src/mkmakemod.sh
===================================================================
RCS file: /home/cvsroot/zsh/Src/mkmakemod.sh,v
retrieving revision 1.17
diff -p -u -r1.17 mkmakemod.sh
--- Src/mkmakemod.sh	30 Jan 2008 10:03:49 -0000	1.17
+++ Src/mkmakemod.sh	9 Jul 2008 03:15:10 -0000
@@ -32,6 +32,8 @@
 #   headers         extra headers for this module (default none)
 #   hdrdeps         extra headers on which the .mdh depends (default none)
 #   otherincs       extra headers that are included indirectly (default none)
+#   modincflags     extra inc flags to pass when building the module
+#   modlibflags     extra linkage flags to pass when building the module
 #
 # The .mdd file may also include a Makefile.in fragment between lines
 # `:<<\Make' and `Make' -- this will be copied into Makemod.in.
@@ -46,6 +48,9 @@
 # and $otherincs will be made up to date, but the .mdh file won't actually
 # be rebuilt if those files change.
 #
+# modincflags and modlibflags should be used for system includes and libraries
+# which are particular to this module; eg, PCRE, regex, etc.
+#
 # The order of sections of the output file is thus:
 #   simple generated macros
 #   macros generated from *.mdd
@@ -191,6 +196,7 @@ if $first_stage; then
 	unset name moddeps nozshdep alwayslink hasexport
 	unset autobins autoinfixconds autoprefixconds autoparams automathfuncs
 	unset objects proto headers hdrdeps otherincs
+	unset modincflags modlibflags
 	. $top_srcdir/$the_subdir/${mddname}.mdd
 	q_name=`echo $name | sed 's,Q,Qq,g;s,_,Qu,g;s,/,Qs,g'`
 	test -n "${moddeps+set}" || moddeps=
@@ -312,6 +318,26 @@ if $first_stage; then
 	echo "modobjs.${mddname}: \$(MODOBJS_${mddname})"
 	echo "	echo '' \$(MODOBJS_${mddname}) $modobjs_sed>> \$(dir_src)/stamp-modobjs.tmp"
 	echo
+	if test -n "$modincflags"; then
+	   echo "${mddname}\$(ANSIOBJ): ${mddname}.c"
+	   echo "	\$(COMPILE) $modincflags -o \$@ \$<"
+	   echo "	@rm -f \$(dir_src)/stamp-modobjs"
+	   echo
+	   echo "${mddname}\$(KNROBJ): ${mddname}.c"
+	   echo "	: ansi2knr \$< > \$@.c"
+	   echo "	\$(COMPILE) $modincflags -o \$@ \$@.c"
+	   echo "	rm -f \$@.c"
+	   echo "	@rm -f \$(dir_src)/stamp-modobjs"
+	   echo
+	   echo "${mddname}.\$(ANSIOBJ): ${mddname}.c"
+	   echo "	\$(DLCOMPILE) $modincflags -o \$@ \$<"
+	   echo
+	   echo "${mddname}.\$(KNROBJ): ${mddname}.c"
+	   echo "	: ansi2knr \$< > \$@.c"
+	   echo "	\$(DLCOMPILE) $modincflags -o \$@ \$@.c"
+	   echo "	rm -f \$@.c"
+	   echo
+	fi
 	if test -z "$alwayslink"; then
 	    case " $all_modules" in *" ${mddname}."*)
 		echo "install.modules-here: install.modules.${mddname}"
@@ -328,7 +354,7 @@ if $first_stage; then
 	    echo
 	    echo "${mddname}.\$(DL_EXT): \$(MODDOBJS_${mddname}) ${mddname}.export $exportdeps \$(@LINKMODS@_${mddname})"
 	    echo '	rm -f $@'
-	    echo "	\$(DLLINK) \$(@E@XPIMP_$mddname) \$(@E@NTRYOPT) \$(MODDOBJS_${mddname}) \$(@LINKMODS@_${mddname}) \$(LIBS) "
+	    echo "	\$(DLLINK) \$(@E@XPIMP_$mddname) \$(@E@NTRYOPT) \$(MODDOBJS_${mddname}) \$(@LINKMODS@_${mddname}) \$(LIBS) ${modlibflags} "
 	    echo
 	fi
 	echo "${mddname}.mdhi: ${mddname}.mdhs \$(INCS_${mddname})"
Index: Src/Modules/pcre.mdd
===================================================================
RCS file: /home/cvsroot/zsh/Src/Modules/pcre.mdd,v
retrieving revision 1.4
diff -p -u -r1.4 pcre.mdd
--- Src/Modules/pcre.mdd	20 Jun 2007 20:59:18 -0000	1.4
+++ Src/Modules/pcre.mdd	9 Jul 2008 03:09:43 -0000
@@ -5,3 +5,6 @@ load=no
 autofeatures="b:pcre_compile b:pcre_study b:pcre_match"
 
 objects="pcre.o"
+
+modincflags="`pcre-config --cflags`"
+modlibflags="`pcre-config --libs`"

