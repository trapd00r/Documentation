From zsh-workers-return-19808-mason-zsh=primenet.com.au@sunsite.dk Wed Apr 21 10:00:52 2004
Return-Path: <zsh-workers-return-19808-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 22793 invoked from network); 21 Apr 2004 10:00:50 -0000
Received: from sunsite.dk (130.225.247.90)
  by ns1.primenet.com.au with SMTP; 21 Apr 2004 10:00:50 -0000
Received: (qmail 3739 invoked by alias); 21 Apr 2004 10:00:43 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 19808
Received: (qmail 3723 invoked from network); 21 Apr 2004 10:00:43 -0000
Received: from localhost (HELO sunsite.dk) (127.0.0.1)
  by localhost with SMTP; 21 Apr 2004 10:00:43 -0000
X-MessageWall-Score: 0 (sunsite.dk)
Received: from [130.225.247.86] by sunsite.dk (MessageWall 1.0.8) with SMTP; 21 Apr 2004 10:0:43 -0000
Received: (qmail 21117 invoked from network); 21 Apr 2004 10:00:43 -0000
Received: from lhuumrelay3.lnd.ops.eu.uu.net (62.189.58.19)
  by a.mx.sunsite.dk with SMTP; 21 Apr 2004 10:00:40 -0000
Received: from MAILSWEEPER01.csr.com (mailhost1.csr.com [62.189.183.235])
	by lhuumrelay3.lnd.ops.eu.uu.net (8.11.0/8.11.0) with ESMTP id i3LA0Dv24393
	for <zsh-workers@sunsite.dk>; Wed, 21 Apr 2004 10:00:13 GMT
Received: from EXCHANGE02.csr.com (unverified [192.168.137.45]) by MAILSWEEPER01.csr.com
 (Content Technologies SMTPRS 4.3.12) with ESMTP id <T6919216becc0a88d01368@MAILSWEEPER01.csr.com>;
 Wed, 21 Apr 2004 10:59:46 +0100
Received: from csr.com ([192.168.144.127]) by EXCHANGE02.csr.com with Microsoft SMTPSVC(5.0.2195.6713);
	 Wed, 21 Apr 2004 11:00:55 +0100
To: Vincent Stemen <zsh@hightek.org>
cc: zsh-workers@sunsite.dk
Subject: Re: FreeBSD compatability feature request 
In-reply-to: "Vincent Stemen"'s message of "Wed, 21 Apr 2004 03:21:51 CDT."
             <20040421082151.GA61057@quark.hightek.org> 
Date: Wed, 21 Apr 2004 11:00:12 +0100
Message-ID: <11514.1082541612@csr.com>
From: Peter Stephenson <pws@csr.com>
X-OriginalArrivalTime: 21 Apr 2004 10:00:55.0765 (UTC) FILETIME=[89B56050:01C42787]
X-Spam-Checker-Version: SpamAssassin 2.63 on a.mx.sunsite.dk
X-Spam-Level: 
X-Spam-Status: No, hits=0.2 required=6.0 tests=EXCUSE_16 autolearn=no 
	version=2.63
X-Spam-Hits: 0.2

Vincent Stemen wrote:
> After replacing /bin/sh with zsh, it was able to fully boot up and
> initialize the system except for one other problem, which appears to be a
> different bug in sh emulation mode.  It hangs when running the nfsd init
> script.  If I <cntl>c out of it, the rest of the system comes up, but
> without NFS.
> 
> I finally isolated the problem.  Below is a small script, called t, that
> reproduces it.
> 
> # cat t
> 
> _find_processes()
> {
>     ps | while read pid command
>     do
>         echo "pid=$pid  $command"
>     done >&2
> 
>     echo "xxx Exited loop xxxxxxxxxxxxxxxxxxxxxxx" >&2
> }
> 
> xxx=$(_find_processes)
> 
> #--- end of script -------

Making a link to sh from zsh and running `sh t' I can get this to happen
on Fedora, but only intermittently.  I think it's the new option I
added, since I can get this to happen with `zsh -f -o notrapsasync', but
not with `zsh -f'.  So it looks like I've introduced a race.

This obviously needs fixing before we can release anything with the
option it it, but is going to take some tracing.  Here is what I've got.

I have two processes running:
pws      18664 14486  0 10:38 pts/2    00:00:00 sh t
pws      18665 18664  0 10:38 pts/2    00:00:00 sh t

(I thought I had another one but it seemed to be hung from a previous
go.)

18664 is waiting for output from the the $(...) to finish.  This is normal.

18665 is waiting for a job to finish in zwaitjob.  Somehow it's
got into a state where it wasn't prepared to handle the SIGCHLD, and
it's therefore missed it.

I'll keep looking.  Any suggestions would be gratefully received.

-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR Ltd., Science Park, Milton Road,
Cambridge, CB4 0WH, UK                          Tel: +44 (0)1223 692070


**********************************************************************
This email and any files transmitted with it are confidential and
intended solely for the use of the individual or entity to whom they
are addressed. If you have received this email in error please notify
the system manager.

This footnote also confirms that this email message has been swept by
MIMEsweeper for the presence of computer viruses.

www.mimesweeper.com
**********************************************************************

