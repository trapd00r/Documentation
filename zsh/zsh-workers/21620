From zsh-workers-return-21620-mason-zsh=primenet.com.au@sunsite.dk Mon Aug 15 17:17:49 2005
Return-Path: <zsh-workers-return-21620-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 13567 invoked from network); 15 Aug 2005 17:17:46 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 15 Aug 2005 17:17:46 -0000
Received: (qmail 85850 invoked from network); 15 Aug 2005 17:17:40 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 15 Aug 2005 17:17:40 -0000
Received: (qmail 13435 invoked by alias); 15 Aug 2005 17:17:38 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 21620
Received: (qmail 13426 invoked from network); 15 Aug 2005 17:17:38 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 15 Aug 2005 17:17:38 -0000
Received: (qmail 85536 invoked from network); 15 Aug 2005 17:17:38 -0000
Received: from dsl3-63-249-88-2.cruzio.com (HELO dot.blorf.net) (63.249.88.2)
  by a.mx.sunsite.dk with SMTP; 15 Aug 2005 17:17:34 -0000
Received: by dot.blorf.net (Postfix, from userid 1000)
	id 3A8EE27AC; Mon, 15 Aug 2005 10:17:33 -0700 (PDT)
Date: Mon, 15 Aug 2005 10:17:33 -0700
From: Wayne Davison <wayned@users.sourceforge.net>
To: zsh-workers@sunsite.dk
Subject: PATCH: make unicode support configurable
Message-ID: <20050815171733.GB29158@blorf.net>
Mime-Version: 1.0
Content-Type: multipart/mixed; boundary="pvezYHf7grwyp3Bc"
Content-Disposition: inline
User-Agent: Mutt/1.5.9i
X-Spam-Checker-Version: SpamAssassin 3.0.4 (2005-06-05) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=AWL,BAYES_00 autolearn=ham 
	version=3.0.4


--pvezYHf7grwyp3Bc
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline

Here's a first pass at turning the ZLE_UNICODE_SUPPORT define into a
configure item.  The attached patch allows the user to specify either
--with-unicode-support or --without-unicode-support (to force the
decision), otherwise it runs a test to see if it thinks unicode can
be supported (which consists of the current checks from system.h
transplanted into configure).  The code in system.h was also modified
to check the value of ZLE_UNICODE_SUPPORT instead of set it.

Some questions that should be answered:

  o Do we like the above name for the --with/--without option?
  o Is including locale.h (if it exists) the right include file for
    the new configure test for __STDC_ISO_10646__?  (It works on my
    Linux system.)
  o Do we need the old unicode "subset" logic that I removed from
    system.h?

..wayne..

--pvezYHf7grwyp3Bc
Content-Type: text/plain; charset=us-ascii
Content-Disposition: attachment; filename="unicode.patch"

--- configure.ac	1 Aug 2005 09:54:56 -0000	1.37
+++ configure.ac	15 Aug 2005 16:56:54 -0000
@@ -2063,6 +2063,43 @@ int ptsname();], ,
    fi
 fi
 
+dnl ---------------
+dnl unicode support
+dnl ---------------
+AC_ARG_WITH(unicode-support,
+[  --with-unicode-support     support unicode characters in the line editor])
+
+echo $with_unicode_support >/tmp/uni
+case x"$with_unicode_support" in
+  xyes) zsh_cv_c_zle_unicode_support=yes ;;
+  xno) zsh_cv_c_zle_unicode_support=no ;;
+  *)
+    AC_CACHE_CHECK(if the compiler supports wide characters,
+     zsh_cv_c_zle_unicode_support,
+    [AC_TRY_COMPILE([
+#ifdef HAVE_LOCALE_H
+# include <locale.h>
+#endif
+     ], [
+int main() {
+#if defined(HAVE_WCHAR_H) && defined(HAVE_WCTOMB) \
+ && defined(HAVE_MBRTOWC) && defined(HAVE_WCRTOMB) \
+ && defined (__STDC_ISO_10646__)
+    return 0;
+#else
+#error Not supported.
+#endif
+}
+    ],
+      zsh_cv_c_zle_unicode_support=yes,
+      zsh_cv_c_zle_unicode_support=no)])
+    ;;
+esac
+AH_TEMPLATE([ZLE_UNICODE_SUPPORT],
+[Define to 1 if you want unicode support in the line editor.])
+if test $zsh_cv_c_zle_unicode_support = yes; then
+  AC_DEFINE(ZLE_UNICODE_SUPPORT)
+fi
 
 dnl ---------------
 dnl dynamic loading
--- Src/system.h	15 Aug 2005 10:01:48 -0000	1.33
+++ Src/system.h	15 Aug 2005 16:56:54 -0000
@@ -691,22 +691,9 @@ extern short ospeed;
 #define UNUSED(x) x
 #endif
 
-/*
- * This is a subset of ZLE_UNICODE_SUPPORT.  It is not all that likely
- * that only the subset is supported, however it's easy to make the
- * \u and \U escape sequences work with just the following.
- */
-#if defined(HAVE_WCHAR_H) && defined(HAVE_WCTOMB) && defined (__STDC_ISO_10646__)
+#ifdef ZLE_UNICODE_SUPPORT
 # include <wchar.h>
 # include <wctype.h>
-
-/*
- * More stringent requirements to enable complete Unicode conversion
- * between wide characters and multibyte strings.
- */
-#if defined(HAVE_MBRTOWC) && defined(HAVE_WCRTOMB)
-#define ZLE_UNICODE_SUPPORT	1
-#endif
 #else
 # ifdef HAVE_LANGINFO_H
 #   include <langinfo.h>

--pvezYHf7grwyp3Bc--

