From zsh-users-return-14953-mason-zsh=primenet.com.au@zsh.org Mon Mar 22 08:52:56 2010
Return-Path: <zsh-users-return-14953-mason-zsh=primenet.com.au@zsh.org>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 29679 invoked by alias); 22 Mar 2010 08:52:56 -0000
Mailing-List: contact zsh-users-help@zsh.org; run by ezmlm
Precedence: bulk
X-No-Archive: yes
List-Id: Zsh Users List <zsh-users.zsh.org>
List-Post: <mailto:zsh-users@zsh.org>
List-Help: <mailto:zsh-users-help@zsh.org>
Delivered-To: mailing list zsh-users@zsh.org
X-Seq: 14953
Received: (qmail 1447 invoked from network); 22 Mar 2010 08:52:53 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received-SPF: none (ns1.primenet.com.au: domain at math.technion.ac.il does not designate permitted sender hosts)
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: AvsEAK/KpkuERHMG/2dsb2JhbACbK3O5BQKEewQ
X-IronPort-AV: E=Sophos;i="4.51,286,1267394400"; 
   d="scan'208";a="229882985"
X-Authentication-Warning: fermat.math.technion.ac.il: nyh set sender to nyh@math.technion.ac.il using -f
Date: Mon, 22 Mar 2010 10:42:26 +0200
From: "Nadav Har'El" <nyh@math.technion.ac.il>
To: Bart Schaefer <schaefer@brasslantern.com>
Cc: zsh-users@zsh.org
Subject: Re: Append cancelled commands to history
Message-ID: <20100322084226.GA26739@fermat.math.technion.ac.il>
References: <c16a574a0809181450t61a5b5ddq2e80797fde37636e@mail.gmail.com> <20080919162045.GA22435@ruderich.org> <20090706151644.6BF508027106@bifrost.dotsrc.org> <20090706154309.GA15663@fermat.math.technion.ac.il> <20090706155337.GB15663@fermat.math.technion.ac.il> <20100315164237.GA23224@fermat.math.technion.ac.il> <100320105027.ZM20067@torch.brasslantern.com>
Mime-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <100320105027.ZM20067@torch.brasslantern.com>
User-Agent: Mutt/1.4.2.2i
Hebrew-Date: 7 Nisan 5770

On Sat, Mar 20, 2010, Bart Schaefer wrote about "Re: Append cancelled commands to history":
> > I thought this would be simple - just replace the print line with
> > 	print -s -r -- "$PREBUFFER$BUFFER"
> 
> Hmm.  When I use TRAPINT, $PREBUFFER is always empty.
> 
> torch% print $ZSH_VERSION $ZSH_PATCHLEVEL 
> 4.3.10-dev-1 1.4940

Thanks for the explanations. For me, $PREBUFFER does work:

$ print $ZSH_VERSION $ZSH_PATCHLEVEL
4.3.10 1.4705
$ cat /etc/redhat-release; rpm -qf =zsh
Fedora release 12 (Constantine)
zsh-4.3.10-4.fc12.x86_64

$ functions TRAPINT
TRAPINT () {
        zle && [[ $HISTNO -eq $HISTCMD ]] && print -s -r -- "$PREBUFFER$BUFFER"
        echo "prebuffer: '$PREBUFFER'"
        return $1
}

$ for i in *
for> do
for> echo<INTERRUPT>prebuffer: 'for i in *
do
'

$

But the problem I have now is that when I now go up in the history, the
last command I see is

	for i in *
	do

which is what standard zsh saved - without the last partial line - and when I
go up another command in history I see

	for i in *
	do
	echo

which is what my code saved. I wished there was a way not to save that
shorter version, with only the accepted lines.

Of course, it's not so terrible as it is - I just wondered if there's a
way to do it better. Usually when I interrupt a multi-line command entry,
it's not because I'm not pleased with the last line I typed (if this was
the case, I could have just backspaced...), but rather, I'm not pleased
with the whole thing. So I want to save the whole thing (including the
last line I'm editing), and go to edit it later if I wish.


-- 
Nadav Har'El                        |        Monday, Mar 22 2010, 7 Nisan 5770
nyh@math.technion.ac.il             |-----------------------------------------
Phone +972-523-790466, ICQ 13349191 |Why do we drive on a parkway and park on
http://nadav.harel.org.il           |a driveway?

