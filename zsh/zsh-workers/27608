From zsh-workers-return-27608-mason-zsh=primenet.com.au@zsh.org Wed Jan 20 11:12:42 2010
Return-Path: <zsh-workers-return-27608-mason-zsh=primenet.com.au@zsh.org>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 7133 invoked by alias); 20 Jan 2010 11:12:42 -0000
Mailing-List: contact zsh-workers-help@zsh.org; run by ezmlm
Precedence: bulk
X-No-Archive: yes
List-Id: Zsh Workers List <zsh-workers.zsh.org>
List-Post: <mailto:zsh-workers@zsh.org>
List-Help: <mailto:zsh-workers-help@zsh.org>
Delivered-To: mailing list zsh-workers@zsh.org
X-Seq: 27608
Received: (qmail 12578 invoked from network); 20 Jan 2010 11:12:39 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-3.0 required=5.0 tests=AWL,BAYES_00,
	RCVD_IN_DNSWL_LOW,SPF_HELO_PASS autolearn=ham version=3.2.5
Received-SPF: none (ns1.primenet.com.au: domain at csr.com does not designate permitted sender hosts)
Date: Wed, 20 Jan 2010 10:34:43 +0000
From: Peter Stephenson <pws@csr.com>
To: zsh-workers@zsh.org
Subject: Re: Fwd: Test Failure
Message-ID: <20100120103443.6c9dfd0c@news01>
In-Reply-To: <20a807211001191446y4a16143eg3014207f8c8e609c@mail.gmail.com>
References: <20a807211001191316x79ce2ffeib91fdc59cdfcb189@mail.gmail.com>
	<20a807211001191342i4b1d8d63o9bede714f1831477@mail.gmail.com>
	<20a807211001191445x5924b63frc6916febda023502@mail.gmail.com>
	<20a807211001191446y4a16143eg3014207f8c8e609c@mail.gmail.com>
Organization: CSR
X-Mailer: Claws Mail 3.5.0 (GTK+ 2.12.8; i386-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
X-OriginalArrivalTime: 20 Jan 2010 10:34:43.0663 (UTC) FILETIME=[2DE90DF0:01CA99BC]
X-Scanned-By: MailControl A-09-22-10 (www.mailcontrol.com) on 10.71.0.131

On Tue, 19 Jan 2010 17:46:43 -0500
Vin Shelton <acs@alumni.princeton.edu> wrote:
> Since 2010-01-17, I've been getting a failure in the test suite:
> 
> : build/zsh-2010-01-17 Tue 19 16:09; make check
> **************************************
> 37 successful test scripts, 1 failure, 0 skipped
> **************************************
> make[1]: *** [check] Error 1
> make[1]: Leaving directory `/home/opt/build/zsh-2010-01-17/Test'
> make: *** [check] Error 2
> 
> C02 doesn't report an error, but it doesn't report a pass, either.

Looks like I got the new test wrong.  It's a bit complicated because it's
not supposed to produce an error if the regex module isn't available.

The failure is because I screwed up the size of the allocations
for the new variables.

Index: Src/Modules/pcre.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Modules/pcre.c,v
retrieving revision 1.17
diff -u -r1.17 pcre.c
--- Src/Modules/pcre.c	17 Jan 2010 21:51:34 -0000	1.17
+++ Src/Modules/pcre.c	20 Jan 2010 10:33:49 -0000
@@ -194,8 +194,8 @@
 		char **mbegin, **mend, **bptr, **eptr;
 		int i, *ipair;
 
-		bptr = mbegin = zalloc(nelem+1);
-		eptr = mend = zalloc(nelem+1);
+		bptr = mbegin = zalloc(sizeof(char*)*(nelem+1));
+		eptr = mend = zalloc(sizeof(char*)*(nelem+1));
 
 		for (ipair = ovec + 2, i = 0;
 		     i < nelem;
Index: Src/Modules/regex.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Modules/regex.c,v
retrieving revision 1.6
diff -u -r1.6 regex.c
--- Src/Modules/regex.c	17 Jan 2010 21:51:36 -0000	1.6
+++ Src/Modules/regex.c	20 Jan 2010 10:33:49 -0000
@@ -135,11 +135,11 @@
 		setiparam("MEND", offs + !isset(KSHARRAYS) - 1);
 		if (nelem) {
 		    char **mbegin, **mend, **bptr, **eptr;
-		    bptr = mbegin = (char **)zalloc(nelem+1);
-		    eptr = mend = (char **)zalloc(nelem+1);
+		    bptr = mbegin = (char **)zalloc(sizeof(char *)*(nelem+1));
+		    eptr = mend = (char **)zalloc(sizeof(char *)*(nelem+1));
 
-		    for (m = matches + start, n = start;
-			 n <= (int)re.re_nsub;
+		    for (m = matches + start, n = 0;
+			 n < nelem;
 			 ++n, ++m, ++bptr, ++eptr)
 		    {
 			char buf[DIGBUFSIZE];
Index: Test/C02cond.ztst
===================================================================
RCS file: /cvsroot/zsh/zsh/Test/C02cond.ztst,v
retrieving revision 1.24
diff -u -r1.24 C02cond.ztst
--- Test/C02cond.ztst	17 Jan 2010 21:51:36 -0000	1.24
+++ Test/C02cond.ztst	20 Jan 2010 10:33:49 -0000
@@ -251,7 +251,7 @@
   fi
 0:regex tests shouldn't crash
 
-  if zmodload -i zsh/regex 2>/dev/null; then
+  (if zmodload -i zsh/regex 2>/dev/null; then
     string="this has stuff in it"
     bad_regex=0
     if [[ $string =~ "h([a-z]*) s([a-z]*) " ]]; then
@@ -259,7 +259,7 @@
 	print -r "regex variables MATCH MBEGIN MEND:
   '$MATCH $MBEGIN $MEND'
   should be:
-  'has stuff  6 15'" >&2
+  'has stuff  6 15'"
         bad_regex=1
       else
 	results=("as 7 8" "tuff 11 14")
@@ -268,19 +268,20 @@
 	    print -r "regex variables match[$i] mbegin[$i] mend[$i]:
   '$match[$i] $mbegin[$i] $mend[$i]'
   should be
-  '$results[$i]'" >&2
+  '$results[$i]'"
+            bad_regex=1
 	    break
 	  fi
 	done
       fi
+      (( bad_regex )) || print OK
     else
-      print -r "regex failed to match '$string'" >&2
+      print -r "regex failed to match '$string'"
     fi
-    (( bad_regex )) || print OK
   else
     # if it didn't load, tough, but not a test error
     print OK
-  fi
+  fi)
 0:MATCH, MBEGIN, MEND, match, mbegin, mend
 >OK
 
-- 
Peter Stephenson <pws@csr.com>            Software Engineer
Tel: +44 (0)1223 692070                   Cambridge Silicon Radio Limited
Churchill House, Cambridge Business Park, Cowley Road, Cambridge, CB4 0WZ, UK


Member of the CSR plc group of companies. CSR plc registered in England and Wales, registered number 4187346, registered office Churchill House, Cambridge Business Park, Cowley Road, Cambridge, CB4 0WZ, United Kingdom

