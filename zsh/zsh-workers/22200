From zsh-workers-return-22200-mason-zsh=primenet.com.au@sunsite.dk Tue Feb 07 16:38:27 2006
Return-Path: <zsh-workers-return-22200-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 4525 invoked from network); 7 Feb 2006 16:38:25 -0000
X-Spam-Checker-Version: SpamAssassin 3.1.0 (2005-09-13) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=AWL,BAYES_00,
	FORGED_RCVD_HELO autolearn=ham version=3.1.0
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 7 Feb 2006 16:38:25 -0000
Received: (qmail 51004 invoked from network); 7 Feb 2006 16:38:19 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 7 Feb 2006 16:38:19 -0000
Received: (qmail 18593 invoked by alias); 7 Feb 2006 16:38:16 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 22200
Received: (qmail 18584 invoked from network); 7 Feb 2006 16:38:16 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 7 Feb 2006 16:38:16 -0000
Received: (qmail 50678 invoked from network); 7 Feb 2006 16:38:15 -0000
Received: from cluster-d.mailcontrol.com (217.69.20.190)
  by a.mx.sunsite.dk with SMTP; 7 Feb 2006 16:38:14 -0000
Received: from exchange03.csr.com (uuk202166.uk.customer.alter.net [62.189.241.194] (may be forged))
	by rly12d.srv.mailcontrol.com (MailControl) with ESMTP id k17Gc5tk001513
	for <zsh-workers@sunsite.dk>; Tue, 7 Feb 2006 16:38:13 GMT
Received: from csr.com ([10.103.143.38]) by exchange03.csr.com with Microsoft SMTPSVC(5.0.2195.6713);
	 Tue, 7 Feb 2006 16:38:04 +0000
To: zsh-workers <zsh-workers@sunsite.dk>
Subject: Re: output from ctrl-z not demetafyed (i think) 
In-reply-to: <237967ef0602070811l60dcf2cfn2e1614d8d53f59e5@mail.gmail.com> 
References: <237967ef0602070811l60dcf2cfn2e1614d8d53f59e5@mail.gmail.com>
Comments: In-reply-to Mikael Magnusson <mikachu@gmail.com>
   message dated "Tue, 07 Feb 2006 17:11:47 +0100."
Date: Tue, 07 Feb 2006 16:37:52 +0000
From: Peter Stephenson <pws@csr.com>
Message-ID: <EXCHANGE03wHwdOm4qi0000a987@exchange03.csr.com>
X-OriginalArrivalTime: 07 Feb 2006 16:38:04.0590 (UTC) FILETIME=[DE3144E0:01C62C04]
Content-Type: text/plain
MIME-Version: 1.0
X-Scanned-By: MailControl A-06-00-02 (www.mailcontrol.com) on 10.68.0.122

Yes, it looks like you're right, jobs.c isn't very good with
unmetafication.  This fixes it for descriptions in a couple of places.
There may be others but it's not entirely clear; for example, I think
error messages for job names work OK because the error function handles
it properly.

Index: Src/jobs.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/jobs.c,v
retrieving revision 1.42
diff -u -r1.42 jobs.c
--- Src/jobs.c	13 Oct 2005 17:50:00 -0000	1.42
+++ Src/jobs.c	7 Feb 2006 16:33:27 -0000
@@ -556,10 +556,18 @@
 #ifdef HAVE_GETRUSAGE
     double total_time;
 #endif
-    int percent;
+    int percent, desclen;
 
     if (!desc)
+    {
 	desc = "";
+	desclen = 0;
+    }
+    else
+    {
+	desc = dupstring(desc);
+	unmetafy(desc, &desclen);
+    }
 
     /* go ahead and compute these, since almost every TIMEFMT will have them */
     elapsed_time = real->tv_sec + real->tv_usec / 1000000.0;
@@ -706,7 +714,7 @@
 		break;
 #endif
 	    case 'J':
-		fprintf(stderr, "%s", desc);
+		fwrite(desc, sizeof(char), desclen, stderr);
 		break;
 	    case '%':
 		putc('%', stderr);
@@ -914,8 +922,14 @@
 			(int)(len - 14 + 2 - strlen(sigmsg(WTERMSIG(pn->status)))), "");
 	    else
 		fprintf(fout, "%-*s", len + 2, sigmsg(WTERMSIG(pn->status)));
-	    for (; pn != qn; pn = pn->next)
-		fprintf(fout, (pn->next) ? "%s | " : "%s", pn->text);
+	    for (; pn != qn; pn = pn->next) {
+		char *txt = dupstring(pn->text);
+		int txtlen;
+		unmetafy(txt, &txtlen);
+		fwrite(txt, sizeof(char), txtlen, fout);
+		if (pn->next)
+		    fputs(" | ", fout);
+	    }
 	    putc('\n', fout);
 	    fline = 0;
 	}

-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070


To access the latest news from CSR copy this link into a web browser:  http://www.csr.com/email_sig.php

