From zsh-workers-return-14552-mason-zsh=primenet.com.au@sunsite.dk Tue May 29 22:41:34 2001
Return-Path: <zsh-workers-return-14552-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 3152 invoked from network); 29 May 2001 22:40:56 -0000
Received: from sunsite.dk (130.225.51.30)
  by ns1.primenet.com.au with SMTP; 29 May 2001 22:40:56 -0000
Received: (qmail 9887 invoked by alias); 29 May 2001 20:17:21 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 14552
Received: (qmail 9874 invoked from network); 29 May 2001 20:17:19 -0000
Date: Tue, 29 May 2001 16:17:14 -0400
From: Clint Adams <clint@zsh.org>
To: zsh-workers@sunsite.dk
Subject: PATCH: vi history repetition
Message-ID: <20010529161714.A5951@dman.com>
Mime-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
User-Agent: Mutt/1.2.5i

This has vi-history-search-{backward,forward} repeat the
last search if the search string is empty.

I had originally intended for this to be an option, but
it was argued that searching for an empty string in history
is less useful than {up,down}-line-or-history.  This is also
more vi-like.

I'm going to commit this since I can't see a need for the
current behavior.

Index: Src/Zle/zle_hist.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/zle_hist.c,v
retrieving revision 1.2
diff -u -r1.2 zle_hist.c
--- Src/Zle/zle_hist.c	2001/05/26 20:57:16	1.2
+++ Src/Zle/zle_hist.c	2001/05/29 20:02:43
@@ -950,7 +950,7 @@
 
 /* the last vi search */
 
-static char *visrchstr;
+static char *visrchstr, *vipenultsrchstr;
 static int visrchsense;
 
 /**/
@@ -962,8 +962,12 @@
     Thingy cmd;
     char *okeymap = curkeymapname;
 
+    if (vipenultsrchstr) {
+	zsfree(vipenultsrchstr);
+    }
+
     if (visrchstr) {
-	zsfree(visrchstr);
+	vipenultsrchstr = visrchstr;
 	visrchstr = NULL;
     }
     clearlist = 1;
@@ -990,6 +994,10 @@
 	    	cmd == Th(z_vicmdmode)) {
 	    sbuf[sptr] = 0;
 	    visrchstr = metafy(sbuf + 1, sptr - 1, META_DUP);
+	    if (!strlen(visrchstr)) {
+	        zsfree(visrchstr);
+		visrchstr = vipenultsrchstr;
+	    }
 	    ret = 1;
 	    sptr = 0;
 	} else if(cmd == Th(z_backwarddeletechar) ||

