From zsh-workers-return-10320-mason-zsh=primenet.com.au@sunsite.auc.dk Wed Mar 29 19:48:58 2000
Return-Path: <zsh-workers-return-10320-mason-zsh=primenet.com.au@sunsite.auc.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 23042 invoked from network); 29 Mar 2000 19:48:57 -0000
Received: from sunsite.auc.dk (130.225.51.30)
  by ns1.primenet.com.au with SMTP; 29 Mar 2000 19:48:57 -0000
Received: (qmail 2447 invoked by alias); 29 Mar 2000 19:48:42 -0000
Mailing-List: contact zsh-workers-help@sunsite.auc.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.auc.dk
X-Seq: 10320
Received: (qmail 2435 invoked from network); 29 Mar 2000 19:48:42 -0000
To: zsh-workers@sunsite.auc.dk
Subject: Re: Bugs with exclusion using file paths. 
In-reply-to: "Sven Wischnowsky"'s message of "Wed, 29 Mar 2000 10:26:47 +0200."
             <200003290826.KAA21838@beta.informatik.hu-berlin.de> 
Date: Tue, 28 Mar 2000 21:48:30 +0100
From: Peter Stephenson <pws@pwstephenson.fsnet.co.uk>
Message-Id: <E12aOS2-0004hL-00.2000-03-29-20-48-26@mail4.svr.pol.co.uk>

Sven Wischnowsky wrote:
> > +				if (buf) {
> >  				    zfree(buf, pathpos + patinlen);
> > +				    patinstart = savpatinstart;
> > +				    patinlen = savpatinlen;
> 
> With something like **/_*~*~ I now get lots of:
> 
>   BUG: attempt to free more than allocated.
> 
> warnings.

Very stupid, sorry; use the original pattern length, not the temporrary
one.  For boring technical reasons due to the way my front-end to configure
is run, I didn't have Zsh memory allocation on, or I would presumably have
picked it up.

Let me know if there is still a problem after this.  I tried **/*~(.)# in
my home directory, with zsh-mem turned on, which ought to have tickled any
bug of this kind.

Index: Src/pattern.c
===================================================================
RCS file: /home/pws/CVSROOT/projects/zsh/Src/pattern.c,v
retrieving revision 1.7
diff -u -r1.7 pattern.c
--- Src/pattern.c	2000/03/27 21:40:57	1.7
+++ Src/pattern.c	2000/03/28 20:16:50
@@ -1815,9 +1815,9 @@
 				    parsfound = savparsfound;
 				}
 				if (buf) {
-				    zfree(buf, pathpos + patinlen);
 				    patinstart = savpatinstart;
 				    patinlen = savpatinlen;
+				    zfree(buf, pathpos + patinlen);
 				}
 				if (!ret)
 				    break;

-- 
Peter Stephenson <pws@pwstephenson.fsnet.co.uk>
Work: pws@CambridgeSiliconRadio.com
Web: http://www.pwstephenson.fsnet.co.uk

