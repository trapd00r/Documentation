From zsh-workers-return-22464-mason-zsh=primenet.com.au@sunsite.dk Fri May 26 22:41:14 2006
Return-Path: <zsh-workers-return-22464-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 9149 invoked from network); 26 May 2006 22:41:10 -0000
X-Spam-Checker-Version: SpamAssassin 3.1.1 (2006-03-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=BAYES_00,FORGED_RCVD_HELO 
	autolearn=ham version=3.1.1
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 26 May 2006 22:41:10 -0000
Received: (qmail 91487 invoked from network); 26 May 2006 22:41:02 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 26 May 2006 22:41:02 -0000
Received: (qmail 591 invoked by alias); 26 May 2006 22:40:59 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 22464
Received: (qmail 581 invoked from network); 26 May 2006 22:40:58 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 26 May 2006 22:40:58 -0000
Received: (qmail 91254 invoked from network); 26 May 2006 22:40:58 -0000
Received: from mta07-winn.ispmail.ntl.com (HELO mtaout01-winn.ispmail.ntl.com) (81.103.221.47)
  by a.mx.sunsite.dk with SMTP; 26 May 2006 22:40:58 -0000
Received: from aamtaout01-winn.ispmail.ntl.com ([81.103.221.35])
          by mtaout01-winn.ispmail.ntl.com with ESMTP
          id <20060526224057.CXGH29343.mtaout01-winn.ispmail.ntl.com@aamtaout01-winn.ispmail.ntl.com>
          for <zsh-workers@sunsite.dk>; Fri, 26 May 2006 23:40:57 +0100
Received: from pwslaptop.csr.com ([81.107.47.162])
          by aamtaout01-winn.ispmail.ntl.com with ESMTP
          id <20060526224057.UZQQ19763.aamtaout01-winn.ispmail.ntl.com@pwslaptop.csr.com>
          for <zsh-workers@sunsite.dk>; Fri, 26 May 2006 23:40:57 +0100
Received: from pwslaptop.csr.com (pwslaptop.csr.com [127.0.0.1])
	by pwslaptop.csr.com (8.13.6/8.13.4) with ESMTP id k4QMekr6018394
	for <zsh-workers@sunsite.dk>; Fri, 26 May 2006 23:40:47 +0100
Message-Id: <200605262240.k4QMekr6018394@pwslaptop.csr.com>
From: Peter Stephenson <p.w.stephenson@ntlworld.com>
To: zsh-workers@sunsite.dk
Subject: Re: core dump with prompt_subst and unusual PROMPT [4.3.2,4.2.6,4.2.1] 
In-Reply-To: Message from Matt Pharr <matt@pharr.org> 
   of "Fri, 26 May 2006 11:41:30 PDT." <2C53493B-C458-475A-957B-D830B1D1FA1F@pharr.org> 
Date: Fri, 26 May 2006 23:40:46 +0100

Matt Pharr wrote:
> If I source the following script (extracted from my .zshrc file), zsh  
> dumps core--I've reproduced this on 4.2.1, 4.2.6, and 4.3.2.   
> Admittedly it's pretty ugly and possibly malformed, though a core  
> dump's a core dump...  A representative stack trace (from 4.3.2) is  
> below.
> 
> thanks,
> -matt
> 
> --- snip ---
> PROMPT='[${{NKAPPDIR##/home/mmp/sw/}%%nkapp}] %(?..err %B%?%b )%(1v.%B 
> %v%b .)%B%#%b '

Thanks... it's actually just the prompt.  It's trying to warn you that
there's a bad substitution in the prompt (you're on your own there...),
and in order to warn you that it's having trouble with substitutions in
the prompt it needs to ensure that the zle display is in order, and to
do that it reexpands the prompt...  which is quite bad luck at this
point.

Index: Src/Zle/zle_main.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/zle_main.c,v
retrieving revision 1.85
diff -u -r1.85 zle_main.c
--- Src/Zle/zle_main.c	25 Apr 2006 15:00:27 -0000	1.85
+++ Src/Zle/zle_main.c	26 May 2006 22:36:41 -0000
@@ -1509,10 +1509,15 @@
 void
 reexpandprompt(void)
 {
-    free(lpromptbuf);
-    lpromptbuf = promptexpand(raw_lp ? *raw_lp : NULL, 1, NULL, NULL);
-    free(rpromptbuf);
-    rpromptbuf = promptexpand(raw_rp ? *raw_rp : NULL, 1, NULL, NULL);
+    static reexpanding;
+
+    if (!reexpanding++) {
+	free(lpromptbuf);
+	lpromptbuf = promptexpand(raw_lp ? *raw_lp : NULL, 1, NULL, NULL);
+	free(rpromptbuf);
+	rpromptbuf = promptexpand(raw_rp ? *raw_rp : NULL, 1, NULL, NULL);
+    }
+    reexpanding--;
 }
 
 /**/

-- 
Peter Stephenson <p.w.stephenson@ntlworld.com>
Web page now at http://homepage.ntlworld.com/p.w.stephenson/

