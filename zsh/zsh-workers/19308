From zsh-workers-return-19308-mason-zsh=primenet.com.au@sunsite.dk Wed Dec 17 20:43:34 2003
Return-Path: <zsh-workers-return-19308-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 28515 invoked from network); 17 Dec 2003 20:43:33 -0000
Received: from sunsite.dk (130.225.247.90)
  by ns1.primenet.com.au with SMTP; 17 Dec 2003 20:43:33 -0000
Received: (qmail 6815 invoked by alias); 17 Dec 2003 20:43:27 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 19308
Received: (qmail 6777 invoked from network); 17 Dec 2003 20:43:26 -0000
Received: from localhost (HELO sunsite.dk) (127.0.0.1)
  by localhost with SMTP; 17 Dec 2003 20:43:26 -0000
X-MessageWall-Score: 0 (sunsite.dk)
Received: from [80.184.45.135] by sunsite.dk (MessageWall 1.0.8) with SMTP; 17 Dec 2003 20:43:26 -0000
Received: from opk by athlon with esmtp (masqmail 0.2.20) id
 1AWigO-4Dd-00 for <zsh-workers@sunsite.dk>; Wed, 17 Dec 2003 21:54:12
 +0100
From: Oliver Kiddle <okiddle@yahoo.co.uk>
To: Zsh workers <zsh-workers@sunsite.dk>
Subject: PATCH: $((##)) causes seg fault
Date: Wed, 17 Dec 2003 21:54:12 +0100
Message-ID: <16220.1071694452@athlon>

I just noticed that there is a bug report filed on Sourceforge: ((##))
causes a segmentation fault. Fix is below. Should I be printing an error
message instead of returning zero?

This is also applicable to 4.0

Oliver

Index: Src/utils.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/utils.c,v
retrieving revision 1.56
diff -u -r1.56 utils.c
--- Src/utils.c	29 Oct 2003 19:17:30 -0000	1.56
+++ Src/utils.c	17 Dec 2003 20:38:24 -0000
@@ -3643,7 +3643,10 @@
     }
     DPUTS(fromwhere == 4, "BUG: unterminated $' substitution");
     *t = '\0';
-    *len = t - buf;
+    if (fromwhere == 6)
+      *misc = 0;
+    else
+      *len = t - buf;
     return buf;
 }
 
Index: Test/C01arith.ztst
===================================================================
RCS file: /cvsroot/zsh/zsh/Test/C01arith.ztst,v
retrieving revision 1.6
diff -u -r1.6 C01arith.ztst
--- Test/C01arith.ztst	26 Mar 2003 17:33:40 -0000	1.6
+++ Test/C01arith.ztst	17 Dec 2003 20:38:24 -0000
@@ -68,6 +68,14 @@
 0:#, ## and $#
 >117
 
+  print $((##))
+0:## without following character
+>0
+
+  print $((## ))
+0:## followed by a space
+>32
+
   integer i
   (( i = 3 + 5 * 1.75 ))
   print $i

