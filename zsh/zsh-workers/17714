From zsh-workers-return-17714-mason-zsh=primenet.com.au@sunsite.dk Thu Sep 19 18:10:30 2002
Return-Path: <zsh-workers-return-17714-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 25880 invoked from network); 19 Sep 2002 18:10:29 -0000
Received: from sunsite.dk (130.225.247.90)
  by ns1.primenet.com.au with SMTP; 19 Sep 2002 18:10:29 -0000
Received: (qmail 23419 invoked by alias); 19 Sep 2002 18:10:20 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 17714
Received: (qmail 23404 invoked from network); 19 Sep 2002 18:10:18 -0000
From: "Bart Schaefer" <schaefer@brasslantern.com>
Message-Id: <1020919180950.ZM21210@candle.brasslantern.com>
Date: Thu, 19 Sep 2002 18:09:50 +0000
X-Mailer: Z-Mail (5.0.0 30July97)
To: zsh-workers@sunsite.dk
Subject: PATCH: Module loading when ARGV0=sh
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii

Turns out that 17537 was a bit too aggressive:  The module dependencies
need to be set up even if the autoloads are not.

E.g.:

ARGV0=sh /usr/local/bin/zsh-4.0.6 -f
zsh: failed to load module: zsh/compctl
$ 

The failure occurrs because zsh/complete is not loaded and the dependency
of zsh/compctl upon it was not established.

The following takes care of it.

Index: Src/mkbltnmlst.sh
===================================================================
diff -c -r1.2 mkbltnmlst.sh
--- Src/mkbltnmlst.sh	1 Sep 2002 16:47:38 -0000	1.2
+++ Src/mkbltnmlst.sh	19 Sep 2002 18:02:41 -0000
@@ -20,7 +20,6 @@
 
 exec > $1
 
-echo "  if (emulation == EMULATE_ZSH) {"
 for x_mod in $x_mods; do
     modfile="`grep '^name='$x_mod' ' $CFMOD | sed -e 's/^.* modfile=//' \
       -e 's/ .*//'`"
@@ -41,6 +40,7 @@
     unset moddeps autobins autoinfixconds autoprefixconds autoparams
     unset automathfuncs
     . $srcdir/../$modfile
+    echo "  if (emulation == EMULATE_ZSH) {"
     for bin in $autobins; do
 	echo "    add_autobin(\"$bin\", \"$x_mod\");"
     done
@@ -56,12 +56,12 @@
     for mfunc in $automathfuncs; do
 	echo "    add_automath(\"$mfunc\", \"$x_mod\");"
     done
+    echo "  }"
     for dep in $moddeps; do
-	echo "    add_dep(\"$x_mod\", \"$dep\");"
+	echo "  add_dep(\"$x_mod\", \"$dep\");"
     done
     test "x$linked" = xno && echo "#endif"
 done
-echo "  }"
 
 echo
 done_mods=" "

-- 
Bart Schaefer                                 Brass Lantern Enterprises
http://www.well.com/user/barts              http://www.brasslantern.com

Zsh: http://www.zsh.org | PHPerl Project: http://phperl.sourceforge.net   

