From zsh-workers-return-23429-mason-zsh=primenet.com.au@sunsite.dk Fri May 11 16:24:17 2007
Return-Path: <zsh-workers-return-23429-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 2668 invoked from network); 11 May 2007 16:24:15 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.0 (2007-05-01) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-1.8 required=5.0 tests=BAYES_00,
	MSGID_FROM_MTA_HEADER,UNPARSEABLE_RELAY autolearn=no version=3.2.0
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 11 May 2007 16:24:15 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 43140 invoked from network); 11 May 2007 16:24:08 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 11 May 2007 16:24:08 -0000
Received: (qmail 13941 invoked by alias); 11 May 2007 16:24:05 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 23429
Received: (qmail 13931 invoked from network); 11 May 2007 16:24:04 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 11 May 2007 16:24:04 -0000
Received: (qmail 42748 invoked from network); 11 May 2007 16:24:04 -0000
Received: from smtpout.mac.com (17.250.248.181)
  by a.mx.sunsite.dk with SMTP; 11 May 2007 16:24:01 -0000
Received: from webmail011 (webmail011-s [10.13.128.11])
	by smtpout.mac.com (Xserve/smtpout11/MantshX 4.0) with ESMTP id l4BGNDfL016455;
	Fri, 11 May 2007 09:23:13 -0700 (PDT)
Date: Fri, 11 May 2007 09:23:13 -0700
From: Jordan Breeding <jordan.breeding@mac.com>
To: Peter Stephenson <pws@csr.com>
Cc: zsh-workers@sunsite.dk
Message-ID: <2DF07A7A-0112-1000-86BB-08869130C191-Webmail-10013@mac.com>
in-reply-to: <200705110928.l4B9Sobe019086@news01.csr.com>
references: <Pine.OSF.4.64.0705101117330.479844@replicant.hut.fi>
 <20070510175541.GA67479@redoubt.spodhuis.org>
 <alpine.OSF.0.99.0705102221080.265865@replicant.hut.fi>
 <20070510222647.GA45037@redoubt.spodhuis.org> <200705110928.l4B9Sobe019086@news01.csr.com>
Subject: Re: problems with 4.3.4 and Tru64
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 7bit
X-Originating-IP: 199.171.212.100
Received: from [199.171.212.100] from webmail.mac.com with HTTP; Fri, 11 May 2007 09:23:13 -0700
X-Brightmail-Tracker: AAAAAA==
X-Brightmail-scanned: yes

On Friday, May 11, 2007, at 04:29AM, "Peter Stephenson" <pws@csr.com> wrote:
>Phil Pennock wrote:
>> > > If these display fine, then multibyte is working and parts of zle are
>> > > working; the problem will be in input processing.  If these don't
>> > > display, then the problem's not in the input processing.
>> > 
>> >  Touche, that works!
>> > 
>> >  Now, how to fix input processing?-)
>
>The fact they display doesn't tell you very much.  You also need to
>check that once you've got them on the command line they behave like a
>single character.  The easiest way is just to move the cursor and check
>it doesn't go to far (which it will if doesn't recognise the two bytes
>as a single character).
>
>If that's really working, input processing is quite involved to check.
>The key function for this is getrestchar() in Src/Zle/zle_main.c.  This
>should recognise the first byte is an incomplete character and the
>second byte completes it.  I don't think this an easy way to avoid
>debugging the insides.
>

<snipped>

Hello,

I have been following this thread as it interests me since I have had trouble getting multibyte to work the way I would expect on OS X.  This thread inspired me to dig a little deeper since I can always see the characters, but with multibyte on echo/printf didn't seem to like the combined characters, and with multibyte off the line editor can't keep straight that it is one character.  I will file a bug report with Apple to turn on multibyte in zsh now since in zsh 4.3.4 it seems to work fine.  The other problems I was having were caused by preexec().  I had some print() statments in precmd() and preexec().  precmd() and chpwd() seem to have no effect on whether multibyte works or not, but this preexec():

preexec() {
  print -Pn "\e]2;%n@%m %0~ (%30>...>${1}%>>%)\a"
}

causes echo/print to misbehave.

My test case was to do `echo h<combined character>lp` where the combined character is either <option-u>e or <ctrl-x k>e:

with the preexec enabled I get:
<combined character>h<combined character>lp

as the output, without it it just echoes exactly what it should.  So I think for the most part my problems are solved now.  It would be nice to still be able to use preexec, but I assume that hopefully that bug can be fixed in the future.

Jordan

