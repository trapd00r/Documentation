From zsh-workers-return-25362-mason-zsh=primenet.com.au@sunsite.dk Thu Jul 31 10:05:49 2008
Return-Path: <zsh-workers-return-25362-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 16936 invoked from network); 31 Jul 2008 10:05:45 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00,WEIRD_PORT
	autolearn=no version=3.2.5
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 31 Jul 2008 10:05:45 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 80346 invoked from network); 31 Jul 2008 10:05:38 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 31 Jul 2008 10:05:38 -0000
Received: (qmail 17150 invoked by alias); 31 Jul 2008 10:05:35 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 25362
Received: (qmail 17136 invoked from network); 31 Jul 2008 10:05:34 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 31 Jul 2008 10:05:34 -0000
Received: from rv-out-0506.google.com (rv-out-0506.google.com [209.85.198.226])
	by bifrost.dotsrc.org (Postfix) with ESMTP id 6291B805A42F
	for <zsh-workers@sunsite.dk>; Thu, 31 Jul 2008 12:05:31 +0200 (CEST)
Received: by rv-out-0506.google.com with SMTP id g37so424741rvb.21
        for <zsh-workers@sunsite.dk>; Thu, 31 Jul 2008 03:05:30 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=gamma;
        h=domainkey-signature:received:received:message-id:date:from:to
         :subject:in-reply-to:mime-version:content-type
         :content-transfer-encoding:content-disposition:references;
        bh=wvLxpLKCi1gj856OABo+Kf/rdlmlKppRdj8EjJu5S+k=;
        b=wqNJP5kodsyIIV7hc7bInqt2tULaYENzjx7c916RHHM4c4ixtvDBepqG2X38kEvbhJ
         KwfBVBTREP0mhyWUohFfobn/tK36Ww+rDejNmbH8P5HnNR60VoWbukEvAfvQ0Mhc7I9V
         hpzumUlLL2hoaf8ZE1Ky+r/ypxmM5XdBpO61Y=
DomainKey-Signature: a=rsa-sha1; c=nofws;
        d=gmail.com; s=gamma;
        h=message-id:date:from:to:subject:in-reply-to:mime-version
         :content-type:content-transfer-encoding:content-disposition
         :references;
        b=U9yT4OMdmogeLh8R7AQCvobkCJxIlulQ1HOuOaAGwHHsN1rP7RTdhqVE5BTsWZ7aHO
         qk3FQ4rAPEkpa6aKhGyKzELcv3M60jkMrPJQxeEkMkoBSjfhDAZQ/BObcTlthC4QpNr6
         XUmFtIKf2Qp/OqW3RO/Gw3rMfisOS1XS6b8jE=
Received: by 10.115.47.1 with SMTP id z1mr9821946waj.129.1217498730071;
        Thu, 31 Jul 2008 03:05:30 -0700 (PDT)
Received: by 10.114.159.2 with HTTP; Thu, 31 Jul 2008 03:05:30 -0700 (PDT)
Message-ID: <6cd6de210807310305q5954b65ax405f51e54d6754ee@mail.gmail.com>
Date: Thu, 31 Jul 2008 06:05:30 -0400
From: "Rocky Bernstein" <rocky.bernstein@gmail.com>
To: zsh-workers@sunsite.dk
Subject: Re: Weird exit caused in a trap DEBUG which sources a file.
In-Reply-To: <200807310901.m6V91g8T002478@news01.csr.com>
MIME-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 7bit
Content-Disposition: inline
References: <6cd6de210807301938m28e05c84vf6296aa5b1bc0d44@mail.gmail.com>
	 <200807310901.m6V91g8T002478@news01.csr.com>
X-Virus-Scanned: ClamAV 0.92.1/7898/Thu Jul 31 08:42:41 2008 on bifrost
X-Virus-Status: Clean

I don't get different results by adding -f. However I do get different
results depending on the zsh version.

The buggy output was run using the stock zsh for Ubunty Hardy Heron:
zsh 4.3.4 (i686-pc-linux-gnu)

I don't get it for the "zsh-beta" package which is
zsh 4.3.5-dev-0+ (i686-pc-linux-gnu)

Life would be good were that were the end of the story.

This is this is whittled down from a larger set of files, and in that
larger set, I still have the problem no matter which of the above two
zsh's is used or a third or the one I built from recent CVS with the
patches I posted applied. So it looks like I'll have to go back and
start again from the larger program and whittle it down again.

If anyone is aware of what bug was fixed between 4.3.4 and 4.3.5-dev-0
that addresses this, it might help understand the nature of the
problem better. (I will also at some point scour ChangeLogs to try to
figure this out too.)

Thanks for double checking and the suggestions.


On Thu, Jul 31, 2008 at 5:01 AM, Peter Stephenson <pws@csr.com> wrote:
> "Rocky Bernstein" wrote:
>> Below is a small program whittled down from a larger one. It has
>> behavior I can't figure out.
>>
>> It seems to show that when a function is called via trap DEBUG and you
>> then source a file and it has a statement in it, on return from the
>> TRAP an exit will be taken.  Here is the program:
>>
>> #!/usr/bin/zsh
>> function debug_trap_handler {
>>     print $functrace[1]
>>     do_bug
>> }
>>
>> function do_bug {
>>    . ./bug-file
>> }
>>
>> trap 'echo EXIT hit' EXIT
>> trap 'debug_trap_handler' DEBUG
>> a=1
>> b=2
>> d=3
>>
>> In "bug-file" put any command. ":" will do. Or a print statement.
>> Let's say it contains the line:
>> print bug file here
>>
>> When I run the above I get:
>>
>> $ ./zshtrace.sh
>>
>> ./zshtrace.sh:12
>> bug file here
>> EXIT hit
>
> That certainly looks like a bug, but it didn't happen for me.  What
> version of the shell do you have, and does it happen with the -f option
> after /usr/bin/zsh?
>
> --
> Peter Stephenson <pws@csr.com>                  Software Engineer
> CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
> Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070
>

