From zsh-workers-return-23278-mason-zsh=primenet.com.au@sunsite.dk Sun Apr 15 21:25:55 2007
Return-Path: <zsh-workers-return-23278-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 7739 invoked from network); 15 Apr 2007 21:25:53 -0000
X-Spam-Checker-Version: SpamAssassin 3.1.8 (2007-02-13) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=BAYES_00,FORGED_RCVD_HELO
	autolearn=ham version=3.1.8
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 15 Apr 2007 21:25:53 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 68204 invoked from network); 15 Apr 2007 21:25:48 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 15 Apr 2007 21:25:48 -0000
Received: (qmail 27078 invoked by alias); 15 Apr 2007 21:25:45 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 23278
Received: (qmail 27066 invoked from network); 15 Apr 2007 21:25:44 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 15 Apr 2007 21:25:44 -0000
Received: (qmail 67877 invoked from network); 15 Apr 2007 21:25:44 -0000
Received: from mtaout03-winn.ispmail.ntl.com (81.103.221.49)
  by a.mx.sunsite.dk with SMTP; 15 Apr 2007 21:25:35 -0000
Received: from aamtaout04-winn.ispmail.ntl.com ([81.103.221.35])
          by mtaout03-winn.ispmail.ntl.com with ESMTP
          id <20070415212552.CHWP4739.mtaout03-winn.ispmail.ntl.com@aamtaout04-winn.ispmail.ntl.com>
          for <zsh-workers@sunsite.dk>; Sun, 15 Apr 2007 22:25:52 +0100
Received: from pwslaptop.csr.com ([81.107.41.251])
          by aamtaout04-winn.ispmail.ntl.com with ESMTP
          id <20070415212533.XUCT29112.aamtaout04-winn.ispmail.ntl.com@pwslaptop.csr.com>
          for <zsh-workers@sunsite.dk>; Sun, 15 Apr 2007 22:25:33 +0100
Received: from pwslaptop.csr.com (pwslaptop.csr.com [127.0.0.1])
	by pwslaptop.csr.com (8.13.8/8.13.7) with ESMTP id l3FLinCF011177
	for <zsh-workers@sunsite.dk>; Sun, 15 Apr 2007 22:44:52 +0100
Message-Id: <200704152144.l3FLinCF011177@pwslaptop.csr.com>
From: Peter Stephenson <p.w.stephenson@ntlworld.com>
To: zsh-workers@sunsite.dk (Zsh hackers list)
Subject: PATCH: numericglobsort
Date: Sun, 15 Apr 2007 22:44:49 +0100

Here's something else I broke (in 23118).  There's already a test for
numericglobsort, but it turns out it works in the C locale.  I've
duplicated the test in the multibyte code, although the problem is not
strictly dependent on multibyte support.  For some reason in the UTF-8
locales zero sorts ahead of dot instead of vice versa; goodness knows
why but ls confirms this isn't just zsh.

Index: Src/sort.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/sort.c,v
retrieving revision 1.3
diff -u -r1.3 sort.c
--- Src/sort.c	22 Jan 2007 17:28:16 -0000	1.3
+++ Src/sort.c	15 Apr 2007 21:20:35 -0000
@@ -42,8 +42,8 @@
 {
     const SortElt ae = *(const SortElt *)a;
     const SortElt be = *(const SortElt *)b;
-    const char *as = ae->cmp;
-    const char *bs = be->cmp;
+    const char *as = ae->cmp, *bs = be->cmp;
+    const char *ao = as;
     int cmp;
 
     if (ae->len != -1 || be->len != -1) {
@@ -122,7 +122,7 @@
 	cmp = (int)STOUC(*as) - (int)STOUC(*bs);
 #endif
 	if (idigit(*as) || idigit(*bs)) {
-	    for (; as > *(char **)a && idigit(as[-1]); as--, bs--);
+	    for (; as > ao && idigit(as[-1]); as--, bs--);
 	    if (idigit(*as) && idigit(*bs)) {
 		while (*as == '0')
 		    as++;
Index: Test/D07multibyte.ztst
===================================================================
RCS file: /cvsroot/zsh/zsh/Test/D07multibyte.ztst,v
retrieving revision 1.15
diff -u -r1.15 D07multibyte.ztst
--- Test/D07multibyte.ztst	10 Feb 2007 22:12:59 -0000	1.15
+++ Test/D07multibyte.ztst	15 Apr 2007 21:20:35 -0000
@@ -358,3 +358,22 @@
 >1 148
 >1 149
 >1 150
+
+  touch ngs1.txt ngs2.txt ngs10.txt ngs20.txt ngs100.txt ngs200.txt
+  setopt numericglobsort
+  print -l ngs*
+  unsetopt numericglobsort
+  print -l ngs*
+0:NUMERIC_GLOB_SORT option in UTF-8 locale
+>ngs1.txt
+>ngs2.txt
+>ngs10.txt
+>ngs20.txt
+>ngs100.txt
+>ngs200.txt
+>ngs100.txt
+>ngs10.txt
+>ngs1.txt
+>ngs200.txt
+>ngs20.txt
+>ngs2.txt

-- 
Peter Stephenson <p.w.stephenson@ntlworld.com>
Web page now at http://homepage.ntlworld.com/p.w.stephenson/

