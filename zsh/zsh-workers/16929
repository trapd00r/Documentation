From zsh-workers-return-16929-mason-zsh=primenet.com.au@sunsite.dk Fri Mar 29 10:03:05 2002
Return-Path: <zsh-workers-return-16929-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 2141 invoked from network); 29 Mar 2002 10:03:05 -0000
Received: from sunsite.dk (130.225.247.90)
  by ns1.primenet.com.au with SMTP; 29 Mar 2002 10:03:05 -0000
Received: (qmail 7548 invoked by alias); 29 Mar 2002 10:02:52 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 16929
Received: (qmail 7531 invoked from network); 29 Mar 2002 10:02:50 -0000
To: zsh-workers@sunsite.dk
Subject: Re: PATCH: environ overflow in zexecve()
References: <877knw2w5x.fsf@lrde.epita.fr>
From: Alexandre Duret-Lutz <duret_g@lrde.epita.fr>
X-Home-Page: http://www.epita.fr/~duret_g/
Date: 29 Mar 2002 11:02:45 +0100
In-Reply-To: <877knw2w5x.fsf@lrde.epita.fr>
Lines: 77
User-Agent: Gnus/5.0808 (Gnus v5.8.8) Emacs/20.7
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Message-ID: <2002-03-29-11-02-47+17785+duret_g@epita.fr>
X-Attribution: adl
Sender: Alexandre Duret-Lutz <duret_g@lrde.epita.fr>

| @@ -345,6 +345,8 @@
|      for (eep = argv; *eep; eep++)
|         if (*eep != pth)
|             unmetafy(*eep, NULL);
| +
| +    /* Search $_ in the environment, then update or insert it.  */
|      for (eep = environ; *eep; eep++)
|         if (**eep == '_' && (*eep)[1] == '=')
|             break;
| @@ -354,9 +356,11 @@
|         strcpy(buf + 2, pth);
|      else
|         sprintf(buf + 2, "%s/%s", pwd, pth);
| -    if (!*eep)
| -	eep[1] = NULL;
| -    *eep = buf;
| +    if (*eep)
| +      zputenv(buf);
| +    else
| +      *eep = buf;
| +
|      closedumps();
|      execve(pth, argv, environ);
|  

Stupid me.  Let's simplify this further by always using putenv.


Index: Src/exec.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/exec.c,v
retrieving revision 1.40
diff -u -r1.40 exec.c
--- Src/exec.c	17 Dec 2001 17:17:38 -0000	1.40
+++ Src/exec.c	29 Mar 2002 09:57:23 -0000
@@ -345,18 +345,16 @@
     for (eep = argv; *eep; eep++)
 	if (*eep != pth)
 	    unmetafy(*eep, NULL);
-    for (eep = environ; *eep; eep++)
-	if (**eep == '_' && (*eep)[1] == '=')
-	    break;
+
+    /* Update $_.  */
     buf[0] = '_';
     buf[1] = '=';
     if (*pth == '/')
 	strcpy(buf + 2, pth);
     else
 	sprintf(buf + 2, "%s/%s", pwd, pth);
-    if (!*eep)
-	eep[1] = NULL;
-    *eep = buf;
+    zputenv(buf);
+
     closedumps();
     execve(pth, argv, environ);
 
Index: Src/params.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/params.c,v
retrieving revision 1.63
diff -u -r1.63 params.c
--- Src/params.c	24 Mar 2002 23:52:49 -0000	1.63
+++ Src/params.c	29 Mar 2002 09:57:29 -0000
@@ -3125,7 +3125,8 @@
 }
 
 
-static int
+/**/
+int
 zputenv(char *str)
 {
 #ifdef HAVE_PUTENV
-- 
Alexandre Duret-Lutz

