From zsh-workers-return-9020-mason-zsh=primenet.com.au@sunsite.auc.dk Mon Dec 13 13:39:39 1999
Return-Path: <zsh-workers-return-9020-mason-zsh=primenet.com.au@sunsite.auc.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 25770 invoked from network); 13 Dec 1999 13:39:38 -0000
Received: from sunsite.auc.dk (130.225.51.30)
  by ns1.primenet.com.au with SMTP; 13 Dec 1999 13:39:38 -0000
Received: (qmail 9896 invoked by alias); 13 Dec 1999 13:39:27 -0000
Mailing-List: contact zsh-workers-help@sunsite.auc.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.auc.dk
X-Seq: 9020
Received: (qmail 9888 invoked from network); 13 Dec 1999 13:39:24 -0000
Date: Mon, 13 Dec 1999 14:39:22 +0100 (MET)
Message-Id: <199912131339.OAA25639@beta.informatik.hu-berlin.de>
From: Sven Wischnowsky <wischnow@informatik.hu-berlin.de>
To: zsh-workers@sunsite.auc.dk
In-reply-to: Zefram's message of Mon, 13 Dec 1999 10:54:12 +0000 (GMT)
Subject: Re: two completion questions


[ Moved to zsh-workers ]

Zefram wrote:

> Bart Schaefer wrote:
> >If you're using the new function-based completion in 3.1.6, it's going to
> >require some editing of the _path_files completer.  Hey, Sven, do you (or
> >any other zsh-workers) remember the rationale for this handling of ".."?
> 
> Globbing and completion never generate "." or ".." components; they are
> filtered out in zreaddir().  The reason for this is that they are pretty
> much never what you want.  If you have files named ".foo" and ".bar",
> then type "." and press tab, are "." and ".." really what you want to
> complete to?  Maybe there should be an option to complete to "." and
> ".." just like normal filenames, but I think the default should very
> definitely stay as being the current behaviour.

Right. This makes it configurable with the special-dirs style. Can
anyone think of a better name?

Bye
 Sven

diff -ru ../z.old/Completion/Core/_path_files Completion/Core/_path_files
--- ../z.old/Completion/Core/_path_files	Mon Dec 13 14:22:15 1999
+++ Completion/Core/_path_files	Mon Dec 13 14:37:14 1999
@@ -224,12 +224,19 @@
 
     if [[ "$tpre$tsuf" = */* ]]; then
       tmp2=( ${^tmp1}*(-/) )
-      [[ ! -o globdots && "$PREFIX" = .* ]] &&
-          tmp2=( "$tmp2[@]" ${^tmp1}.*(-/) . .. )
+      if [[ ! -o globdots && "$PREFIX" = .* ]]; then
+        tmp2=( "$tmp2[@]" ${^tmp1}.*(-/) )
+	zstyle -t ":completion${curcontext}:paths" special-dirs &&
+	    tmp2=( "$tmp2[@]" . .. )
+      fi
     else
       tmp2=( ${^tmp1}${^~pats} )
-      [[ ! -o globdots && "$PREFIX" = .* ]] &&
-          tmp2=( "$tmp2[@]" ${^tmp1}.${^~pats} . .. )
+      if [[ ! -o globdots && "$PREFIX" = .* ]]; then
+        tmp2=( "$tmp2[@]" ${^tmp1}.${^~pats} )
+        [[ "$sopt" = */* ]] &&
+	    zstyle -t ":completion${curcontext}:paths" special-dirs &&
+	    tmp2=( "$tmp2[@]" . .. )
+      fi
     fi
     tmp1=( "$tmp2[@]" )
 
diff -ru ../z.old/Doc/Zsh/compsys.yo Doc/Zsh/compsys.yo
--- ../z.old/Doc/Zsh/compsys.yo	Mon Dec 13 14:21:51 1999
+++ Doc/Zsh/compsys.yo	Mon Dec 13 14:36:50 1999
@@ -647,7 +647,8 @@
 completing for the tt(cd) builtin command
 )
 item(tt(paths))(
-used to look up the values of the tt(expand) and tt(cursor) styles
+used to look up the values of the tt(expand), tt(cursor) and
+tt(special-dirs) styles
 )
 item(tt(pods))(
 for perl pods
@@ -1191,6 +1192,11 @@
 as single strings (not in the string containing all possible
 expansions).
 )
+item(tt(special-dirs))(
+Normally, the completion code will not produce the directory names
+tt(.) and tt(..) as possible completions. If this style is set to
+`true', it will.
+)
 item(tt(stop))(
 If set to `true', the tt(_history_complete_word) bindable
 command will always insert matches as if menucompletion were started
@@ -1894,8 +1900,8 @@
 `tt(-2)', `tt(-n)', `tt(-X)', `tt(-M)', `tt(-P)', `tt(-S)', `tt(-q)',
 `tt(-r)', and `tt(-R)' options from the tt(compadd) builtin.
 
-Finally, the tt(_path_files) function  uses the styles tt(expand) and
-tt(cursor) with the tt(paths) tag.
+Finally, the tt(_path_files) function  uses the styles tt(expand),
+tt(cursor) and tt(special-dirs) with the tt(paths) tag.
 )
 findex(_parameters)
 item(tt(_parameters))(

--
Sven Wischnowsky                         wischnow@informatik.hu-berlin.de

