From zsh-users-return-14076-mason-zsh=primenet.com.au@sunsite.dk Thu Apr 30 00:14:04 2009
Return-Path: <zsh-users-return-14076-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 3764 invoked from network); 30 Apr 2009 00:13:51 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 30 Apr 2009 00:13:51 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 74297 invoked from network); 30 Apr 2009 00:13:36 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 30 Apr 2009 00:13:36 -0000
Received: (qmail 13560 invoked by alias); 30 Apr 2009 00:13:18 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 14076
Received: (qmail 13550 invoked from network); 30 Apr 2009 00:13:18 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 30 Apr 2009 00:13:18 -0000
Received: from vms173007pub.verizon.net (vms173007pub.verizon.net [206.46.173.7])
	by bifrost.dotsrc.org (Postfix) with ESMTP id 348068028C71
	for <zsh-users@sunsite.dk>; Thu, 30 Apr 2009 02:10:56 +0200 (CEST)
Received: from torch.brasslantern.com ([96.249.201.13])
 by vms173007.mailsrvcs.net
 (Sun Java(tm) System Messaging Server 6.3-7.04 (built Sep 26 2008; 32bit))
 with ESMTPA id <0KIW0075L0LKD0EX@vms173007.mailsrvcs.net> for
 zsh-users@sunsite.dk; Wed, 29 Apr 2009 19:13:01 -0500 (CDT)
Received: from torch.brasslantern.com (localhost.localdomain [127.0.0.1])
	by torch.brasslantern.com (8.13.1/8.13.1) with ESMTP id n3U0CsgI010471	for
 <zsh-users@sunsite.dk>; Wed, 29 Apr 2009 17:12:55 -0700
Received: (from schaefer@localhost)	by torch.brasslantern.com
 (8.13.1/8.13.1/Submit) id n3U0CsSV010470	for zsh-users@sunsite.dk; Wed,
 29 Apr 2009 17:12:54 -0700
From: Bart Schaefer <schaefer@brasslantern.com>
Message-id: <090429171254.ZM10469@torch.brasslantern.com>
Date: Wed, 29 Apr 2009 17:12:54 -0700
In-reply-to: <237967ef0904291136v63ae26f4mb08cbd577b3f4503@mail.gmail.com>
Comments: In reply to Mikael Magnusson <mikachu@gmail.com>
 "How to accept a completion?" (Apr 29,  8:36pm)
References: <237967ef0904291136v63ae26f4mb08cbd577b3f4503@mail.gmail.com>
X-Mailer: OpenZMail Classic (0.9.2 24April2005)
To: zsh-users@sunsite.dk
Subject: Re: How to accept a completion?
MIME-version: 1.0
Content-type: text/plain; charset=us-ascii
X-Virus-Scanned: ClamAV 0.92.1/9305/Wed Apr 29 15:43:01 2009 on bifrost
X-Virus-Status: Clean

On Apr 29,  8:36pm, Mikael Magnusson wrote:
}
} Okay, finally encountered a real example of this being annoying now.
} % scp file lt<tab>
} ---- file
} lth/
} ---- remote host name
} lth
} 
} tabbing to the remote host name gives me
} % scp file lth:
} Now how do i complete files on the remote end? If i press tab again i just get
} % scp file lth/
} And if i type a : i get
} % scp file lth::

This is a bug in the _ssh completer that's used for scp et al., not in
the way completion is supposed to work.  You should be able to type a
colon at that point to interrupt the completion cycle to go on to the
next completion.

I believe the following is the correct fix.  I tried some more specific
things with -r instead of -q but they seemed unsatisfactory.  (I'm not
sure why $suf needs to be an array at line 293?)


Index: Completion/Unix/Command/_ssh
===================================================================
retrieving revision 1.19
diff -c -r1.19 _ssh
--- _ssh	4 Nov 2008 04:47:52 -0000	1.19
+++ _ssh	29 Apr 2009 23:59:54 -0000
@@ -227,7 +227,7 @@
         esac
       else
         _wanted values expl 'configure file option' \
-            compadd -M 'm:{a-z}={A-Z}' -S '=' - \
+            compadd -M 'm:{a-z}={A-Z}' -qS '=' - \
 	    	AddressFamily \
                 AFSTokenPassing BatchMode BindAddress \
 		ChallengeResponseAuthentication CheckHostIP \
@@ -293,12 +293,12 @@
         _remote_files ${(kv)~opt_args[(I)-[FP1246]]/-P/-p} && ret=0
       elif compset -P '*@'; then
         suf=( -S '' )
-        compset -S ':*' || suf=( -S : )
+        compset -S ':*' || suf=( -qS : )
         _wanted hosts expl 'remote host name' _ssh_hosts $suf && ret=0
       else
         _alternative \
 	    'files:: _files' \
-	    'hosts:remote host name:_ssh_hosts -S:' \
+	    'hosts:remote host name:_ssh_hosts -qS:' \
 	    'users:user:_ssh_users -qS@' && ret=0
       fi
       ;;
@@ -306,10 +306,10 @@
       if compset -P '*:'; then
         _remote_files && ret=0
       elif compset -P '*@'; then
-        _wanted hosts expl host _ssh_hosts -S: && ret=0
+        _wanted hosts expl host _ssh_hosts -qS: && ret=0
       else
         _alternative \
-	    'hosts:remote host name:_ssh_hosts -S:' \
+	    'hosts:remote host name:_ssh_hosts -qS:' \
 	    'users:user:_ssh_users -qS@' && ret=0
       fi
       ;;

