From zsh-users-return-13418-mason-zsh=primenet.com.au@sunsite.dk Thu Oct 30 09:48:41 2008
Return-Path: <zsh-users-return-13418-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 11346 invoked from network); 30 Oct 2008 09:48:28 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.2 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 30 Oct 2008 09:48:28 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 16174 invoked from network); 30 Oct 2008 09:48:14 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 30 Oct 2008 09:48:14 -0000
Received: (qmail 20609 invoked by alias); 30 Oct 2008 09:47:48 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 13418
Received: (qmail 20592 invoked from network); 30 Oct 2008 09:47:47 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 30 Oct 2008 09:47:47 -0000
Received: from cluster-g.mailcontrol.com (cluster-g.mailcontrol.com [208.87.233.190])
	by bifrost.dotsrc.org (Postfix) with ESMTPS id A6BAB80524C0
	for <zsh-users@sunsite.dk>; Thu, 30 Oct 2008 10:47:44 +0100 (CET)
Received: from cameurexb01.EUROPE.ROOT.PRI ([193.128.72.68])
	by rly24g.srv.mailcontrol.com (MailControl) with ESMTP id m9U9lPMX016063
	for <zsh-users@sunsite.dk>; Thu, 30 Oct 2008 09:47:41 GMT
Received: from news01.csr.com ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.3959);
	 Thu, 30 Oct 2008 09:47:40 +0000
Received: from news01.csr.com (localhost.localdomain [127.0.0.1])
	by news01.csr.com (8.14.2/8.13.4) with ESMTP id m9U9lZww024113
	for <zsh-users@sunsite.dk>; Thu, 30 Oct 2008 09:47:35 GMT
Received: from csr.com (pws@localhost)
	by news01.csr.com (8.14.2/8.14.2/Submit) with ESMTP id m9U9lZa6024109
	for <zsh-users@sunsite.dk>; Thu, 30 Oct 2008 09:47:35 GMT
Message-Id: <200810300947.m9U9lZa6024109@news01.csr.com>
X-Authentication-Warning: news01.csr.com: pws owned process doing -bs
To: zsh-users@sunsite.dk
Subject: Re: Zsh 4.3.8 released
In-reply-to: <gebu0l$59s$1@ger.gmane.org>
References: <9764.1225282786@csr.com> <20081029225750.78dc8263@pws-pc> <gebu0l$59s$1@ger.gmane.org>
Comments: In-reply-to Thorsten Kampe <thorsten@thorstenkampe.de>
   message dated "Thu, 30 Oct 2008 10:15:58 +0100."
Date: Thu, 30 Oct 2008 09:47:35 +0000
From: Peter Stephenson <pws@csr.com>
X-OriginalArrivalTime: 30 Oct 2008 09:47:40.0410 (UTC) FILETIME=[8C7895A0:01C93A74]
X-Scanned-By: MailControl A-08-50-15 (www.mailcontrol.com) on 10.71.0.134
X-Virus-Scanned: ClamAV 0.92.1/8541/Thu Oct 30 03:54:28 2008 on bifrost
X-Virus-Status: Clean

Thorsten Kampe wrote:
> 4.3.8 also doesn't compile under Cygwin (while 4.3.6 dev 2 did)

I can't actually see any change that could be related.

> ./configure goes through but make gives:
> 
> make[3]: Entering directory `/cygdrive/c/data/compile/zsh-
> 4.3.8/Src/Modules'
> gcc -c -I.  -DHAVE_CONFIG_H -O3 -pipe  -o termcap.o termcap.c
> termcap.c: In function `scantermcap':
> termcap.c:238: error: `_nc_strcodes' declared as function returning an 
> array

This implies HAVE_STRCODES is not defined but strcodes is supplied
anyway.  It might be worth looking in config.log to see if the test for
strcodes threw up any odd errors (e.g. didn't compile for some spurious
reason).  Possibly there is yet more grief to do with ordering of tests
for terminal-related headers and libraries, though this hasn't changed
for months.

We could work around this as follows, and the change looks entirely
benign, but I suspect the problems in configure mean this isn't the
right fix.

Index: Src/Modules/termcap.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Modules/termcap.c,v
retrieving revision 1.25
diff -u -r1.25 termcap.c
--- Src/Modules/termcap.c	13 Mar 2008 11:11:04 -0000	1.25
+++ Src/Modules/termcap.c	30 Oct 2008 09:40:10 -0000
@@ -235,7 +235,7 @@
 #endif
 
 #ifndef HAVE_STRCODES
-    static char *strcodes[] = {
+    static char *zstrcodes[] = {
 	"ac", "bt", "bl", "cr", "ZA", "ZB", "ZC", "ZD", "cs", "rP", "ct",
 	"MC", "cl", "cb", "ce", "cd", "ch", "CC", "CW", "cm", "do", "ho",
 	"vi", "le", "CM", "ve", "nd", "ll", "up", "vs", "ZE", "dc", "dl",
@@ -302,7 +302,13 @@
     pm->node.flags = PM_READONLY | PM_SCALAR;
     pm->gsu.s = &nullsetscalar_gsu;
 
-    for (capcode = (char **)strcodes; *capcode; capcode++) {
+    for (capcode = (char **)
+#ifdef HAVE_STRCODES
+	     strcodes
+#else
+	     zstrcodes
+#endif
+	     ; *capcode; capcode++) {
 	if ((tcstr = (char *)tgetstr(*capcode,&u)) != NULL &&
 	    tcstr != (char *)-1) {
 	    pm->u.str = dupstring(tcstr);


-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070

