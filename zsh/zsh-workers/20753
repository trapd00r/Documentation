From zsh-workers-return-20753-mason-zsh=primenet.com.au@sunsite.dk Wed Jan 26 18:36:45 2005
Return-Path: <zsh-workers-return-20753-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 11621 invoked from network); 26 Jan 2005 18:36:44 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 26 Jan 2005 18:36:44 -0000
Received: (qmail 8300 invoked from network); 26 Jan 2005 18:36:38 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 26 Jan 2005 18:36:38 -0000
Received: (qmail 25371 invoked by alias); 26 Jan 2005 18:36:36 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 20753
Received: (qmail 25357 invoked from network); 26 Jan 2005 18:36:35 -0000
Received: from unknown (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 26 Jan 2005 18:36:35 -0000
Received: (qmail 7985 invoked from network); 26 Jan 2005 18:35:59 -0000
Received: from acolyte.scowler.net (216.254.112.45)
  by a.mx.sunsite.dk with SMTP; 26 Jan 2005 18:35:55 -0000
Received: by acolyte.scowler.net (Postfix, from userid 1000)
	id C665A7004D; Wed, 26 Jan 2005 13:35:53 -0500 (EST)
Date: Wed, 26 Jan 2005 13:35:53 -0500
From: Clint Adams <clint@zsh.org>
To: Peter Stephenson <pws@csr.com>
Cc: Zsh hackers list <zsh-workers@sunsite.dk>
Subject: Re: PATCH: zle_params.c
Message-ID: <20050126183553.GA8100@scowler.net>
Mail-Followup-To: Peter Stephenson <pws@csr.com>,
	Zsh hackers list <zsh-workers@sunsite.dk>
References: <200501261806.j0QI6Q2d021854@news01.csr.com>
Mime-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <200501261806.j0QI6Q2d021854@news01.csr.com>
User-Agent: Mutt/1.5.6+20040907i
X-Spam-Checker-Version: SpamAssassin 3.0.2 on a.mx.sunsite.dk
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=6.0 tests=AWL,BAYES_00 autolearn=ham 
	version=3.0.2
X-Spam-Hits: -2.6

> broken.  It also fixes a typo in zle_params.c.

Oops.

> -    memmove(zleline + len, zleline + zlecs, zlell - zlecs);
> -    memcpy(zleline, y, len);
> +    memmove((char *)(zleline + len), (char *)(zleline + zlecs),
> +	    (zlell - zlecs) * ZLE_CHAR_SIZE);
> +    ZS_memcpy(zleline, y, len);

Hmm.  For the sake of consistency..

Index: Src/system.h
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/system.h,v
retrieving revision 1.25
diff -u -r1.25 system.h
--- Src/system.h	26 Jan 2005 18:12:18 -0000	1.25
+++ Src/system.h	26 Jan 2005 18:34:04 -0000
@@ -727,6 +727,7 @@
 #define ZLETAB	L'\t'
 #define ZLENULSTR	L""
 #define ZS_memcpy wmemcpy
+#define ZS_memmove wmemmove
 #define ZC_icntrl iswcntrl
 #else
 typedef int ZLE_CHAR_T;
@@ -738,5 +739,6 @@
 #define ZLETAB	'\t'
 #define ZLENULSTR	""
 #define ZS_memcpy memcpy
+#define ZS_memmove memmove
 #define ZC_icntrl icntrl
 #endif
Index: Src/Zle/zle_params.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/zle_params.c,v
retrieving revision 1.22
diff -u -r1.22 zle_params.c
--- Src/Zle/zle_params.c	26 Jan 2005 18:12:18 -0000	1.22
+++ Src/Zle/zle_params.c	26 Jan 2005 18:34:04 -0000
@@ -242,8 +242,7 @@
     else
 	y = ZLENULSTR, len = 0;
     sizeline(zlell - zlecs + len);
-    memmove((char *)(zleline + len), (char *)(zleline + zlecs),
-	    (zlell - zlecs) * ZLE_CHAR_SIZE);
+    ZS_memmove(zleline + len, zleline + zlecs, zlell - zlecs);
     ZS_memcpy(zleline, y, len);
     zlell = zlell - zlecs + len;
     zlecs = len;

