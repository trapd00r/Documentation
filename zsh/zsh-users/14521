From zsh-users-return-14521-mason-zsh=primenet.com.au@zsh.org Tue Nov 03 16:35:09 2009
Return-Path: <zsh-users-return-14521-mason-zsh=primenet.com.au@zsh.org>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 14373 invoked by alias); 3 Nov 2009 16:35:09 -0000
Mailing-List: contact zsh-users-help@zsh.org; run by ezmlm
Precedence: bulk
X-No-Archive: yes
List-Id: Zsh Users List <zsh-users.zsh.org>
List-Post: <mailto:zsh-users@zsh.org>
List-Help: <mailto:zsh-users-help@zsh.org>
Delivered-To: mailing list zsh-users@zsh.org
X-Seq: 14521
Received: (qmail 24132 invoked from network); 3 Nov 2009 16:35:04 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received-SPF: pass (ns1.primenet.com.au: SPF record at _spf.google.com designates 209.85.218.210 as permitted sender)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=gamma;
        h=domainkey-signature:mime-version:received:date:message-id:subject
         :from:to:content-type;
        bh=MMzbVoNBvNM4PY2hvVdM2JsoZ1OdzXLpSSi6Z/Vpers=;
        b=uS6un8WlyI4t6cge7X4SqpVEzBWRrH1+IdEf+tmjOJGPcIQTkyYzp8x0RdOSlpmOPe
         QoScpcJIQuYvRF2Cc49SHkxCudyiZp1RTo81f0ah+I8/p0g9NO44+enHxyWVNw2f2ryM
         x/w9toHMPo8UPqjr4GOfJenpyO4zb14s6rmOc=
DomainKey-Signature: a=rsa-sha1; c=nofws;
        d=gmail.com; s=gamma;
        h=mime-version:date:message-id:subject:from:to:content-type;
        b=CNggJXvO/pY0v6cEDKYbMnUkvtr71nSuzyIt6HSMfOl/dW2kAlF2UAV5hdOgtRnYio
         ZX47SBGXhtXc9luaSaKEu4U0Can7DWd8xMqKyrWIoNMCOl7oWiJ0fK3ZZFpNORiDGgQa
         Be/Osn1CeRVAQK9Fzs2UERA0G5rZc5hrh5Spo=
MIME-Version: 1.0
Date: Tue, 3 Nov 2009 16:34:57 +0000
Message-ID: <ed7b1c610911030834r383be469u2f0674311d697202@mail.gmail.com>
Subject: multi threaded script
From: Baptiste Daroussin <baptiste.daroussin@gmail.com>
To: zsh-users@zsh.org
Content-Type: text/plain; charset=ISO-8859-1

Hi,

I wanted to write a script that needs to be multithreaded, for example
an UI in zsh/curses that does things in background while the UI is
still responsive.
As I found nothing to be able to execute parallelize processes in zsh
(I'm not speaking of fork()) I began to wrote a small and dirty
pthread module for zsh it was quite easy, currently I only implemented
:
pthread_create, pthread_join, pthread_mutex_lock pthread_mutex_unlock,

As soon as I tryed to use it some problems occurs which shows me (in
fact IRC guys show this to me :)) that pthreads is not a good idea
because of global variables.

So my question as a zsh/zthread module won't make sense in zsh, what
would make sense to a able to achieve this stupid example :


zmodload zsh/zthread
zmutex init lock1
integer toto
toto=11

thread1() {
    zmutex lock lock1
    print "Hello from thread1 $toto"
    toto+=1
    zmutex unlock lock1
    sleep 5
    zmutex lock lock1
    print "again thread1 $toto"
    zmutex unlock lock1
    return
}
thread2() {
    zmutex lock lock1
    print "Hello from thread2 $toto"
    toto+=2
    zmutex unlock lock1
    sleep 5
    zmutex lock lock1
    print "again thread2 $toto"
    zmutex unlock lock1
    return
}
zthread create thr1 thread1
zthread create thr2 thread2

zthread join thr1
zthread join thr2

for information zthread sometime works with this, sometimes shows
garbage, sometimes it exit with pthread fatal error.

Perhaps it is not a good idea to use zsh for that kind of purpose.

regards,
Bapt

