From zsh-users-return-10231-mason-zsh=primenet.com.au@sunsite.dk Wed May 10 05:58:51 2006
Return-Path: <zsh-users-return-10231-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 26400 invoked from network); 10 May 2006 05:58:47 -0000
X-Spam-Checker-Version: SpamAssassin 3.1.1 (2006-03-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=BAYES_00,FORGED_RCVD_HELO 
	autolearn=ham version=3.1.1
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 10 May 2006 05:58:47 -0000
Received: (qmail 16161 invoked from network); 10 May 2006 05:58:41 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 10 May 2006 05:58:41 -0000
Received: (qmail 21971 invoked by alias); 10 May 2006 05:58:31 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 10231
Received: (qmail 21961 invoked from network); 10 May 2006 05:58:31 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 10 May 2006 05:58:31 -0000
Received: (qmail 14450 invoked from network); 10 May 2006 05:58:31 -0000
Received: from s1tank.virtdom.com (216.240.101.50)
  by a.mx.sunsite.dk with SMTP; 10 May 2006 05:58:30 -0000
Received: (qmail 21124 invoked by uid 89); 10 May 2006 06:47:37 -0000
Received: from ool-44c5ba23.dyn.optonline.net (HELO venti) (brian@aljex.com@68.197.186.35)
  by s1tank.virtdom.com with SMTP; 10 May 2006 06:47:37 -0000
Message-ID: <009101c673f7$06b3f090$6500000a@venti>
From: "Brian K. White" <brian@aljex.com>
To: <zsh-users@sunsite.dk>
References: <87r7324zyh.fsf@asfast.com> <ltd5emv9lh.fsf@newsol.starnix.com>
Subject: Re: File locking within zsh?
Date: Wed, 10 May 2006 01:59:57 -0400
Organization: Aljex Software
MIME-Version: 1.0
Content-Type: text/plain;
	format=flowed;
	charset="iso-8859-1";
	reply-type=original
Content-Transfer-Encoding: 7bit
X-Priority: 3
X-MSMail-Priority: Normal
X-Mailer: Microsoft Outlook Express 6.00.2900.2869
X-MimeOLE: Produced By Microsoft MimeOLE V6.00.2900.2869


----- Original Message ----- 
From: "Tim Writer" <tim@starnix.com>
To: "Lloyd Zusman" <ljz@asfast.com>
Cc: <zsh-users@sunsite.dk>
Sent: Tuesday, May 09, 2006 11:31 PM
Subject: Re: File locking within zsh?


> Lloyd Zusman <ljz@asfast.com> writes:
>
>> Do any of you know of any functions, primitives, tricks, hacks, or even
>> outright abominations which will allow me to do cooperative file locking
>> from within zsh?
>>
>> I know that I can do this with a number of compiled executables, but I'm
>> looking for a zsh-only solution.
>>
>> Assuming some sort of zsh locking operator called "lock", consider
>> this example (within a zsh script):
>>
>>   lock -x -t 0 file  # for this example of a hypothetical operator, '-x'
>>                      # means to wait until I get an exclusive lock, and
>>                      # '-t 0' means no time out
>>   print foo bar baz >>file
>>   # do a whole lot of other stuff to "file"
>>   unlock file # release the lock
>>
>> In this example, any other zsh script which asks for an exclusive lock
>> on "file" using this hypothetical "lock" operator will block until the
>> "unlock" operator has been invoked.
>>
>> Can this be done somehow in zsh, or do I have to rely on a compiled
>> executable to accomplish this?
>
> The usual way to lock within shell scripts is to use ln. This works on all
> UNIX like systems because creating a hard link (with ln) is an atomic
> operation which fails if the target already exists. Your example above can 
> be
> written like this:
>
>    while ! ln file file.lock 2>/dev/null
>    do
>        sleep 1
>    done
>    # Lock obtained
>
>    print foo bar baz >>file
>    # do a whole lot of other stuff to "file"
>
>    rm -f file.lock
>    # Lock released
>
> Wrapping this idiom into lock/unlock functions is left as an exercise for 
> the
> reader. :-)


Is that better or worse, and why, than  umask 222 ; >file ?

http://www.unix.org.ua/orelly/unix/upt/ch45_36.htm


Brian K. White  --  brian@aljex.com  --  http://www.aljex.com/bkw/
+++++[>+++[>+++++>+++++++<<-]<-]>>+.>.+++++.+++++++.-.[>+<---]>++.
filePro  BBx    Linux  SCO  FreeBSD    #callahans  Satriani  Filk!

