From zsh-workers-return-26705-mason-zsh=primenet.com.au@sunsite.dk Tue Mar 10 11:10:52 2009
Return-Path: <zsh-workers-return-26705-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 25804 invoked from network); 10 Mar 2009 11:10:49 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.4 required=5.0 tests=AWL,BAYES_00 autolearn=ham
	version=3.2.5
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 10 Mar 2009 11:10:49 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 90561 invoked from network); 10 Mar 2009 11:09:08 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 10 Mar 2009 11:09:08 -0000
Received: (qmail 19052 invoked by alias); 10 Mar 2009 11:09:01 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 26705
Received: (qmail 19040 invoked from network); 10 Mar 2009 11:09:01 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 10 Mar 2009 11:09:01 -0000
Received: from cluster-d.mailcontrol.com (cluster-d.mailcontrol.com [85.115.60.190])
	by bifrost.dotsrc.org (Postfix) with ESMTPS id 66F4D80307F9
	for <zsh-workers@sunsite.dk>; Tue, 10 Mar 2009 12:08:58 +0100 (CET)
Received: from cameurexb01.EUROPE.ROOT.PRI ([193.128.72.68])
	by rly47d.srv.mailcontrol.com (MailControl) with ESMTP id n2AB8ubs003997
	for <zsh-workers@sunsite.dk>; Tue, 10 Mar 2009 11:08:56 GMT
Received: from news01 ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.3959);
	 Tue, 10 Mar 2009 11:08:56 +0000
Date: Tue, 10 Mar 2009 11:08:55 +0000
From: Peter Stephenson <pws@csr.com>
To: "Zsh Hackers' List" <zsh-workers@sunsite.dk>
Subject: PATCH: characters with meta in parameters with prompt subst
Message-ID: <20090310110855.48be30b7@news01>
Organization: CSR
X-Mailer: Claws Mail 3.5.0 (GTK+ 2.12.8; i386-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: quoted-printable
X-OriginalArrivalTime: 10 Mar 2009 11:08:56.0105 (UTC) FILETIME=[9AB9D990:01C9A170]
X-Scanned-By: MailControl A_08_51_00 (www.mailcontrol.com) on 10.68.0.157
X-Virus-Scanned: ClamAV 0.92.1/9084/Tue Mar 10 08:11:13 2009 on bifrost
X-Virus-Status: Clean

This is Sourceforge tracker bug 2182755.

The report didn't give enough information to show it up immediately, but
not surprisingly it involves characters which include a byte that's the
same as the Meta byte, which is the most difficult case.

I haven't looked at how the code got so strangely garbled, but as it's
probably my fault it's hardly worth investigating specially.

There was in fact already a quite similar test for this (just above in
D07multibyte.ztst); so similar I don't quite understand why it passed and
the new one would previously have failed (which I confirmed).

Index: Src/subst.c
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D
RCS file: /cvsroot/zsh/zsh/Src/subst.c,v
retrieving revision 1.94
diff -u -r1.94 subst.c
--- Src/subst.c	11 Feb 2009 20:42:16 -0000	1.94
+++ Src/subst.c	10 Mar 2009 10:59:59 -0000
@@ -2734,7 +2734,7 @@
      */
     if (presc) {
 	int ops =3D opts[PROMPTSUBST], opb =3D opts[PROMPTBANG];
-	int opp =3D opts[PROMPTPERCENT], len;
+	int opp =3D opts[PROMPTPERCENT];
=20
 	if (presc < 2) {
 	    opts[PROMPTPERCENT] =3D 1;
@@ -2756,10 +2756,8 @@
 	    ap =3D aval;
 	    for (; *ap; ap++) {
 		char *tmps;
-		unmetafy(*ap, &len);
 		untokenize(*ap);
-		tmps =3D promptexpand(metafy(*ap, len, META_NOALLOC),
-				    0, NULL, NULL, NULL);
+		tmps =3D promptexpand(*ap, 0, NULL, NULL, NULL);
 		*ap =3D dupstring(tmps);
 		free(tmps);
 	    }
@@ -2767,10 +2765,8 @@
 	    char *tmps;
 	    if (!copied)
 		val =3D dupstring(val), copied =3D 1;
-	    unmetafy(val, &len);
 	    untokenize(val);
-	    tmps =3D promptexpand(metafy(val, len, META_NOALLOC),
-					0, NULL, NULL, NULL);
+	    tmps =3D promptexpand(val, 0, NULL, NULL, NULL);
 	    val =3D dupstring(tmps);
 	    free(tmps);
 	}
Index: Test/D07multibyte.ztst
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D
RCS file: /cvsroot/zsh/zsh/Test/D07multibyte.ztst,v
retrieving revision 1.28
diff -u -r1.28 D07multibyte.ztst
--- Test/D07multibyte.ztst	30 Oct 2008 15:34:18 -0000	1.28
+++ Test/D07multibyte.ztst	10 Mar 2009 10:59:59 -0000
@@ -410,3 +410,20 @@
 0:Metafied characters in prompt expansion
 >=E6=A2=B6=E6=B5=A6=E7=94=B1=E8=A8=98
 >=D0=9F=D1=91=D1=82=D1=80 =D0=98=D0=BB=D1=8C=D0=B8=D1=87 =D0=A7=D0=B0=D0=
=B9=D0=BA=D0=BE=D0=B2=D1=81=D0=BA=D0=B8=D0=B9
+
+  (
+  setopt nonomatch
+  tmp1=3D=C4=84
+  tmpA=3D(=C4=84 '=D0=9F=D1=91=D1=82=D1=80 =D0=98=D0=BB=D1=8C=D0=B8=D1=87 =
=D0=A7=D0=B0=D0=B9=D0=BA=D0=BE=D0=B2=D1=81=D0=BA=D0=B8=D0=B9' =E6=A2=B6=E6=
=B5=A6=E7=94=B1=E8=A8=98)
+  print ${tmp1} ${(%)tmp1} ${(%%)tmp1}
+  print ${#tmp1} ${#${(%)tmp1}} ${#${(%%)tmp1}}
+  print ${tmpA}
+  print ${(%)tmpA}
+  print ${(%%)tmpA}
+  )
+0:More metafied characters in prompt expansion
+>=C4=84 =C4=84 =C4=84
+>1 1 1
+>=C4=84 =D0=9F=D1=91=D1=82=D1=80 =D0=98=D0=BB=D1=8C=D0=B8=D1=87 =D0=A7=D0=
=B0=D0=B9=D0=BA=D0=BE=D0=B2=D1=81=D0=BA=D0=B8=D0=B9 =E6=A2=B6=E6=B5=A6=E7=
=94=B1=E8=A8=98
+>=C4=84 =D0=9F=D1=91=D1=82=D1=80 =D0=98=D0=BB=D1=8C=D0=B8=D1=87 =D0=A7=D0=
=B0=D0=B9=D0=BA=D0=BE=D0=B2=D1=81=D0=BA=D0=B8=D0=B9 =E6=A2=B6=E6=B5=A6=E7=
=94=B1=E8=A8=98
+>=C4=84 =D0=9F=D1=91=D1=82=D1=80 =D0=98=D0=BB=D1=8C=D0=B8=D1=87 =D0=A7=D0=
=B0=D0=B9=D0=BA=D0=BE=D0=B2=D1=81=D0=BA=D0=B8=D0=B9 =E6=A2=B6=E6=B5=A6=E7=
=94=B1=E8=A8=98



--=20
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070

