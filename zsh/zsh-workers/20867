From zsh-workers-return-20867-mason-zsh=primenet.com.au@sunsite.dk Fri Feb 25 14:06:12 2005
Return-Path: <zsh-workers-return-20867-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 3752 invoked from network); 25 Feb 2005 14:06:11 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 25 Feb 2005 14:06:11 -0000
Received: (qmail 51757 invoked from network); 25 Feb 2005 14:06:05 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 25 Feb 2005 14:06:05 -0000
Received: (qmail 14039 invoked by alias); 25 Feb 2005 14:06:02 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 20867
Received: (qmail 14029 invoked from network); 25 Feb 2005 14:06:02 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 25 Feb 2005 14:06:02 -0000
Received: (qmail 51501 invoked from network); 25 Feb 2005 14:06:02 -0000
Received: from mail36.messagelabs.com (193.109.254.211)
  by a.mx.sunsite.dk with SMTP; 25 Feb 2005 14:05:57 -0000
X-VirusChecked: Checked
X-Env-Sender: okiddle@yahoo.co.uk
X-Msg-Ref: server-3.tower-36.messagelabs.com!1109340356!14361755!1
X-StarScan-Version: 5.4.11; banners=-,-,-
X-Originating-IP: [158.234.9.163]
Received: (qmail 29890 invoked from network); 25 Feb 2005 14:05:56 -0000
Received: from iris.logica.co.uk (158.234.9.163)
  by server-3.tower-36.messagelabs.com with SMTP; 25 Feb 2005 14:05:56 -0000
Received: from trentino.logica.co.uk ([158.234.142.59])
	by iris.logica.co.uk (8.12.3/8.12.3/Debian -4) with ESMTP id j1PE5u61026833
	for <zsh-workers@sunsite.dk>; Fri, 25 Feb 2005 14:05:56 GMT
Received: from trentino.groupinfra.com (localhost [127.0.0.1])
	by trentino.logica.co.uk (Postfix) with ESMTP id A7A0F29C54
	for <zsh-workers@sunsite.dk>; Fri, 25 Feb 2005 15:05:35 +0100 (CET)
X-VirusChecked: Checked
X-StarScan-Version: 5.1.13; banners=.,-,-
From: Oliver Kiddle <okiddle@yahoo.co.uk>
To: Zsh workers <zsh-workers@sunsite.dk>
Subject: PATCH: further support for <import>s in ant completion
Date: Fri, 25 Feb 2005 15:05:35 +0100
Message-ID: <28801.1109340335@trentino.groupinfra.com>
X-Spam-Checker-Version: SpamAssassin 3.0.2 on a.mx.sunsite.dk
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=6.0 tests=BAYES_00 autolearn=ham 
	version=3.0.2
X-Spam-Hits: -2.6

The following patch is an addition to Konstantin Sobolev's recent patch
for handling targets from imported files. Turns out that if the imported
files are specified using a relative pathname, that path is resolved
relative to the location of the original build.xml. The fix involves
using cd before sed in the subshell.

Imported files from imported files don't work but _ant has the
alternative method enabled with the call-command style. It isn't default
because it is too slow and, Konstantin tells me, ant -projecthelp only
lists targets with a description.

Oliver

Index: _ant
===================================================================
RCS file: /cvsroot/zsh/zsh/Completion/Unix/Command/_ant,v
retrieving revision 1.9
diff -u -r1.9 _ant
--- _ant	24 Feb 2005 17:06:00 -0000	1.9
+++ _ant	25 Feb 2005 10:10:48 -0000
@@ -88,8 +88,9 @@
       fi
       if [[ -f $buildfile ]]; then
         importedfiles=( $(sed -n "s/ *<import[^>]* file=[\"']\([^\"']*\)[\"'].*/\1/p" < $buildfile) )
-        targets=( $(cat $buildfile $importedfiles |
-	    sed -n "s/ *<target[^>]* name=[\"']\([^\"']*\)[\"'].*/\1/p" ) )
+        targets=( $(sed -n "s/ *<target[^>]* name=[\"']\([^\"']*\)[\"'].*/\1/p" $buildfile) )
+        (( $#importedfiles )) && targets+=( $(cd $buildfile:h;
+	    sed -n "s/ *<target[^>]* name=[\"']\([^\"']*\)[\"'].*/\1/p" $importedfiles) )
 	_wanted targets expl target compadd -a targets && ret=0
       else
 	_message -e targets target

