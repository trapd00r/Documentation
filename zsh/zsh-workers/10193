From zsh-workers-return-10193-mason-zsh=primenet.com.au@sunsite.auc.dk Tue Mar 21 18:14:46 2000
Return-Path: <zsh-workers-return-10193-mason-zsh=primenet.com.au@sunsite.auc.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 9511 invoked from network); 21 Mar 2000 18:14:45 -0000
Received: from sunsite.auc.dk (130.225.51.30)
  by ns1.primenet.com.au with SMTP; 21 Mar 2000 18:14:45 -0000
Received: (qmail 11720 invoked by alias); 21 Mar 2000 18:14:39 -0000
Mailing-List: contact zsh-workers-help@sunsite.auc.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.auc.dk
X-Seq: 10193
Received: (qmail 11694 invoked from network); 21 Mar 2000 18:14:38 -0000
From: "Bart Schaefer" <schaefer@candle.brasslantern.com>
Message-Id: <1000321181432.ZM7988@candle.brasslantern.com>
Date: Tue, 21 Mar 2000 18:14:32 +0000
X-Mailer: Z-Mail (5.0.0 30July97)
To: zsh-workers@sunsite.auc.dk
Subject: PATCH: Prompt truncation crash
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii

prompttrunc() was using a pointer into the prompt buffer without tracking
realloc()s that might happen in addbufspc().

Index: Src/prompt.c
===================================================================
@@ -733,9 +733,9 @@
 prompttrunc(int arg, int truncchar, int doprint, int endchar)
 {
     if (arg) {
-	char ch = *fm, *ptr = bp, *truncstr;
+	char ch = *fm, *ptr, *truncstr;
 	int truncatleft = ch == '<';
-	int w;
+	int w = bp - buf;
 
 	/*
 	 * If there is already a truncation active, return so that
@@ -760,10 +760,11 @@
 	}
 	if (!*fm)
 	    return 0;
-	if (bp == ptr && truncchar == ']') {
+	if (bp - buf == w && truncchar == ']') {
 	    addbufspc(1);
 	    *bp++ = '<';
 	}
+	ptr = buf + w;		/* addbufspc() may have realloc()'d buf */
 	truncstr = ztrduppfx(ptr, bp - ptr);
 
 	bp = ptr;
@@ -787,10 +788,13 @@
 	    if (w < fullen) {
 		/* Invisible substrings, lots of shuffling. */
 		int n = strlen(t);
+		char *p = ptr, *q = buf;
 		addbufspc(n);
+		ptr = buf + (p - q); /* addbufspc() may have realloc()'d */
 
 		if (truncatleft) {
-		    char *p = ptr + n, *q = p;
+		    p = ptr + n;
+		    q = p;
 
 		    n = fullen - w;
 
@@ -812,7 +816,7 @@
 		    bp = q;
 		} else {
 		    /* Truncate on the right, selectively */
-		    char *q = ptr + fullen;
+		    q = ptr + fullen;
 
 		    /* First skip over as much as will "fit". */
 		    while (w > 0 && maxlen > 0) {
@@ -846,6 +850,7 @@
 		/* No invisible substrings. */
 		if (tlen > fullen) {
 		    addbufspc(tlen - fullen);
+		    ptr = bp;	/* addbufspc() may have realloc()'d buf */
 		    bp += tlen - fullen;
 		} else
 		    bp -= fullen - trunclen;

-- 
Bart Schaefer                                 Brass Lantern Enterprises
http://www.well.com/user/barts              http://www.brasslantern.com

