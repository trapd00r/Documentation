From zsh-workers-return-26313-mason-zsh=primenet.com.au@sunsite.dk Thu Jan 15 14:40:13 2009
Return-Path: <zsh-workers-return-26313-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 13500 invoked from network); 15 Jan 2009 14:40:00 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-1.6 required=5.0 tests=AWL,BAYES_00,URIBL_SBL
	autolearn=no version=3.2.5
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 15 Jan 2009 14:40:00 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 72458 invoked from network); 15 Jan 2009 14:39:52 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 15 Jan 2009 14:39:52 -0000
Received: (qmail 27225 invoked by alias); 15 Jan 2009 14:39:45 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 26313
Received: (qmail 27214 invoked from network); 15 Jan 2009 14:39:44 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 15 Jan 2009 14:39:44 -0000
Received: from cluster-g.mailcontrol.com (cluster-g.mailcontrol.com [208.87.233.190])
	by bifrost.dotsrc.org (Postfix) with ESMTPS id D681280271F0
	for <zsh-workers@sunsite.dk>; Thu, 15 Jan 2009 15:39:34 +0100 (CET)
Received: from cameurexb01.EUROPE.ROOT.PRI ([193.128.72.68])
	by rly14g.srv.mailcontrol.com (MailControl) with ESMTP id n0FEdIT7011002
	for <zsh-workers@sunsite.dk>; Thu, 15 Jan 2009 14:39:25 GMT
Received: from news01 ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.3959);
	 Thu, 15 Jan 2009 14:38:45 +0000
Date: Thu, 15 Jan 2009 14:38:38 +0000
From: Peter Stephenson <pws@csr.com>
To: Zsh hackers list <zsh-workers@sunsite.dk>
Subject: Re: Getting the CVS revision of Zsh
Message-ID: <20090115143838.43bc3dbb@news01>
In-Reply-To: <20090114233659.GA29158@scru.org>
References: <2d460de70901090301h6b309a7cm19c5ebfec989ff2c@mail.gmail.com>
	<2d460de70901140533icf13f94yc7f63f974b236f45@mail.gmail.com>
	<090114085737.ZM18662@torch.brasslantern.com>
	<200901141722.n0EHMZwf002944@news01.csr.com>
	<20090114233659.GA29158@scru.org>
Organization: CSR
X-Mailer: Claws Mail 3.5.0 (GTK+ 2.12.8; i386-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
X-OriginalArrivalTime: 15 Jan 2009 14:38:45.0130 (UTC) FILETIME=[F8101EA0:01C9771E]
X-Scanned-By: MailControl A_08_51_00 (www.mailcontrol.com) on 10.71.0.124
X-Virus-Scanned: ClamAV 0.92.1/8868/Thu Jan 15 07:34:41 2009 on bifrost
X-Virus-Status: Clean

On Wed, 14 Jan 2009 23:36:59 +0000
Clint Adams <schizo@debian.org> wrote:
> On Wed, Jan 14, 2009 at 05:22:35PM +0000, Peter Stephenson wrote:
> > If someone is really bundling individual patches with zsh, so that it is
> > different from any CVS checkout, then I would urge them to alter
> > $ZSH_PATCHLEVEL to avoid exactly the sort of confusion you describe.  I
> > can add a config option to fix a patchlevel if this is useful.
> 
> Yes, we do this.  I can just patch zsh.mdd to work around it though.

In that case Bart's concerns are entirely real and this at least gives us
some kind of hook for people to indicate something funny is going on.

Arguably this should go after the standard version string in $ZSH_VERSION,
but I don't want yet more grief with additional customization.  I've spent
far too much time arguing about this already.

I'm fairly happy ZSH_PATCHLEVEL is enough at least for what I'd like it
do.  It's easy to find out what it should be in a released version and so
check if you're in a released version if you really need to.

Index: INSTALL
===================================================================
RCS file: /cvsroot/zsh/zsh/INSTALL,v
retrieving revision 1.37
diff -u -r1.37 INSTALL
--- INSTALL	30 Oct 2008 12:09:18 -0000	1.37
+++ INSTALL	15 Jan 2009 14:31:56 -0000
@@ -271,6 +271,19 @@
 CONFIGURATION OPTIONS
 =====================
 
+Modified versions of zsh
+------------------------
+
+If you are making local modifications to zsh, you are strongly
+advised to configure with the option
+
+  --enable-local-patchlevel="<my-mod-string>"
+
+so that the variable $ZSH_PATCHLEVEL indicates this is not a standard
+version of the shell.  The argument is arbitrary, but should indicate
+the entity that is customizing the shell, for example the OS vendor
+or distributor.
+
 Multibyte Character Support
 ---------------------------
 
Index: configure.ac
===================================================================
RCS file: /cvsroot/zsh/zsh/configure.ac,v
retrieving revision 1.116
diff -u -r1.116 configure.ac
--- configure.ac	13 Jan 2009 17:10:22 -0000	1.116
+++ configure.ac	15 Jan 2009 14:31:56 -0000
@@ -304,6 +304,14 @@
 AC_SUBST(scriptdir)dnl
 AC_SUBST(sitescriptdir)dnl
 
+AH_TEMPLATE([CUSTOM_PATCHLEVEL],
+[Define to a custom value for the ZSH_PATCHLEVEL parameter])
+AC_ARG_ENABLE(custom-patchlevel,
+AC_HELP_STRING([--enable-custom-patchlevel], [set a custom ZSH_PATCHLEVEL value]),
+[if test x$enableval != x && test x$enableval != xno; then
+  AC_DEFINE_UNQUOTED([CUSTOM_PATCHLEVEL], ["$enableval"])
+fi])
+
 dnl Do you want maildir support?
 ifdef([maildir_support],[undefine([maildir_support])])dnl
 AH_TEMPLATE([MAILDIR_SUPPORT],
Index: Src/params.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/params.c,v
retrieving revision 1.152
diff -u -r1.152 params.c
--- Src/params.c	9 Jan 2009 20:28:30 -0000	1.152
+++ Src/params.c	15 Jan 2009 14:31:57 -0000
@@ -31,7 +31,11 @@
 #include "params.pro"
 
 #include "version.h"
+#ifdef CUSTOM_PATCHLEVEL
+#define ZSH_PATCHLEVEL	CUSTOM_PATCHLEVEL
+#else
 #include "patchlevel.h"
+#endif
 
 /* what level of localness we are at */
  


-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070

