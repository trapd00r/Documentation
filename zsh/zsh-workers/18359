From zsh-workers-return-18359-mason-zsh=primenet.com.au@sunsite.dk Tue Mar 18 12:07:10 2003
Return-Path: <zsh-workers-return-18359-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 4113 invoked from network); 18 Mar 2003 12:07:09 -0000
Received: from sunsite.dk (130.225.247.90)
  by ns1.primenet.com.au with SMTP; 18 Mar 2003 12:07:09 -0000
Received: (qmail 20625 invoked by alias); 18 Mar 2003 12:07:02 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 18359
Received: (qmail 20618 invoked from network); 18 Mar 2003 12:07:02 -0000
Received: from localhost (HELO sunsite.dk) (127.0.0.1)
  by localhost with SMTP; 18 Mar 2003 12:07:02 -0000
X-MessageWall-Score: 0 (sunsite.dk)
Received: from [212.125.75.4] by sunsite.dk (MessageWall 1.0.8) with SMTP; 18 Mar 2003 12:7:2 -0000
Received: (qmail 1248 invoked from network); 18 Mar 2003 12:05:25 -0000
Received: from iris.logica.co.uk (158.234.9.163)
  by server-4.tower-1.messagelabs.com with SMTP; 18 Mar 2003 12:05:25 -0000
Received: from finches.logica.co.uk ([158.234.142.11])
	by iris.logica.co.uk (8.9.3/8.9.3/Debian 8.9.3-21) with ESMTP id MAA17936;
	Tue, 18 Mar 2003 12:05:02 GMT
X-Authentication-Warning: iris.logica.co.uk: Host [158.234.142.11] claimed to be finches.logica.co.uk
Received: from finches.logica.co.uk (localhost [127.0.0.1])
	by finches.logica.co.uk (8.11.6/8.11.6/SuSE Linux 0.5) with ESMTP id h2IC90C05759;
	Tue, 18 Mar 2003 13:09:00 +0100
X-VirusChecked: Checked
cc: Zsh hackers list <zsh-workers@sunsite.dk>
In-reply-to: <5451y153msn.fsf@icd.teradyne.com> 
From: Oliver Kiddle <okiddle@yahoo.co.uk>
References: <54565qh3n66.fsf@icd.teradyne.com> <5451y153msn.fsf@icd.teradyne.com>
To: Vin Shelton <shelton@icd.teradyne.com>
Subject: Re: 'make check' failures on Solaris 2.5 and 5.8 
Date: Tue, 18 Mar 2003 13:09:00 +0100
Message-ID: <5757.1047989340@finches.logica.co.uk>

Vin Shelton wrote:
> Sorry to followup my own post, but I forgot to mention that the
> failures started appearing on 2003-03-14.  My 2003-03-13 build passed
> 'make check' fine, except for the expected C02cond failure.

That narrows it down to being my fault in the \u/\U change. Thanks for
reporting it.

The problem is that MB_LEN_MAX is less than 6 on Solaris so it wasn't
allocating enough memory. UTF-8 has characters up to 6 bytes in length
so this suprised me. Solaris 8 pretends to offer UTF-8 locales but I
can't get them to work. The patch below is a quick fix. MB_LEN_MAX is
defined to be 16 in recent glibc which seems high. Anyone know why or
what character sets need that? Handling of $'...' will need rethinking if
'\unnnn' can produce more than 6 bytes because $'...' is done by modifying
the string in place.

If anyone has access to any operating systems other than Linux
and Solaris 8, it would be really useful to know whether it defines
__STDC_ISO_10646__, the value of MB_LEN_MAX and, even more valuably, what
iconv conversions it allows. iconv doesn't necessarily use the same names
for character sets as nl_langinfo(CODESET). unicode can be ISO-10646,
ISO646, 646, UCS4 and other variants so I perhaps should manually convert
to UTF-8 as that has fewer names and then try converting to WCHAR_T and
then nl_langinfo(CODESET).

Oliver

Index: utils.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/utils.c,v
retrieving revision 1.45
diff -u -r1.45 utils.c
--- utils.c	14 Mar 2003 13:36:16 -0000	1.45
+++ utils.c	18 Mar 2003 11:33:59 -0000
@@ -3311,15 +3311,12 @@
     char *inptr, *outptr;
 #  endif
     size_t count;
-    size_t buflen = MB_LEN_MAX * (strlen(s) / 6) + (strlen(s) % 6) + 1;
-#else
-    size_t buflen = strlen(s) + 1;
 #endif
 
     if (fromwhere == 6)
 	t = buf = tmp;
     else if (fromwhere != 4)
-	t = buf = zhalloc(buflen);
+	t = buf = zhalloc(strlen(s) + 1);
     else {
 	t = buf = s;
 	s += 2;

