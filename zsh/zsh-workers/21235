From zsh-workers-return-21235-mason-zsh=primenet.com.au@sunsite.dk Sat May 07 17:13:27 2005
Return-Path: <zsh-workers-return-21235-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 19979 invoked from network); 7 May 2005 17:13:26 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 7 May 2005 17:13:26 -0000
Received: (qmail 58577 invoked from network); 7 May 2005 17:13:20 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 7 May 2005 17:13:20 -0000
Received: (qmail 21082 invoked by alias); 7 May 2005 17:13:17 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 21235
Received: (qmail 21069 invoked from network); 7 May 2005 17:13:16 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 7 May 2005 17:13:16 -0000
Received: (qmail 58208 invoked from network); 7 May 2005 17:13:16 -0000
Received: from vms046pub.verizon.net (206.46.252.46)
  by a.mx.sunsite.dk with SMTP; 7 May 2005 17:13:10 -0000
Received: from candle.brasslantern.com ([4.11.1.68])
 by vms046.mailsrvcs.net (Sun Java System Messaging Server 6.2 HotFix 0.04
 (built Dec 24 2004)) with ESMTPA id <0IG400D3WQHWNZY2@vms046.mailsrvcs.net> for
 zsh-workers@sunsite.dk; Sat, 07 May 2005 12:13:09 -0500 (CDT)
Received: from candle.brasslantern.com (IDENT:schaefer@localhost [127.0.0.1])
	by candle.brasslantern.com (8.12.11/8.12.11) with ESMTP id j47HD7e8001531;
 Sat, 07 May 2005 10:13:07 -0700
Received: (from schaefer@localhost)	by candle.brasslantern.com
 (8.12.11/8.12.11/Submit) id j47HD7AU001530; Sat, 07 May 2005 10:13:07 -0700
Date: Sat, 07 May 2005 17:13:06 +0000
From: Bart Schaefer <schaefer@brasslantern.com>
Subject: Re: [glisse@stedding.loria.fr: Bug#307341: zsh: insufficient escaping
 of spaces in _ssh completion]
In-reply-to: <20050502171034.GA9638@scowler.net>
To: zsh-workers@sunsite.dk
Cc: 307341-forwarded@bugs.debian.org
Message-id: <1050507171306.ZM1529@candle.brasslantern.com>
MIME-version: 1.0
X-Mailer: Z-Mail (5.0.0 30July97)
Content-type: text/plain; charset=us-ascii
References: <20050502171034.GA9638@scowler.net>
Comments: In reply to Clint Adams <schizo@debian.org>
 "[glisse@stedding.loria.fr: Bug#307341: zsh: insufficient escaping of spaces
 in _ssh completion]" (May  2,  1:10pm)
X-Spam-Checker-Version: SpamAssassin 3.0.2 on a.mx.sunsite.dk
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=6.0 tests=AWL,BAYES_00 autolearn=ham 
	version=3.0.2
X-Spam-Hits: -2.6

On May 2,  1:10pm, Clint Adams wrote:
} Subject: [glisse@stedding.loria.fr: Bug#307341: zsh: insufficient escaping
}
} ----- Forwarded message from Marc Glisse <glisse@stedding.loria.fr> -----
} 
} scp somehost:/data/a<TAB>
} scp somehost:/data/a\\\ a/
} But when I press <TAB> again, it fails, as if directory 'a a' did not
} exist. 
} 
} ----- End forwarded message -----

I think this deals with it.  Does anyone remember in what case we might
need (Q) applied to the prefix?  Some mixture of quoting forms, perhaps?

Index: Completion/Unix/Command/_ssh
===================================================================
diff -c -r1.14 _ssh
--- Completion/Unix/Command/_ssh	6 Dec 2004 16:51:17 -0000	1.14
+++ Completion/Unix/Command/_ssh	7 May 2005 17:08:15 -0000
@@ -2,11 +2,15 @@
 
 _remote_files () {
   # There should be coloring based on all the different ls -F classifiers.
-  local expl remfiles remdispf remdispd args suf ret=1
+  local expl rempat remfiles remdispf remdispd args suf ret=1
 
   if zstyle -T ":completion:${curcontext}:files" remote-access; then
     zparseopts -D -E -a args p: 1 2 4 6 F:
-    remfiles=(${(M)${(f)"$(_call_program files ssh $args -a -x ${IPREFIX%:} ls -d1FL "${(Q)PREFIX%%[^./][^/]#}\*" 2>/dev/null)"}%%[^/]#(|/)})
+    if [[ -z $QIPREFIX ]]
+    then rempat="${PREFIX%%[^./][^/]#}\*"
+    else rempat="${(q)PREFIX%%[^./][^/]#}\*"
+    fi
+    remfiles=(${(M)${(f)"$(_call_program files ssh $args -a -x ${IPREFIX%:} ls -d1FL "$rempat" 2>/dev/null)"}%%[^/]#(|/)})
     compset -P '*/'
     compset -S '/*' || suf='remote file'
 

