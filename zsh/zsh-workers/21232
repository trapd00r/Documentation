From zsh-workers-return-21232-mason-zsh=primenet.com.au@sunsite.dk Fri May 06 04:10:20 2005
Return-Path: <zsh-workers-return-21232-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 7509 invoked from network); 6 May 2005 04:10:19 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 6 May 2005 04:10:19 -0000
Received: (qmail 16690 invoked from network); 6 May 2005 04:10:13 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 6 May 2005 04:10:13 -0000
Received: (qmail 2999 invoked by alias); 6 May 2005 04:10:10 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 21232
Received: (qmail 2980 invoked from network); 6 May 2005 04:10:10 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 6 May 2005 04:10:10 -0000
Received: (qmail 16397 invoked from network); 6 May 2005 04:10:09 -0000
Received: from ns1.primenet.com.au (HELO primenet.com.au) (203.24.36.2)
  by a.mx.sunsite.dk with SMTP; 6 May 2005 04:10:04 -0000
Received: (qmail 6446 invoked by uid 8); 6 May 2005 04:10:00 -0000
To: zsh-workers@sunsite.dk
Path: not-for-mail
From: Geoff Wing <mason@primenet.com.au>
X-Newsgroups:  lists.zsh.workers
Subject:  Re: Obscure overflow with very long path; completion
Date: Fri, 6 May 2005 04:10:00 +0000 (UTC)
Organization: PrimeNet Computer Consultants
Lines: 38
Message-ID:  <slrnd7lrgo.32l.mason@g.primenet.com.au>
References:  <DE6AE1FD-6A14-44CE-8CB2-3576B59DB5B6@remahl.se> <200505031026.j43AQwBE014903@news01.csr.com>
Reply-To: mason@primenet.com.au
NNTP-Posting-Host: sparkles.primenet.com.au
X-Trace: f.primenet.com.au 1115352600 27834 203.43.15.10 (6 May 2005 04:10:00 GMT)
X-Complaints-To: usenet@f.primenet.com.au
NNTP-Posting-Date: Fri, 6 May 2005 04:10:00 +0000 (UTC)
User-Agent: slrn/0.9.8.1 (NetBSD)
X-Spam-Checker-Version: SpamAssassin 3.0.2 on a.mx.sunsite.dk
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=6.0 tests=BAYES_00 autolearn=ham 
	version=3.0.2
X-Spam-Hits: -2.6

Peter Stephenson <pws@csr.com> typed:
: David Remahl wrote:
:> Summary:
:> Some very special circumstances triggers a buffer overflow of some  
:> kind (I believe it is on the heap, but I have not had time to look  
:> into it in detail) in the cd builtin.
: I couldn't get this to happen with Fedora Core 3 on x86.  It's possible
: it's some library bug, but I agree it's more likely there's some
: well-masked problem in memory management in zsh.

I get 98 of them built using the provided method before crashing.  Then

% zsh -f
% cd /tmp
% for I in {1..98}; cd aaaaaaaaaaaaaaaaaaaa
% pwd | wc
       1       1    2063
% setopt chaselinks
% cd /tmp
% for I in {1..98}; cd aaaaaaaaaaaaaaaaaaaa

(gdb) bt
#0  0xbdbcba91 in xsymlink (
    s=0x80e80c8 "/tmp/", 'a' <repeats 20 times>, "/", 'a' <repeats 20 times>, "/", 'a' <repeats 20 times>, "/", 'a' <repeats 20 times>, "/", 'a' <repeats 20 times>, "/", 'a' <repeats 20 times>, "/", 'a' <repeats 20 times>, "/", 'a' <repeats 20 times>, "/", 'a' <repeats 20 times>, "/aaaaaa"...) at utils.c:395
#1  0xbdbcb701 in findpwd (
    s=0x80e80c8 "/tmp/", 'a' <repeats 20 times>, "/", 'a' <repeats 20 times>, "/", 'a' <repeats 20 times>, "/", 'a' <repeats 20 times>, "/", 'a' <repeats 20 times>, "/", 'a' <repeats 20 times>, "/", 'a' <repeats 20 times>, "/", 'a' <repeats 20 times>, "/", 'a' <repeats 20 times>, "/aaaaaa"...) at utils.c:279
#2  0xbdb7482e in cd_new_pwd (func=10, dir=0x8091ca8) at builtin.c:1107

These two in utils.c:
   static char xbuf[PATH_MAX*2];
and
   char xbuf2[PATH_MAX*2], ...
are insufficient because the path is over twice the allowed PATH_MAX (1024) on
my machine.  I guess there should be some limiters to stop somewhere and obey
PATH_MAX (or some magic number we wish to support).

Regards,
Geoff

