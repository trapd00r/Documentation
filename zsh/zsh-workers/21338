From zsh-workers-return-21338-mason-zsh=primenet.com.au@sunsite.dk Wed Jun 15 00:29:05 2005
Return-Path: <zsh-workers-return-21338-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 1211 invoked from network); 15 Jun 2005 00:29:04 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 15 Jun 2005 00:29:04 -0000
Received: (qmail 90709 invoked from network); 15 Jun 2005 00:28:57 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 15 Jun 2005 00:28:57 -0000
Received: (qmail 12348 invoked by alias); 15 Jun 2005 00:28:54 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 21338
Received: (qmail 12339 invoked from network); 15 Jun 2005 00:28:53 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 15 Jun 2005 00:28:53 -0000
Received: (qmail 90244 invoked from network); 15 Jun 2005 00:28:53 -0000
Received: from vms046pub.verizon.net (206.46.252.46)
  by a.mx.sunsite.dk with SMTP; 15 Jun 2005 00:28:49 -0000
Received: from candle.brasslantern.com ([4.11.1.68])
 by vms046.mailsrvcs.net (Sun Java System Messaging Server 6.2 HotFix 0.04
 (built Dec 24 2004)) with ESMTPA id <0II3004J9NZXRHUC@vms046.mailsrvcs.net> for
 zsh-workers@sunsite.dk; Tue, 14 Jun 2005 19:28:46 -0500 (CDT)
Received: from candle.brasslantern.com (IDENT:schaefer@localhost [127.0.0.1])
	by candle.brasslantern.com (8.12.11/8.12.11) with ESMTP id j5F0Sjxl007769	for
 <zsh-workers@sunsite.dk>; Tue, 14 Jun 2005 17:28:45 -0700
Received: (from schaefer@localhost)	by candle.brasslantern.com
 (8.12.11/8.12.11/Submit) id j5F0Sj4R007768	for zsh-workers@sunsite.dk; Tue,
 14 Jun 2005 17:28:45 -0700
Date: Wed, 15 Jun 2005 00:28:44 +0000
From: Bart Schaefer <schaefer@brasslantern.com>
Subject: Re: subtle `echo' bug
In-reply-to: <200506142212.24133.arvidjaar@newmail.ru>
To: zsh-workers@sunsite.dk
Message-id: <1050615002844.ZM7767@candle.brasslantern.com>
MIME-version: 1.0
X-Mailer: Z-Mail (5.0.0 30July97)
Content-type: text/plain; charset=us-ascii
References: <20050614172738.GL4685@solemn.turbinal.org>
	<200506142212.24133.arvidjaar@newmail.ru>
Comments: In reply to Andrey Borzenkov <arvidjaar@newmail.ru>
 "Re: subtle `echo' bug" (Jun 14, 10:12pm)
X-Spam-Checker-Version: SpamAssassin 3.0.2 on a.mx.sunsite.dk
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=6.0 tests=AWL,BAYES_00 autolearn=ham 
	version=3.0.2
X-Spam-Hits: -2.6

On Jun 14, 10:12pm, Andrey Borzenkov wrote:
}
} This happens randomly

It's not a bug in echo, and the strange construct with the curly braces
has nothing to do with it.  Try this:

i=0
j=0
repeat 10 do
  i=0
  ((++j))
  seq 1 3 |while read n; do ((++i)); set | : $n; done
  print $i
done
print $i $j $n

Note that both loops exit, without ever executing "print $i", often
after only one pass.  (It's also important that you use a newline, not
a semicolon, after the final "done", or even the last "print" is not
executed.)

This affects any builtin that writes to its standard output, so the
problem is almost certainly resulting from a write error on stdout
because the builtin on the rightmost end of the pipeline is never
reading from its stdin.  When you use an external command on the far
right, a process is forked and the OS allocates some buffer space for
the pipe, and thus silently swallows the output; but when a builtin
is on the far right, that command is executed in the parent shell and
no such buffer is created.

You can see this in action by forcing external execution of the final
command by putting parens around it:

  seq 1 3 |while read n; do ((++i)); { : | set } | (: $n); done

I's sure you could also get the loop to fail with /bin/echo on the far
right by having the stuff inside { } emit a large enough volume to
overflow the OS pipe buffer.

In short, if you write nonsense code, you get nonsense results.  Don't
try to feed input to a command that doesn't want it.

