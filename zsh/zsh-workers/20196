From zsh-workers-return-20196-mason-zsh=primenet.com.au@sunsite.dk Mon Jul 26 02:28:18 2004
Return-Path: <zsh-workers-return-20196-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 16756 invoked from network); 26 Jul 2004 02:28:17 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 26 Jul 2004 02:28:17 -0000
Received: (qmail 62577 invoked from network); 26 Jul 2004 02:28:11 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 26 Jul 2004 02:28:11 -0000
Received: (qmail 7532 invoked by alias); 26 Jul 2004 02:27:57 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 20196
Received: (qmail 7515 invoked from network); 26 Jul 2004 02:27:57 -0000
Received: from unknown (HELO a.mx.sunsite.dk) (130.225.247.88)
  by 130.225.247.90 with SMTP; 26 Jul 2004 02:27:57 -0000
Received: (qmail 61529 invoked from network); 26 Jul 2004 02:25:58 -0000
Received: from g.primenet.com.au (203.24.36.10)
  by a.mx.sunsite.dk with SMTP; 26 Jul 2004 02:25:55 -0000
Received: (qmail 21395 invoked by uid 100); 26 Jul 2004 02:25:52 -0000
Date: Mon, 26 Jul 2004 12:25:52 +1000
From: Geoff Wing <gcw@zsh.org>
To: Zsh Hackers <zsh-workers@sunsite.dk>
Subject: Re: Bug#134474: zsh misbehaves if LINES=2
Message-ID: <20040726022552.GA3222@primenet.com.au>
References: <1020221065017.ZM1834@candle.brasslantern.com> <20040723180422.GA10693@scowler.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20040723180422.GA10693@scowler.net>
User-Agent: Mutt/1.4.2.1i
Organization: PrimeNet Computer Consultancy
X-Spam-Checker-Version: SpamAssassin 2.63 on a.mx.sunsite.dk
X-Spam-Level: 
X-Spam-Status: No, hits=-1.5 required=6.0 tests=BAYES_01 autolearn=no 
	version=2.63
X-Spam-Hits: -1.5

Clint Adams <schizo@debian.org> typed:
: -    if (!(termflags & TERM_SHORT) && tcstr[cap]) {
: +    if (!isset(SINGLE_LINE_ZLE) && tcstr[cap]) {

s/SINGLE_LINE_ZLE/SINGLELINEZLE/
however I'd be more inclined to use the following conditional
though possibly the check on SINGLELINEZLE might be elided
depending on what commitments upon output we claim on that
option.

Regards,
Geoff

--- Src/prompt.c.org	2004-06-23 04:31:08.000000000 +1000
+++ Src/prompt.c	2004-07-26 12:20:11.000000000 +1000
@@ -746,7 +746,8 @@
 mod_export void
 tsetcap(int cap, int flag)
 {
-    if (!(termflags & TERM_SHORT) && tcstr[cap]) {
+    if (tccan(cap) && !isset(SINGLELINEZLE) &&
+        !(termflags & (TERM_NOUP|TERM_BAD|TERM_UNKNOWN))) {
 	switch(flag) {
 	case -1:
 	    tputs(tcstr[cap], 1, putraw);

