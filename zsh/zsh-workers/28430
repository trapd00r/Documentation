From zsh-workers-return-28430-mason-zsh=primenet.com.au@zsh.org Mon Nov 22 14:50:04 2010
Return-Path: <zsh-workers-return-28430-mason-zsh=primenet.com.au@zsh.org>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 16734 invoked by alias); 22 Nov 2010 14:50:03 -0000
Mailing-List: contact zsh-workers-help@zsh.org; run by ezmlm
Precedence: bulk
X-No-Archive: yes
List-Id: Zsh Workers List <zsh-workers.zsh.org>
List-Post: <mailto:zsh-workers@zsh.org>
List-Help: <mailto:zsh-workers-help@zsh.org>
Delivered-To: mailing list zsh-workers@zsh.org
X-Seq: 28430
Received: (qmail 18917 invoked from network); 22 Nov 2010 14:49:49 -0000
X-Spam-Checker-Version: SpamAssassin 3.3.1 (2010-03-16) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-1.9 required=5.0 tests=BAYES_00 autolearn=ham
	version=3.3.1
Received-SPF: none (ns1.primenet.com.au: domain at vinc17.net does not designate permitted sender hosts)
Date: Mon, 22 Nov 2010 15:49:43 +0100
From: Vincent Lefevre <vincent@vinc17.net>
To: zsh-workers@zsh.org
Subject: zsh froze under Mac OS X
Message-ID: <20101122144943.GA1727@prunille.vinc17.org>
Mail-Followup-To: zsh-workers@zsh.org
MIME-Version: 1.0
Content-Type: text/plain; charset=iso-8859-1
Content-Disposition: inline
Content-Transfer-Encoding: 8bit
X-Mailer-Info: http://www.vinc17.net/mutt/
User-Agent: Mutt/1.5.21-6164-vl-r38670 (2010-10-13)

Hi,

I had the following problem with zsh 4.3.10-dev-2 under Mac OS X
(it includes two patches that where posted here: one for
Src/Zle/computil.c and one for Src/jobs.c).

I did the following:
1. I quit a program (mutt) that was running for several days in screen.
2. A few minutes later, I reran the same program (but I don't think
   zsh started it because nothing occurred).
3. I did a Ctrl-C, then I couldn't have the prompt.

But as the machine started to be very slow after (1), I suspect that
problems started to appear at that time.

When I looked with htop after (3), I could see that zsh was taking
100% CPU time with more and more memory (I killed it with "kill -9",
while it was at 40% memory, according to htop).

AFAIK, this is the first time I get this problem exactly. But note
that I often get zsh crashes when a ssh started by zsh and running
for several days terminates.

Output of "sample 1539 10 10" while zsh was running:

Analysis of sampling pid 1539 every 10.000000 milliseconds
Call graph:
    993 Thread_100b
      993 start
        993 _start
          993 zsh_main
            993 zexit
              993 sourcehome
                993 source
                  993 loop
                    993 parse_event
                      993 par_event
                        993 par_sublist
                          993 par_sublist2
                            993 par_pline
                              993 par_cmd
                                992 par_simple
                                  989 zshlex
                                    978 gettokstr
                                      973 hcalloc
                                        965 zhalloc
                                          936 zhalloc
                                          29 zalloc
                                            28 malloc
                                              28 szone_malloc
                                                28 large_and_huge_malloc
                                                  26 vm_allocate
                                                    26 mach_msg
                                                      26 mach_msg_trap
                                                        26 mach_msg_trap
                                                  2 large_and_huge_malloc
                                            1 zalloc
                                        8 __bzero
                                          8 __bzero
                                      4 inungetc
                                        2 zshcalloc
                                          1 malloc
                                            1 malloc
                                          1 szone_malloc
                                            1 szone_malloc
                                        1 inputsetline
                                          1 inputsetline
                                        1 malloc
                                          1 malloc
                                      1 inpush
                                        1 inpush
                                    6 ingetc
                                      3 inpoptop
                                        2 free
                                          1 free
                                          1 szone_size
                                            1 szone_size
                                        1 inpoptop
                                      2 free
                                        2 free
                                      1 ingetc
                                    2 exalias
                                      1 exalias
                                      1 gethashnode
                                        1 gethashnode
                                    2 zshlex
                                    1 0x87440
                                      1 inungetc
                                        1 inungetc
                                  2 ecstrcode
                                    2 dyld_stub_strlen
                                      2 dyld_stub_strlen
                                  1 ecadd
                                    1 ecadd
                                1 ecadd
                                  1 ecadd

Total number in stack (recursive counted multiple, when >=5):

Sort by top of stack, same collapsed (when >= 5):
        zhalloc        936
        mach_msg_trap        26
        __bzero        8

-- 
Vincent Lefèvre <vincent@vinc17.net> - Web: <http://www.vinc17.net/>
100% accessible validated (X)HTML - Blog: <http://www.vinc17.net/blog/>
Work: CR INRIA - computer arithmetic / Arénaire project (LIP, ENS-Lyon)

