From zsh-users-return-7011-mason-zsh=primenet.com.au@sunsite.dk Mon Jan 19 21:47:37 2004
Return-Path: <zsh-users-return-7011-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 17327 invoked from network); 19 Jan 2004 21:47:37 -0000
Received: from sunsite.dk (130.225.247.90)
  by ns1.primenet.com.au with SMTP; 19 Jan 2004 21:47:37 -0000
Received: (qmail 7083 invoked by alias); 19 Jan 2004 21:47:16 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 7011
Received: (qmail 7013 invoked from network); 19 Jan 2004 21:47:15 -0000
Received: from localhost (HELO sunsite.dk) (127.0.0.1)
  by localhost with SMTP; 19 Jan 2004 21:47:15 -0000
X-MessageWall-Score: 0 (sunsite.dk)
Received: from [68.1.17.113] by sunsite.dk (MessageWall 1.0.8) with SMTP; 19 Jan 2004 21:47:15 -0000
Received: from quark.localdomain ([68.12.75.33]) by lakemtao08.cox.net
          (InterMail vM.5.01.06.05 201-253-122-130-105-20030824) with ESMTP
          id <20040119214714.HJND2412.lakemtao08.cox.net@quark.localdomain>;
          Mon, 19 Jan 2004 16:47:14 -0500
Received: from quark.localdomain (localhost.localdomain [127.0.0.1])
	by quark.localdomain (8.12.9/8.12.9) with ESMTP id i0JLlMuO003544;
	Mon, 19 Jan 2004 15:47:22 -0600 (CST)
	(envelope-from vince@quark.localdomain)
Received: (from vince@localhost)
	by quark.localdomain (8.12.9/8.12.9/Submit) id i0JLlLw8003543;
	Mon, 19 Jan 2004 15:47:21 -0600 (CST)
Date: Mon, 19 Jan 2004 15:47:21 -0600
From: Vincent Stemen <zsh@hightek.org>
To: Peter Stephenson <pws@csr.com>
Cc: zsh-users@sunsite.dk
Subject: Re: static link zsh/example and zsh/zftp errors on FreeBSD
Message-ID: <20040119214721.GA94551@quark.localdomain>
References: <20040119095736.GA86747@quark.localdomain> <12217.1074509488@csr.com>
Mime-Version: 1.0
Content-Type: multipart/mixed; boundary="zhXaljGHf11kAtnf"
Content-Disposition: inline
In-Reply-To: <12217.1074509488@csr.com>
User-Agent: Mutt/1.4.1i


--zhXaljGHf11kAtnf
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline

On Mon, Jan 19, 2004 at 10:51:28AM +0000, Peter Stephenson wrote:
> Vincent Stemen wrote:
> 
> > Enable zsh/example in config.modules:
> > 
> > name=zsh/example modfile=Src/Modules/example.mdd link=static auto=no load=yes
> > 
> > I get the following errors:
> > 
> > gcc -static   -o zsh main.o  `cat stamp-modobjs`   -ltermcap -lm  -lc
> > init.o: In function `init_bltinmods':
> > init.o(.text+0x236a): undefined reference to `add_automath'
> > init.o(.text+0x237b): undefined reference to `add_automath'
> > make[1]: *** [zsh] Error 1
> > make[1]: Leaving directory `/u1/g2/pkg/src/zsh-4.1.1/Src'
> > make: *** [all] Error 1
> 
> That's a bit screwy; there's no add_automath, though there is an
> add_automathfunc which is only used inside module.c.

I thought so also after getting your reply so I investigated further
and found the problem.  Apparently the C call to add_automath() is
being generated by the shell script, Src/mkbltnmlst.sh.  I am guessing
that the function name was changed somewhere along the way and did not
get updated in that script.  I changed it to generate a call to
add_automathfunc() instead and it compiled successfully.  The patch is
attached.

> 
> > Enable zsh/zftp and I get the following error:
> > 
> > make[3]: Entering directory `/u1/g2/pkg/src/zsh-4.1.1/Src/Modules'
> > make[3]: *** No rule to make target `tcp.mdh', needed by `zftp.mdh'.
> > Stop.
> > make[3]: Leaving directory `/u1/g2/pkg/src/zsh-4.1.1/Src/Modules'
> > make[2]: *** [headers] Error 1
> > make[2]: Leaving directory `/u1/g2/pkg/src/zsh-4.1.1/Src'
> > make[1]: *** [headers] Error 2
> > make[1]: Leaving directory `/u1/g2/pkg/src/zsh-4.1.1/Src'
> > make: *** [all] Error 1
> 
> You will need to enable zsh/tcp, too.
> 
> It's probably a good idea to make either both or neither static.  We
> don't usually try with a mixture.  (Translation:  I have no idea what
> will happen.)

Ah! I see.  Yes, that fixed it.  It now compiles successfully with
zftp enabled.

Thanks.
Vincent

-- 
Vincent Stemen
Avoid the VeriSign/Network Solutions domain registration trap!
http://www.InetAddresses.net


--zhXaljGHf11kAtnf
Content-Type: text/plain; charset=us-ascii
Content-Disposition: attachment; filename="zsh-example.patch"

*** Src/mkbltnmlst.sh.orig	Mon Jan 19 15:24:36 2004
--- Src/mkbltnmlst.sh	Mon Jan 19 15:25:28 2004
***************
*** 54,60 ****
  	echo "    add_autoparam(\"$param\", \"$x_mod\");"
      done
      for mfunc in $automathfuncs; do
! 	echo "    add_automath(\"$mfunc\", \"$x_mod\");"
      done
      echo "  }"
      for dep in $moddeps; do
--- 54,60 ----
  	echo "    add_autoparam(\"$param\", \"$x_mod\");"
      done
      for mfunc in $automathfuncs; do
! 	echo "    add_automathfunc(\"$mfunc\", \"$x_mod\");"
      done
      echo "  }"
      for dep in $moddeps; do

--zhXaljGHf11kAtnf--

