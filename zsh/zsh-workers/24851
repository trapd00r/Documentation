From zsh-workers-return-24851-mason-zsh=primenet.com.au@sunsite.dk Sun Apr 20 06:36:43 2008
Return-Path: <zsh-workers-return-24851-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 996 invoked from network); 20 Apr 2008 06:36:41 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.4 (2008-01-01) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=BAYES_00 autolearn=ham
	version=3.2.4
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 20 Apr 2008 06:36:41 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 50151 invoked from network); 20 Apr 2008 06:36:34 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 20 Apr 2008 06:36:34 -0000
Received: (qmail 13677 invoked by alias); 20 Apr 2008 06:36:31 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 24851
Received: (qmail 13663 invoked from network); 20 Apr 2008 06:36:31 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 20 Apr 2008 06:36:31 -0000
Received: from mx30.mail.ru (mx30.mail.ru [194.67.23.238])
	by bifrost.dotsrc.org (Postfix) with ESMTP id F35E9808A37A
	for <zsh-workers@sunsite.dk>; Sun, 20 Apr 2008 08:36:26 +0200 (CEST)
Received: from [91.77.192.22] (port=25887 helo=cooker.net)
	by mx30.mail.ru with asmtp 
	id 1JnTA2-00088Q-00
	for zsh-workers@sunsite.dk; Sun, 20 Apr 2008 10:36:26 +0400
From: Andrey Borzenkov <arvidjaar@mail.ru>
To: zsh-workers@sunsite.dk
Subject: PATCH: support colour codes from current GNU ls
Date: Sun, 20 Apr 2008 10:36:21 +0400
User-Agent: KMail/1.9.9
MIME-Version: 1.0
Content-Type: multipart/signed;
  boundary="nextPart1760924.ipLHzXkcUC";
  protocol="application/pgp-signature";
  micalg=pgp-sha1
Content-Transfer-Encoding: 7bit
Message-Id: <200804201036.22025.arvidjaar@mail.ru>
X-Spam: Not detected
X-Virus-Scanned: ClamAV 0.91.2/6846/Sun Apr 20 06:06:11 2008 on bifrost
X-Virus-Status: Clean

--nextPart1760924.ipLHzXkcUC
Content-Type: text/plain;
  charset="us-ascii"
Content-Transfer-Encoding: quoted-printable
Content-Disposition: inline

This adds support for more colors that are supported in current GNU fileuti=
ls.

I am not sure how to properly detect orphan and missing files; when colour
is computed information is no more available. Nor was "missing" used so far
it seems.

Index: Doc/Zsh/mod_complist.yo
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D
RCS file: /cvsroot/zsh/zsh/Doc/Zsh/mod_complist.yo,v
retrieving revision 1.18
diff -u -p -r1.18 mod_complist.yo
=2D-- Doc/Zsh/mod_complist.yo	8 Nov 2007 12:34:15 -0000	1.18
+++ Doc/Zsh/mod_complist.yo	20 Apr 2008 06:32:07 -0000
@@ -51,11 +51,31 @@ for block devices
 item(tt(cd 44;37))(
 for character devices
 )
=2Ditem(tt(ex 35))(
=2Dfor executable files
+item(tt(or) var(none))(
+for a symlink to nonexistent file (default is the value defined for tt(fi)=
);
+this code is currently not used
 )
 item(tt(mi) var(none))(
=2Dfor a non-existent file (default is the value defined for tt(fi))
+for a non-existent file (default is the value defined for tt(fi)); this co=
de
+is currently not used
+)
+item(tt(su 37;41))(
+for files with setuid bit set
+)
+item(tt(sg 30;43))(
+for files with setgid bit set
+)
+item(tt(tw 30;42))(
+for world writable directories with sticky bit set
+)
+item(tt(ow 34;43))(
+for world writable directories without sticky bit set
+)
+item(tt(st 37;44))(
+for directories with sticky bit set but not world writable
+)
+item(tt(ex 35))(
+for executable files
 )
 item(tt(lc \e[))(
 for the left code (see below)
Index: Src/Zle/complist.c
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D
RCS file: /cvsroot/zsh/zsh/Src/Zle/complist.c,v
retrieving revision 1.110
diff -u -p -r1.110 complist.c
=2D-- Src/Zle/complist.c	13 Apr 2008 16:58:42 -0000	1.110
+++ Src/Zle/complist.c	20 Apr 2008 06:32:07 -0000
@@ -177,30 +177,38 @@ static Keymap mskeymap, lskeymap;
 #define COL_SO  5
 #define COL_BD  6
 #define COL_CD  7
=2D#define COL_EX  8
+#define COL_OR  8
 #define COL_MI  9
=2D#define COL_LC 10
=2D#define COL_RC 11
=2D#define COL_EC 12
=2D#define COL_TC 13
=2D#define COL_SP 14
=2D#define COL_MA 15
=2D#define COL_HI 16
=2D#define COL_DU 17
+#define COL_SU 10
+#define COL_SG 11
+#define COL_TW 12
+#define COL_OW 13
+#define COL_ST 14
+#define COL_EX 15
+#define COL_LC 16
+#define COL_RC 17
+#define COL_EC 18
+#define COL_TC 19
+#define COL_SP 20
+#define COL_MA 21
+#define COL_HI 22
+#define COL_DU 23
=20
=2D#define NUM_COLS 18
+#define NUM_COLS 24
=20
 /* Names of the terminal strings. */
=20
 static char *colnames[] =3D {
=2D    "no", "fi", "di", "ln", "pi", "so", "bd", "cd", "ex", "mi",
+    "no", "fi", "di", "ln", "pi", "so", "bd", "cd", "or", "mi",
+    "su", "sg", "tw", "ow", "st", "ex",
     "lc", "rc", "ec", "tc", "sp", "ma", "hi", "du", NULL
 };
=20
 /* Default values. */
=20
 static char *defcols[] =3D {
=2D    "0", "0", "1;31", "1;36", "33", "1;35", "1;33", "1;33", "1;32", NULL,
+    "0", "0", "1;31", "1;36", "33", "1;35", "1;33", "1;33", NULL, NULL,
+    "37;41", "30;43", "30;42", "34;42", "37;44", "1;32",=20
     "\033[", "m", NULL, "0", "0", "7", NULL, NULL
 };
=20
@@ -507,7 +515,9 @@ getcols()
     lr_caplen =3D strlen(mcolors.files[COL_LC]->col) +
 	strlen(mcolors.files[COL_RC]->col);
=20
=2D    /* Default for missing files. */
+    /* Default for orphans and missing files. Currently not used */
+    if (!mcolors.files[COL_OR] || !mcolors.files[COL_OR]->col)
+	mcolors.files[COL_OR] =3D mcolors.files[COL_FI];
     if (!mcolors.files[COL_MI] || !mcolors.files[COL_MI]->col)
 	mcolors.files[COL_MI] =3D mcolors.files[COL_FI];
=20
@@ -872,9 +882,17 @@ putfilecol(char *group, char *n, mode_t=20
 	    return 0;
 	}
=20
=2D    if (S_ISDIR(m))
=2D	colour =3D COL_DI;
=2D    else if (S_ISLNK(m))
+    if (S_ISDIR(m)) {
+	if (m & S_IWOTH)
+	    if (m & S_ISVTX)
+		colour =3D COL_TW;
+	    else
+		colour =3D COL_OW;
+	else if (m & S_ISVTX)
+	    colour =3D COL_ST;
+	else
+	    colour =3D COL_DI;
+    } else if (S_ISLNK(m))
 	colour =3D COL_LN;
     else if (S_ISFIFO(m))
 	colour =3D COL_PI;
@@ -884,6 +902,10 @@ putfilecol(char *group, char *n, mode_t=20
 	colour =3D COL_BD;
     else if (S_ISCHR(m))
 	colour =3D COL_CD;
+    else if (m & S_ISUID)
+	colour =3D COL_SU;
+    else if (m & S_ISGID)
+	colour =3D COL_SG;
     else if (S_ISREG(m) && (m & S_IXUGO))
 	colour =3D COL_EX;
     else
=20

--nextPart1760924.ipLHzXkcUC
Content-Type: application/pgp-signature; name=signature.asc 
Content-Description: This is a digitally signed message part.

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.9 (GNU/Linux)

iEYEABECAAYFAkgK5GUACgkQR6LMutpd94zewwCfW5N/gIJ7GNQxJw2db8M4WRxq
Y8MAoNJ45Q4gOgIGac8gtN+8ic0jrwtC
=SkFt
-----END PGP SIGNATURE-----

--nextPart1760924.ipLHzXkcUC--

