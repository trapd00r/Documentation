From zsh-users-return-11947-mason-zsh=primenet.com.au@sunsite.dk Mon Oct 08 00:09:54 2007
Return-Path: <zsh-users-return-11947-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 5472 invoked from network); 8 Oct 2007 00:09:46 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.3 (2007-08-08) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00,SPF_HELO_PASS
	autolearn=ham version=3.2.3
Received: from ns2.primenet.com.au (HELO primenet.com.au) (@203.24.36.3)
  by ns1.primenet.com.au with (DHE-RSA-AES256-SHA encrypted) SMTP; 8 Oct 2007 00:09:46 -0000
Received: (qmail 18205 invoked from network); 7 Oct 2007 17:03:03 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns2.melb.primenet.com.au with SMTP; 7 Oct 2007 17:03:03 -0000
Received-SPF: none (ns2.melb.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 54438 invoked from network); 7 Oct 2007 17:02:56 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 7 Oct 2007 17:02:56 -0000
Received: (qmail 25068 invoked by alias); 7 Oct 2007 17:02:47 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 11947
Received: (qmail 25053 invoked from network); 7 Oct 2007 17:02:46 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 7 Oct 2007 17:02:46 -0000
Received: (qmail 53281 invoked from network); 7 Oct 2007 17:02:46 -0000
Received: from vms048pub.verizon.net (206.46.252.48)
  by a.mx.sunsite.dk with SMTP; 7 Oct 2007 17:02:39 -0000
Received: from torch.brasslantern.com ([71.116.76.59])
 by vms048.mailsrvcs.net (Sun Java System Messaging Server 6.2-6.01 (built Apr
 3 2006)) with ESMTPA id <0JPJ00BLDWNFDH65@vms048.mailsrvcs.net> for
 zsh-users@sunsite.dk; Sun, 07 Oct 2007 12:02:04 -0500 (CDT)
Received: from torch.brasslantern.com (localhost.localdomain [127.0.0.1])
	by torch.brasslantern.com (8.13.1/8.13.1) with ESMTP id l97H22gw023732	for
 <zsh-users@sunsite.dk>; Sun, 07 Oct 2007 10:02:03 -0700
Received: (from schaefer@localhost)	by torch.brasslantern.com
 (8.13.1/8.13.1/Submit) id l97H22S6023731	for zsh-users@sunsite.dk; Sun,
 07 Oct 2007 10:02:02 -0700
Date: Sun, 07 Oct 2007 10:02:02 -0700
From: Bart Schaefer <schaefer@brasslantern.com>
Subject: Re: sluggish prompt
In-reply-to: <20071007071256.GA14895@panix.com>
To: zsh-users@sunsite.dk
Message-id: <071007100202.ZM23730@torch.brasslantern.com>
MIME-version: 1.0
X-Mailer: OpenZMail Classic (0.9.2 24April2005)
Content-type: text/plain; charset=us-ascii
References: <20071007045049.GA28877@panix.com>
	<20071007053638.14299.qmail@smasher.org>	<20071007061947.GA6554@panix.com>
	<20071007063359.30913.qmail@smasher.org>	<20071007071256.GA14895@panix.com>
Comments: In reply to Russell Hoover <rj@panix.com>
 "Re: sluggish prompt" (Oct  7,  3:12am)

On Oct 7,  3:12am, Russell Hoover wrote:
} Subject: Re: sluggish prompt
} 
} It hangs after any inactivity.

This, and your earlier remark that it happens "after exiting a program",
would tend to indicate that zsh has become swapped out and it's taking
the operating system a long time to swap it back again.  Have you
looked at the output of "ps" (with appropriate options, which vary by
operating system; perhaps "ps up$$" would work) to see how much memory
your shell is consuming?

Are you having this problem on a personal workstation, when logging in
to a shared server, or in some other situation?  How busy is the system
in general?

} I think I made a few adjustments to the rc recently after starting
} to use zsh-3.4.3.  One thing I noticed in the read-out that it kept
} repeating all the different filenames for lines 251 & 253 over & over.

It's not clear from your series of messages whether this happened only
when you started the shell, or every time there was a prompt.

If only at startup, then it's not something to worry about.

} Here are those lines:
} ----------------------------------------------------
} 248 for dirname in $fpath
} 249 do
} 250   for files in $dirname/*(:t)
} 251   do
} 252     autoload $files
} 253   done
} 254 done
} ------------------------------------------------------

I believe you could replace that entire loop with

	autoload ${^fpath}/*(N-.:t)

} The lines I quoted that kept repeating whenever I hit return
} I now notice are from the rcfile:
} -------------------------------------------------------
} 233 function precmd {
} 234         local exitstatus=$?
} 235         psvar[1]=SIG
} 236         [[ $exitstatus -ge 128 ]] && psvar[1]=SIG$signals[$exitstatus-127]
} 237 #        [[ $psvar[1] = SIG ]] && psvar[1]=$exitstatus
} 238 #        jobs % >& /dev/null && psvar[2]=""  || psvar[2]=()
} 239         psvar[2]=$#jobstates; [[ $psvar[2] -eq 0 ]] && psvar[2]=()
} 240 }
} --------------------------------------------------------
} 
} Not sure why the two lines are commented out -- these lines were
} definitely copied, though almost all of the rest of the file is not.

They're probably commented out because they are a cruder/older way to
accomplish the equivalent of the one line following them.
 
} At the risk of overkill here's the whole file, thanks for helping:

There's nothing alarming in there.  Leave the "set -x" out of your rc
file and instead edit your precmd to be:

    function precmd {
	local exitstatus=$?
	print -u2 PRECMD
	psvar[1]=SIG
	[[ $exitstatus -ge 128 ]] && psvar[1]=SIG$signals[$exitstatus-127]
	psvar[2]=$#jobstates; [[ $psvar[2] -eq 0 ]] && psvar[2]=()
    }

Now watch carefully.  When you get the 6-10 second delay, does it happen
before or after the word PRECMD is printed?

Do you have anything in other init files such as .zlogin, .zprofile, etc.?

