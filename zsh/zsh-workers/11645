From zsh-workers-return-11645-mason-zsh=primenet.com.au@sunsite.auc.dk Tue May 30 05:54:35 2000
Return-Path: <zsh-workers-return-11645-mason-zsh=primenet.com.au@sunsite.auc.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 2250 invoked from network); 30 May 2000 05:54:34 -0000
Received: from sunsite.auc.dk (130.225.51.30)
  by ns1.primenet.com.au with SMTP; 30 May 2000 05:54:34 -0000
Received: (qmail 25349 invoked by alias); 30 May 2000 05:54:23 -0000
Mailing-List: contact zsh-workers-help@sunsite.auc.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.auc.dk
X-Seq: 11645
Received: (qmail 25342 invoked from network); 30 May 2000 05:54:21 -0000
From: "Bart Schaefer" <schaefer@candle.brasslantern.com>
Message-Id: <1000530055416.ZM22357@candle.brasslantern.com>
Date: Tue, 30 May 2000 05:54:16 +0000
In-Reply-To: <1000530031957.ZM17947@candle.brasslantern.com>
Comments: In reply to "Bart Schaefer" <schaefer@candle.brasslantern.com>
        "PATCH: Updated _rpm, but a bug with _arguments" (May 30,  3:19am)
References: <1000530031957.ZM17947@candle.brasslantern.com>
X-Mailer: Z-Mail (5.0.0 30July97)
To: zsh-workers@sunsite.auc.dk
Subject: Re: PATCH: Updated _rpm, but a bug with _arguments
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii

On May 30,  3:19am, Bart Schaefer wrote:
} Subject: PATCH: Updated _rpm, but a bug with _arguments
}
} As of the current CVS sources (_arguments revision 1.25) completion for rpm
} doesn't work any longer:
} 
} zagzig[24] rpm --rc<TAB>
} Completing no arguments
} (beep)

It's actually much worse than this; option completion is entirely broken
when there's anything in the current word other than the leading hyphens.
The culprits seem to be the following two hunks of 11624; for example, if
I delete the `&& !line[2]' then completion after two hyphens and an alpha-
numeric starts working again, but one hyphen and an alphanum still fails.

x@ -1434,7 +1436,11 @@
                (state.def->type == CAA_RREST ||
                 state.def->type == CAA_RARGS)) {
                state.inrest = 0;
-               state.opt = (cur == state.nargbeg + 1);
+               state.opt = (cur == state.nargbeg + 1 &&
+                            (!*line || 
+                             ((*line == '-' || *line == '+') &&
+                              (!line[1] ||
+                               (*line == '-' && line[1] == '-' && !line[2])))));
                state.optbeg = state.nargbeg;
                state.argbeg = cur - 1;
                state.argend = argend;
x@ -1510,6 +1516,10 @@
                }
            } else {
                ca_laststate.def = adef;
+               ca_laststate.opt = (!arglast || !*line || 
+                                   ((*line == '-' || *line == '+') &&
+                                    (!line[1] ||
+                                     (*line == '-' && line[1] == '-' && !line[2]))));
                ca_laststate.ddef = NULL;
                ca_laststate.dopt = NULL;
                ca_laststate.optbeg = state.nargbeg;

-- 
Bart Schaefer                                 Brass Lantern Enterprises
http://www.well.com/user/barts              http://www.brasslantern.com

Zsh: http://www.zsh.org | PHPerl Project: http://phperl.sourceforge.net   

