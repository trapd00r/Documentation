From zsh-workers-return-21942-mason-zsh=primenet.com.au@sunsite.dk Fri Oct 28 12:04:03 2005
Return-Path: <zsh-workers-return-21942-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 8158 invoked from network); 28 Oct 2005 12:03:59 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 28 Oct 2005 12:03:59 -0000
Received: (qmail 97462 invoked from network); 28 Oct 2005 12:03:53 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 28 Oct 2005 12:03:53 -0000
Received: (qmail 7035 invoked by alias); 28 Oct 2005 12:03:50 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 21942
Received: (qmail 7025 invoked from network); 28 Oct 2005 12:03:50 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 28 Oct 2005 12:03:50 -0000
Received: (qmail 97175 invoked from network); 28 Oct 2005 12:03:50 -0000
Received: from cluster-c.mailcontrol.com (HELO rly04c.srv.mailcontrol.com) (168.143.177.190)
  by a.mx.sunsite.dk with SMTP; 28 Oct 2005 12:03:49 -0000
Received: from exchange03.csr.com (mailhost1.csr.com [81.105.217.43])
	by rly04c.srv.mailcontrol.com (MailControl) with ESMTP id j9SC3isB012948
	for <zsh-workers@sunsite.dk>; Fri, 28 Oct 2005 13:03:46 +0100
Received: from news01 ([10.103.143.38]) by exchange03.csr.com with Microsoft SMTPSVC(5.0.2195.6713);
	 Fri, 28 Oct 2005 13:06:04 +0100
Date: Fri, 28 Oct 2005 13:03:43 +0100
From: Peter Stephenson <pws@csr.com>
To: zsh-workers@sunsite.dk
Subject: Re: PATCH: displaying wide characters
Message-Id: <20051028130343.03e7ab97.pws@csr.com>
In-Reply-To: <237967ef0510260731rad76af2u7098358d3f0baa76@mail.gmail.com>
References: <200510192031.j9JKVYk7010115@pwslaptop.csr.com>
	<200510192041.j9JKfTJZ010450@pwslaptop.csr.com>
	<237967ef0510191739t103352a9vad735334a790d8b5@mail.gmail.com>
	<EXCHANGE03zfSLZZInL00006f40@exchange03.csr.com>
	<237967ef0510240140g548e0c0r3deb3f4704dc313@mail.gmail.com>
	<20051026001154.32458ec3.p.w.stephenson@ntlworld.com>
	<237967ef0510252219p57c16e24j1c1f2c9ae3ef3003@mail.gmail.com>
	<20051026101757.3997362f.pws@csr.com>
	<237967ef0510260731rad76af2u7098358d3f0baa76@mail.gmail.com>
Organization: Cambridge Silicon Radio
X-Mailer: Sylpheed version 0.9.12 (GTK+ 1.2.10; i386-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
X-OriginalArrivalTime: 28 Oct 2005 12:06:04.0948 (UTC) FILETIME=[F8CB0540:01C5DBB7]
X-Scanned-By: MailControl A-05-40-01 (www.mailcontrol.com) on 10.67.0.114
X-Spam-Checker-Version: SpamAssassin 3.0.4 (2005-06-05) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=AWL,BAYES_00 autolearn=ham 
	version=3.0.4

Mikael Magnusson <mikachu@gmail.com> wrote:
> This didn't fix the problem for me, but it is acting differently now.
> Not sure how to describe it accurately, I'll paste a few lines where
> all I've done is press delete at the first character:

I've found a problem with deletions but for some reason it didn't show up
with the characters you were using.  Anyway, this code certainly fixes
something, so let's see if it's yours.

Much of the following may be simply paranoia; the last fix is the key one.
What happened before was we only overwrote part of the last displayed
character.

Index: Src/Zle/zle_refresh.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/zle_refresh.c,v
retrieving revision 1.34
diff -u -r1.34 zle_refresh.c
--- Src/Zle/zle_refresh.c	25 Oct 2005 23:13:41 -0000	1.34
+++ Src/Zle/zle_refresh.c	28 Oct 2005 12:02:18 -0000
@@ -1069,9 +1069,22 @@
 /* 3: main display loop - write out the buffer using whatever tricks we can */
 
     for (;;) {
-	if (*nl && *ol && nl[1] == ol[1]) /* skip only if second chars match */
+	if (*nl && *ol && nl[1] == ol[1]) {
+	    /* skip only if second chars match */
+#ifdef ZLE_UNICODE_SUPPORT
+	    int ccs_was = ccs;
+#endif
 	/* skip past all matching characters */
 	    for (; *nl && (*nl == *ol); nl++, ol++, ccs++) ;
+#ifdef ZLE_UNICODE_SUPPORT
+	    /* Make sure ol and nl are pointing to real characters */
+	    while ((*nl == WEOF || *ol == WEOF) && ccs > ccs_was) {
+		nl--;
+		ol--;
+		ccs--;
+	    }
+#endif
+	}
 
 	if (!*nl) {
 	    if (ccs == winw && hasam && char_ins > 0 && ins_last
@@ -1125,7 +1138,8 @@
 
     /* inserting & deleting chars: we can if there's no right-prompt */
 	if ((ln || !put_rpmpt || !oput_rpmpt) 
-	    && (nl[1] && ol[1] && nl[1] != ol[1])) { 
+	    && (nl[1] && ol[1] && nl[1] != ol[1])
+	    && *ol != WEOF && *nl != WEOF) { 
 
 	/* deleting characters - see if we can find a match series that
 	   makes it cheaper to delete intermediate characters
@@ -1177,9 +1191,19 @@
 	}
     /* we can't do any fancy tricks, so just dump the single character
        and keep on trying */
-	zputc(*nl);
-	nl++, ol++;
-	ccs++, vcs++;
+#ifdef ZLE_UNICODE_SUPPORT
+	do {
+#endif
+	    zputc(*nl);
+	    nl++, ol++;
+	    ccs++, vcs++;
+#ifdef ZLE_UNICODE_SUPPORT
+	    /*
+	     * Make sure we always overwrite the complete width of
+	     * a character that was there before.
+	     */
+	} while (*ol == WEOF && *nl);
+#endif
     }
 }
 


-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070


This message has been scanned for viruses by BlackSpider MailControl - www.blackspider.com

