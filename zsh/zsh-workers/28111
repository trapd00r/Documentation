From zsh-workers-return-28111-mason-zsh=primenet.com.au@zsh.org Sat Jul 31 20:56:34 2010
Return-Path: <zsh-workers-return-28111-mason-zsh=primenet.com.au@zsh.org>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 18109 invoked by alias); 31 Jul 2010 20:56:34 -0000
Mailing-List: contact zsh-workers-help@zsh.org; run by ezmlm
Precedence: bulk
X-No-Archive: yes
List-Id: Zsh Workers List <zsh-workers.zsh.org>
List-Post: <mailto:zsh-workers@zsh.org>
List-Help: <mailto:zsh-workers-help@zsh.org>
Delivered-To: mailing list zsh-workers@zsh.org
X-Seq: 28111
Received: (qmail 7992 invoked from network); 31 Jul 2010 20:56:32 -0000
X-Spam-Checker-Version: SpamAssassin 3.3.1 (2010-03-16) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-1.9 required=5.0 tests=BAYES_00,RCVD_IN_DNSWL_NONE
	autolearn=ham version=3.3.1
Received-SPF: pass (ns1.primenet.com.au: SPF record at ntlworld.com designates 81.103.221.48 as permitted sender)
Date: Sat, 31 Jul 2010 21:56:02 +0100
From: Peter Stephenson <p.w.stephenson@ntlworld.com>
To: zsh-workers@zsh.org
Subject: Re: Option PRINT_EXIT_VALUE doesn't always work as expected
Message-ID: <20100731215602.39cbaf52@pws-pc>
In-Reply-To: <20100730130204.GC8757@ypig.lip.ens-lyon.fr>
References: <20100730130204.GC8757@ypig.lip.ens-lyon.fr>
X-Mailer: Claws Mail 3.7.6 (GTK+ 2.18.9; x86_64-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
X-Cloudmark-Analysis: v=1.1 cv=4QByPj+6Iq2k/6L54d+eVKTdgQxdscpRskJJReCfdXo= c=1 sm=0 a=rNnWHmR4J4oA:10 a=DogomfpGjd0A:10 a=kj9zAlcOel0A:10 a=YR4_K0clAAAA:8 a=NLZqzBF-AAAA:8 a=R118FEvnQd8jAuhRnfMA:9 a=ILb0k_CAVqDXJ57QI60A:7 a=nlshTeZVnrH7vAmH8Lu9EnYP3v0A:4 a=CjuIK1q_8ugA:10 a=8EUp7cGwtfYA:10 a=_dQi-Dcv4p4A:10 a=HpAAvcLHHh0Zw7uRqdWCyQ==:117

On Fri, 30 Jul 2010 15:02:04 +0200
Vincent Lefevre <vincent@vinc17.net> wrote:
> ypig% setopt PRINT_EXIT_VALUE
> ypig% false | head -n 1
> zsh: exit 1     false | 
> zsh: done       head -n 1
> ypig% echo $pipestatus
> 1 0
> ypig% false | true
> ypig% echo $pipestatus
> 1 0

This fixes that one, sort of...  The shell does special stuff if both
elements of the pipeline are run within the shell.  The special stuff
means the pipeline looks a bit different in this case, however...

% false | true
[1]    11714 exit 1     false

but it does now report the process with the non-zero status, which is
the main point.

Index: Src/jobs.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/jobs.c,v
retrieving revision 1.75
diff -p -u -r1.75 jobs.c
--- Src/jobs.c	16 Dec 2009 18:39:07 -0000	1.75
+++ Src/jobs.c	31 Jul 2010 20:50:22 -0000
@@ -837,7 +837,7 @@ printjob(Job jn, int lng, int synch)
     Process pn;
     int job, len = 9, sig, sflag = 0, llen;
     int conted = 0, lineleng = columns, skip = 0, doputnl = 0;
-    int doneprint = 0;
+    int doneprint = 0, skip_print = 0;
     FILE *fout = (synch == 2 || !shout) ? stdout : shout;
 
     if (oldjobtab != NULL)
@@ -846,16 +846,7 @@ printjob(Job jn, int lng, int synch)
 	job = jn - jobtab;
 
     if (jn->stat & STAT_NOPRINT) {
-	if (jn->stat & STAT_DONE) {
-	    deletejob(jn);
-	    if (job == curjob) {
-		curjob = prevjob;
-		prevjob = job;
-	    }
-	    if (job == prevjob)
-		setprevjob();
-	}
-	return 0;
+	skip_print = 1;
     }
 
     if (lng < 0) {
@@ -889,11 +880,26 @@ printjob(Job jn, int lng, int synch)
 		if (job == thisjob && sig == SIGTSTP)
 		    doputnl = 1;
 	    } else if (isset(PRINTEXITVALUE) && isset(SHINSTDIN) &&
-		       WEXITSTATUS(pn->status))
+		       WEXITSTATUS(pn->status)) {
 		sflag = 1;
+		skip_print = 0;
+	    }
 	}
     }
 
+    if (skip_print) {
+	if (jn->stat & STAT_DONE) {
+	    deletejob(jn);
+	    if (job == curjob) {
+		curjob = prevjob;
+		prevjob = job;
+	    }
+	    if (job == prevjob)
+		setprevjob();
+	}
+	return 0;
+    }
+
     /*
      * - Always print if called from jobs
      * - Otherwise, require MONITOR option ("jobbing") and some

-- 
Peter Stephenson <p.w.stephenson@ntlworld.com>
Web page now at http://homepage.ntlworld.com/p.w.stephenson/

