From zsh-users-return-13040-mason-zsh=primenet.com.au@sunsite.dk Thu Jul 17 21:28:56 2008
Return-Path: <zsh-users-return-13040-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 775 invoked from network); 17 Jul 2008 21:28:54 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.5 (2008-06-10) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=BAYES_00 autolearn=ham
	version=3.2.5
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 17 Jul 2008 21:28:54 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 53735 invoked from network); 17 Jul 2008 21:28:40 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 17 Jul 2008 21:28:40 -0000
Received: (qmail 9298 invoked by alias); 17 Jul 2008 21:28:26 -0000
Mailing-List: contact zsh-users-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-users@sunsite.dk
X-Seq: 13040
Received: (qmail 26343 invoked from network); 17 Jul 2008 21:01:45 -0000
Received: from bifrost.dotsrc.org (130.225.254.106)
  by sunsite.dk with SMTP; 17 Jul 2008 21:01:45 -0000
Received: from smtp2.infineon.com (smtp2.infineon.com [217.10.60.23])
	by bifrost.dotsrc.org (Postfix) with ESMTPS id 8009780561C4
	for <zsh-users@sunsite.dk>; Thu, 17 Jul 2008 23:01:41 +0200 (CEST)
X-SBRS: None
Received: from unknown (HELO mucse313.eu.infineon.com) ([172.23.30.13])
  by smtp2.infineon.com with ESMTP; 17 Jul 2008 22:59:39 +0200
Received: from mucse411.eu.infineon.com ([172.23.29.21]) by mucse313.eu.infineon.com with Microsoft SMTPSVC(6.0.3790.1830);
	 Thu, 17 Jul 2008 23:01:39 +0200
Received: from mucse403.eu.infineon.com ([172.23.29.13]) by
 mucse411.eu.infineon.com ([172.23.29.21]) with mapi; Thu, 17 Jul 2008
 23:01:39 +0200
From: <Gerald.Williams@infineon.com>
To: <zsh-users@sunsite.dk>
Date: Thu, 17 Jul 2008 23:01:39 +0200
Subject: RE: Under Cygwin ZSH, "diff -" fails unless forced into text mode
Thread-Topic: Under Cygwin ZSH, "diff -" fails unless forced into text mode
Thread-Index: AcjoPuRfIUl5S6dFQ7OuI1/WXzfODgAC8wbQ
Message-ID: <D296F3258FB4964D9EBA55141AC6F990056D99FB@mucse403.eu.infineon.com>
References: <20080717085929.2356@blackhawk> <20080717195646.2c69e9b7@pws-pc>
In-Reply-To: <20080717195646.2c69e9b7@pws-pc>
Accept-Language: en-US
Content-Language: en-US
X-MS-Has-Attach:
X-MS-TNEF-Correlator:
acceptlanguage: en-US
Content-Type: text/plain; charset="us-ascii"
Content-Transfer-Encoding: quoted-printable
MIME-Version: 1.0
X-OriginalArrivalTime: 17 Jul 2008 21:01:39.0213 (UTC) FILETIME=[4E807BD0:01C8E850]
X-Virus-Scanned: ClamAV 0.92.1/7739/Thu Jul 17 19:55:11 2008 on bifrost
X-Virus-Status: Clean

Peter Stephenson wrote:
>>  zsh% cat foo | diff - foo
>>  diff: -: Illegal seek
>>  zsh%
>
> The short, but unsatisfactory, answer is that it's not required to
> work.  diff expects to have a seekable file, for which a pipe doesn't
> necessarily qualify: it depends partly on the OS and also partly on how
> far back you need to seek, so you sometimes get away with it.

I'd call expecting stdin to be seekable a bug in diff,
although presumably ZSH-USERS isn't the right forum for
that discussion. (I guess HELP-GNU-UTILS would be.)

>> It passes if I force it into text mode:
>>
>>  zsh% cat foo | diff -a - foo
>>  zsh%
>
> There's some Cygwin-specific code in main.c to force read-only files
> into text mode.  This is a fairly murky area and I have no idea how that
> affects pipes.

I'm not sure where you're headed with that one, but it
appears that ZSH is making the pipe appear as a binary
stream in this case. Forcing it *back* to text is what
fixes the problem.

I know there are similar issues with UTF-8 encodings on
Linux, and I have at times worked around it by setting
LANG=3D or LANG=3DC or something similar (I haven't delved
into it too deeply, although it looks like some of the
workarounds aren't as successful with some of the newer
versions of Linux). But this issue is happening all of
the time on Cygwin, and so far I haven't figured a way
to suppress it. Other shells do not act this way.

-Jerry

