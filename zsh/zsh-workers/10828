From zsh-workers-return-10828-mason-zsh=primenet.com.au@sunsite.auc.dk Wed Apr 19 13:41:23 2000
Return-Path: <zsh-workers-return-10828-mason-zsh=primenet.com.au@sunsite.auc.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 5387 invoked from network); 19 Apr 2000 13:41:22 -0000
Received: from sunsite.auc.dk (130.225.51.30)
  by ns1.primenet.com.au with SMTP; 19 Apr 2000 13:41:22 -0000
Received: (qmail 25601 invoked by alias); 19 Apr 2000 13:41:11 -0000
Mailing-List: contact zsh-workers-help@sunsite.auc.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.auc.dk
X-Seq: 10828
Received: (qmail 25589 invoked from network); 19 Apr 2000 13:41:11 -0000
Date: Wed, 19 Apr 2000 15:41:10 +0200 (MET DST)
Message-Id: <200004191341.PAA19686@beta.informatik.hu-berlin.de>
From: Sven Wischnowsky <wischnow@informatik.hu-berlin.de>
To: zsh-workers@sunsite.auc.dk
In-reply-to: Sven Wischnowsky's message of Wed, 19 Apr 2000 11:26:30 +0200
	(MET DST)
Subject: PATCH: Re: bindkey bug with zsh-3.1.6-dev-21?


I wrote:

> ...
> 
> Hm, maybe a test of the form
> 
>   if (load(zle) || !loaded(complete)) load(compctl);
> 
> There's find_module() for that kind of test.
> 
> Does that sound sensible?

Oops. No, Sven, we can't do that in autoload_zleread(), obviously.

So this puts the test in docomplete().

And it adds module_loaded() which can be used to test if a module is
really loaded.

Bye
 Sven

Index: Src/module.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/module.c,v
retrieving revision 1.1.1.35
diff -u -r1.1.1.35 module.c
--- Src/module.c	2000/02/23 15:18:45	1.1.1.35
+++ Src/module.c	2000/04/19 13:40:33
@@ -447,6 +447,18 @@
 }
 
 /**/
+mod_export int
+module_loaded(const char *name)
+{
+    LinkNode node;
+    Module m;
+
+    return ((node = find_module(name)) &&
+	    (m = ((Module) getdata(node)))->u.handle &&
+	    !(m->flags & MOD_UNLOAD));
+}
+
+/**/
 #ifdef DYNAMIC
 
 /**/
Index: Src/Zle/zle_tricky.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/zle_tricky.c,v
retrieving revision 1.6
diff -u -r1.6 zle_tricky.c
--- Src/Zle/zle_tricky.c	2000/04/17 11:17:10	1.6
+++ Src/Zle/zle_tricky.c	2000/04/19 13:40:34
@@ -523,6 +523,9 @@
     if (undoing)
 	setlastline();
 
+    if (!module_loaded("zsh/complete"))
+	load_module("zsh/compctl");
+
     if (runhookdef(BEFORECOMPLETEHOOK, (void *) &lst))
 	return 0;
 

--
Sven Wischnowsky                         wischnow@informatik.hu-berlin.de

