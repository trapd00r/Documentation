From zsh-workers-return-23195-mason-zsh=primenet.com.au@sunsite.dk Tue Feb 27 12:41:43 2007
Return-Path: <zsh-workers-return-23195-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 8389 invoked from network); 27 Feb 2007 12:41:37 -0000
X-Spam-Checker-Version: SpamAssassin 3.1.8 (2007-02-13) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.5 required=5.0 tests=BAYES_00,FORGED_RCVD_HELO
	autolearn=ham version=3.1.8
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns1.primenet.com.au with SMTP; 27 Feb 2007 12:41:37 -0000
Received-SPF: none (ns1.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 72311 invoked from network); 27 Feb 2007 12:41:31 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 27 Feb 2007 12:41:31 -0000
Received: (qmail 27326 invoked by alias); 27 Feb 2007 12:41:28 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 23195
Received: (qmail 27296 invoked from network); 27 Feb 2007 12:41:27 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 27 Feb 2007 12:41:27 -0000
Received: (qmail 71945 invoked from network); 27 Feb 2007 12:41:27 -0000
Received: from cluster-c.mailcontrol.com (168.143.177.190)
  by a.mx.sunsite.dk with SMTP; 27 Feb 2007 12:41:20 -0000
Received: from cameurexb01.EUROPE.ROOT.PRI ([62.189.241.200])
	by rly13c.srv.mailcontrol.com (MailControl) with ESMTP id l1RCfAbX000345
	for <zsh-workers@sunsite.dk>; Tue, 27 Feb 2007 12:41:10 GMT
Received: from news01.csr.com ([10.103.143.38]) by cameurexb01.EUROPE.ROOT.PRI with Microsoft SMTPSVC(6.0.3790.1830);
	 Tue, 27 Feb 2007 12:41:09 +0000
Date: Tue, 27 Feb 2007 12:41:05 +0000
From: Peter Stephenson <pws@csr.com>
To: zsh-workers@sunsite.dk (Zsh hackers list)
Subject: Re: PATCH: completion regex handling
Message-Id: <20070227124105.8208c36c.pws@csr.com>
In-Reply-To: <070226001857.ZM8988@torch.brasslantern.com>
References: <200702252237.l1PMb7Pw012255@pwslaptop.csr.com>
	<070226001857.ZM8988@torch.brasslantern.com>
Organization: Cambridge Silicon Radio
X-Mailer: Sylpheed version 2.2.10 (GTK+ 2.10.8; i386-redhat-linux-gnu)
Mime-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
X-OriginalArrivalTime: 27 Feb 2007 12:41:09.0680 (UTC) FILETIME=[8E7BE300:01C75A6C]
X-Scanned-By: MailControl A-07-06-80 (www.mailcontrol.com) on 10.67.0.123

Bart Schaefer <schaefer@brasslantern.com> wrote:
> } There are a few problems.  I couldn't work out how to add separators
> } other than space to a command added from within a regex argument
> } specifier.  It should have been possible to use _values -s, but for some
> } reason that didn't work.
> 
> I seem to recall some other places where _values doesn't work correctly.
> Maybe something related to the recursion problem mentioned in the thread
> spawned by zsh-workers/20618?

I don't think it's quite the same.

_values is doing something weird [traditional pause for amazed cries to die
away] with the separator.  It gets it with compvalues -s sep near the top,
then further down there's this:

      if [[ ${#noargs}+${#args}+${#opts} -ne 1 ]] && compvalues -s sep; then
        sep=( "-qS" "$sep" )
      else
        sep=()
      fi

If I comment out all but the second line it works the way I want (and,
playing with dd completion, I couldn't see any obvious adverse effects,
either, although presumably it's wrong if $sep isn't set).  CVS didn't give
much help: that second line was modified on 16th April 2002, the rest of
that chunk on 2nd April 2001, and the previous compvalues -s sep on 8th May
2001.

I'm testing it with this change to _regex_words, which is currently
only used when completing network realms, as in "ip route show realms ".
If it works, you get "cosmos/"; if it doesn't you get "cosmos ".

Index: Completion/Base/Utility/_regex_words
===================================================================
RCS file: /cvsroot/zsh/zsh/Completion/Base/Utility/_regex_words,v
retrieving revision 1.1
diff -u -r1.1 _regex_words
--- Completion/Base/Utility/_regex_words	25 Feb 2007 22:44:52 -0000	1.1
+++ Completion/Base/Utility/_regex_words	27 Feb 2007 12:35:11 -0000
@@ -33,7 +33,8 @@
   else
     # HERE: we should add the terminator instead of a space, but
     # there doesn't appear to be an easy way of doing that.
-    reply+=(":${tag}:${desc}:(( ${wds[1]//\*}${term//(#m)[: \(\)]/\\$MATCH}:${wds[2]//(#m)[: \(\)]/\\$MATCH} ))")
+    # reply+=(":${tag}:${desc}:(( ${wds[1]//\*}${term//(#m)[: \(\)]/\\$MATCH}:${wds[2]//(#m)[: \(\)]/\\$MATCH} ))")
+    reply+=(":${tag}:${desc}:_values -s $term ${wds[2]//(#m)[: \(\)]/\\$MATCH} ${wds[1]//\*}")
   fi
   eval "reply+=($wds[3])"
   if (( $i == $# )); then


-- 
Peter Stephenson <pws@csr.com>                  Software Engineer
CSR PLC, Churchill House, Cambridge Business Park, Cowley Road
Cambridge, CB4 0WZ, UK                          Tel: +44 (0)1223 692070


To access the latest news from CSR copy this link into a web browser:  http://www.csr.com/email_sig.php

To get further information regarding CSR, please visit our Investor Relations page at http://ir.csr.com/csr/about/overview

