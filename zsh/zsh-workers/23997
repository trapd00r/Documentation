From zsh-workers-return-23997-mason-zsh=primenet.com.au@sunsite.dk Sat Oct 20 00:46:52 2007
Return-Path: <zsh-workers-return-23997-mason-zsh=primenet.com.au@sunsite.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 543 invoked from network); 20 Oct 2007 00:46:07 -0000
X-Spam-Checker-Version: SpamAssassin 3.2.3 (2007-08-08) on f.primenet.com.au
X-Spam-Level: 
X-Spam-Status: No, score=-2.6 required=5.0 tests=AWL,BAYES_00,SPF_HELO_PASS
	autolearn=ham version=3.2.3
Received: from ns2.primenet.com.au (HELO primenet.com.au) (@203.24.36.3)
  by ns1.primenet.com.au with (DHE-RSA-AES256-SHA encrypted) SMTP; 20 Oct 2007 00:46:07 -0000
Received: (qmail 11972 invoked from network); 19 Oct 2007 20:20:51 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by ns2.melb.primenet.com.au with SMTP; 19 Oct 2007 20:20:51 -0000
Received-SPF: none (ns2.melb.primenet.com.au: domain at sunsite.dk does not designate permitted sender hosts)
Received: (qmail 82311 invoked from network); 19 Oct 2007 20:19:45 -0000
Received: from sunsite.dk (130.225.247.90)
  by a.mx.sunsite.dk with SMTP; 19 Oct 2007 20:19:45 -0000
Received: (qmail 10603 invoked by alias); 19 Oct 2007 20:19:42 -0000
Mailing-List: contact zsh-workers-help@sunsite.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.dk
X-Seq: 23997
Received: (qmail 10589 invoked from network); 19 Oct 2007 20:19:41 -0000
Received: from news.dotsrc.org (HELO a.mx.sunsite.dk) (130.225.247.88)
  by sunsite.dk with SMTP; 19 Oct 2007 20:19:41 -0000
Received: (qmail 82006 invoked from network); 19 Oct 2007 20:19:41 -0000
Received: from acolyte.scowler.net (216.254.112.45)
  by a.mx.sunsite.dk with SMTP; 19 Oct 2007 20:19:36 -0000
Received: by acolyte.scowler.net (Postfix, from userid 1000)
	id A9D4E5C6BA; Fri, 19 Oct 2007 16:19:35 -0400 (EDT)
Date: Fri, 19 Oct 2007 16:19:35 -0400
From: Clint Adams <clint@zsh.org>
To: Vin Shelton <acs@alumni.princeton.edu>
Cc: zsh workers <zsh-workers@sunsite.dk>
Subject: Re: Failures in today's build
Message-ID: <20071019201935.GA27998@scowler.net>
Mail-Followup-To: Vin Shelton <acs@alumni.princeton.edu>,
	zsh workers <zsh-workers@sunsite.dk>
References: <20a807210710191302o5bc328b2pab30d13195708195@mail.gmail.com>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20a807210710191302o5bc328b2pab30d13195708195@mail.gmail.com>
User-Agent: Mutt/1.5.16 (2007-06-11)

On Fri, Oct 19, 2007 at 04:02:14PM -0400, Vin Shelton wrote:
> With today's build I'm seeing the following failure on my linux boxes:
> 
> /opt/src/zsh-2007-10-19/Test/V01zmodload.ztst: starting.
> Segmentation fault (core dumped)
> 
> Apparently this is a result of a failed unloading of a module:
> 
> Running test: Unload the modules loaded by this test suite
> ZTST_test: expecting status: 0
> Input: /tmp/zsh.ztst.in.1099, output: /tmp/zsh.ztst.out.1099, error:
> /tmp/zsh.ztst.te
> rr.1099
> Segmentation fault (core dumped)
> make: [check] Error 139 (ignored)
> rm -rf Modules .zcompdump

If you don't zcurses -i after zmodloading, the hash is not
initialized. Here's a quick fix:

Index: Src/Modules/curses.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Modules/curses.c,v
retrieving revision 1.12
diff -u -r1.12 curses.c
--- Src/Modules/curses.c	18 Oct 2007 20:44:13 -0000	1.12
+++ Src/Modules/curses.c	19 Oct 2007 20:18:26 -0000
@@ -58,7 +58,7 @@
 static struct ttyinfo saved_tty_state;
 static struct ttyinfo curses_tty_state;
 static LinkList zcurses_windows;
-static HashTable zcurses_colorpairs;
+static HashTable zcurses_colorpairs = NULL;
 
 #define ZCURSES_ERANGE 1
 #define ZCURSES_EDEFINED 2
@@ -599,7 +599,8 @@
 cleanup_(Module m)
 {
     freelinklist(zcurses_windows, (FreeFunc) zcurses_free_window);
-    deletehashtable(zcurses_colorpairs);
+    if (zcurses_colorpairs)
+	deletehashtable(zcurses_colorpairs);
     return setfeatureenables(m, &module_features, NULL);
 }
 

