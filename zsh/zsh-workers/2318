From zsh-workers-request@euclid.skiles.gatech.edu  Mon Nov  4 02:55:07 1996
Return-Path: zsh-workers-request@euclid.skiles.gatech.edu
Received: from euclid.skiles.gatech.edu (list@euclid.skiles.gatech.edu [130.207.146.50]) by coral.primenet.com.au (8.7.5/8.7.3) with ESMTP id CAA27618 for <mason@primenet.com.au>; Mon, 4 Nov 1996 02:55:04 +1100 (EST)
Received: (from list@localhost) by euclid.skiles.gatech.edu (8.7.3/8.7.3) id KAA07299; Sun, 3 Nov 1996 10:36:58 -0500 (EST)
Resent-Date: Sun, 3 Nov 1996 10:36:58 -0500 (EST)
Date: Sun, 3 Nov 1996 16:37:07 +0100 (MET)
From: "C. v. Stuckrad" <stucki@math.fu-berlin.de>
X-Sender: stucki@petzval
Reply-To: "C. v. Stuckrad" <stucki@math.fu-berlin.de>
To: schaefer@nbn.com
cc: Zsh workers list <zsh-workers@math.gatech.edu>
Subject: Re: Strange coredump in new zsh-3.0.1 on Sunos4.1.3 (FIXED)
In-Reply-To: <961102102158.ZM23264@candle.brasslantern.com>
Message-ID: <Pine.GSO.3.95.961103162221.8490C-100000@petzval>
X-TestHeaderA: Written by C. v. Stuckrad; FB. Mathematik; EDV
X-TestHeaderB: FU-Berlin; Arnimallee 2-6; 14195 Berlin; GERMANY
Priority: normal
MIME-Version: 1.0
Content-Type: TEXT/PLAIN; charset=US-ASCII
Resent-Message-ID: <"9vw-Z2.0.wn1.PmBVo"@euclid>
Resent-From: zsh-workers@math.gatech.edu
X-Mailing-List: <zsh-workers@math.gatech.edu> archive/latest/2318
X-Loop: zsh-workers@math.gatech.edu
Precedence: list
Resent-Sender: zsh-workers-request@math.gatech.edu

On Sat, 2 Nov 1996, Bart Schaefer wrote:

> zsh is picking an arbitrary value of 20 for the OPEN_MAX constant.  If
> zclose() is being called on fd=19, chances are that at some previous
> time the fdtable[] array was overflowed and trampled on max_zsh_fd.
> 
> Chances are further that the reason for this is that `screen' is leaving
> way too many file descriptors open when it forks off children.  This is
> actually a potential security problem, because a program written to expect
> this behavior might obtain access to a pseudo-tty that it was not supposed
> to be able to access.
> 
> I seem to recall patching at least one version of `screen' to close down
> file descriptors when forking children, but that was years ago; I very
> seldom use `screen' any more since it became gnuware (no, not *because*
> it did), and I quit hacking on it even before that.

OK, setting OPEN_MAX to 64 (and applying Zoltan's fix too)
did get rid of the bug. 

Thanks a lot !

BUT, it might be something totally different than I thought, NOT 'screen'
but 'ssh' (sshd), The secure-shell- programs from Tatu Ylonen
do open and pass on a filedescriptor to all their descendants.

This filedescriptor is 'constructed' by a test-program, and seems to
somehow get a definite number. And I saw this descriptor being the LAST
POSSIBLE Number (64!).

Our 'screen' is patched to NEVER close this descriptor (knowing it's
Number by an environment variable). Before this patch screen did close
nearly all descriptors (specially the needed one :-)

So zsh on screen on sshd might have died on that ...

For now your repair seems to have worked, and I wait for the users to
complain with now problems :-))

Thanks a lot,   sincerely your's     Stucki

Christoph von Stuckrad       * *  | talk to  | <stucki@math.fu-berlin.de> \
Freie Universitaet Berlin    |/_* | nickname | ...!unido!fub!leibniz!stucki|
Fachbereich Mathematik, EDV  |\ * | 'stucki' | Tel:+49 30 838-7545{9|8}    |
Arnimallee 2-6/14195 Berlin  * *  |  on IRC  | Fax:+49 30 838-5913        /

