From zsh-workers-return-12066-mason-zsh=primenet.com.au@sunsite.auc.dk Mon Jun 26 08:09:52 2000
Return-Path: <zsh-workers-return-12066-mason-zsh=primenet.com.au@sunsite.auc.dk>
Delivered-To: mason-zsh@primenet.com.au
Received: (qmail 5530 invoked from network); 26 Jun 2000 08:09:51 -0000
Received: from sunsite.auc.dk (130.225.51.30)
  by ns1.primenet.com.au with SMTP; 26 Jun 2000 08:09:51 -0000
Received: (qmail 22048 invoked by alias); 26 Jun 2000 08:09:34 -0000
Mailing-List: contact zsh-workers-help@sunsite.auc.dk; run by ezmlm
Precedence: bulk
X-No-Archive: yes
Delivered-To: mailing list zsh-workers@sunsite.auc.dk
X-Seq: 12066
Received: (qmail 22041 invoked from network); 26 Jun 2000 08:09:33 -0000
Date: Mon, 26 Jun 2000 10:09:30 +0200 (MET DST)
Message-Id: <200006260809.KAA18398@beta.informatik.hu-berlin.de>
From: Sven Wischnowsky <wischnow@informatik.hu-berlin.de>
To: zsh-workers@sunsite.auc.dk
In-reply-to: Adam Spiers's message of Mon, 26 Jun 2000 02:37:32 +0100
Subject: PATCH: Re: segfault with _rpm completion


Adam Spiers wrote:

> Latest cvs zsh dumps core after
> 
>   $ zsh -f
>   $ autoload compinit; compinit
>   $ rpm -qf /<TAB>

Missing allocation for the option-argument list. Ouch.

Bye
 Sven

Index: Src/Zle/computil.c
===================================================================
RCS file: /cvsroot/zsh/zsh/Src/Zle/computil.c,v
retrieving revision 1.34
diff -u -r1.34 computil.c
--- Src/Zle/computil.c	2000/06/22 08:42:37	1.34
+++ Src/Zle/computil.c	2000/06/26 08:08:53
@@ -1349,6 +1349,8 @@
 		state.argend = argend;
 		doff = state.doff = 0;
 		state.singles = 1;
+		if (!state.oargs[state.curopt->num])
+		    state.oargs[state.curopt->num] = znewlinklist();
 		goto cont;
 	    } else {
 		state.curopt = NULL;
@@ -1422,6 +1424,9 @@
 
 	    if (sopts && nonempty(sopts))
 		state.curopt = (Caopt) uremnode(sopts, firstnode(sopts));
+
+	    if (!state.oargs[state.curopt->num])
+		state.oargs[state.curopt->num] = znewlinklist();
 
 	    ddef = state.def = state.curopt->args;
 	    dopt = state.curopt;

--
Sven Wischnowsky                         wischnow@informatik.hu-berlin.de

